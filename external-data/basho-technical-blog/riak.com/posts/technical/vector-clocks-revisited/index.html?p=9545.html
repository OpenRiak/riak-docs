
<!doctype html>
<html class="no-js"  xmlns="http://www.w3.org/1999/xhtml" prefix="" lang="en-US" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/content/themes/basho-v2/dist/images/favicon.ico" />
    
<!-- BEGIN Metadata added by the Add-Meta-Tags WordPress plugin -->
<link rel="alternate" hreflang="en-US" href="/posts/technical/vector-clocks-revisited/index.html?p=9545.html" />
<meta name="description" content="In our everyday lives we use the notion of time to order events: get up before breakfast, eat before work, etc. As this excellent ACM article shows, time can be complex in a distributed system. This is the first of three blog posts about changes to Riak&#039;s logical clocks." />
<meta name="keywords" content="technical blog, distributed systems, logical clocks, riak kv, ricon, vector clocks, version vectors" />
<!-- END Metadata added by the Add-Meta-Tags WordPress plugin -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39891693-3"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-39891693-3');
</script>
<!-- END Global site tag (gtag.js) - Google Analytics -->
<title>Vector Clocks Revisited &#8211; Riak</title>
<link rel='dns-prefetch' href='https://ajax.googleapis.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel='stylesheet' id='contact-form-7-css'  href='/content/plugins/contact-form-7/includes/css/styles.css?ver=4.9' type='text/css' media='all' />
<link rel='stylesheet' id='popup-maker-site-css'  href='/content/plugins/popup-maker/assets/css/site.min.css?ver=1.6.6' type='text/css' media='all' />
<link rel='stylesheet' id='rs-plugin-settings-css'  href='/content/plugins/revslider/public/assets/css/settings.css?ver=5.4.6.1' type='text/css' media='all' />
<style id='rs-plugin-settings-inline-css' type='text/css'>
.regmark{font-size:15px;  position:relative;  top:-10px}@media screen and (max-width:700px){.regmark{font-size:13px;  top:-4px}}
</style>
<link rel='stylesheet' id='megamenu-css'  href='/content/uploads/maxmegamenu/style.css?ver=a8ce69' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='/includes/css/dashicons.min.css?ver=4.8.2' type='text/css' media='all' />
<link rel='stylesheet' id='megamenu-fontawesome-css'  href='/content/plugins/megamenu-pro/icons/fontawesome/css/font-awesome.min.css?ver=1.4.5' type='text/css' media='all' />
<link rel='stylesheet' id='megamenu-genericons-css'  href='/content/plugins/megamenu-pro/icons/genericons/genericons/genericons.css?ver=1.4.5' type='text/css' media='all' />
<link rel='stylesheet' id='evcal_cal_default-css'  href='/content/plugins/eventON/assets/css/eventon_styles.css?ver=2.3.15' type='text/css' media='all' />
<!-- inject:css -->
<link rel="stylesheet" href="/content/themes/basho-v2/dist/styles/styles-846178cbe9.min.css">
<!-- endinject -->
<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js'></script>
<script>window.jQuery || document.write('<script src="/content/themes/basho-v2/dist/scripts/jquery.js"><\/script>')</script>
<script type='text/javascript' src='/content/plugins/revslider/public/assets/js/jquery.themepunch.tools.min.js?ver=5.4.6.1'></script>
<script type='text/javascript' src='/content/plugins/revslider/public/assets/js/jquery.themepunch.revolution.min.js?ver=5.4.6.1'></script>
<link rel='https://api.w.org/' href='/json/index.html' />
<link rel='prev' title='Riak Unveils Riak TS to Transform How Enterprises Store and Analyze Unstructured Data' href='/posts/press/basho-unveils-riak-ts-to-transform-how-enterprises-store-and-analyze-unstructured-data/index.html?p=9642.html' />
<link rel='next' title='5 Reasons to Attend RICON 2015' href='/posts/business/5-reasons-to-attend-ricon-2015/index.html?p=9670.html' />
<link rel="canonical" href="/posts/technical/vector-clocks-revisited/index.html?p=9545.html" />
<link rel='shortlink' href='/index.html?p=9545.html' />



<script type="text/javascript">function setREVStartSize(e){
				try{ var i=jQuery(window).width(),t=9999,r=0,n=0,l=0,f=0,s=0,h=0;					
					if(e.responsiveLevels&&(jQuery.each(e.responsiveLevels,function(e,f){f>i&&(t=r=f,l=e),i>f&&f>r&&(r=f,n=e)}),t>r&&(l=n)),f=e.gridheight[l]||e.gridheight[0]||e.gridheight,s=e.gridwidth[l]||e.gridwidth[0]||e.gridwidth,h=i/s,h=h>1?1:h,f=Math.round(h*f),"fullscreen"==e.sliderLayout){var u=(e.c.width(),jQuery(window).height());if(void 0!=e.fullScreenOffsetContainer){var c=e.fullScreenOffsetContainer.split(",");if (c) jQuery.each(c,function(e,i){u=jQuery(i).length>0?u-jQuery(i).outerHeight(!0):u}),e.fullScreenOffset.split("%").length>1&&void 0!=e.fullScreenOffset&&e.fullScreenOffset.length>0?u-=jQuery(window).height()*parseInt(e.fullScreenOffset,0)/100:void 0!=e.fullScreenOffset&&e.fullScreenOffset.length>0&&(u-=parseInt(e.fullScreenOffset,0))}f=u}else void 0!=e.minHeight&&f<e.minHeight&&(f=e.minHeight);e.c.closest(".rev_slider_wrapper").css({height:f})					
				}catch(d){console.log("Failure at Presize of Slider:"+d)}
			};</script>
<style type="text/css">/** Mega Menu CSS Disabled **/</style>
	<style id="pum-styles" type="text/css" media="all">
	/* Popup Google Fonts */
@import url('https://fonts.googleapis.com/css?family=Acme|Montserrat');

/* Popup Theme 12762: Blank Center */
.pum-theme-12762, .pum-theme-blank-center { background: none } 
.pum-theme-12762 .pum-container, .pum-theme-blank-center .pum-container { padding: 0px; border-radius: 0px; border: 1px none #000000; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 1 ); background-color: rgba( 249, 249, 249, 1 ); background: none } 
.pum-theme-12762 .pum-title, .pum-theme-blank-center .pum-title { color: #000000; text-align: center; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 16px; line-height: 16px } 
.pum-theme-12762 .pum-content, .pum-theme-blank-center .pum-content { color: #8c8c8c; font-family: inherit } 
.pum-theme-12762 .pum-content + .pum-close, .pum-theme-blank-center .pum-content + .pum-close { height: auto; width: auto; left: auto; right: 0px; bottom: auto; top: 10px; padding: 4px; color: #ffffff; font-family: inherit; font-size: 12px; line-height: 14px; border: 1px none #ffffff; border-radius: 0px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 255, 158, 1, 1 ) } 
/* Popup Theme 11529: Default No Padding */
.pum-theme-11529, .pum-theme-default-no-padding { background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11529 .pum-container, .pum-theme-default-no-padding .pum-container { padding: 0px; border-radius: 0px; border: 1px none #000000; box-shadow: 1px 1px 3px 0px rgba( 2, 2, 2, 0.23 ); background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11529 .pum-title, .pum-theme-default-no-padding .pum-title { color: #000000; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 32px; line-height: 36px } 
.pum-theme-11529 .pum-content, .pum-theme-default-no-padding .pum-content { color: #8c8c8c; font-family: inherit } 
.pum-theme-11529 .pum-content + .pum-close, .pum-theme-default-no-padding .pum-content + .pum-close { height: auto; width: auto; left: auto; right: 0px; bottom: auto; top: 0px; padding: 8px; color: #ffffff; font-family: inherit; font-size: 12px; line-height: 14px; border: 1px none #ffffff; border-radius: 0px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 255, 158, 1, 1 ) } 
/* Popup Theme 11527: Framed Border */
.pum-theme-11527, .pum-theme-framed-border { background-color: rgba( 255, 255, 255, 0.5 ) } 
.pum-theme-11527 .pum-container, .pum-theme-framed-border .pum-container { padding: 18px; border-radius: 0px; border: 20px outset #dd3333; box-shadow: 1px 1px 3px 0px rgba( 2, 2, 2, 0.97 ) inset; background-color: rgba( 255, 251, 239, 1 ) } 
.pum-theme-11527 .pum-title, .pum-theme-framed-border .pum-title { color: #000000; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 32px; line-height: 36px } 
.pum-theme-11527 .pum-content, .pum-theme-framed-border .pum-content { color: #2d2d2d; font-family: inherit } 
.pum-theme-11527 .pum-content + .pum-close, .pum-theme-framed-border .pum-content + .pum-close { height: 20px; width: 20px; left: auto; right: -20px; bottom: auto; top: -20px; padding: 0px; color: #ffffff; font-family: Acme; font-size: 20px; line-height: 20px; border: 1px none #ffffff; border-radius: 0px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 0, 0, 0, 0.55 ) } 
/* Popup Theme 11526: Cutting Edge */
.pum-theme-11526, .pum-theme-cutting-edge { background-color: rgba( 0, 0, 0, 0.5 ) } 
.pum-theme-11526 .pum-container, .pum-theme-cutting-edge .pum-container { padding: 18px; border-radius: 0px; border: 1px none #000000; box-shadow: 0px 10px 25px 0px rgba( 2, 2, 2, 0.5 ); background-color: rgba( 30, 115, 190, 1 ) } 
.pum-theme-11526 .pum-title, .pum-theme-cutting-edge .pum-title { color: #ffffff; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: Sans-Serif; font-size: 26px; line-height: 28px } 
.pum-theme-11526 .pum-content, .pum-theme-cutting-edge .pum-content { color: #ffffff; font-family: inherit } 
.pum-theme-11526 .pum-content + .pum-close, .pum-theme-cutting-edge .pum-content + .pum-close { height: 24px; width: 24px; left: auto; right: 0px; bottom: auto; top: 0px; padding: 0px; color: #1e73be; font-family: inherit; font-size: 32px; line-height: 24px; border: 1px none #ffffff; border-radius: 0px; box-shadow: -1px 1px 1px 0px rgba( 2, 2, 2, 0.1 ); text-shadow: -1px 1px 1px rgba( 0, 0, 0, 0.1 ); background-color: rgba( 238, 238, 34, 1 ) } 
/* Popup Theme 11525: Hello Box */
.pum-theme-11525, .pum-theme-hello-box { background-color: rgba( 0, 0, 0, 0.75 ) } 
.pum-theme-11525 .pum-container, .pum-theme-hello-box .pum-container { padding: 30px; border-radius: 80px; border: 14px solid #81d742; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0 ); background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11525 .pum-title, .pum-theme-hello-box .pum-title { color: #2d2d2d; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: Montserrat; font-size: 32px; line-height: 36px } 
.pum-theme-11525 .pum-content, .pum-theme-hello-box .pum-content { color: #2d2d2d; font-family: inherit } 
.pum-theme-11525 .pum-content + .pum-close, .pum-theme-hello-box .pum-content + .pum-close { height: auto; width: auto; left: auto; right: -30px; bottom: auto; top: -30px; padding: 0px; color: #2d2d2d; font-family: inherit; font-size: 32px; line-height: 28px; border: 1px none #ffffff; border-radius: 28px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 255, 255, 255, 1 ) } 
/* Popup Theme 11524: Enterprise Blue */
.pum-theme-11524, .pum-theme-enterprise-blue { background-color: rgba( 0, 0, 0, 0.7 ) } 
.pum-theme-11524 .pum-container, .pum-theme-enterprise-blue .pum-container { padding: 28px; border-radius: 5px; border: 1px none #000000; box-shadow: 0px 10px 25px 4px rgba( 2, 2, 2, 0.5 ); background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11524 .pum-title, .pum-theme-enterprise-blue .pum-title { color: #315b7c; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 34px; line-height: 36px } 
.pum-theme-11524 .pum-content, .pum-theme-enterprise-blue .pum-content { color: #2d2d2d; font-family: inherit } 
.pum-theme-11524 .pum-content + .pum-close, .pum-theme-enterprise-blue .pum-content + .pum-close { height: 28px; width: 28px; left: auto; right: 8px; bottom: auto; top: 8px; padding: 4px; color: #ffffff; font-family: inherit; font-size: 20px; line-height: 20px; border: 1px none #ffffff; border-radius: 42px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 49, 91, 124, 1 ) } 
/* Popup Theme 11523: Light Box */
.pum-theme-11523, .pum-theme-lightbox { background-color: rgba( 0, 0, 0, 0.6 ) } 
.pum-theme-11523 .pum-container, .pum-theme-lightbox .pum-container { padding: 18px; border-radius: 3px; border: 8px solid #000000; box-shadow: 0px 0px 30px 0px rgba( 2, 2, 2, 1 ); background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11523 .pum-title, .pum-theme-lightbox .pum-title { color: #000000; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 32px; line-height: 36px } 
.pum-theme-11523 .pum-content, .pum-theme-lightbox .pum-content { color: #000000; font-family: inherit } 
.pum-theme-11523 .pum-content + .pum-close, .pum-theme-lightbox .pum-content + .pum-close { height: 30px; width: 30px; left: auto; right: -24px; bottom: auto; top: -24px; padding: 0px; color: #ffffff; font-family: inherit; font-size: 24px; line-height: 26px; border: 2px solid #ffffff; border-radius: 30px; box-shadow: 0px 0px 15px 1px rgba( 2, 2, 2, 0.75 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 0, 0, 0, 1 ) } 
/* Popup Theme 11522: Default Theme */
.pum-theme-11522, .pum-theme-default-theme { background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11522 .pum-container, .pum-theme-default-theme .pum-container { padding: 15px; border-radius: 3px; border: 1px none #000000; box-shadow: 1px 1px 3px 0px rgba( 2, 2, 2, 0.23 ); background-color: rgba( 255, 255, 255, 1 ) } 
.pum-theme-11522 .pum-title, .pum-theme-default-theme .pum-title { color: #000000; text-align: left; text-shadow: 0px 0px 0px rgba( 2, 2, 2, 0.23 ); font-family: inherit; font-size: 28px; line-height: 30px } 
.pum-theme-11522 .pum-content, .pum-theme-default-theme .pum-content { color: #8c8c8c; font-family: inherit } 
.pum-theme-11522 .pum-content + .pum-close, .pum-theme-default-theme .pum-content + .pum-close { height: auto; width: auto; left: auto; right: 0px; bottom: auto; top: 0px; padding: 8px; color: #ffffff; font-family: inherit; font-weight: 400; font-size: 11px; line-height: 13px; border: 1px none #ffffff; border-radius: 0px; box-shadow: 0px 0px 0px 0px rgba( 2, 2, 2, 0.23 ); text-shadow: 0px 0px 0px rgba( 0, 0, 0, 0.23 ); background-color: rgba( 255, 158, 1, 1 ) } 

	
		</style>
<!-- START - Facebook Open Graph, Google+ and Twitter Card Tags 2.1.2 -->
 <!-- Facebook Open Graph -->
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Riak"/>
  <meta property="og:title" content="Vector Clocks Revisited"/>
  <meta property="og:url" content="/posts/technical/vector-clocks-revisited/"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="In our everyday lives we use the notion of time to order events: get up before breakfast, eat before work, etc. As this excellent ACM article shows, time can be complex in a distributed system.

This is the first of three blog posts about changes to Riak&#039;s logical clocks. They cover a lot of groun"/>
  <meta property="og:image" content="/content/uploads/2015/10/vector-clock-revisited1.png"/>
  <meta property="article:published_time" content="2015-10-06T08:35:50+00:00"/>
  <meta property="article:modified_time" content="2016-10-20T07:48:42+00:00" />
  <meta property="og:updated_time" content="2016-10-20T07:48:42+00:00" />
  <meta property="article:section" content="Technical Blog"/>
 <!-- Google+ / Schema.org -->
  <meta itemprop="name" content="Vector Clocks Revisited"/>
  <meta itemprop="description" content="In our everyday lives we use the notion of time to order events: get up before breakfast, eat before work, etc. As this excellent ACM article shows, time can be complex in a distributed system.

This is the first of three blog posts about changes to Riak&#039;s logical clocks. They cover a lot of groun"/>
  <meta itemprop="image" content="/content/uploads/2015/10/vector-clock-revisited1.png"/>
 <!-- Twitter Cards -->
 <!-- SEO -->
 <!-- Misc. tags -->
<!-- END - Facebook Open Graph, Google+ and Twitter Card Tags 2.1.2 -->
	
	<style>
	_:-ms-input-placeholder, :root .page-template-tpl-riakkv .title_ph {  margin-left:16%; }
	_:-ms-input-placeholder, :root .page-template-tpl-products .home_3_data .title_ph {  margin-left:28.5%; }
	_:-ms-input-placeholder, :root .page-template-tpl-products .home_4_data .title_ph {  margin-left:20.5%; }
	</style>
	 </head>
  <body class="post-template-default single single-post postid-9545 single-format-standard mega-menu-primary-navigation vector-clocks-revisited sidebar-primary">
    <!--[if lt IE 9]>
      <div class="alert alert-warning">
        You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.      </div>
    <![endif]-->
    


<div id="screen_viewport">
	
	<div id="head_container" class="row">
		<header>
			
			<div class="row upper">
				
				<div class="header-contain">
				
					<div class="col-sm-3 header-upper-left">
						
						<div class="logo_home">
							<a href="/index.html"><img alt="Riak logo" src="/content/themes/basho-v2/dist/images/riak.png"></a>
						</div>
	
					</div><!-- end header-upper-left-->
					<div class="col-sm-9 header-upper-right">
					
		
						<div class="quick_tools">
	<ul class="quick_links">
								<li><a href="https://docs.riak.com/index.html" target="_blank">DOWNLOAD RIAK</a></li><li><a href="https://docs.riak.com/index.html">DOCS</a></li>								<li class="lang_menu sling_lang"><a href="javascript: void(0);" class="language_choice">ENGLISH</a>
									<ul>
										<li class="language sling_lang"><a href="http://www.riak.com/index.html" rel="http://www.riak.com">English</a></li>
										<li class="language sling_lang"><a href="http://jp.riak.com/posts/technical/vector-clocks-revisited/" rel="http://jp.riak.com">日本語</a></li>
										<li class="language sling_lang"><a href="http://de.riak.com/posts/technical/vector-clocks-revisited/" rel="http://de.riak.com">Deutsch</a></li>
										<li class="language sling_lang"><a href="http://fr.riak.com/posts/technical/vector-clocks-revisited/" rel="http://fr.riak.com">Fran&ccedil;ais</a></li>
									</ul>
								</li>
							</ul>
						</div>
		
					</div><!-- end header-upper-right-->
					<div class="cf clearfix"></div>
				</div>	<!-- end header-contain -->
		</div><!-- end row -->
		<div class="col-sm-12 row header-lower">

			<div class="header-contain">

				<div class="main_nav">
					<ul class="main_nav_top">

						<div id="mega-menu-wrap-primary_navigation" class="mega-menu-wrap"><div class="mega-menu-toggle" tabindex="0"><div class='mega-toggle-block mega-menu-toggle-block mega-toggle-block-right mega-toggle-block-1' id='mega-toggle-block-1'></div></div><ul id="mega-menu-primary_navigation" class="mega-menu mega-menu-horizontal mega-no-js" data-event="hover_intent" data-effect="slide" data-effect-speed="200" data-second-click="close" data-document-click="collapse" data-vertical-behaviour="standard" data-breakpoint="600" data-unbind="true"><li class='mega-add-arrow mega-m-products mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-align-bottom-left mega-menu-megamenu mega-hide-arrow mega-menu-item-11815' id='mega-menu-item-11815'><a class="mega-menu-link" href="/products/" aria-haspopup="true" tabindex="0">Products</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-columns-1-of-3 mega-menu-item-11816' id='mega-menu-item-11816'><a class="mega-menu-link" href="/products/">Overview</a></li><li class='mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-menu-columns-1-of-3 mega-menu-item-11817' id='mega-menu-item-11817'><a class="mega-menu-link" href="/products/riak-kv/" aria-haspopup="true">Riak<sup>®</sup> KV</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-custom mega-menu-item-object-custom mega-menu-item-11819' id='mega-menu-item-11819'><a class="mega-menu-link" href="/products/riak-kv/index.html#features">Features</a></li><li class='mega-menu-item mega-menu-item-type-custom mega-menu-item-object-custom mega-menu-item-11820' id='mega-menu-item-11820'><a class="mega-menu-link" href="/products/riak-kv/index.html#commercial">Commercial V. OSS</a></li><li class='mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-has-icon mega-menu-item-11821' id='mega-menu-item-11821'><a class="fa-sign-out mega-menu-link" href="/products/riak-kv/resiliency/index.html?p=10906.html">Take Feature Tour</a></li>	</ul>
	</li><li class='mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-menu-columns-1-of-3 mega-menu-item-11822' id='mega-menu-item-11822'><a class="mega-menu-link" href="/products/riak-ts/" aria-haspopup="true">Riak<sup>®</sup> TS</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-custom mega-menu-item-object-custom mega-menu-item-11824' id='mega-menu-item-11824'><a class="mega-menu-link" href="/products/riak-ts/index.html#features">Features</a></li><li class='mega-menu-item mega-menu-item-type-custom mega-menu-item-object-custom mega-menu-item-11825' id='mega-menu-item-11825'><a class="mega-menu-link" href="/products/riak-ts/index.html#commercial">Commercial V. OSS</a></li><li class='mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-has-icon mega-menu-item-11826' id='mega-menu-item-11826'><a class="fa-sign-out mega-menu-link" href="/products/riak-ts/resiliency/index.html?p=10650.html">Take Feature Tour</a></li>	</ul>
	</li></ul>
	</li><li class='mega-m-integrations mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-align-bottom-left mega-menu-megamenu mega-hide-arrow mega-menu-item-11827' id='mega-menu-item-11827'><a class="mega-menu-link" href="/products/integrations/" aria-haspopup="true" tabindex="0">Integrations</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-widget widget_nav_menu mega-menu-columns-1-of-2 mega-menu-item-nav_menu-10' id='mega-menu-item-nav_menu-10'><ul id="menu-integrations-column-1" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-11990"><a href="/products/apache-spark/">Apache Spark</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-11885"><a href="/products/solr/">Apache Solr</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-11883"><a href="/products/apache-mesos/index.html?p=11511.html">Apache Mesos</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-11886"><a href="/products/redis/index.html?p=6927.html">Redis Caching</a></li>
	</ul></li><li class='mega-menu-item mega-menu-item-type-widget widget_nav_menu mega-menu-columns-1-of-2 mega-menu-item-nav_menu-11' id='mega-menu-item-nav_menu-11'><ul id="menu-integrations-column-2" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-11887"><a href="/products/riak-s2/index.html?p=6196.html">Riak S2</a>
	<ul  class="sub-menu">
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11888"><a href="/products/riak-s2/index.html?p=6196.html#features">Features</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11889"><a href="/products/riak-s2/index.html?p=6196.html#commercial">Commercial V. OSS</a></li>
	</ul>
	</li>
	</ul></li></ul>
	</li><li class='mega-m-resources mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-align-bottom-left mega-menu-megamenu mega-hide-arrow mega-menu-item-11837' id='mega-menu-item-11837'><a class="mega-menu-link" href="/resources/" aria-haspopup="true" tabindex="0">Resources</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-widget widget_nav_menu mega-menu-columns-1-of-2 mega-menu-item-nav_menu-2' id='mega-menu-item-nav_menu-2'><ul id="menu-resources-column-1" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-11890"><a href="/resources/">Resource Center</a>
	<ul  class="sub-menu">
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11892"><a href="/resources/index.html?resource=types&amp;t=DATASHEET">DataSheets</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11893"><a href="/resources/index.html?resource=types&amp;t=WHITEPAPER">WhitePapers</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11894"><a href="/resources/index.html?resource=types&amp;t=SOLUTION BRIEF">Solution Briefs</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11895"><a href="/resources/index.html?resource=types&amp;t=CASE STUDY">Case Studies</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11896"><a href="/resources/index.html?resource=types&amp;t=USER STORY">User Stories</a></li>
	<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-11897"><a href="/resources/index.html?resource=types&amp;t=CUSTOMER TESTIMONIAL">Customer Testimonials</a></li>
	</ul>
	</li>
	</ul></li><li class='mega-menu-item mega-menu-item-type-widget widget_nav_menu mega-menu-columns-1-of-2 mega-menu-item-nav_menu-3' id='mega-menu-item-nav_menu-3'><ul id="menu-resources-column-2" class="menu">
	</ul></li></ul>
	</li><li class='mega-add-arrow mega-m-blog mega-menu-item mega-menu-item-type-post_type mega-menu-item-object-page mega-menu-item-has-children mega-align-bottom-right mega-menu-flyout mega-hide-arrow mega-menu-item-11839' id='mega-menu-item-11839'><a class="mega-menu-link" href="/blog/" aria-haspopup="true" tabindex="0">Blog</a>
	<ul class="mega-sub-menu">
	<li class='mega-menu-item mega-menu-item-type-taxonomy mega-menu-item-object-category mega-menu-item-11841' id='mega-menu-item-11841'><a class="mega-menu-link" href="/category/technical/">Technical</a></li><li class='mega-menu-item mega-menu-item-type-taxonomy mega-menu-item-object-category mega-menu-item-11840' id='mega-menu-item-11840'><a class="mega-menu-link" href="/category/business/">Business</a></li></ul>
	</li></ul></div>						</ul>
				</div>
				<div class="cf clearfix"></div>
			</div>	<!-- end header-contain -->	

			</div><!-- end header-lower-->

			
		</header>
	</div>
	    <div class="wrap container" role="document">
      <div class="content row">
        <main class="main" role="main">
          
<div id="subpage_nav">
	<div class="subpage_nav_content">
				<h1>Riak Blog</h1>
				<div class="right_side">
					<ul>
						<li><a class="home_link" href="/index.html">Home</a></li>
						<li><a class="home_link" href="/blog/index.html">Blog</a></li>
					</ul>
				</div>
		</div>
	</div>
</div>
<div id="fb-root"></div>
<script>(function (d, s, id) {
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id))
			return;
		js = d.createElement(s);
		js.id = id;
		js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=291833560991925";
		fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
	<div id="content_blogsingle" class="row">
		<div class="tier_1 tier">
			<div class="content_home_1">
				<article class="post-9545 post type-post status-publish format-standard has-post-thumbnail hentry category-technical tag-distributed-systems-blog tag-logical-clocks tag-riak-kv tag-ricon-2 tag-vector-clocks tag-version-vectors">
					<header> 
												<h1 class="entry-title">Vector Clocks Revisited</h1>
						<div class="entry-meta">
							<time class="updated" datetime="2015-10-06T08:35:50+00:00">Posted October 6, 2015</time>
							<p class="byline author vcard"> <a href="/posts/author/russell-brown/index.html" rel="author" class="fn">by Russell Brown</a></p>							<p class="category">Category: <a href="/category/technical/index.html" rel="category tag">Technical Blog</a></p>
													</div>
					</header>
					<div class="entry-content">
						<p>In our everyday lives we use the notion of time to order events: get up before breakfast, eat before work, etc. As this excellent <a href="https://queue.acm.org/detail.cfm?id=2745385">ACM</a> article shows, time can be complex in a distributed system.</p>
<p>This is the first of three blog posts about changes to Riak&#8217;s logical clocks. They cover a lot of ground: over 3 years. If you prefer to watch a talk, then <a href="http://twitter.com/seancribbs">Sean Cribbs&#8217;</a> excellent &#8220;Brief History Of Time (In Riak)&#8221; talk from last year&#8217;s RICON covers much of what is covered in this post.. The aim is to write about my latest work with logical clocks in Riak, but in order to have a context, we first need to go back in time.</p>
<p>Back in 2010 Riak engineers published two seminal blog posts about Vector Clocks and Riak: <a href="/why-vector-clocks-are-easy/index.html">&#8220;Why Vector Clocks Are Easy&#8221;</a> and it&#8217;s companion piece <a href="/why-vector-clocks-are-hard/index.html">&#8220;Why Vector Clocks Are Hard.&#8221;</a></p>
<p>These two posts are still very valuable, and worth reading, but a lot has changed since then. This series of posts will hopefully bridge the gap.</p>
<h2><b>Why The Logical Clocks?</b></h2>
<p>Riak KV is an eventually consistent key-value database that favours write availability. To achieve this, it allows multiple clients to write concurrently, potentially to the same key. Riak KV uses logical clocks to track the history of updates to values, and detect <i>conflicting</i> writes.</p>
<p>From here on, these logical clocks will be referred to as <i>Version Vectors</i>, with thanks to <a href="https://twitter.com/xmal" target="_blank">Carlos Baquero</a> and this <a href="https://haslab.wordpress.com/2011/07/08/version-vectors-are-not-vector-clocks/">blog post</a>.</p>
<h2><b>Part 1: Vnode Version Vectors</b></h2>
<p>The subject of this first post is a major change to Riak KV&#8217;s logical clocks in the 1.0 release back in September 2011. At that time Riak KV moved from <i>client side IDs</i> to <i>vnode IDs</i>. In the <a href="/why-vector-clocks-are-hard/index.html">&#8220;Why Vector Clocks Are Hard&#8221; </a>article mentioned above the author explains that this is a difficult thing to do, but the benefits appeared to outweigh the costs.</p>
<p>But, before all that, some basics.</p>
<h3><b>A Note on Notation</b></h3>
<p>Throughout this post I use a sort of <a href="http://erlang.org/">Erlang</a>-like syntax.</p>
<pre class="example">%% This is a comment
[] %% This is a list
{} %% This is a tuple
Uppercase_word %% This is a variable
lowercase %% This is an atom
1007 %% this is a number
Var = [{atomx, Var1}, {atomz, Var2}] %% this is a binding that says Var is equal to this list</pre>
<h3><b>Version Vector Recap</b></h3>
<p><a href="index.html?p=9545.html#next-section">Skip down to the next section</a> if you already know how Version Vectors work (that means you <a href="http://teespring.com/doyouevenknow4">Kyle!</a>)</p>
<p>A Version Vector is a data structure that summarises the history of updates to a value. In Riak each Key has its own Version Vector. The data structure is a list of pairs of Actor and Counter.</p>
<pre class="example">[{Actor , Counter}]</pre>
<p>An <i>actor</i> is some entity in the system that makes updates to a object. The actor is the unit of concurrency in the system. Examples might be a server, a client, a virtual node, a process, a thread. Anything that can be uniquely identified and performs actions.</p>
<p>When an actor updates a key it will increment only it&#8217;s own entry in the vector. An actor&#8217;s entry is a summary of all the updates that actor has performed. If an actor is not present in the vector, its counter is agreed to be at zero. As each entry is a summary of an actor&#8217;s updates, the whole Version Vector summarises all the updates to the key from all the actors in the system.</p>
<pre class="example">A = [{a, 3}, {b, 2}, {c, 1}]</pre>
<p>In Version Vector <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> above three actors have updated the key. Actor <strong><span style="font-family: courier new,monospace; font-size: 14pt;">a</span></strong> has issued three updates, <strong><span style="font-family: courier new,monospace; font-size: 14pt;">b</span></strong> two, and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">c</span></strong> has issued one.</p>
<p>On its own, this does not tell us much. Version Vectors are usually considered in pairs.</p>
<pre id="equalvv" class="example">A = [{a, 3}, {b, 2}, {c, 1}]
B = [{a, 3}, {b, 2}, {c, 1}]</pre>
<p>This pair of Version Vectors, <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> above, are equal. They describe exactly the same set of events, or <i>history</i>.</p>
<pre class="example">A = [{a, 2}, {b, 2}, {c, 1}]
B = [{a, 3}, {b, 2}, {c, 1}]</pre>
<p>In the pair <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> is an ancestor of <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>. We say that <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> <i>dominates</i> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong>. <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> has seen an extra event <strong><span style="font-family: courier new,monospace; font-size: 14pt;">({a, 3})</span></strong> which means its clock showing a later logical time than <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong>. You can think of <i>dominates</i> as <i>greater than</i>:</p>
<pre class="example">B &gt; A</pre>
<p>When Riak considers the values represented by these Version Vectors it can discard <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> as all its information is contained in <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>. This is more meaningful than just a greater temporal timestamp; with a dominated Version Vector we <i>know</i> for certain that the events in <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> caused <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>. A wall-clock derived timestamp does not convey this information.</p>
<p><i>Dominates</i> is a stricter relationship than <i>descends</i>. For any pair of Version Vectors <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A descends B</span></strong> if <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> summarises all the events <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> does. So the <i>equal</i> Version Vectors, like <a href="index.html?p=9545.html#equalvv">in the pair above</a>, descend each other. You can think of <i>descends</i> as <i>greater than or equal</i>. If <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> descends <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> then <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B &gt;= A</span></strong>.</p>
<pre class="example">A = []
B = [{a, 1}]</pre>
<p>In the pair above <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B dominates A</span></strong>. All Version Vectors descend the empty Version Vector, and this single event means <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> summarises events does not.</p>
<pre class="example">A = [{a, 1}]
B = [{b, 1}]</pre>
<p>This pair of Version Vectors are in conflict, or <i>concurrent</i>. <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> pair of Version Vectors <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> are concurrent if <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> summarises events unseen by <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> <i>AND</i> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> summarises events unseen by <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong>. Actors <strong><span style="font-family: courier new,monospace; font-size: 14pt;">a</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">b</span></strong> have updated the value &#8220;at the same time&#8221;. And this is the magic of Version Vectors. They allow Riak to detect concurrent writes to a key, and store sibling values. This would be impossible with wall-clock time due to lack of perfect precision, synchronization, and information about causality.</p>
<p>When there is conflict, or concurrency, it needs to be resolved by a write, and that write is a new event. First <i>merge</i> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong> and provide the resulting Version Vector to the client as a context. This ensures the next write descends both <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>.</p>
<pre class="example">A   = [{a, 1}]
B   =         [{b, 1}]
AB  = [{a, 1}, {b, 1}]</pre>
<p>Merging two Version Vectors takes the <a href="https://en.wikipedia.org/wiki/Pairwise_comparison"><span style="font-weight: 400;">pairwise maximum</span></a> of each entry. See <strong><span style="font-family: courier new,monospace; font-size: 14pt;">AB</span></strong> above. This merged Version Vector dominates both <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>. When Actor <strong><span style="font-family: courier new,monospace; font-size: 14pt;">c</span></strong> issues a new update, it will increment its counter in this merged Version Vector, ensuring the new value overwrites both the conflicting values as <strong><span style="font-family: courier new,monospace; font-size: 14pt;">ABC</span></strong> <i>dominates</i> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">A</span></strong>, <strong><span style="font-family: courier new,monospace; font-size: 14pt;">B</span></strong>, and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">AB</span></strong>. Riak will store the merged Version Vector with the new value as the <strong><span style="font-family: courier new,monospace; font-size: 14pt;">frontier</span></strong>, or latest logical time.</p>
<pre class="example">ABC = [{a, 1}, {b, 1}, {c, 1}]</pre>
<p>To summarise: actors working serially update their own entry in a vector moving logical time forward in discrete events. Conflict, ancestry, and dominance can be established by comparing logical clocks for a key.</p>
<p>With the basics dealt with, on to the subject of this post. Before we look at what <i>Vnode Version Vectors</i> are, why would we want them?</p>
<h3 id="next-section"><b>Actor Explosion</b></h3>
<p>Prior to Riak 1.0, the <strong><span style="font-family: courier new,monospace; font-size: 14pt;">actor</span></strong> in the Version Vector was provided by the Client Application. A client would perform a read, modify the returned value, and issue a new write, sending Riak the Version Vector it read, a <i>Client ID</i>, and the new value. Riak would then increment the Client&#8217;s entry in the Version Vector, meaning this new write dominates the value(s) it read, and store it on disk.</p>
<p>In the worst case, an application might start a thread for each PUT operation, pass the thread ID to Riak as a client ID, then exit on completion. Imagine 10 application servers, each serving 1000s of concurrent requests, each sending a single-use-actor-id. The result is Version Vectors far larger than the data, and frequent, aggressive <del>vclock pruning</del>. Remember that &#8220;In a real world scenario with long-lived data, each data element would end up with a vector clock with a length proportional to the number of clients that had ever <a href="/why-vector-clocks-are-hard/index.html">modified it</a>.&#8221; Which sounds <a href="http://dl.acm.org/citation.cfm?id=117606">familiar</a>.</p>
<p>But that is not the worst of it.</p>
<h3><b>Client Complexity</b></h3>
<p>Using Client IDs in Version Vectors means client <i>applications</i> enforce database invariants. While it is merely preferable that actors are long lived, for fewer IDs in a Version Vector, there are invariants that <i>must</i> be maintained:</p>
<ul>
<li>Each actor <i>must</i> be unique.</li>
<li>Each new update must be accompanied by a strict increase in the event counter. That is each update the actor produces <i>must</i> increment the event counter in the vector to a value greater than before; an individual actor <i>must</i> always issue a strictly increasing total order of events.</li>
</ul>
<p>The most common way to satisfy these invariants is to enforce that:</p>
<ul>
<li>An actor <i>must</i> act serially.</li>
<li>An actor <i>must</i> only update it&#8217;s own entry in a Version Vector.</li>
</ul>
<p>Breaking either of these invariants leads to incorrect behaviour, the worst of which is silent data loss. This is a lot to ask of a client application, and somewhat more than the implied contract of &#8220;provide an ID, and the last vector clock you saw for a given value.&#8221;</p>
<p>Worse still, back when Riak used client IDs, there was an edge case that made maintaining these invariants impossible under certain failure scenarios.</p>
<h3><b>Read Your Own Writes (RYOW)</b></h3>
<p>In order for a <i>client</i> to issue a strictly increasing order of events, it must <i>know</i> the last event it issued. Since Riak is eventually consistent, there is no guarantee that a client will read its last write, unless it issues the write to PW primary replicas, and reads the result from PR primary replicas such that</p>
<pre class="example">PW+PR &gt; N</pre>
<p>Where N is the number of replicas for the key.</p>
<p>This guarantees that some Primary P is in both the read and write quorum. This is called a <i>strict quorum</i> as opposed to Riak&#8217;s default <i>sloppy quorum</i> settings.</p>
<p>If you need more detail on this point <a href="/understanding-riaks-configurable-behaviors-part-1/index.html">this exhaustive series of posts is for you</a>. Requiring a strict quorum reduces the <i>Availability</i> of Riak in the case of node failures or network partitions.</p>
<h4>History Repeating</h4>
<p>What happens when you don&#8217;t read your own writes? Before looking at an example, here&#8217;s Riak&#8217;s pre-1.0 algorithm for Version Vectors.</p>
<ul>
<li>Client Gets Value+Version Vector for Key</li>
<li>Client Sends Put Request to Riak with Value and ClientID and Version Vector</li>
<li>Riak increments the entry for ClientID in Version Vector</li>
<li>At each of N Vnodes:
<ul>
<li>Read local value from disk</li>
<li>If local Version Vector descends incoming Version Vector ignore write (you&#8217;ve seen it!)</li>
<li>If Incoming Version Vector descends local Version Vector overwrite local value with new one</li>
<li>If Incoming Version Vector is concurrent with local Version Vector, add new value as <strong><span style="font-family: courier new,monospace; font-size: 12pt;">sibling</span></strong></li>
</ul>
</li>
</ul>
<p>Working correctly depends on that first step. That context from the GET absolutely <i>must</i> contain the highest event the Client ID has issued.</p>
<p>Why? Simply to add one to the Version Vector and for the result to be a <i>new</i> event, a greater counter, and a later logical time, for this actor than previous events.</p>
<p><a href="/content/uploads/2015/10/vector-clock-revisited1.png"><img class="aligncenter size-full wp-image-9607" src="/content/uploads/2015/10/vector-clock-revisited1.png" alt="vector-clock-revisited1" width="287" height="325" srcset="/content/uploads/2015/10/vector-clock-revisited1.png 287w, /content/uploads/2015/10/vector-clock-revisited1-265x300.png 265w" sizes="(max-width: 287px) 100vw, 287px" /></a></p>
<p>We can come up with a pretty simple example where data is lost. Any condition that causes a disjoint read and write set, (say read from <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[A&#8217;, B&#8217;, C&#8217;]</span></strong> and get <strong><span style="font-family: courier new,monospace; font-size: 14pt;">not_found</span></strong>, write to <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[A, B, C]</span></strong>, repeat.) Each write will have the same Version Vector entry of <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{X, 1}]</span></strong>, meaning that after an initial write, all subsequent writes will be dropped, as per the algorithm above:</p>
<pre class="example">Local = [{X, 1}] %% descends
Incoming = [{X, 1}]</pre>
<p>And there are many permutations of failures, partitions, and slow responses that can lead to not reading your own writes.</p>
<p>The cause of the issue is that the same <i>event</i> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">{X, 1}</span></strong> tagged two different things. Each event in a Version Vector is a <i>unique</i> moment in logical time. Two Version Vectors that are equal <i>must</i> represent the same history. In this case <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{X, 1}]</span></strong> could be one of two writes, with potentially different values! In other words, without Read Your Own Writes, Version Vectors may fail to detect concurrent updates: <i>their one and only job</i>.</p>
<h4>So Read Your Own Writes!</h4>
<p>Riak does not ship with <code>PW=quorum</code> and <code>PR=quorum</code> by default: Riak believes people choose Riak for <i>availability</i>. However, if you were aware of the requirement to Read Your Own Write, and set the correct options, there was a bug that may mean you would not Read Your Own Writes, but believe that you had.</p>
<p>Riak 1.0 fixed the <a href="https://github.com/basho/riak_kv/pull/485">bug</a>, but by then, we had <i>Vnode Version Vectors</i>.</p>
<h3><b>This One Weird Trick</b></h3>
<p>In order to relieve the client application of the burden of ID management Riak Engineers figured out a way to have the <a href="https://docs.riak.com/riak/latest/theory/concepts/vnodes/index.html"><i>vnodes</i></a> be the actors in the system. This makes perfect sense, as the vnode is already the unit of concurrency in Riak.</p>
<p>In the  <a href="/why-vector-clocks-are-hard/index.html">&#8220;Why Vector Clocks Are Hard&#8221;</a> post the author describes an issue with <i>Server Actor IDs</i> that is identical to the repeating-history bug above. Namely two different events that were in fact concurrent get the same Version Vector. How does this happen?</p>
<p><a href="/content/uploads/2015/10/version-clock-revisited2.png"><img class="aligncenter size-full wp-image-9608" src="/content/uploads/2015/10/version-clock-revisited2.png" alt="version-clock-revisited2" width="400" height="310" srcset="/content/uploads/2015/10/version-clock-revisited2.png 400w, /content/uploads/2015/10/version-clock-revisited2-300x233.png 300w" sizes="(max-width: 400px) 100vw, 400px" /></a></p>
<ul>
<li style="font-weight: 400;">Clients <strong><span style="font-family: courier new,monospace; font-size: 14pt;">X</span></strong> and <strong><span style="font-family: courier new,monospace; font-size: 14pt;">Y</span></strong> both read key <strong><span style="font-family: courier new,monospace; font-size: 14pt;">K</span></strong> and get <strong><span style="font-family: courier new,monospace; font-size: 14pt;">Rita</span></strong> <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 1}]</span></strong></li>
<li style="font-weight: 400;">Client <strong><span style="font-family: courier new,monospace; font-size: 14pt;">X</span></strong> PUTs &#8220;bob&#8221;</li>
<li style="font-weight: 400;">Client <strong><span style="font-family: courier new,monospace; font-size: 14pt;">Y</span></strong> PUTs &#8220;sue&#8221;</li>
<li style="font-weight: 400;">Riak vnode <strong><span style="font-family: courier new,monospace; font-size: 14pt;">a</span></strong> handles the <strong><span style="font-family: courier new,monospace; font-size: 14pt;">Y</span></strong> PUT, sets the Version Vector to <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 2}]</span></strong> and value to &#8220;Sue&#8221;</li>
<li style="font-weight: 400;">Riak vnode <strong><span style="font-family: courier new,monospace; font-size: 14pt;">a</span></strong> handles the <strong><span style="font-family: courier new,monospace; font-size: 14pt;">X</span></strong> PUT&#8230;</li>
</ul>
<p>What should the vnode do? The incoming Version Vector is <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 1}]</span></strong>. Vnode a can increment its entry, creating the vector <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 2}]</span></strong>, but then we have two different values with the same Version Vector. We failed to capture concurrency, and some write ends up lost.</p>
<p>We could read the local value for <strong><span style="font-family: courier new,monospace; font-size: 14pt;">K</span></strong> and see the Version Vector is <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 2}]</span></strong> which <i>dominates</i> the incoming <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 1}]</span></strong> and discard the incoming write. This seems unfair, as in any <i>race</i>, only one client can <i>&#8220;win&#8221;</i> (some databases do this with wall clock time!)</p>
<p>We could tweak the Version Vector algorithm:</p>
<ul>
<li style="font-weight: 400;">If local Version Vector <i>descends</i> Incoming Version Vector, add new value as <strong><span style="font-family: courier new,monospace; font-size: 14pt;">sibling</span></strong>.</li>
</ul>
<p>This trick introduces <i>false concurrency</i> and allows us to store &#8220;Sue&#8221; and &#8220;Bob&#8221; as sibling values, while discarding &#8220;Rita&#8221; as an ancestor of the incoming Version Vector <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{a, 1}]</span></strong>.</p>
<h3><b>It&#8217;s all good</b></h3>
<p>It also has the handy benefit that badly behaving clients that do not retrieve a Version Vector before writing will still generate a sibling on PUT, meaning their write values are stored, rather than being silently discarded as <i>seen</i>.</p>
<p>What have we achieved? Smaller Version Vectors: in the order of the number of replicas for the key (by default 3 in Riak). Simpler for clients: for best behaviour provide the latest Version Vector you&#8217;ve seen when you issue a PUT, but of the Version Vector is <i>stale</i> it doesn&#8217;t matter, your value will be stored as a sibling.</p>
<p>In short:</p>
<ul>
<li style="font-weight: 400;">No more Read Your Own Writes</li>
<li style="font-weight: 400;">Smaller Version Vectors</li>
<li style="font-weight: 400;">Simpler clients</li>
</ul>
<h3><b>Downside?</b></h3>
<h4 style="text-align: left;">Idempotent PUTs</h4>
<p>On the downside Vnode Version Vectors lose <i>idempotent</i> PUTs.</p>
<p>With Client IDs if some client A sends a PUT with ID X and clock <strong><span style="font-family: courier new,monospace; font-size: 14pt;">[{X, 2}, {Y, 3}]</span></strong> and Riak fails to answer, but stores the write, re-issuing the same write will be <i>idempotent</i>. With <i>Vnode Version Vectors</i> re-issuing the write generates a sibling with an identical value. However Riak side-steps that by storing a <i>Set</i> of siblings values.</p>
<h4>Coordinating Vnode</h4>
<p>Another downside is that there must be a coordinating vnode to increment the Version Vector. This means that when a request reaches Riak, the preference list must be consulted and a vnode on the preference list is chosen to coordinate the PUT. If the node that received the request is not on the preference list, then the request must be <i>forwarded</i> to a node that is: this introduces some latency to a PUT.</p>
<h4>Sibling Explosion</h4>
<p>As a result of false concurrency riak is unable to accurately discern truly concurrent writes from interleaved writes, leading in the worst case to an &#8220;explosion&#8221; of sibling values. This is fixed in Riak 2.0, so don&#8217;t panic! This &#8220;sibling explosion&#8221; is also the subject of the next blog post.</p>
<h2><b>Summary</b></h2>
<p>Since we released Riak 1.0, we no longer need to talk about &#8220;vclocks&#8221;, but instead a &#8220;causal context&#8221; or just &#8220;context&#8221;. Vnode Version Vectors solved some difficult issues for Riak users around availability and client process management, but they came with some costs. For the sake of completeness, here are the <a href="https://github.com/basho/riak/blob/1.0/RELEASE-NOTES.org#getput-improvements">release notes for Vnode Version Vectors</a><span style="font-weight: 400;">.</span></p>
<p>Next time we&#8217;ll look at that “sibling explosion” bug in Vnode Version Vectors, and how academic intervention saved the day.</p>
<p><strong><a href="https://github.com/russelldb" target="_blank">Russell Brown</a></strong></p>
													
					</div>
				</article>
				</div></div><div class="tier_2 tier">
		<div class="content_home_2 row">
			<h1>Recent Articles</h1>
			<div class="divider_line">
				<img alt="" src="/content/themes/basho-v2/assets/images/blog/divider-line.png">
			</div>
			
<div class="col-sm-6 col-md-3 single_blog">
	<article class="post-13488 post type-post status-publish format-standard hentry category-technical tag-apache-mesos tag-mesosphere tag-riak">
				<header>
						<h2 class="entry-title"><a href="/posts/technical/dcos-and-riak-mesos-framework/index.html?p=13488.html">DC/OS 1.9 and Riak Mesos Framework</a></h2>
			<time class="updated" datetime="2017-03-13T09:47:39+00:00">March 13, 2017</time>
							<p class="byline author vcard"> <a href="/posts/author/pavelhardak/index.html" rel="author" class="fn">Pavel Hardak</a></p>
					</header>
		<div class="entry-summary">
			<p>We are pleased today to announce with Mesosphere, the launch of DC/OS 1.9 and a major upgrade of the integration&#8230; </p>
<div class="learn_more_btn"><a href="/posts/technical/dcos-and-riak-mesos-framework/index.html?p=13488.html">Read More</a></div>
		</div>
	</article>
</div>

<div class="col-sm-6 col-md-3 single_blog">
	<article class="post-13441 post type-post status-publish format-standard hentry category-technical tag-iot tag-riak tag-riak-ts tag-the-weather-company">
				<header>
						<h2 class="entry-title"><a href="/posts/technical/traditional-data-lake-approach-may-not-be-a-good-choice-for-iot-data/index.html?p=13441.html">Traditional “Data Lake” Approach May Not Be A Good Choice for IoT Data</a></h2>
			<time class="updated" datetime="2017-03-01T16:46:22+00:00">March 1, 2017</time>
							<p class="byline author vcard"> <a href="/posts/author/dorothy-pults/index.html" rel="author" class="fn">Dorothy Pults</a></p>
					</header>
		<div class="entry-summary">
			<p>The momentum around Apache Spark continues. Spark Summit East was a big success and Riak’s own Pavel Hardak was among&#8230; </p>
<div class="learn_more_btn"><a href="/posts/technical/traditional-data-lake-approach-may-not-be-a-good-choice-for-iot-data/index.html?p=13441.html">Read More</a></div>
		</div>
	</article>
</div>

<div class="col-sm-6 col-md-3 single_blog">
	<article class="post-13409 post type-post status-publish format-standard hentry category-technical tag-basho-academy tag-riak tag-riak-kv tag-riak-ts">
				<header>
						<h2 class="entry-title"><a href="/posts/technical/basho-academy-install-code-and-go/index.html?p=13409.html">Riak Academy: Install, Code and Go</a></h2>
			<time class="updated" datetime="2017-02-27T10:25:05+00:00">February 27, 2017</time>
							<p class="byline author vcard"> <a href="/posts/author/dorothy-pults/index.html" rel="author" class="fn">Dorothy Pults</a></p>
					</header>
		<div class="entry-summary">
			<p>Are you new to NoSQL and want to find out more about Riak? Riak Academy may be the right place for&#8230; </p>
<div class="learn_more_btn"><a href="/posts/technical/basho-academy-install-code-and-go/index.html?p=13409.html">Read More</a></div>
		</div>
	</article>
</div>

<div class="col-sm-6 col-md-3 single_blog">
	<article class="post-13356 post type-post status-publish format-standard hentry category-technical tag-iot tag-riak-ts">
				<header>
						<h2 class="entry-title"><a href="/posts/technical/create-your-first-riak-ts-table/index.html?p=13356.html">Create Your First Riak TS Table</a></h2>
			<time class="updated" datetime="2017-02-21T19:05:56+00:00">February 21, 2017</time>
							<p class="byline author vcard"> <a href="/posts/author/dorothy-pults/index.html" rel="author" class="fn">Dorothy Pults</a></p>
					</header>
		<div class="entry-summary">
			<p>Customers like Intellicore are doing real-time analysis of IoT data using Riak TS. We want to make it easy for&#8230; </p>
<div class="learn_more_btn"><a href="/posts/technical/create-your-first-riak-ts-table/index.html?p=13356.html">Read More</a></div>
		</div>
	</article>
</div>
		</div>
	</div>
		
	<div class="divider_bar shadow"></div>
</div>         </main><!-- /.main -->
                  <aside class="sidebar" role="complementary">
                      </aside><!-- /.sidebar -->
              </div><!-- /.content -->
    </div><!-- /.wrap -->
    <footer class="content-info" role="contentinfo">
	<div class="container">
		<div class="footer_menu row">
			<div class="footer-content row">

				<div class="col-sm-12 col-md-8">

					<div class="four-menus">

	<div class="col-xs-6 col-sm-3 menu_col left">
		<ul>
		<li><a href="/products/">Products</a></li><li><a href="/products/integrations/">Integrations</a></li><li><a href="/resources/">Resources</a></li><li><a href="/resources/nosql-databases/index.html?p=9937.html">NoSQL Explained</a></li>							</ul>
	</div>
	<div class="col-xs-6 col-sm-3 menu_col middle">
		<ul>
		<li><a href="/about/">About Riak</a></li><li><a href="/newsroom/">Newsroom</a></li>							</ul>
	</div>
	<div class="col-xs-6 col-sm-3 menu_col middle">
		<ul>
		<li><a href="/blog/">Blog</a></li><li><a href="/community/">DEVELOPERS</a></li>							</ul>
	</div>
	<div class="col-xs-6  col-sm-3 menu_col right">
		<ul>
									</ul>

	</div>

</div>
<div class="copyright col-xs-12">
						
											</div>
				</div>
				<div class="col-sm-12 col-md-3 footer-right">

					<div class="logo">
						<a href="/index.html"><img alt="" src="/content/themes/basho-v2/dist/images/riak-footer-logo.png"></a>
					</div>

										<div class="cf clearfix"></div>

				</div>

				<div class="back_top">
					<img alt="" src="/content/themes/basho-v2/dist/images/back-top.png">
				</div>


			</div>


		</div>
	</div>
</footer>
<div class="sidenav">
 

</div>


</div>


<!-- google analytics code here -->
<link rel='stylesheet' id='eventon_dynamic_styles-css'  href='/content/plugins/eventON/assets/css/eventon_dynamic_styles.css?ver=4.8.2' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"http:\/\/riak.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script type='text/javascript' src='/content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9'></script>
<script type='text/javascript' src='/includes/js/hoverIntent.min.js?ver=1.8.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var megamenu = {"timeout":"300","interval":"100","effect":{"fadeUp":{"in":{"animate":{"opacity":"show","margin-top":"0"},"css":{"margin-top":"10px"}},"out":{"animate":{"opacity":"hide","margin-top":"10px"}}}}};
/* ]]> */
</script>
<script type='text/javascript' src='/content/plugins/megamenu/js/maxmegamenu.js?ver=2.3.8'></script>
<script type='text/javascript' src='/content/plugins/megamenu-pro/assets/public.js?ver=1.4.5'></script>
<script type='text/javascript' src='/includes/js/jquery/ui/core.min.js?ver=1.11.4'></script>
<script type='text/javascript' src='/includes/js/jquery/ui/position.min.js?ver=1.11.4'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var pum_vars = {"ajaxurl":"http:\/\/riak.com\/wp-admin\/admin-ajax.php","restapi":"http:\/\/riak.com\/wp-json\/pum\/v1","rest_nonce":null,"default_theme":"11522","debug_mode":"","disable_open_tracking":""};
var pum_debug_vars = {"debug_mode_enabled":"Popup Maker Debug Mode Enabled","debug_started_at":"Debug started at:","debug_more_info":"For more information on how to use this information visit http:\/\/docs.wppopupmaker.com\/?utm_medium=js-debug-info&utm_campaign=ContextualHelp&utm_source=browser-console&utm_content=more-info","global_info":"Global Information","localized_vars":"Localized variables","popups_initializing":"Popups Initializing","popups_initialized":"Popups Initialized","single_popup_label":"Popup: #","theme_id":"Theme ID: ","label_method_call":"Method Call:","label_method_args":"Method Arguments:","label_popup_settings":"Settings","label_triggers":"Triggers","label_cookies":"Cookies","label_delay":"Delay:","label_conditions":"Conditions","label_cookie":"Cookie:","label_settings":"Settings:","label_selector":"Selector:","label_mobile_disabled":"Mobile Disabled:","label_tablet_disabled":"Tablet Disabled:","label_display_settings":"Display Settings:","label_close_settings":"Close Settings:","label_event_before_open":"Event: Before Open","label_event_after_open":"Event: After Open","label_event_open_prevented":"Event: Open Prevented","label_event_setup_close":"Event: Setup Close","label_event_close_prevented":"Event: Close Prevented","label_event_before_close":"Event: Before Close","label_event_after_close":"Event: After Close","label_event_before_reposition":"Event: Before Reposition","label_event_after_reposition":"Event: After Reposition","label_event_checking_condition":"Event: Checking Condition","triggers":{"click_open":{"name":"Click Open","modal_title":"Click Trigger Settings","settings_column":"<strong>Extra Selectors<\/strong>: {{data.extra_selectors}}"},"auto_open":{"name":"Auto Open","modal_title":"Auto Open Settings","settings_column":"<strong>Delay<\/strong>: {{data.delay}}"},"scroll":{"name":"Scroll","modal_title":"Scroll Trigger Settings","settings_column":"<strong>Trigger<\/strong>: {{data.trigger}}"}},"cookies":{"on_popup_open":{"name":"On Popup Open","modal_title":"On Popup Open Settings"},"on_popup_close":{"name":"On Popup Close","modal_title":"On Popup Close Settings"},"manual":{"name":"Manual JavaScript","modal_title":"Click Trigger Settings"}}};
var ajaxurl = "http:\/\/riak.com\/wp-admin\/admin-ajax.php";
var popmake_default_theme = "11522";
/* ]]> */
</script>
<script type='text/javascript' src='/content/plugins/popup-maker/assets/js/site.min.js?defer&amp;ver=1.6.6.js' defer='defer'></script>
<script type='text/javascript' src='/content/plugins/popup-maker-scroll-triggered-popups/assets/js/site.min.js?defer&amp;ver=1.2.3.js' defer='defer'></script>

<!-- inject:js -->
<script src="/content/themes/basho-v2/dist/scripts/scripts-cd91f277db.min.js"></script>
<!-- endinject -->
<script type='text/javascript' src='/includes/js/embed.min.js?ver=4.8.2'></script>
  </body>
</html>
