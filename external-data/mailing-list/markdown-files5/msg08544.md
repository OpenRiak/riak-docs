---
title: "Re: Java map-reduce and result keys"
description: ""
project: community
lastmod: 2012-09-14T09:42:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08544"
mailinglist_parent_id: "msg08535"
author_name: "Deepak Balasubramanyam"
project_section: "mailinglistitem"
sent_date: 2012-09-14T09:42:42-07:00
---


Thanks for the tip Russell. I managed to get this done.

I have one more question and a suggestion.


 - Is the name keyData a misnomer in the mapping function -&gt; function(
 value, keyData, arg) ? keyData is a String that carries the bucket
 name. The value object carries more information. value[0].data represents
 the data itself among other properties that represent user metadata; riak
 links; indexes; key; etc etc.
 - If mapValuesJson: function(value, keyData, arg) can take an input
 argument and use it to add a json property whose value is the riak key, a
 custom function would not be necessary. It would be a neat little system
 feature which I take would need amendments to
mapred\\_builtins.js
 .
 - Is riak\\_kv the repo to make contributions to system built functions
 ? There are quite a few open pull requests on that repo, so I'm not sure
 where this change should go.


Thanks
Deepak Bala

On Fri, Sep 14, 2012 at 7:16 PM, Russell Brown  wrote:

&gt;
&gt; On 14 Sep 2012, at 14:24, Deepak Balasubramanyam wrote:
&gt;
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I've written a map reduce query on the riak java client like so...
&gt; &gt;
&gt; &gt; client.mapReduce(BUCKET).addKeyFilter(keyFilter)
&gt; &gt; .addLinkPhase(BUCKET, "\\_", false)
&gt; &gt; .addMapPhase(new
&gt; NamedJSFunction("Riak.mapValuesJson"), false)
&gt; &gt; .addReducePhase(phaseFunction).execute();
&gt; &gt; Collection types = result.getResult(MyType.class);
&gt; &gt;
&gt; &gt; This is the class definition for MyType
&gt; &gt;
&gt; &gt; public class MyType
&gt; &gt; {
&gt; &gt; @RiakKey
&gt; &gt; private String myKey;
&gt; &gt; private String property1;
&gt; &gt; private String property2;
&gt; &gt;
&gt; &gt; /\\* Getters / Setters go here \\*/
&gt; &gt; }
&gt; &gt;
&gt; &gt; When the object mapper deserializes the results into Collection,
&gt; none of the types have the myKey property populated in them. When I
&gt; debugged the calls made by riak I realized that the result of the /mapred
&gt; call does not contain any key information in the body. It only contains the
&gt; value that each key represents. So that explains why the keys are null in
&gt; the result.
&gt;
&gt; The Java client doesn't add the value of the @RiakKey field to the value
&gt; stored in riak.
&gt;
&gt; &gt;
&gt; &gt; On the contrary, a link walk in riak returns the Location header for
&gt; each multipart form entry in the response (Location: /riak/bucket/key). So
&gt; I guess there is at least some way to tweak a client to parse the location
&gt; to get the keys, but you lose out on the map-reduce goodness.
&gt; &gt;
&gt; &gt; Is there some way a map-reduce query can be formed to allow the
&gt; resulting type's RiakKey to be populated ? What are my options ?
&gt;
&gt; A custom Map function may do what you want. Get the Key from the Key Data
&gt; passed to the Map function and add it to the JSON value returned. Jackson
&gt; should then take care of de-serialising it into your values.
&gt;
&gt; Cheers
&gt;
&gt; Russell
&gt;
&gt; &gt;
&gt; &gt; Thanks
&gt; &gt; Deepak Bala
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

