---
title: "Re: Very slow acquisition time (99 percentile) while fast median times"
description: ""
project: community
lastmod: 2016-05-03T10:03:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17283"
mailinglist_parent_id: "msg17275"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2016-05-03T10:03:34-07:00
---


Guillaume,

I have reviewed the debug package for your riak1 server. There are two 
potential areas of follow-up:

1. You are running our most recent Riak 2.1.4 which has eleveldb 2.0.17. We 
have seen a case where a recent feature in eleveldb 2.0.17 caused too much 
cache flushing, impacting leveldbâ€™s performance. A discussion is here:

 https://github.com/basho/leveldb/wiki/mv-timed-grooming2 


2. Yokozuna search was recently updated for some timeout problems. Those 
updates are not yet in a public build. One of our other engineers is likely to 
respond to you on that topic.


An eleveldb 2.0.18 is tagged and available via github if you want to build it 
yourself. Otherwise, Basho may be releasing prebuilt patches of eleveldb 
2.0.18 in the near future. But no date is currently set.

Matthew

&gt; On May 3, 2016, at 10:50 AM, Luke Bakken  wrote:
&gt; 
&gt; Guillaume -
&gt; 
&gt; You said earlier "My data are stored on an openstack volume that
&gt; support up to 3000IOPS". There is a likelihood that your write load is
&gt; exceeding the capacity of your virtual environment, especially if some
&gt; Riak nodes are sharing physical disk or server infrastructure.
&gt; 
&gt; Some suggestions:
&gt; 
&gt; \\* If you're not using Riak Search, set "search = off" in riak.conf
&gt; 
&gt; \\* Be sure to carefully read and apply all tunings:
&gt; http://docs.basho.com/riak/kv/2.1.4/using/performance/
&gt; 
&gt; \\* You may wish to increase the memory dedicated to leveldb:
&gt; http://docs.basho.com/riak/kv/2.1.4/configuring/backend/#leveldb
&gt; 
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt; 
&gt; 
&gt; On Tue, May 3, 2016 at 7:33 AM, Guillaume Boddaert
&gt;  wrote:
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; Sorry for the delay, I've spent a lot of time trying to understand if the
&gt;&gt; problem was elsewhere.
&gt;&gt; I've simplified my infrastructure and got a simple layout that don't rely
&gt;&gt; anymore on loadbalancer and also corrected some minor performance issue on
&gt;&gt; my workers.
&gt;&gt; 
&gt;&gt; At the moment, i have up to 32 workers that are calling riak for writes,
&gt;&gt; each of them are set to :
&gt;&gt; w=1
&gt;&gt; dw=0
&gt;&gt; timeout=1000
&gt;&gt; using protobuf
&gt;&gt; a timeouted attempt is rerun 180s later
&gt;&gt; 
&gt;&gt; From my application server perspective, 23% of the calls are rejected by
&gt;&gt; timeout (75446 tries, 57564 success, 17578 timeout).
&gt;&gt; 
&gt;&gt; Here is a sample riak-admin stat for one of my 5 hosts:
&gt;&gt; 
&gt;&gt; node\\_put\\_fsm\\_time\\_100 : 999331
&gt;&gt; node\\_put\\_fsm\\_time\\_95 : 773682
&gt;&gt; node\\_put\\_fsm\\_time\\_99 : 959444
&gt;&gt; node\\_put\\_fsm\\_time\\_mean : 156242
&gt;&gt; node\\_put\\_fsm\\_time\\_median : 20235
&gt;&gt; vnode\\_put\\_fsm\\_time\\_100 : 5267527
&gt;&gt; vnode\\_put\\_fsm\\_time\\_95 : 2437457
&gt;&gt; vnode\\_put\\_fsm\\_time\\_99 : 4819538
&gt;&gt; vnode\\_put\\_fsm\\_time\\_mean : 175567
&gt;&gt; vnode\\_put\\_fsm\\_time\\_median : 6928
&gt;&gt; 
&gt;&gt; I am using leveldb, so i can't tune bitcask backend as suggested.
&gt;&gt; 
&gt;&gt; I've changed the vmdirty settings and enabled them:
&gt;&gt; admin@riak1:~$ sudo sysctl -a | grep dirtyvm.dirty\\_background\\_ratio = 0
&gt;&gt; vm.dirty\\_background\\_bytes = 209715200
&gt;&gt; vm.dirty\\_ratio = 40
&gt;&gt; vm.dirty\\_bytes = 0
&gt;&gt; vm.dirty\\_writeback\\_centisecs = 100
&gt;&gt; vm.dirty\\_expire\\_centisecs = 200
&gt;&gt; 
&gt;&gt; I've seen less idle time between writes, iostat is showing near constant
&gt;&gt; writes between 20 and 500 kb/s, with some surges around 4000 kb/s. That's
&gt;&gt; better, but not that great.
&gt;&gt; 
&gt;&gt; Here is the current configuration for my "activity\\_fr" bucket type and
&gt;&gt; "tweet" bucket:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/props
&gt;&gt; HTTP/1.1 200 OK
&gt;&gt; Content-Encoding: gzip
&gt;&gt; Content-Length: 314
&gt;&gt; Content-Type: application/json
&gt;&gt; Date: Tue, 03 May 2016 14:30:21 GMT
&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt; Vary: Accept-Encoding
&gt;&gt; {
&gt;&gt; "props": {
&gt;&gt; "active": true,
&gt;&gt; "allow\\_mult": false,
&gt;&gt; "basic\\_quorum": false,
&gt;&gt; "big\\_vclock": 50,
&gt;&gt; "chash\\_keyfun": {
&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt; },
&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt;&gt; "dvv\\_enabled": false,
&gt;&gt; "dw": "quorum",
&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt; "linkfun": {
&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt; },
&gt;&gt; "n\\_val": 3,
&gt;&gt; "notfound\\_ok": true,
&gt;&gt; "old\\_vclock": 86400,
&gt;&gt; "postcommit": [],
&gt;&gt; "pr": 0,
&gt;&gt; "precommit": [],
&gt;&gt; "pw": 0,
&gt;&gt; "r": "quorum",
&gt;&gt; "rw": "quorum",
&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt; "small\\_vclock": 50,
&gt;&gt; "w": "quorum",
&gt;&gt; "young\\_vclock": 20
&gt;&gt; }
&gt;&gt; }
&gt;&gt; 
&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/buckets/tweet/props
&gt;&gt; HTTP/1.1 200 OK
&gt;&gt; Content-Encoding: gzip
&gt;&gt; Content-Length: 322
&gt;&gt; Content-Type: application/json
&gt;&gt; Date: Tue, 03 May 2016 14:30:02 GMT
&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt; Vary: Accept-Encoding
&gt;&gt; 
&gt;&gt; {
&gt;&gt; "props": {
&gt;&gt; "active": true,
&gt;&gt; "allow\\_mult": false,
&gt;&gt; "basic\\_quorum": false,
&gt;&gt; "big\\_vclock": 50,
&gt;&gt; "chash\\_keyfun": {
&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt; },
&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt;&gt; "dvv\\_enabled": false,
&gt;&gt; "dw": "quorum",
&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt; "linkfun": {
&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt; },
&gt;&gt; "n\\_val": 3,
&gt;&gt; "name": "tweet",
&gt;&gt; "notfound\\_ok": true,
&gt;&gt; "old\\_vclock": 86400,
&gt;&gt; "postcommit": [],
&gt;&gt; "pr": 0,
&gt;&gt; "precommit": [],
&gt;&gt; "pw": 0,
&gt;&gt; "r": "quorum",
&gt;&gt; "rw": "quorum",
&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt; "small\\_vclock": 50,
&gt;&gt; "w": "quorum",
&gt;&gt; "young\\_vclock": 20
&gt;&gt; }
&gt;&gt; }
&gt;&gt; 
&gt;&gt; I really don't know what to do. Can you help ?
&gt;&gt; 
&gt;&gt; Guillaume
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

