---
title: "Re: EC2 and RIAK"
description: ""
project: community
lastmod: 2011-04-01T10:03:13-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02842"
mailinglist_parent_id: "msg02841"
author_name: "Eric Moritz"
project_section: "mailinglistitem"
sent_date: 2011-04-01T10:03:13-07:00
---


I concur with Mark, Rackspace has some poor performance with Riak.

On Fri, Apr 1, 2011 at 1:00 PM, Mark Steele  wrote:
&gt; I've done some rather disappointing tests with Riak using Rackspace cloud
&gt; servers. Much better off on dedicated hardware if you can find it.
&gt; Mark Steele
&gt; Bering Media Inc.
&gt;
&gt;
&gt; On Fri, Apr 1, 2011 at 11:51 AM, David Dawson 
&gt; wrote:
&gt;&gt;
&gt;&gt; Mathias and Alexander,
&gt;&gt;
&gt;&gt;        Thanks for both of your replies they were very informative and
&gt;&gt; really have helped me to make my mind up, but to summarise:
&gt;&gt;
&gt;&gt;        - If you want good predictable performance but you are happy to
&gt;&gt; live with the risk of loosing some of your data ( in the event of a cluster
&gt;&gt; failure where the number of nodes that fail &gt; than your n\\_val ) then run
&gt;&gt; with the local ephemeral storage in RAID 5  or 10 and take snapshots of the
&gt;&gt; data periodically or run in dual DC mode with replication.
&gt;&gt;        - If you want 100%  assurance that your data is available and you
&gt;&gt; are happy with unpredictable performance then use EBS.
&gt;&gt;        - If you want 100% assurance that your data is available and also
&gt;&gt; has predictable performance then Amazon EC2 is not the most optimal choice.
&gt;&gt;
&gt;&gt;        In our scenario we are doing a equal amount of reads and writes,
&gt;&gt; and will need to guarantee  about 32K ops/sec from a RIAK cluster over a 2
&gt;&gt; hour period with minimal risks of a outage or drop in performance, hence I
&gt;&gt; am guessing that maybe EC2 is not the right choice for us. We are going to
&gt;&gt; look at Joyent as an alternative, that said has anyone else used other
&gt;&gt; solutions e.g. RackSpace cloud?
&gt;&gt;
&gt;&gt; Dave
&gt;&gt;
&gt;&gt;
&gt;&gt; On 1 Apr 2011, at 14:21, Mathias Meyer wrote:
&gt;&gt;
&gt;&gt; &gt; Hi David,
&gt;&gt; &gt;
&gt;&gt; &gt; Alexander already gave you a good rundown on EC2 and Riak, but let me
&gt;&gt; &gt; add some of my own experiences running databases on EC2 in general.
&gt;&gt; &gt;
&gt;&gt; &gt; The short answer is, Riak is certainly successfully used in production
&gt;&gt; &gt; on EC2, so nothing should hold you back from testing a setup on EC2. But
&gt;&gt; &gt; there's a whole bunch of things you should keep in mind.
&gt;&gt; &gt;
&gt;&gt; &gt; First, it's probably a good idea to avoid using ephemeral storage as
&gt;&gt; &gt; persistent storage. Even though it rarely happens, instances can crash on
&gt;&gt; &gt; EC2 for any kind of reason, mostly a hardware failure of the underlying 
&gt;&gt; &gt; host
&gt;&gt; &gt; of course.
&gt;&gt; &gt;
&gt;&gt; &gt; Cluster compute instances offer especially high CPU power, but what you
&gt;&gt; &gt; really want is really fast and reliable storage I/O, persisted for eternity
&gt;&gt; &gt; if need be. CC instances are certainly a lot better than any other instance
&gt;&gt; &gt; in that terms of general I/O (see [2] for a comparison), but fall prey to
&gt;&gt; &gt; similar limitations in terms of network storage I/O as other instance 
&gt;&gt; &gt; types,
&gt;&gt; &gt; see below.
&gt;&gt; &gt;
&gt;&gt; &gt; The RAID 0'd ephemeral storage on the cluster compute instances may
&gt;&gt; &gt; sound good in theory in terms of performance, but in practice it takes away
&gt;&gt; &gt; data durability in case of a single disk failure. One disk fails, and the
&gt;&gt; &gt; data on that node is gone. Depending on what kinds of seek your doing, an
&gt;&gt; &gt; EBS setup may even turn out to be faster. See [6] and [4] for a comparison
&gt;&gt; &gt; and some initial and extended measurements, and [7] for another comparison.
&gt;&gt; &gt; But certainly, the cluster compute instance's ephemeral storage can achieve
&gt;&gt; &gt; a good amount of throughput, see [5] for some pretty graphs comparing both
&gt;&gt; &gt; RAID and non-RAID setups.
&gt;&gt; &gt;
&gt;&gt; &gt; As Alexander pointed out, multiple instance failures can make this
&gt;&gt; &gt; scenario a real killer, though you end up with the same risks as running on
&gt;&gt; &gt; raw iron servers. Both ephemeral storage and EBS don't make the problem of 
&gt;&gt; &gt; a
&gt;&gt; &gt; proper backup disappear. You could e.g. run off ephemeral storage, relying
&gt;&gt; &gt; on both Riak's replication and a good backup e.g. to an EBS volume or to 
&gt;&gt; &gt; S3.
&gt;&gt; &gt;
&gt;&gt; &gt; EBS on the other hand is prone to a large variance in network latency,
&gt;&gt; &gt; making performance at any point unpredictable and unreliable. Every
&gt;&gt; &gt; measurement you take is likely to be different an hour later. This may 
&gt;&gt; &gt; sound
&gt;&gt; &gt; extreme, but it turns out to be a very big issue for databases where 
&gt;&gt; &gt; there's
&gt;&gt; &gt; lots of disk I/O involved to read and write data, as is the case with 
&gt;&gt; &gt; Riak's
&gt;&gt; &gt; Bitcask storage.
&gt;&gt; &gt;
&gt;&gt; &gt; You can increase the performance and reliability of EBS by using a RAID
&gt;&gt; &gt; of volumes. Preferrably go for a RAID 5 or RAID 10 to add redundancy.
&gt;&gt; &gt; There's mixed opinions on whether that's really necessary on EBS, with
&gt;&gt; &gt; Amazon keeping the data redundant on their end as well, but in general, 
&gt;&gt; &gt; it's
&gt;&gt; &gt; a good tradeoff between increased performance through striping and 
&gt;&gt; &gt; increased
&gt;&gt; &gt; redundancy through mirroring. [1] has a good summary of when it's better to
&gt;&gt; &gt; choose RAID 5 vs. 10.
&gt;&gt; &gt;
&gt;&gt; &gt; RAID 0 will obviously bring the best performance, it's certainly a valid
&gt;&gt; &gt; setup. We've been running RAID 0 setups with 4 volumes, and got great
&gt;&gt; &gt; improvements over a single volume. You're also likely to achieve more
&gt;&gt; &gt; throughput on bigger instances with a setup like this. The caveat once 
&gt;&gt; &gt; again
&gt;&gt; &gt; is that one corrupted volume is enough to make a RAID 0 setup unusable.
&gt;&gt; &gt;
&gt;&gt; &gt; Another crazy thought is to setup a RAID striping across a bunch of
&gt;&gt; &gt; ephemeral drives and EBS volumes, maximizing throughput on both local and
&gt;&gt; &gt; network storage. But know what you're getting yourself into with this kind
&gt;&gt; &gt; of setup, especially when your write load is a lot heavier then the
&gt;&gt; &gt; available network bandwidth can handle, a scenario where your network
&gt;&gt; &gt; volumes will never be able to catch up with the local storage.
&gt;&gt; &gt;
&gt;&gt; &gt; All that said, EBS I/O sure is reasonably fast, but it depends on your
&gt;&gt; &gt; particular use case and performance requirements. It's also worth noting
&gt;&gt; &gt; that the I/O capabilities of EBS increase with the instance size. The 
&gt;&gt; &gt; bigger
&gt;&gt; &gt; your instance, the more throughput you'll achieve (see [3]). Bigger
&gt;&gt; &gt; instances tend to have better network throughput in general, with cluster
&gt;&gt; &gt; compute instances obviously having some of the highest bandwidth available.
&gt;&gt; &gt;
&gt;&gt; &gt; All this turns out to be much less of a problem when data can be held in
&gt;&gt; &gt; memory very easily, e.g. with Innostore, where you can read and write
&gt;&gt; &gt; to/from cache buffers first and then have InnoDB take care of flushing to
&gt;&gt; &gt; disk.
&gt;&gt; &gt;
&gt;&gt; &gt; Personally, I don't think you're overcomplicating things in regard to
&gt;&gt; &gt; multiple availability zones, it's a good idea to do that, when highest
&gt;&gt; &gt; availability possible is your goal, as when it's usually just a single
&gt;&gt; &gt; availability zone that's affected by increased latency or network timeouts,
&gt;&gt; &gt; but as Alexander said, you should think about having cross-datacenter
&gt;&gt; &gt; replication in that scenario, as availability zones are data centers 
&gt;&gt; &gt; located
&gt;&gt; &gt; in different physical locations. Usually they're not that far apart, but 
&gt;&gt; &gt; far
&gt;&gt; &gt; enough to increase latency considerably. But as always, it depends on your
&gt;&gt; &gt; particular use case.
&gt;&gt; &gt;
&gt;&gt; &gt; Now, after all this realtalk, here's the kicker. Riak's way of
&gt;&gt; &gt; replicating data can make both scenarios work. When it's ensured that your
&gt;&gt; &gt; data is replicated on more than one node, it can work in both ways. You
&gt;&gt; &gt; could use both ephemeral storage and be somewhat safe because data will
&gt;&gt; &gt; reside on multiple nodes. The same is true for EBS volumes, as potential
&gt;&gt; &gt; variances in I/O or even minutes of total unavailabilities (as seen on the
&gt;&gt; &gt; recent Reddit outage) can be recovered a lot easier thanks to handoff and
&gt;&gt; &gt; read repairs. You can increase the number of replicas (n\\_val) to increase
&gt;&gt; &gt; your tolerance of instance failure, just make sure that n\\_val is less than
&gt;&gt; &gt; the number of nodes in your cluster.
&gt;&gt; &gt;
&gt;&gt; &gt; Don't get me wrong, I love EC2 and EBS, being able to spin up servers at
&gt;&gt; &gt; any time and to attache more storage to a running instance is extremely
&gt;&gt; &gt; powerful, when you can handle the downsides. But if very low latency is 
&gt;&gt; &gt; what
&gt;&gt; &gt; you're looking for, raw iron with lots of memory and SSD as storage device
&gt;&gt; &gt; thrown on top is hard to beat.
&gt;&gt; &gt;
&gt;&gt; &gt; When in doubt, start with a RAID 0 setup on EBS with 4 volumes, and
&gt;&gt; &gt; compare it with a RAID 5 in terms of performance. They're known to give a
&gt;&gt; &gt; good enough performance in a lot of cases. If you decide to go with a RAID,
&gt;&gt; &gt; be sure to add LVM on top for simpler snapshotting, which will be quite
&gt;&gt; &gt; painful if not impossible to get consistent snapshots using just EBS
&gt;&gt; &gt; snapshots on a bunch of striped volumes.
&gt;&gt; &gt;
&gt;&gt; &gt; Let us know if you have more questions, there's lots of details involved
&gt;&gt; &gt; when you're going under the hood, but this should cover the most important
&gt;&gt; &gt; bases.
&gt;&gt; &gt;
&gt;&gt; &gt; Mathias Meyer
&gt;&gt; &gt; Developer Advocate, Basho Technologies
&gt;&gt; &gt;
&gt;&gt; &gt; [1]
&gt;&gt; &gt; http://en.wikipedia.org/wiki/RAID#RAID\\_10\\_versus\\_RAID\\_5\\_in\\_Relational\\_Databases
&gt;&gt; &gt; [2]
&gt;&gt; &gt; http://blog.cloudharmony.com/2010/09/benchmarking-of-ec2s-new-cluster.html
&gt;&gt; &gt; [3]
&gt;&gt; &gt; http://blog.cloudharmony.com/2010/06/disk-io-benchmarking-in-cloud.html
&gt;&gt; &gt; [4]
&gt;&gt; &gt; http://blog.bioteam.net/2010/07/boot-ephemeral-ebs-storage-performance-on-amazon-cc1-4xlarge-instance-types/
&gt;&gt; &gt; [5]
&gt;&gt; &gt; http://blog.bioteam.net/2010/07/local-storage-performance-of-aws-cluster-compute-instances/
&gt;&gt; &gt; [6]
&gt;&gt; &gt; http://blog.bioteam.net/2010/07/preliminary-ebs-performance-tests-on-amazon-compute-cluster-cc1-4xlarge-instance-types/
&gt;&gt; &gt; [7] http://victortrac.com/EC2\\_Ephemeral\\_Disks\\_vs\\_EBS\\_Volumes
&gt;&gt; &gt;
&gt;&gt; &gt; On Mittwoch, 30. März 2011 at 18:29, David Dawson wrote:
&gt;&gt; &gt;&gt; I am not sure if this has already been discussed, but I am looking at
&gt;&gt; &gt;&gt; the feasibility of running RIAK in a EC2 cloud, as we have a requirement
&gt;&gt; &gt;&gt; that may require us to scale up and down quite considerably on a month by
&gt;&gt; &gt;&gt; month basis. After some initial testing and investigation we have come to
&gt;&gt; &gt;&gt; the conclusion that there are 2 solutions although both have their 
&gt;&gt; &gt;&gt; downsides
&gt;&gt; &gt;&gt; in my opinion:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; 1. Run multiple cluster compute( cc1.4xlarge ) instances ( 23 GB RAM,
&gt;&gt; &gt;&gt; 10 Gigabit ethernet, 2 x 845 GB disks running RAID 0 )
&gt;&gt; &gt;&gt; 2. Same as above but using EBS as the storage instead of the local
&gt;&gt; &gt;&gt; disks.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; The problems I see are as follows with solution 1:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; - A instance failure results in complete loss of data on that machine,
&gt;&gt; &gt;&gt; as the disks are ephemeral storage ( e.g. they only exist whilst the 
&gt;&gt; &gt;&gt; machine
&gt;&gt; &gt;&gt; is up ).
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; The problems I see are as follows with solution 2:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; - EBS is slower than the local disks and from what I have read is
&gt;&gt; &gt;&gt; susceptible to latency depending on factors out of your control.
&gt;&gt; &gt;&gt; - There has been a bit of press lately about availability problems with
&gt;&gt; &gt;&gt; EBS, so we would have to use multiple availability zones although there 
&gt;&gt; &gt;&gt; are
&gt;&gt; &gt;&gt; only 4 in total and it just seems as though I am over complicating things.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Has anyone used EC2 and RIAK in production and if so what are their
&gt;&gt; &gt;&gt; experiences?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Otherwise has anyone used RackSpace or Joyent? as these are
&gt;&gt; &gt;&gt; alternatives although the Joyent solution seems very expensive, and what 
&gt;&gt; &gt;&gt; are
&gt;&gt; &gt;&gt; their experiences?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Dave
&gt;&gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt;&gt; riak-users mailing list
&gt;&gt; &gt;&gt; riak-users@lists.basho.com
&gt;&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

