---
title: "Re: Riak Join is Screwed Up"
description: ""
project: community
lastmod: 2012-05-03T04:42:10-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07379"
mailinglist_parent_id: "msg07378"
author_name: "Joseph Blomstedt"
project_section: "mailinglistitem"
sent_date: 2012-05-03T04:42:10-07:00
---


Yes, 'riak-admin join' is designed to join a node to a cluster, not a
cluster to another cluster. This behavior was different before Riak
1.0 (last September), but was changed as part of several changes to
make Riak's clustering layer more deterministic.

The short answer to the "why is this the case" is related to the fact
that Riak is a network-partition tolerant distributed database without
central coordination. If you have two separate clusters, both which
are receiving incoming client requests, and you try to join the two
clusters together during a network partition, there are very few
guarantees on deterministic behavior.

If clients can talk to all nodes in both clusters, but only some
subset of nodes in each cluster can talk to each other, you then end
up having clients talking to different nodes that have different
beliefs on what the cluster membership/topology is. This is even worse
if you have three clusters, and you concurrently issue a join between
1 and 2 and 2 and 3 during a similar partition scenario.

The more specific answer is that Riak provides certain guarantees by
ensuring that cluster changes logically appear to be totally ordered
events. The history of two completely independent clusters are
disjoint and cannot always be merged. This is solved for the single
node case by relaxing the constraint on total ordering. The cluster
you are joining still maintains a logically monotonic history. While
the node joining the cluster simply gives up it's history.
Specifically, the joining node asks the larger cluster for its cluster
information, and then atomically overwrites it's own view with that of
the cluster.

Regards,
Joe


On Thu, May 3, 2012 at 12:05 AM, Rebecca Meritz
 wrote:
&gt; I figured out a way to fix the problem. But I don't understand why the
&gt; solution works.
&gt;
&gt; Before A sent a join request to B and then B to C and the second request
&gt; failed.
&gt;
&gt; Now A sends a join request to B and then C to B and the second
&gt; request succeeds.
&gt;
&gt; Must a node that is the only member of its cluster always ask to join the
&gt; larger cluster for the request to succeed? Why is this?
&gt;
&gt; Thanks,
&gt; Rebecca
&gt;
&gt; On Thu, May 3, 2012 at 8:41 AM, Rebecca Meritz 
&gt; wrote:
&gt;&gt;
&gt;&gt; I'm testing a script that joins my riak ring on all machines. There is no
&gt;&gt; data in the database yet but I have repeated joined the ring an separated it
&gt;&gt; while working on the script that sets up the environment on my machines. The
&gt;&gt; ring is now in a bizarre state:
&gt;&gt;
&gt;&gt; [rebecca]$ riak-admin member\\_status
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; ================================= Membership
&gt;&gt; ==================================
&gt;&gt; Status     Ring    Pending    Node
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; valid      50.0%      --      'r...@xx.xxx.xx.10'
&gt;&gt; valid      50.0%      --      'r...@xx.xxx.xx.12'
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; Valid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt;&gt; [pay@payment-testing-gw2 ~]$ riak-admin join r...@xx.xxx.xx.14
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; Failed: This node is already a member of a cluster
&gt;&gt; [pay@payment-testing-gw2 ~]$ riak-admin force-remove r...@xx.xxx.xx.14
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; Failed: "r...@xx.xxx.xx.14" is not a member of the cluster.
&gt;&gt;
&gt;&gt; I cannot join a new member nor can I remove it.
&gt;&gt;
&gt;&gt; I've tried stop them all get them to leave, if they wouldn't leave I
&gt;&gt; forced their removal. I stopped them all. I even deleted the whole old ring
&gt;&gt; file before restarting.
&gt;&gt;
&gt;&gt; How can I fix this situations. What causes the above error?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Rebecca
&gt;
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
Joseph Blomstedt 
Software Engineer
Basho Technologies, Inc.
http://www.basho.com/

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

