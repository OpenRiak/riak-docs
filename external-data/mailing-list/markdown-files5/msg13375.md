---
title: "Re: Single node causing cluster to be extremely slow (leveldb)"
description: ""
project: community
lastmod: 2014-01-10T06:50:01-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13375"
mailinglist_parent_id: "msg13373"
author_name: "Sean McKibben"
project_section: "mailinglistitem"
sent_date: 2014-01-10T06:50:01-08:00
---


We need all the results right away anyway, so we don't paginate, so
once we get to 1.4.6+, being able to skip sorting ought to return some
speed to us (and maybe we will leave +S at 6:6). With our small ring
size and SSDs we see 3M keys returning in about 120 sec. While that
case isn't rare, there are only a handful of queries we run that
return over 1M. Will be interesting to compare the speed of unordered
result sets in 1.4.6.

So far, we did run into one case for a few days where some servers had
gotten some 2i corruption and were returning subsets. We had to make
multiple simultaneous requests and union the result sets to
compensate. Luckily we completely migrated (manually) to a new cluster
soon after, which resolved the issue. The additions to 1.4.6 seem like
they will be very helpful, should we encounter something similar
again.

I realize we use 2i in an atypical way, but by using meaningful keys
it is the fastest solution we've come across for retrieval of a set of
high churn, tag-indexed keys that won't fit in RAM. We do hope that
Yokozuna may replace 2i for us in a more horizontally-scalable way
with 2.0, but we haven't yet tested with that.

Thanks,
Sean

&gt; On Jan 10, 2014, at 7:09 AM, Matthew Von-Maszewski  wrote:
&gt;
&gt; Sean,
&gt;
&gt; Also you mentioned concern about +S 6:6. 2i queries in 1.4 added "sorting". 
&gt; Another heavy 2i user noticed that the sorting need more CPU for Erlang. 
&gt; They were happier after removing the +S.
&gt;
&gt; And finally, those 2i queries that return "millions of results" … how long do 
&gt; those queries take to execute?
&gt;
&gt; Matthew
&gt;
&gt;&gt; On Jan 9, 2014, at 9:33 PM, Sean McKibben  wrote:
&gt;&gt;
&gt;&gt; We have a 5 node cluster using elevelDB (1.4.2) and 2i, and this afternoon 
&gt;&gt; it started responding extremely slowly. CPU on member 4 was extremely high 
&gt;&gt; and we restarted that process, but it didn’t help. We temporarily shut down 
&gt;&gt; member 4 and cluster speed returned to normal, but as soon as we boot member 
&gt;&gt; 4 back up, the cluster performance goes to shit.
&gt;&gt;
&gt;&gt; We’ve run in to this before but were able to just start with a fresh set of 
&gt;&gt; data after wiping machines as it was before we migrated to this bare-metal 
&gt;&gt; cluster. Now it is causing some pretty significant issues and we’re not sure 
&gt;&gt; what we can do to get it back to normal, many of our queues are filling up 
&gt;&gt; and we’ll probably have to take node 4 off again just so we can provide a 
&gt;&gt; regular quality of service.
&gt;&gt;
&gt;&gt; We’ve turned off AAE on node 4 but it hasn’t helped. We have some transfers 
&gt;&gt; that need to happen but they are going very slowly.
&gt;&gt;
&gt;&gt; 'riak-admin top’ on node 4 reports this:
&gt;&gt; Load: cpu 610 Memory: total 503852 binary 
&gt;&gt; 231544
&gt;&gt; procs 804 processes 179850 code 
&gt;&gt; 11588
&gt;&gt; runq 134 atom 533 ets 
&gt;&gt; 4581
&gt;&gt;
&gt;&gt; Pid Name or Initial Func Time Reds Memory 
&gt;&gt; MsgQ Current Function
&gt;&gt; -------------------------------------------------------------------------------------------------------------------------------
&gt;&gt; &lt;6175.29048.3&gt; proc\\_lib:init\\_p/5 '-' 462231 51356760 
&gt;&gt; 0 mochijson2:json\\_bin\\_is\\_safe/1
&gt;&gt; &lt;6175.12281.6&gt; proc\\_lib:init\\_p/5 '-' 307183 64195856 
&gt;&gt; 1 gen\\_fsm:loop/7
&gt;&gt; &lt;6175.1581.5&gt; proc\\_lib:init\\_p/5 '-' 286143 41085600 
&gt;&gt; 0 mochijson2:json\\_bin\\_is\\_safe/1
&gt;&gt; &lt;6175.6659.0&gt; proc\\_lib:init\\_p/5 '-' 281845 13752 
&gt;&gt; 0 sext:decode\\_binary/3
&gt;&gt; &lt;6175.6666.0&gt; proc\\_lib:init\\_p/5 '-' 209113 21648 
&gt;&gt; 0 sext:decode\\_binary/3
&gt;&gt; &lt;6175.12219.6&gt; proc\\_lib:init\\_p/5 '-' 168832 16829200 
&gt;&gt; 0 riak\\_client:wait\\_for\\_query\\_results/4
&gt;&gt; &lt;6175.8403.0&gt; proc\\_lib:init\\_p/5 '-' 133333 13880 
&gt;&gt; 1 eleveldb:iterator\\_move/2
&gt;&gt; &lt;6175.8813.0&gt; proc\\_lib:init\\_p/5 '-' 119548 9000 
&gt;&gt; 1 eleveldb:iterator/3
&gt;&gt; &lt;6175.8411.0&gt; proc\\_lib:init\\_p/5 '-' 115759 34472 
&gt;&gt; 0 riak\\_kv\\_vnode:'-result\\_fun\\_ack/2-fun-0-'
&gt;&gt; &lt;6175.5679.0&gt; proc\\_lib:init\\_p/5 '-' 109577 8952 
&gt;&gt; 0 riak\\_kv\\_vnode:'-result\\_fun\\_ack/2-fun-0-'
&gt;&gt; Output server crashed: connection\\_lost
&gt;&gt;
&gt;&gt; Based on that, is there anything anyone can think to do to try to bring 
&gt;&gt; performance back in to the land of usability? Does this thing appear to be 
&gt;&gt; something that may have been resolved in 1.4.6 or 1.4.7?
&gt;&gt;
&gt;&gt; Only thing we can think of at this point might be to remove or force remove 
&gt;&gt; the member and join in a new freshly built one, but last time we attempted 
&gt;&gt; that (on a different cluster) our secondary indexes got irreparably damaged 
&gt;&gt; and only regained consistency when we copied every individual key to (this) 
&gt;&gt; new cluster! Not a good experience :( but i’m hopeful that 1.4.6 may have 
&gt;&gt; addressed some of our issues.
&gt;&gt;
&gt;&gt; Any help is appreciated.
&gt;&gt;
&gt;&gt; Thank you,
&gt;&gt; Sean McKibben
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

