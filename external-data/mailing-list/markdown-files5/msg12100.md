---
title: "Re: Riak Memory Bloat issues with RiakCS/BitCask"
description: ""
project: community
lastmod: 2013-08-20T16:34:47-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12100"
mailinglist_parent_id: "msg12097"
author_name: "Idan Shinberg"
project_section: "mailinglistitem"
sent_date: 2013-08-20T16:34:47-07:00
---


Thank you all for you kind and quick answers

However , even on a 3 node or 5 node cluster
We're still seeing memory bloat ( only much notably slower , as load is
distributed between more machines )

it's important to stress , this is an "read-append" only cluster - This
means the data never expires , and from the moment the cluster is
up , we keep adding data in the form of S3 puts ( of around 9MB objects ) ,
until we reach around 300K PUTS

This is also why merges don't happen ( no stale data )

Has anyone come across this situation in the past ?
does Riak even fit for something like this ?


Regards,

Idan Shinberg


System Architect

Idomoo Ltd.



Mob +972.54.562.2072

email idan.shinb...@idomoo.com

web www.idomoo.com

[image: Description: cid:FC66336E-E750-4C2D-B6E3-985D5A06B5BE@idomoo.co.il]


On Tue, Aug 20, 2013 at 11:32 AM, Erik Søe Sørensen  wrote:

&gt; Your max file size is (far!) less than your small file size threshold -
&gt; which means that at each merge, \\*all\\* of the files will participate in the
&gt; merge. No wonder you need a lot of simultaneously open files... and long
&gt; merge times too, of course.
&gt; Try changing these parameters.
&gt;
&gt;
&gt;
&gt; -------- Oprindelig meddelelse --------
&gt; Fra: Idan Shinberg 
&gt; Dato:
&gt; Til: riak-users 
&gt; Cc: Arik Katsav ,Assaf Fogel 
&gt; Emne: Riak Memory Bloat issues with RiakCS/BitCask
&gt;
&gt;
&gt; Hi all
&gt;
&gt; We have a ~300GB Riak Single Node Cluster
&gt; This seems to have worked fine ( merging worked good ) until an
&gt; OpenFile/OpenPorts limit was reached ( since then , we've tweaked both to
&gt; 64K )
&gt; The above error caused a crash that left corrupted hint files .We've
&gt; deleted the hint ( and their corrosponding the data files ) to allow a
&gt; clean start to riak ( no errors upon start) .
&gt;
&gt; However , merges have not been really working ( taking forever to
&gt; complete ) since then , therefor causing :
&gt;
&gt; \\* Huge Bloat on disk ( Data is around 150K objects of roughly 8MB each
&gt; , but has already more then quadrupled in size the riak storage used (
&gt; around 1.2 TB )
&gt; \\* Huge Bloat in memory , which eventually kills riak itself ( OOM
&gt; killer )
&gt;
&gt; We're not doing anything complex , just using riak and riak-cs to emulate
&gt; S3 access ( and only it ) for roughly 15 client writes per minute.
&gt;
&gt; Our merge settings ( uber-low , but have worked correctly in the up till a
&gt; few days ago ) :
&gt;
&gt; {riak\\_kv, [
&gt; %% Storage\\_backend specifies the Erlang module defining the
&gt; storage
&gt; %% mechanism that will be used on this node.
&gt; {add\\_paths, ["/usr/lib64/riak-cs/lib/riak\\_cs-1.3.1/ebin"]},
&gt; {storage\\_backend, riak\\_cs\\_kv\\_multi\\_backend},
&gt; {multi\\_backend\\_prefix\\_list, [{&lt;&lt;"0b:"&gt;&gt;, be\\_blocks}]},
&gt; {multi\\_backend\\_default, be\\_default},
&gt; {multi\\_backend, [
&gt; {be\\_default, riak\\_kv\\_eleveldb\\_backend, [
&gt; {max\\_open\\_files, 50},
&gt; {data\\_root, "/var/lib/riak/leveldb"}
&gt; ]},
&gt; {be\\_blocks, riak\\_kv\\_bitcask\\_backend, [
&gt;
&gt; {max\\_file\\_size, 16#2000000}, %% 32MB
&gt;
&gt; %% Trigger a merge if any of the following are
&gt; true:
&gt; {frag\\_merge\\_trigger, 10}, %% fragmentation &gt;= 10%
&gt; {dead\\_bytes\\_merge\\_trigger, 8388608}, %% dead bytes
&gt; &gt; 8 MB
&gt;
&gt; %% Conditions that determine if a file will be
&gt; examined during a merge:
&gt; {frag\\_threshold, 5}, %% fragmentation &gt;= 5%
&gt; {dead\\_bytes\\_threshold, 2097152}, %% dead bytes &gt; 2
&gt; MB
&gt; {small\\_file\\_threshold, 16#80000000}, %% file is &lt;
&gt; 2GB
&gt;
&gt; {data\\_root, "/var/lib/riak/bitcask"},
&gt; {log\\_needs\\_merge, true}
&gt;
&gt;
&gt; ]}
&gt; ]},
&gt;
&gt; As you've noticed , log\\_needs\\_merge is set to true and we do get our logs
&gt; filled with needs\\_merge messages such as this one :
&gt;
&gt; ,{"/var/l...",...},...]
&gt; 2013-08-19 00:09:49.043 [info] &lt;0.17972.0&gt;
&gt; "/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728"
&gt; needs\\_merge:
&gt; [{"/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/1153.bitcask.data",[{small\\_file,20506434}]},{"/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/1152.bitcask.data",[{small\\_file,33393237}]},{"/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/1151.bitcask.data",[{small\\_file,33123254}]},{"/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/1150.bitcask.data",[{small\\_file,32505520}]},{"/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/1149.
&gt; ...
&gt; ...
&gt; ...
&gt;
&gt; Yet a merge Only a single merge happened ( and only after around 20
&gt; minutes since we started putting pressure on the riak) :
&gt;
&gt; 2013-08-19 00:17:29.456 [info] &lt;0.18964.14&gt; Merged
&gt; {["/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/712.bitcask.data","/var/lib/riak/
&gt;
&gt; bitcask/388211372416021087647853783690262677096107081728/711.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/710.bitcask
&gt;
&gt; .data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/709.bitcask.data","/var/lib/riak/bitcask/38821137241602108764785378369026267709
&gt;
&gt; 6107081728/708.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/707.bitcask.data","/var/lib/riak/bitcask/388211
&gt; ...
&gt; ...
&gt; ...
&gt; var/lib/riak/bitc
&gt;
&gt; ask/388211372416021087647853783690262677096107081728/697.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/696.bitcask.dat
&gt;
&gt; a","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/695.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107
&gt;
&gt; 081728/694.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/693.bitcask.data","/var/lib/riak/bitcask/38821137241602108764
&gt;
&gt; 7853783690262677096107081728/692.bitcask.data","/var/lib/riak/bitcask/388211372416021087647853783690262677096107081728/691.bitcask.data","/var/lib/riak/bitcas
&gt; k/38821137241602108...",...],...} in 1325.611982 seconds.
&gt;
&gt; Is it reasonable for a merge to take more then 20 minutes ?
&gt; Especially assuming riak's memory usage is bloating much faster ?
&gt; Will Scaling the cluster from a single node to a 3-node cluster ease the
&gt; problem ?
&gt;
&gt; As for the server and usage specs
&gt;
&gt; - Virtual machine having around 8 virtual cores
&gt; - 12 GB of RAM
&gt; - 8 TB of Storage composed of 4 x 2TB disks in Raid 10 ( 4TB available
&gt; storage )
&gt; - ~150 keys several 10s of bytes long ( using Riak-CS for s3 storage ) .
&gt; - ~8MB value size for each key ( raw file )
&gt; - ~22000 Open files ( mostly hint files ) by riak
&gt; - Replication factor of 1
&gt; - Ring size is 64
&gt;
&gt; I'll provide the logs if needed , yet I doubt they'll prove useful .
&gt;
&gt; Any ideas/advice will be appreciated
&gt;
&gt;
&gt; Regards,
&gt;
&gt; Idan Shinberg
&gt;
&gt;
&gt; System Architect
&gt;
&gt; Idomoo Ltd.
&gt;
&gt;
&gt;
&gt; Mob +972.54.562.2072
&gt;
&gt; email idan.shinb...@idomoo.com
&gt;
&gt; web www.idomoo.com
&gt;
&gt; [cid:image001.jpg@01CE98F3.21F78EB0]
&gt;
&lt;&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

