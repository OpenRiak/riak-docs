---
title: "Re: Riak-CS issues when Riak endpoint fails-over to new server"
description: ""
project: community
lastmod: 2017-01-05T17:34:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17834"
mailinglist_parent_id: "msg17830"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2017-01-05T17:34:57-08:00
---


Hi Shaun,
We've been running Riak CS since its early days, so it's possible best
practice has changed.. but I'm sure at some point it was suggested to put a
haproxy between CS and KV to guard against the issues of start-up race
condition, individual KV losses, and brief KV restarts.
I'm sure we used to have continual issues with CS being dead on nodes
before we moved to the haproxy solution. That was probably on Debian
Squeeze though, and these days we're on Ubuntu LTS, and so if CS is
launched from Upstart at least it can retry to start, whereas on old-school
init systems it just gets one attempt and then dies.

Moving on though--

Even if it's not the majority practice, shouldn't CS still be able to
withstand dropping and reconnecting it's protocol buffer TCP connections?

CS still has a problem with not handling the case when its long-standing
idle PBC connections to KV get reset. Regardless of whether that's because
the local KV process is restarted, or because we've failed over to a new
haproxy.
The errors get pushed back to the S3 client software, but even if they
retry, they get repeated errors because, I think, CS has such a large pool
of PBC connections. You have to work through a large portion of this pool
before you finally get to one that's reconnected and is good.

In our case, the pool size is multiplied by the number of CS instances, so
quite a large number.
Most client software has retry limits built in, at much lower values.

While it will come good eventually, there's a significant period of time
where everything fails, all our monitoring goes red, etc. which we'd like
to avoid!

I'm surprised this problem doesn't come up more for other users; I don't
feel like we're running at a large scale.. but maybe we're using a more
dynamic architecture than major users.

Toby

On Thu, 5 Jan 2017 at 20:04 Shaun McVey  wrote:

&gt; Hi Toby,
&gt;
&gt; &gt; I thought that it was recommended AGAINST talking to a co-located Riak
&gt; on the same host?
&gt;
&gt; I'm not sure where you heard that from, but that's not the case. We do
&gt; discourage running other parts of an application on the same hosts, such as
&gt; client front-ends for example. From the top of my head (which means
&gt; there's probably an exception to the rule), all our customers have nodes
&gt; set up in the way Magnus described: one CS instance talking locally to its
&gt; KV instance directly on the same node. The load balancing comes between
&gt; the CS node and the client.
&gt;
&gt; Riak shouldn't take a particularly long time to start at all. We have
&gt; customers that have terabytes of data per node and a KV node can be
&gt; restarted in just a minute or two. As long as you have valid bitcask hint
&gt; files in place (which requires a proper shutdown beforehand), then a node
&gt; should come up quickly. If you have nodes that you feel are taking a
&gt; particularly long time to start up, that may be a symptom of another issue
&gt; unrelated to this discussion.
&gt;
&gt; If, for any reason, you need to shut down KV, you would then just remove
&gt; the CS node from the HAproxy configuration so it doesn't deal with any
&gt; requests. The other CS nodes then take the additional load. There
&gt; shouldn't be a need to restart CS if you remove it from the load balancer.
&gt; Having said that, you shouldn't have to worry about restarting CS as far as
&gt; I'm aware. You might see failures if KV is down, but once it's up and
&gt; running again, CS will continue to deal with new requests without
&gt; problems. Any failures to connect to its KV node should be passed to the
&gt; client/front-end, which should have all the proper logic for re-attempts or
&gt; error reporting.
&gt;
&gt; &gt; I'm surprised more people with highly-available Riak CS installations
&gt; haven't hit the same issues.
&gt;
&gt; As I mentioned, our customers go with the setup Magnus described. I can't
&gt; speak for setups like yours as I've not seen them in the wild.
&gt;
&gt; Kind Regards,
&gt; Shaun
&gt;
&gt; On Wed, Jan 4, 2017 at 11:26 PM, Toby Corkindale  wrote:
&gt;
&gt; Hi Magnus,
&gt; I thought that it was recommended AGAINST talking to a co-located Riak on
&gt; the same host?
&gt; The reason being, the local Riak will take longer to start up than Riak
&gt; CS, once you have a sizeable amount of data. This means Riak CS starts up,
&gt; fails to connect to Riak, and exits.
&gt; You also end up in a situation where you must always restart Riak CS if
&gt; you restart the co-located Riak. (Otherwise the Riak CS PBC connections
&gt; suffer the same problem as I described in my earlier email, where Riak CS
&gt; doesn't realise it needs to reconnect them and returns errors).
&gt;
&gt; Putting haproxy between Riak CS and Riak solved the problem of needing the
&gt; local Riak to be started first.
&gt; But it seems we just were putting the core problem off, rather than
&gt; solving it. ie. That Riak CS doesn't understand it needs to re-connect and
&gt; retry.
&gt;
&gt; I'm surprised more people with highly-available Riak CS installations
&gt; haven't hit the same issues.
&gt;
&gt; Toby
&gt;
&gt; On Wed, 4 Jan 2017 at 21:42 Magnus Kessler  wrote:
&gt;
&gt; Hi Toby,
&gt;
&gt; As far as I know Riak CS has none of the more advanced retry capabilities
&gt; that Riak KV has. However, in the design of CS there seems to be an
&gt; assumption that a CS instance will talk to a co-located KV node on the same
&gt; host. To achieve high availability, in CS deployments HAProxy is often
&gt; deployed in front of the CS nodes. Could you please let me know if this is
&gt; an option for your setup?
&gt;
&gt; Kind Regards,
&gt;
&gt; Magnus
&gt;
&gt;
&gt; On 4 January 2017 at 01:04, Toby Corkindale  wrote:
&gt;
&gt; Hello all,
&gt; Now that we're all back from the end-of-year holidays, I'd like to bump
&gt; this question up.
&gt; I feel like this has been a long-standing problem with Riak CS not
&gt; handling dropped TCP connections.
&gt; Last time the cause was haproxy dropping idle TCP connections after too
&gt; long, but we solved that at the haproxy end.
&gt;
&gt; This time, it's harder -- we're failing over to a different Riak backend,
&gt; so the TCP connections between Riak CS and Riak PBC \\*have\\* to go down, but
&gt; Riak CS just doesn't handle it well at all.
&gt;
&gt; Is there a trick to configuring it better?
&gt;
&gt; Thanks
&gt; Toby
&gt;
&gt;
&gt; On Thu, 22 Dec 2016 at 16:48 Toby Corkindale  wrote:
&gt;
&gt; Hi,
&gt; We've been seeing some issues with Riak CS for a while in a specific
&gt; situation. Maybe you can advise if we're doing something wrong?
&gt;
&gt; Our setup has redundant haproxy instances in front of a cluster of riak
&gt; nodes, for both HTTP and PBC. The haproxy instances share a floating IP
&gt; address.
&gt; Only one node holds the IP, but if it goes down, another takes it up.
&gt;
&gt; Our Riak CS nodes are configured to talk to the haproxy on that floating
&gt; IP.
&gt;
&gt; The problem occurs if the floating IP moves from one haproxy to another.
&gt;
&gt; Suddenly we see a flurry of errors in riak-cs log files.
&gt;
&gt; This is presumably because it was holding open TCP connections, and the
&gt; new haproxy instance doesn't know anything about them, so they get TCP
&gt; RESET and shutdown.
&gt;
&gt; The problem is that riak-cs doesn't try to reconnect and retry
&gt; immediately, instead it just throws a 503 error back to the client. Who
&gt; then retries, but Riak-CS has a pool of a couple of hundred connections to
&gt; cycle through, all of which throw the error!
&gt;
&gt; Does this sound like it is a likely description of the fault?
&gt; Do you have any ways to mitigate this issue in Riak CS when using TCP load
&gt; balancing above Riak PBC?
&gt;
&gt; Toby
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Magnus Kessler
&gt; Client Services Engineer
&gt; Basho Technologies Limited
&gt;
&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

