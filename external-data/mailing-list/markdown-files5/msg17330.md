---
title: "Re: Precommit hook function - no error log - how to debug?"
description: ""
project: community
lastmod: 2016-05-11T12:14:13-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17330"
mailinglist_parent_id: "msg17329"
author_name: "Sanket Agrawal"
project_section: "mailinglistitem"
sent_date: 2016-05-11T12:14:13-07:00
---


Yep, I can always load the module in question in riak console fine. I did
all my testing in riak console, before trying to turn on precommit hook.
Here is the output for loading the module that you asked for - if sasl
logging is not working, perhaps something is broken about commit hooks then:

$ ~/riak/riak1/bin/riak attach
&gt; (riak1@127.0.0.1)1&gt; m(precommit).
&gt; Module precommit compiled: Date: May 11 2016, Time: 02.05
&gt; Compiler options: []
&gt; Object file: /home/ec2-user/riak/customcode/precommit.beam
&gt; Exports:
&gt; module\\_info/0
&gt; module\\_info/1
&gt; pre\\_all/1
&gt; pre\\_uauth/1
&gt; pre\\_uprofile/1
&gt; pre\\_uuid/1
&gt; ok


On Wed, May 11, 2016 at 2:55 PM, Douglas Rohrer  wrote:

&gt; Huh - I get a huge amount of logging when I turn on sasl using
&gt; advanced.config - specifically, I have:
&gt;
&gt; {sasl,[{sasl\\_error\\_logger,{file, "/tmp/sasl-1.log"}}]}
&gt;
&gt; in my advanced.config, and for just a startup/shutdown cycle I get
&gt; a 191555 byte file.
&gt;
&gt; Just to confirm that you can, in fact, load the modules in question, what
&gt; happens if you do a `riak-admin attach` and do `m(precommit).` what do you
&gt; see?
&gt;
&gt; Doug
&gt;
&gt; On Wed, May 11, 2016 at 11:32 AM Sanket Agrawal 
&gt; wrote:
&gt;
&gt;&gt; Thanks, Doug. I have enabled sasl logging now through advanced.config
&gt;&gt; though it doesn't seem to be creating any log yet.
&gt;&gt;
&gt;&gt; If this might help you folks with debugging precommit issue, what I have
&gt;&gt; observed is that erl-reload command doesn't load the precommit modules for
&gt;&gt; any of the three nodes (though precommit hook has been enabled on one of
&gt;&gt; the buckets for testing).
&gt;&gt;
&gt;&gt;&gt; $ ~/riak/riak1/bin/riak-admin erl-reload
&gt;&gt;&gt; Module precommit not yet loaded, skipped.
&gt;&gt;&gt; Module rutils not yet loaded, skipped.
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, May 11, 2016 at 2:05 PM, Douglas Rohrer 
&gt;&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; As to the SASL logging, unfortunately it's not "on by default" and the
&gt;&gt;&gt; setting in riak.conf, as you found out, doesn't work correctly. However,
&gt;&gt;&gt; you can enable SASL via adding a setting to your advanced.config:
&gt;&gt;&gt;
&gt;&gt;&gt; {sasl,[{sasl\\_error\\_logger,tty}]} %% Enable TTY output for the SASL app
&gt;&gt;&gt; {sasl,[{sasl\\_error\\_logger,{file, "/path/to/log"}]} %% Enable SASL and
&gt;&gt;&gt; output to "/path/to/log" file
&gt;&gt;&gt;
&gt;&gt;&gt; We're evaluating if we shouldn't just remove the sasl setting from
&gt;&gt;&gt; riak.conf altogether, as you're the first person (that we know of) since
&gt;&gt;&gt; 2012 that has tried to turn it on and noticed this bug.
&gt;&gt;&gt;
&gt;&gt;&gt; Doug
&gt;&gt;&gt;
&gt;&gt;&gt; On Wed, May 11, 2016 at 10:14 AM Luke Bakken  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi Sanket -
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'd like to confirm some details. Is this a one-node cluster? Did you
&gt;&gt;&gt;&gt; install an official package or build from source?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks -
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; Luke Bakken
&gt;&gt;&gt;&gt; Engineer
&gt;&gt;&gt;&gt; lbak...@basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Tue, May 10, 2016 at 6:49 PM, Sanket Agrawal
&gt;&gt;&gt;&gt;  wrote:
&gt;&gt;&gt;&gt; &gt; One more thing - I set up the hooks by bucket, not bucket type. The
&gt;&gt;&gt;&gt; &gt; documentation for 2.1.4 says that hooks are defined on the bucket
&gt;&gt;&gt;&gt; level.
&gt;&gt;&gt;&gt; &gt; Here is how I set up precommit hook (derived from "Riak Handbook"
&gt;&gt;&gt;&gt; p95):
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; curl -X PUT localhost:8098/types/test\\_kv\\_wo/buckets/uuid\\_log/props -H
&gt;&gt;&gt;&gt; &gt; 'Content-Type: application/json' -d '{ "props": { "precommit":
&gt;&gt;&gt;&gt; [{"mod":
&gt;&gt;&gt;&gt; &gt; "precommit", "fun": "pre\\_uuid"}]}}' -v
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; On Tue, May 10, 2016 at 9:15 PM, Sanket Agrawal &lt;
&gt;&gt;&gt;&gt; sanket.agra...@gmail.com&gt;
&gt;&gt;&gt;&gt; &gt; wrote:
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; I just set up a precommit hook function in dev environment (KV 2.1.4)
&gt;&gt;&gt;&gt; &gt;&gt; which doesn't seem to be triggering off at all. The object is being
&gt;&gt;&gt;&gt; stored
&gt;&gt;&gt;&gt; &gt;&gt; in the bucket, but the precommit logic is not kicking off. I checked
&gt;&gt;&gt;&gt; couple
&gt;&gt;&gt;&gt; &gt;&gt; of things as listed below but came up with no error - so, it is a
&gt;&gt;&gt;&gt; &gt;&gt; head-scratcher why precommit hook is not triggering:
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; - Verify precommit is set in bucket properties - snippet from curl
&gt;&gt;&gt;&gt; query
&gt;&gt;&gt;&gt; &gt;&gt;&gt; for bucket props below:
&gt;&gt;&gt;&gt; &gt;&gt;&gt; "precommit":[{"mod":"precommit","fun":"pre\\_uuid"}]
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; - check there is no error in logs
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; - check riak-console for commit errors:
&gt;&gt;&gt;&gt; &gt;&gt;&gt; $ ./riak1/bin/riak-admin status|grep commit
&gt;&gt;&gt;&gt; &gt;&gt;&gt; postcommit\\_fail : 0
&gt;&gt;&gt;&gt; &gt;&gt;&gt; precommit\\_fail : 0
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; - Run the precommit function manually on Riak console itself with a
&gt;&gt;&gt;&gt; riak
&gt;&gt;&gt;&gt; &gt;&gt;&gt; object (that the hook failed to trigger on), and verify it works
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; Also, there is no sasl-error.log. "sasl = on" doesn't work in 2.1.4
&gt;&gt;&gt;&gt; &gt;&gt; because it fails with bad\\_config error. So, I am assuming sasl
&gt;&gt;&gt;&gt; logging is
&gt;&gt;&gt;&gt; &gt;&gt; enabled by default.
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; Here is what precommit function does:
&gt;&gt;&gt;&gt; &gt;&gt; - For the object (an immutable log append of JSON), calculate the
&gt;&gt;&gt;&gt; location
&gt;&gt;&gt;&gt; &gt;&gt; of a LWW bucket, and update a easily calculated key with that JSON
&gt;&gt;&gt;&gt; body. It
&gt;&gt;&gt;&gt; &gt;&gt; works fine from Riak console itself. Code below - we call pre\\_uuid in
&gt;&gt;&gt;&gt; &gt;&gt; precommit hook - both precommit.beam (where the function is) and
&gt;&gt;&gt;&gt; rutils.beam
&gt;&gt;&gt;&gt; &gt;&gt; have been copied to the relevant location as set in riak config, are
&gt;&gt;&gt;&gt; &gt;&gt; accessible through Riak console and work fine if manually executed
&gt;&gt;&gt;&gt; on an
&gt;&gt;&gt;&gt; &gt;&gt; object:
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; %% Preprocess JSON, and copy to a LWW bucket type
&gt;&gt;&gt;&gt; &gt;&gt;&gt; preprocessJ(RObj,B,Choplen) -&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; Bn = {rutils:calcBLWWType(RObj),B}, %%this returns the location
&gt;&gt;&gt;&gt; of LWW
&gt;&gt;&gt;&gt; &gt;&gt;&gt; bucket - works fine in riak console
&gt;&gt;&gt;&gt; &gt;&gt;&gt; %% We store uuid map in  key - we take out timestamp of
&gt;&gt;&gt;&gt; &gt;&gt;&gt; length 32 including "\\_"
&gt;&gt;&gt;&gt; &gt;&gt;&gt; K = riak\\_object:key(RObj),
&gt;&gt;&gt;&gt; &gt;&gt;&gt; Kn = binary:part(K,0,byte\\_size(K) - Choplen),
&gt;&gt;&gt;&gt; &gt;&gt;&gt; NObj =
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; riak\\_object:new(Bn,Kn,riak\\_object:get\\_value(RObj),riak\\_object:get\\_metadata(RObj)),
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {ok, C} = riak:local\\_client(),
&gt;&gt;&gt;&gt; &gt;&gt;&gt; case C:put(NObj) of
&gt;&gt;&gt;&gt; &gt;&gt;&gt; ok -&gt; RObj;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; \\_ -&gt; {fail,&lt;&lt;"Error when trying to process in precommit hook"&gt;&gt;}
&gt;&gt;&gt;&gt; &gt;&gt;&gt; end.
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; pre\\_uuid(RObj) -&gt; preprocessJ(RObj,&lt;&lt;"uuid\\_latest"&gt;&gt;,32).
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; Below is a manual execution from riak console of precommit function -
&gt;&gt;&gt;&gt; &gt;&gt; first we execute it to confirm it is returning the original object:
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; (riak1@127.0.0.1)5&gt; precommit:pre\\_uuid(O1).
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {r\\_object,{&lt;&lt;"test\\_kv\\_wo"&gt;&gt;,&lt;&lt;"uuid\\_log"&gt;&gt;},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; &lt;&lt;"ahmed\\_2016-05-10T20%3a47%3a47.346299Z"&gt;&gt;,
&gt;&gt;&gt;&gt; &gt;&gt;&gt; [{r\\_content,{dict,3,16,16,8,80,48,
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[[...]|...],[],...}}},
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &lt;&lt;"{\\"uname\\":\\"ahmed\\",\\"uuid\\":\\"df8c10e0-381d-5f65-bf43-cb8b4cb806fc\\",\\"timestamp\\":\\"2016-05-"...&gt;&gt;}],
&gt;&gt;&gt;&gt; &gt;&gt;&gt; [{&lt;&lt;0&gt;&gt;,{1,63630132467}}],
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {dict,1,16,16,8,80,48,
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; undefined}
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; Now, we check if the object has been written to test\\_lww/uuid\\_latest
&gt;&gt;&gt;&gt; &gt;&gt; bucket type:
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; (riak1@127.0.0.1)6&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; C:get({&lt;&lt;"test\\_lww"&gt;&gt;,&lt;&lt;"uuid\\_latest"&gt;&gt;},&lt;&lt;"ahmed"&gt;&gt;).
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {ok,{r\\_object,{&lt;&lt;"hnm\\_fsm\\_lww"&gt;&gt;,&lt;&lt;"uuid\\_latest"&gt;&gt;},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; &lt;&lt;"ahmed"&gt;&gt;,
&gt;&gt;&gt;&gt; &gt;&gt;&gt; [{r\\_content,{dict,4,16,16,8,80,48,
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;&gt;
&gt;&gt;&gt;&gt; &lt;&lt;"{\\"uname\\":\\"ahmed\\",\\"uuid\\":\\"df8c10e0-381d-5f65-bf43-cb8b4cb806fc\\",\\"timestamp\\":\\""...&gt;&gt;}],
&gt;&gt;&gt;&gt; &gt;&gt;&gt; [{&lt;&lt;153,190,230,200,210,126,212,127,0,0,156,65&gt;&gt;,
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {1,63630148036}}],
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {dict,1,16,16,8,80,48,
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt;&gt;&gt; &gt;&gt;&gt; undefined}}
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt; Will appreciate pointer on how to debug precommit hook.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

