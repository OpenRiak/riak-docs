---
title: "Re: Invalid hintfiles"
description: ""
project: community
lastmod: 2013-09-18T19:05:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12316"
mailinglist_parent_id: "msg12315"
author_name: "Seth Thomas"
project_section: "mailinglistitem"
sent_date: 2013-09-18T19:05:23-07:00
---


Toby,Although I haven't traced a root cause just yet I've had several reports in IRC of odd behavior when using nginx as a load balancer for Riak CS. In almost every case, removing nginx from the equation and switching to haproxy or pointing directly at the nodes in the application has resolved issues. It's anecdotal until I can actually determine a root cause but it's worth testing out if you're experiencing trouble. --Â Seth ThomasOn September 18, 2013 at 8:48:27 PM, Toby Corkindale (toby.corkind...@strategicdata.com.au) wrote: On 19/09/13 11:17, Luke Bakken wrote:
&gt; Hi Toby,
&gt;
&gt; Invalid hint files won't cause Riak to fail requests - there must have
&gt; been something else happening. Hint files are used by Riak to speed
&gt; start time when loading a large key set.
&gt;
&gt; You mentioned a "load-balancer pool" - are you using something like
&gt; HAProxy to load-balance requests to your Riak CS cluster?
&gt;
&gt; The "error: disconnected" message is a good clue. If you can provide
&gt; log files that may point to the cause.

Hi Luke,
I'm still seeing quite a few failed requests. I've been chasing the 
hintfiles but I guess that was a red herring.

We're using nginx to load balance requests to Riak CS.
I tried going directly to each node in turn, and it didn't show that any 
one node was reliably failing every request.

Hitting one server just now came up with OK/403/403/OK/OK.
Trying another was OK/OK/OK/OK/403 though.

Here's some logs from riak-cs:

error.log:2013-09-19 11:37:02.242 [error] 
&lt;0.5105.0&gt;@riak\\_cs\\_wm\\_common:maybe\\_create\\_user:223 Retrieval of user 
record for s3 failed. Reason: disconnected

There wasn't anything immediately either side of that. The riak logs for 
the same minute on that server likewise do not have anything.

There's quite a lot of free memory on the servers; they have 32000 file 
handles available.

Toby


&gt; On Wed, Sep 18, 2013 at 4:29 PM, Toby Corkindale
&gt;  wrote:
&gt;&gt; I found one Riak server was reporting a lot of errors like
&gt;&gt; [error] &lt;0.808.0&gt; Hintfile
&gt;&gt; '/var/lib/riak/bitcask/68507889249886074290797726533575766546371837952/3.bitcask.hint'
&gt;&gt; invalid
&gt;&gt;
&gt;&gt; And the Riak CS logs contained a lot of messages about being unable to
&gt;&gt; retrieve s3 user details because "error: disconnected"
&gt;&gt;
&gt;&gt; I think I've blown away the bad hintfiles and have had them repaired from
&gt;&gt; other replicas now, and I haven't seen any more errors for a little while.
&gt;&gt;
&gt;&gt; I'm not sure what caused those to become invalid.
&gt;&gt; Just a thought, but would be good if Riak could automatically repair them
&gt;&gt; rather than failing requests.
&gt;&gt;
&gt;&gt; Cheer,s
&gt;&gt; Toby
&gt;&gt;
&gt;&gt; On 19/09/13 08:42, Toby Corkindale wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Ah, hold on.. have just discovered that rather than it being deletion
&gt;&gt;&gt; calls, it seems to just be every X calls of any sort.. sounds like one
&gt;&gt;&gt; of the servers in the load-balancer pool must be misconfigured somehow,
&gt;&gt;&gt; but the rest are OK.
&gt;&gt;&gt;
&gt;&gt;&gt; On 19/09/13 08:34, Toby Corkindale wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I've just upgraded from Riak CS 1.3.1 to 1.4.1
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Using s3cmd to test a few things, I've found some odd behaviour.
&gt;&gt;&gt;&gt; Creating a bucket and putting a file works just fine, eg:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; s3cmd mb s3://test
&gt;&gt;&gt;&gt; s3cmd put README s3://test
&gt;&gt;&gt;&gt; s3cmd get s3://test/README
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; However if I try to delete a file or bucket, it throws an error:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; s3cmd del s3://test/README
&gt;&gt;&gt;&gt; ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you
&gt;&gt;&gt;&gt; provided does not exist in our records.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; s3cmd rb s3://test
&gt;&gt;&gt;&gt; ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you
&gt;&gt;&gt;&gt; provided does not exist in our records.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Have I messed something up during the upgrade, or is this a bug in 1.4.1?


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

