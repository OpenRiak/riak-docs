---
title: "Re: after raising of n_val all keys exists multiple times in	?keys=true"
description: ""
project: community
lastmod: 2013-03-07T14:02:19-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10359"
mailinglist_parent_id: "msg10349"
author_name: "Simon Effenberg"
project_section: "mailinglistitem"
sent_date: 2013-03-07T14:02:19-08:00
---


Any idea what happened? We have had to remove the riak db and started
from scratch to get rid of the ghost keys...

On Thu, 7 Mar 2013 11:35:12 +0100
Simon Effenberg  wrote:

&gt; Now we see only 3 occurrences of the keys. So maybe the reducing of the
&gt; n\\_val could be a problem.. after we removed the keys (or tried it) they
&gt; were deleted and in the keys=keys output only 3 (was 4 before) are
&gt; listed. So somehow the increasing n\\_val from 3 to 12 (factor 4...) and
&gt; then reducing again to 3 could be the problem. But I have no clue why
&gt; this should be the case.
&gt; 
&gt; Cheers,
&gt; Simon
&gt; 
&gt; On Thu, 7 Mar 2013 11:30:40 +0100
&gt; Simon Effenberg  wrote:
&gt; 
&gt; &gt; Hi Mark,
&gt; &gt; 
&gt; &gt; we have 12 Riak nodes running. The exact command for getting keys is:
&gt; &gt; 
&gt; &gt; curl http://localhost:8098/buckets/config/keys?keys=true
&gt; &gt; 
&gt; &gt; Properties are:
&gt; &gt; 
&gt; &gt; curl -s http://localhost:8098/riak/config | python -mjson.tool
&gt; &gt; {
&gt; &gt; "props": {
&gt; &gt; "allow\\_mult": true, 
&gt; &gt; "basic\\_quorum": false, 
&gt; &gt; "big\\_vclock": 50, 
&gt; &gt; "chash\\_keyfun": {
&gt; &gt; "fun": "chash\\_std\\_keyfun", 
&gt; &gt; "mod": "riak\\_core\\_util"
&gt; &gt; }, 
&gt; &gt; "dw": "quorum", 
&gt; &gt; "last\\_write\\_wins": false, 
&gt; &gt; "linkfun": {
&gt; &gt; "fun": "mapreduce\\_linkfun", 
&gt; &gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt; &gt; }, 
&gt; &gt; "n\\_val": 3, 
&gt; &gt; "name": "config", 
&gt; &gt; "notfound\\_ok": true, 
&gt; &gt; "old\\_vclock": 86400, 
&gt; &gt; "postcommit": [], 
&gt; &gt; "pr": 0, 
&gt; &gt; "precommit": [], 
&gt; &gt; "pw": 0, 
&gt; &gt; "r": "quorum", 
&gt; &gt; "rw": "quorum", 
&gt; &gt; "small\\_vclock": 50, 
&gt; &gt; "w": "quorum", 
&gt; &gt; "young\\_vclock": 20
&gt; &gt; }
&gt; &gt; }
&gt; &gt; 
&gt; &gt; you see that the n\\_val is now at 3 because of a bug in our tool which uses 
&gt; &gt; the Java client incorrect. Nevertheless we got multiple keys:
&gt; &gt; 
&gt; &gt; curl -s http://localhost:8098/buckets/config/keys?keys=true | python 
&gt; &gt; -mjson.tool | sort | uniq -c 
&gt; &gt; 4 
&gt; &gt; "com.xx.xx.xxx.yyy.yyy.yyy.BlockedAdFilterFactory:blocked-ads"
&gt; &gt; ....
&gt; &gt; 
&gt; &gt; We are using a n\\_val of 12 to get something like a DC awareness. Our 
&gt; &gt; software creates 4 buckets and one (the config bucket) is really small and 
&gt; &gt; another isn't that big. But both are important in a case of a split brain 
&gt; &gt; (inter DC connection went down). The other buckets holding most of the data 
&gt; &gt; are either distinct or can easily be merged.
&gt; &gt; 
&gt; &gt; We wanted to reproduce this but our problem is, the keys can't be really 
&gt; &gt; removed. I mean they are removed and you can't 'GET' them anymore and also 
&gt; &gt; a 'DELETE' is complaining about this fact and you can create the key again, 
&gt; &gt; fetch it again, remove it again but in the 
&gt; &gt; http://localhost:8098/buckets/config/keys?keys=true they are not 
&gt; &gt; disappearing (even after a rolling restart of the cluster).
&gt; &gt; 
&gt; &gt; Cheers,
&gt; &gt; Simon
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Wed, 6 Mar 2013 11:59:55 -0600
&gt; &gt; Mark Phillips  wrote:
&gt; &gt; 
&gt; &gt; &gt; Hey Simon,
&gt; &gt; &gt; 
&gt; &gt; &gt; A few questions for starters:
&gt; &gt; &gt; 
&gt; &gt; &gt; How many Riak nodes are in your cluster?
&gt; &gt; &gt; Is your R still the default of 2?
&gt; &gt; &gt; Out of curiosity, what's the use case for an n\\_val of 12? I think the
&gt; &gt; &gt; highest I've ever seen is 5 or 6. :)
&gt; &gt; &gt; 
&gt; &gt; &gt; Mark
&gt; &gt; &gt; 
&gt; &gt; &gt; On Wed, Mar 6, 2013 at 10:28 AM, Simon Effenberg
&gt; &gt; &gt;  wrote:
&gt; &gt; &gt; &gt; Hi,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; we changed the n\\_val of a bucket from 3 to 12. If we are now doing this:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; riak:8098/riak/config?keys=true
&gt; &gt; &gt; &gt; or
&gt; &gt; &gt; &gt; riak:8098/buckets/config/keys?keys=true
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; we get some keys multiple times. Getting the content works
&gt; &gt; &gt; &gt; well but we can't rely on the output (or have to sort/uniq the output).
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Is this a normal behavior or is it a bug? (Riak 1.3.0 is used with
&gt; &gt; &gt; &gt; eleveldb as backend).
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Cheers,
&gt; &gt; &gt; &gt; Simon
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; 
&gt; &gt; 
&gt; &gt; -- 
&gt; &gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; &gt; Fon: + 49-(0)30-8109 - 7173
&gt; &gt; Fax: + 49-(0)30-8109 - 7131
&gt; &gt; 
&gt; &gt; Mail: seffenb...@team.mobile.de
&gt; &gt; Web: www.mobile.de
&gt; &gt; 
&gt; &gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Geschäftsführer: Malte Krüger
&gt; &gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; &gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; &gt; 
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; -- 
&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; Fon: + 49-(0)30-8109 - 7173
&gt; Fax: + 49-(0)30-8109 - 7131
&gt; 
&gt; Mail: seffenb...@team.mobile.de
&gt; Web: www.mobile.de
&gt; 
&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; 
&gt; 
&gt; Geschäftsführer: Malte Krüger
&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


-- 
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon: + 49-(0)30-8109 - 7173
Fax: + 49-(0)30-8109 - 7131

Mail: seffenb...@team.mobile.de
Web: www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

