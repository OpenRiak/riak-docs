---
title: "Re: Corrupted Erlang binary term inside LevelDB"
description: ""
project: community
lastmod: 2013-07-30T12:43:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11818"
mailinglist_parent_id: "msg11813"
author_name: "Brian Sparrow"
project_section: "mailinglistitem"
sent_date: 2013-07-30T12:43:16-07:00
---


Hello List! 

Wanted to pass along the steps we used to get Vladimir's corrupted binary fixed 
and his transfers finished. If you have any questions please feel free to 
contact me directly.


OK. So correcting this issue is a multi-step operation. From a high level we 
are going to do the following:

1. Decode the bucket/key from the corrupted binary.
2. Identify the owning partitions of the binary.
3. Identify the corrupt copy.
4. Delete the corrupt replica directly from the backend so as not to affect the 
other (good) replicas
5. Force read-repair to re-populate all replicas

I have prepared a gist[1] with all the steps spelled out.

Please let me know if you have any issues/questions.

Thanks!
Brian

[1] https://gist.github.com/bsparrow435/6115630 

-- 
Brian Sparrow
Developer Advocate
Basho Technologies

Sent with Sparrow (http://www.sparrowmailapp.com/?sig)


On Tuesday, July 30, 2013 at 12:56 PM, Vladimir Shabanov wrote:

&gt; I've built and installed mv-error-logging-hack on one of my nodes. Will look 
&gt; into syslog once new BLOCKS.bad file appears.
&gt; 
&gt; Meanwhile I'm still waiting for doctor to solve problem with partition 
&gt; handoff. When he will arrive? Maybe there is already some "do it yourself" 
&gt; instructions available? 
&gt; 
&gt; 
&gt; 2013/7/26 Matthew Von-Maszewski  (mailto:matth...@basho.com)&gt;
&gt; &gt; Vladimir,
&gt; &gt; 
&gt; &gt; I have created a branch off the 1.3.2 release tag: mv-error-logging-hack
&gt; &gt; 
&gt; &gt; This has two changes:
&gt; &gt; 
&gt; &gt; - removes a late fix for database level locking that was added in 1.3.2 (to 
&gt; &gt; see if that was the problem source prior to its fix) 
&gt; &gt; 
&gt; &gt; - add test of all background file operations and log errors to syslog 
&gt; &gt; (since LOG handle not available)
&gt; &gt; 
&gt; &gt; 
&gt; &gt; When I build new version of leveldb, I make sure eleveldb also rebuilds. I 
&gt; &gt; do this via "rm eleveldb/c\\_src/\\*.o" followed by "cd eleveldb/c\\_src/leveldb; 
&gt; &gt; make clean" There is a pull request from another community user that makes 
&gt; &gt; the entire process cleaner. I just have not had time to review and approve 
&gt; &gt; it. 
&gt; &gt; 
&gt; &gt; I typically "grep beam /var/log/syslog" on my Debian system. The exact 
&gt; &gt; system log may vary due to your Linux implementation.
&gt; &gt; 
&gt; &gt; Let me know if this finds in any bugs. 
&gt; &gt; 
&gt; &gt; Matthew
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Jul 25, 2013, at 8:12 PM, Vladimir Shabanov  &gt; (mailto:vshaban...@gmail.com)&gt; wrote: 
&gt; &gt; &gt; I prefer second option since it will show are the corrupted blocks 
&gt; &gt; &gt; related to race condition. First option needs to be run for a long time 
&gt; &gt; &gt; to be completely sure that it really fixes the issue. 
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; 2013/7/26 Matthew Von-Maszewski  &gt; &gt; (mailto:matth...@basho.com)&gt;
&gt; &gt; &gt; &gt; Vladimir,
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I apologize for not recognizing your name and previous contribution. I 
&gt; &gt; &gt; &gt; just tend to think in terms of code and performance bottlenecks, not 
&gt; &gt; &gt; &gt; people.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Your June contribution resulted in changes that were released in 1.4 
&gt; &gt; &gt; &gt; and 1.3.2. I and the team thank you. However, we have not isolated 
&gt; &gt; &gt; &gt; the source of the corruption. We only know today that it does not 
&gt; &gt; &gt; &gt; happen very often. We have a second, high transaction site, that has 
&gt; &gt; &gt; &gt; seen the same issue. 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I can offer you two non-release options:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; - I have a branch to 1.4.0 that fixes a potential, but unproven, race 
&gt; &gt; &gt; &gt; condition. Details are here:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; https://github.com/basho/leveldb/wiki/mv-sst-fadvise 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; You would have to build eleveldb locally and copy it into your 
&gt; &gt; &gt; &gt; executable tree. The 1.4 leveldb and eleveldb work fine with Riak 
&gt; &gt; &gt; &gt; 1.3.x. should you desire to limit changes to your production 
&gt; &gt; &gt; &gt; environment. 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; - I have code, soon to be a branch against 1.3.2, that only adds syslog 
&gt; &gt; &gt; &gt; error messages to prove / disprove the race condition. You could take 
&gt; &gt; &gt; &gt; this code and see if it reports problems. This route would help the 
&gt; &gt; &gt; &gt; community and mostly me know the root cause is within the race 
&gt; &gt; &gt; &gt; condition addressed by the mv-sst-fadvise branch. 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; The two options above are what I currently have to offer. I am 
&gt; &gt; &gt; &gt; actively working to find the corruption source. The good news is that 
&gt; &gt; &gt; &gt; Riak will naturally recover from a "bad CRC" when detected. The bad 
&gt; &gt; &gt; &gt; news is that the Google defaults let some bad CRCs become good CRCs. 
&gt; &gt; &gt; &gt; Riak 1.4 and 1.3.2 cannot identify those bad CRCs that became good 
&gt; &gt; &gt; &gt; CRCs. 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Matthew
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Jul 25, 2013, at 4:32 PM, Vladimir Shabanov  &gt; &gt; &gt; (mailto:vshaban...@gmail.com)&gt; wrote: 
&gt; &gt; &gt; &gt; &gt; Good. Will wait for doctor.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; A month ago I mailed about segmentation fault
&gt; &gt; &gt; &gt; &gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2013-June/012245.html
&gt; &gt; &gt; &gt; &gt; After looking at core dumps you have found this problem with CRC 
&gt; &gt; &gt; &gt; &gt; checks being skipped. I enabled paranoid\\_checks and got my node up an 
&gt; &gt; &gt; &gt; &gt; running.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; I've also found that lost/BLOCKS.bad sometimes appears in partitions 
&gt; &gt; &gt; &gt; &gt; and have sent you these blocks for further analysis. 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; It's very interesting why corrupted data appears in the first place. 
&gt; &gt; &gt; &gt; &gt; Nodes didn't crashed, hardware didn't failed. As I mentioned 
&gt; &gt; &gt; &gt; &gt; previously all my machines are with ECC memory and Riak data is kept 
&gt; &gt; &gt; &gt; &gt; on ZFS filesystem (which also checks CRC for all the data and doesn't 
&gt; &gt; &gt; &gt; &gt; report any CRC errors). So it looks that data is somehow corrupted by 
&gt; &gt; &gt; &gt; &gt; Riak itself. 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; lost/BLOCKS.bad are usually small 2-8kb and appears very infrequently 
&gt; &gt; &gt; &gt; &gt; (once a week, once a month or never for many partitions). I found 
&gt; &gt; &gt; &gt; &gt; these BLOCKS.bad in both data/leveldb and data/anti\\_entropy. So I 
&gt; &gt; &gt; &gt; &gt; have suspicion that there is a bug in LevelDB. 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Looking at LOGs they are created during compactions:
&gt; &gt; &gt; &gt; &gt; "Moving corrupted block to lost/BLOCKS.bad (size 2393)"
&gt; &gt; &gt; &gt; &gt; but there is no more information. What kind of block is it, where it 
&gt; &gt; &gt; &gt; &gt; was found.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Is it possible to somehow find source of those BLOCKS.bad files? I'm 
&gt; &gt; &gt; &gt; &gt; building Riak from sources, maybe it's possible to enable some 
&gt; &gt; &gt; &gt; &gt; additional logging to find what these BLOCKS.bad are? 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 2013/7/25 Matthew Von-Maszewski  &gt; &gt; &gt; &gt; (mailto:matth...@basho.com)&gt;
&gt; &gt; &gt; &gt; &gt; &gt; Vladimir,
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; I can explain what happened, but not how to correct the problem. 
&gt; &gt; &gt; &gt; &gt; &gt; The gentleman that can walk you through a repair is tied up on 
&gt; &gt; &gt; &gt; &gt; &gt; another project, but he intends to respond as soon as he is able. 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; We recently discovered / realized that Google's leveldb code does 
&gt; &gt; &gt; &gt; &gt; &gt; not check the CRC of each block rewritten during a compaction. 
&gt; &gt; &gt; &gt; &gt; &gt; This means that blocks with bad CRCs get read without being flagged 
&gt; &gt; &gt; &gt; &gt; &gt; as bad, then rewritten to a new file with a new, valid CRC. The 
&gt; &gt; &gt; &gt; &gt; &gt; corruption is now hidden. 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; A more thorough discussion of the problem is found here:
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; https://github.com/basho/leveldb/wiki/mv-verify-compactions 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; We added code to the 1.3.2 and 1.4 Riak releases to have the block 
&gt; &gt; &gt; &gt; &gt; &gt; CRC checked during both read (Get) requests and compaction 
&gt; &gt; &gt; &gt; &gt; &gt; rewrites. This prevents future corruption hiding. Unfortunately, 
&gt; &gt; &gt; &gt; &gt; &gt; it does NOTHING for blocks already corrupted and rewritten with 
&gt; &gt; &gt; &gt; &gt; &gt; valid CRCs. You are encountering this latter condition. We have a 
&gt; &gt; &gt; &gt; &gt; &gt; developer advocate / client services person that has walked others 
&gt; &gt; &gt; &gt; &gt; &gt; through a fix via the Riak data replicas … 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; … please hold and the doctor will be with you shortly.
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; Matthew
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; On Jul 24, 2013, at 9:39 PM, Vladimir Shabanov 
&gt; &gt; &gt; &gt; &gt; &gt;  wrote: 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Hello,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Recently I've started expanding my Riak cluster and found that 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; handoffs were continuously retried for one partition. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Here are logs from two nodes 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; https://gist.github.com/vshabanov/41282e622479fbe81974
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; The most interesting parts of logs are
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "Handoff receiver for partition ... exited abnormally after 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; processing 2860338 objects: {{badarg,[{erlang,binary\\_to\\_term,..."
&gt; &gt; &gt; &gt; &gt; &gt; &gt; and
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "bad argument in call to erlang:binary\\_to\\_term(&lt;&lt;131,104,...."
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Both nodes are running Riak 1.3.2 (old one was running 1.3.1 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; previously).
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; When I've printed corrupted binary string I found that it 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; corresponds to one value. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; When I've tried to "get" it, it was read OK but node with 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; corrupted value shown the same binary\\_to\\_term error.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; When I've tried to delete corrupted value I've got timeout. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; I'm running machines with ECC memory and ZFS filesystem (which 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; doesn't report any checksum failures) so I doubt data was 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; silently corrupted on disk. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; LOG from corresponding LevelDB partition doesn't show any errors. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; But there is a lost/BLOCKS.bad file in this partition (7kb, 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; created more than a month ago and looks like it doesn't contain 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; corrupted value). 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; At the moment I've stopped handoffs using "risk-admin 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; transfer-limit 0".
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Why the value was corrupted? It there any way to remove it or fix 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; it? \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; &gt; &gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; &gt; &gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

