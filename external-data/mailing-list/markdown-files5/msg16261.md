---
title: "Re: uWSGI + Riak connection issues"
description: ""
project: community
lastmod: 2015-06-20T13:12:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16261"
mailinglist_parent_id: "msg16260"
author_name: "tele"
project_section: "mailinglistitem"
sent_date: 2015-06-20T13:12:00-07:00
---


Hi All,

This is going to be a long post but it explains exactly how to
reproduce the issue.

So i was able to nail down the part of code that is causing the issue.
Let me explain a little bit, in my app there is an API that gets me a
random content (key) from a bucket initially my implementation was like
this:

randn = random.randrange(0000, 9999)
results = content\\_bucket.search("id:\\*",fl="\\*,score", sort="random\\_%s
asc" % str(randn), start=0, rows=2) 
if len(results['docs']) == 0:
 raise ContentException('No content found')
images = []
for res in results['docs']:
 images.append(res['imageBinary'])

It was not the best in term of performance, so since that bucket does
not change i decided to do the following:

print 'content bucket'
content\\_bucket =riak\\_client.bucket\\_type('pickorflip\\_content').bucket('content') 
print 'cache content keys' 
content\\_keys = [] 
#content\\_keys = content\\_bucket.get\\_keys() 
for keys in content\\_bucket.stream\\_keys(): 
 for key in keys:
 content\\_keys.append(key)


I'm fully aware of NEVER user get\\_keys() and stream\\_keys() in
production but since it's only at startup and we are talking about
couple of thousand keys i don't see an issue in doing that. By storing
the keys on an array i can quickly randomly get 3 keys and get the
content i need much quickly than doing the riak search.

I'm sure it loads that code only at startup and not everytime because
i've added the print that gets printed only at startupt and not
everytime i call the API.

So i created another app in order to reproduce the issue:

/opt/myapp/myapp.py

import os, sys
from flask import Flask, request, Response, jsonify, g, url\\_for,
make\\_response, session import riak

app = Flask(\\_\\_name\\_\\_)
riak\\_client = riak.RiakClient(host='127.0.0.1', pb\\_port=10017,
protocol='pbc')

print 'Content bucket'
content\\_bucket =
riak\\_client.bucket\\_type('pickorflip\\_content').bucket('content')

print 'cache content keys'
content\\_keys = []
#content\\_keys = content\\_bucket.get\\_keys() 
for keys in content\\_bucket.stream\\_keys():
 for key in keys:
 content\\_keys.append(key)

@app.route("/")
def myapp():
 print 'get bucket'
 user\\_bucket = riak\\_client.bucket\\_type('user\\_type').bucket('users')
 print 'get user info from bucket'
 user\\_info = user\\_bucket.get('myuser')
 return '', 200


if \\_\\_name\\_\\_ == '\\_\\_main\\_\\_':
 app.run(
 host="0.0.0.0",debug=False,
 port=int("5000")
 )


The myapp.ini for uwsgi:

[uwsgi]
vhost = true
socket = /tmp/myapp.sock
venv = /opt/myapp/venv
chdir = /opt/myapp/
module = myapp
callable = app
processes = 4
close-on-exec=true
master = true
carbon = 10.21.1.1:2003
stats = /tmp/stats.sock
post-buffering = 1

nginx:

 location / {
 include uwsgi\\_params;
 uwsgi\\_pass unix:/tmp/myapp.sock;
 }



This is my locust load testing script:

test.py

from locust import HttpLocust, TaskSet, task

class LoadTest(TaskSet):

 @task
 def get\\_user(self):
 self.client.get("/")

class WebsiteUser(HttpLocust):
 task\\_set = LoadTest
 min\\_wait = 1000
 max\\_wait = 3000


And you can run it with: locust -H http://ip:port -f test.py

So while it's running i monitor with uwsgitop the socket

uwsgitop /tmp/stats.sock

So i can see what the workers are doing. After less than a minute all
the workers gets busy and stuck. But if i ran uwsgi with only one
process it works fine.

If i ran just flask with python myapp.py and then i loadtest against
port 5000 i do not hit this issue. So it's only when i use uwsgi and
multiple processes.

Any idea of what i could further troubleshoot to understand exactly why
the get\\_keys is causing the issue with multi processes in uwsgi ?
Considering that part of the code it's loaded only at startup of uwsgi
or maybe i'm missing something here?

Thank you

:tele

On Sat, 20 Jun 2015 02:59:20 -0500
tele  wrote:

&gt; Hi All,
&gt; 
&gt; I'm trying to troubleshoot an issue and i'm posting here because its
&gt; caused by connecting to Riak even if i may miss some configuration on
&gt; uwsgi. This is my enviroment:
&gt; 
&gt; nginx + uwsgi + flask app
&gt; 
&gt; The flask app uses Riak and Redis.
&gt; The connection between nginx and uwsgi is via unix socket.
&gt; 
&gt; If i use only one process in uwsgi i can easily run simultaneous
&gt; requests without hitting the issue i'm having. When i add even only
&gt; one more process all the workers gets busy and the app hangs. If i
&gt; remove the riak code part it's working fine, so the issue has to be
&gt; somewhere on the connection pooling or something else.
&gt; 
&gt; I'm experiencing the same issues as this user:
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2014-January/014387.html
&gt; 
&gt; If i use protobuf protocol i hit the DecodeErrors messages, sometimes
&gt; i don't get any error the app just hangs. If i use the http protocol
&gt; with riak, i don't get any exception but it just hangs.
&gt; 
&gt; It hangs on a simple snippet:
&gt; 
&gt; user\\_bucket = riak\\_client.bucket\\_type('user\\_type').bucket('users')
&gt; user\\_info = user\\_bucket.get(user\\_id)
&gt; 
&gt; I'm using Locust to generate traffic
&gt; 
&gt; 1 uwsgi worker, locust 10 users hatch 2 seconds = no issues
&gt; 2+ uwsgi worker, locust 10 users hatch 2 seconds = app hangs after few
&gt; minutes
&gt; 
&gt; For Riak i have 3 nodes running on the same box, i'm using the latest
&gt; version from git.
&gt; 
&gt; The app hangs in any of those connection scenarios:
&gt; 
&gt; riak\\_client = riak.RiakClient(host='127.0.0.1', pb\\_port=10017,
&gt; protocol='pbc') riak\\_client = riak.RiakClient(protocol='pbc',
&gt; nodes=[{'host':'127.0.0.1', 'pb\\_port':10017},{'host':'127.0.0.1',
&gt; 'pb\\_port':10027},{'host':'127.0.0.1', 'pb\\_port':10037}]) riak\\_client =
&gt; riak.RiakClient(protocol='http', http\\_port=10018, host='127.0.0.1')
&gt; riak\\_client = riak.RiakClient(protocol='http',
&gt; nodes=[{'host':'127.0.0.1', 'http\\_port':10018},{'host':'127.0.0.1',
&gt; 'http\\_port':10028},{'host':'127.0.0.1', 'http\\_port':10038}])
&gt; 
&gt; My uwsgi config is the following:
&gt; 
&gt; [uwsgi]
&gt; vhost = true
&gt; socket = /tmp/app.sock
&gt; venv = /opt/app/venv
&gt; chdir = /opt/app/
&gt; module = myapp
&gt; callable = app
&gt; processes = 2
&gt; master = true
&gt; close-on-exec=true
&gt; master = true
&gt; post-buffering = 1
&gt; carbon = 127.0.0.1:2003
&gt; stats = /tmp/stats.sock
&gt; 
&gt; If i sniff the network traffic, when it hangs uwsgi basically stops
&gt; sending any request to riak, all the workers becomes busy and the only
&gt; way to restore it it's a restart of uwsgi.
&gt; 
&gt; My SW versions are the following:
&gt; 
&gt; Riak latest from git.
&gt; 
&gt; Python libs:
&gt; riak (2.2.0)
&gt; riak-pb (2.0.0.16)
&gt; protobuf (2.5.0)
&gt; 
&gt; UWSGI: 2.0.10
&gt; 
&gt; Any idea on how i can troubleshoot this issue? It seems related to
&gt; uwsgi but it's happening only when using the Riak connection.
&gt; 
&gt; Thank you
&gt; 
&gt; :tele
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

