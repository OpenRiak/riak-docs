---
title: "Re: Very slow acquisition time (99 percentile) while fast median times"
description: ""
project: community
lastmod: 2016-05-03T13:49:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17285"
mailinglist_parent_id: "msg17275"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2016-05-03T13:49:09-07:00
---


Guillaume,

A prebuilt eleveldb 2.0.18 for Debian 7 is found here:
 
https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.18/eleveldb\\_2.0.18\\_debian7.tgz
 


There are good instructions for applying an eleveldb patch here:

 
http://docs.basho.com/community/productadvisories/leveldbsegfault/#patch-eleveldb-so

Key points about the above web page:

- use the eleveldb patch file link in this email, NOT links on the web page

- the Debian directory listed on the web page will be slightly different than 
your Riak 2.1.4 installation:
 
 /usr/lib/riak/lib/eleveldb-/priv/


Matthew


&gt; On May 3, 2016, at 1:01 PM, Matthew Von-Maszewski  wrote:
&gt; 
&gt; Guillaume,
&gt; 
&gt; I have reviewed the debug package for your riak1 server. There are two 
&gt; potential areas of follow-up:
&gt; 
&gt; 1. You are running our most recent Riak 2.1.4 which has eleveldb 2.0.17. We 
&gt; have seen a case where a recent feature in eleveldb 2.0.17 caused too much 
&gt; cache flushing, impacting leveldbâ€™s performance. A discussion is here:
&gt; 
&gt; https://github.com/basho/leveldb/wiki/mv-timed-grooming2 
&gt; 
&gt; 
&gt; 2. Yokozuna search was recently updated for some timeout problems. Those 
&gt; updates are not yet in a public build. One of our other engineers is likely 
&gt; to respond to you on that topic.
&gt; 
&gt; 
&gt; An eleveldb 2.0.18 is tagged and available via github if you want to build it 
&gt; yourself. Otherwise, Basho may be releasing prebuilt patches of eleveldb 
&gt; 2.0.18 in the near future. But no date is currently set.
&gt; 
&gt; Matthew
&gt; 
&gt;&gt; On May 3, 2016, at 10:50 AM, Luke Bakken &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; Guillaume -
&gt;&gt; 
&gt;&gt; You said earlier "My data are stored on an openstack volume that
&gt;&gt; support up to 3000IOPS". There is a likelihood that your write load is
&gt;&gt; exceeding the capacity of your virtual environment, especially if some
&gt;&gt; Riak nodes are sharing physical disk or server infrastructure.
&gt;&gt; 
&gt;&gt; Some suggestions:
&gt;&gt; 
&gt;&gt; \\* If you're not using Riak Search, set "search = off" in riak.conf
&gt;&gt; 
&gt;&gt; \\* Be sure to carefully read and apply all tunings:
&gt;&gt; http://docs.basho.com/riak/kv/2.1.4/using/performance/ 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\* You may wish to increase the memory dedicated to leveldb:
&gt;&gt; http://docs.basho.com/riak/kv/2.1.4/configuring/backend/#leveldb
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; Engineer
&gt;&gt; lbak...@basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Tue, May 3, 2016 at 7:33 AM, Guillaume Boddaert
&gt;&gt;  wrote:
&gt;&gt;&gt; Hi,
&gt;&gt;&gt; 
&gt;&gt;&gt; Sorry for the delay, I've spent a lot of time trying to understand if the
&gt;&gt;&gt; problem was elsewhere.
&gt;&gt;&gt; I've simplified my infrastructure and got a simple layout that don't rely
&gt;&gt;&gt; anymore on loadbalancer and also corrected some minor performance issue on
&gt;&gt;&gt; my workers.
&gt;&gt;&gt; 
&gt;&gt;&gt; At the moment, i have up to 32 workers that are calling riak for writes,
&gt;&gt;&gt; each of them are set to :
&gt;&gt;&gt; w=1
&gt;&gt;&gt; dw=0
&gt;&gt;&gt; timeout=1000
&gt;&gt;&gt; using protobuf
&gt;&gt;&gt; a timeouted attempt is rerun 180s later
&gt;&gt;&gt; 
&gt;&gt;&gt; From my application server perspective, 23% of the calls are rejected by
&gt;&gt;&gt; timeout (75446 tries, 57564 success, 17578 timeout).
&gt;&gt;&gt; 
&gt;&gt;&gt; Here is a sample riak-admin stat for one of my 5 hosts:
&gt;&gt;&gt; 
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_100 : 999331
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_95 : 773682
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_99 : 959444
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_mean : 156242
&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_median : 20235
&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_100 : 5267527
&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_95 : 2437457
&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_99 : 4819538
&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_mean : 175567
&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_median : 6928
&gt;&gt;&gt; 
&gt;&gt;&gt; I am using leveldb, so i can't tune bitcask backend as suggested.
&gt;&gt;&gt; 
&gt;&gt;&gt; I've changed the vmdirty settings and enabled them:
&gt;&gt;&gt; admin@riak1:~$ sudo sysctl -a | grep dirtyvm.dirty\\_background\\_ratio = 0
&gt;&gt;&gt; vm.dirty\\_background\\_bytes = 209715200
&gt;&gt;&gt; vm.dirty\\_ratio = 40
&gt;&gt;&gt; vm.dirty\\_bytes = 0
&gt;&gt;&gt; vm.dirty\\_writeback\\_centisecs = 100
&gt;&gt;&gt; vm.dirty\\_expire\\_centisecs = 200
&gt;&gt;&gt; 
&gt;&gt;&gt; I've seen less idle time between writes, iostat is showing near constant
&gt;&gt;&gt; writes between 20 and 500 kb/s, with some surges around 4000 kb/s. That's
&gt;&gt;&gt; better, but not that great.
&gt;&gt;&gt; 
&gt;&gt;&gt; Here is the current configuration for my "activity\\_fr" bucket type and
&gt;&gt;&gt; "tweet" bucket:
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/props
&gt;&gt;&gt; HTTP/1.1 200 OK
&gt;&gt;&gt; Content-Encoding: gzip
&gt;&gt;&gt; Content-Length: 314
&gt;&gt;&gt; Content-Type: application/json
&gt;&gt;&gt; Date: Tue, 03 May 2016 14:30:21 GMT
&gt;&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt;&gt; Vary: Accept-Encoding
&gt;&gt;&gt; {
&gt;&gt;&gt; "props": {
&gt;&gt;&gt; "active": true,
&gt;&gt;&gt; "allow\\_mult": false,
&gt;&gt;&gt; "basic\\_quorum": false,
&gt;&gt;&gt; "big\\_vclock": 50,
&gt;&gt;&gt; "chash\\_keyfun": {
&gt;&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt;&gt; },
&gt;&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt;&gt;&gt; "dvv\\_enabled": false,
&gt;&gt;&gt; "dw": "quorum",
&gt;&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt;&gt; "linkfun": {
&gt;&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt;&gt; },
&gt;&gt;&gt; "n\\_val": 3,
&gt;&gt;&gt; "notfound\\_ok": true,
&gt;&gt;&gt; "old\\_vclock": 86400,
&gt;&gt;&gt; "postcommit": [],
&gt;&gt;&gt; "pr": 0,
&gt;&gt;&gt; "precommit": [],
&gt;&gt;&gt; "pw": 0,
&gt;&gt;&gt; "r": "quorum",
&gt;&gt;&gt; "rw": "quorum",
&gt;&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt;&gt; "small\\_vclock": 50,
&gt;&gt;&gt; "w": "quorum",
&gt;&gt;&gt; "young\\_vclock": 20
&gt;&gt;&gt; }
&gt;&gt;&gt; }
&gt;&gt;&gt; 
&gt;&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/buckets/tweet/props
&gt;&gt;&gt; HTTP/1.1 200 OK
&gt;&gt;&gt; Content-Encoding: gzip
&gt;&gt;&gt; Content-Length: 322
&gt;&gt;&gt; Content-Type: application/json
&gt;&gt;&gt; Date: Tue, 03 May 2016 14:30:02 GMT
&gt;&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt;&gt; Vary: Accept-Encoding
&gt;&gt;&gt; 
&gt;&gt;&gt; {
&gt;&gt;&gt; "props": {
&gt;&gt;&gt; "active": true,
&gt;&gt;&gt; "allow\\_mult": false,
&gt;&gt;&gt; "basic\\_quorum": false,
&gt;&gt;&gt; "big\\_vclock": 50,
&gt;&gt;&gt; "chash\\_keyfun": {
&gt;&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt;&gt; },
&gt;&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt;&gt;&gt; "dvv\\_enabled": false,
&gt;&gt;&gt; "dw": "quorum",
&gt;&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt;&gt; "linkfun": {
&gt;&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt;&gt; },
&gt;&gt;&gt; "n\\_val": 3,
&gt;&gt;&gt; "name": "tweet",
&gt;&gt;&gt; "notfound\\_ok": true,
&gt;&gt;&gt; "old\\_vclock": 86400,
&gt;&gt;&gt; "postcommit": [],
&gt;&gt;&gt; "pr": 0,
&gt;&gt;&gt; "precommit": [],
&gt;&gt;&gt; "pw": 0,
&gt;&gt;&gt; "r": "quorum",
&gt;&gt;&gt; "rw": "quorum",
&gt;&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt;&gt; "small\\_vclock": 50,
&gt;&gt;&gt; "w": "quorum",
&gt;&gt;&gt; "young\\_vclock": 20
&gt;&gt;&gt; }
&gt;&gt;&gt; }
&gt;&gt;&gt; 
&gt;&gt;&gt; I really don't know what to do. Can you help ?
&gt;&gt;&gt; 
&gt;&gt;&gt; Guillaume
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

