---
title: "Re: Handoffs are too slow after netsplit"
description: ""
project: community
lastmod: 2017-02-24T09:28:36-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18032"
mailinglist_parent_id: "msg18031"
author_name: "Andrey Ershov"
project_section: "mailinglistitem"
sent_date: 2017-02-24T09:28:36-08:00
---


Thanks guys for your replies.

Charlie, I've seen a ticket regarding this issue
https://github.com/basho/riak/issues/754 - I'm not calling vnode-status
command.
Douglas, I suppose vnode\\_inactivity\\_timeout

should
not influence riak\\_core\\_vnode\\_manager:force\\_handoff() execution time. As
far as I understand, when vnode\\_inactivity\\_timeout has triggered, vnode
initiates takeoff, but here I'm forcing take off and it does not start
right away.
Anyway, I've set vnode\\_inactivity\\_timeout to 2 seconds and no longer call
foce\\_handoff. Seems that handoffs are now faster, but still might take up
to 30 seconds.
Guys, probably there is some other timer should trigger before takeoff can
proceed?


2017-02-24 20:20 GMT+03:00 Charlie Voiselle :

&gt; Andrey:
&gt;
&gt; Another thing that can stall handoff is running commands that reset the
&gt; vnode activity timer. The `riak-admin vnode-status` command will reset the
&gt; activity timer and should never be run more frequently that then vnode
&gt; inactivity timeout; if you do, that can permanently stall handoff. We have
&gt; seen this before at a customer site where they were collecting the statics
&gt; from the vnode-status command into their metrics system.
&gt;
&gt; Regards,
&gt; Charlie Voiselle
&gt;
&gt;
&gt; On Feb 23, 2017, at 7:14 AM, Douglas Rohrer  wrote:
&gt;
&gt; Andrey:
&gt;
&gt; It's waiting for 60 seconds, literally...
&gt;
&gt; See https://github.com/basho/riak\\_core/search?utf8=%E2%9C%
&gt; 93&q=vnode\\_inactivity\\_timeout - handoff is not initiated until a vnode
&gt; has been inactive for the specified inactivity period.
&gt;
&gt; For demonstration purposes, if you want to reduce this time, you could set
&gt; the riak\\_core.vnode\\_inactivity\\_timeout period lower ,which can be set in
&gt; advanced.config. Also note that, depending on the backend you use, it's
&gt; possible to have other settings set lower than the vnode inactivity
&gt; timeout, you can actually prevent handoff completely - see
&gt; http://docs.basho.com/riak/kv/2.2.0/setup/planning/
&gt; backend/bitcask/#sync-strategy, for examnple.
&gt;
&gt; Hope this helps.
&gt;
&gt; Doug
&gt;
&gt; On Thu, Feb 23, 2017 at 6:40 AM Andrey Ershov 
&gt; wrote:
&gt;
&gt; Hi, guys!
&gt;
&gt; I'd like to follow up on handoffs behaviour after netsplit. The problem is
&gt; that right after network partition is healed, "riak-admin transfers"
&gt; command says that there are X partitions waiting transfer from one node to
&gt; another, and Y partitions waiting transfer in the opposite direction. What
&gt; are they waiting for? Active transfers section is always empty. It takes
&gt; about 1 minute for transfer to occur. I've increased transfer\\_limit to 100
&gt; and it does not help.
&gt; Also I've tried to attach to Erlang VM and execute
&gt; riak\\_core\\_vnode\\_manager:force\\_handoff() on each node. This command
&gt; returns 'ok'. But seems that it does not work right after network is
&gt; healed. After some time 30-60 s, force\\_handoff() works as expected, but
&gt; actually it's the same latency as in auto handoff case.
&gt;
&gt; So what is it waiting for? Any ideas?
&gt;
&gt; I'm preparing real-time coding demo to be shown on the conference. So it's
&gt; too much time to wait for 1 minute for handoff to occur just for a couple
&gt; of keys...
&gt; --
&gt; Thanks,
&gt; Andrey
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;


-- 
С уважением,
Ершов Андрей
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

