---
title: "Re: empty sibling after a DELETE then PUT"
description: ""
project: community
lastmod: 2011-10-06T10:14:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05076"
mailinglist_parent_id: "msg05065"
author_name: "Eric Moritz"
project_section: "mailinglistitem"
sent_date: 2011-10-06T10:14:27-07:00
---


It seems to me that occasional tombstone siblings may occur in the case
where two clients fetch the same vclock and concurrently do a delete and a
put.

If this is the case, there appears to be no way to differentiate a sibling
which intentionally has no content from a tombstone. Is that correct?
On Oct 6, 2011 3:22 AM, "Roland Karlsson" &lt;
roland.karls...@erlang-solutions.com&gt; wrote:
&gt; Hi,
&gt;
&gt; Look at the answers to my question "Delete takes 5 seconds in RIAK 1.0 ??"
&gt;
&gt; And I actually found that the tombstone seemed to be able to live forever.
&gt;
&gt; The tombstone is nearly treated as an existing object.
&gt;
&gt;
&gt; /Roland
&gt;
&gt;
&gt;
&gt; ----- Original Message -----
&gt; From: "Eric Moritz" 
&gt; To: "Jon Meredith" 
&gt; Cc: riak-users@lists.basho.com
&gt; Sent: Thursday, October 6, 2011 12:28:19 AM
&gt; Subject: Re: empty sibling after a DELETE then PUT
&gt;
&gt; What I am trying to model is a concurrent DELETE and a concurrent PUT
&gt; where both operations use the same source VClock. When I do a GET
&gt; after those concurrent operations is an object with two siblings; One
&gt; blank and one with the data.
&gt;
&gt; Is the reconciliation of those two values, the responsibility of the
&gt; application and if so, do we need to treat empty bodies as tombstones?
&gt;
&gt; Thanks,
&gt; Eric.
&gt;
&gt; On Wed, Oct 5, 2011 at 6:21 PM, Jon Meredith  wrote:
&gt;&gt; Hi Eric,
&gt;&gt; What you are seeing is probably a result of some changes we've made to
&gt;&gt; deletes. After you issue the DELETE, Riak creates a tombstone object
first
&gt;&gt; and then removes it. 1.0 now adds a delay of 3s by default. If you do a
&gt;&gt; get during that time you should see an X-Riak-Vclock line for the 404
&gt;&gt; message after the delete.
&gt;&gt; If you use that vclock with the put then the tombstone will be removed.
 The
&gt;&gt; feature wasn't well publicized so has not made it into the clients yet.
&gt;&gt; There should be more info to follow on deletes soon. If you really want
&gt;&gt; the old behavior, add {delete\\_mode, immediate} to the riak\\_kv section of
&gt;&gt; your app.config
&gt;&gt; Jon Meredith
&gt;&gt; Basho Technologies.
&gt;&gt; On Wed, Oct 5, 2011 at 1:13 PM, Eric Moritz 
&gt;&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; If I enabled allow\\_multi on a bucket and do I DELETE followed by a PUT
&gt;&gt;&gt; I am getting a 300 response with one sibling having the body of the
&gt;&gt;&gt; PUT and a second sibling with an empty body. If that the expected
&gt;&gt;&gt; behavior?
&gt;&gt;&gt;
&gt;&gt;&gt; I wrote a script that would start with a reconciled value. Get the
&gt;&gt;&gt; VClock of the current value. Then do every permutation of a PUT with
&gt;&gt;&gt; (Pv) and without (P) the VClock and a DELETE with (Dv) and without (D)
&gt;&gt;&gt; the vClock and I see the following result:
&gt;&gt;&gt;
&gt;&gt;&gt; Pv Dv 404
&gt;&gt;&gt; Dv Pv 300
&gt;&gt;&gt; Pv D 404
&gt;&gt;&gt; D Pv 300
&gt;&gt;&gt;
&gt;&gt;&gt; Is it expected that a delete creates a blank sibling like that and
&gt;&gt;&gt; therefore we should treat empty body's as deleted?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Eric Moritz.
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

