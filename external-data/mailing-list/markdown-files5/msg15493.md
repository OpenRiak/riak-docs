---
title: "Re: Java Client and clobber update"
description: ""
project: community
lastmod: 2015-01-14T13:33:05-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15493"
mailinglist_parent_id: "msg15492"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2015-01-14T13:33:05-08:00
---


Cosmin -

It would appear that the crazy generics involved are indeed broken
when it comes to UpdateValue the "ClobberUpdate" - it's not pulling
out the type correctly. I'll have to try and figure out why that is.
Type erasure will make you weep ;)

Two ways to deal with it at the moment:

A) Pass in a TypeReference explicitly:

TypeReference tRef = new TypeReference(){};
...
.withUpdate(UpdateValue.Update.clobberUpdate(entity), tRef)
...

B) Create your own class that subclasses UpdateValue.Update that does
the same thing as a "clobber update" :

public static class UpdateEntity extends UpdateValue.Update
{
 private final SomeEntity entity;

 public UpdateEntity(SomeEntity e)
 {
 this.entity = e;
 }

 @Override
 public SomeEntity apply(SomeEntity original)
 {
 return entity;
 }

}

...
.withUpdate(new UpdateEntity(entity))
...



I've tested both of these solutions and they both work.

Thanks and sorry for the problem,
- Roach

On Wed, Jan 14, 2015 at 1:39 PM, Cosmin Marginean  wrote:
&gt; I’m doing a fairly “by the book” clobber update (store and fetch below work
&gt; fine) on an entity using the Java client. I’m seeing an error that happens
&gt; at type-inference time within the Riak Java client. I’m pasting below the
&gt; exact test that I’m using to generate this, as well as the stacktrace.
&gt; Please let me know if I’m missing something or if it’s a known bug.
&gt;
&gt; Thank you
&gt; Cosmin
&gt;
&gt; @Test
&gt; public void testRiakUpdate() throws Exception {
&gt; RiakNode node = new
&gt; RiakNode.Builder().withRemoteAddress("192.168.168.2").withRemotePort(8087).build();
&gt; RiakCluster cluster = new RiakCluster.Builder(node).build();
&gt; cluster.start();
&gt; RiakClient client = new RiakClient(cluster);
&gt;
&gt; SomeEntity entity = new SomeEntity();
&gt; entity.setName("John Doe");
&gt; entity.setDescription("Some Description");
&gt; Location location = new Location(new Namespace("bucket"), "entity-key");
&gt;
&gt; // Store
&gt; StoreValue storeOp = new
&gt; StoreValue.Builder(entity).withLocation(location).build();
&gt; client.execute(storeOp);
&gt;
&gt; // Fetch
&gt; FetchValue fetchOp = new FetchValue.Builder(location).build();
&gt; entity = client.execute(fetchOp).getValue(SomeEntity.class);
&gt;
&gt; // Update
&gt; entity.setName("New name");
&gt; UpdateValue updateOp = new UpdateValue.Builder(location)
&gt; .withFetchOption(FetchValue.Option.DELETED\\_VCLOCK, true)
&gt; .withUpdate(UpdateValue.Update.clobberUpdate(entity))
&gt; .build();
&gt; client.execute(updateOp).getValue(SomeEntity.class);
&gt; }
&gt;
&gt; private static class SomeEntity {
&gt; private String name;
&gt; private String description;
&gt;
&gt; public String getName() {
&gt; return name;
&gt; }
&gt;
&gt; public void setName(String name) {
&gt; this.name = name;
&gt; }
&gt;
&gt; public String getDescription() {
&gt; return description;
&gt; }
&gt;
&gt; public void setDescription(String description) {
&gt; this.description = description;
&gt; }
&gt; }
&gt;
&gt;
&gt;
&gt;
&gt; java.lang.ClassCastException:
&gt; sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to
&gt; java.lang.Class
&gt; at
&gt; com.basho.riak.client.api.commands.kv.UpdateValue$1.handle(UpdateValue.java:149)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.api.commands.ListenableFuture.notifyListeners(ListenableFuture.java:78)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.api.commands.CoreFutureAdapter.handle(CoreFutureAdapter.java:120)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.FutureOperation.fireListeners(FutureOperation.java:131)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.FutureOperation.setResponse(FutureOperation.java:170)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at com.basho.riak.client.core.RiakNode.onSuccess(RiakNode.java:823)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:58)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:155)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:108)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:785)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:116)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:494)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:461)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:378)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:101)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at java.lang.Thread.run(Thread.java:745) [na:1.8.0\\_05]
&gt; 20:34:13.390 [nioEventLoopGroup-2-1] DEBUG
&gt; c.b.riak.client.core.FutureOperation - IllegalStateException; required:
&gt; [CREATED, WRITTEN, RETRY] current: COMPLETE
&gt; 20:34:13.391 [nioEventLoopGroup-2-1] WARN
&gt; i.n.channel.DefaultChannelPipeline - An exception was thrown by a user
&gt; handler's exceptionCaught() method while handling the following exception:
&gt; java.lang.ClassCastException:
&gt; sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to
&gt; java.lang.Class
&gt; at
&gt; com.basho.riak.client.api.commands.kv.UpdateValue$1.handle(UpdateValue.java:149)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.api.commands.ListenableFuture.notifyListeners(ListenableFuture.java:78)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.api.commands.CoreFutureAdapter.handle(CoreFutureAdapter.java:120)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.FutureOperation.fireListeners(FutureOperation.java:131)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.FutureOperation.setResponse(FutureOperation.java:170)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at com.basho.riak.client.core.RiakNode.onSuccess(RiakNode.java:823)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:58)
&gt; ~[riak-client-2.0.0.jar:na]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:155)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:108)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:785)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:116)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:494)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:461)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:378)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at
&gt; io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:101)
&gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; at java.lang.Thread.run(Thread.java:745) [na:1.8.0\\_05]
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

