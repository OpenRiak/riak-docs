---
title: "Re: Ideal Backend for keys that frequently get overwritten"
description: ""
project: community
lastmod: 2011-09-14T12:23:49-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04713"
mailinglist_parent_id: "msg04712"
author_name: "Jeremy Raymond"
project_section: "mailinglistitem"
sent_date: 2011-09-14T12:23:49-07:00
---


Ahh, OK I get it now... if \\_any\\_ of these thresholds are met \\_and\\_ the files
are not active (i.e. they have grown larger than max\\_file\\_size) they'll be
merged. Thanks!

- Jeremy


On Wed, Sep 14, 2011 at 3:16 PM, Dan Reverri  wrote:

&gt; At any point in time Bitcask may have data spread across a number of data
&gt; files. Bitcask occasionally runs a merge process which reads the data from
&gt; those files and writes a merged set of data to a new file. Once completed
&gt; the old files can be removed and the new file is used for future read
&gt; operations.
&gt;
&gt; The merge process chooses which files to merge based on a number of
&gt; thresholds. The thresholds are:
&gt;
&gt; {frag\\_threshold, 40}, % &gt;= 40% fragmentation
&gt; {dead\\_bytes\\_threshold, 134217728}, % Dead bytes &gt; 128 MB
&gt; {small\\_file\\_threshold, 10485760}, % File is &lt; 10 MB
&gt;
&gt; If a data file exceeds any of the thresholds it will be included in the
&gt; merge process. The small\\_file\\_threshold means that any inactive data file
&gt; that is less than 10MB will be included in the merge process.
&gt;
&gt; Thanks,
&gt; Dan
&gt;
&gt;
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt; On Wed, Sep 14, 2011 at 9:50 AM, Jeremy Raymond wrote:
&gt;
&gt;&gt; Ok, thanks I'll give that a try.
&gt;&gt;
&gt;&gt; What does small\\_file\\_threshold do then?
&gt;&gt;
&gt;&gt; - Jeremy
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Sep 14, 2011 at 12:48 PM, Dan Reverri  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Jeremy,
&gt;&gt;&gt;
&gt;&gt;&gt; The max\\_file\\_size parameter controls when Bitcask will close the
&gt;&gt;&gt; currently active data file and start a new data file. The active data file
&gt;&gt;&gt; will not be considered when determining if a merge should occur. The default
&gt;&gt;&gt; max\\_file\\_size is 2GBs. This means that each partition in the system can grow
&gt;&gt;&gt; to 2GBs before the data files are considered for merging. This is likely
&gt;&gt;&gt; what you are seeing in your situation.
&gt;&gt;&gt;
&gt;&gt;&gt; You can lower the max\\_file\\_size in the app.config file under the bitcask
&gt;&gt;&gt; section. This parameter should be specified in bytes.
&gt;&gt;&gt;
&gt;&gt;&gt; This article is related to your issue:
&gt;&gt;&gt;
&gt;&gt;&gt; https://help.basho.com/entries/20141178-why-does-it-seem-that-bitcask-merging-is-only-triggered-when-a-riak-node-is-restarted
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Dan
&gt;&gt;&gt;
&gt;&gt;&gt; Daniel Reverri
&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; d...@basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Wed, Sep 14, 2011 at 8:49 AM, Jeremy Raymond wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; If I'm reading the docs correctly, only files smaller
&gt;&gt;&gt;&gt; than small\\_file\\_threshold will be included in a merge. So
&gt;&gt;&gt;&gt; if small\\_file\\_threshold must be bigger than max\\_file\\_size for a merge to
&gt;&gt;&gt;&gt; happen?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; - Jeremy
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Wed, Sep 14, 2011 at 10:23 AM, Jeremy Raymond 
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Maybe I just need to tweak the Bitcask parameters to merge more often?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I have approx 17000 keys which get overwritten once an hour. After each
&gt;&gt;&gt;&gt;&gt; updated the /var/lib/riak/bitcask folder grows by 20 MB (so about 1200 
&gt;&gt;&gt;&gt;&gt; bytes
&gt;&gt;&gt;&gt;&gt; per key). With the default frag\\_merge\\_trigger at 60 I should get a merge
&gt;&gt;&gt;&gt;&gt; every 3 hours as I would have &gt; 60% of the keys being dead? This would 
&gt;&gt;&gt;&gt;&gt; also
&gt;&gt;&gt;&gt;&gt; meet the default frag\\_threshold of 40 since &gt; 40% of the keys are dead? 
&gt;&gt;&gt;&gt;&gt; I'm
&gt;&gt;&gt;&gt;&gt; not seeing the merging happening.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; - Jeremy
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On Wed, Sep 14, 2011 at 9:28 AM, Jeremiah Peschka &lt;
&gt;&gt;&gt;&gt;&gt; jeremiah.pesc...@gmail.com&gt; wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; I would think that the InnoDB backend would be a better backend for
&gt;&gt;&gt;&gt;&gt;&gt; the use case you're describing.
&gt;&gt;&gt;&gt;&gt;&gt; ---
&gt;&gt;&gt;&gt;&gt;&gt; Jeremiah Peschka - Founder, Brent Ozar PLF, LLC
&gt;&gt;&gt;&gt;&gt;&gt; Microsoft SQL Server MVP
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On Sep 14, 2011, at 8:09 AM, Jeremy Raymond wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Hi,
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; I store data in Riak whose keys constantly get overwritten with new
&gt;&gt;&gt;&gt;&gt;&gt; data. I'm currently using Bitcask as the back-end and recently noticed 
&gt;&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt;&gt; Bitcask data folder grow to 24GB. After restarting the nodes, which I 
&gt;&gt;&gt;&gt;&gt;&gt; think
&gt;&gt;&gt;&gt;&gt;&gt; triggered Bitcask merge, the data went down to 96MB. Today the data dirs 
&gt;&gt;&gt;&gt;&gt;&gt; are
&gt;&gt;&gt;&gt;&gt;&gt; back up to around 500MB. Would an alternate backend better suit this 
&gt;&gt;&gt;&gt;&gt;&gt; type of
&gt;&gt;&gt;&gt;&gt;&gt; use case where keys are constantly being overwritten?
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; - Jeremy
&gt;&gt;&gt;&gt;&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

