---
title: "Re: Riak Cannot allocate bytes of memory (of type \"heap\")"
description: ""
project: community
lastmod: 2016-01-25T11:19:17-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16986"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-01-25T11:19:17-08:00
---


Hello Byron -

m3.large instances only support 7.5 GiB of RAM. You can see that Riak
crashed while attempting to allocate 2.12 GiB of RAM for leveldb.

I suggest decreasing jvm (Solr) RAM back to the 1GiB setting that
ships with Riak. You can also experiment with disabling Active
Anti-Entropy to reduce memory usage. Hopefully someone with more
experience with Riak Search (Yokozuna) interaction with Active
Anti-Entropy will chime in on this thread.

Or, increase the amount of RAM available to these VMs.

Thanks

--
Luke Bakken
Engineer
lbak...@basho.com


On Mon, Jan 25, 2016 at 10:10 AM, Sakoulas, Byron
 wrote:
&gt; We are running an 8 node cluster of riak at AWS, and our nodes are 
&gt; consistently crashing with the error - Cannot allocate x bytes of memory (of 
&gt; type "heap‚Äù).
&gt;
&gt; Here are some of the specs for our env:
&gt;
&gt; 8 nodes - running on M3 Larges
&gt; Level DB with 50% allocated
&gt; Solr with 2Gig
&gt; We use only Immutable and CRDT data
&gt; We have a Custom search schema
&gt; System config matches basho recommendations
&gt; CentOs 7
&gt; Riak 2.0.2
&gt; Riak java client 2.0.0
&gt;
&gt; Below is the console log leading up to the crash. I have also attached the 
&gt; erl\\_crash.dump file. Any help is greatly appreciated.
&gt;
&gt; 2016-01-25 16:34:16.822 [info] 
&gt; &lt;0.2681.4&gt;@riak\\_kv\\_exchange\\_fsm:key\\_exchange:263 Repaired 1 keys during 
&gt; active anti-entropy exchange of 
&gt; {707914855582156101004909840846949587645842325504,3} between 
&gt; {730750818665451459101842416358141509827966271488,'riakaws@172.16.65.8'}
&gt; and 
&gt; {753586781748746817198774991869333432010090217472,'riakaws@172.16.65.12'}
&gt; 2016-01-25 16:34:56.867 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,180682}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,22177879},{mbuf\\_size,0},{stack\\_size,26},{old\\_heap\\_size,0},{heap\\_size,8755966}]
&gt; 2016-01-25 16:35:00.231 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,203278}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,26613454},{mbuf\\_size,0},{stack\\_size,26},{old\\_heap\\_size,0},{heap\\_size,9839470}]
&gt; 2016-01-25 16:35:08.857 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,256704}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,31936144},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,12371527}]
&gt; 2016-01-25 16:35:15.731 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,299047}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,38323372},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,14501169}]
&gt; 2016-01-25 16:35:21.285 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,330848}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,45988046},{mbuf\\_size,0},{stack\\_size,26},{old\\_heap\\_size,0},{heap\\_size,16029792}]
&gt; 2016-01-25 16:35:36.034 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,382846}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,55185655},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,18521726}]
&gt; 2016-01-25 16:35:49.409 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,455689}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,66222786},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,21841438}]
&gt; 2016-01-25 16:35:59.878 [info] &lt;0.71.0&gt; alarm\\_handler: 
&gt; {set,{process\\_memory\\_high\\_watermark,&lt;0.1369.0&gt;}}
&gt; 2016-01-25 16:36:00.267 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,515497}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,79467343},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,24737674}]
&gt; 2016-01-25 16:36:08.497 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{hashtree,should\\_insert,3}},{message\\_queue\\_len,560639}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,95360811},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,26973030}]
&gt; 2016-01-25 16:36:34.806 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,691363}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,114432973},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,33336504}]
&gt; 2016-01-25 16:36:55.523 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,809402}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,137319567},{mbuf\\_size,0},{stack\\_size,26},{old\\_heap\\_size,0},{heap\\_size,38698478}]
&gt; 2016-01-25 16:37:10.427 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,897252}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,164783480},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,43053480}]
&gt; 2016-01-25 16:37:46.837 [info] 
&gt; &lt;0.10112.4&gt;@riak\\_kv\\_exchange\\_fsm:key\\_exchange:263 Repaired 1 keys during 
&gt; active anti-entropy exchange of 
&gt; {959110449498405040071168171470060731649205731328,3} between 
&gt; {959110449498405040071168171470060731649205731328,'riakaws@172.16.65.8'}
&gt; and 
&gt; {1004782375664995756265033322492444576013453623296,'riakaws@172.16.65.13'}
&gt; 2016-01-25 16:37:56.113 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{hashtree,maybe\\_flush\\_buffer,1}},{message\\_queue\\_len,1132569}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,197740176},{mbuf\\_size,0},{stack\\_size,26},{old\\_heap\\_size,0},{heap\\_size,54503137}]
&gt; 2016-01-25 16:38:29.550 [info] 
&gt; &lt;0.94.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&gt; &lt;0.1369.0&gt; 
&gt; [{initial\\_call,{yz\\_index\\_hashtree,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,1313878}]
&gt; 
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,237288211},{mbuf\\_size,0},{stack\\_size,19},{old\\_heap\\_size,0},{heap\\_size,62782512}]
&gt;
&gt;
&gt; erlang.log.1:
&gt; ===== ALIVE Mon Jan 25 16:34:01 UTC 2016
&gt;
&gt; ===== Mon Jan 25 16:39:55 UTC 2016
&gt; [os\\_mon] cpu supervisor port (cpu\\_sup): Erlang has closed
&gt; [os\\_mon] memory supervisor port (memsup): Erlang has closed
&gt;
&gt; Crash dump was written to: /var/log/riak/erl\\_crash.dump
&gt; eheap\\_alloc: Cannot allocate 2277966824 bytes of memory (of type "heap").
&gt;
&gt;
&gt;
&gt; This email and attachments contain information that may be confidential or 
&gt; privileged. If you are not the intended recipient, notify the sender at once 
&gt; and delete this message completely from your information system. Further use, 
&gt; disclosure, or copying of information contained in this email is not 
&gt; authorized, and any such action should not be construed as a waiver of 
&gt; privilege or other confidentiality protections.
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

