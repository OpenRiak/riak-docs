---
title: "erlang go boom"
description: ""
project: community
lastmod: 2013-08-05T12:52:59-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11892"
author_name: "Paul Ingalls"
project_section: "mailinglistitem"
sent_date: 2013-08-05T12:52:59-07:00
---


As promised in previous email, I hit a fairly big problem over the weekend and 
then reproduced it this morning and I was wondering if I could get some help.

Basically, I was running my code against our risk cluster and everything was 
moving along just fine. However, at some point Riak just seems to hit a wall. 
I get to a certain scale of content, about 9-10 GB per node, and about half the 
cluster gives up the ghost.

I've done this twice from scratch now, the first time I thought maybe I was 
trying to push too many transactions per second. But the second time I reduced 
the speed and changed some settings in the app.config that I thought would 
reduce memory usage. Ran it again, and 24 hrs later I still hit the wall 
(almost the same place).

So, I figure I'm still doing something wrong, I'm just not sure what. I'm 
obviously hitting some kind of heap issue, but I'm not sure what else I can do 
about it. I'm hoping there is something obvious I'm missing in my ignorance, 
cuz at the moment I'm stuck...

Some details:

7 node cluster running 1.4
each VM has 7GB RAM and 4 CPUs
the data directory is on a RAID0 with 750GB of space
128 partitions, levelDB backend
using links and secondary indexes
lots of buckets (over 10 million), a couple buckets have lots of keys (one was 
around 6.6 million keys when it crashed, the other around 3.7 million). 
Values are pretty small, almost all are just a few bytes. There is one bucket, 
the largest (6.6 million keys), with value sizes between 1-2k.

primary custom app config settings:
{kernel,
 [
 {inet\\_dist\\_listen\\_min, 6000},
 {inet\\_dist\\_listen\\_max, 7999}
 ]},

{riak\\_core, [
 {default\\_bucket\\_props, [
 {allow\\_mult, true},
 {r, 1},
 {w, 1},
 {dw, 1},
 {dw, 1}
 ]},
 {ring\\_creation\\_size, 128},
 ]},

 {riak\\_kv, [
 {storage\\_backend, riak\\_kv\\_eleveldb\\_backend},
 ]}

 {eleveldb, [
 {max\\_open\\_files, 32}
 ]},

custom vm.args settings
+A 16 
 

Here is some of the error information I am seeing when it all goes boom:

\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
\\* On one of the nodes that crashes:
\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
last lines of console.log
-------------------
2013-08-05 17:59:08.071 [info] 
&lt;0.29251.556&gt;@riak\\_kv\\_exchange\\_fsm:key\\_exchange:206 Repaired 1 keys during 
active anti-entropy exchange of 
{468137243207554840987117797979434404733540892672,3} between 
{479555224749202520035584085735030365824602865664,riak@riak001} and 
{490973206290850199084050373490626326915664838656,riak@riak002}
2013-08-05 18:01:10.234 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,47828850},{mbuf\\_size,0},{stack\\_size,10},{old\\_heap\\_size,0},{heap\\_size,40978448}]
2013-08-05 18:01:10.672 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.12133.557&gt; 
[{initial\\_call,{riak\\_api\\_pb\\_server,init,1}},{almost\\_current\\_function,{riak\\_pb\\_kv\\_codec,'-encode\\_content\\_meta/3-lc$^0/1-1-',1}},{message\\_queue\\_len,0}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,47828850},{mbuf\\_size,0},{stack\\_size,45},{old\\_heap\\_size,0},{heap\\_size,40978360}]
2013-08-05 18:01:12.993 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{dict,fold\\_bucket,3}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,59786060},{mbuf\\_size,0},{stack\\_size,50},{old\\_heap\\_size,0},{heap\\_size,40978626}]
2013-08-05 18:01:13.816 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{dict,fold\\_bucket,3}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,59786060},{mbuf\\_size,0},{stack\\_size,50},{old\\_heap\\_size,0},{heap\\_size,40978626}]
2013-08-05 18:01:13.819 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.12133.557&gt; 
[{initial\\_call,{riak\\_api\\_pb\\_server,init,1}},{almost\\_current\\_function,{riak\\_kv\\_pb,pack,5}},{message\\_queue\\_len,0}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,59786060},{mbuf\\_size,0},{stack\\_size,200971},{old\\_heap\\_size,0},{heap\\_size,47627275}]
2013-08-05 18:01:14.594 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,116769640},{mbuf\\_size,0},{stack\\_size,49},{old\\_heap\\_size,0},{heap\\_size,81956796}]
2013-08-05 18:01:15.729 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.12133.557&gt; 
[{initial\\_call,{riak\\_api\\_pb\\_server,init,1}},{almost\\_current\\_function,{riak\\_kv\\_pb,encode,2}},{message\\_queue\\_len,0}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,74732575},{mbuf\\_size,0},{stack\\_size,81},{old\\_heap\\_size,0},{heap\\_size,42778355}]
2013-08-05 18:01:15.878 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,116769640},{mbuf\\_size,0},{stack\\_size,49},{old\\_heap\\_size,0},{heap\\_size,81956794}]
2013-08-05 18:01:15.878 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,116769640},{mbuf\\_size,0},{stack\\_size,41},{old\\_heap\\_size,0},{heap\\_size,81956788}]
2013-08-05 18:01:15.878 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,116769640},{mbuf\\_size,0},{stack\\_size,52},{old\\_heap\\_size,0},{heap\\_size,81956774}]
2013-08-05 18:01:15.878 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.14832.557&gt; 
[{initial\\_call,{riak\\_kv\\_get\\_fsm,init,1}},{almost\\_current\\_function,{riak\\_object,encode\\_maybe\\_binary,1}},{message\\_queue\\_len,1}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,116769640},{mbuf\\_size,0},{stack\\_size,52},{old\\_heap\\_size,0},{heap\\_size,81956791}]
2013-08-05 18:01:15.880 [info] 
&lt;0.83.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap 
&lt;0.12133.557&gt; 
[{initial\\_call,{riak\\_api\\_pb\\_server,init,1}},{almost\\_current\\_function,{lists,reverse,1}},{message\\_queue\\_len,0}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,74732575},{mbuf\\_size,0},{stack\\_size,71},{old\\_heap\\_size,0},{heap\\_size,69315695}]


in erlang.log:
----------------------
===== ALIVE Mon Aug 5 17:56:26 UTC 2013
Erlang has closed
/home/fanzo/riak/rel/riak/bin/../lib/os\\_mon-2.2.9/priv/bin/memsup: Erlang has 
closed.

===== Mon Aug 5 18:13:22 UTC 2013
^M
Crash dump was written to: ./log/erl\\_crash.dump^M
eheap\\_alloc: Cannot allocate 934157120 bytes of memory (of type "heap").^M

with this initial crash, nothing is written to crash.log or error.log. There 
is a big honking erl\\_crash.dump file though...

\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
\\* on the next node:
\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
last lines of console.log
----------------------
2013-08-05 17:49:02.789 [info] 
&lt;0.3014.550&gt;@riak\\_kv\\_exchange\\_fsm:key\\_exchange:206 Repaired 1 keys during 
active anti-entropy exchange of 
{91343852333181432387730302044767688728495783936,3} between 
{91343852333181432387730302044767688728495783936,riak@riak002} and 
{114179815416476790484662877555959610910619729920,riak@riak004}
2013-08-05 18:00:19.830 [info] &lt;0.61.0&gt; alarm\\_handler: 
{set,{system\\_memory\\_high\\_watermark,[]}}
2013-08-05 18:00:56.272 [info] 
&lt;0.85.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap &lt;0.7460.0&gt; 
[{initial\\_call,{riak\\_core\\_vnode,init,1}},{almost\\_current\\_function,{eleveldb,get,3}},{message\\_queue\\_len,6}]
 
[{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,59786060},{mbuf\\_size,0},{stack\\_size,43},{old\\_heap\\_size,0},{heap\\_size,40978885}]

in erlang.log:
----------------------
===== ALIVE Mon Aug 5 17:56:55 UTC 2013
/home/fanzo/riak/rel/riak/bin/../lib/os\\_mon-2.2.9/priv/bin/memsup: Erlang has 
closed.Erlang has closed


===== Mon Aug 5 18:13:33 UTC 2013
^M
Crash dump was written to: ./log/erl\\_crash.dump^M
eheap\\_alloc: Cannot allocate 934157120 bytes of memory (of type "heap").^M
 
\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
\\* on the next node:
\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
console.log looks similar to the first

nothing was logged in erlang.log and there was no crash dump. Looks like the 
beam proc just crashed hard.


\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
\\* on the next node:
\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*\\*
last lines of console.log
----------------------
console.log looks similar to the first

in erlang.log:
----------------------
===== Mon Aug 5 18:01:43 UTC 2013
Erlang has closed
/home/fanzo/riak/rel/riak/bin/../lib/os\\_mon-2.2.9/priv/bin/memsup: Erlang has 
closed.
^M
Crash dump was written to: ./log/erl\\_crash.dump^M
eheap\\_alloc: Cannot allocate 2280657000 bytes of memory (of type "heap").^M


If I try to start things back up, the nodes keep periodically crashing, usually 
within a few minutes. And I can't put any more data in without it blowing up...

Any help would be appreciated.

Paul Ingalls
Founder & CEO Fanzo
p...@fanzo.me
@paulingalls
http://www.linkedin.com/in/paulingalls



\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

