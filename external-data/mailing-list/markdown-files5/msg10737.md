---
title: "Re: Map reduce weirdness on Riak 1.3"
description: ""
project: community
lastmod: 2013-04-06T23:01:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10737"
mailinglist_parent_id: "msg10734"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-04-06T23:01:01-07:00
---


Hi Kartik,

You could look at the data as part of the map phase and check if the age 
criteria is a match there instead of in a separate reduce phase. If it is a 
match, return something like '{"key":{"age\\_int":24}}' and if it does not match 
and should not go into the final results just return an empty list. If you then 
remove the reduce phase, the list of map phase outputs will be sent to the 
client, which should be similar to the output you were building in the reduce 
phase.

If you still want to use a reduce phase, here is a link that describes how it 
should to be designed [1].

Best regards,

Christian

[1] 
http://docs.basho.com/riak/latest/references/appendices/MapReduce-Implementation/#How-a-Reduce-Phase-Works-in-Riak

On 6 Apr 2013, at 21:46, "Kartik Thakore"  wrote:

&gt; How would I filter and append to rest of the reduce results?
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Sat, Apr 6, 2013 at 4:09 PM, Christian Dahlqvist  
&gt; wrote:
&gt; 
&gt; Hi Kartik,
&gt; 
&gt; The reduce phase will normally run recursively a number of times as results 
&gt; come in from map phases on different nodes [1]. This allows Riak to start 
&gt; reducing the results before all data is available and will not require all 
&gt; input data to be stored in memory on the coordinating node. The output from 
&gt; the first iteration will be passed into the following iteration together with 
&gt; the next batch of map phase results. When processing large amounts of data 
&gt; this is the most efficient way to do it, and reduce functions should be 
&gt; written in a way so that they can handle this.
&gt; 
&gt; If you know that the number of results will be manageable or the reduce phase 
&gt; requires all results to be processed at once, there is an argument called 
&gt; 'reduce\\_phase\\_only\\_1' [1] that can be specified in order to force the reduce 
&gt; phase to run only once all map phase results are available.
&gt; 
&gt; In your case you might however be able to completely eliminate the reduce 
&gt; phase if you made the map phase perform filtering and formatting. If a record 
&gt; does not match the criteria, you just return [].
&gt; 
&gt; This would give you a list of JSON documents instead of a single one, but 
&gt; would most likely be more efficient.
&gt; 
&gt; Best regards,
&gt; 
&gt; Christian
&gt; 
&gt; [1] 
&gt; http://docs.basho.com/riak/1.2.0/references/appendices/MapReduce-Implementation/
&gt; 
&gt; 
&gt; On 6 Apr 2013, at 20:22, Kartik Thakore  wrote:
&gt; 
&gt;&gt; I am not sure have you mean by re-reduce. Can you clarify what you mean? 
&gt;&gt; 
&gt;&gt; I was thinking the reduce phase happens after the whole map is done. Do I 
&gt;&gt; have to implement a count waiter for the map results in the reduce code?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Sat, Apr 6, 2013 at 3:19 PM, Christian Dahlqvist  
&gt;&gt; wrote:
&gt;&gt; Hi Kartik,
&gt;&gt; 
&gt;&gt; What you are seeing is a result of you not accounting for re-reduce in you 
&gt;&gt; reduce phase function. 
&gt;&gt; 
&gt;&gt; In Riak reduce phases generally run recursively and the input for each run 
&gt;&gt; may contain both values from preceding map phase as well as output from 
&gt;&gt; previous iterations of the reduce phase. In order for the reduce phase to 
&gt;&gt; behave correctly you will need to distinguish between the different types of 
&gt;&gt; input records in your reduce function. 
&gt;&gt; 
&gt;&gt; Best regards,
&gt;&gt; 
&gt;&gt; Christian
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 6 Apr 2013, at 19:09, Kartik Thakore  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hello,
&gt;&gt;&gt; 
&gt;&gt;&gt; I recently setup a test cluster to try to do a tech demo web application on.
&gt;&gt;&gt; 
&gt;&gt;&gt; I have been having some weirdness with the map reduce functionality.
&gt;&gt;&gt; 
&gt;&gt;&gt; My database is here:
&gt;&gt;&gt; 
&gt;&gt;&gt; http://aimed.cc:8098/riak/rekon/go#/buckets/test\\_rand\\_docs
&gt;&gt;&gt; 
&gt;&gt;&gt; The cluster has 5 nodes
&gt;&gt;&gt; ulimit 4096
&gt;&gt;&gt; 
&gt;&gt;&gt; This is Riak 1.3.0 release on Debian with 663 of free memory.
&gt;&gt;&gt; 
&gt;&gt;&gt; I am running this map reduce:
&gt;&gt;&gt; 
&gt;&gt;&gt; curl -X POST -H "content-type: application/json" \\
&gt;&gt;&gt; http://aimed.cc:8098/mapred --data @-&lt;&lt;\\EOF
&gt;&gt;&gt; {"inputs": "test\\_rand\\_docs",
&gt;&gt;&gt; "query":[{"map":{"language":"javascript","source":"
&gt;&gt;&gt; function (v) {
&gt;&gt;&gt; var r = {};
&gt;&gt;&gt; var data = JSON.parse(v.values[0].data);
&gt;&gt;&gt; r.data = data;
&gt;&gt;&gt; r.key = v.key;
&gt;&gt;&gt; return [ r ];
&gt;&gt;&gt; }
&gt;&gt;&gt; "}},{"reduce":{"language":"javascript","source":"
&gt;&gt;&gt; function (v) {
&gt;&gt;&gt; var r = {};
&gt;&gt;&gt; for( var i in v )
&gt;&gt;&gt; {
&gt;&gt;&gt; var doc = v[i];
&gt;&gt;&gt; if( doc['data'] !== undefined) {
&gt;&gt;&gt; var age = doc['data']['age\\_int'];
&gt;&gt;&gt; if ( age !== undefined && age &gt; 10 && age &lt;25 ){
&gt;&gt;&gt; r[doc['key']] = doc['data'];
&gt;&gt;&gt; }
&gt;&gt;&gt; }
&gt;&gt;&gt; }
&gt;&gt;&gt; return [ r ];
&gt;&gt;&gt; 
&gt;&gt;&gt; }
&gt;&gt;&gt; "}}]
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; my result is randomly:
&gt;&gt;&gt; 
&gt;&gt;&gt; [{"9DYMGV0B6Jdn5DivoTExiqyDYUC":{"age\\_int":24},"JQYUs2onC822EOzMaToz71j77e":{"age\\_int":18},"AcrUwotAdYaV5zitaMylnUgYsWY":{"age\\_int":24}}]
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; or
&gt;&gt;&gt; 
&gt;&gt;&gt; [{"LYJpg97ZA5qjZTTv2cfavmRgxLb":{"age\\_int":11}}]
&gt;&gt;&gt; 
&gt;&gt;&gt; but it is clear with this:
&gt;&gt;&gt; 
&gt;&gt;&gt; http://aimed.cc:8098/solr/test\\_rand\\_docs/select?q=age\\_int:[10%20TO%2025]
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; that there are 134 records ....
&gt;&gt;&gt; 
&gt;&gt;&gt; so what is going on?
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Is it low memory? Or that it is on a XEN machine (Linode)? Is there a 
&gt;&gt;&gt; scaleable memory server vendor (AWS or w/e) I should consider?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Kartik Thakore
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

