---
title: "Re: Riak-CS issues when Riak endpoint fails-over to new server"
description: ""
project: community
lastmod: 2017-01-04T02:43:51-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17828"
mailinglist_parent_id: "msg17827"
author_name: "Magnus Kessler"
project_section: "mailinglistitem"
sent_date: 2017-01-04T02:43:51-08:00
---


Hi Toby,

As far as I know Riak CS has none of the more advanced retry capabilities
that Riak KV has. However, in the design of CS there seems to be an
assumption that a CS instance will talk to a co-located KV node on the same
host. To achieve high availability, in CS deployments HAProxy is often
deployed in front of the CS nodes. Could you please let me know if this is
an option for your setup?

Kind Regards,

Magnus


On 4 January 2017 at 01:04, Toby Corkindale  wrote:

&gt; Hello all,
&gt; Now that we're all back from the end-of-year holidays, I'd like to bump
&gt; this question up.
&gt; I feel like this has been a long-standing problem with Riak CS not
&gt; handling dropped TCP connections.
&gt; Last time the cause was haproxy dropping idle TCP connections after too
&gt; long, but we solved that at the haproxy end.
&gt;
&gt; This time, it's harder -- we're failing over to a different Riak backend,
&gt; so the TCP connections between Riak CS and Riak PBC \\*have\\* to go down, but
&gt; Riak CS just doesn't handle it well at all.
&gt;
&gt; Is there a trick to configuring it better?
&gt;
&gt; Thanks
&gt; Toby
&gt;
&gt;
&gt; On Thu, 22 Dec 2016 at 16:48 Toby Corkindale  wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt; We've been seeing some issues with Riak CS for a while in a specific
&gt;&gt; situation. Maybe you can advise if we're doing something wrong?
&gt;&gt;
&gt;&gt; Our setup has redundant haproxy instances in front of a cluster of riak
&gt;&gt; nodes, for both HTTP and PBC. The haproxy instances share a floating IP
&gt;&gt; address.
&gt;&gt; Only one node holds the IP, but if it goes down, another takes it up.
&gt;&gt;
&gt;&gt; Our Riak CS nodes are configured to talk to the haproxy on that floating
&gt;&gt; IP.
&gt;&gt;
&gt;&gt; The problem occurs if the floating IP moves from one haproxy to another.
&gt;&gt;
&gt;&gt; Suddenly we see a flurry of errors in riak-cs log files.
&gt;&gt;
&gt;&gt; This is presumably because it was holding open TCP connections, and the
&gt;&gt; new haproxy instance doesn't know anything about them, so they get TCP
&gt;&gt; RESET and shutdown.
&gt;&gt;
&gt;&gt; The problem is that riak-cs doesn't try to reconnect and retry
&gt;&gt; immediately, instead it just throws a 503 error back to the client. Who
&gt;&gt; then retries, but Riak-CS has a pool of a couple of hundred connections to
&gt;&gt; cycle through, all of which throw the error!
&gt;&gt;
&gt;&gt; Does this sound like it is a likely description of the fault?
&gt;&gt; Do you have any ways to mitigate this issue in Riak CS when using TCP
&gt;&gt; load balancing above Riak PBC?
&gt;&gt;
&gt;&gt; Toby
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;


-- 
Magnus Kessler
Client Services Engineer
Basho Technologies Limited

Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

