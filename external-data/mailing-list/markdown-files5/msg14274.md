---
title: "Re: Consistent Riak (riak_ensemble) without Anti-entropy?"
description: ""
project: community
lastmod: 2014-05-28T10:40:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14274"
mailinglist_parent_id: "msg14272"
author_name: "Sargun Dhillon"
project_section: "mailinglistitem"
sent_date: 2014-05-28T10:40:04-07:00
---


I've gone ahead and opened up an issue on the riak\\_kv github project:
https://github.com/basho/riak\\_kv/issues/959 - as it appears like this
is an actual bug. My preference would be that when
riak\\_kv\\_ensemble\\_backend is booting up, it initiates manual AAE sync,
so I don't have to wait for AAE exchange to occur, as on a real
cluster, this might take a while.

On Wed, May 28, 2014 at 3:24 AM, Sargun Dhillon  wrote:
&gt; So, I noticed that if I don't have anti-entropy on, and I enable
&gt; strongly consistent Riak, it doesn't work. Specifically, what happens
&gt; is that riak\\_kv\\_ensembles sets up the ensembles, but the
&gt; riak\\_ensemble\\_peer never gets past to all\\_sync state. It appears that
&gt; this is because the riak\\_kv\\_ensemble\\_backend relies on anti-entropy to
&gt; perform an exchange before it comes up. See here, from
&gt; riak\\_kv/develop:
&gt;
&gt;
&gt; sync(Replies, State=#state{ensemble=\\_Ensemble, id=Id}) -&gt;
&gt; Peers0 = [{Idx, PeerId} || {PeerId={{kv,\\_PL,\\_N,Idx},\\_Node},\\_Reply}
&gt; &lt;- Replies],
&gt; Peers = orddict:from\\_list(Peers0),
&gt; {{kv, PL, N, Idx}, \\_} = Id,
&gt; IndexN = {PL,N},
&gt; %% Sort to remove duplicates when changing ownership / forwarded response
&gt; Siblings0 = lists:usort([I || {{{kv,\\_PL,\\_N,I},\\_Node},\\_Reply} &lt;- Replies]),
&gt; %% Just in case, remove self from list
&gt; Siblings = Siblings0 -- [Idx],
&gt;
&gt; case local\\_partition(Idx) of
&gt; true -&gt;
&gt; T0 = erlang:now(),
&gt; Pid = self(),
&gt; spawn\\_link(fun() -&gt;
&gt; wait\\_for\\_sync(Idx, IndexN, Pid, T0,
&gt; Siblings, Peers)
&gt; end),
&gt; {async, State};
&gt; false -&gt;
&gt; {ok, State}
&gt; end.
&gt;
&gt; wait\\_for\\_sync(Idx, IndexN, Pid, T0, Siblings, Peers) -&gt;
&gt; Exchanges = riak\\_kv\\_entropy\\_info:exchanges(Idx, IndexN),
&gt; Recent = [OtherIdx || {OtherIdx, T1, \\_} &lt;- Exchanges,
&gt; T1 &gt; T0],
&gt; lager:info("~p/~p: Exchanges: ~p~nT0: ~p~nRecent: ~p~nSibs: ~p",
&gt; [Idx, IndexN, Exchanges, T0, Recent, Siblings]),
&gt; Need = length(Siblings),
&gt; Finished = length(Recent),
&gt; Local = local\\_partition(Idx),
&gt; Complete = ((Siblings -- Recent) =:= []),
&gt; if not Local -&gt;
&gt; lager:info("Partition ownership changed. No need to sync."),
&gt; riak\\_ensemble\\_backend:sync\\_complete(Pid, []);
&gt; Complete -&gt;
&gt; lager:info("Complete ~b/~b :: ~p -&gt; ~p~n", [Finished,
&gt; Need, Idx, Pid]),
&gt; SyncPeers = [orddict:fetch(PeerIdx, Peers) || PeerIdx &lt;- 
&gt; Siblings],
&gt; riak\\_ensemble\\_backend:sync\\_complete(Pid, SyncPeers);
&gt; true -&gt;
&gt; lager:info("Not yet ~b/~b :: ~p", [Finished, Need, Idx]),
&gt; timer:sleep(10000),
&gt; wait\\_for\\_sync(Idx, IndexN, Pid, T0, Siblings, Peers)
&gt; end.
&gt;
&gt;
&gt; (I uncommented the debugging). If riak\\_kv\\_entropy\\_manager is not
&gt; enabled, then riak\\_kv\\_entropy\\_info:exchanges will always be empty. Can
&gt; we either (1) manually trigger AAE exchange upon noticing that strong
&gt; consistency is enabled (I imagine you can do this by setting the mode
&gt; to manual, and then queueing up the AAE jobs), (2) throw a warning to
&gt; the user saying that they should enable AAE.
&gt;
&gt; -Sargun

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

