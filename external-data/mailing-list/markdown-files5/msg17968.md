---
title: "Re: Secondary indexes or Riak search ?"
description: ""
project: community
lastmod: 2017-02-13T05:38:51-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17968"
mailinglist_parent_id: "msg17967"
author_name: "Alex Feng"
project_section: "mailinglistitem"
sent_date: 2017-02-13T05:38:51-08:00
---


Hi Russell,

We will look into the links, thank you for the great help.

Br,
Aelx

2017-02-13 20:05 GMT+08:00 Russell Brown :

&gt; Hi Alex,
&gt; A quick look at riak\\_test it seems that the `return\\_body` parameter is
&gt; generally supported for both HTTP and PB now. I wasn’t aware of that.
&gt;
&gt; This test exercises the API.
&gt;
&gt; https://github.com/basho/riak\\_test/blob/develop/tests/
&gt; verify\\_2i\\_returnbody.erl
&gt;
&gt; The `ref` returned from the link I gave you is a way to correlate messages
&gt; received with the query. If you have a look at the code in the test here
&gt;
&gt; https://github.com/basho/riak\\_test/blob/develop/tests/
&gt; secondary\\_index\\_tests.erl#L204
&gt;
&gt; You can get an idea of the general pattern. I guess line 227
&gt;
&gt; https://github.com/basho/riak\\_test/blob/develop/tests/
&gt; secondary\\_index\\_tests.erl#L227
&gt;
&gt; Is the pertinent one for you.
&gt;
&gt; Cheers
&gt;
&gt; Russell
&gt;
&gt; On 13 Feb 2017, at 11:08, Alex Feng  wrote:
&gt;
&gt; &gt; Hi Russell,
&gt; &gt;
&gt; &gt; We have tried this, but it returns a reference(some number) only. We
&gt; have googled and haven't found any clue about how to use this API.
&gt; &gt; The API user guide doesn't say much about the "reference". What is the
&gt; next step with the returned reference ?
&gt; &gt;
&gt; &gt;
&gt; &gt; cs\\_bucket\\_fold(Pid::pid(), Bucket::bucket() | bucket\\_and\\_type(),
&gt; Opts::cs\\_opts()) -&gt; {ok, reference()} | {error, term()}
&gt; &gt; secret function, do not use, or I come to your house and keeel you.
&gt; &gt;
&gt; &gt; cs\\_opt() = {timeout, timeout()} | {continuation, binary()} |
&gt; {max\\_results, non\\_neg\\_integer() | all} | {start\\_key, binary()} |
&gt; {start\\_incl, boolean()} | {end\\_key, binary()} | {end\\_incl, boolean()}
&gt; &gt;
&gt; &gt;
&gt; &gt; Br,
&gt; &gt; Alex
&gt; &gt;
&gt; &gt; 2017-02-13 16:34 GMT+08:00 Russell Brown :
&gt; &gt; If you look at the riak-erlang-client here
&gt; https://github.com/basho/riak-erlang-client/blob/develop/
&gt; src/riakc\\_pb\\_socket.erl#L1129 there is a client API call that was
&gt; implemented for CS (riak s2, or whatever it is called, the large object
&gt; store thingy that basho had) that will use the $keys index, but in the back
&gt; end calls fold\\_objects rather than fold\\_keys on eleveldb, and so returns
&gt; the whole object. NOTE: this is equivalent to r=1, you don’t get a quorum
&gt; read here, but a single vnode per-value only. I don’t know if other clients
&gt; added this API, but it would not be hard to add to any client that supports
&gt; 2i. Like I say, originally it was for riakCS, but it’s open source and part
&gt; of the release for 4 years now, so hardly a secret.
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt;
&gt; &gt; Russell
&gt; &gt;
&gt; &gt; On 13 Feb 2017, at 06:18, Alex Feng  wrote:
&gt; &gt;
&gt; &gt; &gt; Hi Russell,
&gt; &gt; &gt;
&gt; &gt; &gt; In your reply, you mentioned this,
&gt; &gt; &gt;
&gt; &gt; &gt; &gt;&gt; There is also the feature that can return the actual riak objects
&gt; for a $keys index search,
&gt; &gt; &gt; &gt;&gt;You can pack the index terms with data and return the terms in a
&gt; query so that you don’t need a further object fetch (see &gt;&gt;return\\_terms in
&gt; docs.)
&gt; &gt; &gt;
&gt; &gt; &gt; If I understood correctly, it is possible to fetch object (value) by
&gt; 2i in one time. But, we have tried using "return\\_term = true", it returns
&gt; the index with key comparing only key when not using "return\\_term=true".
&gt; It doesn't help much with extra index, what we want to achieve is to fetch
&gt; the object in one time.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Our use case, client search DB every 10 seconds by 2i, Riak will
&gt; return a list of around 5000 results(Keys), then client will query DB to
&gt; fetch value for each key, basically it is around 5000 times, client is
&gt; easy to run into some issues most of the time. Any suggestion here ?
&gt; &gt; &gt;
&gt; &gt; &gt; Many thanks in advance.
&gt; &gt; &gt;
&gt; &gt; &gt; Br,
&gt; &gt; &gt; Alex
&gt; &gt; &gt;
&gt; &gt; &gt; 2017-02-06 19:02 GMT+08:00 Alex Feng :
&gt; &gt; &gt; Hi Russell,
&gt; &gt; &gt;
&gt; &gt; &gt; It is really helpful, thank you a lot.
&gt; &gt; &gt; We are suffering from solr crash now, are considering to switch to 2i.
&gt; &gt; &gt;
&gt; &gt; &gt; Br,
&gt; &gt; &gt; Alex
&gt; &gt; &gt;
&gt; &gt; &gt; 2017-02-06 16:53 GMT+08:00 Russell Brown :
&gt; &gt; &gt; It’s worth noting that secondary indexes (2i) has some other
&gt; advantages over solr search. If you \\_can\\_ model your queries in 2i then I'd
&gt; recommend it.
&gt; &gt; &gt;
&gt; &gt; &gt; Secondary indexes have a richer API than is currently documented, if
&gt; you look at https://docs.basho.com/riak/1.4.7/dev/using/2i/ you’ll see
&gt; that documents a feature that allows the index terms to be filtered via reg
&gt; ex. There is also the feature that can return the actual riak objects for a
&gt; $keys index search,
&gt; &gt; &gt; You can pack the index terms with data and return the terms in a query
&gt; so that you don’t need a further object fetch (see return\\_terms in docs.)
&gt; &gt; &gt; Secondary indexes are written atomically with the object they index.
&gt; &gt; &gt; Operationally they don’t require you run a JVM and Solr alongside your
&gt; riak nodes.
&gt; &gt; &gt;
&gt; &gt; &gt; You have the tools with basho\\_bench to answer the question about
&gt; performance and overhead for your workload. I suspect for “overhead” 2i
&gt; wins, as there is no JVM-per-node.
&gt; &gt; &gt;
&gt; &gt; &gt; Modelling for 2i is perhaps harder, in the classical nosql way, you
&gt; have to do more work upfront when designing your querying.
&gt; &gt; &gt;
&gt; &gt; &gt; I hope that helps a little. I worked quite a lot on 2i and never
&gt; really understood why riak-search was seen as a replacment, imo they’re
&gt; complementary, and you pick the one that best fits.
&gt; &gt; &gt;
&gt; &gt; &gt; Cheers
&gt; &gt; &gt;
&gt; &gt; &gt; Russell
&gt; &gt; &gt;
&gt; &gt; &gt; On 2 Feb 2017, at 09:43, Alex Feng  wrote:
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; Hello Riak-users,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I am currently using Riak search to do some queries, since my
&gt; queries are very simple, it should be fulfilled by secondary indexes as
&gt; well.
&gt; &gt; &gt; &gt; So, my question is which one has better performance and less
&gt; overhead, let's say both can fulfill the query requirement.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Many thanks in advance.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Br,
&gt; &gt; &gt; &gt; Alex
&gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt;
&gt; &gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

