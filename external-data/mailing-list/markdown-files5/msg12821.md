---
title: "Re: bitcask issue - write_locked"
description: ""
project: community
lastmod: 2013-11-01T09:46:58-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12821"
mailinglist_parent_id: "msg12820"
author_name: "Alex Rice"
project_section: "mailinglistitem"
sent_date: 2013-11-01T09:46:58-07:00
---


Thanks for the heads-up sounds simple enough to add to the Riak
startup script in /etc/init.d

On Fri, Nov 1, 2013 at 10:30 AM, Evan Vigil-McClanahan
 wrote:
&gt; I replied to this (accidentally) off-list. For the rest of you folks,
&gt; if you want to follow the resolution you can add yourself to the
&gt; following issue:
&gt; https://github.com/basho/bitcask/issues/99
&gt;
&gt; In the mean time, a workaround is to remove all lockfiles
&gt; (bitcask.\\*.lock) from your bitcask directory before you start up. I
&gt; hope to have an actual fix in Riak 2.0.
&gt;
&gt; On Thu, Oct 31, 2013 at 7:42 AM, Konstantin Kalin
&gt;  wrote:
&gt;&gt; We use riak 1.2.1 in production. Recently we had two incidents when a Riak
&gt;&gt; node (out of 27 nodes) was in limbo state: riak-core worked fine but bitcask
&gt;&gt; backend was constantly crashing (see below). Both times it happened
&gt;&gt; immediately after Riak was restarted due to Linux reboot.
&gt;&gt;
&gt;&gt; I looked at the source code of bitcask and looks like it happens because
&gt;&gt; there was a stuck alive process that held the lock.
&gt;&gt;
&gt;&gt; Major issue that this node causes timeouts on others and as result Java
&gt;&gt; client got timeout error and bad-message code. Thus it was impossible to do
&gt;&gt; any update for data that lands to that node as a primary replica (It's my
&gt;&gt; guess). For reads there was significant delay ~60 seconds. We have W=3, R=2.
&gt;&gt;
&gt;&gt; Is it known issue ? What I can do besides of upgrading to latest version and
&gt;&gt; hoping it will solve the issue :)
&gt;&gt;
&gt;&gt; Thank you,
&gt;&gt; Konstantin.
&gt;&gt;
&gt;&gt; Bad Riak node.
&gt;&gt; ==================
&gt;&gt; 2013-10-30 21:40:27.000 [info] &lt;0.7.0&gt; Application erlydtl started on node
&gt;&gt; 'r...@dirapp81.mlp.marquee.net'
&gt;&gt; 2013-10-30 21:40:45.229 [info] &lt;0.407.0&gt;@riak\\_core:wait\\_for\\_service:439 Wait
&gt;&gt; complete for service riak\\_kv (18 seconds)
&gt;&gt; 2013-10-30 21:40:45.473 [error] &lt;0.798.0&gt; gen\\_fsm &lt;0.798.0&gt; in state active
&gt;&gt; terminated with reason: bad return value:
&gt;&gt; {error,{write\\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
&gt;&gt; 2013-10-30 21:40:45.485 [error] &lt;0.798.0&gt; CRASH REPORT Process &lt;0.798.0&gt;
&gt;&gt; with 1 neighbours exited with reason: bad return value:
&gt;&gt; {error,{write\\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
&gt;&gt; in gen\\_fsm:terminate/7 line 611
&gt;&gt; 2013-10-30 21:40:45.486 [error] &lt;0.140.0&gt; Supervisor riak\\_core\\_vnode\\_sup had
&gt;&gt; child undefined started with {riak\\_core\\_vnode,start\\_link,undefined} at
&gt;&gt; &lt;0.798.0&gt; exit with reason bad return value:
&gt;&gt; {error,{write\\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
&gt;&gt; in context child\\_terminated
&gt;&gt; 2013-10-30 21:40:45.487 [error] &lt;0.845.0&gt; gen\\_fsm &lt;0.845.0&gt; in state ready
&gt;&gt; terminated with reason: bad return value:
&gt;&gt; {error,{write\\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
&gt;&gt; ==================
&gt;&gt;
&gt;&gt;
&gt;&gt; Another good Riak node:
&gt;&gt; ==================
&gt;&gt; 2013-10-30 21:37:36.348 [error] &lt;0.15018.5661&gt;@riak\\_kv\\_put\\_fsm:prepare:220
&gt;&gt; Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"123"&gt;&gt;} to
&gt;&gt; 'r...@dirapp81.mlp.marquee.net' - nodedown
&gt;&gt; 2013-10-30 21:37:36.348 [error] &lt;0.14950.5661&gt;@riak\\_kv\\_put\\_fsm:prepare:220
&gt;&gt; Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"123"&gt;&gt;} to
&gt;&gt; 'r...@dirapp81.mlp.marquee.net' - nodedown
&gt;&gt; 2013-10-30 21:41:52.313 [error]
&gt;&gt; &lt;0.16728.5661&gt;@riak\\_api\\_pb\\_server:handle\\_info:170 Unrecognized message
&gt;&gt; {11673037,{error,timeout}}
&gt;&gt; 2013-10-30 21:41:52.313 [error]
&gt;&gt; &lt;0.16733.5661&gt;@riak\\_api\\_pb\\_server:handle\\_info:170 Unrecognized message
&gt;&gt; {105876903,{error,timeout}}
&gt;&gt; ==================
&gt;&gt;
&gt;&gt;
&gt;&gt; One more good Riak node (that temporary held vnode of bad Riak node during
&gt;&gt; it's down):
&gt;&gt; ==================
&gt;&gt; 2013-10-30 21:37:37.345 [error] &lt;0.3663.0&gt; \\*\\* Node
&gt;&gt; 'r...@dirapp81.mlp.marquee.net' not responding \\*\\*
&gt;&gt; \\*\\* Removing (timedout) connection \\*\\*
&gt;&gt;
&gt;&gt; 2013-10-30 21:37:37.345 [error] &lt;0.30864.17&gt;@riak\\_kv\\_put\\_fsm:prepare:220
&gt;&gt; Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"5457016"&gt;&gt;} to
&gt;&gt; 'r...@dirapp81.mlp.marquee.net' - nodedown
&gt;&gt; 2013-10-30 21:41:44.358 [info]
&gt;&gt; &lt;0.151.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:271 An outbound handoff of
&gt;&gt; partition riak\\_kv\\_vnode 1438665674247607560106752257205091097473808596992
&gt;&gt; was terminated for reason: {shutdown,max\\_concurrency}
&gt;&gt; 2013-10-30 21:42:44.361 [info]
&gt;&gt; &lt;0.151.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:271 An outbound handoff of
&gt;&gt; partition riak\\_kv\\_vnode 1438665674247607560106752257205091097473808596992
&gt;&gt; was terminated for reason: {shutdown,max\\_concurrency}
&gt;&gt; 2013-10-30 21:44:30.164 [info]
&gt;&gt; &lt;0.151.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:271 An outbound handoff of
&gt;&gt; partition riak\\_kv\\_vnode 1438665674247607560106752257205091097473808596992
&gt;&gt; was terminated for reason: {shutdown,max\\_concurrency}
&gt;&gt; 2013-10-30 21:45:30.384 [info]
&gt;&gt; &lt;0.2262.18&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:126 Starting hinted\\_handoff
&gt;&gt; transfer of riak\\_kv\\_vnode from 'r...@dirapp41.mlp.marquee.net'
&gt;&gt; 1438665674247607560106752257205091097473808596992 to
&gt;&gt; 'r...@dirapp81.mlp.marquee.net'
&gt;&gt; 1438665674247607560106752257205091097473808596992
&gt;&gt; 2013-10-30 21:45:43.917 [error]
&gt;&gt; &lt;0.2262.18&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:215 hinted\\_handoff transfer
&gt;&gt; of riak\\_kv\\_vnode from 'r...@dirapp41.mlp.marquee.net'
&gt;&gt; 1438665674247607560106752257205091097473808596992 to
&gt;&gt; 'r...@dirapp81.mlp.marquee.net'
&gt;&gt; 1438665674247607560106752257205091097473808596992 failed because of
&gt;&gt; error:{case\\_clause,{error,closed}}
&gt;&gt; [{riak\\_core\\_handoff\\_sender,start\\_fold,5,[{file,"src/riak\\_core\\_handoff\\_sender.erl"},{line,174}]}]
&gt;&gt; 2013-10-30 21:46:30.382 [error]
&gt;&gt; &lt;0.969.18&gt;@riak\\_api\\_pb\\_server:handle\\_info:170 Unrecognized message
&gt;&gt; {67827933,{error,timeout}}
&gt;&gt; 2013-10-30 21:47:30.167 [info]
&gt;&gt; &lt;0.151.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:271 An outbound handoff of
&gt;&gt; partition riak\\_kv\\_vnode 1438665674247607560106752257205091097473808596992
&gt;&gt; was terminated for reason: {shutdown,max\\_concurrency}
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

