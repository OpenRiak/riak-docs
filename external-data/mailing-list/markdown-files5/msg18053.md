---
title: "Re: [CRDT_OP-in-CommitHook]"
description: ""
project: community
lastmod: 2017-03-02T01:51:03-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18053"
mailinglist_parent_id: "msg18052"
author_name: "李明"
project_section: "mailinglistitem"
sent_date: 2017-03-02T01:51:03-08:00
---


Thanks Russell,
 Yes, it was a big trouble using the internal api, especially with very
few knowledge about erlang.
Have read the riak\\_kv\\_pb\\_crdt, but it confused me a lot. How to
define a serial
actor and is there a simple example creating an `riak\\_client:put` option
object?

The reason why i need to use the internal API is i believed it will bring
less performance loss than trying to create a new client which may be
more convenient,
we are running a very heavy riak cluster and i want to keep the hook
working lightly.




2017-03-02 16:32 GMT+08:00 Russell Brown :

&gt; Hi,
&gt;
&gt; You’re using internal details of the CRDT implementation, I’m not sure
&gt; that is such a great idea. You always have your `Context` set to
&gt; `undefined` but if your ops are all adds that shouldn’t matter in this case.
&gt;
&gt; The issue is that you’re calling `riak\\_kv\\_crdt:update` that needs to be
&gt; called from within the vnode. The `ThisNode` value is not a serial actor,
&gt; so you may have many concurrent updates with the actor `ThisNode`, and
&gt; that’s not how to do it. It is crucial that the actor updating the CRDT
&gt; acts in serial issuing an increasing count of events. Thats why we put the
&gt; CRDT code inside Riak, inside the vnode.
&gt;
&gt; You’re doing neither one thing nor the other, in that your using a
&gt; datatype bucket but not the datatype API (it sends Ops from the client,
&gt; you’re doing read/modify/write.)
&gt;
&gt; I can see the issue here is that the API is external only, if you \\_must\\_
&gt; use the internal API have a look at https://github.com/basho/riak\\_
&gt; kv/blob/develop/src/riak\\_kv\\_pb\\_crdt.erl and you see that the CRDT\\_OP is
&gt; all that is sent by the client.
&gt;
&gt; https://github.com/basho/riak\\_kv/blob/develop/src/riak\\_kv\\_pb\\_crdt.erl#L162
&gt;
&gt; Those put options matter too, especially for counters, less so for sets.
&gt;
&gt; I guess it would be great if riak\\_client had some internal API functions
&gt; that made this easier to do from a hook. If you open an issue on
&gt; github.com/basho/riak\\_kv I can look into that and make a PR.
&gt;
&gt; Hope that helps
&gt;
&gt; Russell
&gt;
&gt; On 1 Mar 2017, at 09:30, 李明  wrote:
&gt;
&gt; &gt; Hi
&gt; &gt; I am new to erlang and riak. I started to use riak as a kv store
&gt; couple of months ago. Now i want to implement a commit hook to riak so that
&gt; riak could help me to make some statistics.
&gt; &gt; i read some docs and write a pre-hook scripts, which will fetch the
&gt; object key and store it into a set.
&gt; &gt; This hook works fine if there is only one client write to riak, but
&gt; if i increase the connection to riak writing, i found it lost some elements
&gt; in the set. Looks like the crdt\\_op did not do the merge operation.And there
&gt; is no obvious error in the log files.
&gt; &gt;
&gt; &gt; Could someone help me to finger out what happened or what i has
&gt; missed.
&gt; &gt;
&gt; &gt; i am using the riak 2.1.3
&gt; &gt;
&gt; &gt; Thanks all!
&gt; &gt;
&gt; &gt;
&gt; &gt; Here is the hook scripts:
&gt; &gt;
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt; -module(myhook).
&gt; &gt; -export([pretest/1]).
&gt; &gt;
&gt; &gt; now\\_to\\_local\\_string({MegaSecs, Secs, MicroSecs}) -&gt;
&gt; &gt; LocalTime = calendar:now\\_to\\_local\\_time({MegaSecs, Secs, MicroSecs}),
&gt; &gt; {{Year, Month, Day}, {Hour, Minute, \\_}} = LocalTime,
&gt; &gt; TimeStr = lists:flatten(io\\_lib:format("~
&gt; 4..0w~2..0w~2..0w~2..0w~2..0w",
&gt; &gt; [Year, Month, Day, Hour, Minute])),
&gt; &gt; TimeStr.
&gt; &gt;
&gt; &gt; is\\_deleted(Object)-&gt;
&gt; &gt; case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riak\\_object:get\\_metadata(Object))
&gt; of
&gt; &gt; {ok,\\_} -&gt;
&gt; &gt; true;
&gt; &gt; \\_ -&gt;
&gt; &gt; false
&gt; &gt; end.
&gt; &gt;
&gt; &gt; pretest(Object) -&gt;
&gt; &gt; % timer:sleep(10000),
&gt; &gt; try
&gt; &gt; ObjBucket = riak\\_object:bucket(Object),
&gt; &gt; % riak\\_object:bucket(Obj).
&gt; &gt; % {&lt;&lt;"cn-archive"&gt;&gt;,&lt;&lt;"local-test"&gt;&gt;}
&gt; &gt;
&gt; &gt; Bucket = element(2, ObjBucket),
&gt; &gt; BucketType = element(1, ObjBucket),
&gt; &gt;
&gt; &gt; ObjKey = riak\\_object:key(Object),
&gt; &gt; % Key = binary\\_to\\_list(ObjKey),
&gt; &gt; % ObjData = riak\\_object:get\\_value(Object),
&gt; &gt; % Msg = binary\\_to\\_list(ObjData),
&gt; &gt; CommitItem = iolist\\_to\\_binary(mochijson2:encode({struct, [{b,
&gt; Bucket}, {k, ObjKey}, {t, BucketType}]})),
&gt; &gt;
&gt; &gt; case is\\_deleted(Object) of
&gt; &gt; true -&gt;
&gt; &gt; KeyPrefix = "delete";
&gt; &gt; \\_ -&gt;
&gt; &gt; KeyPrefix = "update"
&gt; &gt; end,
&gt; &gt;
&gt; &gt; CurMin = now\\_to\\_local\\_string(os:timestamp()),
&gt; &gt; IndexKey = binary:list\\_to\\_bin(io\\_lib:format("~s-~s", [CurMin,
&gt; KeyPrefix])),
&gt; &gt;
&gt; &gt; %% Get a riak client
&gt; &gt; {ok, C} = riak:local\\_client(),
&gt; &gt; % get node obj
&gt; &gt; ThisNode = atom\\_to\\_binary(node(), latin1),
&gt; &gt;
&gt; &gt; % get index obj and set context
&gt; &gt; BType = &lt;&lt;"archive"&gt;&gt;,
&gt; &gt; B = &lt;&lt;"local-test"&gt;&gt;,
&gt; &gt;
&gt; &gt; {SetObj, Context} = case C:get({BType, B}, IndexKey) of
&gt; &gt; {error, notfound} -&gt;
&gt; &gt; ThisSetObj = riak\\_kv\\_crdt:new({BType, B},
&gt; IndexKey, riak\\_dt\\_orswot),
&gt; &gt; {ThisSetObj, undefined};
&gt; &gt; {ok, ThisSetObj} -&gt;
&gt; &gt; % The datatype update requires the context if the
&gt; value exists
&gt; &gt; {{Ctx, \\_}, \\_} = riak\\_kv\\_crdt:value(ThisSetObj,
&gt; riak\\_dt\\_orswot),
&gt; &gt; {ThisSetObj, Ctx}
&gt; &gt; end,
&gt; &gt;
&gt; &gt; UpdateIndex = [{add, CommitItem}],
&gt; &gt; % UpdateOp = {crdt\\_op, riak\\_dt\\_orswot, {update,
&gt; UpdateIndex}, Context},
&gt; &gt; UpdateOp = {crdt\\_op, riak\\_dt\\_orswot, {update,
&gt; UpdateIndex}, undefined},
&gt; &gt; NewObj = riak\\_kv\\_crdt:update(SetObj, ThisNode, UpdateOp),
&gt; &gt;
&gt; &gt; error\\_logger:info\\_msg("Updating index for ~s,to set
&gt; ~s~n", [binary:bin\\_to\\_list(CommitItem), IndexKey]),
&gt; &gt;
&gt; &gt; C:put(NewObj),
&gt; &gt; Object
&gt; &gt; catch
&gt; &gt; error:Error -&gt;
&gt; &gt; {fail, lists:flatten(io\\_lib:format("[
&gt; PREHOOKEXCEPTION]~p",[Error]))}
&gt; &gt; end.
&gt; &gt;
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt;
&gt; &gt; This is the set bucket props
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt; active: true
&gt; &gt; allow\\_mult: true
&gt; &gt; basic\\_quorum: false
&gt; &gt; big\\_vclock: 50
&gt; &gt; chash\\_keyfun: {riak\\_core\\_util,chash\\_std\\_keyfun}
&gt; &gt; claimant: 'riak@192.168.100.2'
&gt; &gt; datatype: set
&gt; &gt; dvv\\_enabled: true
&gt; &gt; dw: quorum
&gt; &gt; last\\_write\\_wins: false
&gt; &gt; linkfun: {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}
&gt; &gt; n\\_val: 3
&gt; &gt; notfound\\_ok: true
&gt; &gt; old\\_vclock: 86400
&gt; &gt; postcommit: []
&gt; &gt; pr: 0
&gt; &gt; precommit: []
&gt; &gt; pw: 0
&gt; &gt; r: quorum
&gt; &gt; rw: quorum
&gt; &gt; small\\_vclock: 50
&gt; &gt; w: quorum
&gt; &gt; young\\_vclock: 20
&gt; &gt;
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

