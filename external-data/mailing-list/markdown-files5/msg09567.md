---
title: "Re: Cluster setup"
description: ""
project: community
lastmod: 2012-12-12T15:09:05-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09567"
author_name: "Jared Morrow"
project_section: "mailinglistitem"
sent_date: 2012-12-12T15:09:05-08:00
---


Kevin,

First off I want to make sure when you say "public" you don't actually mean
"public to the internet"? If so, we suggest keeping Riak behind a firewall
or VPN and have your application(s) talk to it through those access points.
 Also, many people use a proxy like [HAProxy](http://haproxy.1wt.eu/) to
load balance requests to all nodes of the cluster. This will share the
load and also prevent the single point of failure of filtering all your
requests to one node. Admittedly, you now just moved your SPoF to HAProxy,
but that's outside of the scope of this reply at least! Right now it might
be more than you need and will add initial complexity and setup. You can
write and read happily to one node or pick a node at random, Riak nodes
will pass along requests if they don't own the keys you are trying to
access.

I'm glad to hear you got your three node cluster up, and thank the
community for helping you get there. I know you have looked at the Azure
docs and some of the Fast Track documents, but I highly recommend the
[Concepts Section](
http://docs.basho.com/riak/latest/references/appendices/concepts/) as it
gives a nice high-level overview on how Riak works. Knowing those will go
a long way towards getting your head around not only how Riak works, but
also some of the terms that get thrown around on the mailing-list.

-Jared


On Wed, Dec 12, 2012 at 10:04 AM, Kevin Burton wrote:

&gt; Looking at
&gt;
&gt; http://docs.basho.com/riak/latest/tutorials/installation/Installing-on-Windo
&gt; ws-Azure/ It looks like the setup is more of the later (one public IP, two
&gt; public ports) Although the documentation doesn't create a public port for
&gt; pb. So given this setup I am assuming that we only have this one public IP
&gt; address so all queries to this address are shared amount the nodes in the
&gt; cluster. Right? I will try this.
&gt;
&gt; -----Original Message-----
&gt; From: Antonio Rohman Fernandez [mailto:roh...@mahalostudio.com]
&gt; Sent: Wednesday, December 12, 2012 10:55 AM
&gt; To: Kevin Burton
&gt; Cc: Shane McEwan; 
&gt; Subject: Re: Cluster setup
&gt;
&gt; Well, I don't work with VMs, for me 1 node = 1 full server
&gt;
&gt; Sent from my iPhone
&gt;
&gt; On 12/12/2012, at 17:43, "Kevin Burton"  wrote:
&gt;
&gt; &gt; But when setting up a cluster on VM's there is only one public
&gt; &gt; address. So in your scenario there is only IP not IP1, IP2, IP3. So
&gt; &gt; they are all equal including the IP address which addresses the
&gt; &gt; cluster. The public ports direct traffic to individual machines. At
&gt; &gt; least that is the way I understand it and the way I have been
&gt; &gt; connecting with SSH. I haven't tried it but I suppose you could keep
&gt; &gt; all of the ports private and the same and only expose one port. But I
&gt; &gt; don't know how to do that so the public port is handled equally as the IP
&gt; address.
&gt; &gt;
&gt; &gt; -----Original Message-----
&gt; &gt; From: Antonio Rohman Fernandez [mailto:roh...@mahalostudio.com]
&gt; &gt; Sent: Wednesday, December 12, 2012 10:37 AM
&gt; &gt; To: Kevin Burton
&gt; &gt; Cc: Shane McEwan; riak-users@lists.basho.com
&gt; &gt; Subject: Re: Cluster setup
&gt; &gt;
&gt; &gt; You have to understand that there is no master node in Riak, all nodes
&gt; &gt; are equal, so you have as many entrypoint IPs as servers:
&gt; &gt;
&gt; &gt; http://IP1:8089/riak
&gt; &gt; http://IP2:8089/riak
&gt; &gt; http://IP3:8089/riak
&gt; &gt; Etc...
&gt; &gt;
&gt; &gt; You can query data, put data, delete data, etc... In any node at any
&gt; &gt; time
&gt; &gt;
&gt; &gt; Rohman
&gt; &gt;
&gt; &gt; Sent from my iPhone
&gt; &gt;
&gt; &gt; On 12/12/2012, at 17:18, "Kevin Burton" 
&gt; wrote:
&gt; &gt;
&gt; &gt;&gt; On last question. Since this is a cluster there is only one public IP
&gt; &gt;&gt; address. Doesn't that necessitate the ports being different values
&gt; &gt;&gt; (ie
&gt; &gt;&gt; 8088
&gt; &gt;&gt; -&gt; node1, 8089 -&gt; node2, 8090 -&gt; node3 or something like that)?
&gt; &gt;&gt;
&gt; &gt;&gt; -----Original Message-----
&gt; &gt;&gt; From: Shane McEwan [mailto:sh...@mcewan.id.au]
&gt; &gt;&gt; Sent: Wednesday, December 12, 2012 10:12 AM
&gt; &gt;&gt; To: Kevin Burton
&gt; &gt;&gt; Cc: riak-users@lists.basho.com
&gt; &gt;&gt; Subject: Re: Cluster setup
&gt; &gt;&gt;
&gt; &gt;&gt; Looks good to me!
&gt; &gt;&gt;
&gt; &gt;&gt; On 12/12/12 16:10, Kevin Burton wrote:
&gt; &gt;&gt;&gt; So now I have
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; [azureuser@bsicentos3 ~]$ sudo riak-admin member-status Attempting
&gt; &gt;&gt;&gt; to restart script through sudo -H -u riak
&gt; &gt;&gt;&gt; ================================= Membership
&gt; &gt;&gt;&gt; ==================================
&gt; &gt;&gt;&gt; Status Ring Pending Node
&gt; &gt;&gt;&gt; --------------------------------------------------------------------
&gt; &gt;&gt;&gt; -
&gt; &gt;&gt;&gt; -
&gt; &gt;&gt;&gt; ------
&gt; &gt;&gt;&gt; ---
&gt; &gt;&gt;&gt; valid 32.8% -- 'riak@10.79.108.25'
&gt; &gt;&gt;&gt; valid 34.4% -- 'riak@10.79.110.52'
&gt; &gt;&gt;&gt; valid 32.8% -- 'riak@10.79.90.11'
&gt; &gt;&gt;&gt; --------------------------------------------------------------------
&gt; &gt;&gt;&gt; -
&gt; &gt;&gt;&gt; -
&gt; &gt;&gt;&gt; ------
&gt; &gt;&gt;&gt; ---
&gt; &gt;&gt;&gt; Valid:3 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Does this look right?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; -----Original Message-----
&gt; &gt;&gt;&gt; From: Shane McEwan [mailto:sh...@mcewan.id.au]
&gt; &gt;&gt;&gt; Sent: Wednesday, December 12, 2012 9:58 AM
&gt; &gt;&gt;&gt; To: Kevin Burton
&gt; &gt;&gt;&gt; Cc: riak-users@lists.basho.com
&gt; &gt;&gt;&gt; Subject: Re: Cluster setup
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Run the join commands on the OTHER machines . . . NOT the master.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Use the master's IP address in the join commands but the actual
&gt; &gt;&gt;&gt; command must be run on the non-master machines. You're telling the
&gt; &gt; "slave"
&gt; &gt;&gt;&gt; machines to join the cluster by telling them which machine they need
&gt; &gt;&gt;&gt; to talk to to get the cluster information.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; On 12/12/12 15:51, Kevin Burton wrote:
&gt; &gt;&gt;&gt;&gt; \\*So again from the master I do 'sudo riak-admin cluster join
&gt; &gt;&gt;&gt;&gt; riak@10.79.90.11 ' but I get:\\*
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; [sudo] password for azureuser:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Attempting to restart script through sudo -H -u riak
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Failed: This node is already a member of a cluster
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; \\*Looking at the plan:\\*
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; [azureuser@bsicentos1 ~]$ sudo riak-admin cluster plan
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Attempting to restart script through sudo -H -u riak
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; =============================== Staged Changes
&gt; &gt;&gt;&gt;&gt; ================================
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Action Nodes(s)
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; -------------------------------------------------------------------
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; ---------
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; join 'riak@10.79.108.25'
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; -------------------------------------------------------------------
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; ---------
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; NOTE: Applying these changes will result in 1 cluster transition
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; ###################################################################
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #########
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; After cluster transition 1/1
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; ###################################################################
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #
&gt; &gt;&gt;&gt;&gt; #########
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; ================================= Membership
&gt; &gt;&gt;&gt;&gt; ==================================
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Status Ring Pending Node
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; -------------------------------------------------------------------
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; ---------
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; valid 0.0% 50.0% 'riak@10.79.108.25'
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; valid 100.0% 50.0% 'riak@10.79.110.52'
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; -------------------------------------------------------------------
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; -
&gt; &gt;&gt;&gt;&gt; ---------
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Valid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; WARNING: Not all replicas will be on distinct nodes
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Transfers resulting from cluster changes: 32
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; 32 transfers from 'riak@10.79.110.52' to 'riak@10.79.108.25'
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; \\*I don't see riak@10.79.90.11  in the
&gt; &gt;&gt;&gt;&gt; cluster.\\*
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; -----Original Message-----
&gt; &gt;&gt;&gt;&gt; From: Shane McEwan [mailto:sh...@mcewan.id.au]
&gt; &gt;&gt;&gt;&gt; Sent: Wednesday, December 12, 2012 9:43 AM
&gt; &gt;&gt;&gt;&gt; To: Kevin Burton
&gt; &gt;&gt;&gt;&gt; Cc: riak-users@lists.basho.com
&gt; &gt;&gt;&gt;&gt; Subject: Re: Cluster setup
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; There's no need to join the "master" to itself. Just join the other
&gt; &gt;&gt;&gt;&gt; nodes to the master.
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

