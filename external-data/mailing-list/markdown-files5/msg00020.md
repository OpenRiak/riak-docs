---
title: "Re: Question about the source code: riak_get_fsm"
description: ""
project: community
lastmod: 2010-04-13T06:30:50-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00020"
mailinglist_parent_id: "msg00019"
author_name: "Justin Sheehy"
project_section: "mailinglistitem"
sent_date: 2010-04-13T06:30:50-07:00
---


Hi, Marc.

I understand your confusion as that code is a bit subtle.

The reason this isn't a bug is that upon receiving the very first
notfound in your situation, the "FailThreshold" case in the clause
for notfound messages would return true -- since it would already know
that it could never get 3 ok responses after that. The FSM would
immediately send a notfound to the client and would not wait for the
subsequent vnode responses.

I hope that this explanation was helpful.

Best,

-Justin



On Tue, Apr 13, 2010 at 9:00 AM, Marc Worrell  wrote:
&gt; Hi,
&gt;
&gt; I was reading the source code of riak\\_get\\_fsm to see how failure is handled.
&gt; I stumbled on a construction that I don't understand.
&gt;
&gt; In waiting\\_vnode\\_r/2 I see that:
&gt; 1. on receiving an ok: there is a check if there are R ok replies
&gt; 2. on receiving notfound: there is a check of there are R (ok + notfound) 
&gt; replies
&gt;
&gt; Now suppose I have R = N = 3.
&gt; And I get back from the nodes the sequence: [notfound, ok, ok]
&gt; Then #state.replied\\_r = 2, and #state.replied\\_notfound = 1.
&gt; This will let "waiting\\_vnode\\_r({r, {ok, RObj}, ...)" stay in the state 
&gt; "waiting\\_vnode\\_r".
&gt; Though we know we got an answer from all R (N) nodes, only a timeout will 
&gt; move the fsm further.
&gt;
&gt; Could this be handled differently or am I missing something?
&gt;
&gt; - Marc
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

