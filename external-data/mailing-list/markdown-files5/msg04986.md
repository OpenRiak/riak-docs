---
title: "Delete takes 5 seconds in riak 1.0 ???"
description: ""
project: community
lastmod: 2011-10-03T05:49:50-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04986"
mailinglist_parent_id: "msg04843"
author_name: "Roland Karlsson"
project_section: "mailinglistitem"
sent_date: 2011-10-03T05:49:50-07:00
---


Hi Basho,

I had written some simple tests using riakc client library.

The tests are attached to this mail.

In particular I made this call in the tests at the start of
of each test in order to get a clean DB.

 riakc\\_pb\\_socket:delete(Pid, Bucket, Key),

In 0.14 that worked just fine. But ... in 1.0 it did not work.
The tests failed and complained about siblings.

But ... after some time of experimenting I found that if I
added a sleep of 5 seconds after the delete ... then the tests
were OK again.

Is this correct? Does delete take 5 seconds?

NOTE that the attached file assumes inits is started.

/Roland
%%%-------------------------------------------------------------------
%%% @author 
%%% @doc
%%% @end
%%%-------------------------------------------------------------------
-module(node).

-export([test\\_nvc/0,
 test\\_vc/0,
 test\\_vc\\_siblings/0,
 connect/0,
 create\\_bucket\\_nvc/0,
 create\\_bucket\\_vc/0,
 set\\_bucket\\_nvc/0,
 set\\_bucket\\_vc/0,
 write\\_first/0,
 write\\_second\\_nvc/0,
 write\\_second\\_vc/0,
 delete/0,
 read/0,
 buckets/0,
 keys/0,
 bucket\\_props/0]).

test\\_nvc() -&gt;
 create\\_bucket\\_nvc(),
 write\\_first(),
 write\\_second\\_nvc(),
 read().

test\\_vc() -&gt;
 create\\_bucket\\_vc(),
 write\\_first(),
 write\\_second\\_vc(),
 read().

test\\_vc\\_siblings() -&gt;
 create\\_bucket\\_vc(),
 write\\_first(),
 write\\_vc\\_siblings(),
 read().

connect() -&gt;
 {ok, Pid} = riakc\\_pb\\_socket:start\\_link("localhost", 8087),
 Pid.

create\\_bucket\\_nvc() -&gt;
 delete(),
 set\\_bucket\\_nvc().

set\\_bucket\\_nvc() -&gt;
 %% riakc\\_pb\\_socket:set\\_bucket/3 cannot be used. It only supports
 %% two settings: n\\_val and allow\\_mult.
 httpc:request(put,
 {"http://localhost:8098/riak/persons",
 [],
 "application/json",
 "{\\"props\\":{\\"last\\_write\\_wins\\":true,\\"allow\\_mult\\":false}}"},
 [],
 []).

create\\_bucket\\_vc() -&gt;
 delete(),
 set\\_bucket\\_vc().

set\\_bucket\\_vc() -&gt;
 %% riakc\\_pb\\_socket:set\\_bucket/3 cannot be used. It only supports
 %% two settings: n\\_val and allow\\_mult.
 httpc:request(put,
 {"http://localhost:8098/riak/persons",
 [],
 "application/json",
 "{\\"props\\":{\\"last\\_write\\_wins\\":false,\\"allow\\_mult\\":true}}"},
 [],
 []).

write\\_first() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 Obj = riakc\\_obj:new(Bucket, Key, &lt;&lt;"1953"&gt;&gt;),
 ok = riakc\\_pb\\_socket:put(Pid, Obj),
 riakc\\_pb\\_socket:stop(Pid).

delete() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 riakc\\_pb\\_socket:delete(Pid, Bucket, Key),
 %% In riak 1.0 you have to do some seconds sleep after a
 %% delete. Is this meant to be so?
 timer:sleep(5000),
 riakc\\_pb\\_socket:stop(Pid).

read() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 {ok, Obj} = riakc\\_pb\\_socket:get(Pid, Bucket, Key),
 riakc\\_pb\\_socket:stop(Pid),
 Obj.

write\\_second\\_nvc() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 Obj = riakc\\_obj:new(Bucket, Key, &lt;&lt;"1954"&gt;&gt;),
 ok = riakc\\_pb\\_socket:put(Pid, Obj),
 riakc\\_pb\\_socket:stop(Pid).

write\\_second\\_vc() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 {ok, Obj1} = riakc\\_pb\\_socket:get(Pid, Bucket, Key),
 Obj2 = riakc\\_obj:update\\_value(Obj1, &lt;&lt;"1954"&gt;&gt;),
 ok = riakc\\_pb\\_socket:put(Pid, Obj2),
 riakc\\_pb\\_socket:stop(Pid).

write\\_vc\\_siblings() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 Key = &lt;&lt;"roland"&gt;&gt;,
 {ok, Obj1} = riakc\\_pb\\_socket:get(Pid, Bucket, Key),
 Obj2 = riakc\\_obj:update\\_value(Obj1, &lt;&lt;"1954"&gt;&gt;),
 ok = riakc\\_pb\\_socket:put(Pid, Obj2),
 Obj3 = riakc\\_obj:update\\_value(Obj1, &lt;&lt;"1955"&gt;&gt;),
 ok = riakc\\_pb\\_socket:put(Pid, Obj3),
 riakc\\_pb\\_socket:stop(Pid).

buckets() -&gt;
 Pid = connect(),
 {ok, Buckets} = riakc\\_pb\\_socket:list\\_buckets(Pid),
 riakc\\_pb\\_socket:stop(Pid),
 Buckets.

keys() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 {ok, Keys} = riakc\\_pb\\_socket:list\\_keys(Pid, Bucket),
 riakc\\_pb\\_socket:stop(Pid),
 Keys.

bucket\\_props() -&gt;
 Pid = connect(),
 Bucket = &lt;&lt;"persons"&gt;&gt;,
 %% NOTE: only returns allow\\_mult and n\\_val.
 {ok, Props} = riakc\\_pb\\_socket:get\\_bucket(Pid, Bucket),
 riakc\\_pb\\_socket:stop(Pid),
 Props.
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

