---
title: "Re: Is it inefficient to map over a small bucket when you have 	millions of other buckets?"
description: ""
project: community
lastmod: 2010-07-13T03:02:25-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00719"
mailinglist_parent_id: "msg00714"
author_name: "Nicolas Fouché"
project_section: "mailinglistitem"
sent_date: 2010-07-13T03:02:25-07:00
---


Giving just a bucket WILL traverse the entire keyspace.
Here is a conversation I had on IRC yesterday (GMT+1).

[4:18pm] danoyoung: this may be obvious, but I just want to confirm,
on the QA session from the last webinar, it was stated that listing
keys for a given bucket requires examining keys that don't belong to
the requested bucket.....
[4:18pm] danoyoung: So if I have a number of buckets, one with say
1000 objects in it, but I have 25 million objects scatter throughout a
number of buckets (on a given node), then a M/R query would need to
visit all 25 million even though I'm only interested in the 1000
objects?
[4:21pm] justinsheehy: yes, that's correct. (if you specify the M/R
by bucket instead of getting the input keylist some other way)
[4:21pm] justinsheehy: this is because the backends aren't required to
separate the buckets in any way, and in some cases simply use {bucket,
key} as their internal key.
[4:21pm] justinsheehy: that's what allows buckets to be "free"
[4:23pm] nfo: justinsheehy: so same behavior with "GET
/riak/bucket?keys=true" I suppose.
[4:23pm] danoyoung: hmm..ok, thanx. so it seems that I'll need to have
a secondary index somewhere (w/n riak or else) to keep track of all my
keys w/n a given bucket...
[4:24pm] justinsheehy: nfo: yes, that's effectively the same thing
[4:24pm] danoyoung: to avoid expensive list keys operations....
[4:27pm] nfo: justinsheehy: about this, I find "sad", for beginners,
that the Fast Track gives an example of a bucket listing without any
warning. It's the very first map/reduce Riak query a person sees, and
it's not efficient.
[4:27pm] nfo: {"inputs":"goog",
[4:27pm] nfo: 
https://wiki.basho.com/display/RIAK/Loading+Data+and+Running+MapReduce+Queries
[4:28pm] justinsheehy: nfo: fair enough, I'll make sure that gets (at
least) a note.
[4:28pm] danoyoung: if I had buckets with tens of thousands of object
in them, then what would be the most effecient way to run M/R against
them all, break up into multiple M/R jobs that process say 500
bucket/key values at a time...tand then aggregate these results....
[4:28pm] danoyoung: i meant 5000...
[4:28pm] seancribbs: danoyoung: knowing the keys AOT is crucial
[4:31pm] seancribbs: so if you have some way to build objects that
have links to the objects you want to query across, and the first ones
have intuitive keys, you'll avoid the cost of list-keys

-Nicolas

On Mon, Jul 12, 2010 at 4:44 PM, Alexander Sicular  wrote:
&gt; I believe the number of buckets are basically unlimited - as long as
&gt; you use the default bucket properties (which can be changed by conf
&gt; file), re. number of replicas. If you change bucket properties on the
&gt; fly that info runs around the cluster in the gossip channel.
&gt; Afaik, buckets are simply virtual namespaces. Your data structure
&gt; could have a bucket per user listing collections. Map over that then
&gt; use the collection value to deriv bucket/key pair to pass into
&gt; additional map phases in an m/r chain.
&gt;
&gt; And no, I seriously doubt that riak traverses the entire key space for
&gt; every m/r in the sense that it touches every key in the system
&gt; regardless of bucket. That is why riak has an input param required for
&gt; each m/r. I would love to hear otherwise.
&gt;
&gt; -Alexander
&gt;
&gt; On 2010-07-11, Daniel Einspanjer  wrote:
&gt;&gt;   I'm thinking about the pros and cons of Riak vs HBase for Mozilla's
&gt;&gt; Weave (now Firefox Sync) 2.0 engine.
&gt;&gt; https://wiki.mozilla.org/Labs/Weave/Sync/2.0/API
&gt;&gt;
&gt;&gt; The primary use case is that when a user's client performs a sync, it
&gt;&gt; needs to retrieve all the new items since the last time it synced for
&gt;&gt; each collection (bookmarks, tabs, history, etc.) that the client is
&gt;&gt; configured to sync.
&gt;&gt;      If a particular client doesn't sync often, it is possible that
&gt;&gt; there might be thousands of items to retrieve, this means that using
&gt;&gt; links \\*might\\* run into issues.
&gt;&gt;
&gt;&gt; HBase's use of ordered keys pushes for a schema where you'd have the
&gt;&gt; modified timestamp in the key.  That would allow for quick and easy
&gt;&gt; scanning of just the new items.
&gt;&gt;
&gt;&gt; Riak however, has a few interesting features such as the on-demand
&gt;&gt; creation of new buckets that might make it much more flexible... if
&gt;&gt; there is a highly performant mechanism for the client to retrieve new data.
&gt;&gt;
&gt;&gt; What prompted me to post this message was something I thought I
&gt;&gt; remembered seeing regarding mapping over buckets in Riak.  Unfortunately
&gt;&gt; I can't find the reference now.
&gt;&gt;
&gt;&gt; Is it true that in order to map over all the keys in a single bucket,
&gt;&gt; the Riak cluster must actually traverse the entire global keyspace of
&gt;&gt; all buckets to find the keys that are part of the desired bucket?
&gt;&gt;
&gt;&gt; In the case where you have tens of millions of users, and you have
&gt;&gt; either one bucket per user or (if it were feasible) one bucket per user
&gt;&gt; per collection, it seems like it would be impossible to efficiently
&gt;&gt; perform a map reduce on one user's bucket.
&gt;&gt;
&gt;&gt; That seems like such a common scenario, I must have misinterpreted what
&gt;&gt; I read.  I'd really appreciate some clarification there and also would
&gt;&gt; be very interested in any schema proposals or thoughts you might have
&gt;&gt; about this use case.
&gt;&gt;
&gt;&gt; -Daniel
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt; --
&gt; Sent from my mobile device
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

