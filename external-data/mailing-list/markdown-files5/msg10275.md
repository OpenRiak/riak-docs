---
title: "Re: How to call mapreduce from Riak client?"
description: ""
project: community
lastmod: 2013-02-27T07:29:45-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10275"
author_name: "Miroslav Urbanek"
project_section: "mailinglistitem"
sent_date: 2013-02-27T07:29:45-08:00
---


Answering my own e-mail:

The function has to be executed on a Riak node. The script should call

rpc:call(Host, riak\\_kv\\_mrc\\_pipe, mapred, [Inputs, Phases])

instead of

riak\\_kv\\_mrc\\_pipe:mapred(Inputs, Phases).

Miro

On Tue, Feb 26, 2013 at 10:39 PM, Miroslav Urbanek
 wrote:
&gt; Dear Riak users,
&gt;
&gt; I have an Erlang script for counting the number of objects in a Riak bucket:
&gt;
&gt; ...
&gt; Inputs = &lt;&lt;"buckets"&gt;&gt;,
&gt; Phases = [{reduce,{modfun,riak\\_kv\\_mapreduce,reduce\\_count\\_inputs},none,true}],
&gt; ...
&gt; {ok, Client} = riak:client\\_connect(Host)
&gt; Client:mapred(Inputs, Phases)
&gt; ...
&gt;
&gt; After the update to 1.3, this no longer works. In the mailing list
&gt; archive I found an alternative method:
&gt;
&gt; riak\\_kv\\_mrc\\_pipe:mapred(Inputs, Phases)
&gt;
&gt; However, I'm getting the following error:
&gt;
&gt; escript: exception exit: {noproc,{gen\\_server,call,
&gt; [riak\\_kv\\_mrc\\_sink\\_sup,
&gt; {start\\_child,[&lt;0.2.0&gt;,[]]},
&gt; infinity]}}
&gt; in function gen\\_server:call/3 (gen\\_server.erl, line 188)
&gt; in call from riak\\_kv\\_mrc\\_pipe:mapred\\_stream\\_sink/3
&gt; (src/riak\\_kv\\_mrc\\_pipe.erl, line 266)
&gt; in call from riak\\_kv\\_mrc\\_pipe:mapred/3 (src/riak\\_kv\\_mrc\\_pipe.erl, line 219)
&gt;
&gt; What does it mean? What's the optimal way to count number of keys in a
&gt; bucket in Riak 1.3 anyway?
&gt;
&gt; Here's the complete script:
&gt;
&gt; #!/usr/bin/env escript
&gt;
&gt; main(\\_) -&gt;
&gt;
&gt; Host = 'riak@domain',
&gt; Inputs = &lt;&lt;"bucket"&gt;&gt;,
&gt; Phases = 
&gt; [{reduce,{modfun,riak\\_kv\\_mapreduce,reduce\\_count\\_inputs},none,true}],
&gt;
&gt; ok = application:start(inets),
&gt; {ok, \\_} = net\\_kernel:start([count]),
&gt; true = auth:set\\_cookie('riak'),
&gt; true = net\\_kernel:connect\\_node(Host),
&gt;
&gt; case riak\\_kv\\_mrc\\_pipe:mapred(Inputs, Phases) of
&gt; {ok, Result} -&gt; io:format("OK: ~p~n", Result);
&gt; {error, Reason} -&gt; io:format("Error: ~p~n", Reason)
&gt; end.
&gt;
&gt; Thanks,
&gt; Miro

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

