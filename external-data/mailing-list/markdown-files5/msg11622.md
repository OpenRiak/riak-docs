---
title: "Re: TCP recv timeout and handoffs almost all the time"
description: ""
project: community
lastmod: 2013-07-19T00:51:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11622"
mailinglist_parent_id: "msg11619"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-07-19T00:51:28-07:00
---


Hi Simon,

If you have objects that can be a s big as 15MB, it is probably wise to 
increase the size of +zdbbl in order to avoid filling up buffers when these 
large objects need to be transferred between nodes. What an appropriate level 
is depends a lot on the size distribution of your data and your access 
patterns, so I would recommend benchmarking to find a suitable value.

Erlang also has a default process limit of 32768 (at least in R15B01), which 
may be what you are hitting. You can override this to 256k by adding the 
following line to the vm.args file:

 +P 262144

Best regards,

Christian



On 19 Jul 2013, at 08:24, Simon Effenberg  wrote:

&gt; The +zdbbl parameter helped a lot but the hinted handoffs didn't
&gt; disappear completely. I have no more busy dist port errors in the
&gt; \\_console.log\\_ (why aren't they in the error.log? it looks for me like a
&gt; serious problem you have.. at least our cluster was behaving not that
&gt; nice).
&gt; 
&gt; I'll try to increase the buffer size to a higher value because my
&gt; suggestion is that also the objects send from one to another are also
&gt; stored therein and we have sometimes objects which are up to 15MB.
&gt; 
&gt; But I saw now also some crashes in the last 6 hours on only two machines
&gt; complaining about too many processes
&gt; 
&gt; ----------------
&gt; console.log
&gt; 2013-07-19 02:04:21.962 UTC [error] &lt;0.12813.29&gt; CRASH REPORT Process 
&gt; &lt;0.12813.29&gt; with 15 neighbours exited with reason: {system\\_limit
&gt; 
&gt; crash.log
&gt; 2013-07-19 02:04:21 UTC =ERROR REPORT====
&gt; Too many processes
&gt; ----------------
&gt; 
&gt; the process has a process limit of 95142. So I will increase it now but I 
&gt; never saw any information about such problems on the linux tuning page. Am I 
&gt; missing something?
&gt; 
&gt; Cheers
&gt; Simon
&gt; 
&gt; 
&gt; On Thu, 18 Jul 2013 19:34:18 +0100
&gt; Guido Medina  wrote:
&gt; 
&gt;&gt; If what you are describing is happening for 1.4, type riak-admin diag 
&gt;&gt; and see the new recommended kernel parameters, also, on vm.args 
&gt;&gt; uncomment the +zdbbl 32768 parameter, since what you are describing is 
&gt;&gt; similar to what happened to us when we upgraded to 1.4.
&gt;&gt; 
&gt;&gt; HTH,
&gt;&gt; 
&gt;&gt; Guido.
&gt;&gt; 
&gt;&gt; On 18/07/13 19:21, Simon Effenberg wrote:
&gt;&gt;&gt; Hi @list,
&gt;&gt;&gt; 
&gt;&gt;&gt; I see sometimes logs talking about "hinted\\_handoff transfer of .. failed 
&gt;&gt;&gt; because of TCP recv timeout".
&gt;&gt;&gt; Also riak-admin transfers shows me many handoffs (is it possible to give 
&gt;&gt;&gt; some insights about "how many" handoffs happened through "riak-admin 
&gt;&gt;&gt; status"?).
&gt;&gt;&gt; 
&gt;&gt;&gt; - Is it a normal behavior to have up to 30 handoffs from/to different nodes?
&gt;&gt;&gt; - How can I get down to the problem with the TCP recv timeout? I'm not sure 
&gt;&gt;&gt; if this is a network problem or if the other node is too slow. The load is 
&gt;&gt;&gt; ok on the machines (some IOwait but not 100%). Maybe interfering with AAE?
&gt;&gt;&gt; 
&gt;&gt;&gt; Here the log information about the TCP recv timeout. But that is not that 
&gt;&gt;&gt; often but handoffs happens really often:
&gt;&gt;&gt; 
&gt;&gt;&gt; 2013-07-18 16:22:05.654 UTC [error] 
&gt;&gt;&gt; &lt;0.28933.14&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:216 hinted\\_handoff 
&gt;&gt;&gt; transfer of riak\\_kv\\_vnode from 'riak@10.46.109.207' 
&gt;&gt;&gt; 1118962191081472546749696200048404186924073353216 to 'riak@10.46.109.205' 
&gt;&gt;&gt; 1118962191081472546749696200048404186924073353216 failed because of TCP 
&gt;&gt;&gt; recv timeout
&gt;&gt;&gt; 2013-07-18 16:22:05.673 UTC [error] 
&gt;&gt;&gt; &lt;0.202.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:282 An outbound handoff of 
&gt;&gt;&gt; partition riak\\_kv\\_vnode 1118962191081472546749696200048404186924073353216 
&gt;&gt;&gt; was terminated for reason: {shutdown,timeout}
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks in advance
&gt;&gt;&gt; Simon
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; -- 
&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; Fon: + 49-(0)30-8109 - 7173
&gt; Fax: + 49-(0)30-8109 - 7131
&gt; 
&gt; Mail: seffenb...@team.mobile.de
&gt; Web: www.mobile.de
&gt; 
&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; 
&gt; 
&gt; Geschäftsführer: Malte Krüger
&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

