---
title: "Re: The best (fastest) way to delete/clear a bucket [python]"
description: ""
project: community
lastmod: 2014-05-19T13:35:31-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14238"
mailinglist_parent_id: "msg14236"
author_name: "Paweł Królikowski"
project_section: "mailinglistitem"
sent_date: 2014-05-19T13:35:31-07:00
---


The problem is that the tombstones never disappear - they keep coming back
through bucket.get\\_keys() hours after deletion, even after a restart.

I said I'm using the delete\\_mode default configuration, because I didn't
change it. I now tried, and apparently it's not supported any more in Riak
2.0.

17:16:56.318 [error] You've tried to set delete\\_mode, but there is no
setting with that name.^M
17:16:56.318 [error] Did you mean one of these?^M
17:16:56.335 [error] dtrace^M
17:16:56.335 [error] nodename^M
17:16:56.335 [error] ssl.keyfile^M
17:16:56.335 [error] Error generating configuration in phase
transform\\_datatypes^M
17:16:56.335 [error] Conf file attempted to set unknown variable:
delete\\_mode^M
Error generating config with cuttlefish

I'm using Riak 2.0.0pre20, on strongly consistent buckets, on a single node
cluster. Can this be the reason? I guess what I need is a confirmation that
something is broken/that I'm doing something stupid.

I've tried looking for similar issues (github.com/basho/riak/issues),
didn't find any -&gt; I guess that suggests I'm doing something stupid, I just
don't know what yet.


Thanks again :)

--
Paweł


On 19 May 2014 18:00, Dmitri Zagidulin  wrote:

&gt; Ah, yes, you bring up a good point. (And, that's another subtlety to keep
&gt; in mind, with Option #1).
&gt;
&gt; Tombstones are definitely something to keep in mind, when deleting unit
&gt; test data.
&gt; As you mentioned in your earlier question, if you're using default
&gt; delete\\_mode configuration ( 3 seconds ), it means that if you issue a
&gt; delete, a tombstone object is going to be written (and stick around for at
&gt; least 3 seconds), and unfortunately, it is going to show up as a false
&gt; positive on a List Keys call.
&gt;
&gt; The easiest thing to try, in your case, is to set 'delete\\_mode' to
&gt; 'immediate', restart the test cluster, and retest. With an immediate
&gt; delete, your second test with 10 keys should not take as long as the
&gt; previous delete with 10000 keys.
&gt;
&gt;
&gt;
&gt;
&gt; On Mon, May 19, 2014 at 11:46 AM, Paweł Królikowski wrote:
&gt;
&gt;&gt; Hi Dmitri,
&gt;&gt;
&gt;&gt; Thanks a lot for the answer. Option #1 seems the best, but I have a
&gt;&gt; follow up question:
&gt;&gt;
&gt;&gt; - when do the deleted keys disappear from Riak: a part of my problem
&gt;&gt; (have not explained it correctly the first time), is that get\\_keys()
&gt;&gt; returns keys that no longer exist. So, I run a test with 10 000 keys, I
&gt;&gt; remove them, it takes Nseconds. I then follow with a test with 10 keys, but
&gt;&gt; removing them takes just as much time - I imagine it's because I'm going
&gt;&gt; over that 10 000 keys again.
&gt;&gt;
&gt;&gt; This article seems relevant:
&gt;&gt; http://basho.com/riaks-config-behaviors-part-3/ - it seems like the
&gt;&gt; tombstones simply remain in my system indefinitely.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Paweł
&gt;&gt;
&gt;&gt;
&gt;&gt; On 19 May 2014 15:32, Dmitri Zagidulin  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Pawel,
&gt;&gt;&gt;
&gt;&gt;&gt; There's basically three ways to clear data from Riak (for the purposes
&gt;&gt;&gt; of automated testing):
&gt;&gt;&gt;
&gt;&gt;&gt; 1. Iterate through the keys via get\\_keys(), and delete each one. This is
&gt;&gt;&gt; what you're currently doing, except you don't need to invoke if.exists().
&gt;&gt;&gt; if.exists() makes an additional API call to Riak, and it takes twice as
&gt;&gt;&gt; long as just calling delete() (and trapping a potential 404 doesn't exist
&gt;&gt;&gt; error).
&gt;&gt;&gt;
&gt;&gt;&gt; Advantages: Easy to understand, can be done entirely in code (without
&gt;&gt;&gt; invoking OS/shell commands).
&gt;&gt;&gt;
&gt;&gt;&gt; Disadvantages: It can get slow, for large data sets. Another subtle
&gt;&gt;&gt; disadvantage is that, as your app grows, it can get difficult to keep track
&gt;&gt;&gt; of which buckets you've created and need to be cleared.
&gt;&gt;&gt;
&gt;&gt;&gt; 2. Stop the Riak cluster, delete the riak data directory, and re-start.
&gt;&gt;&gt;
&gt;&gt;&gt; Advantages: Very fast, and you can be sure that you're deleting all
&gt;&gt;&gt; buckets.
&gt;&gt;&gt;
&gt;&gt;&gt; Disadvantages: Involves invoking OS/shell commands. This is fairly easy
&gt;&gt;&gt; if your Riak node is running on the same machine as your tests (and if it's
&gt;&gt;&gt; a single node). To delete the data directories of a multi-node cluster, now
&gt;&gt;&gt; you need to involve either a bash script that uses SSH to log in and
&gt;&gt;&gt; restart, or a coordination framework like Ansible.
&gt;&gt;&gt;
&gt;&gt;&gt; 3. Use an in-memory back end. (And to drop all data, just restart the
&gt;&gt;&gt; node(s)).
&gt;&gt;&gt;
&gt;&gt;&gt; Advantages: Same as #2 - fast, thorough.
&gt;&gt;&gt;
&gt;&gt;&gt; Disadvantages: Same as #2 (involves shell commands, potentially SSH
&gt;&gt;&gt; etc). In addition, since you're likely not going to be running your
&gt;&gt;&gt; production code on an in-memory back end, this method introduces a
&gt;&gt;&gt; potential environmental/functional difference between your testing and
&gt;&gt;&gt; production clusters.
&gt;&gt;&gt;
&gt;&gt;&gt; I generally use method #1 in my unit tests, and manually delete each
&gt;&gt;&gt; key.
&gt;&gt;&gt;
&gt;&gt;&gt; Dmitri
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Mon, May 19, 2014 at 8:53 AM, Paweł Królikowski wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; For testing, I'd like to be able to throw a large number of data at
&gt;&gt;&gt;&gt; Riak (100k+ entries), check how it performed, change something in the
&gt;&gt;&gt;&gt; application, run the test again. I'd like to use the same data every time,
&gt;&gt;&gt;&gt; so, I'd like to clear the bucket between every test.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The documentation (
&gt;&gt;&gt;&gt; http://docs.basho.com/riak/2.0.0beta1/dev/references/http/) says:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\*Delete Buckets\\*
&gt;&gt;&gt;&gt; There is no straightforward way to delete an entire Bucket. To delete
&gt;&gt;&gt;&gt; all the keys in a bucket, you’ll need to delete them all individually.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; So, I'm currently using something like:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; for k in r\\_bk.get\\_keys():
&gt;&gt;&gt;&gt; v = r\\_bk.get(k)
&gt;&gt;&gt;&gt; if v.exists:
&gt;&gt;&gt;&gt; r\\_bk.delete(v)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The problem is that r\\_bk.get\\_keys() returns a lot of elements that
&gt;&gt;&gt;&gt; don't exist (tombstones?) and iterating over all of them takes time.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Is that the way it's supposed to work? Or am I missing something?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; - I'm using default delete\\_mode configuration ( 3 seconds )
&gt;&gt;&gt;&gt; - I'm using Riak 2.0 alpha 19 with Python. ( there's a bug with strong
&gt;&gt;&gt;&gt; consistency in Beta1, cannot use it)
&gt;&gt;&gt;&gt; - changing the bucket name for every run seems .. impractical?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Any advices welcomed,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt; Paweł
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

