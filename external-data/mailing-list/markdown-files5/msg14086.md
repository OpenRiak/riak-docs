---
title: "Re: Performance slows down with write heavy use"
description: ""
project: community
lastmod: 2014-04-14T20:02:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14086"
mailinglist_parent_id: "msg14085"
author_name: "Istv√°n"
project_section: "mailinglistitem"
sent_date: 2014-04-14T20:02:23-07:00
---


This is very little information that you provided. Based on that
nobody can draw conclusions. It is better to use the system
performance monitoring tools and find out what is saturated and change
the settings based on that.

Linux performance guide:

http://www.brendangregg.com/USEmethod/use-linux.html

LevelDB configuration:

http://docs.basho.com/riak/latest/ops/advanced/backends/leveldb/#Parameter-Planning

20 ops/s is very low, you can use basho\\_bench to benchmark riak and
get a better understanding what is going on with pretty graphs and
useful p values.

basho\\_bench:

https://github.com/basho/basho\\_bench

Regards,
Istvan

On Mon, Apr 14, 2014 at 7:10 PM, Jie Lu  wrote:
&gt;
&gt; I also have a problem in performance test of Riak Cluster.
&gt; ~~~~~~~~~~~~
&gt; Riak version: 1.4.7
&gt; OS: openSUSE 11.3
&gt; RAM: 4G
&gt; ring size is 64
&gt; backend: leveldb
&gt; Nodes in cluster: 6 nodes
&gt;
&gt; ~~~~~~~~~~~~~
&gt;
&gt; I write a key/value with value is 1K bytes, and 25 concurrent threads on
&gt; one client nodes. The test result only 20 ops/s performance.
&gt;
&gt; Is there any performance benchmark to compare with?
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; On Tue, Apr 15, 2014 at 6:26 AM, Luke Bakken  wrote:
&gt;&gt;
&gt;&gt; Hi Matthew -
&gt;&gt;
&gt;&gt; Some suggestions:
&gt;&gt;
&gt;&gt; \\* Upgrade to Riak 1.4.8
&gt;&gt;
&gt;&gt; \\* Test with a ring size of 64
&gt;&gt;
&gt;&gt; \\* Use staggered merge windows in your cluster
&gt;&gt; (http://docs.basho.com/riak/latest/ops/advanced/backends/bitcask/)
&gt;&gt;
&gt;&gt; \\* Since you're on dedicated hardware RAID, use the noop scheduler for your
&gt;&gt; Riak data volumes:
&gt;&gt;
&gt;&gt; cat /sys/block/sd\\*/queue/scheduler
&gt;&gt; noop anticipatory deadline [cfq]
&gt;&gt;
&gt;&gt; \\* Increase +zdbbl in /etc/riak/vm.args to 96000
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; CSE
&gt;&gt; lbak...@basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, Apr 14, 2014 at 2:33 PM, Matthew MacClary
&gt;&gt;  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; I have a persistent issue I am trying to diagnose. In our use of Riak we
&gt;&gt;&gt; have multiple data creators writing into a 7 node cluster. The value size is
&gt;&gt;&gt; a bit large at around 2MB. The behavior I am seeing is that if I delete all
&gt;&gt;&gt; data out of bitcask, then test performance I get fast writes. As I keep
&gt;&gt;&gt; doing the same work of writing to the cluster, then the Riak write times
&gt;&gt;&gt; will start tailing off and getting really bad.
&gt;&gt;&gt;
&gt;&gt;&gt; Initial write times seen by my application: 0.5 seconds for 100MB worth
&gt;&gt;&gt; of values (~200MB/s)
&gt;&gt;&gt; Subsequent write times: 11 seconds for 100MB worth of values (~9MB/s)
&gt;&gt;&gt;
&gt;&gt;&gt; This slow down can happen over roughly 20-40 minutes of writing or about
&gt;&gt;&gt; 200GB worth of key/value pairs written.
&gt;&gt;&gt;
&gt;&gt;&gt; I can reset the cluster to get fast performance again by stopping Riak
&gt;&gt;&gt; and deleting the bitcask directories, then starting Riak again. This step is
&gt;&gt;&gt; not feasible for production, but during testing at least the write speed
&gt;&gt;&gt; goes up by 20x.
&gt;&gt;&gt;
&gt;&gt;&gt; Watching iostat I see that every few seconds the disk io jumps to ~11%.
&gt;&gt;&gt; It doesn't seem that highly loaded from my cursory look. Watching top I see
&gt;&gt;&gt; that beam.smp runs at around 100 for CPU% or less when heavily loaded. I am
&gt;&gt;&gt; not sure how to tell what it is doing though :-)
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for any suggestions!!
&gt;&gt;&gt;
&gt;&gt;&gt; -Matt
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; ================
&gt;&gt;&gt; System Description
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; avg value size = 2MB
&gt;&gt;&gt; Riak version = 1.4.1
&gt;&gt;&gt; n\\_val = 2
&gt;&gt;&gt; client threads total = 105
&gt;&gt;&gt; backend = bitcask
&gt;&gt;&gt; ring\\_creation\\_size = 128
&gt;&gt;&gt; node count = 7
&gt;&gt;&gt; node OS = RHEL 6.2
&gt;&gt;&gt; server RAM = 128GB
&gt;&gt;&gt; RAID = RAID0 across 8 SAS drives
&gt;&gt;&gt; FS = ext4
&gt;&gt;&gt; FS options = /dev/mapper/vg0-lv0 / ext4
&gt;&gt;&gt; rw,noatime,barrier=0,stripe=512,data=ordered 0 0
&gt;&gt;&gt; bitcask size on one server = 133GB
&gt;&gt;&gt; AAE = off
&gt;&gt;&gt; interface = protobuf
&gt;&gt;&gt; client library = riak java client
&gt;&gt;&gt; file-max = 65536
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Best Regards.
&gt; Lu Jie
&gt;
&gt;
&gt;
&gt; --
&gt; Best Regards.
&gt; Lu Jie
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
the sun shines for all

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

