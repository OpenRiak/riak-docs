---
title: "Re: Q: What mechanism does Riak have to deal with the unique user	issue?"
description: ""
project: community
lastmod: 2010-07-09T18:07:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00700"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2010-07-09T18:07:45-07:00
---


Carbon-copying to riak-users since this is an important discussion.

You seem to have a fundamental misunderstanding about how quorums work. Write 
quorums (W and DW) aren't guarantees of atomicity and [global] consistency, but 
of durability. There's no distributed transaction, two-phase commit, or mutual 
coordination of writes, simply an acknowledgment that the write was received on 
an adequate number of nodes. 

One unintuitive side-effect of these "sloppy quorums" is that a write may 
appear to fail to the client (i.e. not meet quorum), but actually succeed on 
some number of nodes within the cluster. However, on the next read, if the 
nodes that did succeed report in a timely fashion, the previously failed nodes 
will be updated with the new value (read repair).

I tried to place strong caveats on the use of the If-None-Match header and 
read-before-write strategy because they can only be implemented on the 
client-side, and they only are able to present an asynchronously aggregated 
state at the time of request, not a strong guarantee of global consistency. 
Again, buyer beware.

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On Jul 9, 2010, at 7:17 PM, Carl Humphrey wrote:

&gt; Hi Sean,
&gt; 
&gt; regarding the answer to this question, i'm a bit confused with the answer.
&gt; 
&gt; couldn't I choose to forgo availability ( for some of the cluster users ) 
&gt; and only create a new user when a majority vote write passes
&gt; 
&gt; for instance
&gt; 
&gt; i have 3 servers each connected to each other
&gt; 
&gt; if 1 server gets cut off from the other 2 , it couldn't get a majority vote 
&gt; on a write and therefore cant add new users
&gt; 
&gt; however the other side of the split brain could get a majority vote ( 2 out 
&gt; of 3 ) and therefore its safe to write. ( with the?If-None\\_Match header? )
&gt; 
&gt; is this not the way the CAP settings work in riak work?
&gt; 
&gt; if i want to be able to dish out unique resources to customer do i have to 
&gt; implement zookeeper alongside riak to do it?
&gt; 
&gt; Much Thanks
&gt; Carl.
&gt; 
&gt; Q: What mechanism does Riak have to deal with the unique user issue?
&gt; 
&gt; Riak has neither write locks nor transactions. There is no way to absolutely 
&gt; guarantee uniqueness without introducing an intermediary that acts as a 
&gt; single-arbiter (and point-of-failure). However, in cases when you aren't 
&gt; experiencing high write-concurrency on the data in question there are a few 
&gt; things you can do to simulate the uniqueness constraint:
&gt; 
&gt; Check for existence of the key before writing. In HTTP, this is as simple as 
&gt; a HEAD request. If the response is 404 Not Found, the object probably doesn't 
&gt; exist.
&gt; Use a conditional PUT (in HTTP) when creating the object. The If-None-Match: 
&gt; \\*header should prevent you from blindly overwriting an existing key.
&gt; Neither of these solutions are bullet-proof because all operations happen in 
&gt; Riak asynchronously. Remember that it's eventually consistent, meaning that 
&gt; not all parts of the system may agree at all times, but they will converge on 
&gt; a single state over time. There will be corner-cases where a key doesn't 
&gt; exist when you check for it, the write via the conditional request succeeds, 
&gt; and you still end up creating an object in conflict. Caveat emptor.
&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

