---
title: "Re: MapReduce performance problem"
description: ""
project: community
lastmod: 2013-02-28T17:41:12-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10296"
mailinglist_parent_id: "msg10264"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2013-02-28T17:41:12-08:00
---


I didn't want you to think that you've been forgotten, but I've been
swamped getting ready to head out of the country for 2 weeks on a company
trip. You're in good hands with the list, though.

---
Jeremiah Peschka - Founder, Brent Ozar Unlimited
MCITP: SQL Server 2008, MVP
Cloudera Certified Developer for Apache Hadoop


On Tue, Feb 26, 2013 at 4:36 PM, Kevin Burton wrote:

&gt; I got the same error on an AWS instance (m1.xlarge) when using the
&gt; MapReduce version of list all keys.\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; Query failed with Riak returned an error. Code '0'. Message:
&gt; {"phase":0,"error":"[preflist\\_exhausted]","input":"{ok,{r\\_object,&lt;&lt;\\"buyseasons-products\\"&gt;&gt;,&lt;&lt;\\"00113023\\"&gt;&gt;,[{r\\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;\\"content-type\\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\\"X-Riak-VTag\\"&gt;&gt;,49,54,99,97,90,90,72,106,56,50,100,77,85,75,66,114,76,50,109,88,89,109]],[[&lt;&lt;\\"index\\"&gt;&gt;,{&lt;&lt;\\"active\\_bin\\"&gt;&gt;,&lt;&lt;\\"InactiveDiscontinued\\"&gt;&gt;},{&lt;&lt;\\"definition\\_bin\\"&gt;&gt;,&lt;&lt;\\"Costume\\"&gt;&gt;},{&lt;&lt;\\"department\\_bin\\"&gt;&gt;,&lt;&lt;\\"Adult
&gt; Costumes\\"&gt;&gt;},{&lt;&lt;\\"...\\"&gt;&gt;,...}]],...}}},...}],...},...}","type":"forward\\_preflist","stack":"[]"}
&gt; – CommunicationError\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; The ‘Department’ MapReduce with an AWS instance also returned three
&gt; ‘failed’ phases.\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; Kevin\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; \\*From:\\* riak-users [mailto:riak-users-boun...@lists.basho.com] \\*On Behalf
&gt; Of \\*Jeremiah Peschka
&gt; \\*Sent:\\* Tuesday, February 26, 2013 3:18 PM
&gt;
&gt; \\*To:\\* riak-users
&gt; \\*Subject:\\* Re: MapReduce performance problem\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; Responses inline.\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; ---\\*\\*\\*\\*
&gt;
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited\\*\\*\\*\\*
&gt;
&gt; MCITP: SQL Server 2008, MVP\\*\\*\\*\\*
&gt;
&gt; Cloudera Certified Developer for Apache Hadoop\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; On Tue, Feb 26, 2013 at 12:26 PM, Kevin Burton 
&gt; wrote:\\*\\*\\*\\*
&gt;
&gt; Right. I know it is not ideal. I have been able to split the VM’s into
&gt; groups. So 2 of the 4 are running on separate hardware. Anything more I
&gt; just get the response ‘get real’. That being said I want to get the maximum
&gt; performance of the limited resources that I have. I have a separate
&gt; question for the group in trying to get basho\\_bench up and running (I get a
&gt; long string of errors). What do you need to know more about my environment
&gt; to “understand” it? I am new so I am probably asking the wrong questions so
&gt; please tell me what you are missing that might help diagnose the problem.\\*
&gt; \\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; For troubleshooting any environment it's good to know relevant hardware
&gt; details about CPU speed, core count, amount of RAM, disks, network cards,
&gt; etc. A working basho\\_bench benchmark would help, too, because it will
&gt; provide an indicator of how your environment will perform with Riak as
&gt; opposed to how your business logic performs, as implemented, with Riak.\\*\\*\\*
&gt; \\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; For virtualization, it's also important to know how many other guests are
&gt; on the host, whether there are any CPU, memory, or network reservations in
&gt; place, and which version of virtualization you're running. Virtualization
&gt; makes performance tuning more complex, but not impossible. \\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; I agree. I will use ListAllKeysFromIndex to get a list of keys for now.
&gt; The only reason that I included the m/r code is because of the error. If I
&gt; get another m/r job with similar output I need to know how to diagnose the
&gt; problem. I was using JavaScript m/r because I kind of understand
&gt; JavaScript. Is there a separate task to do Erlang m/r jobs.\\*\\*\\*\\*
&gt;
&gt; Erlang phases can be added to a MapReduceQuery using MapErlang and
&gt; ReduceErlang. \\*\\*\\*\\*
&gt;
&gt; I assume that I will need to know Erlang. Any recommendations on how best
&gt; to know what I need to know about Erlang to write a m/r job. But before I
&gt; do that wouldn’t it be prudent to know that the source if the problem is
&gt; indeed JavaScript? How would I pinpoint that?\\*\\*\\*\\*
&gt;
&gt; I think this has been answered on list. I'd search
&gt; http://riak.markmail.org\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; Someone from Basho can probably handle this better than my handwaving that
&gt; using JavaScript involves an interpreter, type marshaling between Erlang
&gt; and JavaScript, and won't multi-thread like Erlang will.\\*\\*\\*\\*
&gt;
&gt; These two m/r jobs are basically an example of using m/r that would be
&gt; typical for our application. Just for sheer maintenance we wouldn’t want
&gt; to go down the path of maintaining a counter for all the fields that we
&gt; have. There could be departments, categories, celebrations, . . . Basically
&gt; a lot of them. For all intents it is an ad hoc query. If that is one of
&gt; the limitations then we will have to note it and see if coping with this
&gt; limitation is too onerous.\\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; MR queries are going to scan all of your data on disk. If you have 5 nodes
&gt; that can read at ~100 MB/s and you have 100GB of data, how long will it
&gt; take for your ad hoc query to run? \\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
&gt; Riak Search/Lucene/Yokozuna will be better options for ad hoc workloads
&gt; than MapReducing across the cluster.\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; \\*From:\\* riak-users [mailto:riak-users-boun...@lists.basho.com] \\*On Behalf
&gt; Of \\*Jeremiah Peschka
&gt; \\*Sent:\\* Tuesday, February 26, 2013 1:33 PM
&gt; \\*To:\\* riak-users
&gt; \\*Subject:\\* Re: MapReduce performance problem\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; Before you go troubleshooting performance problems, I'd focus on getting
&gt; results out of basho\\_bench and getting a good understanding of your
&gt; environment. If you're running 4 guests with 1 vCPU each on the same VM
&gt; host with all guests sharing a single pool of disks, no amount of tuning
&gt; will solve that problem. Without an understanding of the operating
&gt; environment, we can't do much more than point at general best practices and
&gt; say "these might help you, not sure, though."\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; As far as your specifics - for the first query, if you're attempting to
&gt; get a list of keys, I still recommend using ListAllKeysFromIndex(string
&gt; Bucket). This will be pushed out as part of the IRiakClient interface in
&gt; the next day or two, and I'm sure the gods of OOP won't kill you for using
&gt; an actual RiakClient object instead of an IRiakClient interface between now
&gt; and then. Sending those results back directly from riak\\_kv is going to be
&gt; far faster than messing around with a JavaScript MapReduce job.\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; Always keep in mind that MR jobs are not going to be the most efficient
&gt; way to perform any kind of ad hoc querying - they're great for large scale
&gt; data transformations but if you really want performance, you'll want to
&gt; write Erlang MR jobs. \\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; If you need to maintain counts per department, a better approach will be
&gt; persisting counters and maintaining those counts via some kind of
&gt; caching/pre-aggregation mechanism, most likely outside of Riak because of
&gt; eventual consistency guarantees. Alex Siculars will eventually show up and
&gt; start chanting "use redis"; you'll be resistant at first, but his arguments
&gt; make a lot of sense. Riak does some things very well, maintaining
&gt; consistent counters isn't one of them... yet.\\*\\*\\*\\*
&gt;
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; ---\\*\\*\\*\\*
&gt;
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited\\*\\*\\*\\*
&gt;
&gt; MCITP: SQL Server 2008, MVP\\*\\*\\*\\*
&gt;
&gt; Cloudera Certified Developer for Apache Hadoop\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; On Tue, Feb 26, 2013 at 10:52 AM, Kevin Burton 
&gt; wrote:\\*\\*\\*\\*
&gt;
&gt; I have a simple CorrugatedIron client that makes the following request:\\*\\*\\*
&gt; \\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; IRiakClient riakClient = cluster.CreateClient();\\*\\*\\*\\*
&gt;
&gt; RiakBinIndexRangeInput bucketKeyInput = new
&gt; RiakBinIndexRangeInput(productBucketName, "$key", "00000000", "99999999");
&gt; \\*\\*\\*\\*
&gt;
&gt; RiakMapReduceQuery query = new RiakMapReduceQuery()\\*\\*\\*\\*
&gt;
&gt; .Inputs(bucketKeyInput)\\*\\*\\*\\*
&gt;
&gt; .MapJs(m =&gt; m.Name("Riak.mapValuesJson").Keep(true));\\*\\*
&gt; \\*\\*
&gt;
&gt; RiakResult result =
&gt; riakClient.MapReduce(query);\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; So as you can see this is a very basic range m/r query. But the result
&gt; comes back as:\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; Riak returned an error. Code '0'. Message: timeout\\*\\*\\*\\*
&gt;
&gt; CommunicationError\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; Another type of m/r query I have\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; IRiakClient riakClient = cluster.CreateClient();\\*\\*\\*\\*
&gt;
&gt; var query = new RiakMapReduceQuery()\\*\\*\\*\\*
&gt;
&gt; .Inputs(productBucketName)\\*\\*\\*\\*
&gt;
&gt; .MapJs(m =&gt; m.Source(@"function(v,d,a) {" +\\*\\*\\*\\*
&gt;
&gt; "var p = JSON.parse(v.values[0].data);" +\\*\\*\\*\\*
&gt;
&gt; "var r = [];" +\\*\\*\\*\\*
&gt;
&gt; "d = escape(p.Department);" +\\*\\*\\*\\*
&gt;
&gt; "if(d != '') {" +\\*\\*\\*\\*
&gt;
&gt; "var o = {};" +\\*\\*\\*\\*
&gt;
&gt; "o[d] = 1;" +\\*\\*\\*\\*
&gt;
&gt; "r.push(o);" +\\*\\*\\*\\*
&gt;
&gt; "}" +\\*\\*\\*\\*
&gt;
&gt; "return r;" +\\*\\*\\*\\*
&gt;
&gt; "}"))\\*\\*\\*\\*
&gt;
&gt; .ReduceJs(m =&gt; m.Source(@"function(v,d,a) {" +\\*\\*\\*\\*
&gt;
&gt; "var r = {};" +\\*\\*\\*\\*
&gt;
&gt; "for(var i in v) {" +\\*\\*\\*\\*
&gt;
&gt; " for(var w in v[i]) {" +\\*\\*\\*\\*
&gt;
&gt; " if(w in r) r[w] += v[i][w];" +\\*\\*\\*\\*
&gt;
&gt; " else r[w] = v[i][w];" +\\*\\*\\*\\*
&gt;
&gt; " }" +\\*\\*\\*\\*
&gt;
&gt; "}" +\\*\\*\\*\\*
&gt;
&gt; "return [r];" +\\*\\*\\*\\*
&gt;
&gt; "}")\\*\\*\\*\\*
&gt;
&gt; .Keep(true));\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; This returns but it takes far too long. I have about 60,000 items in my
&gt; bucket and this takes about 50-60 seconds to execute. The results seem
&gt; valid. For these types of m/r jobs what can I do on the server (or client)
&gt; to helo diagnose the problem. I have basic tools like iostat and top to
&gt; give me data but some pointers on using the output of these tools might
&gt; help.\\*\\*\\*\\*
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com\\*\\*\\*\\*
&gt;
&gt; \\*\\*\\*\\*
&gt;
&gt; \\*\\* \\*\\*
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

