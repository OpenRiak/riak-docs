---
title: "Re: [CRDT_OP-in-CommitHook]"
description: ""
project: community
lastmod: 2017-03-02T00:34:17-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18052"
mailinglist_parent_id: "msg18051"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2017-03-02T00:34:17-08:00
---


Hi,

You’re using internal details of the CRDT implementation, I’m not sure that is 
such a great idea. You always have your `Context` set to `undefined` but if 
your ops are all adds that shouldn’t matter in this case.

The issue is that you’re calling `riak\\_kv\\_crdt:update` that needs to be called 
from within the vnode. The `ThisNode` value is not a serial actor, so you may 
have many concurrent updates with the actor `ThisNode`, and that’s not how to 
do it. It is crucial that the actor updating the CRDT acts in serial issuing an 
increasing count of events. Thats why we put the CRDT code inside Riak, inside 
the vnode.

You’re doing neither one thing nor the other, in that your using a datatype 
bucket but not the datatype API (it sends Ops from the client, you’re doing 
read/modify/write.)

I can see the issue here is that the API is external only, if you \\_must\\_ use 
the internal API have a look at 
https://github.com/basho/riak\\_kv/blob/develop/src/riak\\_kv\\_pb\\_crdt.erl and you 
see that the CRDT\\_OP is all that is sent by the client.

https://github.com/basho/riak\\_kv/blob/develop/src/riak\\_kv\\_pb\\_crdt.erl#L162

Those put options matter too, especially for counters, less so for sets.

I guess it would be great if riak\\_client had some internal API functions that 
made this easier to do from a hook. If you open an issue on 
github.com/basho/riak\\_kv I can look into that and make a PR.

Hope that helps

Russell

On 1 Mar 2017, at 09:30, 李明  wrote:

&gt; Hi 
&gt; I am new to erlang and riak. I started to use riak as a kv store couple 
&gt; of months ago. Now i want to implement a commit hook to riak so that riak 
&gt; could help me to make some statistics.
&gt; i read some docs and write a pre-hook scripts, which will fetch the object 
&gt; key and store it into a set.
&gt; This hook works fine if there is only one client write to riak, but if i 
&gt; increase the connection to riak writing, i found it lost some elements in the 
&gt; set. Looks like the crdt\\_op did not do the merge operation.And there is no 
&gt; obvious error in the log files.
&gt; 
&gt; Could someone help me to finger out what happened or what i has missed.
&gt; 
&gt; i am using the riak 2.1.3
&gt; 
&gt; Thanks all!
&gt; 
&gt; 
&gt; Here is the hook scripts:
&gt; 
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; -module(myhook).
&gt; -export([pretest/1]).
&gt; 
&gt; now\\_to\\_local\\_string({MegaSecs, Secs, MicroSecs}) -&gt;
&gt; LocalTime = calendar:now\\_to\\_local\\_time({MegaSecs, Secs, MicroSecs}),
&gt; {{Year, Month, Day}, {Hour, Minute, \\_}} = LocalTime,
&gt; TimeStr = lists:flatten(io\\_lib:format("~4..0w~2..0w~2..0w~2..0w~2..0w",
&gt; [Year, Month, Day, Hour, Minute])),
&gt; TimeStr.
&gt; 
&gt; is\\_deleted(Object)-&gt;
&gt; case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riak\\_object:get\\_metadata(Object)) of
&gt; {ok,\\_} -&gt;
&gt; true;
&gt; \\_ -&gt;
&gt; false
&gt; end.
&gt; 
&gt; pretest(Object) -&gt;
&gt; % timer:sleep(10000),
&gt; try
&gt; ObjBucket = riak\\_object:bucket(Object),
&gt; % riak\\_object:bucket(Obj).
&gt; % {&lt;&lt;"cn-archive"&gt;&gt;,&lt;&lt;"local-test"&gt;&gt;}
&gt; 
&gt; Bucket = element(2, ObjBucket),
&gt; BucketType = element(1, ObjBucket),
&gt; 
&gt; ObjKey = riak\\_object:key(Object),
&gt; % Key = binary\\_to\\_list(ObjKey),
&gt; % ObjData = riak\\_object:get\\_value(Object),
&gt; % Msg = binary\\_to\\_list(ObjData),
&gt; CommitItem = iolist\\_to\\_binary(mochijson2:encode({struct, [{b, 
&gt; Bucket}, {k, ObjKey}, {t, BucketType}]})),
&gt; 
&gt; case is\\_deleted(Object) of
&gt; true -&gt;
&gt; KeyPrefix = "delete";
&gt; \\_ -&gt;
&gt; KeyPrefix = "update"
&gt; end,
&gt; 
&gt; CurMin = now\\_to\\_local\\_string(os:timestamp()),
&gt; IndexKey = binary:list\\_to\\_bin(io\\_lib:format("~s-~s", [CurMin, 
&gt; KeyPrefix])),
&gt; 
&gt; %% Get a riak client
&gt; {ok, C} = riak:local\\_client(),
&gt; % get node obj
&gt; ThisNode = atom\\_to\\_binary(node(), latin1),
&gt; 
&gt; % get index obj and set context
&gt; BType = &lt;&lt;"archive"&gt;&gt;,
&gt; B = &lt;&lt;"local-test"&gt;&gt;,
&gt; 
&gt; {SetObj, Context} = case C:get({BType, B}, IndexKey) of
&gt; {error, notfound} -&gt; 
&gt; ThisSetObj = riak\\_kv\\_crdt:new({BType, B}, IndexKey, 
&gt; riak\\_dt\\_orswot),
&gt; {ThisSetObj, undefined};
&gt; {ok, ThisSetObj} -&gt;
&gt; % The datatype update requires the context if the value 
&gt; exists
&gt; {{Ctx, \\_}, \\_} = riak\\_kv\\_crdt:value(ThisSetObj, 
&gt; riak\\_dt\\_orswot),
&gt; {ThisSetObj, Ctx}
&gt; end,
&gt; 
&gt; UpdateIndex = [{add, CommitItem}],
&gt; % UpdateOp = {crdt\\_op, riak\\_dt\\_orswot, {update, UpdateIndex}, 
&gt; Context},
&gt; UpdateOp = {crdt\\_op, riak\\_dt\\_orswot, {update, UpdateIndex}, 
&gt; undefined},
&gt; NewObj = riak\\_kv\\_crdt:update(SetObj, ThisNode, UpdateOp),
&gt; 
&gt; error\\_logger:info\\_msg("Updating index for ~s,to set ~s~n", 
&gt; [binary:bin\\_to\\_list(CommitItem), IndexKey]),
&gt; 
&gt; C:put(NewObj),
&gt; Object
&gt; catch
&gt; error:Error -&gt;
&gt; {fail, 
&gt; lists:flatten(io\\_lib:format("[PREHOOKEXCEPTION]~p",[Error]))}
&gt; end.
&gt; 
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; 
&gt; This is the set bucket props
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; active: true
&gt; allow\\_mult: true
&gt; basic\\_quorum: false
&gt; big\\_vclock: 50
&gt; chash\\_keyfun: {riak\\_core\\_util,chash\\_std\\_keyfun}
&gt; claimant: 'riak@192.168.100.2'
&gt; datatype: set
&gt; dvv\\_enabled: true
&gt; dw: quorum
&gt; last\\_write\\_wins: false
&gt; linkfun: {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}
&gt; n\\_val: 3
&gt; notfound\\_ok: true
&gt; old\\_vclock: 86400
&gt; postcommit: []
&gt; pr: 0
&gt; precommit: []
&gt; pw: 0
&gt; r: quorum
&gt; rw: quorum
&gt; small\\_vclock: 50
&gt; w: quorum
&gt; young\\_vclock: 20
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

