---
title: "Re: ListKeys or MapReduce"
description: ""
project: community
lastmod: 2013-02-12T11:46:14-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10103"
mailinglist_parent_id: "msg10101"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2013-02-12T11:46:14-08:00
---


...and fixed!

You can get this right now if you're adventurous and want to build
CorrugatedIron from source by grabbing the develop branch [1]. We have
several other issues to clean up and verify before we release CI 1.1.1 in
the next day or so. Or you can download it from [2] if you don't want to
build yourself and don't want to wait for NuGet. Once we put 1.1.1 to NuGet
we'll respond to this thread or email you directly.

I make no guarantees that the new DLL won't eat your hard drive or turn
your computer into a killer robot.

[1]: https://github.com/DistributedNonsense/CorrugatedIron/tree/develop
[2]:
http://clientresources.brentozar.com.s3.amazonaws.com/CorrugatedIron-111-alpha.zip

---
Jeremiah Peschka - Founder, Brent Ozar Unlimited
MCITP: SQL Server 2008, MVP
Cloudera Certified Developer for Apache Hadoop


On Tue, Feb 12, 2013 at 11:13 AM, Jeremiah Peschka &lt;
jeremiah.pesc...@gmail.com&gt; wrote:

&gt; Good news! You've found a bug in CorrugatedIron. Because of index naming,
&gt; we muck index names to have a suffix of \\_bin or \\_int, depending on the
&gt; index type. This shouldn't be happening on $key, but it is. I'll create a
&gt; github issue and get that taken care of.
&gt;
&gt; ---
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; MCITP: SQL Server 2008, MVP
&gt; Cloudera Certified Developer for Apache Hadoop
&gt;
&gt;
&gt; On Tue, Feb 12, 2013 at 7:56 AM, Kevin Burton wrote:
&gt;
&gt;&gt; I forgot to mention that when I execute this code I get the error:\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; {not\\_found,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {&lt;&lt;"products"&gt;&gt;,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; &lt;&lt;"$keys"&gt;&gt;},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; undefined}}}:[{mochijson2,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; json\\_encode,2,\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/mochijson2.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,149}]},\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; {mochijson2,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; '-json\\_encode\\_array/2-fun-0-',\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; 3,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/mochijson2.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,157}]},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {lists,foldl,3,\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt;
&gt;&gt; [{file,"lists.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,1197}]},\\*\\*
&gt;&gt; \\*\\*
&gt;&gt;
&gt;&gt; {mochijson2,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; json\\_encode\\_array,2,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/mochijson2.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,159}]},\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; {riak\\_kv\\_pb\\_mapred,
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; process\\_stream,3,
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/riak\\_kv\\_pb\\_mapred.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,97}]},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; {riak\\_api\\_pb\\_server,
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; process\\_stream,5,
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/riak\\_api\\_pb\\_server.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,227}]},\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt;
&gt;&gt; {riak\\_api\\_pb\\_server,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; handle\\_info,2,\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "src/riak\\_api\\_pb\\_server.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,158}]},\\*\\*\\*
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; {gen\\_server,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; handle\\_msg,5,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [{file,\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; "gen\\_server.erl"},\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {line,607}]}] -
&gt;&gt; CommunicationError\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; \\*From:\\* riak-users [mailto:riak-users-boun...@lists.basho.com] \\*On
&gt;&gt; Behalf Of \\*Kevin Burton
&gt;&gt; \\*Sent:\\* Tuesday, February 12, 2013 9:48 AM
&gt;&gt; \\*To:\\* 'Jeremiah Peschka'
&gt;&gt; \\*Cc:\\* 'riak-users'
&gt;&gt; \\*Subject:\\* RE: ListKeys or MapReduce\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; The name is “$keys”? Something like:\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; using (IRiakEndPoint cluster = RiakCluster.FromConfig(
&gt;&gt; "riakConfig"))\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; IRiakClient riakClient = cluster.CreateClient();\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; RiakBucketKeyInput bucketKeyInput = new
&gt;&gt; RiakBucketKeyInput();\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; bucketKeyInput.AddBucketKey(productBucketName, "$keys");\\*
&gt;&gt; \\*\\*\\*
&gt;&gt;
&gt;&gt; RiakMapReduceQuery query = new RiakMapReduceQuery()\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; .Inputs(bucketKeyInput)\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; .MapJs(m =&gt; m.Name("Riak.mapValuesJson").Keep(true));\\*
&gt;&gt; \\*\\*\\*
&gt;&gt;
&gt;&gt; RiakResult result =
&gt;&gt; riakClient.MapReduce(query);\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; if (result.IsSuccess)\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; {\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; \\*From:\\* Jeremiah Peschka 
&gt;&gt; [mailto:jeremiah.pesc...@gmail.com]
&gt;&gt;
&gt;&gt; \\*Sent:\\* Tuesday, February 12, 2013 9:18 AM
&gt;&gt; \\*To:\\* Kevin Burton
&gt;&gt; \\*Cc:\\* riak-users
&gt;&gt; \\*Subject:\\* Re: ListKeys or MapReduce\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; It would be queried like any other index as an MR input. I'll create an
&gt;&gt; issue and will try to get this in some time in the next few days - no
&gt;&gt; promises, though.\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; ---\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; MCITP: SQL Server 2008, MVP\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Cloudera Certified Developer for Apache Hadoop\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;&gt; On Tue, Feb 12, 2013 at 7:09 AM, Kevin Burton 
&gt;&gt; wrote:\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; I will read the other URLs that you mentioned. Thank you.\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Would you mind giving a short example (preferably using CI) of the $keys
&gt;&gt; index?\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*From:\\* Jeremiah Peschka [mailto:jeremiah.pesc...@gmail.com]
&gt;&gt; \\*Sent:\\* Tuesday, February 12, 2013 8:52 AM
&gt;&gt; \\*To:\\* Kevin Burton
&gt;&gt; \\*Cc:\\* riak-users
&gt;&gt; \\*Subject:\\* Re: ListKeys or MapReduce\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; They're both pretty crappy in terms of performance - they read all data
&gt;&gt; off of disk. If you're using LevelDB you can use the $keys index to pull
&gt;&gt; back just the keys that in a single bucket.\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; A better approach is to maintain a separate bucket - e.g. DocumentCount -
&gt;&gt; that is used for counting documents. Unfortunately, you can't guarantee
&gt;&gt; transactional consistency around counts in Riak today, so you'll want to
&gt;&gt; move maintaining the counts out of Riak and into something else. If you
&gt;&gt; search the list archives [1], you'll find that Redis has been mentioned as
&gt;&gt; a good way to solve this problem - counters are stored in Redis and flushed
&gt;&gt; to Riak on a regular schedule. Because of the lack of consistency
&gt;&gt; (especially around MapReduce operations), Riak isn't the best choice if you
&gt;&gt; require counters/aggregations to be stored in the database.\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Once CRDTs [2] make it into mainstream Riak, you can make use of those
&gt;&gt; data structures to implement distributed counters in Riak.\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [1]: http://riak.markmail.org\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; [2]: http://vimeo.com/52414903\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; ---\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; MCITP: SQL Server 2008, MVP\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Cloudera Certified Developer for Apache Hadoop\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; On Mon, Feb 11, 2013 at 10:30 AM,  wrote:\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; Say I need to determine how many document there are in my database. For a
&gt;&gt; CorrugatedIron application I can do ListKeys and get the warning that it is
&gt;&gt; an expensive operation or I can do a MapReduce query. Which is the the
&gt;&gt; least expensive? Is there an option that I am missing?\\*\\*\\*\\*
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com\\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\*\\*\\*
&gt;&gt;
&gt;&gt; \\*\\* \\*\\*
&gt;&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

