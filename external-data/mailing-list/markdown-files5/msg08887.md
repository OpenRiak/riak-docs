---
title: "Re: Riak performance problems when LevelDB database grows beyond 16GB"
description: ""
project: community
lastmod: 2012-10-11T13:37:10-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08887"
mailinglist_parent_id: "msg08881"
author_name: "Evan Vigil-McClanahan"
project_section: "mailinglistitem"
sent_date: 2012-10-11T13:37:10-07:00
---


Can you attach the eleveldb portion of your app.config file?
Configuration problems, especially max\\_open\\_files being too low, can
often cause issues like this.

If it isn't sensitive, the whole app.config and vm.args files are also
often helpful.

On Thu, Oct 11, 2012 at 9:12 AM,  wrote:
&gt; Hello,
&gt;
&gt; I am writing a new application and I am testing it on a cluster with 4 Riak
&gt; nodes (16 GM RAM, 2 x i3 3.4GHz - 2 cores).
&gt;
&gt; The application is tested with the expected load of 1000 requests/second,
&gt; 90% of the requests cause a Riak read and write of a new key. The problem
&gt; is that the performance starts falling after 18-20 hours and one of the Riak
&gt; nodes stops responding after 23-25 hours.
&gt;
&gt; (Key is cca 61 bytes long, data is just 3 timestamps converted to binary,
&gt; and there is a secondary key containing an expiration time. There should be
&gt; a mapred job to delete keys older than 24 hours, but it is turned off while
&gt; researching the performance problem.)
&gt;
&gt; Logs on the other nodes show that the problematic node cannot be contacted:
&gt;
&gt; 2012-10-11 11:33:57.473 [error] &lt;0.908.0&gt; \\*\\* Node 'riak@172.16.0.2' not
&gt; responding \\*\\*
&gt; \\*\\* Removing (timedout) connection \\*\\*
&gt;
&gt; The problematic node itself does not respond to "/usr/sbin/riak ping", but
&gt; beam.smp is running and ALIVE messages are written regularly to the erlang
&gt; log. There is nothing suspicious in logs on the node, its error log is
&gt; empty.
&gt;
&gt; The beam.smp consumes 20% memory and 50-100% of 1 CPU (the other 3 CPUs sit
&gt; idle), and the process has 267 open LevelDB files.
&gt;
&gt; The database sizes are:
&gt;
&gt; node1: 16249M, 281 files in 21 dirs (with 4 additional files like
&gt; /home/riak/leveldb/0/lost/BLOCKS.bad); this is the problematic node
&gt; node2: 16183M, 264 files in 16 dirs
&gt; node3: 16664M, 264 files in 16 dirs
&gt; node4: 16205M, 265 files in 16 dirs
&gt;
&gt; I tried to attach to the beam.smp process with Erlang, but it does not
&gt; respond to net\\_adm:ping/1.
&gt;
&gt; I attached gdb to the process, and gdb shows that most of its 93 threads are
&gt; idle (in ethr\\_event\\_wait), but 2 threads are in LevelDB code:
&gt;
&gt; Thread 24 (Thread 0x7f1a8ecc0700 (LWP 3912)):
&gt; #0 0x00007f1a91f74d84 in pthread\\_cond\\_wait@@GLIBC\\_2.3.2 () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #1 0x00007f1a0ee0ae9d in leveldb::port::CondVar::Wait() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #2 0x00007f1a0ede3841 in leveldb::DBImpl::MakeRoomForWrite(bool) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ede91ad in leveldb::DBImpl::Write(leveldb::WriteOptions
&gt; const&, leveldb::WriteBatch\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0eddeca4 in eleveldb\\_write () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x0000000000534c16 in process\\_main ()
&gt; #6 0x00000000004987e3 in ?? ()
&gt; #7 0x0000000000595320 in ?? ()
&gt; #8 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #9 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #10 0x0000000000000000 in ?? ()
&gt;
&gt; Thread 20 (Thread 0x7f19fc727700 (LWP 3967)):
&gt; #0 0x00007f1a0ee05a67 in leveldb::crc32c::Extend(unsigned int, char const\\*,
&gt; unsigned long) () from /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #1 0x00007f1a0ee012b9 in
&gt; leveldb::TableBuilder::WriteRawBlock(leveldb::Slice const&,
&gt; leveldb::CompressionType, leveldb::BlockHandle\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #2 0x00007f1a0ee01444 in
&gt; leveldb::TableBuilder::WriteBlock(leveldb::BlockBuilder\\*,
&gt; leveldb::BlockHandle\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ee015e4 in leveldb::TableBuilder::Flush() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0ee0178b in leveldb::TableBuilder::Add(leveldb::Slice const&,
&gt; leveldb::Slice const&) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x00007f1a0ede7cad in
&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #6 0x00007f1a0ede8456 in leveldb::DBImpl::BackgroundCompaction() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #7 0x00007f1a0ede9038 in leveldb::DBImpl::BackgroundCall() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #8 0x00007f1a0ee06c1e in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #9 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #10 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #11 0x0000000000000000 in ?? ()
&gt;
&gt; When I looked at thread 20 in the process again, the stack has shown some
&gt; Snappy compressions, and many later inspections have shown call to
&gt; fdatasync(2),
&gt; which was replaced by some more compaction work. Thread 24 still sits in
&gt; leveldb::DBImpl::MakeRoomForWrite.
&gt;
&gt; Thread 20 samples:
&gt; #0 0x00007f1a0ee0ed6d in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #1 0x00007f1a0ee0edb3 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #2 0x00007f1a0ee0f9dc in snappy::internal::CompressFragment(char const\\*,
&gt; unsigned long, char\\*, unsigned short\\*, int) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ee10dc1 in snappy::Compress(snappy::Source\\*, snappy::Sink\\*)
&gt; () from /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0ee1115a in snappy::RawCompress(char const\\*, unsigned long,
&gt; char\\*, unsigned long\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x00007f1a0ee014eb in
&gt; leveldb::TableBuilder::WriteBlock(leveldb::BlockBuilder\\*,
&gt; leveldb::BlockHandle\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #6 0x00007f1a0ee015e4 in leveldb::TableBuilder::Flush() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #7 0x00007f1a0ee0178b in leveldb::TableBuilder::Add(leveldb::Slice const&,
&gt; leveldb::Slice const&) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #8 0x00007f1a0ede7cad in
&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #9 0x00007f1a0ede8456 in leveldb::DBImpl::BackgroundCompaction() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #10 0x00007f1a0ede9038 in leveldb::DBImpl::BackgroundCall() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #11 0x00007f1a0ee06c1e in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #12 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #13 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #14 0x0000000000000000 in ?? ()
&gt;
&gt; #0 0x00007f1a91a8fa5d in fdatasync () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #1 0x00007f1a0ee08d64 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #2 0x00007f1a0ede3357 in
&gt; leveldb::DBImpl::FinishCompactionOutputFile(leveldb::DBImpl::CompactionState\\*,
&gt; leveldb::Iterator\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ede7e6e in
&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0ede8456 in leveldb::DBImpl::BackgroundCompaction() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x00007f1a0ede9038 in leveldb::DBImpl::BackgroundCall() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #6 0x00007f1a0ee06c1e in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #7 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #8 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #9 0x0000000000000000 in ?? ()
&gt;
&gt; #0 0x00007f1a0ee05765 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #1 0x00007f1a0ee0b6da in
&gt; leveldb::InternalKeyComparator::Compare(leveldb::Slice const&,
&gt; leveldb::Slice const&) const () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #2 0x00007f1a0ee00218 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ee006aa in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0ede7ccd in
&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x00007f1a0ede8456 in leveldb::DBImpl::BackgroundCompaction() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #6 0x00007f1a0ede9038 in leveldb::DBImpl::BackgroundCall() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #7 0x00007f1a0ee06c1e in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #8 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #9 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #10 0x0000000000000000 in ?? ()
&gt;
&gt; #0 0x00007f1a0eb61dcb in std::string::\\_M\\_mutate(unsigned long, unsigned
&gt; long, unsigned long) () from /usr/lib/x86\\_64-linux-gnu/libstdc++.so.6
&gt; #1 0x00007f1a0eb61e1c in std::string::\\_M\\_replace\\_safe(unsigned long,
&gt; unsigned long, char const\\*, unsigned long) () from
&gt; /usr/lib/x86\\_64-linux-gnu/libstdc++.so.6
&gt; #2 0x00007f1a0ee03559 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #3 0x00007f1a0ee037bd in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #4 0x00007f1a0ee00680 in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #5 0x00007f1a0ede7ccd in
&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\\*) () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #6 0x00007f1a0ede8456 in leveldb::DBImpl::BackgroundCompaction() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #7 0x00007f1a0ede9038 in leveldb::DBImpl::BackgroundCall() () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #8 0x00007f1a0ee06c1e in ?? () from
&gt; /usr/lib/riak/lib/eleveldb-1.2.2p5/priv/eleveldb.so
&gt; #9 0x00007f1a91f70e9a in start\\_thread () from
&gt; /lib/x86\\_64-linux-gnu/libpthread.so.0
&gt; #10 0x00007f1a91a964bd in clone () from /lib/x86\\_64-linux-gnu/libc.so.6
&gt; #11 0x0000000000000000 in ?? ()
&gt;
&gt; Software used:
&gt;
&gt; OS: Ubuntu 12.04 LTS, amd64
&gt; Riak: riak\\_1.2.1rc2, installed from the Basho-provided deb package
&gt; client accesses Riak via riak-erlang-client 1.2.1
&gt;
&gt; Any hints?
&gt;
&gt; Thanks, Jan
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

