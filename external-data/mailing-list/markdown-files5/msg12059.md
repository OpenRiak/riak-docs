---
title: "Re: Javascript MapReduce fails Erlang succeeds"
description: ""
project: community
lastmod: 2013-08-16T01:33:10-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12059"
mailinglist_parent_id: "msg12058"
author_name: "Christopher Meiklejohn"
project_section: "mailinglistitem"
sent_date: 2013-08-16T01:33:10-07:00
---


Hi Doug,

First, my apologies. I confused two email responses I was writing, and that's 
why my previous e-mail was a bit out of context.

I've loaded your backup file into a locally built cluster here off of the Riak 
1.2 branch, but I'm still unable to reproduce the issue using the following 
map/reduce command:

curl -XPOST http://localhost:8098/mapred -H 'Content-Type: application/json' -d 
'{"inputs":[ [ "aaaaaaaa-50d7-4536-9048-87ef2e48ddda", 
"key\\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71" ] ], 
"query":[{"map":{"language":"erlang","module":"riak\\_kv\\_mapreduce","function":"map\\_object\\_value"}}
 ] }'

Can you please provide which operating system, build, and package version of 
Riak you are running?

- Chris 

-- 
Christopher Meiklejohn
Software Engineer
Basho Technologies, Inc.



On Friday, August 16, 2013 at 1:23 AM, Christopher Meiklejohn wrote:

&gt; Hi Doug,
&gt; 
&gt; Can you provide more information as to how you build the image with Vagrant 
&gt; so I can try to reproduce it? The configuration alone isn't going to be 
&gt; enough as this appears to be a systems related issue.
&gt; 
&gt; - Chris 
&gt; 
&gt; -- 
&gt; Christopher Meiklejohn
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; 
&gt; 
&gt; 
&gt; On Friday, August 16, 2013 at 1:20 AM, Doug Read wrote:
&gt; 
&gt; &gt; Hi Chris,
&gt; &gt; 
&gt; &gt; I made a riak-admin backup of the key which reproduces the issue. I was 
&gt; &gt; wondering if you could give me some direction of how to debug the issue.
&gt; &gt; 
&gt; &gt; thanks
&gt; &gt; doug
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Thu, Aug 15, 2013 at 3:41 PM, Chris Meiklejohn  &gt; (mailto:cmeiklej...@basho.com)&gt; wrote:
&gt; &gt; &gt; The best guess I have at this point is probably something related to 
&gt; &gt; &gt; character encoding, but without a reproduction case, I'm not able to 
&gt; &gt; &gt; debug it any further.
&gt; &gt; &gt; 
&gt; &gt; &gt; Good luck with the upgrade tonight! 
&gt; &gt; &gt; 
&gt; &gt; &gt; - Chris
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; On Thu, Aug 15, 2013 at 3:39 PM, Doug Read  &gt; &gt; (mailto:doug.r...@qnary.com)&gt; wrote:
&gt; &gt; &gt; &gt; I redirected the output of curl into a file on an ubuntu box. I am 
&gt; &gt; &gt; &gt; upgrading the cluster to 1.4.1 tonight. To your point I PUT the value 
&gt; &gt; &gt; &gt; into the key locally (3 node cluster) and couldn't reproduce either. 
&gt; &gt; &gt; &gt; Also i am turning on the java vm logging. 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Thu, Aug 15, 2013 at 3:33 PM, Chris Meiklejohn 
&gt; &gt; &gt; &gt;  wrote:
&gt; &gt; &gt; &gt; &gt; Hi Doug,
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; I've configured a Riak 1.2 cluster, and run the aforementioned 
&gt; &gt; &gt; &gt; &gt; map-reduce job in Erlang and I can't trigger the crash. I'm getting 
&gt; &gt; &gt; &gt; &gt; the expected results of the map/reduce job. How did you send me the 
&gt; &gt; &gt; &gt; &gt; object that you provided off-list? 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; - Chris
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; On Thu, Aug 15, 2013 at 12:36 PM, Chris Meiklejohn 
&gt; &gt; &gt; &gt; &gt;  wrote:
&gt; &gt; &gt; &gt; &gt; &gt; Hi Doug,
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; Can you provide a sample of the JSON that you're storing in these 
&gt; &gt; &gt; &gt; &gt; &gt; objects? It appears that mochijson2's tokenizer is crashing because 
&gt; &gt; &gt; &gt; &gt; &gt; it thinks the JSON is not valid, where the Spidermonkey parsing is 
&gt; &gt; &gt; &gt; &gt; &gt; succeeding. 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; - Chris
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; On Wed, Aug 14, 2013 at 10:58 AM, Doug Read  &gt; &gt; &gt; &gt; &gt; (mailto:doug.r...@qnary.com)&gt; wrote:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; The following MapReduce job fails using javascript but succeeds 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; when using erlang. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Riak 1.2.0 2012-0806 Debian x86\\_64
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 3 nodes, n\\_val=3
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Riak diag gives large list of 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [warning] The following preflists do not satisfy the n\\_val:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Not really sure what this means but thought i would share. 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; JAVASCRIPT: 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; curl -XPOST http://localhost:8098/mapred -H 'Content-Type: 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; application/json' -d '{"inputs":[ [ 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "aaaaaaaa-4536-9048-87ef2e48ddda", 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "key\\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71" ] ], "query":[ { 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "map": { "name": "Riak.mapValuesJson", "language": "javascript" } 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; }, { "reduce": { "name": "Riak.filterNotFound", "language": 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "javascript" } } ] }'
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; JAVASCRIPT RESULT:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; {"phase":0,"error":"{{{badmatch,any},[{js\\_mochijson2,tokenize,2,[{file,\\"src/js\\_mochijson2.erl\\"},{line,507}]},{js\\_mochijson2,decode1,2,[{file,\\"src/js\\_mochijson2.erl\\"},{line,277}]},{js\\_mochijson2,json\\_decode,2,[{file,\\"src/js\\_mochijson2.erl\\"},{line,272}]},{js\\_driver,eval\\_js,3,[{file,\\"src/js\\_driver.erl\\"},{line,150}]},{riak\\_kv\\_js\\_vm,invoke\\_js,3,[{file,\\"src/riak\\_kv\\_js\\_vm.erl\\"},{line,275}]},{riak\\_kv\\_js\\_vm,handle\\_call,3,[{file,\\"src/riak\\_kv\\_js\\_vm.erl\\"},{line,144}]},{gen\\_server,handle\\_msg,5,[{file,\\"gen\\_server.erl\\"},{line,...}]},...]},...}","input":"{ok,{r\\_object,&lt;&lt;\\"aaaaaaaa-50d7-4536-9048-87ef2e48ddda\\"&gt;&gt;,&lt;&lt;\\"key\\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71\\"&gt;&gt;,[{r\\_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[&lt;&lt;\\"Links\\"&gt;&gt;]],[],[],[],[],[],[],[],[[&lt;&lt;\\"content-type\\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\\"X-Riak-VTag\\"&gt;&gt;,54,69,114,82,65,97,76,65,65,73,82,102,48,73,102,104,114,102,102,112,103,109]],[[&lt;
&lt;\\
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; 
&gt; 
&gt; 
&gt; "index\\"&gt;&gt;]],[],[[&lt;&lt;\\"X-Riak-Last-Modified\\"&gt;&gt;|{1375,51580,339577}]],[],[[&lt;&lt;...&gt;&gt;]]}}},...}],...},...}","type":"exit","stack":"[{gen\\_server,call,3,[{file,\\"gen\\_server.erl\\"},{line,188}]},{riak\\_kv\\_mrc\\_map,map\\_js,3,[{file,\\"src/riak\\_kv\\_mrc\\_map.erl\\"},{line,192}]},{riak\\_kv\\_mrc\\_map,process,3,[{file,\\"src/riak\\_kv\\_mrc\\_map.erl\\"},{line,140}]},{riak\\_pipe\\_vnode\\_worker,process\\_input,3,[{file,\\"src/riak\\_pipe\\_vnode\\_worker.erl\\"},{line,445}]},{riak\\_pipe\\_vnode\\_worker,wait\\_for\\_input,2,[{file,\\"src/riak\\_pipe\\_vnode\\_worker.erl\\"},{line,377}]},{gen\\_fsm,handle\\_msg,7,[{file,\\"gen\\_fsm.erl\\"},{line,494}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,\\"proc\\_lib...\\"},...]}]"}
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ERLANG:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; curl -XPOST http://localhost:8098/mapred -H 'Content-Type: 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; application/json' -d '{"inputs":[ [ 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "aaaaaaaa-50d7-4536-9048-87ef2e48ddda", 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "key\\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71" ] ], 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; "query":[{"map":{"language":"erlang","module":"riak\\_kv\\_mapreduce","function":"map\\_object\\_value"}}
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ] }' 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ERLANG RESULT:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [{"key":"value"}]
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Any ideas? 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; &gt; &gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; &gt; &gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Attachments: 
&gt; &gt; - bad.bak
&gt; 




\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

