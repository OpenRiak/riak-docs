---
title: "get failures on consistent buckets"
description: ""
project: community
lastmod: 2015-07-16T04:30:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16298"
author_name: "Gregg Siegfried"
project_section: "mailinglistitem"
sent_date: 2015-07-16T04:30:08-07:00
---



Hi, all.

We are in the testing phase of an application subsystem that uses Riak
2.1.1 and a bucket type with consistency on and n=5 (per Basho docs).

Client side is .net using the Basho .net client.

As the testing volume has risen, we are encountering get failures that
seem to have a communication-related flavor.

Things like: ³CommunicationError: Unable to read data from the transport
connection: A connection attempt failed because the connected party did
not properly respond after a period of time, or established connection
failed because connected host has failed to respond² Or
³CommunicationError: Riak returned an error. Code Œ0¹. Message timeout² or
even ³ClusterOffline: unable to access functioning Riak node².

The cluster itself is 5 nodes, 2.1.1, centos 6, front ended with haproxy.
The HA proxy stats with respect to retries, redispatch, errors, warning
are completely clean.
There are actually 2 haproxy nodes polling the riak nodes, set up with a
keepalived (HSRP) VIP, but there have been no failovers.

The only things in any of my ³crash² logs are:

2015-07-16 01:13:59 =CRASH REPORT====
 crasher:
 initial call: mochiweb\\_acceptor:init/3
 pid: &lt;0.4628.6768&gt;
 registered\\_name: []
 exception error:
{function\\_clause,[{webmachine\\_request,peer\\_from\\_peername,[{error,enotconn},
{webmachine\\_request,{wm\\_reqstate,#Port&lt;0.12171987&gt;,[],undefined,undefined,u
ndefined,{wm\\_reqdata,'GET',http,{1,0},"defined\\_in\\_wm\\_req\\_srv\\_init","defined
\\_in\\_wm\\_req\\_srv\\_init",defined\\_on\\_call,defined\\_in\\_load\\_dispatch\\_data,"/ping",
"/ping",[],defined\\_in\\_load\\_dispatch\\_data,"defined\\_in\\_load\\_dispatch\\_data",50
0,1073741824,67108864,[],[],{0,nil},not\\_fetched\\_yet,false,{0,nil},&lt;&lt;&gt;&gt;,foll
ow\\_request,undefined,undefined,[]},undefined,undefined,undefined}}],[{file,
"src/webmachine\\_request.erl"},{line,150}]},{webmachine\\_request,get\\_peer,1,[
{file,"src/webmachine\\_request.erl"},{line,124}]},{webmachine,new\\_request,2,
[{file,"src/webmachine.erl"},{line,69}]},{webmachine\\_mochiweb,loop,2,[{file
,"src/webmachine\\_mochiweb.erl"},{line,49}]},{mochiweb\\_http,headers,5,[{file
,"src/mochiweb\\_http.erl"},{line,96}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"p
roc\\_lib.erl"},{line,239}]}]}
 ancestors: ['http://0.0.0.0:8098\\_mochiweb',riak\\_api\\_sup,&lt;0.368.0&gt;]
 messages: []
 links: [&lt;0.374.0&gt;,#Port&lt;0.12171987&gt;]
 dictionary: []
 trap\\_exit: false
 status: running
 heap\\_size: 987
 stack\\_size: 27
 reductions: 1249
 neighbours:


And there are a number of these, over time, but all of the application
interaction with the cluster is via PB, not rest.

The client side is running inside an ASP.net application pool via IIS 7.5.
 All of the windows machines have had the TCP parameters around
TimedWaitDelay and MaxUserPort changed (30 or 60 and 65534 respectively)
to support the connection rate that the .net client generates.

Prior to going to consistent buckets, we did not see these.

We¹ve implemented Put retry logic in order to work around similar,
transient failures on the write side, which are more understandable due to
the way the consistency subsystem operates. We were not expecting to have
to implement this type of retry on the get-side.

Any recommendations from the group as to how to start unraveling this one?
 A number of the status-related riak-admin commands do not function once
consistency has been used, which has limited my ability to peer too
closely into the nodes themselves.

The volume here is likely trivial compared to most of the use cases I¹m
reading about, but the data model is relatively complex, and the traffic
rate and object sizes quite variable.

Thank you for any insight.
Gregg Siegfried
Language Logic, LLC


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

