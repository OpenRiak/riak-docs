---
title: "Re: riak-cs reclaim storage"
description: ""
project: community
lastmod: 2014-06-09T18:15:06-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14306"
mailinglist_parent_id: "msg14305"
author_name: "Hector Castro"
project_section: "mailinglistitem"
sent_date: 2014-06-09T18:15:06-07:00
---


This mailing list entry was discussed a bit in IRC today. Below are a few notes 
from the exchange between Tyler and our very own Joe Caswell. Hopefully they 
help provide some insight into Riak CS GC for others:

- Riak CS data blocks are stored in Bitcask.

- `riak-admin vnode-status` outputs several important Bitcask details: 
fragmentation percentage, dead bytes, and total size for each Bitcask file.

- If the dead bytes portion of `riak-admin node-status` doesn’t account for the 
amount of storage you expect to reclaim, Riak CS GC may not have happened yet.

- As an example:

{"/var/lib/riak/bitcask/0/3054.bitcask.data",4,91282721,2147205296},

This snippet shows a 2GB file (3054.bitcask.data) that is 4% fragmented and has 
90MB of dead bytes that could be removed via a merge.

- Bitcask’s default `frag\\_merge\\_trigger` is 60% and `dead\\_bytes\\_merge\\_trigger` 
is 512MB.

- The merge triggering process in Riak is called very 3 minutes. If any 
triggers are met, the merge is added to a queue. A single merge worker pulls 
from that queue per node (merge triggers occur per vnode).

- Adding `{log\\_needs\\_merge, true}` to the Bitcask section produces a log entry 
whenever a trigger is met.

- If you want to reclaim space used by Riak CS faster, lower Bitcask’s default 
merge triggers and thresholds.

- For additional details around tuning Bitcask, see:

http://docs.basho.com/riak/latest/ops/advanced/backends/bitcask/#Configuring-Bitcask
http://docs.basho.com/riak/latest/ops/advanced/backends/bitcask/#Tuning-Bitcask 

-- 
Hector

On June 9, 2014 at 9:08:03 PM, Kota Uenishi (k...@basho.com) wrote:
&gt; Well, maybe you had deleted your objects when you set leeway\\_second
&gt; with 1 day, and later you changed leeway\\_second to 5min? Changing
&gt; leeway\\_second won't change deletion timing of already deleted objects.
&gt; 
&gt; FYI, maybe it's not what you want, but there's a detailed description
&gt; [1] on internal design and behaviour of garbage collection.
&gt; 
&gt; Of course Riak CS and Riak is not a black box, how Riak CS uses Riak
&gt; is open-sourced and not hidden. For developers and hard-core
&gt; operators, there's just very primitive tool to diagnose Riak CS by
&gt; hitting Riak directly. It is riak\\_cs\\_inspector, installed in
&gt; /usr/lib/riak-cs/lib/riak\\_cs-1.4.5/priv/tools/internal/riak\\_cs\\_inspector.erl 
&gt; . See [2] for detailed usage. It prints Riak CS internal data in
&gt; structured manner but it is still hard to find the answer "how many
&gt; objects to be deleted today?" .
&gt; 
&gt; I think your assumption is very natural, because there should be some
&gt; operational visibility tools like you said.
&gt; 
&gt; [1] 
&gt; https://github.com/basho/riak\\_cs/wiki/Object-Chunking-and-Garbage-Collection#garbage-collection
&gt; 
&gt; [2] https://gist.github.com/kuenishi/bf286cf28f16ebbf1256
&gt; 
&gt; On Tue, Jun 10, 2014 at 1:46 AM, Tyler Flint wrote:
&gt; &gt; Unfortunately, it doesn’t seem to have made a difference.
&gt; &gt;
&gt; &gt; I did restart the riak-cs process after updating the app.config. Triggering 
&gt; &gt; a riak-cs-gc 
&gt; batch did trigger a job, but did not seem to yield any results.
&gt; &gt;
&gt; &gt; I’m a bit concerned that I’m unable to root cause the issue here. Is there 
&gt; &gt; some sort of 
&gt; visibility tools that I’m overlooking? I would assume that I’d be able to 
&gt; query into riak-cs 
&gt; and find “x entries are ready to be garbage collected” or something to 
&gt; provide some visibility. 
&gt; I’m not even sure if the problem is within riak-cs or riak/bitcask.
&gt; &gt;
&gt; &gt; Are riak-cs and riak just black boxes? I can’t imagine this to be the case 
&gt; &gt; if people are 
&gt; using these solutions in production. Please tell me I’m just an idiot and not 
&gt; aware of 
&gt; some utility/configuration to make this work.
&gt; &gt;
&gt; &gt; Thanks
&gt; &gt;
&gt; &gt; On Jun 8, 2014, at 7:22 PM, Tyler Flint wrote:
&gt; &gt;
&gt; &gt;&gt; Yes it is riak 1.4.5
&gt; &gt;&gt;
&gt; &gt;&gt; Let me see if that helps.
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;&gt; On Jun 8, 2014, at 7:20 PM, Kota Uenishi wrote:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Spelling mistake, sorry:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; {gc\\_paginated\\_indexes, true},
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; On Mon, Jun 9, 2014 at 10:10 AM, Kota Uenishi wrote:
&gt; &gt;&gt;&gt;&gt; Hi,
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Are you using 1.4.5? I'm not sure but you may have a log message like 
&gt; &gt;&gt;&gt;&gt; this:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; "Error occurred trying to query from time 0 to ~p in gc key index. 
&gt; &gt;&gt;&gt;&gt; Reason: ~p"
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; in console.log. If so, it's even failing not only GC but in listing
&gt; &gt;&gt;&gt;&gt; objects to be collected. Then setting a line
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; {gc\\_pagenated\\_indexes, true},
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; into riak\\_cs section of your app.config . This is implicit option and
&gt; &gt;&gt;&gt;&gt; its default is false.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; On Fri, Jun 6, 2014 at 11:52 PM, Tyler Flint wrote:
&gt; &gt;&gt;&gt;&gt;&gt; Thank you in advance for any assistance.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; To explore riak-cs, I setup a 2 node cluster with riak and riak-cs on 
&gt; &gt;&gt;&gt;&gt;&gt; each node, and 
&gt; put the riak nodes on the same cluster. I then proceeded to use risk-cs by 
&gt; uploading a 3G 
&gt; file using the multi-part upload protocol. I was unaware, however, that I 
&gt; needed to finalize 
&gt; the multipart upload and thus had many in progress multi-part uploads. 
&gt; Through the duration 
&gt; of my troubleshooting, the storage on the filesystem grew to 224G. Once I 
&gt; discovered 
&gt; my error, I proceeded to cancel all of the previous uploads. At this point 
&gt; there are no 
&gt; uploads in progress, and only a single 3G file available in the bucket. 
&gt; However, it has 
&gt; been 48 hours since the exploration and the storage use is still 224G on both 
&gt; machines. 
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; I have attempted multiple strategies in attempt to reclaim space, all 
&gt; &gt;&gt;&gt;&gt;&gt; without 
&gt; any effect.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Within riak-cs:
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; - I have shortened the gc leeway duration to 5 minutes and set all of 
&gt; &gt;&gt;&gt;&gt;&gt; the gc intervals 
&gt; as low as 5 minutes.
&gt; &gt;&gt;&gt;&gt;&gt; - I have manually triggered the riak-cs-gc batch multiple times. (After 
&gt; &gt;&gt;&gt;&gt;&gt; running 
&gt; batch, status shows a gc run and eventually complete)
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Within riak:
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; - I have adjusted the bitcask settings in attempt to trigger a merge.
&gt; &gt;&gt;&gt;&gt;&gt; - I have force merged all of the bitcask partitions manually in the 
&gt; &gt;&gt;&gt;&gt;&gt; erlang console. 
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; None of these strategies seem to have any effect whatsoever.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; At this point I’m not even sure where to start, nor do I know if the 
&gt; &gt;&gt;&gt;&gt;&gt; issue is within 
&gt; riak-cs or riak (via bitcask). Any suggestions would be appreciated.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Thanks
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Tyler
&gt; &gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; --
&gt; &gt;&gt;&gt;&gt; Kota UENISHI / @kuenishi
&gt; &gt;&gt;&gt;&gt; Basho Japan KK
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; --
&gt; &gt;&gt;&gt; Kota UENISHI / @kuenishi
&gt; &gt;&gt;&gt; Basho Japan KK
&gt; &gt;
&gt; 
&gt; 
&gt; 
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

