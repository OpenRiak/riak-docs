---
title: "Re: Object not found after successful PUT on S3 API"
description: ""
project: community
lastmod: 2017-03-10T09:17:44-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18084"
mailinglist_parent_id: "msg18065"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2017-03-10T09:17:44-08:00
---


Just to clarify ...

What Alexander is suggesting is what Daniel is currently using, and
what I suspect may be causing Daniel's issues.

If you wish to run a leveldb-only Riak CS cluster, you still \\*must\\*
use the advanced.config file and the riak\\_cs\\_kv\\_multi\\_backend, and the
other settings that I mention in my response and in the docs. Notice
the multi\\_backend\\_prefix\\_list setting, for one thing.

Daniel -

The storage\\_backend setting in advanced.config will \\*override\\*
storage\\_backend in riak.conf. If you wish to ensure the riak.conf
setting is overridden, you may comment it out in that file.

--
Luke Bakken
Engineer
lbak...@basho.com

On Fri, Mar 10, 2017 at 9:08 AM, Alexander Sicular  wrote:
&gt;
&gt; Hi Daniel,
&gt;
&gt; Riak CS uses multi by default. By default the manifests are stored in leveldb 
&gt; and the blobs/chunks are stored in bitcask. If you're looking to force 
&gt; everything to level you should remove multi and use level as the backend 
&gt; setting. As Luke noted elsewhere, this configuration hasn't been fully tested 
&gt; and is not supported.
&gt;
&gt; Off the top of my head, take a look at the email Martin (?) sent about his 
&gt; modified level backend a few weeks ago for reasons why using level for data 
&gt; chunks may not be the best idea at this time.
&gt;
&gt; Thanks,
&gt; Alexander
&gt;
&gt; @siculars
&gt; http://siculars.posthaven.com
&gt;
&gt; Sent from my iRotaryPhone
&gt;
&gt; On Mar 10, 2017, at 10:50, Daniel Miller  wrote:
&gt;
&gt; Hi Luke,
&gt;
&gt; Again, thanks for your help. We are currently preparing to move all objects 
&gt; into a new cluster using the S3 API. One question on configuration: currently 
&gt; I have "storage\\_backend = leveldb" in my riak.conf. I assume that on the new 
&gt; cluster, in addition to using the advanced.config you provided, I also need 
&gt; to set "storage\\_backend = multi" in riak.conf â€“ is that correct?
&gt;
&gt; Referring back to the subject of this thread for a bit, I'm assuming your 
&gt; current theory for why the (most recent) object went missing is because we 
&gt; have a bad backend configuration. Note that that object went missing weeks 
&gt; after it was originally written into riak, and it was successfully retrieved 
&gt; many times before it went missing. Is there a way I can query riak to verify 
&gt; your theory that the manifest was overwritten? Russel Brown suggested: "I 
&gt; wonder if you can get the manifest and then see if any/all of the chunks are 
&gt; present?" Would that help to answer the question about why the object went 
&gt; missing? Can you provide any hints on how to do that?
&gt;
&gt; While bad configuration may be the cause of this most recent object going 
&gt; missing, it does not explain the original two objects that went missing 
&gt; immediately after they were PUT. Those original incidents happened when our 
&gt; cluster was still using bitcask/mutli backend, so should not have been 
&gt; affected by bad configuration.
&gt;
&gt; ~ Daniel
&gt;
&gt; On Tue, Mar 7, 2017 at 3:58 PM, Luke Bakken  wrote:
&gt;&gt;
&gt;&gt; Hi Daniel,
&gt;&gt;
&gt;&gt; Thanks for providing all of that information.
&gt;&gt;
&gt;&gt; You are missing important configuration for riak\\_kv that can only be 
&gt;&gt; provided in an /etc/riak/advanced.config file. Please see the following 
&gt;&gt; document, especially the section to which I link here:
&gt;&gt;
&gt;&gt; http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/riak-for-cs/#setting-up-the-proper-riak-backend
&gt;&gt;
&gt;&gt; [
&gt;&gt; {riak\\_kv, [
&gt;&gt; % NOTE: double-check this path for your environment:
&gt;&gt; {add\\_paths, ["/usr/lib/riak-cs/lib/riak\\_cs-2.1.1/ebin"]},
&gt;&gt; {storage\\_backend, riak\\_cs\\_kv\\_multi\\_backend},
&gt;&gt; {multi\\_backend\\_prefix\\_list, [{&lt;&lt;"0b:"&gt;&gt;, be\\_blocks}]},
&gt;&gt; {multi\\_backend\\_default, be\\_default},
&gt;&gt; {multi\\_backend, [
&gt;&gt; {be\\_default, riak\\_kv\\_eleveldb\\_backend, [
&gt;&gt; {data\\_root, "/opt/data/ecryptfs/riak"}
&gt;&gt; ]},
&gt;&gt; {be\\_blocks, riak\\_kv\\_eleveldb\\_backend, [
&gt;&gt; {data\\_root, "/opt/data/ecryptfs/riak\\_blocks"}
&gt;&gt; ]}
&gt;&gt; ]}
&gt;&gt; ]}
&gt;&gt; ].
&gt;&gt;
&gt;&gt; Your configuration will look like the above. The contents of this file are 
&gt;&gt; merged with the contents of /etc/riak/riak.conf to produce the configuration 
&gt;&gt; that Riak uses.
&gt;&gt;
&gt;&gt; Notice that I chose riak\\_kv\\_eleveldb\\_backend twice because of the discussion 
&gt;&gt; you had previously about RAM usage and bitcask 
&gt;&gt; (http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2016-November/018801.html)
&gt;&gt;
&gt;&gt; In your current configuration, you are not using the expected prefix for the 
&gt;&gt; block data. My guess is that on very rare occasions your data happens to 
&gt;&gt; overwrite the manifest for a file. You may also have corrupted files at this 
&gt;&gt; point without noticing it at all.
&gt;&gt;
&gt;&gt; IMPORTANT: you can't switch from your current configuration to this new one 
&gt;&gt; without re-saving all of your data.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; Engineer
&gt;&gt; lbak...@basho.com
&gt;&gt;
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; Engineer
&gt;&gt; lbak...@basho.com
&gt;&gt;
&gt;&gt; On Tue, Mar 7, 2017 at 6:47 AM, Daniel Miller  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Responses inline.
&gt;&gt;&gt;
&gt;&gt;&gt; On Mon, Mar 6, 2017 at 3:04 PM, Luke Bakken  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi Daniel,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Two questions:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\* Do you happen to have an /etc/riak/app.config file present?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; No.
&gt;&gt;&gt;
&gt;&gt;&gt; Not sure if relevant, but I did notice that /etc/riak-cs/advanced.config 
&gt;&gt;&gt; does exist, which contradicts with what I said earlier. This is surprising 
&gt;&gt;&gt; to me because I did not create this file. Maybe it was created by the riak 
&gt;&gt;&gt; installer? Anyway, the content is:
&gt;&gt;&gt;
&gt;&gt;&gt; $ cat /etc/riak-cs/advanced.config
&gt;&gt;&gt; [
&gt;&gt;&gt; {riak\\_cs,
&gt;&gt;&gt; [
&gt;&gt;&gt; ]}
&gt;&gt;&gt; ].
&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\* On one of your Riak nodes, could you please execute the following 
&gt;&gt;&gt;&gt; commands:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; riak attach
&gt;&gt;&gt;&gt; rp(application:get\\_all\\_env(riak\\_kv)).
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Copy the output of the previous command and attach as a separate file
&gt;&gt;&gt;&gt; to your response. Please note that the period is significant. Use
&gt;&gt;&gt;&gt; CTRL-C CTRL-C to exit the "riak attach" session.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Attached.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

