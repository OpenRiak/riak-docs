---
title: "Re: Pre-commit hook debug"
description: ""
project: community
lastmod: 2015-12-01T11:48:02-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16839"
mailinglist_parent_id: "msg16838"
author_name: "Geoff Simonds"
project_section: "mailinglistitem"
sent_date: 2015-12-01T11:48:02-08:00
---


I will change the hook to use riak\\_object and give it a try.

Thanks Jon!

Geoff

On Tue, Dec 1, 2015 at 2:20 PM Jon Meredith  wrote:

&gt; Hi Geoff,
&gt;
&gt; Looks like the WM endpoint isn't handling that crash well.
&gt;
&gt; As for your precommit hook, the hook runs inside the server context so
&gt; you'll need to use the riak\\_object module instead. riakc\\_obj is a cut-down
&gt; version for use in the Erlang client.
&gt;
&gt; Jon
&gt;
&gt; On Tue, Dec 1, 2015 at 11:53 AM Geoff Simonds 
&gt; wrote:
&gt;
&gt;&gt; Good afternoon,
&gt;&gt;
&gt;&gt; I am writing to ask for some help regarding a pre-commit hook in Riak
&gt;&gt; 2.1.1. I am locally running a 5 node Riak dev cluster (
&gt;&gt; https://github.com/xing/riak-dev-cluster) on a Mac and am having trouble
&gt;&gt; with a pre-commit hook. I have added the "add\\_paths" to my advanced.config:
&gt;&gt; [
&gt;&gt; Riak KV config
&gt;&gt; {riak\\_kv,
&gt;&gt; [
&gt;&gt; %% Paths to custom erlang modules.
&gt;&gt; {add\\_paths, ["/tmp/ls/custom\\_modules"]}
&gt;&gt; ]}
&gt;&gt; ].
&gt;&gt;
&gt;&gt; and then copied the compiled beam to this directory. I then issued a
&gt;&gt; curl PUT to add the pre-commit to the bucket props:
&gt;&gt;
&gt;&gt; curl -XPUT -H "Content-Type: application/json" -d
&gt;&gt; '{"props":{"precommit":[{"mod":"rr\\_pre\\_commit","fun":"set\\_process\\_datetime\\_index"}]}}'
&gt;&gt; http://127.0.0.1:11098/buckets/LS\\~News/props
&gt;&gt;
&gt;&gt; and am able to confirm it worked when I do a GET on the bucket
&gt;&gt; properties. The bucket already had a single key stored in it and when I do
&gt;&gt; another PUT on that object (hoping to get the pre-commit to fire), I get
&gt;&gt; the following error:
&gt;&gt;
&gt;&gt; {error,badarg,
&gt;&gt; [{erlang,iolist\\_to\\_binary,
&gt;&gt; [{hook\\_crashed,
&gt;&gt; {rr\\_pre\\_commit,set\\_process\\_datetime\\_index,error,
&gt;&gt; function\\_clause}}],
&gt;&gt; []},
&gt;&gt; {wrq,append\\_to\\_response\\_body,2,[{file,"src/wrq.erl"},{line,215}]},
&gt;&gt; {riak\\_kv\\_wm\\_object,handle\\_common\\_error,3,
&gt;&gt; [{file,"src/riak\\_kv\\_wm\\_object.erl"},{line,1178}]},
&gt;&gt; {webmachine\\_resource,resource\\_call,3,
&gt;&gt; [{file,"src/webmachine\\_resource.erl"},{line,186}]},
&gt;&gt; {webmachine\\_resource,do,3,
&gt;&gt; [{file,"src/webmachine\\_resource.erl"},{line,142}]},
&gt;&gt; {webmachine\\_decision\\_core,resource\\_call,1,
&gt;&gt; [{file,"src/webmachine\\_decision\\_core.erl"},{line,48}]},
&gt;&gt; {webmachine\\_decision\\_core,accept\\_helper,1,
&gt;&gt; [{file,"src/webmachine\\_decision\\_core.erl"},{line,616}]},
&gt;&gt; {webmachine\\_decision\\_core,decision,1,
&gt;&gt; [{file,"src/webmachine\\_decision\\_core.erl"},{line,521}]}]}}
&gt;&gt;
&gt;&gt;
&gt;&gt; I am able to run the pre-commit function when I attach to the Riak shell and 
&gt;&gt; add the paths manually (code:add\\_patha) but not when it triggers via a PUT. 
&gt;&gt; Also, in my pre-commit hook module/function I am using the riak erlang 
&gt;&gt; client to access the object metadata. Is this module compiled into Riak or 
&gt;&gt; do I also need to add a path for this?
&gt;&gt;
&gt;&gt;
&gt;&gt; The pre-commit module/function is below:
&gt;&gt;
&gt;&gt;
&gt;&gt; set\\_process\\_datetime\\_index(Obj) -&gt;
&gt;&gt; case is\\_deleted(Obj) of
&gt;&gt; true -&gt;
&gt;&gt; Obj;
&gt;&gt; \\_ -&gt;
&gt;&gt; MD = riakc\\_obj:get\\_update\\_metadata(Obj),
&gt;&gt; case riakc\\_obj:get\\_user\\_metadata\\_entry(MD, 
&gt;&gt; &lt;&lt;"process\\_messagedate"&gt;&gt;) of
&gt;&gt; %% if user "process messagedate" metadata is not found
&gt;&gt; notfound -&gt;
&gt;&gt; %% add it
&gt;&gt; MD2 = 
&gt;&gt; riakc\\_obj:set\\_user\\_metadata\\_entry(MD,{&lt;&lt;"process\\_messagedate"&gt;&gt;,format\\_date\\_index(calendar:local\\_time())}),
&gt;&gt; %% and modify the message\\_date 2i index
&gt;&gt; MD3 = riakc\\_obj:set\\_secondary\\_index(MD2,{{binary\\_index, 
&gt;&gt; &lt;&lt;"messagedate"&gt;&gt;}, [format\\_date\\_index(calendar:local\\_time())]}),
&gt;&gt; riakc\\_obj:update\\_metadata(Obj,MD3);
&gt;&gt; \\_ -&gt;
&gt;&gt; %% otherwise, don't do anything as we have already stored the 
&gt;&gt; process time
&gt;&gt; Obj
&gt;&gt; end
&gt;&gt;
&gt;&gt; end.
&gt;&gt;
&gt;&gt; is\\_deleted(Obj)-&gt;
&gt;&gt; case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riakc\\_obj:get\\_metadata(Obj)) of
&gt;&gt; {ok,\\_} -&gt;
&gt;&gt; true;
&gt;&gt; \\_ -&gt;
&gt;&gt; false
&gt;&gt; end.
&gt;&gt;
&gt;&gt;
&gt;&gt; Any help or advice is appreciated.
&gt;&gt;
&gt;&gt;
&gt;&gt; Geoff
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

