---
title: "Re: Riak search 2 returning multiple stale results for single record"
description: ""
project: community
lastmod: 2016-02-15T12:29:29-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17024"
mailinglist_parent_id: "msg17023"
author_name: "Zeeshan Lakhani"
project_section: "mailinglistitem"
sent_date: 2016-02-15T12:29:29-08:00
---


Hello Peter,

The cleanup for delete, as a call to SOLR, occurs after the reap happens in the 
backend, depending on delete\\_mode of course. Did you notice any Solr errors in 
the logs related to “failed to index” or something similar? Maybe the delete 
request never hit the solr\\_core/search\\_index, and, therefore, has stayed around 
as a sibling. The logs would help there. Have you set delete\\_mode to something 
specific (i.e. 
http://docs.basho.com/riak/latest/ops/advanced/deletion/#Configuring-Object-Deletion
 
)?
 

I can tell you that the soon-to-be-released 2.0.7 and 2.2 releases fixes this 
with more aggressive tactics to handle deletes, especially around datatypes (I 
see that you’re using maps), instead of waiting for the call after the backend 
reap/removal. 

Looking at previous threads, your W quorum value can also matter - 
http://riak-users.197444.n3.nabble.com/Deleted-keys-come-back-td4033536.html#a4033576
 
.
 

For you current situation, an updated re-PUT for those with siblings would 
resolve them, or via an internal solr cleanup call, or through a reindexing 
process. If you want to find me on IRC, we can discuss a few others tools we 
have that may help you get most of the way there until the new release, 
depending on the questions I asked in the first paragraph.

Thanks.

Zeeshan Lakhani
programmer | 
software engineer at @basho

&gt; On Feb 15, 2016, at 5:33 AM, Peter Roberts  wrote:
&gt; 
&gt; We’re currently evaluating whether Riak is suitable for our system and have 
&gt; an issue with multiple/stale results being returned from Riak search. We’re 
&gt; reliably seeing this occur when a record is deleted and a new one created 
&gt; under the same key shortly afterwards – which, based on the \\_yz\\_id, causes 
&gt; siblings to be created. 
&gt; 
&gt; Accessing the record through the map datatype only gives us the expected 
&gt; record. We’ve considered de-duplicating the result by ID but this could 
&gt; still result in search results where the query matches the old but not the 
&gt; new data. The obsolete records in Riak search/Solr never get cleaned up. 
&gt; 
&gt; Is this a known issue? Are we missing something on inserting/querying the 
&gt; data? Is it possible to tie the version of data in the Riak search result to 
&gt; the version retrieved from Riak by key?
&gt; 
&gt; Below is an example of the Riak search query/result (using Node 
&gt; basho-riak-client) and datatype data. The date.value is set to the 
&gt; creation/update time. 
&gt; 
&gt; var searchOptions = {
&gt; indexName: 'minimals\\_index',
&gt; q: 'name\\_register:foo',
&gt; presort: ‘score'
&gt; }
&gt; 
&gt; riakClient.search(searchOptions, function(err, result) {
&gt; console.log('Search result', err, result);
&gt; callback(err, result);
&gt; }
&gt; 
&gt; Results:
&gt; { numFound: 6,
&gt; maxScore: 0.35434481501579285,
&gt; docs: 
&gt; [ { score: 0.35434482,
&gt; \\_yz\\_rb: 'minimals',
&gt; \\_yz\\_rt: 'maps',
&gt; \\_yz\\_rk: 'test:foo',
&gt; \\_yz\\_id: '1\\*maps\\*minimals\\*test:foo\\*13\\*2EB6xtIHCicwmARKDJ81tS',
&gt; 'date\\_map.\\_type\\_register': '\\_date',
&gt; 'date\\_map.\\_value\\_register': '2016-02-12T11:39:22.942Z',
&gt; name\\_register: 'foo',
&gt; owner\\_register: 'test' },
&gt; …
&gt; { score: 0.35434482,
&gt; \\_yz\\_rb: 'minimals',
&gt; \\_yz\\_rt: 'maps',
&gt; \\_yz\\_rk: 'test:foo',
&gt; \\_yz\\_id: '1\\*maps\\*minimals\\*test:foo\\*13\\*4hNPnHzeJpTc7S6nEW8vNb',
&gt; 'date\\_map.\\_type\\_register': '\\_date',
&gt; 'date\\_map.\\_value\\_register': '2016-02-12T13:28:11.785Z',
&gt; name\\_register: 'foo',
&gt; owner\\_register: 'test' } ] 
&gt; }
&gt; 
&gt; Riak get by ID:
&gt; $ curl -XGET 
&gt; "http://localhost:11098/types/maps/buckets/minimals/datatypes/test:foo"
&gt; {"type":"map","value":{"date\\_map":{"\\_type\\_register":"\\_date","\\_value\\_register":"2016-02-12T13:28:11.785Z"},"name\\_register":"foo","owner\\_register":"test"},"context":"g2wAAAABaAJtAAAADMHSXwlPAZAxAAAAQmEDag==“}
&gt; 
&gt; 
&gt; Thanks,
&gt; Peter
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

