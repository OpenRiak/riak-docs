---
title: "Re: Strategies for testing against Riak"
description: ""
project: community
lastmod: 2012-09-09T10:09:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08483"
mailinglist_parent_id: "msg08481"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2012-09-09T10:09:05-07:00
---


Brad,

:root should be where you want the test node generated to. In a Rails
project this is typically tmp/riak\\_test\\_server.
:source should point to the directory where the 'riak' control script
lives in your local install. On Linux this is usually /usr/sbin, on
Mac/Homebrew it might be /usr/local/bin.

Using the same binaries but a different configuration is \\*exactly\\*
what the Riak::TestServer does (these go for Riak::Node as well, which
generates non-test nodes). #create will create a new directory on the
filesystem (pointed to by :root) which contains bin/ etc/ data/ log/
ring/ and possibly some other directories. It will write your
specified configuration to etc/app.config and etc/vm.args, using
defaults that include memory-only backends for KV and Search and point
the appropriate directories to the new root. It will also modify the
riak & riak-admin scripts to point to the new root and write them to
bin/. All of this happens without copying the Riak code or Erlang
runtime into the new location.

The other interesting and useful feature, aside from isolating the new
Riak node to the generated directory, is the Console and the
memory-backends that were specifically written for usage in
test-suites. Riak::TestServer#drop will open a console (just like
"riak attach") and run a command in the Riak node that makes it drop
all data in RAM, which gives you a clean slate for each test/example.

There is one bug in the generation process currently, which is that
you must have started the normal installation at least once. I hope to
resolve this bug in the future.

On Sat, Sep 8, 2012 at 6:42 PM, Brad Heller  wrote:
&gt; Hey Sean,
&gt;
&gt; Thanks for the suggestion. I've spent a few hours trying to get this up and
&gt; running and I'm having a bit of a hard time. Is there any documentation
&gt; around Riak::TestServer?
&gt;
&gt; What are the configuration values for :source and :root supposed to be
&gt; exactly? As I understand it, :root should be something like
&gt; /path/to/riak/bin and source should be something like /path/to/riak. Is that
&gt; correct? Also, how does Riak:: TestServer#create behave exactly?
&gt;
&gt; In our dev environments we have a Riak configuration that includes config
&gt; files and binaries that our dev's can just git clone so they can get started
&gt; quickly. It is very similar to what the following docs outline only with
&gt; three nodes instead of one:
&gt; https://wiki.basho.com/Building-a-Development-Environment.html
&gt;
&gt; What I'd really like to set up is a way for Riak::TestServer to use the same
&gt; binaries as our dev riak config, but a different configuration (app.config,
&gt; vm.args, etc.). Is this possible? Alternatively, we could stick a copy of
&gt; the Riak binaries directly in the repo that is using Ripple to make it a bit
&gt; more standalone.
&gt;
&gt; What is the configuration you were anticipating when you wrote the
&gt; Riak::TestServer class?
&gt;
&gt; Thanks,
&gt; Brad Heller
&gt;
&gt; On Sep 7, 2012, at 5:02 AM, Sean Cribbs  wrote:
&gt;
&gt; If it's only for your test suite, use a local memory-only node via the
&gt; Ripple::TestServer. If you configure it correctly (there's a bundled
&gt; Rails generator that helps), it will delete all the contents of Riak
&gt; in one fell-swoop after or before each test/example.
&gt;
&gt; On Fri, Sep 7, 2012 at 2:49 AM, Brad Heller  wrote:
&gt;
&gt; Hey all,
&gt;
&gt; So we're rolling out Riak more and more and so far, so good. In fact we're
&gt; starting to accumulate a pretty sizable test suite of our data access layer.
&gt; To support this we've written some code that helps clean out buckets between
&gt; test runs. We're using Ruby (ripple + ruby-risk-client, obviously) so we
&gt; just monkey patch the bucket object and detect if it was used or not.
&gt;
&gt; If it was used during a test, we iterate over all the keys and delete each
&gt; one. We're cognizant of the risks in doing this for large clusters, but in
&gt; our test enviro the number of documents per test is pretty small and the
&gt; operations themselves are quite fast.
&gt;
&gt; The problem we're having, though, is that when we run the full suite (or a
&gt; large subset of the suite) all at once the churn in Riak seems to be so
&gt; quick that sometimes Riak isn't quite in the state that we expect it to be
&gt; in when the test runs! For instance, we have a test that checks that the
&gt; right number of linked documents are created when a given object is saved.
&gt; If we run the test by itself everything works fine--the expectation that 10
&gt; documents are created indeed checks out. If we run this test as part of a
&gt; large suite of tests, the expectation fails and sometimes 11 documents or 12
&gt; documents appear (we check by counting the keys in the linked bucket).
&gt;
&gt; I would think that this has something to do with Riak's eventually
&gt; consistent delete operation, but wanted to tap in to the brain trust: Is
&gt; there any tuning we can do in test to prevent this?
&gt;
&gt; Thanks,
&gt;
&gt; Brad Heller | Engineering Lead | Cloudability.com | 541-231-1514 | Skype:
&gt; brad.heller | @bradhe | @cloudability
&gt;
&gt; We're hiring! http://cloudability.com/jobs
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
&gt;



-- 
Sean Cribbs 
Software Engineer
Basho Technologies, Inc.
http://basho.com/

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

