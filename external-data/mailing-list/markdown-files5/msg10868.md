---
title: "Re: Advice for storing records in Riak"
description: ""
project: community
lastmod: 2013-04-12T02:50:53-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10868"
mailinglist_parent_id: "msg10865"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-04-12T02:50:53-07:00
---


Hi Toby,

Inserting lots of small records in Riak and querying the full data set via 
MapReduce is definitely not the best way to go around things. As Alexander 
points out, easy object is stored with metadata, which adds some overhead and 
Riak MapReduce tends to work best when run over smaller data sets.

In order to help and come up with suggestions on how to model your data 
efficiently I would need to better understand the nature of the data you want 
to store in Riak, the access patterns and how you need to be able to query it.

- What does the data represent? Are there any natural way to group records? 
- How frequently are records inserted? How often are they updated? Do you 
delete records or keep them forever?
- How do you need to be able to query this data? What is the logical task of 
the MapReduce job you described? 
- In what different ways is the data aggregated?

Best regards,

Christian



On 12 Apr 2013, at 09:11, Alexander Sicular  wrote:

&gt; Inline -Alexander.
&gt; 
&gt; On Apr 12, 2013 3:11 AM, "Toby Corkindale" 
&gt;  wrote:
&gt; &gt;
&gt; &gt; Hi,
&gt; &gt; I wondered if I could get a little advice on good practices for storing my 
&gt; &gt; records in Riak, such that they perform reasonably well in map-reduce 
&gt; &gt; queries?
&gt; &gt;
&gt; &gt; I have a little over 200 million records, currently stored in a regular SQL 
&gt; &gt; database. I'm expecting this dataset to continue to grow, of course.
&gt; &gt; Each record is reasonably small - some get up to couple of hundred bytes, 
&gt; &gt; but most are smaller, and consist of around a dozen numeric fields and some 
&gt; &gt; small alphanumeric identifier fields.
&gt; &gt;
&gt; &gt; My initial trial of importing these into Riak were to take each database 
&gt; &gt; row and convert it into a small JSON of key=&gt;value pairs.
&gt; &gt;
&gt; &gt; I'm find two issues with this though.
&gt; &gt; 1) It takes a really long time to import everything into Riak, at least 
&gt; &gt; compared to ingesting into PostgreSQL. (I'm using Riak's HTTP API)
&gt; 
&gt; Proto buff interface is faster, less overhead. ..
&gt; 
&gt; &gt; 2) An initial trial of some map-reduce queries was significantly slower 
&gt; &gt; than I was hoping; I suspect this is because of my data structure though.
&gt; &gt; My initial map phase was iterating over a high percentage of the keys, 
&gt; &gt; decoding the JSON, and then returning just one or two of the fields from 
&gt; &gt; the JSON structure, which is maybe an inefficient way to go about things?
&gt; Not the most efficient. Everything is translated from erlang to JavaScript 
&gt; and shipped over to the coordinating node. MR over smaller sets, accumulate 
&gt; over some range like time or something native to your app.
&gt; 
&gt; &gt;
&gt; &gt;
&gt; &gt; So I was wondering if there's a better way to be approaching the problem.. 
&gt; &gt; I wondered about breaking up the records further, and storing individual 
&gt; &gt; fields against keys, rather than the whole record as a JSON object.
&gt; &gt;
&gt; &gt; Eg. This was my initial method:
&gt; &gt; Key: {id}:{recordtype}:{recordid}
&gt; &gt; Value: { field1: "foo", field2: "bar", field3: "baz" }
&gt; &gt;
&gt; &gt; I wondered about this, creating one key for each field:
&gt; &gt; {id}:{recordtype}:{recordid}:field1 ==&gt; "foo"
&gt; &gt; {id}:{recordtype}:{recordid}:field2 ==&gt; "bar"
&gt; &gt; {id}:{recordtype}:{recordid}:field3 ==&gt; "baz"
&gt; &gt;
&gt; 
&gt; Don't do that. There is a ~400b per key overhead in riak.
&gt; 
&gt; &gt; That would avoid the need for one of the map phases; but on the other hand, 
&gt; &gt; now I'd be creating an order of magnitude more overall keys in the db.
&gt; &gt;
&gt; &gt;
&gt; &gt; On the other hand, I wondered about going the other way, and grouping 
&gt; &gt; records under one key. So instead of having keys 100, 101, 102 .. 109, I 
&gt; &gt; would have one key 10x that contained a JSON structure with an array of 
&gt; &gt; records.. (I don't know whether I store 10, 50 or 100 records per key)
&gt; &gt;
&gt; 
&gt; I might batch depending on your access pattern and update pattern. If you 
&gt; update values with any frequency it may not be worth it. Riak has no in 
&gt; place updates. 
&gt; 
&gt; &gt; This would speed up the time taken to ingest data to Riak, and reduce the 
&gt; &gt; number of total queries made by the map phase.. but would increase the work 
&gt; &gt; DONE in the map phase and add inefficiencies as sometimes only a few rows 
&gt; &gt; of the set would actually be required for a given query.
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; And the third consideration is that maybe I just need to scale up the 
&gt; &gt; cluster size to have more machines. Currently it's running on a small 
&gt; &gt; cluster of four nodes while trialling Riak. (And I'm comparing performance 
&gt; &gt; with a single, but significantly more powerful, PostgreSQL node)
&gt; &gt;
&gt; &gt;
&gt; &gt; There's nothing to stop me trying out all these methods, but I thought I'd 
&gt; &gt; poll the community for advice since no doubt implemented similar things 
&gt; &gt; before and know what rough things may or may not work well.
&gt; &gt;
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt; Toby
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

