---
title: "Bitcask fold key issue, unhandled data corruption ?"
description: ""
project: community
lastmod: 2014-10-01T04:37:56-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14965"
author_name: "Arnaud Wetzel"
project_section: "mailinglistitem"
sent_date: 2014-10-01T04:37:56-07:00
---


Hello all,
I am using riak 1.4.3
I have an error during map reduce (not every time) :

{
 "phase": "listkeys",
 "error": "function\\_clause",
 "input": "xxx",
 "type": "error",
 "stack": "[
 {riak\\_kv\\_pipe\\_listkeys,keysend,
 [ error,
 {worker\\_crash,{badarg,[{erlang,binary\\_to\\_term,[&lt;&lt;&gt;&gt;],[]},
 {riak\\_kv\\_bitcask\\_backend,'-fold\\_keys\\_fun/2-fun-1-',4,
 [{file,\\"src/riak\\_kv\\_bitcask\\_backend.erl\\"},{line,461}]},
 
{bitcask\\_nifs,keydir\\_fold\\_cont,4,[{file,\\"src/bitcask\\_nifs.erl\\"},{line,419}]},
 
{bitcask\\_nifs,keydir\\_frozen,4,[{file,\\"src/bitcask\\_nifs.erl\\"},{line,265}]},
 {riak\\_kv\\_bitcask\\_backend,'-fold\\_keys/4-fun-0-',5,
 [{file,\\"src/riak\\_kv\\_bitcask\\_backend.erl\\"},{line,254}]},
 {riak\\_kv\\_worker,handle\\_work,3,[{file,...},...]},
 ...]},...},...],...},...]"
}

So it seems to be a corruption on a bitcask file making a &lt;&lt;&gt;&gt; bitcask
key, which is not a term\\_to\\_binary({B,K}), so the fold function crash.

I will make a manual bitcask fold in order to find the corrupted file,
but I have some questions :

- I saw that in last riak2.0 the fold function does not handle
corrupted key format either, but is their an additional consistency
check in newer version making this problem impossible ?
- What is the best way for me to reconstruct the file : delete the
partition en repair it ?
- Do you think it's a good idea to make the fold function more
resilient to a corrupted key format ?
- Do you have an idea of the possible source of the problem ? If
anybody had this issue before ?

Thank you very much

Arnaud

-- 
Arnaud Wetzel
Co-founder
Shopping Adventure
13 rue saint Anastase, 75003 Paris

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

