---
title: "Re: Riak 2i http query much faster than python api?"
description: ""
project: community
lastmod: 2013-04-11T09:53:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10853"
mailinglist_parent_id: "msg10852"
author_name: "Evan Vigil-McClanahan"
project_section: "mailinglistitem"
sent_date: 2013-04-11T09:53:19-07:00
---


Sean wrote it, it's already in master, iirc.

That wouldn't surprise me, honestly, re performance. It's something
we've been meaning to look into, just to make sure that nothing is
extravagantly horrible, but I don't think that any systematic effort
has started as yet. Have you managed to replicate and profile Jeff's
case?

On Thu, Apr 11, 2013 at 11:47 AM, Shuhao  wrote:
&gt; Evan: Who is working on the streaming interface?
&gt;
&gt; Also, it seems that the python API is a bit slow on its own and a lot of
&gt; time is actually spent in the client as well.
&gt;
&gt; Shuhao
&gt;
&gt;
&gt; On 13-04-11 10:18 AM, Evan Vigil-McClanahan wrote:
&gt;&gt;
&gt;&gt; Have you tried streaming the results? Sometimes the
&gt;&gt; disproportionately slow responses from large mapreduce jobs are due to
&gt;&gt; swapping and memory pressure. Streaming should lower the amount of
&gt;&gt; memory used, potentially allowing you to do this in a reasonable
&gt;&gt; amount of time. the downside here is that streaming currently isn't
&gt;&gt; supported in the python client (although a new version that does
&gt;&gt; should be out sometime soon-ish).
&gt;&gt;
&gt;&gt; On Wed, Apr 10, 2013 at 9:25 PM, Jeff Peck  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; As a follow-up to this thread and my thread from earlier today, I am
&gt;&gt;&gt; basically looking for a simple way to extract the value of a single field
&gt;&gt;&gt; from approximately 900,000 documents (which happens to be indexed). I
&gt;&gt;&gt; have
&gt;&gt;&gt; been trying many options including a map-reduce function that executes
&gt;&gt;&gt; entirely over http (taking out any python client bottlenecks). I let that
&gt;&gt;&gt; run for over an hour before I stopped it. It did not return any output.
&gt;&gt;&gt;
&gt;&gt;&gt; I also have tried grabbing a list of the 900k keys from a secondary index
&gt;&gt;&gt; (very fast, about 11 seconds) and then trying to fetch each key in
&gt;&gt;&gt; parallel
&gt;&gt;&gt; (using curl and gnu parallel). That was also too slow to be feasible.
&gt;&gt;&gt;
&gt;&gt;&gt; Is there something basic that I am missing?
&gt;&gt;&gt;
&gt;&gt;&gt; One idea that I though of was to have a secondary index that is intended
&gt;&gt;&gt; to
&gt;&gt;&gt; split all of my data into segments. I would use the first three
&gt;&gt;&gt; characters
&gt;&gt;&gt; of the md5 of the document's key in hexadecimal format. So, the index
&gt;&gt;&gt; would
&gt;&gt;&gt; contain strings like "ae1", "2f4", "5ee", etc. Then, I can run my
&gt;&gt;&gt; map-reduce
&gt;&gt;&gt; query against \\*each\\* segment individually and possibly even in parallel.
&gt;&gt;&gt;
&gt;&gt;&gt; I have observed that map-reduce is very fast with small sets of data
&gt;&gt;&gt; (i.e.
&gt;&gt;&gt; 5,000 objects), but with 900,000 objects it does not appear to run in a
&gt;&gt;&gt; proportionately fast time. So, the idea is to divide the data into
&gt;&gt;&gt; segments
&gt;&gt;&gt; that can be better handled by map-reduce.
&gt;&gt;&gt;
&gt;&gt;&gt; Before I implement this, I want to ask: Does this seem like the
&gt;&gt;&gt; appropriate
&gt;&gt;&gt; way to handle this type of operation? And, is there any better way to do
&gt;&gt;&gt; this in the current version of Riak?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Apr 10, 2013, at 6:10 PM, Shuhao Wu  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; There are some inefficiencies in the python client... I've been profiling
&gt;&gt;&gt; it
&gt;&gt;&gt; recently and found that it occasionally takes the python client longer
&gt;&gt;&gt; when
&gt;&gt;&gt; you're on the same machine.
&gt;&gt;&gt;
&gt;&gt;&gt; Perhaps Sean could comment?
&gt;&gt;&gt;
&gt;&gt;&gt; Shuhao
&gt;&gt;&gt; Sent from my phone.
&gt;&gt;&gt;
&gt;&gt;&gt; On 2013-04-10 4:04 PM, "Jeff Peck"  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks Evan. I tried doing it in python like this (realizing that the
&gt;&gt;&gt;&gt; previous way I did it uses MapReduce) and I had better results. It
&gt;&gt;&gt;&gt; finished
&gt;&gt;&gt;&gt; in 3.5 minutes, but nowhere close to the 15 seconds from the straight
&gt;&gt;&gt;&gt; http
&gt;&gt;&gt;&gt; query:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; import riak
&gt;&gt;&gt;&gt; from pprint import pprint
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; bucket\\_name = "mybucket"
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; client =
&gt;&gt;&gt;&gt; riak.RiakClient(port=8087,transport\\_class=riak.RiakPbcTransport)
&gt;&gt;&gt;&gt; bucket = client.bucket(bucket\\_name)
&gt;&gt;&gt;&gt; results = bucket.get\\_index('status\\_bin', 'PERSISTED')
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; print len(results)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Apr 10, 2013, at 4:00 PM, Evan Vigil-McClanahan
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; get\\_index() is the right function there, I think.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On Wed, Apr 10, 2013 at 2:53 PM, Jeff Peck  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; I can grab over 900,000 keys from an indexs, using an http query in
&gt;&gt;&gt;&gt;&gt;&gt; about 15 seconds, whereas the same operation in python times out after
&gt;&gt;&gt;&gt;&gt;&gt; 5
&gt;&gt;&gt;&gt;&gt;&gt; minutes. Does this indicate that I am using the python API
&gt;&gt;&gt;&gt;&gt;&gt; incorrectly?
&gt;&gt;&gt;&gt;&gt;&gt; Should I be relying on an http request initially when I need to grab
&gt;&gt;&gt;&gt;&gt;&gt; this
&gt;&gt;&gt;&gt;&gt;&gt; many keys?
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; (Note: This is tied to the question that I asked earlier, but is also
&gt;&gt;&gt;&gt;&gt;&gt; a
&gt;&gt;&gt;&gt;&gt;&gt; general question to help understand the proper usage of the python
&gt;&gt;&gt;&gt;&gt;&gt; API.)
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Thanks! Examples are below.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; - Jeff
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; ---
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; HTTP:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; $ time curl -s
&gt;&gt;&gt;&gt;&gt;&gt; http://localhost:8098/buckets/mybucket/index/status\\_bin/PERSISTED |
&gt;&gt;&gt;&gt;&gt;&gt; grep -o
&gt;&gt;&gt;&gt;&gt;&gt; , | wc -l
&gt;&gt;&gt;&gt;&gt;&gt; 926047
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; real 0m14.583s
&gt;&gt;&gt;&gt;&gt;&gt; user 0m2.500s
&gt;&gt;&gt;&gt;&gt;&gt; sys 0m0.270s
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; ---
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Python:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; import riak
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; bucket = "my bucket"
&gt;&gt;&gt;&gt;&gt;&gt; client = riak.RiakClient(port=8098)
&gt;&gt;&gt;&gt;&gt;&gt; results = client.index(bucket, 'status\\_bin',
&gt;&gt;&gt;&gt;&gt;&gt; 'PERSISTED').run(timeout=5\\*60\\*1000) # 5 minute timeout
&gt;&gt;&gt;&gt;&gt;&gt; print len(results)
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; (times out after 5 minutes)
&gt;&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

