---
title: "Re: {error, notfound} items in mapreduce during ownership handoff"
description: ""
project: community
lastmod: 2013-03-06T13:47:04-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10338"
mailinglist_parent_id: "msg10337"
author_name: "Jeremy Raymond"
project_section: "mailinglistitem"
sent_date: 2013-03-06T13:47:04-08:00
---


Thanks for the response. To handle not founds and tombstones I need this in
every map function?

map\\_something({error, notfound}, \\_, \\_) -&gt;
 [];
map\\_something(RiakObj, \\_, \\_) -&gt;
 Metadata = riak\\_object:get\\_metadata(RiakObj),
 case dict:is\\_key(&lt;&lt;"X-Riak-Deleted"&gt;&gt;, Metadata) of
 true -&gt;
 []; % I have a tombstone
 false -&gt;
 [ok] % I have a valid item
 end.

Is there a better or built-in way to do this filtering?

--
Jeremy


On Wed, Mar 6, 2013 at 4:08 PM, John Daily  wrote:

&gt; I'm sorry this went unanswered, Jeremy. Thanks for the follow up.
&gt;
&gt; Your code needs to be able to handle notfound errors and tombstones[1]
&gt; regardless of ownership handoff. The coverage for the 2i or listkeys input
&gt; will be calculated up front, with the work distributed to a node where the
&gt; key is expected to be found, but it's always possible that the node
&gt; selected may not have the data you want due to network or system errors
&gt; that haven't yet healed.
&gt;
&gt; Both the notfound and the fitting error in the logs (which is benign, and
&gt; related to the notfound problem) should be less common under Riak 1.3,
&gt; although ownership handoff will still exacerbate the problem.
&gt;
&gt; [1] https://github.com/basho/riak\\_kv/issues/358
&gt;
&gt; -John Daily
&gt; Technical Evangelist
&gt; jda...@basho.com
&gt;
&gt;
&gt; On Mar 6, 2013, at 3:14 PM, Jeremy Raymond  wrote:
&gt;
&gt; So I should expect {error, notfound} inputs to map jobs while ownership
&gt; handoff is in progress? Are the not found items actually unavailable during
&gt; handoff or is this just not found on the old node, but will be picked up by
&gt; the new node during the same mapreduce job?
&gt;
&gt; --
&gt; Jeremy
&gt;
&gt;
&gt; On Thu, Feb 28, 2013 at 11:28 AM, Jeremy Raymond wrote:
&gt;
&gt;&gt; Yesterday I added a new node to my cluster. During the time when
&gt;&gt; ownership handoff was happening (several hours of work) mapreduce map
&gt;&gt; functions were receiving {error, notfound} as inputs. My Erlang mapred
&gt;&gt; functions weren't designed to handle this. They hadn't encountered this
&gt;&gt; before during normal operation. After the ownership handoff process
&gt;&gt; completed the {error, notfound} inputs have stopped.
&gt;&gt;
&gt;&gt; Any explanations for the {error, notfound} inputs during ownership
&gt;&gt; handoff? Is this because a node is attempting to process an object now
&gt;&gt; moved to another node? If this is the case would the notfound object be
&gt;&gt; found on the other node in the same mapreduce job (i.e. still visible to
&gt;&gt; the overall mapred process)? Should I assume {error, notfound} inputs for
&gt;&gt; all mapred jobs as a valid possible input and always handle it?
&gt;&gt;
&gt;&gt; I've also accumulated about 50MB of "Pipe worker startup failed:fitting
&gt;&gt; was gone before startup" on each node during the ownership\\_transfer
&gt;&gt; process. These messages are benign?
&gt;&gt;
&gt;&gt; Thanks a lot.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Jeremy
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

