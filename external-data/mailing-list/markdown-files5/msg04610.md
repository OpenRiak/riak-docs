---
title: "Re: Riak Clustering Changes in 1.0"
description: ""
project: community
lastmod: 2011-09-08T04:10:50-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04610"
mailinglist_parent_id: "msg04595"
author_name: "Ciprian Dorin Craciun"
project_section: "mailinglistitem"
sent_date: 2011-09-08T04:10:50-07:00
---


On Thu, Sep 8, 2011 at 03:12, Joseph Blomstedt  wrote:
&gt; Given that 1.0 prerelease packages are now available, I wanted to
&gt; mention some changes to Riak's clustering capabilities in 1.0. In
&gt; particular, there are some subtle semantic differences in the
&gt; riak-admin commands. More complete docs will be updated in the near
&gt; future, but I hope a quick email suffices for now.
&gt;
&gt; [nodeB/riak-admin join nodeA] is now strictly one-way. It joins nodeB
&gt; to the cluster that nodeA is a member of. This is semantically
&gt; different than pre-1.0 Riak in which join essentially joined clusters
&gt; together rather than joined a node to a cluster. As part of this
&gt; change, the joining node (nodeB in this case) must be a singleton
&gt; (1-node) cluster.
&gt;
&gt; In pre-1.0, leave and remove were essentially the same operation, with
&gt; leave just being an alias for 'remove this-node'. This has changed.
&gt; Leave and remove are now very different operations.
&gt;
&gt; [nodeB/riak-admin leave] is the only safe way to have a node leave the
&gt; cluster, and it must be executed by the node that you want to remove.
&gt; In this case, nodeB will start leaving the cluster, and will not leave
&gt; the cluster until after it has handed off all its data. Even if nodeB
&gt; is restarted (crashed/shutdown/whatever), it will remain in the leave
&gt; state and continue handing off partitions until done. After handoff,
&gt; it will leave the cluster, and eventually shutdown.
&gt;
&gt; [nodeA/riak-admin remove nodeB] immediately removes nodeB from the
&gt; cluster, without handing off its data. All replicas held by nodeB are
&gt; therefore lost, and will need to be re-generated through read-repair.
&gt; Use this command carefully. It's intended for nodes that are
&gt; permanently unrecoverable and therefore for which handoff doesn't make
&gt; sense. By the final 1.0 release, this command may be renamed
&gt; "force-remove" just to make the distinction clear.
&gt;
&gt; There are now two new commands that provide additional insight into
&gt; the cluster. [riak-admin member\\_status] and [riak-admin ring\\_status].
&gt;
&gt; Underneath, the clustering protocol has been mostly re-written. The
&gt; new approach has the following advantages:
&gt; 1. It is no longer necessary to wait on [riak-admin ringready] in
&gt; between adding/removing nodes from the cluster, and adding/removing is
&gt; also much more sound/graceful. Starting up 16 nodes and issuing
&gt; [nodeX: riak-admin join node1] for X=1:16 should just work.
&gt;
&gt; 2. Data is first transferred to new partition owners before handing
&gt; over partition ownership. This change fixes numerous bugs, such as
&gt; 404s/not\\_founds during ownership changes. The Ring/Pending columns in
&gt; [riak-admin member\\_status] visualize this at a high-level, and the
&gt; full transfer status in [riak-admin ring\\_status] provide additional
&gt; insight.
&gt;
&gt; 3. All partition ownership decisions are now made by a single node in
&gt; the cluster (the claimant). Any node can be the claimant, and the duty
&gt; is automatically taken over if the previous claimant is removed from
&gt; the cluster. [riak-admin member\\_status] will list the current
&gt; claimant.
&gt;
&gt; 4. Handoff related to ownership changes can now occur under load;
&gt; hinted handoff still only occurs when a vnode is inactive. This change
&gt; allows a cluster to scale up/down under load, although this needs to
&gt; be further benchmarked and tuned before 1.0.
&gt;
&gt; To support all of the above, a new limitation has been introduced.
&gt; Cluster changes (member addition/removal, ring rebalance, etc) can
&gt; only occur when all nodes are up and reachable. [riak-admin
&gt; ring\\_status] will complain when this is not the case. If a node is
&gt; down, you must issue [riak-admin down ] to mark the node as
&gt; down, and the remaining nodes will then proceed to converge as usual.
&gt; Once the down node comes back online, it will automatically
&gt; re-integrate into the cluster. However, there is nothing preventing
&gt; client requests being served by a down node before it re-integrates.
&gt; Before issuing [down ], make sure to update your load balancers
&gt; / connection pools to not include this node. Future releases of Riak
&gt; may make offlining a node an automatic operation, but it's a
&gt; user-initiated action in 1.0.
&gt;
&gt; -Joe


 Hello!

 I'm quite happy to see that things related to clustering have been
worked on, so "Nice work!". :)

 My guess is that all this went actually in the Riak-Core
repository (I haven't looked over the repository). Thus -- as I'm a
user of Riak-Core -- what else notable has changed in Riak-Core.

 Thanks,
 Ciprian.

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

