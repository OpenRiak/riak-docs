---
title: "Re: Java Client and clobber update"
description: ""
project: community
lastmod: 2015-01-14T13:42:50-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15494"
mailinglist_parent_id: "msg15493"
author_name: "Cosmin Marginean"
project_section: "mailinglistitem"
sent_date: 2015-01-14T13:42:50-08:00
---


Hi Brian,

Thank you for your prompt reply, I thought that might be the case (and I agree, 
the way generics ended up being implemented is sadistic)

I went with B) already but I wanted to make sure this is recorded.

I filed this here for reference: 
https://github.com/basho/riak-java-client/issues/493

Cheers
Cos


On Wednesday, 14 January 2015 at 21:32, Brian Roach wrote:

&gt; Cosmin -
&gt; 
&gt; It would appear that the crazy generics involved are indeed broken
&gt; when it comes to UpdateValue the "ClobberUpdate" - it's not pulling
&gt; out the type correctly. I'll have to try and figure out why that is.
&gt; Type erasure will make you weep ;)
&gt; 
&gt; Two ways to deal with it at the moment:
&gt; 
&gt; A) Pass in a TypeReference explicitly:
&gt; 
&gt; TypeReference tRef = new TypeReference(){};
&gt; ...
&gt; .withUpdate(UpdateValue.Update.clobberUpdate(entity), tRef)
&gt; ...
&gt; 
&gt; B) Create your own class that subclasses UpdateValue.Update that does
&gt; the same thing as a "clobber update" :
&gt; 
&gt; public static class UpdateEntity extends UpdateValue.Update
&gt; {
&gt; private final SomeEntity entity;
&gt; 
&gt; public UpdateEntity(SomeEntity e)
&gt; {
&gt; this.entity = e;
&gt; }
&gt; 
&gt; @Override
&gt; public SomeEntity apply(SomeEntity original)
&gt; {
&gt; return entity;
&gt; }
&gt; 
&gt; }
&gt; 
&gt; ...
&gt; .withUpdate(new UpdateEntity(entity))
&gt; ...
&gt; 
&gt; 
&gt; 
&gt; I've tested both of these solutions and they both work.
&gt; 
&gt; Thanks and sorry for the problem,
&gt; - Roach
&gt; 
&gt; On Wed, Jan 14, 2015 at 1:39 PM, Cosmin Marginean  (mailto:cosmin...@gmail.com)&gt; wrote:
&gt; &gt; I’m doing a fairly “by the book” clobber update (store and fetch below work
&gt; &gt; fine) on an entity using the Java client. I’m seeing an error that happens
&gt; &gt; at type-inference time within the Riak Java client. I’m pasting below the
&gt; &gt; exact test that I’m using to generate this, as well as the stacktrace.
&gt; &gt; Please let me know if I’m missing something or if it’s a known bug.
&gt; &gt; 
&gt; &gt; Thank you
&gt; &gt; Cosmin
&gt; &gt; 
&gt; &gt; @Test
&gt; &gt; public void testRiakUpdate() throws Exception {
&gt; &gt; RiakNode node = new
&gt; &gt; RiakNode.Builder().withRemoteAddress("192.168.168.2").withRemotePort(8087).build();
&gt; &gt; RiakCluster cluster = new RiakCluster.Builder(node).build();
&gt; &gt; cluster.start();
&gt; &gt; RiakClient client = new RiakClient(cluster);
&gt; &gt; 
&gt; &gt; SomeEntity entity = new SomeEntity();
&gt; &gt; entity.setName("John Doe");
&gt; &gt; entity.setDescription("Some Description");
&gt; &gt; Location location = new Location(new Namespace("bucket"), "entity-key");
&gt; &gt; 
&gt; &gt; // Store
&gt; &gt; StoreValue storeOp = new
&gt; &gt; StoreValue.Builder(entity).withLocation(location).build();
&gt; &gt; client.execute(storeOp);
&gt; &gt; 
&gt; &gt; // Fetch
&gt; &gt; FetchValue fetchOp = new FetchValue.Builder(location).build();
&gt; &gt; entity = client.execute(fetchOp).getValue(SomeEntity.class);
&gt; &gt; 
&gt; &gt; // Update
&gt; &gt; entity.setName("New name");
&gt; &gt; UpdateValue updateOp = new UpdateValue.Builder(location)
&gt; &gt; .withFetchOption(FetchValue.Option.DELETED\\_VCLOCK, true)
&gt; &gt; .withUpdate(UpdateValue.Update.clobberUpdate(entity))
&gt; &gt; .build();
&gt; &gt; client.execute(updateOp).getValue(SomeEntity.class);
&gt; &gt; }
&gt; &gt; 
&gt; &gt; private static class SomeEntity {
&gt; &gt; private String name;
&gt; &gt; private String description;
&gt; &gt; 
&gt; &gt; public String getName() {
&gt; &gt; return name;
&gt; &gt; }
&gt; &gt; 
&gt; &gt; public void setName(String name) {
&gt; &gt; this.name (http://this.name) = name;
&gt; &gt; }
&gt; &gt; 
&gt; &gt; public String getDescription() {
&gt; &gt; return description;
&gt; &gt; }
&gt; &gt; 
&gt; &gt; public void setDescription(String description) {
&gt; &gt; this.description = description;
&gt; &gt; }
&gt; &gt; }
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; java.lang.ClassCastException:
&gt; &gt; sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to
&gt; &gt; java.lang.Class
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.kv.UpdateValue$1.handle(UpdateValue.java:149)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.ListenableFuture.notifyListeners(ListenableFuture.java:78)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.CoreFutureAdapter.handle(CoreFutureAdapter.java:120)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.FutureOperation.fireListeners(FutureOperation.java:131)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.FutureOperation.setResponse(FutureOperation.java:170)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at com.basho.riak.client.core.RiakNode.onSuccess(RiakNode.java:823)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:58)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:155)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:108)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:785)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:116)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:494)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:461)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:378)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:101)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at java.lang.Thread.run(Thread.java:745) [na:1.8.0\\_05]
&gt; &gt; 20:34:13.390 [nioEventLoopGroup-2-1] DEBUG
&gt; &gt; c.b.riak.client.core.FutureOperation - IllegalStateException; required:
&gt; &gt; [CREATED, WRITTEN, RETRY] current: COMPLETE
&gt; &gt; 20:34:13.391 [nioEventLoopGroup-2-1] WARN
&gt; &gt; i.n.channel.DefaultChannelPipeline - An exception was thrown by a user
&gt; &gt; handler's exceptionCaught() method while handling the following exception:
&gt; &gt; java.lang.ClassCastException:
&gt; &gt; sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to
&gt; &gt; java.lang.Class
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.kv.UpdateValue$1.handle(UpdateValue.java:149)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.ListenableFuture.notifyListeners(ListenableFuture.java:78)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.api.commands.CoreFutureAdapter.handle(CoreFutureAdapter.java:120)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.FutureOperation.fireListeners(FutureOperation.java:131)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.FutureOperation.setResponse(FutureOperation.java:170)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at com.basho.riak.client.core.RiakNode.onSuccess(RiakNode.java:823)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:58)
&gt; &gt; ~[riak-client-2.0.0.jar:na]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:155)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:108)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:785)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:116)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:494)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:461)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:378)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at
&gt; &gt; io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:101)
&gt; &gt; [netty-all-4.0.17.Final.jar:4.0.17.Final]
&gt; &gt; at java.lang.Thread.run(Thread.java:745) [na:1.8.0\\_05]
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; 
&gt; 
&gt; 
&gt; 
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

