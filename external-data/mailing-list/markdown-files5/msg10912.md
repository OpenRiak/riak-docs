---
title: "Re: stream_list_keys"
description: ""
project: community
lastmod: 2013-04-17T02:31:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10912"
mailinglist_parent_id: "msg10902"
author_name: "tom kelly"
project_section: "mailinglistitem"
sent_date: 2013-04-17T02:31:36-07:00
---


Hi Christian,

Thanks for the reply!

That code snippet is very similar to what I had, except I was missing the
ack\\_keys call. That leads to the trivial question of why is there two keys
messages, {Id, From, {keys,Keys}} and {Id, {keys,Keys}}? I guess the ack
has been recently added for flow control?

My keys will be MD5s of data objects and I can't know them beforehand so I
need to cycle through them. Cycling through all the buckets is a bad idea
alright but I need to do it only very infrequently, if there's no other way
I'll profile it before deciding to use it or not. So the important question
for my application, is there a recommended way to retrieve all the keys in
a bucket?

//Tom.


On Tue, Apr 16, 2013 at 9:45 PM, Christian Dahlqvist wrote:

&gt; Hi Tom,
&gt;
&gt; Here is an example that runs from the Riak console and dumps all keys of a
&gt; bucket to a file and shows how stream\\_list\\_keys can be used:
&gt;
&gt; -module(keylister).
&gt;
&gt; -export([list\\_keys\\_to\\_file/2]).
&gt;
&gt; -define(TIMEOUT, 10000000).
&gt;
&gt; %% @spec list\\_keys\\_to\\_file(binary(), string()) -&gt;
&gt; %% ok | {error, term()}
&gt; list\\_keys\\_to\\_file(Bucket, File) when is\\_binary(Bucket) andalso is\\_list(File) 
&gt; -&gt;
&gt; {ok, C} = riak:local\\_client(),
&gt; case file:open(File, [write]) of
&gt; {ok, IoDev} -&gt;
&gt; C:stream\\_list\\_keys(Bucket, ?TIMEOUT),
&gt; write\\_keys\\_to\\_file(IoDev);
&gt; {error, Reason} -&gt;
&gt; {error, Reason}
&gt; end.
&gt;
&gt; write\\_keys\\_to\\_file(IoDev) -&gt;
&gt; receive
&gt; {\\_, {keys,Keys}} -&gt;
&gt; Output = [[K, &lt;&lt;"\\n"&gt;&gt;] || K &lt;- Keys],
&gt; file:write(IoDev, Output),
&gt; write\\_keys\\_to\\_file(IoDev);
&gt; {\\_, From, {keys,Keys}} -&gt;
&gt; riak\\_kv\\_keys\\_fsm:ack\\_keys(From),
&gt; Output = [[K, &lt;&lt;"\\n"&gt;&gt;] || K &lt;- Keys],
&gt; file:write(IoDev, Output),
&gt; write\\_keys\\_to\\_file(IoDev);
&gt; {\\_, done} -&gt;
&gt; file:close(IoDev);
&gt; M -&gt;
&gt; {error, unexpected\\_message, M}
&gt; end.
&gt;
&gt;
&gt; Although there are times when this is useful to use, it is NOT recommended
&gt; for production use as it has to traverse ALL keys stored in the cluster,
&gt; see:
&gt; http://docs.basho.com/riak/latest/references/apis/http/HTTP-List-Keys/
&gt;
&gt; Best regards,
&gt;
&gt; Christian
&gt;
&gt;
&gt;
&gt;
&gt; On 16 Apr 2013, at 15:49, tom kelly  wrote:
&gt;
&gt; Hi List,
&gt; I'm experimenting with riak 1.3.1 and I've started a cluster with two
&gt; nodes, connected from a dev node and wrote & read a few test keys and
&gt; everything was looking good. I was in the process of writing a few
&gt; functions we'll need in our system, one of which needs to cycle through all
&gt; the keys at startup, stream\\_list\\_keys looked like it would do the job but
&gt; I've just noticed this strange behavior:
&gt;
&gt; (a...@dev1.bfast.com)41&gt;
&gt; (a...@dev1.bfast.com)41&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,2583625}
&gt; (a...@dev1.bfast.com)42&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,98542259}
&gt; (a...@dev1.bfast.com)43&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,83513611}
&gt; (a...@dev1.bfast.com)44&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,112529022}
&gt; (a...@dev1.bfast.com)45&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,66267591}
&gt; (a...@dev1.bfast.com)46&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,90620806}
&gt; (a...@dev1.bfast.com)47&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,24108838}
&gt; (a...@dev1.bfast.com)48&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,17013899}
&gt; (a...@dev1.bfast.com)49&gt; DB:stream\\_list\\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,48399864}
&gt; (a...@dev1.bfast.com)50&gt; flush().
&gt; Shell got {2583625,{&lt;5272.17627.0&gt;,#Ref&lt;5272.0.0.95523&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {98542259,{&lt;5272.17656.0&gt;,#Ref&lt;5272.0.0.95733&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {83513611,{&lt;5272.17670.0&gt;,#Ref&lt;5272.0.0.95901&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {112529022,{&lt;5272.17683.0&gt;,#Ref&lt;5272.0.0.96064&gt;},{keys,[]}}
&gt; Shell got {66267591,{&lt;5272.17698.0&gt;,#Ref&lt;5272.0.0.96224&gt;},{keys,[]}}
&gt; Shell got {90620806,{&lt;5272.17708.0&gt;,#Ref&lt;5272.0.0.96375&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {24108838,{&lt;5272.17717.0&gt;,#Ref&lt;5272.0.0.96482&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {17013899,{&lt;5272.17731.0&gt;,#Ref&lt;5272.0.0.96638&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {48399864,{&lt;5272.17736.0&gt;,#Ref&lt;5272.0.0.96767&gt;},{keys,[]}}
&gt; ok
&gt;
&gt; The key &lt;&lt;1&gt;&gt; was written over an hour ago and these successive calls to
&gt; stream\\_list\\_keys are ~2 seconds apart, The key isn't always in the first
&gt; keys message returned and there's only ever one message returned per call.
&gt; From the comments in the source I expected all the keys to be returned
&gt; followed by the done message.
&gt; Am I misunderstanding or misusing anything here? Any pointers welcomed.
&gt; Thanks,
&gt; //TTom.
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

