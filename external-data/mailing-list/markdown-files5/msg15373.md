---
title: "Re: Memory-backend TTL"
description: ""
project: community
lastmod: 2014-12-16T10:53:46-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15373"
author_name: "Juan Luis Francés"
project_section: "mailinglistitem"
sent_date: 2014-12-16T10:53:46-08:00
---


Hello.

Do you have any update about this issue? I am affected by the same memory leak. 
Sadly, this problem does the Riak memory backend useless in production.

You can reproduce it with this dirty script (be careful, it is resource 
intensive):

https://gist.github.com/indpnday/76d99c5852e0100c5a04

- 1 Riak node 2.0.1. 
- riak.conf:

buckets.default.n\\_val = 1
buckets.default.last\\_write\\_wins = true
buckets.default.r = 1
buckets.default.w = 1
multi\\_backend.memory.storage\\_backend = memory
multi\\_backend.memory.memory\\_backend.ttl = 90s
multi\\_backend.memory.memory\\_backend.max\\_memory\\_per\\_vnode = 250MB


# curl http://127.0.0.1:8098/buckets/memory/props
{"props":{"allow\\_mult":false,"backend”:"memory","basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"dvv\\_enabled":false,"dw":"quorum","last\\_write\\_wins":true,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":1,"name”:"memory","notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":1,"rw":"quorum","small\\_vclock":50,"w":1,"young\\_vclock":20}}


Is there any bug report opened in github where to follow this issue?

Best regards,
Juan Luis Francés

2014-10-20 15:43 GMT+02:00 Luke Bakken:
&gt;Lucas,
&gt;
&gt;Thanks for all the detailed information. This is not expected
&gt;behavior. What MIME type are you using for storing the long integer
&gt;data (64 binary bits, I assume)?
&gt;
&gt;I'd like to try and reproduce this. There have been issues with TTL
&gt;and max\\_memory but they should have been fixed for Riak 2.0.
&gt;--
&gt;Luke Bakken
&gt;Engineer / CSE
&gt;lbak...@basho.com
&gt;
&gt;
&gt;On Mon, Oct 20, 2014 at 1:56 AM, Lucas Grijander
&gt; Hi Luke,
&gt;
&gt; Indeed, when removed the thousands of requests, the memory is stabilized.
&gt; However the memory consumption is still very high:
&gt;
&gt; riak-admin status |grep memory
&gt; memory\\_total : 18494760128
&gt; memory\\_processes : 145363184
&gt; memory\\_processes\\_used : 142886424
&gt; memory\\_system : 18349396944
&gt; memory\\_atom : 561761
&gt; memory\\_atom\\_used : 554496
&gt; memory\\_binary : 7108243240
&gt; memory\\_code : 13917820
&gt; memory\\_ets : 11200328880
&gt;
&gt; I have test also with Riak 1.4.10 and the performance is the same.
&gt;
&gt; Is it normal that the "memory\\_ets" has more than 10GB when we have a
&gt; "ring\\_size" of 16 and a max\\_memory\\_per\\_vnode = 250MB?
&gt;
&gt; 2014-10-15 20:50 GMT+02:00 Lucas Grijander:
&gt;&gt;
&gt;&gt; Hi Luke.
&gt;&gt;
&gt;&gt; About the first issue:
&gt;&gt;
&gt;&gt; - From the beginning, the servers are all running ntpd. They are Ubuntu
&gt;&gt; 14.04 and the ntpd service is installed and running by default.
&gt;&gt; - Anti-entropy was also disabled from the beginning:
&gt;&gt;
&gt;&gt; {anti\\_entropy,{off,[]}},
&gt;&gt;
&gt;&gt;
&gt;&gt; About the second issue, I am perplex because, after 2 restarts of the Riak
&gt;&gt; server, just now there is a big memory consumption but is not growing like
&gt;&gt; the previous days. The only change was to remove this code (it was used
&gt;&gt; thousands of times/s). It was a possible workaround about the previous
&gt;&gt; problem with the TTL but this code now is useless because the TTL is working
&gt;&gt; fine with this node alone:
&gt;&gt;
&gt;&gt; self.db.delete((key)
&gt;&gt; self.db.get(key, r=1)
&gt;&gt;
&gt;&gt;
&gt;&gt; # riak-admin status|grep memory
&gt;&gt; memory\\_total : 18617871264
&gt;&gt; memory\\_processes : 224480232
&gt;&gt; memory\\_processes\\_used : 222700176
&gt;&gt; memory\\_system : 18393391032
&gt;&gt; memory\\_atom : 561761
&gt;&gt; memory\\_atom\\_used : 552862
&gt;&gt; memory\\_binary : 7135206080
&gt;&gt; memory\\_code : 13779729
&gt;&gt; memory\\_ets : 11209256232
&gt;&gt;
&gt;&gt; The problem is that I don't remember if the code change was after or
&gt;&gt; before the second restart. I am going to restart the riak server again and I
&gt;&gt; will report you about if the "possible memory leak" is reproduced.
&gt;&gt;
&gt;&gt; This is the props of the bucket:
&gt;&gt;
&gt;&gt; {"props":{"allow\\_mult":false,"backend":"ttl\\_stg","basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"dvv\\_enabled":false,"dw":"quorum","last\\_write\\_wins":true,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":1,"name":"ttl\\_stg","notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":1,"rw":"quorum","small\\_vclock":50,"w":1,"young\\_vclock":20}}
&gt;&gt;
&gt;&gt; About the data that we put into the bucket are all with this schema:
&gt;&gt;
&gt;&gt; KEY: Alphanumeric with a length of 47
&gt;&gt; DATA: Long integer.
&gt;&gt;
&gt;&gt; # riak-admin status|grep puts
&gt;&gt; vnode\\_puts : 84708
&gt;&gt; vnode\\_puts\\_total : 123127430
&gt;&gt; node\\_puts : 83169
&gt;&gt; node\\_puts\\_total : 123128062
&gt;&gt;
&gt;&gt; # riak-admin status|grep gets
&gt;&gt; vnode\\_gets : 162314
&gt;&gt; vnode\\_gets\\_total : 240433213
&gt;&gt; node\\_gets : 162317
&gt;&gt; node\\_gets\\_total : 240433216


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

