---
title: "key expiration and memory"
description: ""
project: community
lastmod: 2013-08-28T01:58:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12146"
author_name: "Alexander Ilyin"
project_section: "mailinglistitem"
sent_date: 2013-08-28T01:58:07-07:00
---


Hi,

we're using Riak 1.3.1 with a Bitcask storage engine on a 4 node cluster.
Properties of the bucket used:
{"props":{"allow\\_mult":false,"
basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"dw":"quorum","last\\_write\\_wins":false,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":2,"name":"c","notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":"one","rw":"quorum","small\\_vclock":50,"w":"one","young\\_vclock":20}}


3 nodes crashed today morning almost simultaneously, fourth node had
crashed earlier this nignt. It's hard to figure out the reason of the crash
looking into the logs, but I suppose this is due to insufficient RAM
available on the servers (this maillist doesn't like big attachments but I
can send logs if it will help).

Actually, I'm dealing with Riak memory usage for some time already. Some
time ago I figured out that memory usage is much more than it is promised
in the documentation (
http://riak-users.197444.n3.nabble.com/memory-consumption-td4028674.html).
After that I tried to reduce number of keys stored, changing the
expiry\\_secs setting from 2 months to 1 month. I expected the memory usage
to drop in half because new keys are put into Riak at a approximately same
rate for last two months and Bitcask stores all keys in memory. But that
didn't happen. Memory usage have dropped a little but grew again in a few
days.

So the questions are:
\\* is there a cheap way to figure out the number of keys stored in a bucket?
\\* how long does it take to purge old keys from the storage?
\\* is it possible to see how many keys were expired for the last
minute/hour/day?
\\* are there some other ways to reduce memory usage I'm missing except for
adding new servers?

Thanks in advance.
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

