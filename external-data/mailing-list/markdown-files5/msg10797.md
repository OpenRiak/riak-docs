---
title: "Re: A story about unexpected changes in riak-erlang-client	dependencies"
description: ""
project: community
lastmod: 2013-04-09T08:17:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10797"
mailinglist_parent_id: "msg10795"
author_name: "Reid Draper"
project_section: "mailinglistitem"
sent_date: 2013-04-09T08:17:01-07:00
---


Yuri,

You're certainly not the only one dealing with this. Sorry about that. It's bit 
us here at Basho a few times too. As you saw, we're moving toward not having 
master dependencies, at least for tagged versions of repos. Especially for 
projects that are likely to be dependencies in other projects (ie. our client 
libraries, lager, etc.). That being said, it will take us some time to get 
there. You should also be aware of another 'fun' issue with rebar: if multiple 
dependencies require the same dep, the version that rebar first encounters will 
be the one that gets used. You'll find it helpful to use `./rebar list-deps` to 
see exactly what's being used in your project. I agree that this is something 
the Erlang community could improve, but in the short-term we're going to be 
more diligent about using recursively using tags for all tagged repos.

Reid


On Apr 9, 2013, at 10:49 AM, Yuri Lukyanov  wrote:

&gt; Hi,
&gt; 
&gt; To begin with, I almost fucked up production servers with these
&gt; changes in riak\\_pb:
&gt; https://github.com/basho/riak\\_pb/commit/2505ff1fa3975b93150d7445b6f7b91940ecb970
&gt; 
&gt; Well, this issue boils down to commonly known rebar-related problem. I
&gt; was even hesitating which mailing list I should've sent this massage
&gt; to, riak-users@ or rebar@.
&gt; The thing is that rebar does not allow you to fix dependencies on a
&gt; certain version.
&gt; 
&gt; When you do this in your rebar.config:
&gt; 
&gt; {deps, [
&gt; {riakc, "1.3.1", {git,
&gt; "https://github.com/basho/riak-erlang-client.git", "c377347bb0"}},
&gt; ]}.
&gt; 
&gt; you actually do \\_nothing\\_ to prevent you from unexpected changes to come.
&gt; 
&gt; Any dependency may have its own dependencies and so does riakc. And
&gt; guess what we see in riakc rebar.config in the commit "c377347bb0"?
&gt; 
&gt; Right:
&gt; {deps, [
&gt; {riak\\_pb, ".\\*", {git, "git://github.com/basho/riak\\_pb", "master"}}
&gt; ]}.
&gt; 
&gt; Welcome master.
&gt; 
&gt; And here is the welcoming message on your production servers when you
&gt; do hot code reloading:
&gt; 
&gt; crasher:
&gt; initial call: riakc\\_pb\\_socket:init/1
&gt; pid: &lt;0.3364.6566&gt;
&gt; registered\\_name: []
&gt; exception exit:
&gt; {{{badrecord,rpbgetreq},[{riak\\_kv\\_pb,iolist,2,[{file,"src/riak\\_kv\\_pb.erl"},{line,48}]},{riak\\_kv\\_pb,encode,2,[{file,"src/r
&gt; iak\\_kv\\_pb.erl"},{line,40}]},{riak\\_pb\\_codec,encode,1,[{file,"src/riak\\_pb\\_codec.erl"},{line,77}]},{riakc\\_pb\\_socket,send\\_request,2,[{file,"src/r
&gt; iakc\\_pb\\_socket.erl"},{line,1280}]},{riakc\\_pb\\_socket,handle\\_call,3,[{file,"src/riakc\\_pb\\_socket.erl"},{line,759}]},{gen\\_server,handle\\_msg,5,[{f
&gt; ile,"gen\\_server.erl"},{line,588}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,227}]}]},[{gen\\_server,terminate,6,[{file,"gen\\_ser
&gt; ver.erl"},{line,747}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,227}]}]}
&gt; 
&gt; 
&gt; I see that now the situation is better and the last master version of
&gt; the riakc rebar.config looks like this:
&gt; 
&gt; {deps, [
&gt; {riak\\_pb, "1.4.0.2", {git, "git://github.com/basho/riak\\_pb",
&gt; {tag, "1.4.0.2"}}}
&gt; ]}.
&gt; 
&gt; That helps. But only a bit.
&gt; Let's look at the riak\\_pb rebar.config...
&gt; https://github.com/basho/riak\\_pb/blob/master/rebar.config
&gt; 
&gt; And voil√†:
&gt; {deps, [
&gt; {protobuffs, "0.8.\\*", {git,
&gt; "git://github.com/basho/erlang\\_protobuffs.git", "master"}}
&gt; ]}.
&gt; 
&gt; New interesting things to come in the future. Just wait for it.
&gt; 
&gt; 
&gt; And if we go through any erlang project on github using rebar we will
&gt; see a lot of the same stuff. No one seems to worry about this much.
&gt; 
&gt; The question is why? Is this me only who facing those issues? It
&gt; doesn't look this. I see messages appearing again and again in rebar
&gt; mailing list and in rebar issues list on github about the same matter.
&gt; People invent hacks and patches to somehow improve the situation.
&gt; For example, the following rebar plugin recursively locks all deps by
&gt; creating a separate rebar.config:
&gt; https://github.com/seth/rebar\\_lock\\_deps\\_plugin
&gt; (and my fork of this: https://github.com/lukyanov/rebar-lock-deps)
&gt; 
&gt; But all of those attempts are just partial solutions. The real
&gt; solution would be to have a single centered dependencies repository,
&gt; like ruby has, for instance. While we, as Erlang community, still do
&gt; not have one, why don't we start \\_never\\_ using masters in our
&gt; rebar.config's and make this a habit?
&gt; 
&gt; I strongly urge Basho to be a good example of this, as you guys always do.
&gt; 
&gt; Thanks.
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

