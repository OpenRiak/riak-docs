---
title: "Re: Connection Pool with Erlang PB Client Necessary?"
description: ""
project: community
lastmod: 2011-07-28T14:32:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04125"
mailinglist_parent_id: "msg04120"
author_name: "Andrew Berman"
project_section: "mailinglistitem"
sent_date: 2011-07-28T14:32:09-07:00
---


Cool, I'll check it out, though there appears to be something wrong
with your account as when I try to view the source, I get an error
back from GitHub.

On Thu, Jul 28, 2011 at 1:55 PM, Joel Meyer  wrote:
&gt;
&gt;
&gt; On Tue, Jul 26, 2011 at 11:35 AM, Andrew Berman  wrote:
&gt;&gt;
&gt;&gt; Thanks for the reply Bryan.  This all makes sense.  I am fairly new to
&gt;&gt; Erlang and wasn't sure if using a gen\\_server solved some of the issues
&gt;&gt; with connections.  From what I've seen a lot of people simply make
&gt;&gt; calls to Riak directly from a resource and so I thought having a
&gt;&gt; gen\\_server in front of Riak would help to manage things better.
&gt;&gt; Apparently it doesn't.
&gt;&gt;
&gt;&gt; So, then, two more questions.  I have used connection pools in Java
&gt;&gt; like C3P0 and they can ramp up connections and then cull connections
&gt;&gt; when there is a period of inactivity.  The only pooler I've found that
&gt;&gt; does this is: https://github.com/seth/pooler .  Do you have any other
&gt;&gt; recommendations on connection poolers?
&gt;
&gt; I'm late to the party, but you could take a look at gen\\_server\\_pool
&gt; (https://github.com/openx/gen\\_server\\_pool). It's a pooling library I wrote
&gt; to provide pooling of gen\\_servers. I've used it mostly for Thrift clients,
&gt; but Anthony (also on the list) uses it to pool riak\\_pb clients in
&gt; webmachine. The basic idea is that you'd call
&gt; gen\\_server\\_pool:start\\_link(...) wherever you'd normally call
&gt; gen\\_server:start\\_link(...) and pass in a few extra args that control min and
&gt; max pool size, as well as idle timeout. You can use the Pid you get back
&gt; from that the same way you'd use the pid of your gen\\_server, except that all
&gt; work gets dispatched to a member of a pool instead of a single gen\\_server.
&gt; To be honest, I haven't tested out the open-source version I posted on
&gt; GitHub (sorry, I've been busy), but it's just a slightly modified version of
&gt; the internal library that's been used in production for several months with
&gt; good results.
&gt; Cheers,
&gt; Joel
&gt;
&gt;&gt;
&gt;&gt; Second, I'm still a little confused on client ID.  I thought client Id
&gt;&gt; represented an actual client, not a connection.  So, in my case, the
&gt;&gt; gen\\_server is one client which makes multiple connections.  After
&gt;&gt; seeing what you wrote and reading a bit more on it, it seems like
&gt;&gt; client Id should just be some random string (base64 encoded) that
&gt;&gt; should be generated on creating a connection.  Is that right?
&gt;&gt;
&gt;&gt; Thanks for your help!
&gt;&gt;
&gt;&gt; Andrew
&gt;&gt;
&gt;&gt; On Tue, Jul 26, 2011 at 9:39 AM, Bryan O'Sullivan 
&gt;&gt; wrote:
&gt;&gt; &gt; On Mon, Jul 25, 2011 at 4:03 PM, Andrew Berman 
&gt;&gt; &gt; wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; I know that this subject has been brought up before, but I'm still
&gt;&gt; &gt;&gt; wondering what the value of a connection pool is with Riak.
&gt;&gt; &gt;
&gt;&gt; &gt; It's a big deal:
&gt;&gt; &gt;
&gt;&gt; &gt; It amortises TCP and PBC connection setup overhead over a number of
&gt;&gt; &gt; requests, thereby reducing average query latency.
&gt;&gt; &gt; It greatly reduces the likelihood that very busy clients and servers
&gt;&gt; &gt; will
&gt;&gt; &gt; run out of limited resources that are effectively invisible, e.g. closed
&gt;&gt; &gt; TCP
&gt;&gt; &gt; connections stuck in TIME\\_WAIT.
&gt;&gt; &gt;
&gt;&gt; &gt; Each of the above is a pretty big deal. Of course, connection pooling
&gt;&gt; &gt; isn't
&gt;&gt; &gt; free.
&gt;&gt; &gt;
&gt;&gt; &gt; If you have many clients talking to a server sporadically, you may end
&gt;&gt; &gt; up
&gt;&gt; &gt; with large numbers of open-and-idle connections on a server, which will
&gt;&gt; &gt; both
&gt;&gt; &gt; consume resources and increase latency for all other clients. This is
&gt;&gt; &gt; usually only a problem with a very large number (many thousands) of
&gt;&gt; &gt; clients
&gt;&gt; &gt; per server, and it usually only arises with poorly written and tuned
&gt;&gt; &gt; connection pooling libraries. But ...
&gt;&gt; &gt; ... Most connection pooling libraries are poorly written and tuned, so
&gt;&gt; &gt; they'll behave pathologically just when you need them not to.
&gt;&gt; &gt; Since you don't set up a connection per request, the requests where you
&gt;&gt; &gt; \\*do\\*
&gt;&gt; &gt; need to set up a connection are going to be more expensive than those
&gt;&gt; &gt; where
&gt;&gt; &gt; you don't, so you'll see jitter in your latency profile. About 99.9% of
&gt;&gt; &gt; users will never, ever care about this.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Since Erlang processes are so small and fast to
&gt;&gt; &gt;&gt; create, is there really any overhead in having the gen\\_server create a
&gt;&gt; &gt;&gt; new connection (with the same client id) each time it needs to access
&gt;&gt; &gt;&gt; Riak?
&gt;&gt; &gt;
&gt;&gt; &gt; Of course. The overhead of Erlang processes has nothing to do with the
&gt;&gt; &gt; cost
&gt;&gt; &gt; of setting up a connection.
&gt;&gt; &gt; Also, you really don't want to be using the same client ID repeatedly
&gt;&gt; &gt; across
&gt;&gt; &gt; different connections. That's an awesome way to cause bugs with vclock
&gt;&gt; &gt; resolution that end up being very very hard to diagnose.
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

