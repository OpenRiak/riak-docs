---
title: "Re: Riak Client Resources,  Deleting a Key Doesn't Remove it from	bucket.keys"
description: ""
project: community
lastmod: 2011-05-26T09:52:25-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03427"
mailinglist_parent_id: "msg03426"
author_name: "Aphyr"
project_section: "mailinglistitem"
sent_date: 2011-05-26T09:52:25-07:00
---


Agreed. In fact, jrecursive pointed out to me last week that vnode 
operations are synchronous. That means that when you call list-keys, not 
only is it going to take a long time (right now upwards of 5 minutes) to 
complete, but while each vnode is returning its list of keys \\*it blocks 
any other requests\\*.


While list-keys is an unfortunate necessity for some things, its use 
should be minimized if you're going to get to any appreciable (100M 
keys) scale. I don't even know how we're going to use it at all above a 
billion. Possibly by listing the keys periodically from bitcask 
directly, and maintaining an index ourselves.


--Kyle

On 05/26/2011 09:40 AM, Sean Cribbs wrote:

With recent commits (
https://github.com/seancribbs/ripple/compare/35d7323fb0e179c8c971...da3ab71a19d194c65a7b

), it is cached until you either refresh it manually by passing :reload
=&gt; true or a block (for streaming key lists). This was the compromise
reached in that pull-request.

All of this caching discussion glosses over the fact that you \\*should
not list keys\\* in any real application. It really begs the question --
how often do you list keys in Redis, or memcached? I suspect that
generally you don't. This isn't a relational database. (Also, how often
do you actually do a full-table scan in MySQL? You don't if you're sane
-- you use an index, or even LIMIT + OFFSET.)

I'm tempted to remove Document::all and make Bucket#keys harder to
access, but the balance between discouraging bad behavior and exposing
available functionality is a hard one to strike. I don't want new
developers to immediately use list-keys and then be discouraged from
using Riak because it's slow; on the other hand, it /can be useful/ in
some circumstances. In those cases where it's useful, the developer
should probably be responsible enough to request the key list only once;
the caching behavior simply does this for them. I guess whether it
/should/ do this for them is the issue at hand.

All that said, I'm really torn on this issue, and the same problem
applies to full-bucket MapReduce. Caveat emptor.

Sean Cribbs &gt;
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On May 26, 2011, at 10:35 AM, Jonathan Langevin wrote:


How long is the key list cached like that, naturally?\\*


 \\*/
/\\*Jonathan Langevin\\*/
Systems Administrator
\\*Loom Inc.\\*
Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com
 - www.loomlearning.com
 - Skype: intel352

/\\*

\\*


On Thu, May 26, 2011 at 10:35 AM, Sean Cribbs &gt; wrote:

 Keith,

 There was a pull-request issue out for this on the Github project
 (https://github.com/seancribbs/ripple/pull/168). For various
 reasons, the list of keys is memoized in the Riak::Bucket
 instance. Passing :reload =&gt; true to the #keys method will cause
 it to refresh. I like to discourage list-keys, but with the
 memoized list you don't shoot yourself in the foot as often.

 Sean Cribbs &gt;
 Developer Advocate
 Basho Technologies, Inc.
 http://basho.com/

 On May 26, 2011, at 10:29 AM, Keith Bennett wrote:

 &gt; All -
 &gt;
 &gt; I just started working with Riak, and am using the riak-client
 Ruby gem.
 &gt;
 &gt; When I delete a key from a bucket, and try to fetch the value
 associated with that key, I get a 404 error (which is reasonable).
 However, it remains in the bucket's list of keys (i.e. the value
 returned by bucket.keys(). Why is the key still reported to exist
 in the bucket? Is bucket.keys cached, and therefore unaware of the
 deletion? Here's a riak-client Ruby script and its output in irb
 that illustrates this:
 &gt;
 &gt; ree-1.8.7-2010.02 :001 &gt; require 'riak'
 &gt; =&gt; true
 &gt; ree-1.8.7-2010.02 :002 &gt;
 &gt; ree-1.8.7-2010.02 :003 &gt; client = Riak::Client.new
 &gt; =&gt; #&gt;
 &gt; ree-1.8.7-2010.02 :004 &gt; bucket = client['links']
 &gt; =&gt; #
 &gt; ree-1.8.7-2010.02 :005 &gt; key = bucket.keys.first
 &gt; =&gt; "4000-17.xml"
 &gt; ree-1.8.7-2010.02 :006 &gt; object = bucket[key]
 &gt; =&gt; #
 &gt; ree-1.8.7-2010.02 :007 &gt; object.delete
 &gt; =&gt; #
 &gt; ree-1.8.7-2010.02 :008 &gt; bucket.keys.first
 &gt; =&gt; "4000-17.xml"
 &gt; ree-1.8.7-2010.02 :009 &gt; object = bucket[key]
 &gt; Riak::HTTPFailedRequest: Expected [200, 300] from Riak but
 received 404. not found
 &gt;
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:55:in
 `perform'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1054:in
 `request'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:2142:in
 `reading\\_body'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1053:in
 `request'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1037:in
 `request'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:543:in
 `start'
 &gt; from
 
/Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1035:in
 `request'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:47:in
 `perform'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:46:in
 `tap'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:46:in
 `perform'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/http\\_backend/transport\\_methods.rb:59:in
 `get'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/http\\_backend.rb:72:in
 `fetch\\_object'
 &gt; from
 
/Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/bucket.rb:101:in
 `[]'
 &gt; from riak-delete-failure.rb:9
 &gt;
 &gt; Thanks,
 &gt; Keith
 &gt;
 &gt;
 &gt;
 &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
 &gt; riak-users mailing list
 &gt; riak-users@lists.basho.com 
 &gt;
 http://lists.basho.com/mailman/listinfo/riak-users\\_listsbasho.com
 


 \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
 riak-users mailing list
 riak-users@lists.basho.com 
 http://lists.basho.com/mailman/listinfo/riak-users\\_listsbasho.com
 






\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

