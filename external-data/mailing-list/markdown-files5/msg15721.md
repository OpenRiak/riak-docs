---
title: "Re: Simple 3 node test cluster eating all my memory"
description: ""
project: community
lastmod: 2015-02-13T10:08:58-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15721"
mailinglist_parent_id: "msg15700"
author_name: "Ciprian Manea"
project_section: "mailinglistitem"
sent_date: 2015-02-13T10:08:58-08:00
---


Hi Simon,

Unfortunately we seem to have the same bug [0] mentioned by Juan Luis also
in the (1.4.9) release you're testing against. A fix is already being
worked on and will be available in an upcoming Riak release.

[0] https://github.com/basho/riak\\_kv/issues/1064

Thank you,
Ciprian

On Thu, Feb 12, 2015 at 3:19 PM, Simon Hartley &lt;
simon.hart...@williamhill.com&gt; wrote:

&gt; Brilliant Thanks.
&gt;
&gt;
&gt;
&gt; Is there an equivalent document and spreadsheet (and link form one to the
&gt; other) for the in-memory backend. Given we are not using LevelDB I’ve never
&gt; read that part of the docs.
&gt;
&gt;
&gt;
&gt; Given we have limited the memory per in-memory storage instance (i.e. per
&gt; vnode) to 32MB (in the max\\_memory setting), and that we would expect ~43
&gt; vnodes per server (128 ring size / 3 nodes = ~43 vnodes per server), that
&gt; gives a maximum backend memory usage of 43 \\* 32MB = 1376MB in normal
&gt; operation.
&gt;
&gt;
&gt;
&gt; This is significantly less than the amount of memory we see Riak trying to
&gt; grab. Also the spiking behaviour of the memory usage is still unexplained.
&gt;
&gt;
&gt;
&gt; How do we estimate the memory requirements of the remainder of the vnode
&gt; system (i.e. everything but the storage component)?
&gt;
&gt;
&gt;
&gt; Thanks,
&gt;
&gt;
&gt;
&gt; Simon.
&gt;
&gt;
&gt;
&gt; \\*From:\\* Ciprian Manea [mailto:cipr...@basho.com]
&gt; \\*Sent:\\* 12 February 2015 12:56
&gt;
&gt; \\*To:\\* Simon Hartley
&gt; \\*Cc:\\* riak-users@lists.basho.com
&gt; \\*Subject:\\* Re: Simple 3 node test cluster eating all my memory
&gt;
&gt;
&gt;
&gt; Hi Simon,
&gt;
&gt;
&gt;
&gt; The spreadsheet is referenced from the LevelDB's parameter planning [0].
&gt;
&gt;
&gt;
&gt; A ring\\_size defines the number of vnodes (virtual nodes) a riak cluster
&gt; runs internally, and as each virtual node is implemented as an Erlang
&gt; process, the bigger the ring\\_size is, the more memory is required from the
&gt; operating system.
&gt;
&gt;
&gt;
&gt; [0]
&gt; http://docs.basho.com/riak/1.4.12/ops/advanced/backends/leveldb/#Parameter-Planning
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; Regards,
&gt;
&gt; Ciprian
&gt;
&gt;
&gt;
&gt; On Thu, Feb 12, 2015 at 1:44 PM, Simon Hartley &lt;
&gt; simon.hart...@williamhill.com&gt; wrote:
&gt;
&gt; Hi Ciprian,
&gt;
&gt;
&gt;
&gt; Thanks for the answer.
&gt;
&gt;
&gt;
&gt; According to Riak doc “Cluster-Capacity-Planning” (
&gt; http://docs.basho.com/riak/1.4.9/ops/building/planning/cluster/#Ring-Size-Number-of-Partitions
&gt; )
&gt;
&gt;
&gt;
&gt; “The default number of partitions in a Riak cluster is 64. This works for
&gt; smaller clusters, but if you plan to grow your cluster past 5 nodes it is
&gt; recommended you consider a larger ring size.”
&gt;
&gt;
&gt;
&gt; In our staging and production environments we have 5 nodes, and this will
&gt; likely grow, so we chose a ring assize of 128. We like to keep the same
&gt; config across all out environments where possible, so we replicated this in
&gt; the 3-node test environment.
&gt;
&gt;
&gt;
&gt; There is nothing in this document to suggest a upper limit on ring size
&gt; based on number of nodes (or capacity of individual nodes). From where in
&gt; the Riak docs is this spreadsheet referenced?
&gt;
&gt;
&gt;
&gt; I can rebuild the cluster with ring size 16 if necessary, but can you
&gt; explain why the current larger ring size produces the sudden memory spike
&gt; and subsequent crash?
&gt;
&gt;
&gt;
&gt; Thanks,
&gt;
&gt;
&gt; Simon.
&gt;
&gt;
&gt;
&gt; \\*From:\\* Ciprian Manea [mailto:cipr...@basho.com]
&gt; \\*Sent:\\* 12 February 2015 11:26
&gt; \\*To:\\* Simon Hartley
&gt; \\*Cc:\\* riak-users@lists.basho.com
&gt; \\*Subject:\\* Re: Simple 3 node test cluster eating all my memory
&gt;
&gt;
&gt;
&gt; Hi Simon,
&gt;
&gt;
&gt;
&gt; Looking at this problem from another angle, a ring size of 128 is too
&gt; large for just 3 servers with 4 GB RAM each. For instance when dimensioning
&gt; a cluster with LevelDB backend we recommend our customers to observe the
&gt; calculations on this spreadsheet [0].
&gt;
&gt;
&gt;
&gt; Filling the above spreadsheet with your system's details (3 nodes, 4 GB
&gt; RAM) we get a ring-size of 16 for the riak cluster. Would you be able to
&gt; recreate the cluster with ring-size 16 and test again?
&gt;
&gt;
&gt;
&gt; [0]
&gt; https://docs.google.com/spreadsheet/ccc?key=0AnW\\_U8Qe8NdYdGk2V3Qza0VRNkxyRFNGUVVCV0c3V3c&usp=sharing#gid=0
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; Thanks,
&gt;
&gt; Ciprian
&gt;
&gt;
&gt;
&gt; On Thu, Feb 12, 2015 at 11:51 AM, Simon Hartley &lt;
&gt; simon.hart...@williamhill.com&gt; wrote:
&gt;
&gt; Hi,
&gt;
&gt;
&gt;
&gt; We have a simple 3 node test cluster, and we are seeing this cluster
&gt; fall-over under quite modest loads, 2-3 times a day with the node reporting
&gt; out of memory problems.
&gt;
&gt;
&gt;
&gt; Our basic details are:
&gt;
&gt;
&gt;
&gt; · Riak 1.4.9
&gt;
&gt; · 3 nodes, each being:
&gt;
&gt; o A virtual RedHat EL
&gt;
&gt; o 2 x 2.2GHz CPU
&gt;
&gt; o 4GB RAM
&gt;
&gt; · In-memory back end
&gt;
&gt; · 128 segment ring
&gt;
&gt;
&gt;
&gt; We have tried to limit the in-memory max memory by the following setting
&gt; in app.config:
&gt;
&gt;
&gt;
&gt; %% Memory Config
&gt;
&gt; {memory\\_backend, [
&gt;
&gt; {max\\_memory, 32}, %% 32 megabytes
&gt;
&gt; {ttl, 86400} %% 1 Day in seconds
&gt;
&gt; ]},
&gt;
&gt;
&gt;
&gt; The behaviour we are seeing is a sudden and rapid increase in memory
&gt; allocated to riak, up to 100% available RAM, and then a crash.
&gt;
&gt;
&gt;
&gt; This is happening on all 3 nodes (at different times).
&gt;
&gt;
&gt;
&gt; When looking through the console.log just prior to the out of memory /
&gt; crash we see log entries similar to the following appearing:
&gt;
&gt;
&gt;
&gt; 2015-02-11 16:50:27.356 [info]
&gt; &lt;0.98.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:92 monitor large\\_heap
&gt; &lt;0.238.0&gt;
&gt; [{name,riak\\_core\\_gossip},{initial\\_call,{riak\\_core\\_gossip,init,1}},{almost\\_current\\_function,{riak\\_core\\_gossip,update\\_gossip\\_vers
&gt;
&gt; ion,1}},{message\\_queue\\_len,78}]
&gt; [{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,47828850},{mbuf\\_size,0},{stack\\_size,15},{old\\_heap\\_size,0},{heap\\_size,13944475}]
&gt;
&gt;
&gt;
&gt; We can’t see any errors at the appropriate times in the error.log
&gt;
&gt;
&gt;
&gt; We see the following in erlang.log.1:
&gt;
&gt;
&gt;
&gt; ===== ALIVE Wed Feb 11 17:00:24 GMT 2015
&gt;
&gt; /usr/lib64/riak/lib/os\\_mon-2.2.9/priv/bin/memsup: Erlang has closed.
&gt;
&gt; Erlang has closed
&gt;
&gt;
&gt;
&gt; Crash dump was written to: /var/log/riak/erl\\_crash.dump
&gt;
&gt; eheap\\_alloc: Cannot allocate 4454408120 bytes of memory
&gt;
&gt;
&gt;
&gt; =====
&gt;
&gt;
&gt;
&gt; Anyone any ideas?
&gt;
&gt;
&gt;
&gt; \\*Simon Hartley\\*
&gt;
&gt; Solutions Architect
&gt;
&gt;
&gt;
&gt; Email: simon.hart...@williamhill.com
&gt;
&gt; Skype: \\*+44 (0)113 397 6747 &lt;%2B44%20%280%29113%20397%206747&gt;\\*
&gt;
&gt; Skype: \\*sijomons\\*
&gt;
&gt;
&gt;
&gt; \\*William Hill Online\\*, St. Johns, Merrion St. Leeds, LS2 8LQ
&gt;
&gt; [image: Description: Description: Description:
&gt; cid:image002.png@01CC2FFA.24244CF0]
&gt;
&gt;
&gt;
&gt; Confidentiality: The contents of this e-mail and any attachments
&gt; transmitted with it are intended to be confidential to the intended
&gt; recipient; and may be privileged or otherwise protected from disclosure. If
&gt; you are not an intended recipient of this e-mail, do not duplicate or
&gt; redistribute it by any means. Please delete it and any attachments and
&gt; notify the sender that you have received it in error. This e-mail is sent
&gt; by a William Hill PLC group company. The William Hill group companies
&gt; include, among others, William Hill PLC (registered number 4212563),
&gt; William Hill Organization Limited (registered number 278208), William Hill
&gt; US HoldCo Inc, WHG (International) Limited (registered number 99191) and
&gt; WHG Trading Limited (registered number 101439). Each of William Hill PLC,
&gt; William Hill Organization Limited is registered in England and Wales and
&gt; has its registered office at Greenside House, 50 Station Road, Wood Green,
&gt; London N22 7TP. William Hill U.S. HoldCo, Inc. is 160 Greentree Drive,
&gt; Suite 101, Dover 19904, Kent, Delaware, United States of America. Each of
&gt; WHG (International) Limited and WHG Trading Limited is registered in
&gt; Gibraltar and has its registered office at 6/1 Waterport Place, Gibraltar.
&gt; Unless specifically indicated otherwise, the contents of this e-mail are
&gt; subject to contract; and are not an official statement, and do not
&gt; necessarily represent the views, of William Hill PLC, its subsidiaries or
&gt; affiliated companies. Please note that neither William Hill PLC, nor its
&gt; subsidiaries and affiliated companies can accept any responsibility for any
&gt; viruses contained within this e-mail and it is your responsibility to scan
&gt; any emails and their attachments. William Hill PLC, its subsidiaries and
&gt; affiliated companies may monitor e-mail traffic data and also the content
&gt; of e-mails for effective operation of the e-mail system, or for security,
&gt; purposes..
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt; Confidentiality: The contents of this e-mail and any attachments
&gt; transmitted with it are intended to be confidential to the intended
&gt; recipient; and may be privileged or otherwise protected from disclosure. If
&gt; you are not an intended recipient of this e-mail, do not duplicate or
&gt; redistribute it by any means. Please delete it and any attachments and
&gt; notify the sender that you have received it in error. This e-mail is sent
&gt; by a William Hill PLC group company. The William Hill group companies
&gt; include, among others, William Hill PLC (registered number 4212563),
&gt; William Hill Organization Limited (registered number 278208), William Hill
&gt; US HoldCo Inc, WHG (International) Limited (registered number 99191) and
&gt; WHG Trading Limited (registered number 101439). Each of William Hill PLC,
&gt; William Hill Organization Limited is registered in England and Wales and
&gt; has its registered office at Greenside House, 50 Station Road, Wood Green,
&gt; London N22 7TP. William Hill U.S. HoldCo, Inc. is 160 Greentree Drive,
&gt; Suite 101, Dover 19904, Kent, Delaware, United States of America. Each of
&gt; WHG (International) Limited and WHG Trading Limited is registered in
&gt; Gibraltar and has its registered office at 6/1 Waterport Place, Gibraltar.
&gt; Unless specifically indicated otherwise, the contents of this e-mail are
&gt; subject to contract; and are not an official statement, and do not
&gt; necessarily represent the views, of William Hill PLC, its subsidiaries or
&gt; affiliated companies. Please note that neither William Hill PLC, nor its
&gt; subsidiaries and affiliated companies can accept any responsibility for any
&gt; viruses contained within this e-mail and it is your responsibility to scan
&gt; any emails and their attachments. William Hill PLC, its subsidiaries and
&gt; affiliated companies may monitor e-mail traffic data and also the content
&gt; of e-mails for effective operation of the e-mail system, or for security,
&gt; purposes..
&gt;
&gt;
&gt; Confidentiality: The contents of this e-mail and any attachments
&gt; transmitted with it are intended to be confidential to the intended
&gt; recipient; and may be privileged or otherwise protected from disclosure. If
&gt; you are not an intended recipient of this e-mail, do not duplicate or
&gt; redistribute it by any means. Please delete it and any attachments and
&gt; notify the sender that you have received it in error. This e-mail is sent
&gt; by a William Hill PLC group company. The William Hill group companies
&gt; include, among others, William Hill PLC (registered number 4212563),
&gt; William Hill Organization Limited (registered number 278208), William Hill
&gt; US HoldCo Inc, WHG (International) Limited (registered number 99191) and
&gt; WHG Trading Limited (registered number 101439). Each of William Hill PLC,
&gt; William Hill Organization Limited is registered in England and Wales and
&gt; has its registered office at Greenside House, 50 Station Road, Wood Green,
&gt; London N22 7TP. William Hill U.S. HoldCo, Inc. is 160 Greentree Drive,
&gt; Suite 101, Dover 19904, Kent, Delaware, United States of America. Each of
&gt; WHG (International) Limited and WHG Trading Limited is registered in
&gt; Gibraltar and has its registered office at 6/1 Waterport Place, Gibraltar.
&gt; Unless specifically indicated otherwise, the contents of this e-mail are
&gt; subject to contract; and are not an official statement, and do not
&gt; necessarily represent the views, of William Hill PLC, its subsidiaries or
&gt; affiliated companies. Please note that neither William Hill PLC, nor its
&gt; subsidiaries and affiliated companies can accept any responsibility for any
&gt; viruses contained within this e-mail and it is your responsibility to scan
&gt; any emails and their attachments. William Hill PLC, its subsidiaries and
&gt; affiliated companies may monitor e-mail traffic data and also the content
&gt; of e-mails for effective operation of the e-mail system, or for security,
&gt; purposes..
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

