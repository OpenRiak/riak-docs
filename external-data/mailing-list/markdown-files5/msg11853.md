---
title: "Re: Riak 1.4 - fastest way to count all records in bucket (100+	millions)"
description: ""
project: community
lastmod: 2013-08-01T13:48:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11853"
mailinglist_parent_id: "msg11852"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2013-08-01T13:48:55-07:00
---


What's the underlying goal of getting this count of records in a bucket? Do
you want to just have a live count or will you be eventually performing
additional filters on the count?

One option might be to use counters [1] to hold these counts, instead of
attempting to compute them on the fly.

In direct answer to your question - there's no faster way to make this
happen apart from speeding up disks and may playing around with some of the
MapReduce arguments, like enabling pre-reduce. You're always going to have
to scan the cluster to find keys matching your criteria (at least with
LevelDB).

[1]: http://basho.com/counters-in-riak-1-4/



---
Jeremiah Peschka - Founder, Brent Ozar Unlimited
MCITP: SQL Server 2008, MVP
Cloudera Certified Developer for Apache Hadoop


On Thu, Aug 1, 2013 at 12:01 PM, Christian Rosnes &lt;
christian.ros...@gmail.com&gt; wrote:

&gt;
&gt;
&gt;
&gt; On Wed, Jul 31, 2013 at 9:54 AM, Christian Rosnes &lt;
&gt; christian.ros...@gmail.com&gt; wrote:
&gt;
&gt;
&gt;&gt; I have 4 node Riak 1.4 test cluster on Azure
&gt;&gt; (Large: 4core, 7GB RAM instances).
&gt;&gt;
&gt;&gt;
&gt; Ran 7, slightly different, Erlang map-reduce jobs overnight to count the
&gt; 118 million
&gt; records in the 'entries' bucket. There were no other user requests running
&gt; at the time of testing. Please take the test-results with a grain of salt,
&gt; YMMV.
&gt; Scripts used listed below.
&gt;
&gt; Christian
&gt; @NorSoulx
&gt;
&gt; \\*Here are the results:\\*
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.1.sh\\*
&gt; Counting all records in bucket: entries (Thu Aug 1 09:07:53 UTC 2013)
&gt; [118 553 863]
&gt; real \\* 201m46.355s\\*
&gt; user 0m0.199s
&gt; sys 0m0.419s
&gt; Done: Thu Aug 1 12:29:39 UTC 2013
&gt;
&gt; ----
&gt; Running script\\* count.all.records.in.bucket.2.sh\\*
&gt; Counting all records in bucket: entries (Wed Jul 31 19:24:40 UTC 2013)
&gt; [118 553 863]
&gt; real \\*148m33.854s\\* (ran this a second time and the result was then \\*
&gt; 144m\\*)
&gt; user 0m0.185s
&gt; sys 0m0.423s
&gt; Done: Wed Jul 31 21:53:13 UTC 2013
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.3.sh\\*
&gt; Counting all records in bucket: entries (Wed Jul 31 21:53:13 UTC 2013)
&gt; [118 553 863]
&gt; real \\*129m51.310s\\*
&gt; user 0m0.136s
&gt; sys 0m0.327s
&gt; Done: Thu Aug 1 00:03:05 UTC 2013
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.4.sh\\*
&gt; Countuing all records in bucket: entries (Thu Aug 1 00:03:05 UTC 2013)
&gt; [118 553 863]
&gt; real \\*138m29.816s\\*
&gt; user 0m0.105s
&gt; sys 0m0.464s
&gt; Done: Thu Aug 1 02:21:35 UTC 2013
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.5.sh\\*
&gt; Counting all records in bucket: entries (Thu Aug 1 02:21:35 UTC 2013)
&gt; [118 553 863]
&gt; real \\*132m10.353s\\*
&gt; user 0m0.129ss
&gt; sys 0m0.337s
&gt; Done: Thu Aug 1 04:33:45 UTC 2013
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.6.sh\\*
&gt; Counting all records in bucket: entries (Thu Aug 1 04:33:45 UTC 2013)
&gt; [118 553 863]
&gt; real \\*137m16.386s\\*
&gt; user 0m0.122s
&gt; sys 0m0.363s
&gt; Done: Thu Aug 1 06:51:01 UTC 2013
&gt;
&gt; ----
&gt; Running script \\*count.all.records.in.bucket.7.sh\\*
&gt; Counting all records in bucket: entries (Thu Aug 1 06:51:01 UTC 2013)
&gt;
&gt; [118 553 863]
&gt; real \\*136m51.149s\\*
&gt; user 0m0.297s
&gt; sys 0m0.225s
&gt; Done: Thu Aug 1 09:07:53 UTC 2013
&gt;
&gt; =============================
&gt;
&gt; \\*Scripts:\\*
&gt;
&gt; count.all.records.in.bucket.1.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred -H 'Content-Type:
&gt; application/json' -d '{
&gt; "inputs":"entries",
&gt; "query":[
&gt;
&gt; {"map":{"language":"erlang","module":"riak\\_mapreduce\\_utils",
&gt; "function":"map\\_id","keep":false}},
&gt;
&gt; {"reduce" : {"language" : "erlang", "module" :
&gt; "riak\\_kv\\_mapreduce", "function" : "reduce\\_count\\_inputs" }},
&gt; ],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; count.all.records.in.bucket.2.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":{
&gt; "bucket":"entries",
&gt; "index":"$bucket",
&gt; "key":"entries"
&gt; },
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt; "arg":{"reduce\\_phase\\_batch\\_size":1000}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; count.all.records.in.bucket.3.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":"entries",
&gt;
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt; "arg":{"do\\_prereduce":true}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; count.all.records.in.bucket.4.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":"entries",
&gt;
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt;
&gt; "arg":{"reduce\\_phase\\_batch\\_size":100000,"do\\_prereduce":true}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; count.all.records.in.bucket.5.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":{
&gt; "bucket":"entries",
&gt; "index":"$bucket",
&gt; "key":"entries"
&gt; },
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt; "arg":{"do\\_prereduce":true}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt; count.all.records.in.bucket.6.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":{
&gt; "bucket":"entries",
&gt; "index":"$bucket",
&gt; "key":"entries"
&gt; },
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt; "arg":{"do\\_prereduce":false}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; count.all.records.in.bucket.7.sh
&gt;
&gt; --------------------------------
&gt; time curl -XPOST http://localhost:8098/mapred \\
&gt; -H 'Content-Type: application/json' \\
&gt; -d '{"inputs":{
&gt; "bucket":"entries",
&gt; "index":"$bucket",
&gt; "key":"entries"
&gt; },
&gt; "query":[{"reduce":{"language":"erlang",
&gt; "module":"riak\\_kv\\_mapreduce",
&gt; "function":"reduce\\_count\\_inputs",
&gt; "arg":{"reduce\\_phase\\_batch\\_size":10000}
&gt; }
&gt; }],
&gt; "timeout": 90000000}'
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

