---
title: "Re: Differences between riak_client and	riak_kv_mrc_pipe	MapReduce	when one node is down."
description: ""
project: community
lastmod: 2013-01-31T10:48:15-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09950"
mailinglist_parent_id: "msg09946"
author_name: "gunin"
project_section: "mailinglistitem"
sent_date: 2013-01-31T10:48:15-08:00
---


I'm try fix this bug.
1. Add fucntion for generating ConsHashCookie in riak\\_kv\\_mrc\\_pipe
const\\_hash\\_cookie()-&gt;
 Random = chash:key\\_of(now()),
 {ok, Ring} = riak\\_core\\_ring\\_manager:get\\_my\\_ring(),
 NodeCount = length(riak\\_core\\_ring:all\\_members(Ring)),
 case riak\\_core\\_apl:get\\_primary\\_apl(Random,NodeCount,riak\\_pipe) of
 [{{Partition, \\_Node},\\_}|\\_]-&gt;
 riak\\_pipe\\_vnode:hash\\_for\\_partition(Partition);
 \\_-&gt;
 Random
 end.
It's taking account of which nodes are up.
2. Remove Hash = chash:key\\_of(ConstHashCookie) in reduce2pipe function.

After that all work fine.

May be I must write const\\_hash\\_cookie more accurate and push this changed to 
github?

----- Исходное сообщение -----
От: gu...@mail.mipt.ru
Кому: "Bryan Fink" 
Копия: "Riak-Users" 
Отправленные: Четверг, 31 Январь 2013 г 21:51:21
Тема: Re: Differences between riak\\_client and riak\\_kv\\_mrc\\_pipe MapReduce 
when one node is down.

Hello Bryan.
I'm detect problem.

Problem is in reduce phase.

1. See riak\\_kv\\_mrc\\_pipe:mr2pipe\\_phases implementation. It convert MapReduce job 
spec to riak\\_pipe spec. 
In this fun created ConstHashCookie as Now = now(), and use it as chashfun 
value for fitting in reduce phase.
This generated value actually used in riak\\_kv\\_w\\_reduce:done function, you try 
make prereduce not reduced data and send to output.
But output vnode in that case is
preflist for ConstHashCookie,i.e. some random value and n\\_val for this phase is 
always 1, that why sometimes calculated perflist for this phase is empty.

Do you have any suggestion how we can fix it?

Thanks,
Alexander Gunin.


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

