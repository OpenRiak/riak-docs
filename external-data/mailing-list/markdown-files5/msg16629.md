---
title: "Re: Deleted keys come back"
description: ""
project: community
lastmod: 2015-10-07T17:12:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16629"
mailinglist_parent_id: "msg16617"
author_name: "Kota Uenishi"
project_section: "mailinglistitem"
sent_date: 2015-10-07T17:12:17-07:00
---


I'd also recommend to have "allow\\_mult" as true to prevent
resurrection caused by sloppy quorum, handoffs or any network
separation. Also, to make sure your data eventually consistent, R+W
should be &gt; N. Your case is 1+1, not &gt;2.

On Wed, Oct 7, 2015 at 10:19 PM, Dmitri Zagidulin  wrote:
&gt; Hello,
&gt;
&gt; There are two things going on here: the W quorum value of the write and
&gt; delete operations, and possibly the delete\\_mode setting.
&gt;
&gt; Let's walk through the scenario.
&gt; You're writing to a 2 node cluster, two copies of each object (n\\_val=2),
&gt; with your write quorum of 1 (W=1).
&gt;
&gt; So that's possibility #1 -- there's no guarantee that your writes succeed
&gt; with both replicas. (It could've just written one, and the other one is
&gt; missing).
&gt;
&gt; Then you're doing a List Keys (to delete the objects), which runs with an
&gt; implicit quorum of R=1. (Meaning, it only contacts half of the replicas, and
&gt; lists them.) So (if possibility #1 happened, above) the list keys could have
&gt; not returned some keys, the first time around. (Because it may have
&gt; contacted the partitions that had missing replicas). Then you deleted, ran
&gt; another List Keys, and that one could have returned the keys that it missed
&gt; the first time.
&gt;
&gt; Possibility #2 -- your deletes are using W=1, meaning, they're only waiting
&gt; for the delete operation from 1 replica to respond, before returning
&gt; success. So, it's possible that a delete operation removed just one replica,
&gt; but the second one still exists. And the second List Keys can now pick up
&gt; the not-deleted replica.
&gt;
&gt; Possibility #3 -- by default, the delete\\_mode is set to keep deleted objects
&gt; for 3 seconds. So, if you ran your deletes, and then re-ran a List Keys
&gt; before the 3 seconds expired, you could pick up some keys.
&gt;
&gt; The upshot of all this is:
&gt; - Use W=2 when writing and deleting. (That is, your W value should be the
&gt; same as your N value).
&gt;
&gt; - If that doesn't work, set delete\\_mode to 'immediate' in the config.
&gt; Specifically, delete\\_mode is set in the advanced.config file
&gt; (http://docs.basho.com/riak/latest/ops/advanced/configs/configuration-files/#Advanced-Configuration
&gt; ). So, my advanced.config file looks like this:
&gt;
&gt; [
&gt; {riak\\_kv,
&gt; [
&gt; {delete\\_mode, immediate}
&gt; ]}
&gt; }
&gt; ].
&gt;
&gt; Also, if you're deleting things for unit tests, there's an easier way.
&gt; Instead of deleting the bucket object-by-object, you can just stop the node,
&gt; and clear the bitcask (or leveldb) data directory. (That's going to get rid
&gt; of all the data in the cluster, which is what you want to do for unit tests
&gt; anyways.)
&gt;
&gt; You can learn more about these topics on the following pages:
&gt; \\* http://docs.basho.com/riak/latest/ops/advanced/deletion/
&gt; \\*
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2011-October/006048.html
&gt; (mailing list post introducing delete\\_mode)
&gt; \\* http://basho.com/posts/technical/riaks-config-behaviors-part-3/ (the
&gt; Tombstones section)
&gt;
&gt; Dmitri
&gt;
&gt;
&gt;
&gt;
&gt; On Wed, Oct 7, 2015 at 1:35 PM, mtakahashi-ivi 
&gt; wrote:
&gt;&gt;
&gt;&gt; Hello,
&gt;&gt;
&gt;&gt; I'm using riak KV in 2 nodes cluster.
&gt;&gt; I inserted hundreds of key/value pair and deleted all keys in a bucket.
&gt;&gt; After above process, I can get some keys if I get list of keys in the
&gt;&gt; bucket.
&gt;&gt; Why those keys remain? How do I delete keys reliably?
&gt;&gt; If I increase number of nodes to 5 , I can delete all keys in the bucket
&gt;&gt; as
&gt;&gt; same way as I did.
&gt;&gt; My bucket property is the following.
&gt;&gt;
&gt;&gt; ----------------------
&gt;&gt; {
&gt;&gt; "props": {
&gt;&gt; "name": "BUCKET\\_A",
&gt;&gt; "active": true,
&gt;&gt; "allow\\_mult": false,
&gt;&gt; "basic\\_quorum": false,
&gt;&gt; "big\\_vclock": 50,
&gt;&gt; "chash\\_keyfun": {
&gt;&gt; "mod": "riak\\_core\\_util",
&gt;&gt; "fun": "chash\\_std\\_keyfun"
&gt;&gt; },
&gt;&gt; "claimant": "riak@172.17.0.171",
&gt;&gt; "dvv\\_enabled": true,
&gt;&gt; "dw": "quorum",
&gt;&gt; "last\\_write\\_wins": false,
&gt;&gt; "linkfun": {
&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker",
&gt;&gt; "fun": "mapreduce\\_linkfun"
&gt;&gt; },
&gt;&gt; "n\\_val": 2,
&gt;&gt; "notfound\\_ok": false,
&gt;&gt; "old\\_vclock": 86400,
&gt;&gt; "postcommit": [],
&gt;&gt; "pr": 0,
&gt;&gt; "precommit": [],
&gt;&gt; "pw": 0,
&gt;&gt; "r": 1,
&gt;&gt; "rw": "quorum",
&gt;&gt; "search\\_index": "BUCKET\\_A\\_INDEX",
&gt;&gt; "small\\_vclock": 50,
&gt;&gt; "w": 1,
&gt;&gt; "young\\_vclock": 20
&gt;&gt; }
&gt;&gt; }
&gt;&gt;
&gt;&gt;
&gt;&gt; Masanori Takahashi
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; View this message in context:
&gt;&gt; http://riak-users.197444.n3.nabble.com/Deleted-keys-come-back-tp4033536.html
&gt;&gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
Kota UENISHI / @kuenishi
Basho Japan KK

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

