---
title: "Re: Socket returned short packet length 0 - expected 4"
description: ""
project: community
lastmod: 2014-04-17T13:38:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14111"
mailinglist_parent_id: "msg14110"
author_name: "Jason Wang"
project_section: "mailinglistitem"
sent_date: 2014-04-17T13:38:34-07:00
---


Sean -

Unfortunately we do not see any errors logged in any of the files
(console.log.x, erlang.log.x, error.log.x and crash.log.x). Is there
another level of logging we should enable? (note: I sent our log files
directly to your basho email address).

Hosting environment: AWS EC2 via VPC and dedicated instances
OS: CentOS release 6.4 (Final)
Infrastructure: No servers between the client and the Riak servers.

Jason


On Thu, Apr 17, 2014 at 11:57 AM, Sean Cribbs  wrote:

&gt; Jason,
&gt;
&gt; It's really hard to tell what's going on without more information about
&gt; the environment.
&gt;
&gt; Reviewing the manpage for recv (the C API behind socket.recv), you can see
&gt; that the call returns 0 if the connection is closed. Python interprets this
&gt; as an empty buffer rather than an error condition.
&gt;
&gt; Now, why would the server-side close the connection? The only thing I can
&gt; think of is that there is an unhandled error path in the server code such
&gt; that the Erlang process serving the requests exits abnormally, and the
&gt; linked server socket shuts down as a result. This is why I asked about the
&gt; error logs from your Riak nodes.
&gt;
&gt; So, any additional information you can give would be helpful, especially
&gt; what your deployment environment looks like. For example, are you on a
&gt; cloud provider or your own hardware? What OS/distribution are you using?
&gt; What sorts of other infrastructure is deployed for your app?
&gt;
&gt;
&gt; On Thu, Apr 17, 2014 at 12:43 PM, Jason Wang  wrote:
&gt;
&gt;&gt; Sean,
&gt;&gt;
&gt;&gt; RE http vs pbc port: Verified that our production environment is using
&gt;&gt; the pbc protocol on port 8087.
&gt;&gt;
&gt;&gt; RE crashlog: There are no entries in console.log, crash.log and error.log
&gt;&gt; for over a month.
&gt;&gt;
&gt;&gt; RE HAprodxy: Our clients are connecting to the Riak servers. No reverse
&gt;&gt; proxy systems are in between.
&gt;&gt;
&gt;&gt; Anything else I can look into?
&gt;&gt;
&gt;&gt; Jason
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Apr 16, 2014 at 1:02 PM, Sean Cribbs  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Jason,
&gt;&gt;&gt;
&gt;&gt;&gt; We usually see these errors when someone connects to the HTTP port
&gt;&gt;&gt; instead of the PB port. First, check that your client is configured
&gt;&gt;&gt; correctly. Also, please check the server logs for any crashes related to
&gt;&gt;&gt; riak\\_api\\_pb\\_server, and paste those here if present.
&gt;&gt;&gt;
&gt;&gt;&gt; It is also conceivable this could occur if the socket were closed before
&gt;&gt;&gt; anything were sent, that is, the read buffer on it is empty, so it returns
&gt;&gt;&gt; 0. I don't know of any specific reason that might happen unless you are
&gt;&gt;&gt; using haproxy between the client and the server (see related PR/issue
&gt;&gt;&gt; https://github.com/basho/riak\\_api/pull/54).
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Tue, Apr 15, 2014 at 6:34 PM, Jason Wang  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; HI all,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; In production, we are experiencing "Socket returned short packet length
&gt;&gt;&gt;&gt; 0 - expected 4" exceptions whenever we try to store an object &gt;20K in size.
&gt;&gt;&gt;&gt; In addition, the exception typically takes over 60 seconds to manifest. The
&gt;&gt;&gt;&gt; content of each object is an bytearray.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Any idea what could be causing this exception?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Other details:
&gt;&gt;&gt;&gt; Library: Python
&gt;&gt;&gt;&gt; Version: riak==2.0.1, riak-pb==1.4.1.1
&gt;&gt;&gt;&gt; Protocol: pbc
&gt;&gt;&gt;&gt; Steps to reproduce: N/A. This only happens in production, not on dev
&gt;&gt;&gt;&gt; machines.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks in advance,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Jason
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt; Software Engineer
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

