---
title: "Re: 2i timeouts in 1.4"
description: ""
project: community
lastmod: 2013-07-26T17:44:51-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11785"
mailinglist_parent_id: "msg11782"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2013-07-26T17:44:51-07:00
---


For a work around you could use streaming and pagination.

Request smaller pages of data (i.e. sub 60 seconds worth) and use streaming to 
get the results to your client sooner.

In HTTP this would look like

http://127.0.0.1:8098/buckets/mybucket/index/test\\_bin/myval?max\\_results=10000&stream=true

your results will include a continuation like

 {"continuation":"g2gCYgAAFXttAAAABDU0OTk="}

and you can use that to get the next N results. Breaking your query up that way 
should duck the timeout.

Furthermore, adding &stream=true will mean the first results is received very 
rapidly.

I don't think the Ruby client is up to date for the new 2i features, but you 
could monkeypatch as before.

Cheers

Russell

On 26 Jul 2013, at 19:00, Sean McKibben  wrote:

&gt; Thank you for looking in to this. This is a major problem for our production 
&gt; cluster, and we're in a bit of a bind right now trying to figure out a 
&gt; workaround in the interim. It sounds like maybe a mapreduce might handle the 
&gt; timeout properly, so hopefully we can do that in the meantime.
&gt; If there is any way we can have a hotfix ASAP though, that would be 
&gt; preferable. Certainly would not be a problem for us to edit a value in the 
&gt; config file (and given the lack of support in the ruby client for the timeout 
&gt; setting, the ability to edit the global default would be preferred).
&gt; In the ruby client i had to monkeypatch it like this to even submit the 
&gt; timeout value, which is not ideal:
&gt; 
&gt; module Riak
&gt; class Client
&gt; class HTTPBackend
&gt; def get\\_index(bucket, index, query)
&gt; bucket = bucket.name if Bucket === bucket
&gt; path = case query
&gt; when Range
&gt; raise ArgumentError, t('invalid\\_index\\_query', :value =&gt; 
&gt; query.inspect) unless String === query.begin || Integer === query.end
&gt; index\\_range\\_path(bucket, index, query.begin, query.end)
&gt; when String, Integer
&gt; index\\_eq\\_path(bucket, index, query, 'timeout' =&gt; '260000')
&gt; else
&gt; raise ArgumentError, t('invalid\\_index\\_query', :value =&gt; 
&gt; query.inspect)
&gt; end
&gt; response = get(200, path)
&gt; JSON.parse(response[:body])['keys']
&gt; end
&gt; end
&gt; end
&gt; end
&gt; 
&gt; Thanks for the update,
&gt; Sean
&gt; 
&gt; 
&gt; 
&gt; On Jul 26, 2013, at 4:49 PM, Russell Brown  wrote:
&gt; 
&gt;&gt; Hi Sean,
&gt;&gt; I'm very sorry to say that you've found a featurebug.
&gt;&gt; 
&gt;&gt; There was a fix put in here https://github.com/basho/riak\\_core/pull/332
&gt;&gt; 
&gt;&gt; But that means that the default timeout of 60 seconds is now honoured. In 
&gt;&gt; the past it was not.
&gt;&gt; 
&gt;&gt; As far as I can see the 2i endpoint never accepted a timeout argument, and 
&gt;&gt; it still does not.
&gt;&gt; 
&gt;&gt; The fix would be to add the timeout to the 2i API endpoints, and I'll do 
&gt;&gt; that straight away.
&gt;&gt; 
&gt;&gt; In the meantime, I wonder if streaming the results would help, or if you'd 
&gt;&gt; still hit the overall timeout?
&gt;&gt; 
&gt;&gt; Very sorry that you've run into this. Let me know if streaming helps, I've 
&gt;&gt; raised an issue here[1] if you want to track this bug
&gt;&gt; 
&gt;&gt; Cheers
&gt;&gt; 
&gt;&gt; Russell
&gt;&gt; 
&gt;&gt; [1] https://github.com/basho/riak\\_kv/issues/610
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 26 Jul 2013, at 17:59, Sean McKibben  wrote:
&gt;&gt; 
&gt;&gt;&gt; I should have mentioned that I also tried:
&gt;&gt;&gt; curl -H "X-Riak-Timeout: 260000" 
&gt;&gt;&gt; "http://127.0.0.1:8098/buckets/mybucket/index/test\\_bin/myval?timeout=260000"
&gt;&gt;&gt; -i
&gt;&gt;&gt; but still receive the 500 error below exactly at the 60 second mark. Is 
&gt;&gt;&gt; this a bug?
&gt;&gt;&gt; 
&gt;&gt;&gt; Secondary to getting this working at all, is this documented anywhere? and 
&gt;&gt;&gt; any way to set this timeout using the ruby riak client?
&gt;&gt;&gt; 
&gt;&gt;&gt; Stream may well work, but I'm going to have to make a number of changes on 
&gt;&gt;&gt; the client side to deal with the results.
&gt;&gt;&gt; 
&gt;&gt;&gt; Sean
&gt;&gt;&gt; 
&gt;&gt;&gt; On Jul 26, 2013, at 3:53 PM, Brian Roach  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Sean -
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The timeout isn't via a header, it's a query param -&gt; &timeout=xxxx
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; You can also use stream=true to stream the results.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; - Roach
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Sent from my iPhone
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Jul 26, 2013, at 3:43 PM, Sean McKibben  wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; We just upgraded to 1.4 and are having a big problem with some of our 
&gt;&gt;&gt;&gt;&gt; larger 2i queries. We have a few key queries that takes longer than 60 
&gt;&gt;&gt;&gt;&gt; seconds (usually about 110 seconds) to execute, but after going to 1.4 we 
&gt;&gt;&gt;&gt;&gt; can't seem to get around a 60 second timeout.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I've tried:
&gt;&gt;&gt;&gt;&gt; curl -H "X-Riak-Timeout: 260000" 
&gt;&gt;&gt;&gt;&gt; "http://127.0.0.1:8098/buckets/mybucket/index/test\\_bin/myval?x-riak-timeout=260000"
&gt;&gt;&gt;&gt;&gt; -i
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; But I always get
&gt;&gt;&gt;&gt;&gt; HTTP/1.1 500 Internal Server Error
&gt;&gt;&gt;&gt;&gt; Vary: Accept-Encoding
&gt;&gt;&gt;&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.0 (never breaks eye contact)
&gt;&gt;&gt;&gt;&gt; Date: Fri, 26 Jul 2013 21:41:28 GMT
&gt;&gt;&gt;&gt;&gt; Content-Type: text/html
&gt;&gt;&gt;&gt;&gt; Content-Length: 265
&gt;&gt;&gt;&gt;&gt; Connection: close
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 500 Internal Server 
&gt;&gt;&gt;&gt;&gt; ErrorInternal Server Error
=====================

The server 
&gt;&gt;&gt;&gt;&gt; encountered an error while processing this 
&gt;&gt;&gt;&gt;&gt; request:  

```
{error,{error,timeout}}
```


---

mochiweb+webmachine
&gt;&gt;&gt;&gt;&gt; web server


&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Right at the 60 second mark. What can I set to give my secondary index 
&gt;&gt;&gt;&gt;&gt; queries more time??
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; This is causing major problems for us :(
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Sean
&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

