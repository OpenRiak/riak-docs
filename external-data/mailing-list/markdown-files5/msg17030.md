---
title: "Re: Riak search 2 returning multiple stale results for single record"
description: ""
project: community
lastmod: 2016-02-17T10:05:06-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17030"
mailinglist_parent_id: "msg17029"
author_name: "Zeeshan Lakhani"
project_section: "mailinglistitem"
sent_date: 2016-02-17T10:05:06-08:00
---


Good to hear. 

The upcoming releases with the changes are soon on the agenda. As a user, you 
will not have to do anything special with the delete, and it will work across 
all delete\\_mode(s). The change is that riak\\_search (yokozuna) now handles 
tombstones on cleanup instead of waiting for the backend to reap. 


Zeeshan Lakhani
programmer | 
software engineer at @basho 

&gt; On Feb 17, 2016, at 7:59 AM, Peter Roberts  wrote:
&gt; 
&gt; Hi Zeeshan,
&gt; 
&gt; Configuring the delete\\_mode to immediate (or a very low millisecond value) 
&gt; does prevent this occurring for me, I hadn’t spotted this setting before. 
&gt; This is a suitable solution for us at the moment. There were no Solr errors 
&gt; in the logs so I think it wasn’t being called by Riak. 
&gt; 
&gt; Are you able to provide me with any more details on how the delete will 
&gt; change in the upcoming releases and when they might be available?
&gt; 
&gt; Thanks,
&gt; Peter
&gt; 
&gt; From: Zeeshan Lakhani &gt;
&gt; Date: Monday, 15 February 2016 20:27
&gt; To: Peter Roberts &gt;
&gt; Cc: "riak-users@lists.basho.com " 
&gt; &gt;
&gt; Subject: Re: Riak search 2 returning multiple stale results for single record
&gt; 
&gt; Hello Peter,
&gt; 
&gt; The cleanup for delete, as a call to SOLR, occurs after the reap happens in 
&gt; the backend, depending on delete\\_mode of course. Did you notice any Solr 
&gt; errors in the logs related to “failed to index” or something similar? Maybe 
&gt; the delete request never hit the solr\\_core/search\\_index, and, therefore, has 
&gt; stayed around as a sibling. The logs would help there. Have you set 
&gt; delete\\_mode to something specific (i.e. 
&gt; http://docs.basho.com/riak/latest/ops/advanced/deletion/#Configuring-Object-Deletion
&gt; 
&gt; )?
&gt; 
&gt; 
&gt; I can tell you that the soon-to-be-released 2.0.7 and 2.2 releases fixes this 
&gt; with more aggressive tactics to handle deletes, especially around datatypes 
&gt; (I see that you’re using maps), instead of waiting for the call after the 
&gt; backend reap/removal. 
&gt; 
&gt; Looking at previous threads, your W quorum value can also matter - 
&gt; http://riak-users.197444.n3.nabble.com/Deleted-keys-come-back-td4033536.html#a4033576
&gt; 
&gt; .
&gt; 
&gt; 
&gt; For you current situation, an updated re-PUT for those with siblings would 
&gt; resolve them, or via an internal solr cleanup call, or through a reindexing 
&gt; process. If you want to find me on IRC, we can discuss a few others tools we 
&gt; have that may help you get most of the way there until the new release, 
&gt; depending on the questions I asked in the first paragraph.
&gt; 
&gt; Thanks.
&gt; 
&gt; Zeeshan Lakhani
&gt; programmer | 
&gt; software engineer at @basho
&gt; 
&gt;&gt; On Feb 15, 2016, at 5:33 AM, Peter Roberts &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; We’re currently evaluating whether Riak is suitable for our system and have 
&gt;&gt; an issue with multiple/stale results being returned from Riak search. We’re 
&gt;&gt; reliably seeing this occur when a record is deleted and a new one created 
&gt;&gt; under the same key shortly afterwards – which, based on the \\_yz\\_id, causes 
&gt;&gt; siblings to be created. 
&gt;&gt; 
&gt;&gt; Accessing the record through the map datatype only gives us the expected 
&gt;&gt; record. We’ve considered de-duplicating the result by ID but this could 
&gt;&gt; still result in search results where the query matches the old but not the 
&gt;&gt; new data. The obsolete records in Riak search/Solr never get cleaned up. 
&gt;&gt; 
&gt;&gt; Is this a known issue? Are we missing something on inserting/querying the 
&gt;&gt; data? Is it possible to tie the version of data in the Riak search result to 
&gt;&gt; the version retrieved from Riak by key?
&gt;&gt; 
&gt;&gt; Below is an example of the Riak search query/result (using Node 
&gt;&gt; basho-riak-client) and datatype data. The date.value is set to the 
&gt;&gt; creation/update time. 
&gt;&gt; 
&gt;&gt; var searchOptions = {
&gt;&gt; indexName: 'minimals\\_index',
&gt;&gt; q: 'name\\_register:foo',
&gt;&gt; presort: ‘score'
&gt;&gt; }
&gt;&gt; 
&gt;&gt; riakClient.search(searchOptions, function(err, result) {
&gt;&gt; console.log('Search result', err, result);
&gt;&gt; callback(err, result);
&gt;&gt; }
&gt;&gt; 
&gt;&gt; Results:
&gt;&gt; { numFound: 6,
&gt;&gt; maxScore: 0.35434481501579285,
&gt;&gt; docs: 
&gt;&gt; [ { score: 0.35434482,
&gt;&gt; \\_yz\\_rb: 'minimals',
&gt;&gt; \\_yz\\_rt: 'maps',
&gt;&gt; \\_yz\\_rk: 'test:foo',
&gt;&gt; \\_yz\\_id: '1\\*maps\\*minimals\\*test:foo\\*13\\*2EB6xtIHCicwmARKDJ81tS',
&gt;&gt; 'date\\_map.\\_type\\_register': '\\_date',
&gt;&gt; 'date\\_map.\\_value\\_register': '2016-02-12T11:39:22.942Z',
&gt;&gt; name\\_register: 'foo',
&gt;&gt; owner\\_register: 'test' },
&gt;&gt; …
&gt;&gt; { score: 0.35434482,
&gt;&gt; \\_yz\\_rb: 'minimals',
&gt;&gt; \\_yz\\_rt: 'maps',
&gt;&gt; \\_yz\\_rk: 'test:foo',
&gt;&gt; \\_yz\\_id: '1\\*maps\\*minimals\\*test:foo\\*13\\*4hNPnHzeJpTc7S6nEW8vNb',
&gt;&gt; 'date\\_map.\\_type\\_register': '\\_date',
&gt;&gt; 'date\\_map.\\_value\\_register': '2016-02-12T13:28:11.785Z',
&gt;&gt; name\\_register: 'foo',
&gt;&gt; owner\\_register: 'test' } ] 
&gt;&gt; }
&gt;&gt; 
&gt;&gt; Riak get by ID:
&gt;&gt; $ curl -XGET 
&gt;&gt; "http://localhost:11098/types/maps/buckets/minimals/datatypes/test:foo 
&gt;&gt; "
&gt;&gt; {"type":"map","value":{"date\\_map":{"\\_type\\_register":"\\_date","\\_value\\_register":"2016-02-12T13:28:11.785Z"},"name\\_register":"foo","owner\\_register":"test"},"context":"g2wAAAABaAJtAAAADMHSXwlPAZAxAAAAQmEDag==“}
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; Peter
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com 
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt;&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

