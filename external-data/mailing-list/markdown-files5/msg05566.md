---
title: "Re: Is Riak suitable for a short-term scatter/gather sort of data	store?"
description: ""
project: community
lastmod: 2011-11-12T14:32:13-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05566"
mailinglist_parent_id: "msg05564"
author_name: "Gordon Tillman"
project_section: "mailinglistitem"
sent_date: 2011-11-12T14:32:13-08:00
---


Keith I have an idea that might work for you. This is a bit vague but I would 
be glad to put together a more concrete example if you like.

Use secondary indexes to tag each entry with the device id.

You can then find all of the entries for a given device by using the the 
secondary index to feed into a simple map phase operation that returns only the 
entries that you want; i.e., those that are in a given time range.

In addition, to easily find all of the registered device ids easily you can 
create one entry for each device. The key can be most anything (even the 
device id if you encode it properly -- hash it), and you could tag each of 
those entries with a secondary index whose field is something like "type" or 
whatever and whose value is "deviceid". The value for each entry could be just 
a simple text/plain value whose contents is just the device id of the 
registered device.

--gordon

On Nov 12, 2011, at 16:19 , Keith Irwin wrote:

&gt; Folks--
&gt; 
&gt; (Apologies up front for the length of this.)
&gt; 
&gt; I'm wondering if you can let me know if Riak is a good fit for a simple 
&gt; not-quite-key-value scenario described below. MongoDB or (say) Postgresql 
&gt; seem a more natural fit conceptually, but I really, really like Riak's 
&gt; distribution strategy.
&gt; 
&gt; ## context
&gt; 
&gt; The basic overview is this: 
&gt; 
&gt; 50K devices push data once a second to web services which need to store that 
&gt; data in short-term storage (Riak). Once an hour, a sweeper needs to take an 
&gt; hour's worth of data per device (if there is any) and ship it off to long 
&gt; term storage, then delete it from short-term storage. Ideally, there'd only 
&gt; ever be slightly more than 1 hour's worth of data still in short-term storage 
&gt; for any given device. The goal is to write down the data as simply and safely 
&gt; as possible, with little or no processing on that data.
&gt; 
&gt; Each second's worth of data is:
&gt; 
&gt; \\* A device identifier
&gt; \\* A timestamp (epoch seconds, integer) for the slice of time the data 
&gt; represents
&gt; \\* An opaque blob of binary data (2 to 4k)
&gt; 
&gt; Once an hour, I'd like to do something like:
&gt; 
&gt; \\* For each device:
&gt; \\* Find (and concat) all the data between time1 and time2 (an hour).
&gt; \\* Move that data to long-term storage (not Riak) as a single blob.
&gt; \\* Delete that data from Riak.
&gt; 
&gt; For an SQL db, this is a really simple problem, conceptually. You can have a 
&gt; table with three columns: device-id, timestamp, blob. You can index the first 
&gt; two columns and roll up the data easily enough and then delete it via single 
&gt; SQL statements (or buffer as needed). The harder part is partitioning, 
&gt; replication, etc, etc.
&gt; 
&gt; For MongoDB, it's also fairly simple. Just use a document with the same 
&gt; device-id, timestamp and binary-array data (as JSON), make sure indexes are 
&gt; declared, and query/delete just as in SQL. MongoDB provides sharding, 
&gt; replica-sets, recovery, etc. Set up, while less complicated than an RDBMS, 
&gt; still seems way more complicated than necessary.
&gt; 
&gt; These solutions also provide sorting (which, while nice, isn't a requirement 
&gt; for my case).
&gt; 
&gt; ## question
&gt; 
&gt; I've been reading the Riak docs, and I'm just not sure if this simple 
&gt; "queryable" case can really fit all that well. I'm not so concerned about 
&gt; having to send 50K "deletes" to delete data. I'm more concerned about being 
&gt; able to find it. Given what I've written above, I may be blocked conceptually 
&gt; by the above index/query mentality such that I'm just not seeing the Riak way 
&gt; of doing things.
&gt; 
&gt; Anyway, I can "tag" (via the secondary index feature) each blob of data with 
&gt; the device-id and the timestamp. I could then do a range query similar to:
&gt; 
&gt; GET /buckets/devices/index/timestamp/start/end
&gt; 
&gt; However, this doesn't allow me to group based on device-id. I could create a 
&gt; separate bucket for every device, such that I could do:
&gt; 
&gt; GET /buckets/device-id/index/timestamp/start/end
&gt; 
&gt; but if I do this, how can I get a list of the device-ids I need so that I can 
&gt; create that specific URL? The docs say listing buckets and keys is 
&gt; problematic.
&gt; 
&gt; Might be that Riak just isn't a good case for this sort of thing, especially 
&gt; given I want to use it for short-term transient data, and that's fine. But I 
&gt; wanted to ask you all just to make sure that I'm not missing something 
&gt; somewhere.
&gt; 
&gt; For instance, might link walking help? How about a map/reduce to find a 
&gt; unique list of device-ids within a given time-horizon, and a streaming map 
&gt; job to gather the data for export? Does that seem pretty reasonable?
&gt; 
&gt; Thanks!
&gt; 
&gt; Keith
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

