---
title: "Re: What is this...?"
description: ""
project: community
lastmod: 2012-01-21T20:06:40-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06362"
mailinglist_parent_id: "msg06361"
author_name: "Zheng Zhibin"
project_section: "mailinglistitem"
sent_date: 2012-01-21T20:06:40-08:00
---


After tracing the source code, I think it might also be caused by network 
breakdown, possibly ^\\_^ I am not sure.

Please modify these two lines of riak\\_core\\_handoff\\_receiver.erl (Riak 1.0.3):

From:
process\\_message(\\_, \\_MsgData, State=#state{sock=Socket,
 tcp\\_mod=TcpMod}) -&gt;
 TcpMod:send(Socket, &lt;&lt;255:8,"unknown\\_msg"&gt;&gt;),
 State.

To:
process\\_message(Code, MsgData, State=#state{sock=Socket,
 tcp\\_mod=TcpMod}) -&gt;
 lager:info("handoff\\_receiver\\_process\\_message: ~p ~p", [Code, MsgData]),
 TcpMod:send(Socket, &lt;&lt;255:8,"unknown\\_msg"&gt;&gt;),
 State.

Then rerun this case, check for the log: ./log/console.log , see what are the 
Code and MsgData? 

Zheng Zhibin

在 2012-1-22，上午11:41， Zheng Zhibin 写道：

&gt; Oh, sorry for my fast response ^\\_^
&gt; 
&gt; This issue should due to the miscommunication between 
&gt; riak\\_core\\_handoff\\_sender.erl and riak\\_core\\_handoff\\_receiver.erl
&gt; 
&gt; Zheng Zhibin
&gt; 
&gt; 在 2012-1-22，上午11:23， Zheng Zhibin 写道：
&gt; 
&gt;&gt; I think this basically due to different definition of Protocol Buffers 
&gt;&gt; between Riak and Riak Erlang Client.
&gt;&gt; 
&gt;&gt; Updated them into the same version, and make clean & make, this should help.
&gt;&gt; 
&gt;&gt; Zheng Zhibin
&gt;&gt; 
&gt;&gt; 在 2012-1-22，上午11:18， Zheng Zhibin 写道：
&gt;&gt; 
&gt;&gt;&gt; saw the code in "deps/riak\\_core/src/riak\\_core\\_handoff\\_receiver.erl"
&gt;&gt;&gt; 
&gt;&gt;&gt; process\\_message(?PT\\_MSG\\_INIT, MsgData, State=#state{vnode\\_mod=VNodeMod}) -&gt;
&gt;&gt;&gt; &lt;&gt; = MsgData,
&gt;&gt;&gt; lager:info("Receiving handoff data for partition ~p:~p", [VNodeMod, 
&gt;&gt;&gt; Partition]),
&gt;&gt;&gt; {ok, VNode} = riak\\_core\\_vnode\\_master:get\\_vnode\\_pid(Partition, VNodeMod),
&gt;&gt;&gt; State#state{partition=Partition, vnode=VNode};
&gt;&gt;&gt; process\\_message(?PT\\_MSG\\_OBJ, MsgData, State=#state{vnode=VNode, 
&gt;&gt;&gt; count=Count}) -&gt;
&gt;&gt;&gt; Msg = {handoff\\_data, MsgData},
&gt;&gt;&gt; case gen\\_fsm:sync\\_send\\_all\\_state\\_event(VNode, Msg, 60000) of
&gt;&gt;&gt; ok -&gt;
&gt;&gt;&gt; State#state{count=Count+1};
&gt;&gt;&gt; E={error, \\_} -&gt;
&gt;&gt;&gt; exit(E)
&gt;&gt;&gt; end;
&gt;&gt;&gt; process\\_message(?PT\\_MSG\\_OLDSYNC, MsgData, State=#state{sock=Socket,
&gt;&gt;&gt; tcp\\_mod=TcpMod}) -&gt;
&gt;&gt;&gt; TcpMod:send(Socket, &lt;PT\\_MSG\\_OLDSYNC:8,"sync"&gt;),
&gt;&gt;&gt; &lt;&gt; = MsgData,
&gt;&gt;&gt; VNodeMod = binary\\_to\\_atom(VNodeModBin, utf8),
&gt;&gt;&gt; State#state{vnode\\_mod=VNodeMod};
&gt;&gt;&gt; process\\_message(?PT\\_MSG\\_SYNC, \\_MsgData, State=#state{sock=Socket,
&gt;&gt;&gt; tcp\\_mod=TcpMod}) -&gt;
&gt;&gt;&gt; TcpMod:send(Socket, &lt;PT\\_MSG\\_SYNC:8, "sync"&gt;),
&gt;&gt;&gt; State;
&gt;&gt;&gt; process\\_message(?PT\\_MSG\\_CONFIGURE, MsgData, State) -&gt;
&gt;&gt;&gt; ConfProps = binary\\_to\\_term(MsgData),
&gt;&gt;&gt; State#state{vnode\\_mod=proplists:get\\_value(vnode\\_mod, ConfProps),
&gt;&gt;&gt; partition=proplists:get\\_value(partition, ConfProps)};
&gt;&gt;&gt; process\\_message(\\_, \\_MsgData, State=#state{sock=Socket,
&gt;&gt;&gt; tcp\\_mod=TcpMod}) -&gt;
&gt;&gt;&gt; TcpMod:send(Socket, &lt;&lt;255:8,"unknown\\_msg"&gt;&gt;),
&gt;&gt;&gt; State.
&gt;&gt;&gt; 
&gt;&gt;&gt; Your request message sent from riak-erlang-client has been droped to the 
&gt;&gt;&gt; last one of matching.
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Zheng Zhibin
&gt;&gt;&gt; 
&gt;&gt;&gt; 在 2012-1-22，上午12:43， Mike Oxford 写道：
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 3 node cluster of 1.0.2, level\\_db backend, pb interface. Build up a
&gt;&gt;&gt;&gt; store of 9 connections (3 to each node) and pull one out randomly.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; --snip
&gt;&gt;&gt;&gt; 62&gt; 
&gt;&gt;&gt;&gt; riakc\\_pb\\_socket:list\\_keys(gen\\_server:call(forum\\_store:get\\_random\\_pid(alliance),
&gt;&gt;&gt;&gt; get\\_connector\\_pid), &lt;&lt;"alliance\\_overview"&gt;&gt;
&gt;&gt;&gt;&gt; {ok,[]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 63&gt; 
&gt;&gt;&gt;&gt; riakc\\_pb\\_socket:list\\_keys(gen\\_server:call(forum\\_store:get\\_random\\_pid(alliance),
&gt;&gt;&gt;&gt; get\\_connector\\_pid), &lt;&lt;"alliance\\_overview"&gt;&gt;).
&gt;&gt;&gt;&gt; {ok,[]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 64&gt; 
&gt;&gt;&gt;&gt; riakc\\_pb\\_socket:list\\_keys(gen\\_server:call(forum\\_store:get\\_random\\_pid(alliance),
&gt;&gt;&gt;&gt; get\\_connector\\_pid), "alliance\\_overview").
&gt;&gt;&gt;&gt; {ok,[]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 65&gt; 
&gt;&gt;&gt;&gt; riakc\\_pb\\_socket:list\\_keys(gen\\_server:call(forum\\_store:get\\_random\\_pid(alliance),
&gt;&gt;&gt;&gt; get\\_connector\\_pid), "alliance\\_overview").
&gt;&gt;&gt;&gt; =ERROR REPORT==== 21-Jan-2012::08:23:11 ===
&gt;&gt;&gt;&gt; \\*\\* Generic server &lt;0.24647.5&gt; terminating
&gt;&gt;&gt;&gt; \\*\\* Last message in was {tcp,#Port&lt;0.5820&gt;,[255|&lt;&lt;"unknown\\_msg"&gt;&gt;]}
&gt;&gt;&gt;&gt; \\*\\* When Server state == {state,"127.0.0.1",2010,false,false,#Port&lt;0.5820&gt;,
&gt;&gt;&gt;&gt; {request,#Ref&lt;0.0.4.159143&gt;,
&gt;&gt;&gt;&gt; {rpblistkeysreq,"alliance\\_overview"},
&gt;&gt;&gt;&gt; undefined,
&gt;&gt;&gt;&gt; {106931976,&lt;0.25063.5&gt;},
&gt;&gt;&gt;&gt; 60000,#Ref&lt;0.0.4.159144&gt;},
&gt;&gt;&gt;&gt; {[],[]},
&gt;&gt;&gt;&gt; 1,[],infinity,100}
&gt;&gt;&gt;&gt; \\*\\* Reason for termination ==
&gt;&gt;&gt;&gt; \\*\\* {function\\_clause,[{riakclient\\_pb,decode,[undefined,&lt;&lt;"unknown\\_msg"&gt;&gt;]},
&gt;&gt;&gt;&gt; {riakc\\_pb\\_socket,handle\\_info,2},
&gt;&gt;&gt;&gt; {gen\\_server,handle\\_msg,5},
&gt;&gt;&gt;&gt; {proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt;&gt;&gt; {error,{timeout,[]}}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 66&gt; 
&gt;&gt;&gt;&gt; riakc\\_pb\\_socket:list\\_keys(gen\\_server:call(forum\\_store:get\\_random\\_pid(alliance),
&gt;&gt;&gt;&gt; get\\_connector\\_pid), "alliance\\_overview").
&gt;&gt;&gt;&gt; {ok,[]}
&gt;&gt;&gt;&gt; --end snip
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Riak console spits out the following at the same time...
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; --snip
&gt;&gt;&gt;&gt; nodes().08:23:11.154 [info] Handoff receiver for partition undefined
&gt;&gt;&gt;&gt; exited after processing 0 objects
&gt;&gt;&gt;&gt; --end snip
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Error condition does not seem to follow any specific node and the
&gt;&gt;&gt;&gt; connections die when the error is thrown so its constantly building
&gt;&gt;&gt;&gt; new ones.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; TIA.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; -mox
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

