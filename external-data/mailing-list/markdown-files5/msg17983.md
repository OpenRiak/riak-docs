---
title: "Re: Truncated bit-cask files"
description: ""
project: community
lastmod: 2017-02-14T12:59:54-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17983"
mailinglist_parent_id: "msg17982"
author_name: "Arun Rajagopalan"
project_section: "mailinglistitem"
sent_date: 2017-02-14T12:59:54-08:00
---


Thanks Matthew. I will try one of those solutions


On Tue, Feb 14, 2017 at 3:51 PM, Matthew Von-Maszewski 
wrote:

&gt; Arun,
&gt;
&gt; You are running out of RAM for the leveldb AAE. There are several ways to
&gt; fix that:
&gt;
&gt; - reduce memory allocated to bitcask
&gt; - more memory per server
&gt; - more servers of same memory
&gt; - reduce the ring size from 64 to 8, and rebuild data within the cluster
&gt; from scratch
&gt; - lie to leveldb and give it a big than real memory setting in riak.conf:
&gt; leveldb.maximum\\_memory=8G
&gt;
&gt;
&gt; The key LOG lines are:
&gt;
&gt; Options.total\\_leveldb\\_mem: 2,901,766,963 &lt;-- this is the total memory
&gt; assigned to ALL of leveldb, but
&gt; only 20% of it goes to AAE vnodes
&gt;
&gt; File cache size: 5833527 &lt;-- the first vnode says, cool enough memory
&gt; for me
&gt; Block cache size: 7930679 &lt;-- ditto
&gt;
&gt; ... but as more vnodes start:
&gt;
&gt; File cache size: 0 &lt;-- things are just not going to work
&gt; well
&gt; Block cache size: 0
&gt;
&gt; There are no actual file system error messages in your LOG files. That
&gt; supports that the real problem is memory unhappiness.
&gt;
&gt; Matthew
&gt;
&gt;
&gt; On Feb 14, 2017, at 3:34 PM, Arun Rajagopalan &lt;
&gt; arun.v.rajagopa...@gmail.com&gt; wrote:
&gt;
&gt; Hi Matthew, Magnus
&gt;
&gt; I have attached the log files for your review
&gt;
&gt; Thanks
&gt; Arun
&gt;
&gt;
&gt; On Tue, Feb 14, 2017 at 11:55 AM, Matthew Von-Maszewski &lt;
&gt; matth...@basho.com&gt; wrote:
&gt;
&gt;&gt; Arun,
&gt;&gt;
&gt;&gt; The AAE code uses leveldb for its storage of anti-entropy data, no matter
&gt;&gt; which backend holds the user data. Therefore the error below suggests
&gt;&gt; corruption within leveldb files (which is not impossible, but becoming
&gt;&gt; really rare except with bad hardware or full disks).
&gt;&gt;
&gt;&gt; Before wiping out the AAE directory, you should copy the LOG file within
&gt;&gt; it. There are likely more useful error messages within that file ... maybe
&gt;&gt; put the file in drop box or zip attach to a reply for us to review.
&gt;&gt;
&gt;&gt; Matthew
&gt;&gt;
&gt;&gt; On Feb 14, 2017, at 10:42 AM, Magnus Kessler  wrote:
&gt;&gt;
&gt;&gt; On 14 February 2017 at 14:46, Arun Rajagopalan &lt;
&gt;&gt; arun.v.rajagopa...@gmail.com&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Magnus
&gt;&gt;&gt;
&gt;&gt;&gt; RIAK crashes on startup when I have trucated bitcask file
&gt;&gt;&gt;
&gt;&gt;&gt; It also crashes when the AAE files are bad too I think. Example below
&gt;&gt;&gt;
&gt;&gt;&gt; 2017-02-13 21:18:30 =CRASH REPORT====
&gt;&gt;&gt; crasher:
&gt;&gt;&gt; initial call: riak\\_kv\\_index\\_hashtree:init/1
&gt;&gt;&gt; pid: &lt;0.6037.0&gt;
&gt;&gt;&gt; registered\\_name: []
&gt;&gt;&gt; exception exit: {{{badmatch,{error,{db\\_open,"Corruption: truncated
&gt;&gt;&gt; record at end of file"}}},[{hashtree,new\\_segment\\_
&gt;&gt;&gt; store,2,[{file,"src/hashtree.erl"},{line,675}]},{hashtree,ne
&gt;&gt;&gt; w,2,[{file,"src/hashtree.erl"},{line,246}]},{riak\\_kv\\_index\\_h
&gt;&gt;&gt; ashtree,do\\_new\\_tree,3,[{file,"src/riak\\_kv\\_index\\_hashtree.erl
&gt;&gt;&gt; "},{line,610}]},{lists,foldl,3,[{file,"lists.erl"},{line,124
&gt;&gt;&gt; 8}]},{riak\\_kv\\_index\\_hashtree,init\\_trees,3,[{file,"src/riak\\_k
&gt;&gt;&gt; v\\_index\\_hashtree.erl"},{line,474}]},{riak\\_kv\\_index\\_hashtree,
&gt;&gt;&gt; init,1,[{file,"src/riak\\_kv\\_index\\_hashtree.erl"},{line,268}]}
&gt;&gt;&gt; ,{gen\\_server,init\\_it,6,[{file,"gen\\_server.erl"},{line,304}]}
&gt;&gt;&gt; ,{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,23
&gt;&gt;&gt; 9}]}]},[{gen\\_server,init\\_it,6,[{file,"gen\\_server.erl"},{line
&gt;&gt;&gt; ,328}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{
&gt;&gt;&gt; line,239}]}]}
&gt;&gt;&gt; ancestors: [&lt;0.715.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.160.0&gt;]
&gt;&gt;&gt; messages: []
&gt;&gt;&gt; links: []
&gt;&gt;&gt; dictionary: []
&gt;&gt;&gt; trap\\_exit: false
&gt;&gt;&gt; status: running
&gt;&gt;&gt; heap\\_size: 1598
&gt;&gt;&gt; stack\\_size: 27
&gt;&gt;&gt; reductions: 889
&gt;&gt;&gt; neighbours:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Regards
&gt;&gt;&gt; Arun
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt; Hi Arun,
&gt;&gt;
&gt;&gt; The crash log you provided shows that there is a corrupted file in the
&gt;&gt; AAE (anti\\_entropy) backend. Entries in console.log should have more
&gt;&gt; information about which partition is affected. Please post output from the
&gt;&gt; affected node at around 2017-02-13T21:18:30. As this is AAE data, it is
&gt;&gt; safe to remove the directory named after the affected partition from the
&gt;&gt; active\\_entropy directory before restarting the node. You may find that
&gt;&gt; there is more than one affected partition, the next of which will be
&gt;&gt; encountered after the attempted restart only. If this is the case, simply
&gt;&gt; identify the next partition in the same way and remove it, too, until the
&gt;&gt; node starts up successfully again.
&gt;&gt;
&gt;&gt; Is there a reason why the nodes aren't shut down in the regular way?
&gt;&gt;
&gt;&gt; Kind Regards,
&gt;&gt;
&gt;&gt; Magnus
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Magnus Kessler
&gt;&gt; Client Services Engineer
&gt;&gt; Basho Technologies Limited
&gt;&gt;
&gt;&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt; 
&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

