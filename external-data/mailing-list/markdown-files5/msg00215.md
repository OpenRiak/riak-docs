---
title: "Re: Sanity check - reduce phase swallowing inputs?"
description: ""
project: community
lastmod: 2010-04-30T06:09:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00215"
mailinglist_parent_id: "msg00214"
author_name: "Kevin Smith"
project_section: "mailinglistitem"
sent_date: 2010-04-30T06:09:36-07:00
---


Jimmy --

A couple of comments:

\\* Multiple sequential map phases only work if each map phase emits ONLY 
key/value pairs as the inputs for the next map phase.

\\* The Javascript environment provides a function, ejsLog(), which you can use 
to debug M/R jobs. You call it like this: ejsLog("/path/to/log/file", 
"StringToLog")

--Kevin
On Apr 30, 2010, at 8:37 AM, Jimmy Thrasher wrote:

&gt; Oops. Forgot to reply all.
&gt; 
&gt; Dan suggested I try keep: true in the reduce phase, but it turns out that 
&gt; didn't make a difference. Can anyone else spot a hole in my query below? 
&gt; Are there logs I can look at to debug errors in the reduce phase?
&gt; 
&gt; Hi Dan,
&gt; 
&gt; Here's the query as I have it for debug purposes, including the wonky reduce 
&gt; phase. I might add that this query works on my local machine (Mac OS, Riak 
&gt; 0.9.1, not Innostore). The remote machine is Ubuntu 9.10, Amazon EC2 32-bit, 
&gt; Innostore, Riak 0.9.1.
&gt; 
&gt; I'm generating the query in Ruby. Also, beware.. I'm a n00b. If this code is 
&gt; making obvious idiomatic errors, I'd be happy to receive your suggestions.
&gt; 
&gt; Thanks,
&gt; 
&gt; Jimmy
&gt; 
&gt; query = {
&gt; 'inputs' =&gt; 'events',
&gt; 'query' =&gt; [
&gt; {'map' =&gt; { # go get annotations
&gt; 'language' =&gt; 'javascript',
&gt; 'source' =&gt; &lt;&lt;-END
&gt; function(v) {
&gt; var d = Riak.mapValuesJson(v)[0]
&gt; if (d.type == "checkin" && (#{guard\\_expression}))
&gt; return [[v.bucket, v.key], [v.key + ',annotation', 
&gt; 'spend']]
&gt; else
&gt; return []
&gt; }
&gt; END
&gt; }},
&gt; {'map' =&gt; {
&gt; 'language' =&gt; 'javascript',
&gt; 'source' =&gt; # verify the annotations exist
&gt; 'function(v) {
&gt; if ("values" in v && "bucket" in v)
&gt; return [[v.bucket, v.key]]
&gt; else
&gt; return []
&gt; }'}},
&gt; {'map' =&gt; { # prep for reduce phase
&gt; 'language' =&gt; 'javascript',
&gt; 'source' =&gt;
&gt; 'function(v,k,a) {
&gt; return [v]
&gt; }'}},
&gt; {'reduce' =&gt; { # does the reduce phase work?
&gt; 'language' =&gt; 'javascript',
&gt; 'source' =&gt;
&gt; 'function(v, a) {
&gt; return v
&gt; }'}},
&gt; ]}
&gt; 
&gt; On Thu, Apr 29, 2010 at 9:18 PM, Dan Reverri  wrote:
&gt; What's the map phase function?
&gt; 
&gt; On Thu, Apr 29, 2010 at 6:14 PM, Jimmy Thrasher  wrote:
&gt; Hi everyone. Hope you're doing well. Tried this on the IRC channel, but I 
&gt; guess it was dinner time. :)
&gt; 
&gt; I have a query which, up until today, has worked quite well. The data 
&gt; currently coming out of the map phases are all correct looking, but the 
&gt; minute I start a reduce, I get [] as the result.
&gt; 
&gt; Currently, for debug, my only reduce function looks like this:
&gt; function(values) {
&gt; return values
&gt; }
&gt; 
&gt; If I remove all the reduce phases, I get, say, 2 items out of the query. But 
&gt; if I put that reduce function in, I get only [].
&gt; 
&gt; Is this something anyone has seen before? How should I go about debugging it?
&gt; 
&gt; Thanks for any direction you can give.
&gt; 
&gt; Jimmy
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

