---
title: "Re: Request queue issue with riakc_pb_socket"
description: ""
project: community
lastmod: 2012-08-02T10:02:31-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08164"
mailinglist_parent_id: "msg08053"
author_name: "Bryan Fink"
project_section: "mailinglistitem"
sent_date: 2012-08-02T10:02:31-07:00
---


On Tue, Jul 24, 2012 at 8:48 PM, Julian  wrote:
&gt; I'm using riakc\\_pb\\_socket to queue up several requests and rely on the
&gt; built-in queueing, which should hopefully eventually service all requests.
&gt; However I have a scenario in which a couple processes that queue a request
&gt; are never terminating the call on the socket...even though a request issued
&gt; subsequently gets through.

Hi, Julian. I have one possible answer for you. Could you please try
wrapping your call to riakc\\_pb\\_socket:search/5 in a try-catch block?

Deep inside riakc\\_pb\\_socket, that call becomes a gen\\_server:call to
the socket server. If that call times out (or encounters a few other
errors), the calling process (your code) exits with an exception. A
timeout here should be a rare occurrence, because the socket server
should be normally be unblocked, ready to handle (enqueue) requests,
but it's possible, and there are other errors that can trigger the
same behavior.

So, try setting things up as:

 populate\\_instance(InstanceBin, State) -&gt;
 error\\_logger:info\\_msg(binary\\_to\\_list(InstanceBin) ++ " about to wait"),
 try riakc\\_pb\\_socket:search(...) of
 {ok, MapredResult} -&gt;
 error\\_logger:info\\_msg(binary\\_to\\_list(InstanceBin) ++ "
done waiting"),
 ...process MapredResult...;
 {error, \\_} -&gt;
 error\\_logger:info\\_msg(binary\\_to\\_list(InstanceBin) ++ "
encountered error")
 catch exit:\\_ -&gt;
 error\\_logger:info\\_msg(binary\\_to\\_list(InstanceBin) ++ "
failed call, retrying..."),
 populate\\_instance(InstanceBin, State)
 end.

(obviously needs some safety valves to prevent infinite retries, etc.,
but you get the idea)

I consider this a little bit of a long shot, since your timeout is so
long, but it's the only way I've been able to recreate such a
situation so far.

-Bryan

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

