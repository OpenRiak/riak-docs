---
title: "Re: Riak-CS Node.js client"
description: ""
project: community
lastmod: 2015-02-26T06:15:03-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15799"
mailinglist_parent_id: "msg15798"
author_name: "Kota Uenishi"
project_section: "mailinglistitem"
sent_date: 2015-02-26T06:15:03-08:00
---


&gt; The s3 signer uses the signs the "canonicalizedResource" and that have the 
&gt; query parameters already encoded, so I tried to replace the "%3D" by the "=" 
&gt; and it already works.

Yey! The culprit is here. Most client mistakenly encodes Multipart
uploadId although it is already supposed to be url-encoded. This is
the case for #1063, too. Maybe Riak CS can be aligned to how S3
behaves to save most S3 clients - stay tuned to that issue, please.
Anyway, thank you for reporting!



On Thu, Feb 26, 2015 at 9:54 PM, Patrick F. Marques
 wrote:
&gt; Hi,
&gt;
&gt; thanks for your help Uenishi.
&gt;
&gt; I'm using Riak 1.5.2, and AWS Node.js SDK 2.1.14 and the example code I'm
&gt; running is bellow.
&gt; I have beed trying with and without forcing a singing version. With some
&gt; debug I found that the default is the use the s3 signer.... If I force v2 I
&gt; have another error, "Cannot set property 'Timestamp' of undefined" that is
&gt; throe by v2.js signer code, I made a simple fix but then every request
&gt; returns "Access Denied".
&gt;
&gt; The s3 signer uses the signs the "canonicalizedResource" and that have the
&gt; query parameters already encoded, so I tried to replace the "%3D" by the "="
&gt; and it already works.
&gt;
&gt;
&gt; // ----------------------------------
&gt;
&gt; 'use strict';
&gt;
&gt; var fs = require('fs');
&gt; var path = require('path');
&gt; var zlib = require('zlib');
&gt;
&gt; var config = {
&gt; accessKeyId: 'WDH-HCBBZONGEY2PADRC',
&gt; secretAccessKey: '9nJpf\\_C3hoaGrMBbvWH\\_pJ7qQT5ijrQKrN2XVg==',
&gt; // region: 'eu'
&gt;
&gt; httpOptions: {
&gt; proxy: 'http://192.168.56.100:8080'
&gt; },
&gt;
&gt; signatureVersion: 'v2'
&gt; };
&gt;
&gt; var bigfile = path.join('./', 'bigfile');
&gt; var body = fs.createReadStream(bigfile).pipe(zlib.createGzip());
&gt;
&gt; var AWS = require('aws-sdk');
&gt; var s3 = new AWS.S3(new AWS.Config(config));
&gt;
&gt; var params = {
&gt; Bucket: 'test',
&gt; Key: 'myKey',
&gt; Body: body
&gt; };
&gt;
&gt; s3.upload(params).
&gt; on('httpUploadProgress', function(evt) { console.log(evt); }).
&gt; send(function(err, data) {
&gt; console.log(err, data);
&gt; });
&gt;
&gt; // ----------------------------------
&gt;
&gt; Bets Regards,
&gt; Patrick Marques
&gt;
&gt;
&gt; On Thu, Feb 26, 2015 at 6:47 AM, Kota Uenishi  wrote:
&gt;&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; My 6th sense says you're hitting this problem:
&gt;&gt; https://github.com/basho/riak\\_cs/issues/1063
&gt;&gt;
&gt;&gt; Could you give me an example of code or debug print of Node.js client that
&gt;&gt; includes the source string before being signed by a secret key?
&gt;&gt;
&gt;&gt; Otherwise maybe that client is just using v4 authentication which we
&gt;&gt; haven't yet supported. To avoid it, please try v2 authentication.
&gt;&gt;
&gt;&gt; 2015/02/26 9:06 "Patrick F. Marques" :
&gt;&gt;&gt;
&gt;&gt;&gt; Hi everyone,
&gt;&gt;&gt;
&gt;&gt;&gt; I'm trying to use AWS SDK as a S3 client for Riack CS to upload large
&gt;&gt;&gt; objects that I usually don't know the its size, for that propose I'm trying
&gt;&gt;&gt; to use the multipart upload like in the SDK example
&gt;&gt;&gt; https://github.com/aws/aws-sdk-js/blob/master/doc-src/guide/node-examples.md#amazon-s3-uploading-an-arbitrarily-sized-stream-upload.
&gt;&gt;&gt; The problem is that I'm always getting Access Denied.
&gt;&gt;&gt;
&gt;&gt;&gt; I've been trying some other clients but also without success.
&gt;&gt;&gt;
&gt;&gt;&gt; Best regards,
&gt;&gt;&gt; Patrick Marques
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;



-- 
Kota UENISHI / @kuenishi
Basho Japan KK

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

