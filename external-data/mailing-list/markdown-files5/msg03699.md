---
title: "Re: speeding up riaksearch precommit indexing"
description: ""
project: community
lastmod: 2011-06-15T05:30:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03699"
mailinglist_parent_id: "msg03662"
author_name: "Rusty Klophaus"
project_section: "mailinglistitem"
sent_date: 2011-06-15T05:30:19-07:00
---


Hi Steve,

Thanks for sending over more details.

The pre- vs. post-commit hook question is a good one. The reason we chose a
pre-commit hook over a post-commit hook for Riak Search indexing is because
a post commit hook doesn't currently provide back-pressure to the Riak KV
side of the system. It would be possible to get yourself into a situation
where the queue of objects to index is so large that it exhausts available
resources. The pre-commit hook prevents that situation.

Everything in your setup below appears correct, so it may be time to look
into batching as a way to increase the speed of indexing.

Best,
Rusty


On Mon, Jun 13, 2011 at 1:45 PM, Steve Webb  wrote:

&gt; Ok, I've changed my two VMs to each have:
&gt;
&gt; 3 CPUs, 1GB ram, 120GB disk
&gt;
&gt; I'm ingesting the twitter spritzer stream (about 10-20 tweets per second,
&gt; approx 2k of data per tweet). One bucket is storing the non-indexed tweets
&gt; in full. Another bucket is storing the indexed tweet string, id, date and
&gt; username. A maximum of 20 clients can be hitting the 'cluster' at any one
&gt; time.
&gt;
&gt; I'm using n\\_val=2 so there is replication going on behind the scenes.
&gt;
&gt; I'm using a hardware load-balancer to distribute the work amongst the two
&gt; nodes and now I'm seeing about 75% CPU usage as opposed to 100% on one node
&gt; and 50% on the replicating-only node.
&gt;
&gt; I've monitored the VM over the last few days and it seems to be mostly
&gt; CPU-bound. The disk I/O is low. The Network I/O is low.
&gt;
&gt; Q: Can I change the pre-commit to a post-commit trigger or something
&gt; perhaps or will that make any difference at all? I'm ok if the tweet stuff
&gt; doesn't get indexed immediately and there's a slight lag in indexing if it
&gt; saves on CPU.
&gt;
&gt; Here's my search schema (the default, I think):
&gt;
&gt; root@ha2:/var/log/riaksearch# search-cmd show\\_schema Index
&gt; Attempting to restart script through sudo -u riak
&gt;
&gt; %% Schema for 'Index'
&gt;
&gt; {
&gt; schema,
&gt; [
&gt; {version, "1.1"},
&gt; {n\\_val, 3},
&gt; {default\\_field, "value"},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; whitespace\\_analyzer\\_factory}}
&gt; ],
&gt; [
&gt; %% Field names ending in "\\_num" are indexed as integers
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_num"},
&gt; {type, integer},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; integer\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Field names ending in "\\_int" are indexed as integers
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_int"},
&gt; {type, integer},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; integer\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Field names ending in "\\_dt" are indexed as dates
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_dt"},
&gt; {type, date},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; noop\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Field names ending in "\\_date" are indexed as dates
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_date"},
&gt; {type, date},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; noop\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Field names ending in "\\_txt" are indexed as full text"
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_txt"},
&gt; {type, string},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; standard\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Field names ending in "\\_text" are indexed as full text"
&gt; {dynamic\\_field, [
&gt; {name, "\\*\\_text"},
&gt; {type, string},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; standard\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Everything else is a string
&gt; {dynamic\\_field, [
&gt; {name, "\\*"},
&gt; {type, string},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; whitespace\\_analyzer\\_factory}}
&gt; ]}
&gt; ]
&gt; }.
&gt;
&gt; Here's an indexed record:
&gt;
&gt; root@ha1:~# curl -s http://ha:8098/riak/gnip/80329247314550784 | json\\_xs
&gt; {
&gt; "created\\_at" : "Mon Jun 13 17:42:39 +0000 2011",
&gt; "tweet" : "@NielJDBSimpson yeaah",
&gt; "screen\\_name" : "SophieBieber69"
&gt; }
&gt;
&gt; A non-indexed record:
&gt;
&gt; root@ha1:~# curl -s http://ha:8098/riak/tweets/80329247314550784
&gt;
&gt; "{\\"entities\\":{\\"urls\\":[],\\"hashtags\\":[],\\"user\\_mentions\\":[{\\"indices\\":[0,15],\\"screen\\_name\\":\\"NielJDBSimpson\\",\\"name\\":\\"\\\\u2665Enielle
&gt; Anne\\\\u2665
&gt; \\\\u25d5\\\\u203f\\\\u25d5\\",\\"id\\_str\\":\\"197405933\\",\\"id\\":197405933}]},\\"retweet\\_count\\":0,\\"truncated\\":false,\\"text\\":\\"@NielJDBSimpson
&gt; yeaah\\",\\"created\\_at\\":\\"Mon Jun 13 17:42:39 +0000
&gt; 2011\\",\\"place\\":null,\\"in\\_reply\\_to\\_status\\_id\\":77609368182472704,\\"coordinates\\":null,\\"source\\":\\"web\\",\\"geo\\":null,\\"favorited\\":false,\\"in\\_reply\\_to\\_status\\_id\\_str\\":\\"77609368182472704\\",\\"id\\_str\\":\\"80329247314550784\\",\\"in\\_reply\\_to\\_screen\\_name\\":\\"N
&gt; ielJDBSimpson\\",\\"in\\_reply\\_to\\_user\\_id\\_str\\":\\"197405933\\",\\"user\\":{\\"lang\\":\\"en\\",\\"created\\_at\\":\\"Wed
&gt; May 04 17:02:14 +0000
&gt; 2011\\",\\"profile\\_text\\_color\\":\\"3D1957\\",\\"profile\\_image\\_url\\":\\"http:\\\\\\/\\\\\\/
&gt; a3.twimg.com
&gt; \\\\\\/profile\\_images\\\\\\/1372500926\\\\\\/IMG01256-20110418-1827\\_normal.jpg\\",\\"is\\_translator\\":false,\\"statuses\\_count\\":124,\\"profile\\_sidebar\\_fill\\_color\\":\\"7AC3EE\\",\\"li
&gt; sted\\_count\\":0,\\"following\\":null,\\"profile\\_background\\_tile\\":true,\\"friends\\_count\\":425,\\"description\\":\\"I
&gt; love Justin Bieber i saw him 23\\\\\\/03\\\\\\/2011 in concert best nite ever.
&gt; Never say Never imma beliber.Follow me I will follow back xx
&gt; :P\\",\\"screen\\_name\\":\\"SophieBieber69\\",\\"contributors\\_enabled\\":false,\\"verified\\":false,\\"profile\\_link\\_color\\":\\"FF0000\\",\\"url\\":null,\\"profile\\_sidebar\\_border\\_color\\":\\"65B0DA\\",\\"default\\_profile\\_image\\":false,\\"time\\_zone\\":null,\\"protected\\":false,\\"i
&gt; d\\_str\\":\\"293033762\\",\\"notifications\\":null,\\"profile\\_use\\_background\\_image\\":true,\\"favourites\\_count\\":6,\\"location\\":\\"Sheffield\\",\\"name\\":\\"Sophie
&gt; Bieber
&gt; \\",\\"profile\\_background\\_color\\":\\"642D8B\\",\\"id\\":293033762,\\"default\\_profile\\":false,\\"show\\_all\\_inline\\_media\\":false,\\"follow\\_request\\_sent\\":null,\\"geo\\_enabled\\":false,\\"profile\\_background\\_image\\_url\\":\\"http:\\\\\\/\\\\\\/
&gt; a1.twimg.com\\\\\\/images\\\\\\/themes\\\\\\/th
&gt;
&gt; eme10\\\\\\/bg.gif\\",\\"utc\\_offset\\":null,\\"followers\\_count\\":184},\\"id\\":80329247314550784,\\"contributors\\":null,\\"retweeted\\":false,\\"in\\_reply\\_to\\_user\\_id\\":197405933}\\r"
&gt;
&gt; - Steve Webb
&gt;
&gt; -- Steve Webb - Senior System Administrator for gnip.com
&gt; http://twitter.com/GnipWebb
&gt;
&gt;
&gt; On Thu, 9 Jun 2011, Rusty Klophaus wrote:
&gt;
&gt; Hi Steve,
&gt;&gt;
&gt;&gt; Riak does best with a lot of memory and a fast disk. Depending on how much
&gt;&gt; data you have in the system, putting two nodes into 1GB of memory on a
&gt;&gt; single VM may be causing the system to overrun available resources and
&gt;&gt; page
&gt;&gt; out to disk, and depending on how you've set up your virtualized
&gt;&gt; environment, you could be paying extra costs with each disk access,
&gt;&gt; compounding the problem. My first recommendation would be to either run
&gt;&gt; the
&gt;&gt; test again while monitoring disk operations using iostat to see if disk is
&gt;&gt; the problem, or to just go ahead and test on bigger hardware. I suspect
&gt;&gt; you
&gt;&gt; will see much less of a performance difference between the tests once
&gt;&gt; there
&gt;&gt; are ample resources.
&gt;&gt;
&gt;&gt; That said, some slowdown is expected when you turn on indexing, as Riak
&gt;&gt; Search adds quite a bit of overhead in parsing and tokenizing the
&gt;&gt; document,
&gt;&gt; and then storing the results.
&gt;&gt;
&gt;&gt; There are two ways to speed up indexing:
&gt;&gt;
&gt;&gt; 1. Reduce the size of your documents. If your documents are large, but
&gt;&gt;
&gt;&gt; you only need one or two fields indexed, you can create smaller
&gt;&gt; "surrogate"
&gt;&gt; documents with just the fields you need indexed, plus a link back to your
&gt;&gt; original document.
&gt;&gt; 2. Batch your writes using the Solr interface. Riak Search uses
&gt;&gt;
&gt;&gt; "term-based partitioning". Term-based partitioning reduces complexity
&gt;&gt; during
&gt;&gt; queries, at the cost of increased complexity during writes. You can gain
&gt;&gt; back some of the lost performance by batching your writes. This allows
&gt;&gt; the
&gt;&gt; system to plan which messages it sends more intelligently, thus sending
&gt;&gt; fewer messages and reducing overhead. The downside here is that you can't
&gt;&gt; use the Riak KV interface, you need to switch to the Solr interface.
&gt;&gt;
&gt;&gt; Would you mind describing a bit more about your the size and shape of your
&gt;&gt; data (how many objects, average object size, object format, throughput,
&gt;&gt; etc.) and ideally attach your Riak Search schema?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Rusty
&gt;&gt;
&gt;&gt;
&gt;&gt; On Tue, Jun 7, 2011 at 4:35 PM, Steve Webb  wrote:
&gt;&gt;
&gt;&gt; Hey there.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm inserting twitter spritzer tweets into a bucket that doesn't have a
&gt;&gt;&gt; precommit index hook, and a few fields from the tweet into a second
&gt;&gt;&gt; bucket
&gt;&gt;&gt; that does have the precommit hook.
&gt;&gt;&gt;
&gt;&gt;&gt; Speeds on the inserts into the indexed bucket are an order or magnitude
&gt;&gt;&gt; slower than the non-indexed bucket.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm using a 1GB ram, 20GB disk vmware VM, 2-node cluster, ubuntu 10.4,
&gt;&gt;&gt; riaksearch 0.14.0 with n\\_val = 2.
&gt;&gt;&gt;
&gt;&gt;&gt; Is there a way to do a more lazy indexing to where it doesn't slow down
&gt;&gt;&gt; inserts so much?
&gt;&gt;&gt;
&gt;&gt;&gt; - Steve
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Steve Webb - Senior System Administrator for gnip.com
&gt;&gt;&gt; http://twitter.com/GnipWebb
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

