---
title: "Re: Understanding read_repairs"
description: ""
project: community
lastmod: 2013-02-27T13:23:20-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10279"
mailinglist_parent_id: "msg10277"
author_name: "Jared Morrow"
project_section: "mailinglistitem"
sent_date: 2013-02-27T13:23:20-08:00
---


Belai,

Active Anti-Entropy is doing work building trees and checking data, so it
will slow down gets/puts slightly. If you can't accept the slight
performance hit, disabling it is the right choice. In our testing, if you
use eLevelDB, 1.3.0 with AAE enabled is faster than 1.2.1 without AAE in
most cases due to the other speedups added to eLevelDB in 1.3.0. Since
Bitcask runs about the limit of what a filesystem can handle, AAE
definitely shows a slight performance hit since it is accessing the
filesystem as well.

Glad to hear the patch solved your other issues.

-Jared



On Wed, Feb 27, 2013 at 1:13 PM, Belai Beshah wrote:

&gt; Patch worked good on 1.3, no more continuous read repairs. However, we
&gt; started seeing problems with Set/Get of about 0.1% which was not there in
&gt; the 1.2 release. Since this happens even without the patch on a clean 1.3
&gt; install we narrowed it down to being Active Anti-Entropy since it looks
&gt; like it is always actively fixing data, may it is our write and read
&gt; immediately pattern or the fact that we have only a single 4TB disk
&gt; behind each node and they can't keep up. With Active Anti-Entropy turned
&gt; off all our tests passed and performance returned to 1.2 levels without
&gt; any read repairs. For now we are happy to continue our tests with Active
&gt; Anti-Entropy turned off but it will be great if we can get some pointer
&gt; from the experts that could explain the behavior we saw. Thanks you guys
&gt; for the help.
&gt;
&gt; ------------------------------
&gt; \\*From:\\* Jared Morrow [ja...@basho.com]
&gt; \\*Sent:\\* Friday, February 22, 2013 11:56 AM
&gt; \\*To:\\* Belai Beshah
&gt; \\*Cc:\\* Russell Brown; riak-users@lists.basho.com
&gt; \\*Subject:\\* Re: Understanding read\\_repairs
&gt;
&gt; Belai,
&gt;
&gt; One other option is to use our "basho-patches" functionality. We use it to
&gt; run new code on current installations where sending a new .beam file is
&gt; easier than remaking the packages or compiling from source. On your ubuntu
&gt; system using our packages, the folder should be in
&gt; /usr/lib/riak/lib/basho-patches.
&gt;
&gt; To do this you just need the one file changed in the PR pointed to by
&gt; Russell.
&gt;
&gt; Here are the steps to make that happen:
&gt;
&gt; - Install Erlang R15B01:
&gt; http://docs.basho.com/riak/latest/tutorials/installation/Installing-Erlang/
&gt; - Get riak\\_kv: git clone git://github.com/basho/riak\\_kv.git
&gt; - compile riak\\_kv with just 'make'
&gt; - copy the resulting .beam file in the ebin folder to the machines you
&gt; need the new file: scp ebin/riak\\_kv\\_vnode.beam user@myriaknode
&gt; :/usr/lib/riak/lib/basho-patches
&gt; - stop each node and restart them one at a time
&gt; - If you want to convince yourself you are using the new code, you can
&gt; do a 'riak attach' to attach to the node and run
&gt; code:which('riak\\_kv\\_vnode'). (Don't forget the '.' at the end)
&gt;
&gt; For example on my dev install here is the command before the file is in
&gt; basho-patches:
&gt;
&gt; (dev2@127.0.0.1)1&gt; code:which('riak\\_kv\\_vnode').
&gt; ".../lib/riak\\_kv-1.3.0/ebin/riak\\_kv\\_vnode.beam"
&gt;
&gt; Here is the command after I put the .beam in the basho-patches directory:
&gt;
&gt; (dev2@127.0.0.1)1&gt; code:which('riak\\_kv\\_vnode').
&gt; ".../lib/basho-patches/riak\\_kv\\_vnode.beam"
&gt;
&gt; Notice the path of the code changed from .../riak\\_kv-1.3.0/... to
&gt; .../basho-patches/...
&gt;
&gt; That might seem like a lot of work, but it is a really handy and useful
&gt; trick/skill that you might use quite a bit down the road.
&gt;
&gt; Hope that helps,
&gt; Jared
&gt;
&gt;
&gt; On Fri, Feb 22, 2013 at 10:25 AM, Belai Beshah wrote:
&gt;
&gt;&gt; Thanks Russel, that looks like exactly the problem we saw. I have never
&gt;&gt; built riak from source before but I will give it a try it this weekend.
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; From: Russell Brown [russell.br...@me.com]
&gt;&gt; Sent: Friday, February 22, 2013 1:24 AM
&gt;&gt; To: Belai Beshah
&gt;&gt; Cc: riak-users@lists.basho.com
&gt;&gt; Subject: Re: Understanding read\\_repairs
&gt;&gt;
&gt;&gt; Hi,
&gt;&gt; Thanks for trying Riak.
&gt;&gt;
&gt;&gt; On 21 Feb 2013, at 23:48, Belai Beshah  wrote:
&gt;&gt;
&gt;&gt; &gt; Hi All,
&gt;&gt; &gt;
&gt;&gt; &gt; We are evaluating Riak to see if it can be used to cache large blobs of
&gt;&gt; data. Here is our test cluster setup:
&gt;&gt; &gt;
&gt;&gt; &gt; • six Ubuntu LTS 12.04 dedicated nodes with 8 core 2.6 Ghz CPU,
&gt;&gt; 32 GB RAM, 3.6T disk
&gt;&gt; &gt; • {pb\\_backlog, 64},
&gt;&gt; &gt; • {ring\\_creation\\_size, 256},
&gt;&gt; &gt; • {default\\_bucket\\_props, [{n\\_val, 2},
&gt;&gt; {allow\\_mult,false},{last\\_write\\_wins,true}]},
&gt;&gt; &gt; • using bitcask as the backend
&gt;&gt; &gt;
&gt;&gt; &gt; Everything else default except the above. There is an HAProxy load
&gt;&gt; balancer infront of the nodes that the clients talk too configured
&gt;&gt; according to the basho wiki. Due to the nature of the application we are
&gt;&gt; integrating we do about 1200/s writes of approximately 40-50KB each and
&gt;&gt; read them back almost immediately. We noticed a lot of read repairs and
&gt;&gt; since that was one of the things that could indicate performance problem we
&gt;&gt; go worried. So we wrote a simple java client application that simulates our
&gt;&gt; use case. The test program is dead simple:
&gt;&gt; &gt; • generate keys using random UUID and value using Apache commons
&gt;&gt; RandomStringUtils
&gt;&gt; &gt; • create a thread pool of 5 and store key/value using
&gt;&gt; “bucket.store()”
&gt;&gt; &gt; • read the values back using “bucket.fetch()” multiple times
&gt;&gt; &gt; I could provide the spike code if needed. What we noticed is that we
&gt;&gt; get a lot of read repairs all over the place. We even made it use a single
&gt;&gt; thread to read/write, played with the write/read quorum and even put a
&gt;&gt; delay of 5 minutes between the writes before the reads start to give the
&gt;&gt; cluster time to be eventually consistent. Nothing helps, we always see a
&gt;&gt; lot of read repairs, sometime as many as the number of inserts.
&gt;&gt;
&gt;&gt;
&gt;&gt; It sounds like you are experiencing this bug
&gt;&gt; https://github.com/basho/riak\\_kv/pull/334
&gt;&gt;
&gt;&gt; It is fixed in master, but it doesn't look like it made it into 1.3.0. If
&gt;&gt; you're ok with building from source, I tried it and a patch from
&gt;&gt; 8895d2877576af2441bee755028df1a6cf2174c7 goes cleanly onto 1.3.0.
&gt;&gt;
&gt;&gt; Cheers
&gt;&gt;
&gt;&gt; Russell
&gt;&gt;
&gt;&gt;
&gt;&gt; &gt; The good thing is that in all of these tests we have not seen any read
&gt;&gt; failures. Performance is also not bad, a few maxs here and there we don't
&gt;&gt; like but 90% looks good. Even when we killed a node, the reads are still
&gt;&gt; successful.
&gt;&gt; &gt;
&gt;&gt; &gt; We are wondering what the expected ratio of read repairs is and what is
&gt;&gt; a reasonable time for the cluster not to restore to read\\_repair to fulfill
&gt;&gt; a read request or is there something we are missing in our setup.
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks
&gt;&gt; &gt; Belai
&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

