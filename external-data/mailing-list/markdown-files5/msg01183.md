---
title: "Re: erlang:phash2(now())"
description: ""
project: community
lastmod: 2010-10-04T07:00:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01183"
mailinglist_parent_id: "msg01181"
author_name: "eF"
project_section: "mailinglistitem"
sent_date: 2010-10-04T07:00:27-07:00
---


forget deleting refs, I confused it with another project.

On 4 October 2010 11:17, Lev Walkin  wrote:

&gt;
&gt; In some of my tests there were improvements in the order of single digit
&gt; percentages. That's a good enough for me to get rid of phashing now(). Don't
&gt; forget about GC implications of getting now() in and out.
&gt;
&gt; What do you mean you could delete refs? I believe refs are not better than
&gt;
&gt; On Oct 4, 2010, at 1:44 AM, eF wrote:
&gt;
&gt; I forked riak from github some time ago substitute erlang:phash2 with
&gt; make\\_ref. I did not reveal any significant performance jump ;)
&gt;
&gt; However I agree with you that make\\_ref just looks better and seems to be
&gt; more accurate. Actually, no hash is needed (at least in riak\\_client) because
&gt; it is used to match on specific messages (to not mix map/reds etc.) and we
&gt; can easily match on make\\_ref which is as good as any erlang term.
&gt;
&gt; My initial motivation was better control over memory (i.e. I could delete
&gt; refs), but there was no improvement also, so I gave up the idea.
&gt;
&gt;
&gt; Michal Zajda
&gt;
&gt; On 2 October 2010 16:00, Lev Walkin  wrote:
&gt;
&gt;&gt;
&gt;&gt; In riak sources there are many references to erlang:phash2(erlang:now()).
&gt;&gt;
&gt;&gt; Why not use idiomatic make\\_ref() or at the very least
&gt;&gt; erlang:phash2(make\\_ref()), which is faster?
&gt;&gt;
&gt;&gt; 1&gt; perftest:comprehensive(100000, fun() -&gt; erlang:phash2(erlang:now())
&gt;&gt; end).
&gt;&gt; Sequential 100000 cycles in ~1 seconds (193510 cycles/s)
&gt;&gt; Parallel 2 100000 cycles in ~1 seconds (187282 cycles/s)
&gt;&gt; Parallel 4 100000 cycles in ~1 seconds (197310 cycles/s)
&gt;&gt; Parallel 10 100000 cycles in ~1 seconds (182890 cycles/s)
&gt;&gt; Parallel 100 100000 cycles in ~0 seconds (208671 cycles/s)
&gt;&gt; [197310,182890,208671]
&gt;&gt; 2&gt; perftest:comprehensive(100000, fun() -&gt; erlang:phash2(make\\_ref()) end).
&gt;&gt; Sequential 100000 cycles in ~0 seconds (323952 cycles/s)
&gt;&gt; Parallel 2 100000 cycles in ~0 seconds (301875 cycles/s)
&gt;&gt; Parallel 4 100000 cycles in ~0 seconds (308568 cycles/s)
&gt;&gt; Parallel 10 100000 cycles in ~0 seconds (287875 cycles/s)
&gt;&gt; Parallel 100 100000 cycles in ~0 seconds (326416 cycles/s)
&gt;&gt; [308568,287875,326416]
&gt;&gt; 3&gt; perftest:comprehensive(100000, fun() -&gt; make\\_ref() end).
&gt;&gt; Sequential 100000 cycles in ~0 seconds (1299765 cycles/s)
&gt;&gt; Parallel 2 100000 cycles in ~0 seconds (934492 cycles/s)
&gt;&gt; Parallel 4 100000 cycles in ~0 seconds (1111679 cycles/s)
&gt;&gt; Parallel 10 100000 cycles in ~0 seconds (1241434 cycles/s)
&gt;&gt; Parallel 100 100000 cycles in ~0 seconds (1264350 cycles/s)
&gt;&gt; [1111679,1241434,1264350]
&gt;&gt; 4&gt;
&gt;&gt;
&gt;&gt; make\\_ref is 6 times faster than erlang:phash2(make\\_ref()) which is 50%
&gt;&gt; faster than erlang:phash2(now()).
&gt;&gt;
&gt;&gt; Of course, in the grand scheme of things this might not be your biggest
&gt;&gt; bottleneck, but why hashing now() when there exsists an idiomatic make\\_ref()
&gt;&gt; solution? Am I missing something?
&gt;&gt;
&gt;&gt; --
&gt;&gt; Lev Walkin
&gt;&gt; v...@lionet.info
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; vlm
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

