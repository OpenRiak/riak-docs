---
title: "Re: Riak 2.9.0 - Update Available"
description: ""
project: community
lastmod: 2019-06-28T02:25:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18622"
mailinglist_parent_id: "msg18621"
author_name: "Martin Sumner"
project_section: "mailinglistitem"
sent_date: 2019-06-28T02:25:27-07:00
---


Bryan,

We saw that Riak was using much more memory than was expected at the end of
the handoffs. Using `riak-admin top` we could see that this wasn't process
memory, but binaries. Firstly did some work via attach looping over
processes and running GC to confirm that this wasn't a failure to collect
garbage - the references to memory were real. Then did a bit of work in
attach writing some functions to analyse process\\_info/2 for each process
(looking at binary and memory), and discovered that there were penciller
processes that had lots of references to lots of large binaries (and this
accounted for all the unexpected memory use), and where the penciller was
the only process with a reference to the binary. This made no sense
initially as the penciller should only have small binaries (metadata).
Then looked at the running state of the penciller processes and could see
no large binaries in the state, but could see that a lot of the active keys
in the penciller were keys that were known to have large object values (but
small amounts of metadata) - and that the size of the object values were
the same as the size of the binary references found on the penciller
process via process\\_info/2..

I then recalled the first part of this:
https://dieswaytoofast.blogspot.com/2012/12/erlang-binaries-and-garbage-collection.html.
It was obvious that in extracting the metadata the beam was naturally
retaining a reference to the whole binary, as long as the sub-binary was
retained by the a process (the Penciller). Forcing a binary copy resolved
this referencing issue. It was nice that the same tools used to detect the
issue, made it quite easy to write a test to confirm resolution -
https://github.com/martinsumner/leveled/blob/master/test/end\\_to\\_end/riak\\_SUITE.erl#L1214-L1239
.

The memory leak section of Fred Herbert's http://www.erlang-in-anger.com/ is
great reading for helping with these types of issues.

Thanks

Martin


On Fri, 28 Jun 2019 at 09:46, b h  wrote:

&gt; Nice work - I've read issue / PR - how did you discover / track it down -
&gt; tools or just reading the code ?
&gt;
&gt; On Fri, 28 Jun 2019 at 09:35, Martin Sumner 
&gt; wrote:
&gt;
&gt;&gt; There is now a second update available for 2.9.0:
&gt;&gt; https://github.com/basho/riak/tree/riak-2.9.0p2.
&gt;&gt;
&gt;&gt; This patch, like the patch before, resolves a memory management issue in
&gt;&gt; leveled, which this time could be triggered by sending many large objects
&gt;&gt; in a short period of time. The underlying problem is described a bit
&gt;&gt; further here https://github.com/martinsumner/leveled/issues/285, and is
&gt;&gt; resolved by leveled working more sympathetically with the beam binary
&gt;&gt; memory management.
&gt;&gt;
&gt;&gt; Switching to the patched version is not urgent unless you are using the
&gt;&gt; leveled backend, and may send a large number of large objects in a burst.
&gt;&gt;
&gt;&gt; Updated packages are available (thanks to Nick Adams at TI Tokyo) -
&gt;&gt; https://files.tiot.jp/riak/kv/2.9/2.9.0p2/
&gt;&gt;
&gt;&gt; Thanks again to the testing team at the NHS Spine project, Aaron Gibbon
&gt;&gt; (BJSS) and Ramen Sen, who discovered the problem. The issue was discovered
&gt;&gt; in a handoff scenario where there were a tens of thousands of 2MB objects
&gt;&gt; stored in a portion of the keyspace at the end of the handoff - which led
&gt;&gt; to memory issues until either more PUTs were received (to force a persist
&gt;&gt; to disk) or a restart occurred..
&gt;&gt;
&gt;&gt; Regards
&gt;&gt;
&gt;&gt;
&gt;&gt; On Sat, 25 May 2019 at 09:35, Martin Sumner 
&gt;&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Unfortunately, Riak 2.9.0 was released with an issue whereby a race
&gt;&gt;&gt; condition in heavy-PUT scenarios (e.g. handoffs), could cause a leak of
&gt;&gt;&gt; file descriptors.
&gt;&gt;&gt;
&gt;&gt;&gt; The issue is described here -
&gt;&gt;&gt; https://github.com/basho/riak\\_kv/issues/1699, and the underlying issue
&gt;&gt;&gt; here - https://github.com/martinsumner/leveled/issues/278.
&gt;&gt;&gt;
&gt;&gt;&gt; There is a new patched version of the release available (2.9.0p1) at
&gt;&gt;&gt; https://github.com/basho/riak/tree/riak-2.9.0p1. This should be used
&gt;&gt;&gt; in preference to the original release of 2.9.0.
&gt;&gt;&gt;
&gt;&gt;&gt; Updated packages are available (thanks to Nick Adams at TI Tokyo) -
&gt;&gt;&gt; https://files.tiot.jp/riak/kv/2.9/2.9.0p1/
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks also to the testing team at the NHS Spine project, Aaron Gibbon
&gt;&gt;&gt; (BJSS) and Ramen Sen, who discovered the problem.
&gt;&gt;&gt;
&gt;&gt;&gt; Regards
&gt;&gt;&gt;
&gt;&gt;&gt; Martin
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

