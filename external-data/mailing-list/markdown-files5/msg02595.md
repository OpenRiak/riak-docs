---
title: "Re: annoying javascript problem in Reduce phases"
description: ""
project: community
lastmod: 2011-03-10T04:50:03-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02595"
mailinglist_parent_id: "msg02594"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-03-10T04:50:03-08:00
---


Antonio,

Sorry it's a little buried in the documentation, but be aware that Reduce 
phases \\*may\\* be called more than once (CouchDB calls this rereduce). What you 
experience in the last example is a demonstration of that: you must structure 
your reduce function such that it can receive as inputs anything that it 
outputs. The array/list that you return as the output will be concatenated 
with more values on the subsequent applications of the function. Your reduce 
function can (almost) never assume that it is operating on the entire result 
set.

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On Mar 10, 2011, at 5:32 AM, Antonio Rohman Fernandez wrote:

&gt; Dear All,
&gt; I'm having a pretty annoying Javascript problem and would like to know if is 
&gt; a bug (most likely) or if somebody has a solution.
&gt; 
&gt; This is the sample data i'm playing with:
&gt; bucket -&gt; 'testbucket'
&gt; key00001:{"name":"antonio","dob":1981,"country":"Spain"}
&gt; key00002:{"name":"rohman","dob":1982,"country":"Taiwan"}
&gt; key00003:{"name":"fernandez","dob":1983,"country":"US"}
&gt; key00004:{"name":"lee","dob":1984,"country":"Japan"}
&gt; key00005:{"name":"bruce","dob":1985,"country":"China"}
&gt; 
&gt; MAP ONLY: 
&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt; { return [v.values[0].data]; }"}}]}
&gt; 
&gt; The Mapping phase ( nothing special, just gives back the values of all keys 
&gt; in the bucket ) gives the correct data, an array of all my key's values:
&gt; ["{\\"name\\":\\"rohman\\",\\"dob\\":1982,\\"country\\":\\"Taiwan\\"}",
&gt; "{\\"name\\":\\"bruce\\",\\"dob\\":1985,\\"country\\":\\"China\\"}",
&gt; "{\\"name\\":\\"fernandez\\",\\"dob\\":1983,\\"country\\":\\"US\\"}",
&gt; "{\\"name\\":\\"antonio\\",\\"dob\\":1981,\\"country\\":\\"Spain\\"}",
&gt; "{\\"name\\":\\"lee\\",\\"dob\\":1984,\\"country\\":\\"Japan\\"}"]
&gt; 
&gt; REDUCE (try1:OK): 
&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt; {"language":"javascript","source":"function(v,a) { return v; }"}}]}
&gt; 
&gt; This kinda useless Reduce phase returns the data as it is, even the order is 
&gt; reversed... seems ok:
&gt; ["{\\"name\\":\\"lee\\",\\"dob\\":1984,\\"country\\":\\"Japan\\"}",
&gt; "{\\"name\\":\\"fernandez\\",\\"dob\\":1983,\\"country\\":\\"US\\"}",
&gt; "{\\"name\\":\\"rohman\\",\\"dob\\":1982,\\"country\\":\\"Taiwan\\"}",
&gt; "{\\"name\\":\\"antonio\\",\\"dob\\":1981,\\"country\\":\\"Spain\\"}",
&gt; "{\\"name\\":\\"bruce\\",\\"dob\\":1985,\\"country\\":\\"China\\"}"]
&gt; 
&gt; REDUCE (try2:OK): 
&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt; {"language":"javascript","source":"function(v,a) { return [v[1]]; }"}}]}
&gt; 
&gt; This Reduce phase just return the 2nd item array[1] of the result... seems ok 
&gt; too!:
&gt; ["{\\"name\\":\\"fernandez\\",\\"dob\\":1983,\\"country\\":\\"US\\"}"]
&gt; 
&gt; REDUCE (try3:!!!!!): 
&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt; {"language":"javascript","source":"function(v,a) { return [v[3]]; }"}}]}
&gt; 
&gt; This Reduce phase SHOULD return the 4th item of the array... but returns 
&gt; NULL!!!!:
&gt; [null] &lt;-- WTF... works for [v[0]], [v[1]], [v[2]] but fails from [v[3]]...
&gt; 
&gt; REDUCE (try4:!!!!!): 
&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt; {"language":"javascript","source":"function(v,a) { return [v]; }"}}]}
&gt; 
&gt; This Reduce phase returns the data inside an array... but with a wrong patter 
&gt; [[1,1,1,[1,1]]]!!!:
&gt; [
&gt; ["{\\"name\\":\\"lee\\",\\"dob\\":1984,\\"country\\":\\"Japan\\"}",
&gt; "{\\"name\\":\\"fernandez\\",\\"dob\\":1983,\\"country\\":\\"US\\"}",
&gt; "{\\"name\\":\\"rohman\\",\\"dob\\":1982,\\"country\\":\\"Taiwan\\"}",
&gt; ["{\\"name\\":\\"antonio\\",\\"dob\\":1981,\\"country\\":\\"Spain\\"}", &lt;---- See the 
&gt; weird extra array?
&gt; "{\\"name\\":\\"bitch\\",\\"dob\\":1985,\\"country\\":\\"China\\"}"]
&gt; ]
&gt; ]
&gt; 
&gt; that is transformed to this:
&gt; 
&gt; Array (
&gt; [0] =&gt; {"name":"lee","dob":1984,"country":"Japan"}
&gt; [1] =&gt; {"name":"fernandez","dob":1983,"country":"US"}
&gt; [2] =&gt; {"name":"rohman","dob":1982,"country":"Taiwan"}
&gt; [3] =&gt; Array (
&gt; [0] =&gt; {"name":"antonio","dob":1981,"country":"Spain"}
&gt; [1] =&gt; {"name":"bruce","dob":1985,"country":"China"}
&gt; )
&gt; )
&gt; 
&gt; I don't know what is going on with the javascript Reduce phase... but is 
&gt; killing me...
&gt; return v --&gt; OK
&gt; return [v[0]] --&gt; OK
&gt; return [v[1]] --&gt; OK
&gt; return [v[2]] --&gt; OK
&gt; return [v[3]] --&gt; ERROR ( and so on )
&gt; 
&gt; any ideas? thanks
&gt; Rohman
&gt; 
&gt; 
&gt; 
&gt; Antonio Rohman Fernandez
&gt; CEO, Founder & Lead Engineer
&gt; roh...@mahalostudio.com Projects
&gt; MaruBatsu.es
&gt; PupCloud.com
&gt; Wedding Album
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

