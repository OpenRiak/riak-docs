---
title: "Re: Randomizing Bitcask merges"
description: ""
project: community
lastmod: 2014-03-13T15:31:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13802"
mailinglist_parent_id: "msg13799"
author_name: "Sargun Dhillon"
project_section: "mailinglistitem"
sent_date: 2014-03-13T15:31:23-07:00
---


If you can afford the disk space, and potential latency overheads, you
can make your bitcask merges less frequent. You can find a window when
your databases are going to be in low-usage, and have each node have a
separate window for bitcask merges, which (A) will latency-level
across your cluster, and (B) ensure that latency-leveling doesn't when
you don't want it to.

On Thu, Mar 13, 2014 at 10:49 AM, Matthew MacClary
 wrote:
&gt; I thought I would share part of one of our post install scripts with the
&gt; community to get feedback. Our goal is to avoid big merges that affect the
&gt; whole cluster at once. We set the merge trigger and merge threshold to the
&gt; same value which should result in more frequent but smaller scoped merges.
&gt; The trigger for each riak node is set randomly between 50% and 85% for dead
&gt; bytes and "fragmentation". We also chose to use largish values for the
&gt; threshold because that dictates how much of our disk bandwidth we will
&gt; "waste", if you merge after 10% dead bytes - then your are "wasting" your
&gt; time copying 90% good bytes and only recovering 10% of the slab's disk
&gt; space.
&gt;
&gt; What we were seeing in testing is that soon after the cluster was installed,
&gt; all the nodes were doing heavy merges at the same time. This created a very
&gt; noticeable bad performance window. Over time the merges would start to
&gt; spread out a little bit due to random factors. I should also point out that
&gt; our work mix is basically 1:1:1:0 for write:read:delete:update so merging
&gt; happens a lot.
&gt;
&gt; We decided to make the merges smaller and start the cluster out with
&gt; randomized merges. If you read with a consistency value of 1, then there is
&gt; a good chance that if one replica is merging, then another replica vnode
&gt; would not be part of a merge and could reply with normal latency.
&gt;
&gt; Let me know what you think! Is any of this reasoning faulty?
&gt;
&gt; # values used to compute values for app.config file
&gt; NUMERATOR=2147483648 # matches max\\_file\\_size
&gt; DENOMINATOR=100
&gt;
&gt; THRESH=`shuf -i 50-85 -n 1`
&gt; #BYTES=$(expr $THRESH \\\\* 2147483648 / 100 )
&gt; BYTES=$(expr $THRESH \\\\* $NUMERATOR / $DENOMINATOR )
&gt;
&gt; sed -ri "s/(.\\*dead\\_bytes\\_merge\\_trigger,)\\d\\*.\\*$/\\1${BYTES}},/"
&gt; ${RIAK\\_CONFIG\\_STAGING}/app.config
&gt; sed -ri "s/(.\\*dead\\_bytes\\_threshold,)\\d\\*.\\*$/\\1${BYTES}},/"
&gt; ${RIAK\\_CONFIG\\_STAGING}/app.config
&gt;
&gt; sed -ri "s/(.\\*frag\\_merge\\_trigger,)\\d\\*.\\*$/\\1${THRESH}},/"
&gt; ${RIAK\\_CONFIG\\_STAGING}/app.config
&gt; sed -ri "s/(.\\*frag\\_threshold,)\\d\\*.\\*$/\\1${THRESH}},/"
&gt; ${RIAK\\_CONFIG\\_STAGING}/app.config
&gt;
&gt;
&gt; -Matt
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

