---
title: "Re: Riak Java client 100% CPU"
description: ""
project: community
lastmod: 2013-02-15T08:18:00-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10138"
mailinglist_parent_id: "msg10136"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2013-02-15T08:18:00-08:00
---


Daniel -

Fixed. I swear I thought I had edited the ACL.

Thanks,
- Roach

On Fri, Feb 15, 2013 at 6:08 AM, Daniel Iwan  wrote:
&gt; Hi
&gt;
&gt; Thanks for that and also for building riak-client with all dependencies.
&gt; But I'm afraid S3 bucket is password protected or link expired since I'm
&gt; getting AccessDenied on that 1.1.0 jar
&gt;
&gt; Daniel
&gt;
&gt;
&gt;
&gt; On 14 February 2013 17:22, Brian Roach  wrote:
&gt;&gt;
&gt;&gt; Daniel -
&gt;&gt;
&gt;&gt; Yes, sorry about that. This has been corrected in the current master
&gt;&gt; on github and version 1.1.0 of the client will be released today.
&gt;&gt; https://github.com/basho/riak-java-client/pull/212
&gt;&gt;
&gt;&gt; Thanks!
&gt;&gt; Brian Roach
&gt;&gt;
&gt;&gt; On Thu, Feb 14, 2013 at 9:31 AM, Daniel Iwan 
&gt;&gt; wrote:
&gt;&gt; &gt; I see 100% CPU very regularly on one of the Riak client (v1.0.7)
&gt;&gt; &gt; threads.
&gt;&gt; &gt; I think the place where it spins is connection reaper in
&gt;&gt; &gt; RiakConnectionPool
&gt;&gt; &gt;
&gt;&gt; &gt; I looked at it briefly and it seems that when it finds first connection
&gt;&gt; &gt; using peek but that does not expired it can spin in tight while loop.
&gt;&gt; &gt; I guess second peek() should be outside if block?
&gt;&gt; &gt;
&gt;&gt; &gt; private synchronized void doStart() {
&gt;&gt; &gt; if (idleConnectionTTLNanos &gt; 0) {
&gt;&gt; &gt; idleReaper.scheduleWithFixedDelay(new Runnable() {
&gt;&gt; &gt; public void run() {
&gt;&gt; &gt; RiakConnection c = available.peek();
&gt;&gt; &gt; while (c != null) {
&gt;&gt; &gt; long connIdleStartNanos =
&gt;&gt; &gt; c.getIdleStartTimeNanos();
&gt;&gt; &gt; if (connIdleStartNanos + idleConnectionTTLNanos
&gt;&gt; &gt; &lt;
&gt;&gt; &gt; System.nanoTime()) {
&gt;&gt; &gt; if (c.getIdleStartTimeNanos() ==
&gt;&gt; &gt; connIdleStartNanos) {
&gt;&gt; &gt; // still a small window, but better than
&gt;&gt; &gt; locking
&gt;&gt; &gt; // the whole pool
&gt;&gt; &gt; boolean removed = available.remove(c);
&gt;&gt; &gt; if (removed) {
&gt;&gt; &gt; c.close();
&gt;&gt; &gt; permits.release();
&gt;&gt; &gt; }
&gt;&gt; &gt; }
&gt;&gt; &gt; c = available.peek();
&gt;&gt; &gt; }
&gt;&gt; &gt; }
&gt;&gt; &gt; }
&gt;&gt; &gt; }, idleConnectionTTLNanos, idleConnectionTTLNanos,
&gt;&gt; &gt; TimeUnit.NANOSECONDS);
&gt;&gt; &gt; }
&gt;&gt; &gt;
&gt;&gt; &gt; state = State.RUNNING;
&gt;&gt; &gt; }
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; Regards
&gt;&gt; &gt; Daniel Iwan
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; &gt;
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

