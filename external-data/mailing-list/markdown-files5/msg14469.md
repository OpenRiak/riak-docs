---
title: "Re: Riak CS: Undeletable broken buckets"
description: ""
project: community
lastmod: 2014-07-08T01:57:14-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14469"
mailinglist_parent_id: "msg14466"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2014-07-08T01:57:14-07:00
---


Hi Shunichi,
Enabling that temporarily then enabled me to remove the buckets by
first creating (s3cmd mb) and then removing (s3cmd rb) the problematic
buckets.

Thanks,
Toby

On 7 July 2014 19:38, Shunichi Shinohara  wrote:
&gt; Hi Toby,
&gt;
&gt; There is a rarely used option "disable\\_local\\_bucket\\_check" in Riak CS.
&gt; I don't know it solves your case, please let me mention it.
&gt;
&gt; To use it, first set it in app.config of riak-cs (or
&gt; application:set\\_env/3 in shell),
&gt; {riak\\_cs, [...
&gt; {disable\\_local\\_bucket\\_check, true},
&gt; ...]},
&gt; Then create bucket as usual (e.g. s3cmd mb ...).
&gt;
&gt; These steps solves one of partial update patterns that Andrew mentioned.
&gt;
&gt; Thanks,
&gt; Shino
&gt;
&gt; On Mon, Jul 7, 2014 at 2:12 PM, Toby Corkindale  wrote:
&gt;&gt; Hi Andrew,
&gt;&gt; Thanks for the details.
&gt;&gt; The Puppet config should never have let it be setup with
&gt;&gt; allow\\_mult=false, but as this is a test cluster, it's possible
&gt;&gt; something went awry there at some point.
&gt;&gt;
&gt;&gt; If it's not really a bug that needs reporting then I can let it go.
&gt;&gt; Thanks,,
&gt;&gt; Toby
&gt;&gt;
&gt;&gt; On 7 July 2014 12:21, Andrew Stone  wrote:
&gt;&gt;&gt; Hi Toby,
&gt;&gt;&gt;
&gt;&gt;&gt; We've seen this scenario before. It occurs because riak-cs stores bucket
&gt;&gt;&gt; information in 2 places on disk:
&gt;&gt;&gt; 1) Inside the user record (for bucket permissions)
&gt;&gt;&gt; 2) Inside a global list of buckets, since each bucket must be unique
&gt;&gt;&gt;
&gt;&gt;&gt; What has happened most likely is that the bucket is no longer stored for the
&gt;&gt;&gt; given user, but still in the global list of bucket. It shows up in bucket
&gt;&gt;&gt; lists, but the current user doesn't have permission to actually do anything
&gt;&gt;&gt; with it. Essentially you have partially written (or partially deleted) data.
&gt;&gt;&gt; I believe the only time we saw this was when Riak was configured with
&gt;&gt;&gt; {allow\\_mult, false} which is an invalid setting when used with riak-cs.
&gt;&gt;&gt; Riak-cs uses siblings intelligently to merge conflicting data, and without
&gt;&gt;&gt; that it's possible to end up in these types of scenarios. Later versions of
&gt;&gt;&gt; riak-cs should refuse to run with {allow\\_mult, false}. I'd check your riak
&gt;&gt;&gt; config to see if that is the case here.
&gt;&gt;&gt;
&gt;&gt;&gt; We actually have scripts to detect and remove the bad buckets that we've
&gt;&gt;&gt; used in support. We can probably get you a copy if you want. Just let me
&gt;&gt;&gt; know. And make sure when running in production that allow\\_mult = true.
&gt;&gt;&gt;
&gt;&gt;&gt; -Andrew
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Sun, Jul 6, 2014 at 9:59 PM, Toby Corkindale  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt; At some point we've managed to create a couple of buckets that don't
&gt;&gt;&gt;&gt; work and can't be deleted (in a development/testing cluster, not
&gt;&gt;&gt;&gt; production).
&gt;&gt;&gt;&gt; They show up with both 's3cmd ls' or by querying the HTTP API for a
&gt;&gt;&gt;&gt; user's buckets.
&gt;&gt;&gt;&gt; However attempting to list files in the bucket, or removing the
&gt;&gt;&gt;&gt; bucket, or recreating the bucket, fails.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; It's not in a production cluster so it's not a huge concern to me, but
&gt;&gt;&gt;&gt; thought I'd report the bug here in case it's of interest to you.
&gt;&gt;&gt;&gt; Riak 1.4.9-1 and Riak-CS 1.4.5-1 on Ubuntu 12.04 LTS.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd ls
&gt;&gt;&gt;&gt; 2014-02-07 00:07 s3://test5403
&gt;&gt;&gt;&gt; 2013-12-13 07:25 s3://test9857
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd ls s3://test5403
&gt;&gt;&gt;&gt; ERROR: Bucket 'test5403' does not exist
&gt;&gt;&gt;&gt; tobyc@adonai:~$ s3cmd ls s3://test9857
&gt;&gt;&gt;&gt; ERROR: Bucket 'test9857' does not exist
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd rb s3://test5403
&gt;&gt;&gt;&gt; ERROR: Bucket 'test5403' does not exist
&gt;&gt;&gt;&gt; Bucket 's3://test5403/' removed
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd ls
&gt;&gt;&gt;&gt; 2014-02-07 00:07 s3://test5403
&gt;&gt;&gt;&gt; 2013-12-13 07:25 s3://test9857
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd mb s3://test5403
&gt;&gt;&gt;&gt; Bucket 's3://test5403/' created
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; $ s3cmd ls s3://test5403
&gt;&gt;&gt;&gt; ERROR: Bucket 'test5403' does not exist
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Turning and turning in the widening gyre
&gt;&gt; The falcon cannot hear the falconer
&gt;&gt; Things fall apart; the center cannot hold
&gt;&gt; Mere anarchy is loosed upon the world
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com



-- 
Turning and turning in the widening gyre
The falcon cannot hear the falconer
Things fall apart; the center cannot hold
Mere anarchy is loosed upon the world

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

