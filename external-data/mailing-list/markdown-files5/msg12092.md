---
title: "Re: Data Replica algortihm"
description: ""
project: community
lastmod: 2013-08-19T16:16:53-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12092"
mailinglist_parent_id: "msg12083"
author_name: "Andrew Thompson"
project_section: "mailinglistitem"
sent_date: 2013-08-19T16:16:53-07:00
---


On Mon, Aug 19, 2013 at 04:03:25PM -0300, Jo√£o Machado wrote:
&gt; Hi all,
&gt; 
&gt; Anyone knows how the algorithm responsible for choosing where the data
&gt; replica is stored works?
&gt; 
&gt; Is possible to customise (or configure) it to ensure that the data will be
&gt; in different physical nodes (or even physical racks) like Cassandra does?

Riak writes the replicas to the vnode to which the {bucket, key} hashes
and the following N-1 vnodes.

Riak uses target\\_n (which defaults to 4) to determine what the largest N
expected is, it then tries to lay out the vnodes that no 
sequence of vnodes are on the same physical nodes. Here's an example 4
node cluster with the default target\\_n of 4:

(dev1@127.0.0.1)5&gt; riak\\_core\\_ring:pretty\\_print(element(2,
riak\\_core\\_ring\\_manager:get\\_my\\_ring()), [legend]).
==================================== Nodes ====================================
Node a: 16 ( 25.0%) dev1@127.0.0.1
Node b: 16 ( 25.0%) dev2@127.0.0.1
Node c: 16 ( 25.0%) dev3@127.0.0.1
Node d: 16 ( 25.0%) dev4@127.0.0.1
==================================== Ring ====================================
abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|abcd|
ok

As you can see, there are no sequences where any 2 vnodes in a 4 vnode
sequence are on the same machine. Now look at what happens when # of
nodes &lt; target\\_n:

==================================== Nodes ====================================
Node a: 22 ( 34.4%) dev2@127.0.0.1
Node b: 21 ( 32.8%) dev3@127.0.0.1
Node c: 21 ( 32.8%) dev4@127.0.0.1
==================================== Ring =====================================
abca|bcab|cabc|abca|bcab|cabc|abca|bcab|cabc|abca|bcab|cabc|abca|bcab|cabc|abca|

Oops, now we have nodes appearing twice in the list of every 4 vnodes.
This is bad because it means that if you loose one node, and N=4, you
have a chance to loose 2 of your replicas, instead of one.

Rack awareness is something that is being worked on, but we don't have
it just yet, but as long as you have more than target\\_n nodes, Riak will
try pretty hard to balance your replicas across physical machines. This
is also why we don't recommend riak clusters smaller than 5 nodes
(satisfy target\\_n and one more machine so you can tolerate 2/5 machines
being down).

Andrew

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

