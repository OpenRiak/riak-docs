---
title: "Re: Riak Secondary Index Limits"
description: ""
project: community
lastmod: 2014-08-29T09:03:12-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14815"
mailinglist_parent_id: "msg14806"
author_name: "Bryan"
project_section: "mailinglistitem"
sent_date: 2014-08-29T09:03:12-07:00
---


Hi Sean,

Sweet! Thanks for the explanation. Much appreciated and very helpful. Just a 
bit more clarification, on an equality lookup, where the ‘foobar’ key has a 
value ‘barfoo’ that is the very low-cardinality, are those indexed objects 
individually stored as a key/value term which then is enumerated over, versus a 
key/list\\_of\\_values term? In other words, if I have 600K records where 
foobar=barfoo, will this be 600K reads, or 1 read with a list of 600K entries 
which are then enumerated over in memory?

Cheers,
Bryan
----

Bryan Hughes
Go Factory

http://www.go-factory.net

On Aug 29, 2014, at 6:46 AM, Sean Cribbs  wrote:

&gt; I made a minor mistake in my example, the PrimaryKey is part of the
&gt; index key, whereas the value contains nothing. It's more like this:
&gt; 
&gt; {i, IndexName, IndexTerm, PrimaryKey} =&gt; &lt;&lt;&gt;&gt;
&gt; 
&gt; So for the initial seek, we construct a key like so:
&gt; 
&gt; {i, &lt;&lt;"foobar\\_bin"&gt;&gt;, &lt;&lt;"baz"&gt;&gt;, &lt;&lt;&gt;&gt;}
&gt; 
&gt; On Fri, Aug 29, 2014 at 8:44 AM, Sean Cribbs  wrote:
&gt;&gt; Hi Bryan,
&gt;&gt; 
&gt;&gt; Index entries are just keys in LevelDB like normal values are. So,
&gt;&gt; performance is relatively constant at write time but is O(N) at read
&gt;&gt; (because you are scanning the index). The high-cardinality term will
&gt;&gt; definitely be expensive to enumerate, but the low-cardinality terms
&gt;&gt; will be much less so. The index entries in LevelDB look roughly like
&gt;&gt; this:
&gt;&gt; 
&gt;&gt; {i, IndexName, IndexTerm} =&gt; PrimaryKey
&gt;&gt; 
&gt;&gt; Since the keys are encoded with sext, we encode the start key of the
&gt;&gt; range (or the equality query), start an iterator and then seek to that
&gt;&gt; start key and start reading values. When a key is reached that exceeds
&gt;&gt; the range or equality query, we stop iterating.
&gt;&gt; 
&gt;&gt; Of course, that is an oversimplification, there are issues with
&gt;&gt; backpressure from the request coordinator process against the
&gt;&gt; iterators, streaming merge sort if you want the results back in order
&gt;&gt; or paginated, etc. Also, all 2I queries are run via coverage, which
&gt;&gt; ensures that the entire keyspace is "covered" but hits most if not all
&gt;&gt; nodes in the cluster.
&gt;&gt; 
&gt;&gt; On Thu, Aug 28, 2014 at 9:18 PM, Bryan  wrote:
&gt;&gt;&gt; Hi Everyone,
&gt;&gt;&gt; 
&gt;&gt;&gt; Apologies as this has probably been asked before. Unfortunately I have not
&gt;&gt;&gt; been able to parse through the list serve to find a reasonable answer and
&gt;&gt;&gt; the Basho wiki docs seem to be missing this information. I have read up on
&gt;&gt;&gt; the secondary index docs.
&gt;&gt;&gt; 
&gt;&gt;&gt; I am interested to better understand how the secondary indexes perform when
&gt;&gt;&gt; there is a very low distribution of values that are indexed. For example,
&gt;&gt;&gt; lets say I have a bucket with 1 million objects that I create a secondary
&gt;&gt;&gt; index on. Now lets say the index is on a value that has an uneven
&gt;&gt;&gt; distribution where one of the values is not selective while the others are,
&gt;&gt;&gt; such that 60% of the values fall into a single indexed value, while the
&gt;&gt;&gt; remaining 40% have a good distribution.
&gt;&gt;&gt; 
&gt;&gt;&gt; For example, I have a record (i.e. object) where the indexed field is
&gt;&gt;&gt; ‘foobar\\_bin'. I have 1 million objects in the bucket that have 100 unique
&gt;&gt;&gt; ‘foobar’ values distributed over the 1 million objects. One of the values
&gt;&gt;&gt; repeats for 60% of the records (600K) and the rest have an even distribution
&gt;&gt;&gt; of about 4%.
&gt;&gt;&gt; 
&gt;&gt;&gt; How will the secondary indexes perform with this and is this an appropriate
&gt;&gt;&gt; use of the secondary indexes? Finally, what I have read is not completely
&gt;&gt;&gt; clear on what happens if the indexed value is updated when the value has
&gt;&gt;&gt; such a low degree of selectivity?
&gt;&gt;&gt; 
&gt;&gt;&gt; We have less than 512 partitions and are using the erlang client.
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks in advance - any insights will be much appreciated!
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers,
&gt;&gt;&gt; Bryan
&gt;&gt;&gt; 
&gt;&gt;&gt; ----
&gt;&gt;&gt; 
&gt;&gt;&gt; Bryan Hughes
&gt;&gt;&gt; Go Factory
&gt;&gt;&gt; http://www.go-factory.net
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Sean Cribbs 
&gt;&gt; Software Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://basho.com/
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

