---
title: "Re: Write_lock error has occurred after inserting 12M data"
description: ""
project: community
lastmod: 2010-07-30T16:03:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00814"
mailinglist_parent_id: "msg00812"
author_name: "David Smith"
project_section: "mailinglistitem"
sent_date: 2010-07-30T16:03:55-07:00
---


Yup, that looks like the file handle leak. You can verify by using
lsof on the server and looking for multiple handles to
bitcask.write.lock. Something like:

lsof -p pid | awk '{print $9}'| uniq -c

D.

On Friday, July 30, 2010, Alex Wolfe  wrote:
&gt; Hey David.
&gt; Does the below log output look like it could be caused by the issue you fixed?
&gt; Alex
&gt;
&gt; ==== Fri Jul 30 14:22:34 CDT 2010
&gt; =ERROR REPORT==== 30-Jul-2010::14:22:34 ===\\*\\* State machine &lt;0.176.0&gt; 
&gt; terminating \\*\\* Last event in was {riak\\_vnode\\_req\\_v1,                     
&gt; 593735040165679310520246963290989976735222595584,                     
&gt; {fsm,undefined,&lt;0.12466.0&gt;},                     {riak\\_kv\\_put\\_req\\_v1,         
&gt;              {&lt;&lt;"test.groups"&gt;&gt;,&lt;&lt;"EghzXywWrGGtp2fCcSLoatIdjML"&gt;&gt;},           
&gt;            {r\\_object,&lt;&lt;"test.groups"&gt;&gt;,                       
&gt; &lt;&lt;"EghzXywWrGGtp2fCcSLoatIdjML"&gt;&gt;,                       [{r\\_content,         
&gt;                 {dict,5,16,16,8,80,48,                          
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
&gt; {{[],[],                            [[&lt;&lt;"Links"&gt;&gt;]],                          
&gt;  [],[],[],[],[],[],[],                            
&gt; [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,                              
&gt; 116,105,111,110,47,106,115,111,110],                             
&gt; [&lt;&lt;"X-Riak-VTag"&gt;&gt;,89,69,78,55,55,111,66,121,73,                              
&gt; 69,78,53,122,101,85,105,117,68,89,80,52]],                            
&gt; [],[],                            [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|               
&gt;                {1280,517754,951062}]],                            [],         
&gt;                    [[&lt;&lt;"X-Riak-Meta"&gt;&gt;]]}}},                         
&gt; &lt;&lt;"{\\"name\\":\\"foo\\",\\"created\\_at\\":\\"2010-07-30T19:22:34.947Z\\",\\"type\\":\\"group\\",\\"version\\":1}"&gt;&gt;}],  
&gt;                     [{&lt;&lt;0,55,119,231&gt;&gt;,{1,63447736954}}],                    
&gt;   {dict,1,16,16,8,80,48,                        
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
&gt; [[clean|true]],                          []}}},                       
&gt; undefined},                      33218311,63447736954,                      
&gt; [{returnbody,true}]}}\\*\\* When State == active\\*\\*      Data  == 
&gt; {state,593735040165679310520246963290989976735222595584,                      
&gt; riak\\_kv\\_vnode,                       
&gt; {state,593735040165679310520246963290989976735222595584,                      
&gt;          riak\\_kv\\_bitcask\\_backend,                              
&gt; {#Ref&lt;0.0.0.611&gt;,                               
&gt; "data/bitcask/593735040165679310520246963290989976735222595584"},             
&gt;                  [],false},                       undefined,none}\\*\\* Reason 
&gt; for termination = \\*\\* {{badmatch,{error,emfile}},   
&gt; [{bitcask\\_fileops,create\\_file\\_loop,3},    {bitcask,put,3},    
&gt; {riak\\_kv\\_bitcask\\_backend,put,3},    {riak\\_kv\\_vnode,perform\\_put,3},    
&gt; {riak\\_kv\\_vnode,do\\_put,7},    {riak\\_kv\\_vnode,handle\\_command,3},    
&gt; {riak\\_core\\_vnode,vnode\\_command,3},    {gen\\_fsm,handle\\_msg,7}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:22:35 ===Failed to open lock file 
&gt; data/bitcask/593735040165679310520246963290989976735222595584/bitcask.write.lock:
&gt; emfile
&gt; =ERROR REPORT==== 30-Jul-2010::14:22:35 ===\\*\\* State machine &lt;0.12471.0&gt; 
&gt; terminating \\*\\* Last event in was {riak\\_vnode\\_req\\_v1,                     
&gt; 593735040165679310520246963290989976735222595584,                     
&gt; {fsm,undefined,&lt;0.12470.0&gt;},                     {riak\\_kv\\_put\\_req\\_v1,         
&gt;              {&lt;&lt;"test.users"&gt;&gt;,&lt;&lt;"ZrAxzFghd51VG902GuCcJ2gYOMJ"&gt;&gt;},            
&gt;          {r\\_object,&lt;&lt;"test.users"&gt;&gt;,                       
&gt; &lt;&lt;"ZrAxzFghd51VG902GuCcJ2gYOMJ"&gt;&gt;,                       [{r\\_content,         
&gt;                 {dict,5,16,16,8,80,48,                          
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
&gt; {{[],[],                            [[&lt;&lt;"Links"&gt;&gt;,                            
&gt;  {{&lt;&lt;"test.groups"&gt;&gt;,                                
&gt; &lt;&lt;"EghzXywWrGGtp2fCcSLoatIdjML"&gt;&gt;},                               
&gt; &lt;&lt;"groups"&gt;&gt;}]],                            [],[],[],[],[],[],[],             
&gt;                [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,                 
&gt;              116,105,111,110,47,106,115,111,110],                             
&gt; [&lt;&lt;"X-Riak-VTag"&gt;&gt;,50,88,97,105,85,49,70,49,55,                              
&gt; 54,48,71,113,115,75,103,54,102,84,56,118,84]],                            
&gt; [],[],                            
&gt; [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1280,517755,638}]],                            
&gt; [],                            [[&lt;&lt;"X-Riak-Meta"&gt;&gt;]]}}},                      
&gt;   
&gt; &lt;&lt;"{\\"name\\":\\"bar\\",\\"created\\_at\\":\\"2010-07-30T19:22:34.998Z\\",\\"type\\":\\"user\\",\\"version\\":1}"&gt;&gt;}],  
&gt;                     [{&lt;&lt;3,30,180,15&gt;&gt;,{1,63447736955}}],                     
&gt;   {dict,1,16,16,8,80,48,                        
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
&gt; [[clean|true]],                          []}}},                       
&gt; undefined},                      122945524,63447736955,                      
&gt; [{returnbody,true}]}}\\*\\* When State == active\\*\\*      Data  == 
&gt; {state,593735040165679310520246963290989976735222595584,                      
&gt; riak\\_kv\\_vnode,                       
&gt; {state,593735040165679310520246963290989976735222595584,                      
&gt;          riak\\_kv\\_bitcask\\_backend,                              
&gt; {#Ref&lt;0.0.0.16357&gt;,                               
&gt; "data/bitcask/593735040165679310520246963290989976735222595584"},             
&gt;                  [],false},                       undefined,none}\\*\\* Reason 
&gt; for termination = \\*\\* {bad\\_return\\_value,{error,{write\\_locked,emfile}}}
&gt; ==&gt; sasl-error.log &lt;==
&gt; =CRASH REPORT==== 30-Jul-2010::14:22:35 === crasher:   initial call: 
&gt; riak\\_core\\_vnode:init/1   pid: &lt;0.176.0&gt;   registered\\_name: []   exception 
&gt; exit: {{badmatch,{error,emfile}},                    
&gt; [{bitcask\\_fileops,create\\_file\\_loop,3},                     {bitcask,put,3},   
&gt;                   {riak\\_kv\\_bitcask\\_backend,put,3},                     
&gt; {riak\\_kv\\_vnode,perform\\_put,3},                     
&gt; {riak\\_kv\\_vnode,do\\_put,7},                     
&gt; {riak\\_kv\\_vnode,handle\\_command,3},                     
&gt; {riak\\_core\\_vnode,vnode\\_command,3},                     
&gt; {gen\\_fsm,handle\\_msg,7}]}     in function  gen\\_fsm:terminate/7   ancestors: 
&gt; [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.98.0&gt;]   messages: []   links: 
&gt; [#Port&lt;0.3507&gt;,&lt;0.100.0&gt;]   dictionary: []   trap\\_exit: true   status: 
&gt; running   heap\\_size: 1597   stack\\_size: 24   reductions: 11185 neighbours:
&gt; =SUPERVISOR REPORT==== 30-Jul-2010::14:22:35 ===    Supervisor: 
&gt; {local,riak\\_core\\_vnode\\_sup}    Context:    child\\_terminated    Reason:     
&gt; {{badmatch,{error,emfile}},                 
&gt; [{bitcask\\_fileops,create\\_file\\_loop,3},                  {bitcask,put,3},      
&gt;            {riak\\_kv\\_bitcask\\_backend,put,3},                  
&gt; {riak\\_kv\\_vnode,perform\\_put,3},                  {riak\\_kv\\_vnode,do\\_put,7},     
&gt;              {riak\\_kv\\_vnode,handle\\_command,3},                  
&gt; {riak\\_core\\_vnode,vnode\\_command,3},                  
&gt; {gen\\_fsm,handle\\_msg,7}]}    Offender:   [{pid,&lt;0.176.0&gt;},                 
&gt; {name,undefined},                 {mfa,                     
&gt; {riak\\_core\\_vnode,start\\_link,                         [riak\\_kv\\_vnode,          
&gt;                593735040165679310520246963290989976735222595584]}},          
&gt;       {restart\\_type,temporary},                 {shutdown,brutal\\_kill},      
&gt;           {child\\_type,worker}]
&gt;
&gt; =CRASH REPORT==== 30-Jul-2010::14:22:35 === crasher:   initial call: 
&gt; riak\\_core\\_vnode:init/1   pid: &lt;0.12471.0&gt;   registered\\_name: []   exception 
&gt; exit: {bad\\_return\\_value,{error,{write\\_locked,emfile}}}     in function  
&gt; gen\\_fsm:terminate/7   ancestors: 
&gt; [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.98.0&gt;]   messages: []   links: 
&gt; [&lt;0.100.0&gt;]   dictionary: []   trap\\_exit: true   status: running   heap\\_size: 
&gt; 2584   stack\\_size: 24   reductions: 1955 neighbours:
&gt; =SUPERVISOR REPORT==== 30-Jul-2010::14:22:35 ===    Supervisor: 
&gt; {local,riak\\_core\\_vnode\\_sup}    Context:    child\\_terminated    Reason:     
&gt; {bad\\_return\\_value,{error,{write\\_locked,emfile}}}    Offender:   
&gt; [{pid,&lt;0.12471.0&gt;},                 {name,undefined},                 {mfa,   
&gt;                   {riak\\_core\\_vnode,start\\_link,                         
&gt; [riak\\_kv\\_vnode,                          
&gt; 593735040165679310520246963290989976735222595584]}},                 
&gt; {restart\\_type,temporary},                 {shutdown,brutal\\_kill},             
&gt;     {child\\_type,worker}]
&gt;
&gt; ==&gt; erlang.log.4 &lt;==
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* Generic server memsup 
&gt; terminating \\*\\* Last message in was {'EXIT',&lt;0.21020.78&gt;,                      
&gt;    {emfile,                              [{erlang,open\\_port,                 
&gt;                   [{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},                        
&gt;            [stream]]},                               
&gt; {os,start\\_port\\_srv\\_loop,2}]}}\\*\\* When Server state == {state,{unix,darwin},    
&gt;                          false,                              
&gt; {1897500000,7776508000},                              {&lt;0.81.0&gt;,972008},      
&gt;                        false,60000,30000,0.8,0.05,&lt;0.21020.78&gt;,              
&gt;                #Ref&lt;0.0.2.58535&gt;,undefined,                              
&gt; [reg],                              []}\\*\\* Reason for termination == \\*\\* 
&gt; {emfile,[{erlang,open\\_port,[{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},[stream]]},    
&gt;       {os,start\\_port\\_srv\\_loop,2}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* Generic server memsup 
&gt; terminating \\*\\* Last message in was {'EXIT',&lt;0.21186.78&gt;,                      
&gt;    {emfile,                              [{erlang,open\\_port,                 
&gt;                   [{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},                        
&gt;            [stream]]},                               
&gt; {os,start\\_port\\_srv\\_loop,2}]}}\\*\\* When Server state == {state,{unix,darwin},    
&gt;                          false,undefined,undefined,false,60000,30000,        
&gt;                      0.8,0.05,&lt;0.21186.78&gt;,#Ref&lt;0.0.2.58551&gt;,                
&gt;              undefined,                              [reg],                  
&gt;            []}\\*\\* Reason for termination == \\*\\* 
&gt; {emfile,[{erlang,open\\_port,[{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},[stream]]},    
&gt;       {os,start\\_port\\_srv\\_loop,2}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* Generic server memsup 
&gt; terminating \\*\\* Last message in was {'EXIT',&lt;0.21252.78&gt;,                      
&gt;    {emfile,                              [{erlang,open\\_port,                 
&gt;                   [{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},                        
&gt;            [stream]]},                               
&gt; {os,start\\_port\\_srv\\_loop,2}]}}\\*\\* When Server state == {state,{unix,darwin},    
&gt;                          false,undefined,undefined,false,60000,30000,        
&gt;                      0.8,0.05,&lt;0.21252.78&gt;,#Ref&lt;0.0.2.58559&gt;,                
&gt;              undefined,                              [reg],                  
&gt;            []}\\*\\* Reason for termination == \\*\\* 
&gt; {emfile,[{erlang,open\\_port,[{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},[stream]]},    
&gt;       {os,start\\_port\\_srv\\_loop,2}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* Generic server memsup 
&gt; terminating \\*\\* Last message in was {'EXIT',&lt;0.21374.78&gt;,                      
&gt;    {emfile,                              [{erlang,open\\_port,                 
&gt;                   [{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},                        
&gt;            [stream]]},                               
&gt; {os,start\\_port\\_srv\\_loop,2}]}}\\*\\* When Server state == {state,{unix,darwin},    
&gt;                          false,undefined,undefined,false,60000,30000,        
&gt;                      0.8,0.05,&lt;0.21374.78&gt;,#Ref&lt;0.0.2.58569&gt;,                
&gt;              undefined,                              [reg],                  
&gt;            []}\\*\\* Reason for termination == \\*\\* 
&gt; {emfile,[{erlang,open\\_port,[{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},[stream]]},    
&gt;       {os,start\\_port\\_srv\\_loop,2}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* Generic server memsup 
&gt; terminating \\*\\* Last message in was {'EXIT',&lt;0.21396.78&gt;,                      
&gt;    {emfile,                              [{erlang,open\\_port,                 
&gt;                   [{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},                        
&gt;            [stream]]},                               
&gt; {os,start\\_port\\_srv\\_loop,2}]}}\\*\\* When Server state == {state,{unix,darwin},    
&gt;                          false,undefined,undefined,false,60000,30000,        
&gt;                      0.8,0.05,&lt;0.21396.78&gt;,#Ref&lt;0.0.2.58575&gt;,                
&gt;              undefined,                              [reg],                  
&gt;            []}\\*\\* Reason for termination == \\*\\* 
&gt; {emfile,[{erlang,open\\_port,[{spawn,"/bin/sh -s unix:cmd 2&gt;&1"},[stream]]},    
&gt;       {os,start\\_port\\_srv\\_loop,2}]}
&gt; =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\\*\\* State machine &lt;0.175.0&gt; 
&gt; terminating \\*\\* Last event in was {riak\\_vnode\\_req\\_v1,                     
&gt; 570899077082383952423314387779798054553098649600,                     
&gt; {fsm,undefined,&lt;0.12470.0&gt;},                     {riak\\_kv\\_put\\_req\\_v1,         
&gt;              {&lt;&lt;"test.users"&gt;&gt;,&lt;&lt;"ZrAxzFghd51VG902GuCcJ2gYOMJ"&gt;&gt;},            
&gt;          {r\\_object,&lt;&lt;"test.users"&gt;&gt;,                       
&gt; &lt;&lt;"ZrAxzFghd51VG902GuCcJ2gYOMJ"&gt;&gt;,                       [{r\\_content,         
&gt;                 {dict,5,16,16,8,80,48,                          
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
&gt; {{[],[],                            [[&lt;&lt;"Links"&gt;&gt;,                            
&gt;  {{&lt;&lt;"test.groups"&gt;&gt;,                                
&gt; &lt;&lt;"EghzXywWrGGtp2fCcSLoatIdjML"&gt;&gt;},                               
&gt; &lt;&lt;"groups"&gt;&gt;}]],                            [],[],[],[],[],[],[],             
&gt;                [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,                 
&gt;              116,105,111,110,47,106,115,111,110],                             
&gt; [&lt;&lt;"X-Riak-VTag"&gt;&gt;,50,88,97,105,85,49,70,49,55,                              
&gt; 54,48,71,113,115,75,103,54,102,84,56,118,84]],                            
&gt; [],[],                            
&gt; [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1280,517755,638}]],                            
&gt; [],                            [[&lt;&lt;"X-Riak-Meta"&gt;&gt;]]}}},                      
&gt;   
&gt; &lt;&lt;"{\\"name\\":\\"bar\\",\\"created\\_at\\":\\"2010-07-30T19:22:34.998Z\\",\\"type\\":\\"user\\",\\"version\\":1}"&gt;&gt;}],  
&gt;                     [{&lt;&lt;3,30,180,15&gt;&gt;,{1,63447736955}}],                     
&gt;   {dict,1,16,16,8,80,48,                        
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
&gt; [[clean|true]],                          []}}},                       
&gt; undefined},                      122945524,63447736955,                      
&gt; [{returnbody,true}]}}\\*\\* When State == active\\*\\*      Data  == 
&gt; {state,570899077082383952423314387779798054553098649600,                      
&gt; riak\\_kv\\_vnode,                       
&gt; {state,570899077082383952423314387779798054553098649600,
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

