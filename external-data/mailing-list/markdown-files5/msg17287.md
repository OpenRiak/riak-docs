---
title: "Re: Very slow acquisition time (99 percentile) while fast median times"
description: ""
project: community
lastmod: 2016-05-04T06:18:46-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17287"
mailinglist_parent_id: "msg17275"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2016-05-04T06:18:46-07:00
---


Guillaume,

Two points:

1. You can send the “riak debug” from one server and I will verify that 2.0.18 
is indicated in the LOG file.

2. Your previous “riak debug” from server “riak1” indicated that only two CPU 
cores existed. We performance test with eight, twelve, and twenty-four core 
servers, not two. You have two heavy weight applications, Riak and Solr, 
competing for time on those two cores. Actually, you have three applications 
due to leveldb’s background compaction operations.

One leveldb compaction is CPU intensive. The compaction reads a block from the 
disk, computes a CRC32 check of the block, decompresses the block, merges the 
keys of this block with one or more blocks from other files, then compresses 
the new block, computes a new CRC32, and finally writes the block to disk. And 
there can be multiple compactions running simultaneously. All of your CPU time 
could be periodically lost to leveldb compactions.

There are some minor tunings we could do, like disabling compression in 
leveldb, that might help. But I seriously doubt you are going to achieve your 
desired results with only two cores. Adding a sixth server with two cores is 
not really going to help.

Matthew


&gt; On May 4, 2016, at 4:27 AM, Guillaume Boddaert 
&gt;  wrote:
&gt; 
&gt; Thanks, I've installed the new library as stated in the documentation using 
&gt; 2.0.18 files.
&gt; 
&gt; I was unable to find the vnode LOG file from the documentation, as my vnodes 
&gt; looks like file, not directories. So I can't verify that I run the proper 
&gt; version of the library after my riak restart.
&gt; 
&gt; Anyway, it has unfortunately no effect:
&gt; http://www.awesomescreenshot.com/image/1219821/1b292613c051da86df5696034c114b14
&gt; 
&gt; 
&gt; 
&gt; I think i'll try to add a 6th node that don't rely on network disks and see 
&gt; what's going on.
&gt; 
&gt; G.
&gt; 
&gt; 
&gt; On 03/05/2016 22:47, Matthew Von-Maszewski wrote:
&gt;&gt; Guillaume,
&gt;&gt; 
&gt;&gt; A prebuilt eleveldb 2.0.18 for Debian 7 is found here:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.18/eleveldb\\_2.0.18\\_debian7.tgz
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; There are good instructions for applying an eleveldb patch here:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; http://docs.basho.com/community/productadvisories/leveldbsegfault/#patch-eleveldb-so
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Key points about the above web page:
&gt;&gt; 
&gt;&gt; - use the eleveldb patch file link in this email, NOT links on the web page
&gt;&gt; 
&gt;&gt; - the Debian directory listed on the web page will be slightly different 
&gt;&gt; than your Riak 2.1.4 installation:
&gt;&gt; 
&gt;&gt; /usr/lib/riak/lib/eleveldb-/priv/
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt;&gt; On May 3, 2016, at 1:01 PM, Matthew Von-Maszewski &gt;&gt; &gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Guillaume,
&gt;&gt;&gt; 
&gt;&gt;&gt; I have reviewed the debug package for your riak1 server. There are two 
&gt;&gt;&gt; potential areas of follow-up:
&gt;&gt;&gt; 
&gt;&gt;&gt; 1. You are running our most recent Riak 2.1.4 which has eleveldb 2.0.17. 
&gt;&gt;&gt; We have seen a case where a recent feature in eleveldb 2.0.17 caused too 
&gt;&gt;&gt; much cache flushing, impacting leveldb’s performance. A discussion is here:
&gt;&gt;&gt; 
&gt;&gt;&gt; https://github.com/basho/leveldb/wiki/mv-timed-grooming2 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 2. Yokozuna search was recently updated for some timeout problems. Those 
&gt;&gt;&gt; updates are not yet in a public build. One of our other engineers is 
&gt;&gt;&gt; likely to respond to you on that topic.
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; An eleveldb 2.0.18 is tagged and available via github if you want to build 
&gt;&gt;&gt; it yourself. Otherwise, Basho may be releasing prebuilt patches of 
&gt;&gt;&gt; eleveldb 2.0.18 in the near future. But no date is currently set.
&gt;&gt;&gt; 
&gt;&gt;&gt; Matthew
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On May 3, 2016, at 10:50 AM, Luke Bakken &gt;&gt;&gt; &gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Guillaume -
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; You said earlier "My data are stored on an openstack volume that
&gt;&gt;&gt;&gt; support up to 3000IOPS". There is a likelihood that your write load is
&gt;&gt;&gt;&gt; exceeding the capacity of your virtual environment, especially if some
&gt;&gt;&gt;&gt; Riak nodes are sharing physical disk or server infrastructure.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Some suggestions:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\* If you're not using Riak Search, set "search = off" in riak.conf
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\* Be sure to carefully read and apply all tunings:
&gt;&gt;&gt;&gt; http://docs.basho.com/riak/kv/2.1.4/using/performance/ 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\* You may wish to increase the memory dedicated to leveldb:
&gt;&gt;&gt;&gt; http://docs.basho.com/riak/kv/2.1.4/configuring/backend/#leveldb 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; Luke Bakken
&gt;&gt;&gt;&gt; Engineer
&gt;&gt;&gt;&gt; lbak...@basho.com 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Tue, May 3, 2016 at 7:33 AM, Guillaume Boddaert
&gt;&gt;&gt;&gt;  
&gt;&gt;&gt;&gt;  wrote:
&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Sorry for the delay, I've spent a lot of time trying to understand if the
&gt;&gt;&gt;&gt;&gt; problem was elsewhere.
&gt;&gt;&gt;&gt;&gt; I've simplified my infrastructure and got a simple layout that don't rely
&gt;&gt;&gt;&gt;&gt; anymore on loadbalancer and also corrected some minor performance issue on
&gt;&gt;&gt;&gt;&gt; my workers.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; At the moment, i have up to 32 workers that are calling riak for writes,
&gt;&gt;&gt;&gt;&gt; each of them are set to :
&gt;&gt;&gt;&gt;&gt; w=1
&gt;&gt;&gt;&gt;&gt; dw=0
&gt;&gt;&gt;&gt;&gt; timeout=1000
&gt;&gt;&gt;&gt;&gt; using protobuf
&gt;&gt;&gt;&gt;&gt; a timeouted attempt is rerun 180s later
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; From my application server perspective, 23% of the calls are rejected by
&gt;&gt;&gt;&gt;&gt; timeout (75446 tries, 57564 success, 17578 timeout).
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Here is a sample riak-admin stat for one of my 5 hosts:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_100 : 999331
&gt;&gt;&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_95 : 773682
&gt;&gt;&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_99 : 959444
&gt;&gt;&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_mean : 156242
&gt;&gt;&gt;&gt;&gt; node\\_put\\_fsm\\_time\\_median : 20235
&gt;&gt;&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_100 : 5267527
&gt;&gt;&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_95 : 2437457
&gt;&gt;&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_99 : 4819538
&gt;&gt;&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_mean : 175567
&gt;&gt;&gt;&gt;&gt; vnode\\_put\\_fsm\\_time\\_median : 6928
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I am using leveldb, so i can't tune bitcask backend as suggested.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I've changed the vmdirty settings and enabled them:
&gt;&gt;&gt;&gt;&gt; admin@riak1:~$ sudo sysctl -a | grep dirtyvm.dirty\\_background\\_ratio = 0
&gt;&gt;&gt;&gt;&gt; vm.dirty\\_background\\_bytes = 209715200
&gt;&gt;&gt;&gt;&gt; vm.dirty\\_ratio = 40
&gt;&gt;&gt;&gt;&gt; vm.dirty\\_bytes = 0
&gt;&gt;&gt;&gt;&gt; vm.dirty\\_writeback\\_centisecs = 100
&gt;&gt;&gt;&gt;&gt; vm.dirty\\_expire\\_centisecs = 200
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I've seen less idle time between writes, iostat is showing near constant
&gt;&gt;&gt;&gt;&gt; writes between 20 and 500 kb/s, with some surges around 4000 kb/s. That's
&gt;&gt;&gt;&gt;&gt; better, but not that great.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Here is the current configuration for my "activity\\_fr" bucket type and
&gt;&gt;&gt;&gt;&gt; "tweet" bucket:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/props
&gt;&gt;&gt;&gt;&gt; HTTP/1.1 200 OK
&gt;&gt;&gt;&gt;&gt; Content-Encoding: gzip
&gt;&gt;&gt;&gt;&gt; Content-Length: 314
&gt;&gt;&gt;&gt;&gt; Content-Type: application/json
&gt;&gt;&gt;&gt;&gt; Date: Tue, 03 May 2016 14:30:21 GMT
&gt;&gt;&gt;&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt;&gt;&gt;&gt; Vary: Accept-Encoding
&gt;&gt;&gt;&gt;&gt; {
&gt;&gt;&gt;&gt;&gt; "props": {
&gt;&gt;&gt;&gt;&gt; "active": true,
&gt;&gt;&gt;&gt;&gt; "allow\\_mult": false,
&gt;&gt;&gt;&gt;&gt; "basic\\_quorum": false,
&gt;&gt;&gt;&gt;&gt; "big\\_vclock": 50,
&gt;&gt;&gt;&gt;&gt; "chash\\_keyfun": {
&gt;&gt;&gt;&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt;&gt;&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt;&gt;&gt;&gt; },
&gt;&gt;&gt;&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co" 
&gt;&gt;&gt;&gt;&gt; ,
&gt;&gt;&gt;&gt;&gt; "dvv\\_enabled": false,
&gt;&gt;&gt;&gt;&gt; "dw": "quorum",
&gt;&gt;&gt;&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt;&gt;&gt;&gt; "linkfun": {
&gt;&gt;&gt;&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt;&gt;&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt;&gt;&gt;&gt; },
&gt;&gt;&gt;&gt;&gt; "n\\_val": 3,
&gt;&gt;&gt;&gt;&gt; "notfound\\_ok": true,
&gt;&gt;&gt;&gt;&gt; "old\\_vclock": 86400,
&gt;&gt;&gt;&gt;&gt; "postcommit": [],
&gt;&gt;&gt;&gt;&gt; "pr": 0,
&gt;&gt;&gt;&gt;&gt; "precommit": [],
&gt;&gt;&gt;&gt;&gt; "pw": 0,
&gt;&gt;&gt;&gt;&gt; "r": "quorum",
&gt;&gt;&gt;&gt;&gt; "rw": "quorum",
&gt;&gt;&gt;&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt;&gt;&gt;&gt; "small\\_vclock": 50,
&gt;&gt;&gt;&gt;&gt; "w": "quorum",
&gt;&gt;&gt;&gt;&gt; "young\\_vclock": 20
&gt;&gt;&gt;&gt;&gt; }
&gt;&gt;&gt;&gt;&gt; }
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; admin@riak1:~$ http localhost:8098/types/activity\\_fr/buckets/tweet/props
&gt;&gt;&gt;&gt;&gt; HTTP/1.1 200 OK
&gt;&gt;&gt;&gt;&gt; Content-Encoding: gzip
&gt;&gt;&gt;&gt;&gt; Content-Length: 322
&gt;&gt;&gt;&gt;&gt; Content-Type: application/json
&gt;&gt;&gt;&gt;&gt; Date: Tue, 03 May 2016 14:30:02 GMT
&gt;&gt;&gt;&gt;&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt;&gt;&gt;&gt;&gt; Vary: Accept-Encoding
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; {
&gt;&gt;&gt;&gt;&gt; "props": {
&gt;&gt;&gt;&gt;&gt; "active": true,
&gt;&gt;&gt;&gt;&gt; "allow\\_mult": false,
&gt;&gt;&gt;&gt;&gt; "basic\\_quorum": false,
&gt;&gt;&gt;&gt;&gt; "big\\_vclock": 50,
&gt;&gt;&gt;&gt;&gt; "chash\\_keyfun": {
&gt;&gt;&gt;&gt;&gt; "fun": "chash\\_std\\_keyfun",
&gt;&gt;&gt;&gt;&gt; "mod": "riak\\_core\\_util"
&gt;&gt;&gt;&gt;&gt; },
&gt;&gt;&gt;&gt;&gt; "claimant": "r...@riak2.lighthouse-analytics.co" 
&gt;&gt;&gt;&gt;&gt; ,
&gt;&gt;&gt;&gt;&gt; "dvv\\_enabled": false,
&gt;&gt;&gt;&gt;&gt; "dw": "quorum",
&gt;&gt;&gt;&gt;&gt; "last\\_write\\_wins": true,
&gt;&gt;&gt;&gt;&gt; "linkfun": {
&gt;&gt;&gt;&gt;&gt; "fun": "mapreduce\\_linkfun",
&gt;&gt;&gt;&gt;&gt; "mod": "riak\\_kv\\_wm\\_link\\_walker"
&gt;&gt;&gt;&gt;&gt; },
&gt;&gt;&gt;&gt;&gt; "n\\_val": 3,
&gt;&gt;&gt;&gt;&gt; "name": "tweet",
&gt;&gt;&gt;&gt;&gt; "notfound\\_ok": true,
&gt;&gt;&gt;&gt;&gt; "old\\_vclock": 86400,
&gt;&gt;&gt;&gt;&gt; "postcommit": [],
&gt;&gt;&gt;&gt;&gt; "pr": 0,
&gt;&gt;&gt;&gt;&gt; "precommit": [],
&gt;&gt;&gt;&gt;&gt; "pw": 0,
&gt;&gt;&gt;&gt;&gt; "r": "quorum",
&gt;&gt;&gt;&gt;&gt; "rw": "quorum",
&gt;&gt;&gt;&gt;&gt; "search\\_index": "activity\\_fr.20160422104506",
&gt;&gt;&gt;&gt;&gt; "small\\_vclock": 50,
&gt;&gt;&gt;&gt;&gt; "w": "quorum",
&gt;&gt;&gt;&gt;&gt; "young\\_vclock": 20
&gt;&gt;&gt;&gt;&gt; }
&gt;&gt;&gt;&gt;&gt; }
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I really don't know what to do. Can you help ?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Guillaume
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com 
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

