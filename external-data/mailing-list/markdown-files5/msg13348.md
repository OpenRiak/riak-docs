---
title: "Re: anti_entropy_expire"
description: ""
project: community
lastmod: 2013-12-31T13:18:22-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13348"
mailinglist_parent_id: "msg13347"
author_name: "Charlie Voiselle"
project_section: "mailinglistitem"
sent_date: 2013-12-31T13:18:22-08:00
---


Edgar:

Could you attach the AAE section of your app.config? Iâ€™d like to look into 
this issue further for you. Something I think you might be running into is 
https://github.com/basho/riak\\_core/pull/483.

The issue of concern is that the LevelDB bloom filter is not enabled properly 
for the instance into which the AAE data is stored. You can mitigate this 
particular issue by adding {use\\_bloomfilter, true} as shown below:

 %% The LevelDB options used by AAE to generate the LevelDB-backed
 %% on-disk hashtrees.
 {anti\\_entropy\\_leveldb\\_opts, [{write\\_buffer\\_size, 4194304},
 {max\\_open\\_files, 20}]},

Becomes:

 %% The LevelDB options used by AAE to generate the LevelDB-backed
 %% on-disk hashtrees.
 {anti\\_entropy\\_leveldb\\_opts, [{write\\_buffer\\_size, 4194304},
 {use\\_bloomfilter, true},
 {max\\_open\\_files, 20}]},

This might not solve your specific problem, but it will certainly improve your 
AAE performance.

Thanks,
Charlie Voiselle

On Dec 31, 2013, at 12:04 PM, Edgar Veiga  wrote:

&gt; Hey guys! 
&gt; 
&gt; Nothing on this one?
&gt; 
&gt; Btw: Happy new year :)
&gt; 
&gt; 
&gt; On 27 December 2013 22:35, Edgar Veiga  wrote:
&gt; This is a du -hs \\* of the riak folder:
&gt; 
&gt; 44G anti\\_entropy
&gt; 1.1M kv\\_vnode
&gt; 252G leveldb
&gt; 124K ring
&gt; 
&gt; It's a 6 machine cluster, so ~1512G of levelDB.
&gt; 
&gt; Thanks for the tip, I'll upgrade in a near future!
&gt; 
&gt; Best regards
&gt; 
&gt; 
&gt; On 27 December 2013 21:41, Matthew Von-Maszewski  wrote:
&gt; I have a query out to the developer that can better respond to your follow-up 
&gt; questions. It might be Monday before we get a reply due to the holidays.
&gt; 
&gt; Do you happen to know how much data is in the leveldb dataset and/or one 
&gt; vnode? Not sure it will change the response, but might be nice to have that 
&gt; info available.
&gt; 
&gt; Matthew
&gt; 
&gt; P.S. Unrelated to your question: Riak 1.4.4 is available for download. It 
&gt; has a couple of nice bug fixes for leveldb.
&gt; 
&gt; 
&gt; On Dec 27, 2013, at 2:08 PM, Edgar Veiga  wrote:
&gt; 
&gt;&gt; Ok, thanks for confirming!
&gt;&gt; 
&gt;&gt; Is it normal, that this action affects the overall state of the cluster? On 
&gt;&gt; the 26th It started the regeneration and the the response times of the 
&gt;&gt; cluster raised to never seen values. It was a day of heavy traffic but 
&gt;&gt; everything was going quite ok until it started the regeneration process..
&gt;&gt; 
&gt;&gt; Have you got any advices about changing those app.config values? My cluster 
&gt;&gt; is running smoothly for the past 6 months and I don't want to start all over 
&gt;&gt; again :) 
&gt;&gt; 
&gt;&gt; Best Regards
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 27 December 2013 18:56, Matthew Von-Maszewski  wrote:
&gt;&gt; Yes. Confirmed.
&gt;&gt; 
&gt;&gt; There are options available in app.config to control how often this occurs 
&gt;&gt; and how many vnodes rehash at once: defaults are every 7 days and two 
&gt;&gt; vnodes per server at a time.
&gt;&gt; 
&gt;&gt; Matthew Von-Maszewski
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Dec 27, 2013, at 13:50, Edgar Veiga  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi!
&gt;&gt;&gt; 
&gt;&gt;&gt; I've been trying to find what may be the cause of this.
&gt;&gt;&gt; 
&gt;&gt;&gt; Every once in a week, all the nodes in my riak cluster start to do some 
&gt;&gt;&gt; kind of operation that lasts at least for two days. 
&gt;&gt;&gt; 
&gt;&gt;&gt; You can watch a sample of my munin logs regarding the last week in here:
&gt;&gt;&gt; 
&gt;&gt;&gt; https://cloudup.com/imWiBwaC6fm
&gt;&gt;&gt; Take a look at the days 19 and 20, and now it has started again on the 26...
&gt;&gt;&gt; 
&gt;&gt;&gt; I'm suspecting that this may be caused by the aae hash trees being 
&gt;&gt;&gt; regenerated, as you say in your documentation:
&gt;&gt;&gt; For added protection, Riak periodically (default: once a week) clears and 
&gt;&gt;&gt; regenerates all hash trees from the on-disk K/V data.
&gt;&gt;&gt; Can you confirm me that this may be the root of the "problem" and if it's 
&gt;&gt;&gt; normal for the action to last for two days?
&gt;&gt;&gt; 
&gt;&gt;&gt; I'm using riak 1.4.2 on 6 machines, with centOS. The backend is levelDB.
&gt;&gt;&gt; 
&gt;&gt;&gt; Best Regards,
&gt;&gt;&gt; Edgar Veiga
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt; 
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

