---
title: "Re: {error, notfound} items in mapreduce during ownership handoff"
description: ""
project: community
lastmod: 2013-03-06T15:34:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10340"
mailinglist_parent_id: "msg10338"
author_name: "John Daily"
project_section: "mailinglistitem"
sent_date: 2013-03-06T15:34:27-08:00
---


Disclaimer: I haven't done this myself, or even attempted to compile the code 
below, but in hopes it makes your life a little easier...

Here's some Erlang that should allow you to abstract away the checks. Assuming 
that you have a function named "real\\_map\\_fun" that takes a single Riak object 
as an argument, you should be able to reuse "check\\_found" and "check\\_tombstone" 
below and wrap the call to "real\\_map\\_fun" in a function like "map\\_something".

map\\_something(Obj, \\_, \\_) -&gt;
 check\\_found(Obj, fun real\\_map\\_fun/1).


check\\_found({error, notfound}, \\_Fun) -&gt;
 [];
check\\_found(Obj, Fun) -&gt;
 check\\_tombstone(dict:is\\_key(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,
 riak\\_object:get\\_metadata(Obj)),
 Obj, Fun).


check\\_tombstone(true, \\_Obj, \\_Fun) -&gt;
 [];
check\\_tombstone(false, Obj, Fun) -&gt;
 Fun(Obj).

-John


On Mar 6, 2013, at 4:45 PM, Jeremy Raymond  wrote:

&gt; Thanks for the response. To handle not founds and tombstones I need this in 
&gt; every map function?
&gt; 
&gt; map\\_something({error, notfound}, \\_, \\_) -&gt;
&gt; [];
&gt; map\\_something(RiakObj, \\_, \\_) -&gt;
&gt; Metadata = riak\\_object:get\\_metadata(RiakObj),
&gt; case dict:is\\_key(&lt;&lt;"X-Riak-Deleted"&gt;&gt;, Metadata) of
&gt; true -&gt;
&gt; []; % I have a tombstone
&gt; false -&gt;
&gt; [ok] % I have a valid item
&gt; end.
&gt; 
&gt; Is there a better or built-in way to do this filtering?
&gt; 
&gt; --
&gt; Jeremy
&gt; 
&gt; 
&gt; On Wed, Mar 6, 2013 at 4:08 PM, John Daily  wrote:
&gt; I'm sorry this went unanswered, Jeremy. Thanks for the follow up.
&gt; 
&gt; Your code needs to be able to handle notfound errors and tombstones[1] 
&gt; regardless of ownership handoff. The coverage for the 2i or listkeys input 
&gt; will be calculated up front, with the work distributed to a node where the 
&gt; key is expected to be found, but it's always possible that the node selected 
&gt; may not have the data you want due to network or system errors that haven't 
&gt; yet healed.
&gt; 
&gt; Both the notfound and the fitting error in the logs (which is benign, and 
&gt; related to the notfound problem) should be less common under Riak 1.3, 
&gt; although ownership handoff will still exacerbate the problem.
&gt; 
&gt; [1] https://github.com/basho/riak\\_kv/issues/358
&gt; 
&gt; -John Daily
&gt; Technical Evangelist
&gt; jda...@basho.com
&gt; 
&gt; 
&gt; On Mar 6, 2013, at 3:14 PM, Jeremy Raymond  wrote:
&gt; 
&gt;&gt; So I should expect {error, notfound} inputs to map jobs while ownership 
&gt;&gt; handoff is in progress? Are the not found items actually unavailable during 
&gt;&gt; handoff or is this just not found on the old node, but will be picked up by 
&gt;&gt; the new node during the same mapreduce job?
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Jeremy
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Thu, Feb 28, 2013 at 11:28 AM, Jeremy Raymond  wrote:
&gt;&gt; Yesterday I added a new node to my cluster. During the time when ownership 
&gt;&gt; handoff was happening (several hours of work) mapreduce map functions were 
&gt;&gt; receiving {error, notfound} as inputs. My Erlang mapred functions weren't 
&gt;&gt; designed to handle this. They hadn't encountered this before during normal 
&gt;&gt; operation. After the ownership handoff process completed the {error, 
&gt;&gt; notfound} inputs have stopped.
&gt;&gt; 
&gt;&gt; Any explanations for the {error, notfound} inputs during ownership handoff? 
&gt;&gt; Is this because a node is attempting to process an object now moved to 
&gt;&gt; another node? If this is the case would the notfound object be found on the 
&gt;&gt; other node in the same mapreduce job (i.e. still visible to the overall 
&gt;&gt; mapred process)? Should I assume {error, notfound} inputs for all mapred 
&gt;&gt; jobs as a valid possible input and always handle it?
&gt;&gt; 
&gt;&gt; I've also accumulated about 50MB of "Pipe worker startup failed:fitting was 
&gt;&gt; gone before startup" on each node during the ownership\\_transfer process. 
&gt;&gt; These messages are benign?
&gt;&gt; 
&gt;&gt; Thanks a lot.
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Jeremy
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

