---
title: "Re: Hard time with Riak 2.0.0pre5 features"
description: ""
project: community
lastmod: 2013-11-25T16:48:37-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13089"
mailinglist_parent_id: "msg13033"
author_name: "Valter Balegas"
project_section: "mailinglistitem"
sent_date: 2013-11-25T16:48:37-08:00
---


Hello,

I’m trying to use strong consistency in a riak cluster with nodes in a 
wide-area network, but a timeout fires sometimes, regardless the timeout value.
I tried to increase the timeout of the get operation but it does not seem to 
help. Is there any parameter that i can change to increase the timeout? 
The latency between the nodes is the order of hundreds of milliseconds, and, 
since in the eventual-consistency setting this does not happen (even with a 
bigger read quorum), i’m assuming it has to do with Strong consistency 
parametrization.
I’m using the most recent erlang client and riak versions and the client runs 
in the same machine as the node i connect to.

{ok, Pid} = riakc\\_pb\\_socket:start\\_link(“NODELINK", 8087). 
{ok,&lt;0.35.0&gt;}
2&gt; 
2&gt; riakc\\_pb\\_socket:get(Pid, {&lt;&lt;"STRONG"&gt;&gt;,&lt;&lt;"ITEMS"&gt;&gt;}, &lt;&lt;"KEY"&gt;&gt;, [],5000).
{error,&lt;&lt;"timeout"&gt;&gt;}
3&gt;riakc\\_pb\\_socket:get(Pid, {&lt;&lt;"STRONG"&gt;&gt;,&lt;&lt;"ITEMS"&gt;&gt;}, &lt;&lt;"KEY"&gt;&gt;, [],5000). 
 
{ok,{riakc\\_obj,{&lt;&lt;"STRONG"&gt;&gt;,&lt;&lt;"ITEMS"&gt;&gt;},
 &lt;&lt;"KEY"&gt;&gt;,
 &lt;&lt;107,206,97,96,96,96,204,96,74,97,96,73,45,78,45,204,96,
 202,99,99,96,1,10,...&gt;&gt;,
 [{{dict,2,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],...},
 {{[],[],[],[],[],[],[],[],[],[],...}}},
 &lt;&lt;"100"&gt;&gt;}],
 undefined,undefined}}
4&gt; riakc\\_pb\\_socket:get(Pid, {&lt;&lt;"STRONG"&gt;&gt;,&lt;&lt;"ITEMS"&gt;&gt;}, &lt;&lt;"KEY"&gt;&gt;, [],5000000).
{error,&lt;&lt;"timeout"&gt;&gt;}
5&gt; riakc\\_pb\\_socket:get(Pid, {&lt;&lt;"STRONG"&gt;&gt;,&lt;&lt;"ITEMS"&gt;&gt;}, &lt;&lt;"KEY"&gt;&gt;, [],5000).

=ERROR REPORT==== 26-Nov-2013::00:34:38 ===
\\*\\* Generic server &lt;0.35.0&gt; terminating 
\\*\\* Last message in was {req\\_timeout,#Ref&lt;0.0.0.113&gt;}
\\*\\* When Server state == {state,”NODELINK",
 8087,false,false,undefined,gen\\_tcp,undefined,
 {[],[]},
 1,[],infinity,undefined,undefined,undefined,
 undefined,100}
\\*\\* Reason for termination == 
\\*\\* disconnected
\\*\\* exception exit: disconnected

Thanks,
Valter



No dia 21/11/2013, às 11:40, Valter Balegas  escreveu:

&gt; Thanks, it works now! 
&gt; i wouldn’t realize that bucket type had to be specified as a type. But i did 
&gt; say that i didn’t now what that meant. :)
&gt; 
&gt; I hope i can do all my experiments now,
&gt; Valter
&gt; 
&gt; No dia 20/11/2013, às 21:04, Valter Balegas  escreveu:
&gt; 
&gt;&gt; Hello,
&gt;&gt; 
&gt;&gt; Here is the sequence of commands:
&gt;&gt; 
&gt;&gt; --Compiled Riak with "make rel" and riak-erlang-client with “make". Erlang 
&gt;&gt; version R16B02; using the latest version on GitHub or the riak2.0.0.5pre 
&gt;&gt; package.
&gt;&gt; 
&gt;&gt; ./bin/riak stop
&gt;&gt; 
&gt;&gt; --changed the consensus flag to true on ./etc/riak.conf
&gt;&gt; 
&gt;&gt; ./bin/riak start
&gt;&gt; 
&gt;&gt; .bin//riak-admin bucket-type create bucket '{"props": {"consistent": true}}'
&gt;&gt; ./bin/riak-admin bucket-type activate bucket
&gt;&gt; 
&gt;&gt; ./bin/riak stop
&gt;&gt; ./bin/riak start
&gt;&gt; 
&gt;&gt; on a erlang console, initialized with:
&gt;&gt; 
&gt;&gt; ./erts-5.10.3/bin/erl -pa ../riak-erlang-client/ebin 
&gt;&gt; ../riak-erlang-client/deps/\\*/ebin
&gt;&gt; 
&gt;&gt; f(Pid), {ok, Pid} = riakc\\_pb\\_socket:start\\_link("localhost", 8087).
&gt;&gt; NewA = riakc\\_obj:new(&lt;&lt;"bucket"&gt;&gt;, &lt;&lt;"key"&gt;&gt;, &lt;&lt;"my binary data"&gt;&gt;).
&gt;&gt; NewB = riakc\\_obj:new(&lt;&lt;"bucket"&gt;&gt;, &lt;&lt;"key"&gt;&gt;, &lt;&lt;"my other binary data"&gt;&gt;).
&gt;&gt; riakc\\_pb\\_socket:put(Pid, NewA, [return\\_body]).
&gt;&gt; {ok,{riakc\\_obj,&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"key"&gt;&gt;,
&gt;&gt; &lt;&lt;107,206,97,96,96,96,204,96,202,5,82,28,202,156,255,126,
&gt;&gt; 6,245,74,255,202,96,74,...&gt;&gt;,
&gt;&gt; [{{dict,2,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt; &lt;&lt;"my binary data"&gt;&gt;}],
&gt;&gt; undefined,undefined}}
&gt;&gt; 5&gt; riakc\\_pb\\_socket:put(Pid, NewB, [return\\_body]).
&gt;&gt; {ok,{riakc\\_obj,&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"key"&gt;&gt;,
&gt;&gt; &lt;&lt;107,206,97,96,96,96,204,96,202,5,82,28,202,156,255,126,
&gt;&gt; 6,245,74,255,202,96,74,...&gt;&gt;,
&gt;&gt; [{{dict,2,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt; &lt;&lt;"my binary data"&gt;&gt;},
&gt;&gt; {{dict,2,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt; &lt;&lt;"my other binary data"&gt;&gt;}],
&gt;&gt; undefined,undefined}}
&gt;&gt; 
&gt;&gt; bin/riak-admin bucket-type status bucket
&gt;&gt; bucket is active
&gt;&gt; 
&gt;&gt; young\\_vclock: 20
&gt;&gt; w: quorum
&gt;&gt; small\\_vclock: 50
&gt;&gt; rw: quorum
&gt;&gt; r: quorum
&gt;&gt; pw: 0
&gt;&gt; precommit: []
&gt;&gt; pr: 0
&gt;&gt; postcommit: []
&gt;&gt; old\\_vclock: 86400
&gt;&gt; notfound\\_ok: true
&gt;&gt; n\\_val: 3
&gt;&gt; linkfun: {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}
&gt;&gt; last\\_write\\_wins: false
&gt;&gt; dw: quorum
&gt;&gt; consistent: true
&gt;&gt; chash\\_keyfun: {riak\\_core\\_util,chash\\_std\\_keyfun}
&gt;&gt; big\\_vclock: 50
&gt;&gt; basic\\_quorum: false
&gt;&gt; allow\\_mult: true
&gt;&gt; active: true
&gt;&gt; claimant: 'riak@127.0.0.1
&gt;&gt; 
&gt;&gt; bin/riak-admin bucket-type list
&gt;&gt; bucket (active)
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; No dia 20/11/2013, às 17:23, Jordan West  escreveu:
&gt;&gt; 
&gt;&gt;&gt; Hi Valter,
&gt;&gt;&gt; 
&gt;&gt;&gt; Could you provide the code you are using to generate the concurrent 
&gt;&gt;&gt; requests in addition to the output of `riak-admin bucket-type list` and 
&gt;&gt;&gt; `riak-admin bucket-type status ` where  is the name 
&gt;&gt;&gt; of the strongly consistent bucket you created (from one node should be 
&gt;&gt;&gt; sufficient)? I've been using this feature in a personal project and just 
&gt;&gt;&gt; tested on a local cluster using curl and was unable to reproduce (the 
&gt;&gt;&gt; cluster was a bit behind develop but there have been no recent changes to 
&gt;&gt;&gt; the feature).
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers,
&gt;&gt;&gt; Jordan 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Wed, Nov 20, 2013 at 5:30 AM, Valter Balegas  wrote:
&gt;&gt;&gt; Hello,
&gt;&gt;&gt; 
&gt;&gt;&gt; I was able to activate strong consistency, but the node keeps generating 
&gt;&gt;&gt; siblings, when i execute two concurrent writes (Store two objects without 
&gt;&gt;&gt; vector clock).
&gt;&gt;&gt; I tried with the Riak 2.0.0.5pre package and the latest version on the 
&gt;&gt;&gt; repository. Am i missing anything? i was expecting operations to fail, in 
&gt;&gt;&gt; this case.
&gt;&gt;&gt; 
&gt;&gt;&gt; It seems that the error was caused by my Erlang version. The creation of 
&gt;&gt;&gt; the bucket type didn’t fail with R16B02.
&gt;&gt;&gt; 
&gt;&gt;&gt; Valter
&gt;&gt;&gt; 
&gt;&gt;&gt; No dia 20/11/2013, às 03:13, Jordan West  escreveu:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Valter,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; You mentioned you are using a recent develop. Would you be able to pull 
&gt;&gt;&gt;&gt; down any recent changes and update-deps (or build a fresh devrel)? I just 
&gt;&gt;&gt;&gt; tried a fresh clone of develop and was unable to reproduce the same error. 
&gt;&gt;&gt;&gt; I, also, tried with R15B01 (Riak 2.0 is slated to use R16B02 right now). 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Alternatively, you should be able to workaround this by doing a `riak 
&gt;&gt;&gt;&gt; attach-direct` and defining the atom at the erlang shell:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 1&gt; consistent.
&gt;&gt;&gt;&gt; consistent
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Jordan
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Tue, Nov 19, 2013 at 3:06 PM, Valter Balegas  wrote:
&gt;&gt;&gt;&gt; I can’t create the bucket type:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; RPC to 'riak@127.0.0.1' failed: {'EXIT',
&gt;&gt;&gt;&gt; {badarg,
&gt;&gt;&gt;&gt; [{erlang,list\\_to\\_existing\\_atom,
&gt;&gt;&gt;&gt; ["consistent"],
&gt;&gt;&gt;&gt; []},
&gt;&gt;&gt;&gt; {riak\\_kv\\_wm\\_utils,erlify\\_bucket\\_prop,1,
&gt;&gt;&gt;&gt; [{file,"src/riak\\_kv\\_wm\\_utils.erl"},
&gt;&gt;&gt;&gt; {line,393}]},
&gt;&gt;&gt;&gt; {riak\\_kv\\_console,
&gt;&gt;&gt;&gt; '-bucket\\_type\\_create/2-lc$^0/1-0-',1,
&gt;&gt;&gt;&gt; [{file,"src/riak\\_kv\\_console.erl"},
&gt;&gt;&gt;&gt; {line,483}]},
&gt;&gt;&gt;&gt; {riak\\_kv\\_console,bucket\\_type\\_create,2,
&gt;&gt;&gt;&gt; [{file,"src/riak\\_kv\\_console.erl"},
&gt;&gt;&gt;&gt; {line,483}]},
&gt;&gt;&gt;&gt; {rpc,'-handle\\_call\\_call/6-fun-0-',5,
&gt;&gt;&gt;&gt; [{file,"rpc.erl"},{line,203}]}]}}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I activated the consensus in riak.conf in the etc dir (find command seems 
&gt;&gt;&gt;&gt; not to find the pattern anywhere else).
&gt;&gt;&gt;&gt; Is there any other way to create the bucket?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Valter
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; No dia 19/11/2013, às 18:10, Jordan West  escreveu:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Tue, Nov 19, 2013 at 7:33 AM, Valter Balegas  wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Strong consistency:
&gt;&gt;&gt;&gt;&gt; How does one activate this? As i understand, either the pb or the http 
&gt;&gt;&gt;&gt;&gt; clients do not accept the consistent property.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Using strong consistency in the Tech Preview is a two-step process. 
&gt;&gt;&gt;&gt;&gt; First, turn on the feature in your riak.conf (the following command 
&gt;&gt;&gt;&gt;&gt; assumes you are using a devrel):
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; for d in dev/dev\\*; do sed -e 's/## enable\\_consensus = 
&gt;&gt;&gt;&gt;&gt; true/enable\\_consensus = true/' -i $d/etc/riak.conf; done
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Then re(start) the cluster.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; With the enable\\_consensus=true un-commented and the cluster running 
&gt;&gt;&gt;&gt;&gt; create a strongly consistent bucket type:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; riak-admin bucket-type create  '{"props": {"consistent": 
&gt;&gt;&gt;&gt;&gt; true}}'
&gt;&gt;&gt;&gt;&gt; riak-admin bucket-type activate 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; You can create and activate the bucket type without having 
&gt;&gt;&gt;&gt;&gt; enabled\\_consensus=true but both must be done to work with strongly 
&gt;&gt;&gt;&gt;&gt; consistent data.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Once that is done you can make requests, just like you would to 
&gt;&gt;&gt;&gt;&gt; eventually consistent data in Riak, but the semantics will be different. 
&gt;&gt;&gt;&gt;&gt; For example, if you make two PUT requests to the same key, w/ no vector 
&gt;&gt;&gt;&gt;&gt; clock\\*, the second request will fail because the data already exists. 
&gt;&gt;&gt;&gt;&gt; More details on semantics of strongly consistent requests can be found in 
&gt;&gt;&gt;&gt;&gt; this PR: https://github.com/basho/riak\\_kv/pull/710
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hope that helps get you started,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Jordan
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; \\* in strong consistency, the "vector clock" is not really a vector clock. 
&gt;&gt;&gt;&gt;&gt; its called such for familiarity, but like any real vector clock exposed 
&gt;&gt;&gt;&gt;&gt; to the client, should be treated like an opaque context.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Details about my environment:
&gt;&gt;&gt;&gt;&gt; -I’m running Mac OSX 10.9
&gt;&gt;&gt;&gt;&gt; -Erlang R15B01
&gt;&gt;&gt;&gt;&gt; -Compiling riak “develop” branch, from basho github
&gt;&gt;&gt;&gt;&gt; -Compiling riak-erlang-client “master” branch, from basho github.
&gt;&gt;&gt;&gt;&gt; -recompiled the latest versions of the branches just before writing this 
&gt;&gt;&gt;&gt;&gt; email.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thank you for your help,
&gt;&gt;&gt;&gt;&gt; Valter
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

