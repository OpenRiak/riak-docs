---
title: "Re: TCP recv timeout and handoffs almost all the time"
description: ""
project: community
lastmod: 2013-07-19T06:58:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11627"
mailinglist_parent_id: "msg11624"
author_name: "Simon Effenberg"
project_section: "mailinglistitem"
sent_date: 2013-07-19T06:58:17-07:00
---


It looked good for some hours but now again we got 

2013-07-19 13:27:07.800 UTC [error] 
&lt;0.18747.29&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:216 hinted\\_handoff transfer of 
riak\\_kv\\_vnode from 'riak@10.46.109.207' 
1136089163393944065322395631681798128560666312704 to 'riak@10.47.109.202' 
1136089163393944065322395631681798128560666312704 failed because of TCP recv 
timeout

and on the destination host I see:


2013-07-19 13:25:04.455 UTC [error] 
&lt;0.28632.25&gt;@riak\\_core\\_handoff\\_receiver:handle\\_info:80 Handoff receiver for 
partition 1136089163393944065322395631681798128560666312704 exited abnormally 
after processing 2 objects: 
{timeout,{gen\\_fsm,sync\\_send\\_all\\_state\\_event,[&lt;0.1107.0&gt;,{handoff\\_data,&lt;&lt;141,146,205,110,211,64,20,133,237,4,211,132,2,170,80,69,37,150,22,203,186,216,249,105,210,172,42,149,95,137,162,2,5,177,129,232,120,102,156,153,137,61,78,237,113,72,10,172,186,101,195,51,176,224,1,120,12,158,130,55,97,198,173,68,83,177,192,35,223,197,55,231,156,185,158,235,27,155,36,87,115,86,148,208,34,87,227,146,145,130,233,242,206,173,46,153,204,59,60,18,125,61,91,208,123,223,188,51,190,70,157,86,49,206,99,201,136,206,28,199,249,167,209,110,172,122,83,67,92,222,164,78,187,24,27,135,102,74,243,54,117,174,81,65,52,60,108,152,213,194,17,66,190,33,175,60,220,189,204,108,78,195,150,117,123,198,205,139,168,64,47,103,12,26,12,11,83,31,96,134,20,128,128,170,245,91,86,186,254,46,120,37,48,13,222,30,99,130,1,158,152,213,67,132,199,168,240,26,7,72,12,123,134,23,198,25,154,247,33,30,225,16,18,39,56,56,63,210,173,139,205,241,132,162,108,33,175,226,205,139,248,231,40,117,112,152,83,145,8,70,121,51,54,134,15,177,211,252,252,59,118,218,223,127,94,114,93,183,174,53,194,81,148,76,227,13,142,77,43,1,134,82,90,254,227,147,111,238,212,31,69,219,126,44,168,63,242,211,124,206,210,101,86,149,130,116,250,251,147,12,34,221,33,121,230,111,251,101,189,207,243,100,63,143,89,161,4,83,59,148,25,30,151,6,79,39,162,43,62,46,79,213,105,181,103,181,150,173,140,197,64,208,58,33,234,134,123,195,97,212,11,13,210,70,23,117,7,189,78,103,216,31,12,118,67,211,6,169,69,187,211,98,113,50,226,18,75,213,77,184,255,229,252,115,120,195,246,220,58,186,251,244,236,101,182,117,159,55,224,42,207,193,215,247,191,110,203,191,67,118,255,127,200,114,229,122,169,227,145,148,65,153,32,93,84,76,74,243,19,85,102,8,137,80,140,254,1&gt;&gt;},60000]}}

so both shows a timeout. How could I takle this down?

- could this happen when many read repairs occur (through AAE)?

Also our "fsm PUT time is going higher but not really the GET time".. is this 
the normal behavior in LOAD/read repair situations?

Also is this a bigger problem with eLevelDB or would it be the same case for 
Bitcask?

Cheers
Simon


On Fri, 19 Jul 2013 10:25:05 +0200
Simon Effenberg  wrote:

&gt; once again with the list included... argh
&gt; 
&gt; Hey Christian,
&gt; 
&gt; so it could be also a erlang limit? I found out why my riak instances
&gt; are all having different processlimits. My mcollectived daemons have
&gt; the different limits and when I triggered a puppetrun through
&gt; mcollective they got this processlimit as well.
&gt; 
&gt; Also in the crash log I see:
&gt; 
&gt; exception exit: {{system\\_limit,[{erlang,spawn
&gt; 
&gt; for the too many processes. So it doesn't look like a Erlang limit, do
&gt; it? But I will keep this +P in my mind!! Thanks a lot.
&gt; 
&gt; The zdbbl is now at 100MB.
&gt; 
&gt; Cheers
&gt; Simon
&gt; 
&gt; On Fri, 19 Jul 2013 08:49:50 +0100
&gt; Christian Dahlqvist  wrote:
&gt; 
&gt; &gt; Hi Simon,
&gt; &gt; 
&gt; &gt; If you have objects that can be a s big as 15MB, it is probably wise to 
&gt; &gt; increase the size of +zdbbl in order to avoid filling up buffers when these 
&gt; &gt; large objects need to be transferred between nodes. What an appropriate 
&gt; &gt; level is depends a lot on the size distribution of your data and your 
&gt; &gt; access patterns, so I would recommend benchmarking to find a suitable value.
&gt; &gt; 
&gt; &gt; Erlang also has a default process limit of 32768 (at least in R15B01), 
&gt; &gt; which may be what you are hitting. You can override this to 256k by adding 
&gt; &gt; the following line to the vm.args file:
&gt; &gt; 
&gt; &gt; +P 262144
&gt; &gt; 
&gt; &gt; Best regards,
&gt; &gt; 
&gt; &gt; Christian
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On 19 Jul 2013, at 08:24, Simon Effenberg  wrote:
&gt; &gt; 
&gt; &gt; &gt; The +zdbbl parameter helped a lot but the hinted handoffs didn't
&gt; &gt; &gt; disappear completely. I have no more busy dist port errors in the
&gt; &gt; &gt; \\_console.log\\_ (why aren't they in the error.log? it looks for me like a
&gt; &gt; &gt; serious problem you have.. at least our cluster was behaving not that
&gt; &gt; &gt; nice).
&gt; &gt; &gt; 
&gt; &gt; &gt; I'll try to increase the buffer size to a higher value because my
&gt; &gt; &gt; suggestion is that also the objects send from one to another are also
&gt; &gt; &gt; stored therein and we have sometimes objects which are up to 15MB.
&gt; &gt; &gt; 
&gt; &gt; &gt; But I saw now also some crashes in the last 6 hours on only two machines
&gt; &gt; &gt; complaining about too many processes
&gt; &gt; &gt; 
&gt; &gt; &gt; ----------------
&gt; &gt; &gt; console.log
&gt; &gt; &gt; 2013-07-19 02:04:21.962 UTC [error] &lt;0.12813.29&gt; CRASH REPORT Process 
&gt; &gt; &gt; &lt;0.12813.29&gt; with 15 neighbours exited with reason: {system\\_limit
&gt; &gt; &gt; 
&gt; &gt; &gt; crash.log
&gt; &gt; &gt; 2013-07-19 02:04:21 UTC =ERROR REPORT====
&gt; &gt; &gt; Too many processes
&gt; &gt; &gt; ----------------
&gt; &gt; &gt; 
&gt; &gt; &gt; the process has a process limit of 95142. So I will increase it now but I 
&gt; &gt; &gt; never saw any information about such problems on the linux tuning page. 
&gt; &gt; &gt; Am I missing something?
&gt; &gt; &gt; 
&gt; &gt; &gt; Cheers
&gt; &gt; &gt; Simon
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; On Thu, 18 Jul 2013 19:34:18 +0100
&gt; &gt; &gt; Guido Medina  wrote:
&gt; &gt; &gt; 
&gt; &gt; &gt;&gt; If what you are describing is happening for 1.4, type riak-admin diag 
&gt; &gt; &gt;&gt; and see the new recommended kernel parameters, also, on vm.args 
&gt; &gt; &gt;&gt; uncomment the +zdbbl 32768 parameter, since what you are describing is 
&gt; &gt; &gt;&gt; similar to what happened to us when we upgraded to 1.4.
&gt; &gt; &gt;&gt; 
&gt; &gt; &gt;&gt; HTH,
&gt; &gt; &gt;&gt; 
&gt; &gt; &gt;&gt; Guido.
&gt; &gt; &gt;&gt; 
&gt; &gt; &gt;&gt; On 18/07/13 19:21, Simon Effenberg wrote:
&gt; &gt; &gt;&gt;&gt; Hi @list,
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; I see sometimes logs talking about "hinted\\_handoff transfer of .. 
&gt; &gt; &gt;&gt;&gt; failed because of TCP recv timeout".
&gt; &gt; &gt;&gt;&gt; Also riak-admin transfers shows me many handoffs (is it possible to 
&gt; &gt; &gt;&gt;&gt; give some insights about "how many" handoffs happened through 
&gt; &gt; &gt;&gt;&gt; "riak-admin status"?).
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; - Is it a normal behavior to have up to 30 handoffs from/to different 
&gt; &gt; &gt;&gt;&gt; nodes?
&gt; &gt; &gt;&gt;&gt; - How can I get down to the problem with the TCP recv timeout? I'm not 
&gt; &gt; &gt;&gt;&gt; sure if this is a network problem or if the other node is too slow. The 
&gt; &gt; &gt;&gt;&gt; load is ok on the machines (some IOwait but not 100%). Maybe 
&gt; &gt; &gt;&gt;&gt; interfering with AAE?
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; Here the log information about the TCP recv timeout. But that is not 
&gt; &gt; &gt;&gt;&gt; that often but handoffs happens really often:
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; 2013-07-18 16:22:05.654 UTC [error] 
&gt; &gt; &gt;&gt;&gt; &lt;0.28933.14&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:216 hinted\\_handoff 
&gt; &gt; &gt;&gt;&gt; transfer of riak\\_kv\\_vnode from 'riak@10.46.109.207' 
&gt; &gt; &gt;&gt;&gt; 1118962191081472546749696200048404186924073353216 to 
&gt; &gt; &gt;&gt;&gt; 'riak@10.46.109.205' 1118962191081472546749696200048404186924073353216 
&gt; &gt; &gt;&gt;&gt; failed because of TCP recv timeout
&gt; &gt; &gt;&gt;&gt; 2013-07-18 16:22:05.673 UTC [error] 
&gt; &gt; &gt;&gt;&gt; &lt;0.202.0&gt;@riak\\_core\\_handoff\\_manager:handle\\_info:282 An outbound handoff 
&gt; &gt; &gt;&gt;&gt; of partition riak\\_kv\\_vnode 
&gt; &gt; &gt;&gt;&gt; 1118962191081472546749696200048404186924073353216 was terminated for 
&gt; &gt; &gt;&gt;&gt; reason: {shutdown,timeout}
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; Thanks in advance
&gt; &gt; &gt;&gt;&gt; Simon
&gt; &gt; &gt;&gt;&gt; 
&gt; &gt; &gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt;&gt; 
&gt; &gt; &gt;&gt; 
&gt; &gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt;&gt; riak-users mailing list
&gt; &gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; -- 
&gt; &gt; &gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; &gt; &gt; Fon: + 49-(0)30-8109 - 7173
&gt; &gt; &gt; Fax: + 49-(0)30-8109 - 7131
&gt; &gt; &gt; 
&gt; &gt; &gt; Mail: seffenb...@team.mobile.de
&gt; &gt; &gt; Web: www.mobile.de
&gt; &gt; &gt; 
&gt; &gt; &gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; Geschäftsführer: Malte Krüger
&gt; &gt; &gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; &gt; &gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; &gt; &gt; 
&gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; Fon: + 49-(0)30-8109 - 7173
&gt; Fax: + 49-(0)30-8109 - 7131
&gt; 
&gt; Mail: seffenb...@team.mobile.de
&gt; Web: www.mobile.de
&gt; 
&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; 
&gt; 
&gt; Geschäftsführer: Malte Krüger
&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


-- 
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon: + 49-(0)30-8109 - 7173
Fax: + 49-(0)30-8109 - 7131

Mail: seffenb...@team.mobile.de
Web: www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

