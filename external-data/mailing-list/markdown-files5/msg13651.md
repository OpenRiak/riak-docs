---
title: "Re: riak crashing when indexing for search"
description: ""
project: community
lastmod: 2014-02-13T07:29:36-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13651"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2014-02-13T07:29:36-08:00
---


Hi Glory,

On Tue, Feb 11, 2014 at 1:29 AM, Glory Lo  wrote:
&gt;
&gt;
&gt; While indexing it seem to run fine part way.. then I noticed it hangs (it
&gt; freezed my machine on a couple of attempts on linux mint 13). Then it
&gt; crashes. I have 3 nodes running and I only tried indexing one of them
&gt; doing a search-cmd mybucket dev1/data/leveldb
&gt;

What was the process for indexing? How much data were you indexing? What
content-type? How big is each object? What is your schema?


&gt; My crash log has multiple errors of different sorts which I haven't
&gt; discern yet. However, the last errors w/ a close timestamp are as follows
&gt; which mentions some timeouts (likely with the freeze):
&gt;

It's hard to discern ripple effect errors from the the origin error. I see
some stuff that is indicative of disk corruption but there's a good chance
that only happened because some other error caused merge\\_index to hard
crash. Could you attach a tar.gz of all your logs?


&gt;
&gt; 2014-02-08 23:15:53 =ERROR REPORT====
&gt; Error in process &lt;0.2799.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {badarg,[{ets,lookup,[145752322,{1118962191081472546749696200048404186924073353216,'
&gt; dev2@127.0.0.1
&gt; '}],[]},{riak\\_search\\_client,'-process\\_terms\\_1/4-fun-2-',3,[{file,"src/riak\\_search\\_client.erl"},{line,295}]},{riak\\_search\\_utils,'-ptransform/2-fun-0-',2,[{file,"src/riak\\_search\\_utils....
&gt;

This is an error finding the temporary ETS table for building the postings
list. That's a really interesting error to have and makes me wonder if you
someone hit the ETS system limit. I'm not even sure that is possible given
how high we've raised the default limit.


&gt;
&gt; 2014-02-08 23:18:46 =ERROR REPORT====
&gt; Error in process &lt;0.2350.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {terminated,[{io,format,[&lt;17869.23.0&gt;,"DEBUG: ~p:~p - ~p~n~n
&gt; ~p~n~n",[riak\\_search\\_dir\\_indexer,194,"{ error , Type , Error , erlang :
&gt; get\\_stacktrace ( )
&gt; }",{error,error,{case\\_clause,{error,timeout}},[{riak\\_search\\_client,'-index\\_docs/1-fun-0-'...
&gt;

I'm actually a bit baffled exactly what this trace is saying. I think more
detail might be in the error.log.


&gt;
&gt; 2014-02-08 23:20:00 =ERROR REPORT====
&gt; Error in process &lt;0.4231.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {{case\\_clause,{data,4711}},[{cpu\\_sup,get\\_uint32\\_measurement,2,[{file,"cpu\\_sup.erl"},{line,227}]},{cpu\\_sup,measurement\\_server\\_loop,1,[{file,"cpu\\_sup.erl"},{line,585}]}]}
&gt;

Yikes, this looks really bad and makes me wonder if this is an environment
issue as this error should not be related to search.


&gt;
&gt; 2014-02-08 23:23:37 =ERROR REPORT====
&gt; Error in process &lt;0.6359.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {badarg,[{erlang,binary\\_to\\_term,[&lt;&lt;31359
&gt; bytes&gt;&gt;],[]},{mi\\_segment,iterate\\_all\\_bytes,2,[{file,"src/mi\\_segment.erl"},{line,167}]},{mi\\_segment\\_writer,from\\_iterator,4,[{file,"src/mi\\_segment\\_writer.erl"},{line,102}]},{mi\\_segment\\_writer,from\\_iterator...
&gt;

This is typically what you see when data corruption occurs but it's hard to
say if data corruption caused the other errors of the other errors caused
corruption.


&gt;
&gt;
&gt;
&gt; 2014-02-08 23:24:58 =ERROR REPORT====
&gt; \\*\\* State machine &lt;0.3211.0&gt; terminating
&gt; \\*\\* Last message in was {'EXIT',&lt;0.168.0&gt;,shutdown}
&gt; \\*\\* When State == active
&gt; \\*\\* Data ==
&gt; {state,1438665674247607560106752257205091097473808596992,riak\\_search\\_vnode,{vstate,1438665674247607560106752257205091097473808596992,merge\\_index\\_backend,{state,1438665674247607560106752257205091097473808596992,&lt;0.3212.0&gt;}},undefined,none,undefined,undefined,&lt;0.3221.0&gt;,{pool,riak\\_search\\_worker,2,[]},undefined,86616}
&gt; \\*\\* Reason for termination =
&gt; \\*\\* {timeout,{gen\\_server,call,[&lt;0.3212.0&gt;,stop]}}
&gt; 2014-02-08 23:24:58 =CRASH REPORT====
&gt; crasher:
&gt; initial call: riak\\_core\\_vnode:init/1
&gt; pid: &lt;0.3211.0&gt;
&gt; registered\\_name: []
&gt; exception exit:
&gt; {{timeout,{gen\\_server,call,[&lt;0.3212.0&gt;,stop]}},[{gen\\_fsm,terminate,7,[{file,"gen\\_fsm.erl"},{line,589}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,227}]}]}
&gt; ancestors: [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.162.0&gt;]
&gt; messages:
&gt; [{'EXIT',&lt;0.3221.0&gt;,shutdown},{#Ref&lt;0.0.1.215952&gt;,ok},{'EXIT',&lt;0.3212.0&gt;,normal}]
&gt; links: []
&gt; dictionary: [{random\\_seed,{27839,21123,25074}}]
&gt; trap\\_exit: true
&gt; status: running
&gt; heap\\_size: 46368
&gt; stack\\_size: 24
&gt; reductions: 24758
&gt; neighbours:
&gt;

This is one of the riak\\_search vnodes crashing because it's merge index
process crashed. Which is expected given the circumstances.


&gt; 2014-02-08 23:24:58 =ERROR REPORT====
&gt; \\*\\* State machine &lt;0.5392.1&gt; terminating
&gt; \\*\\* Last message in was
&gt; {'$gen\\_sync\\_all\\_state\\_event',{&lt;0.5390.1&gt;,#Ref&lt;0.0.1.215861&gt;},{shutdown,60000}}
&gt; \\*\\* When State == ready
&gt; \\*\\* Data == {state,{[],[]},&lt;0.5393.1&gt;,[],undefined}
&gt; \\*\\* Reason for termination =
&gt; \\*\\* {timeout,{gen\\_fsm,sync\\_send\\_all\\_state\\_event,[&lt;0.5393.1&gt;,stop]}}
&gt; 2014-02-08 23:24:58 =CRASH REPORT====
&gt; crasher:
&gt; initial call: riak\\_core\\_vnode\\_worker\\_pool:init/1
&gt; pid: &lt;0.5392.1&gt;
&gt; registered\\_name: []
&gt; exception exit:
&gt; {{timeout,{gen\\_fsm,sync\\_send\\_all\\_state\\_event,[&lt;0.5393.1&gt;,stop]}},[{gen\\_fsm,handle\\_msg,7,[{file,"gen\\_fsm.erl"},{line,511}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,227}]}]}
&gt; ancestors: [&lt;0.5390.1&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.162.0&gt;]
&gt; messages: []
&gt; links: [&lt;0.5390.1&gt;,&lt;0.5393.1&gt;]
&gt; dictionary: []
&gt; trap\\_exit: false
&gt; status: running
&gt; heap\\_size: 233
&gt; stack\\_size: 24
&gt; reductions: 225
&gt; neighbours:
&gt;

This is the worker pool crashing probably because it's vnode crashed.


&gt; 2014-02-08 23:25:01 =SUPERVISOR REPORT====
&gt; Supervisor: {local,riak\\_core\\_vnode\\_sup}
&gt; Context: shutdown\\_error
&gt; Reason: {timeout,{gen\\_server,call,[&lt;0.5436.1&gt;,stop]}}
&gt; Offender:
&gt; [{nb\\_children,1},{name,undefined},{mfargs,{riak\\_core\\_vnode,start\\_link,[]}},{restart\\_type,temporary},{shutdown,300000},{child\\_type,worker}]
&gt;

Supervisor reports just indicating that vnodes have crashed because of a
timeout. Expected given the circumstances.


&gt;
&gt; Can someone provide some guidance as to where to troubleshoot the issue?
&gt; If it's timing out which is a mere symptom of it being in hang state.
&gt; What however is the root cause of it being stuck with those other errors
&gt; like bad arg and bad match.
&gt;

Attach your logs and I should be able to take a closer look.

-Z
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

