---
title: "Re: multiget in python client hangs after timeout"
description: ""
project: community
lastmod: 2014-01-21T11:11:04-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13436"
mailinglist_parent_id: "msg13435"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2014-01-21T11:11:04-08:00
---


Jeff,

This seems like a bug. I designed the multiget code to pass caught
exceptions back along with the other results, but it's totally possible I
made a mistake there. Would you kindly file an issue at
https://github.com/basho/riak-python-client/issues ? Thanks.


On Tue, Jan 21, 2014 at 12:54 PM, Jeff Peck  wrote:

&gt; Hello,
&gt;
&gt; We are using Riak's multiget function from the Python API, and we have
&gt; noticed that our service would sometimes hang and need to be restarted.
&gt; After some searching, we found that the cause was Riak's multiget function.
&gt;
&gt; Consider the following simple example where we are using multiget to only
&gt; get a single object and we are passing a timeout of 1 millisecond.
&gt;
&gt; import riak, riak\\_pb
&gt;
&gt; riak\\_client = riak.RiakClient(host='localhost,
&gt; pb\\_port=8087, protocol='pbc')
&gt;
&gt; for n in range(0,10:
&gt; print
&gt; riak\\_client.multiget([('test\\_bucket', '398eed5613da8d0918cd64b3cf1d44b2')],
&gt; timeout=1) #ms
&gt;
&gt;
&gt; A RiakError is raised, but the script just hangs after that and can only
&gt; be stopped with a signal 9:
&gt;
&gt; Exception in thread riak.client.multiget-worker-0:
&gt; Traceback (most recent call last):
&gt; File "/usr/local/lib/python2.6/threading.py", line 532, in
&gt; \\_\\_bootstrap\\_inner
&gt; self.run()
&gt; File "/usr/local/lib/python2.6/threading.py", line 484, in run
&gt; self.\\_\\_target(\\*self.\\_\\_args, \\*\\*self.\\_\\_kwargs)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/client/multiget.py",
&gt; line 130, in \\_fetcher
&gt; \\*\\*task.options)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/bucket.py", line 206,
&gt; in get
&gt; return obj.reload(r=r, pr=pr, timeout=timeout)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/riak\\_object.py", line
&gt; 307, in reload
&gt; self.client.get(self, r=r, pr=pr, timeout=timeout)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/client/transport.py",
&gt; line 127, in wrapper
&gt; return self.\\_with\\_retries(pool, thunk)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/client/transport.py",
&gt; line 69, in \\_with\\_retries
&gt; return fn(transport)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/client/transport.py",
&gt; line 125, in thunk
&gt; return fn(self, transport, \\*args, \\*\\*kwargs)
&gt; File "/usr/local/lib/python2.6/site-packages/riak/client/operations.py",
&gt; line 315, in get
&gt; return transport.get(robj, r=r, pr=pr, timeout=timeout)
&gt; File
&gt; "/usr/local/lib/python2.6/site-packages/riak/transports/pbc/transport.py",
&gt; line 146, in get
&gt; MSG\\_CODE\\_GET\\_RESP)
&gt; File
&gt; "/usr/local/lib/python2.6/site-packages/riak/transports/pbc/connection.py",
&gt; line 43, in \\_request
&gt; return self.\\_recv\\_msg(expect)
&gt; File
&gt; "/usr/local/lib/python2.6/site-packages/riak/transports/pbc/connection.py",
&gt; line 55, in \\_recv\\_msg
&gt; raise RiakError(err.errmsg)
&gt; RiakError: 'timeout'
&gt;
&gt;
&gt; We are not able to catch the exception because it occurs in a different
&gt; thread. So, when this occurs, it renders our service unusable until a
&gt; restart is issued.
&gt;
&gt; I would like to know if anybody else has encountered this and if there are
&gt; any known work-arounds or a patch for riak/client/multiget.py that will
&gt; propagate the timeout exception so the main thread no longer waits for it
&gt; to never return.
&gt;
&gt; Thanks,
&gt; Jeff
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;


-- 
Sean Cribbs 
Software Engineer
Basho Technologies, Inc.
http://basho.com/
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

