---
title: "Re: RiakCS large file uploads fail with 403/AccessDenied and	400/InvalidDigest"
description: ""
project: community
lastmod: 2015-03-10T04:04:21-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15867"
mailinglist_parent_id: "msg15865"
author_name: "Niels O"
project_section: "mailinglistitem"
sent_date: 2015-03-10T04:04:21-07:00
---


Hello Kota,

Theoretically I understand the issue, but I don't see where I have
URLencoded / decoded any data? this is my sourcecode for test-uploading the
files where should I change anything (without hacking into the \\*AWS Node.js
SDK itself)? \\*

\\*my code that fails if file gets too big to upload in one part: \\*


\\*'use strict'; var fs = require('fs'), AWS = require('aws-sdk');
AWS.config.update( { "accessKeyId": "GHSEZVCH4NYD359IZUEX",
"secretAccessKey": "IZnu4wr0e-LaBZ2ShBXiIwGVceaMkJigpqPxCw==", "region":
"us-east-1",'httpOptions': {'proxy': 'http://172.16.3.21:8080'}});
AWS.config.update({region: ''}); var s3 = new AWS.S3(); var
globalUnCaughtException = function(err) { console.log("uncaughtException:
", err.stack); }; process.on('uncaughtException', globalUnCaughtException);
function uploadFile(s3) { console.log(s3); var body =
fs.createReadStream(fileName); var params = {Bucket: bucket, Key: fileKey,
Body: body}; s3.upload(params, function(err, data) {
console.log("uploaded", err, data); }); } if (process.argv[2] !== undefined
) { // strip path for s3 var fileName = process.argv[2]; var fileKey =
fileName.slice(fileName.lastIndexOf("/")+1); console.log("fileKey: " +
fileKey); // S3 Upload options var bucket = 'testje'; uploadFile(s3); }\\*



On Tue, Mar 10, 2015 at 2:25 AM, Kota Uenishi  wrote:

&gt; Sorry, being late. I thought I've replied to you, but it was a very
&gt; close one where I think you're hitting the same problem as this:
&gt;
&gt;
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2015-February/016845.html
&gt;
&gt; Riak CS often includes `=' in uploadId of multipart uploads while S3
&gt; doesn't (where no specs described in official documents).
&gt;
&gt; On Thu, Feb 12, 2015 at 12:41 AM, Niels O  wrote:
&gt; &gt; Hello everyone,
&gt; &gt;
&gt; &gt; I have just installed riakcs and have the s3cmd and nodejs (the official
&gt; &gt; amazon) plugin working.
&gt; &gt;
&gt; &gt; with the same credentials (accesskey&secret) I CAN upload big files with
&gt; &gt; S3CMD but I CANNOT with the AWS/S3 nodejs plugin? (downloading very big
&gt; &gt; files is no problem b.t.w.)
&gt; &gt;
&gt; &gt;
&gt; &gt; with the nodejs plugin
&gt; &gt;
&gt; &gt; - until 992k, (I tested with 32 KiB increases) everything works
&gt; &gt; - starting at 1024 KiB I get [400 InvalidDigest: The Content-MD5 you
&gt; &gt; specified was invalid.]
&gt; &gt; - from 8192 KiB and beyond I get [403 AccessDenied] back from riakcs.
&gt; &gt;
&gt; &gt; this while -again- with s3cmd I am able to upload files of over 1 GiB
&gt; size
&gt; &gt; easily .. same machine, same creds
&gt; &gt;
&gt; &gt; any ideas?
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; (below some riakcs debug logging from both the 400 and 403) ...
&gt; &gt;
&gt; &gt;
&gt; &gt; 400 - InvalidDigest:
&gt; &gt;
&gt; &gt; 2015-02-11 16:34:16.911 [debug]
&gt; &gt; &lt;0.17889.18&gt;@riak\\_cs\\_s3\\_auth:calculate\\_signature:129 STS:
&gt; &gt;
&gt; ["PUT","\\n","0BsQLab2tMEzr8IWoS2m5w==","\\n","application/octet-stream","\\n","\\n",[["x-amz-date",":",&lt;&lt;"Wed,
&gt; &gt; 11 Feb 2015 15:34:16 GMT"&gt;&gt;,"\\n"]],["/testje/4096k",[]]]
&gt; &gt; 2015-02-11 16:34:17.854 [debug]
&gt; &gt; &lt;0.23568.18&gt;@riak\\_cs\\_put\\_fsm:is\\_digest\\_valid:326 Calculated =
&gt; &gt; &lt;&lt;"pIFX5fpeo7+sPPNjtSBWBg=="&gt;&gt;, Reported = "0BsQLab2tMEzr8IWoS2m5w=="
&gt; &gt; 2015-02-11 16:34:17.860 [debug] &lt;0.23568.18&gt;@riak\\_cs\\_put\\_fsm:done:303
&gt; &gt; Invalid digest in the PUT FSM
&gt; &gt;
&gt; &gt;
&gt; &gt; 403 - AccessDenied
&gt; &gt;
&gt; &gt; 2015-02-11 16:36:00.448 [debug]
&gt; &gt; &lt;0.22889.18&gt;@riak\\_cs\\_s3\\_auth:calculate\\_signature:129 STS:
&gt; &gt;
&gt; ["POST","\\n",[],"\\n","application/octet-stream","\\n","\\n",[["x-amz-date",":",&lt;&lt;"Wed,
&gt; &gt; 11 Feb 2015 15:36:00 GMT"&gt;&gt;,"\\n"]],["/testje/8192k","?uploads"]]
&gt; &gt; 2015-02-11 16:36:00.484 [debug]
&gt; &gt; &lt;0.23539.18&gt;@riak\\_cs\\_s3\\_auth:calculate\\_signature:129 STS:
&gt; &gt;
&gt; ["PUT","\\n","sq5d2PIhC7I1xxT8Rp9cVg==","\\n","application/octet-stream","\\n","\\n",[["x-amz-date",":",&lt;&lt;"Wed,
&gt; &gt; 11 Feb 2015 15:36:00
&gt; &gt;
&gt; GMT"&gt;&gt;,"\\n"]],["/testje/8192k","?partNumber=1&uploadId=TXR2AuCeRDWwc2bviLPcOg=="]]
&gt; &gt; 2015-02-11 16:36:00.484 [debug]
&gt; &gt; &lt;0.23539.18&gt;@riak\\_cs\\_wm\\_common:post\\_authentication:471 bad\\_auth
&gt; &gt; 2015-02-11 16:36:00.494 [debug]
&gt; &gt; &lt;0.23543.18&gt;@riak\\_cs\\_s3\\_auth:calculate\\_signature:129 STS:
&gt; &gt;
&gt; ["DELETE","\\n",[],"\\n","application/octet-stream","\\n","\\n",[["x-amz-date",":",&lt;&lt;"Wed,
&gt; &gt; 11 Feb 2015 15:36:00
&gt; &gt; GMT"&gt;&gt;,"\\n"]],["/testje/8192k","?uploadId=TXR2AuCeRDWwc2bviLPcOg=="]]
&gt; &gt; 2015-02-11 16:36:00.494 [debug]
&gt; &gt; &lt;0.23543.18&gt;@riak\\_cs\\_wm\\_common:post\\_authentication:471 bad\\_auth
&gt; &gt;
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

