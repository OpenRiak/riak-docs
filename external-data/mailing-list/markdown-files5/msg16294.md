---
title: "Re: Riak LevelDB Deletion Problem"
description: ""
project: community
lastmod: 2015-07-14T13:22:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16294"
mailinglist_parent_id: "msg16293"
author_name: "Antonio Teixeira"
project_section: "mailinglistitem"
sent_date: 2015-07-14T13:22:36-07:00
---


Ok Matthew,

We will proceed with the deletion , will monitor the disk space and will
come back with further reports to the list.

Thanks for your time,
Antonio

2015-07-14 18:32 GMT+01:00 Matthew Von-Maszewski :

&gt; Antonio,
&gt;
&gt; A Riak delete operation happens in these steps:
&gt;
&gt; - Riak writes a “tombstone” value for the key to the N vnodes that contain
&gt; it (this is a new record)
&gt;
&gt; - Riak by default, waits 3 seconds to verify all vnodes agree to the
&gt; tombstone/delete
&gt;
&gt; - Riak issues an actual delete operation against the key to leveldb
&gt;
&gt; - leveldb creates its own tombstone
&gt;
&gt; - the leveldb tombstone “floats” through level-0 and level-1 as part of
&gt; normal compactions
&gt;
&gt; - upon reaching level-2, leveldb will initiate immediate compaction and
&gt; propagation of tombstones in .sst table files containing 1000 or more
&gt; tombstones. This is when disk space recovery begins.
&gt;
&gt;
&gt; Yes, this means that initially the leveldb vnodes will grow in size until
&gt; enough stuff (new data and/or tombstones) forces the tombstones to level-2
&gt; via normal compaction operations. “Enough stuff” to fill levels 0 and 1 is
&gt; about 4.2Gbytes of compressed Riak objects.
&gt;
&gt; The “get” operation you mentioned is something that happens internally. A
&gt; manual “get” by your code will not influence the operation.
&gt;
&gt; Matthew
&gt;
&gt;
&gt; On Jul 14, 2015, at 1:01 PM, Antonio Teixeira 
&gt; wrote:
&gt;
&gt; Hi Matthew,
&gt;
&gt; We will be removing close to 1 TB of data from the node , and since we are
&gt; short on "disk space" when we saw that the disk space was actually rising
&gt; we halted the data removal.
&gt;
&gt; Now according to some docs I have read, if after a deletion ( a few
&gt; seconds ) we make a .get() it force the release of the diskspace , is this
&gt; true ?
&gt;
&gt; For us it's not possible to move data to another node, is there any way
&gt; even manually to release the space ? or at least to force :
&gt; " The actual release occurs significantly later (days, weeks, or even
&gt; months later) when the tombstone record merges with the actual data in a
&gt; background compaction."
&gt;
&gt; Thanks for all the help,
&gt; Antonio
&gt;
&gt;
&gt; 2015-07-14 17:43 GMT+01:00 Matthew Von-Maszewski :
&gt;
&gt;&gt; Antonio,
&gt;&gt;
&gt;&gt; Here is a detailed discussion of the Riak / leveldb delete scenario:
&gt;&gt;
&gt;&gt; https://github.com/basho/leveldb/wiki/mv-aggressive-delete
&gt;&gt;
&gt;&gt; Pay close attention to the section titled “Update April 6, 2014”. This
&gt;&gt; explains why as much as 4.2G bytes per vnode might remain within leveldb
&gt;&gt; after deleting all keys. There is no mechanism to override the logic that
&gt;&gt; causes the disk space retention.
&gt;&gt;
&gt;&gt; One workaround is to use Riak’s handoff mechanism to transfer vnodes from
&gt;&gt; one physical server to another. The vnode transfer will remove all
&gt;&gt; deletion tombstones on the destination. The last step of the transfer then
&gt;&gt; deletes all leveldb files on the original server, recovering the space.
&gt;&gt;
&gt;&gt; Matthew
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; &gt; On Jul 14, 2015, at 12:32 PM, Antonio Teixeira 
&gt;&gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Hello,
&gt;&gt; &gt;
&gt;&gt; &gt; We have been migrating our Riak Database to another infrastructure
&gt;&gt; through a "streaming" process and right now we should have somewhere around
&gt;&gt; 2Gb of free space the Hard Disk, however those 2Gb are still being used by
&gt;&gt; Riak. After some research I believe the problem is the Objects are only
&gt;&gt; being marked for deletion and not actually deleted at runtime. What we need
&gt;&gt; is a way to aggressively deleted those keys or some way to force Riak to
&gt;&gt; delete those marked keys and subsequently release the Disk Space. The Riak
&gt;&gt; version we are using is v2.0.2
&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

