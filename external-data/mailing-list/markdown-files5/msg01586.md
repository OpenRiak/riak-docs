---
title: "Re: java driver : lisKeys() returned also deleted keys"
description: ""
project: community
lastmod: 2010-11-20T12:08:25-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01586"
mailinglist_parent_id: "msg01585"
author_name: "Andrea Campolonghi"
project_section: "mailinglistitem"
sent_date: 2010-11-20T12:08:25-08:00
---


Andy,

great to know.
So you know is there a way to get if this marker?

Andrea

2010/11/20 Andy Gross 

&gt;
&gt; Hi Andrea,
&gt;
&gt; Key deletion in Riak doesn't occur immediately in Riak - keys are first
&gt; marked with a tombstone marker and then reaped asynchronously. If you
&gt; insert a sleep between the delete() and keys() calls (try a few seconds) -
&gt; does the test pass?
&gt;
&gt; - Andy
&gt;
&gt;
&gt; On Sat, Nov 20, 2010 at 10:02 AM, Andrea Campolonghi &lt;
&gt; acampolon...@gmail.com&gt; wrote:
&gt;
&gt;&gt; I am having this issues with the java driver :
&gt;&gt; https://github.com/krestenkrab/riak-java-pb-client
&gt;&gt;
&gt;&gt; After deleting a key the listKeys method still return it.
&gt;&gt; The following test case put and delete one simple key and fails when
&gt;&gt; counting the listKeys item.
&gt;&gt;
&gt;&gt; Any Suggestion?
&gt;&gt;
&gt;&gt; public class RiakCacheTest extends TestCase {
&gt;&gt;
&gt;&gt; private RiakClient rc;
&gt;&gt;
&gt;&gt; private String host = "172.16.194.134";
&gt;&gt;
&gt;&gt; private int port = 8087;
&gt;&gt;
&gt;&gt; private String bucket = "bucket";
&gt;&gt;
&gt;&gt; @Override
&gt;&gt;
&gt;&gt; protected void setUp() throws Exception {
&gt;&gt;
&gt;&gt; rc = new RiakClient(this.host,this.port);
&gt;&gt;
&gt;&gt; rc.setClientID(this.getClass().toString());
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; public void testRemove(){
&gt;&gt;
&gt;&gt; String key = "key";
&gt;&gt;
&gt;&gt; String value = "Andrea";
&gt;&gt;
&gt;&gt; RiakObject obj = new RiakObject(this.bucket, key, value);
&gt;&gt;
&gt;&gt; try{
&gt;&gt;
&gt;&gt; this.rc.store(obj);
&gt;&gt;
&gt;&gt; assertTrue(getValue(key).equals(value));
&gt;&gt;
&gt;&gt; assertEquals(keys().size(),1);
&gt;&gt;
&gt;&gt; this.rc.delete(this.bucket, key);
&gt;&gt;
&gt;&gt; assertNull(getValue(key));
&gt;&gt;
&gt;&gt; assertEquals(keys().size(),0);
&gt;&gt;
&gt;&gt; }catch(IOException e){
&gt;&gt;
&gt;&gt; e.printStackTrace();
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; private String getValue(String key){
&gt;&gt;
&gt;&gt; String fetched = "";
&gt;&gt;
&gt;&gt; try{
&gt;&gt;
&gt;&gt; RiakObject[] ros = this.rc.fetch(this.bucket, key);
&gt;&gt;
&gt;&gt; for(RiakObject ro : ros){
&gt;&gt;
&gt;&gt; return ro.getValue().toStringUtf8();
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; }catch(IOException e){
&gt;&gt;
&gt;&gt; e.printStackTrace();
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; return null;
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt;
&gt;&gt; private List keys() {
&gt;&gt;
&gt;&gt; ArrayList result = new ArrayList();
&gt;&gt;
&gt;&gt; ByteString bucket = ByteString.copyFromUtf8(this.bucket);
&gt;&gt;
&gt;&gt; try{
&gt;&gt;
&gt;&gt; KeySource keys = this.rc.listKeys(bucket);
&gt;&gt;
&gt;&gt; while(keys.hasNext()){
&gt;&gt;
&gt;&gt; String key = keys.next().toStringUtf8();
&gt;&gt;
&gt;&gt; result.add(key);
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; }catch(IOException e){
&gt;&gt;
&gt;&gt; e.printStackTrace();
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; return result;
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt;
&gt;&gt; }
&gt;&gt;
&gt;&gt; --
&gt;&gt; Andrea Campolonghi
&gt;&gt;
&gt;&gt; Cell : +39 347 2298435
&gt;&gt; acampolon...@gmail.com
&gt;&gt; and...@andreacfm.com
&gt;&gt; http://www.andreacfm.com
&gt;&gt;
&gt;&gt; Railo Team
&gt;&gt; and...@getrailo.org
&gt;&gt; http://getrailo.org
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt;


-- 
Andrea Campolonghi

Cell : +39 347 2298435
acampolon...@gmail.com
and...@andreacfm.com
http://www.andreacfm.com

Railo Team
and...@getrailo.org
http://getrailo.org
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

