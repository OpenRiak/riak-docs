---
title: "Re: Riak HTTPS listener hangs"
description: ""
project: community
lastmod: 2014-04-21T09:27:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14117"
mailinglist_parent_id: "msg14114"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2014-04-21T09:27:15-07:00
---


Hi Adam,

If possible, could you please mail me directly your app.config,
vm.args and archive of log files (/var/log/riak) from one node, and
HAProxy configuration?

Have you tried having HAProxy as the SSL endpoint and then use
unencrypted HTTP traffic between HAProxy and Riak? I believe it's
typical to use HAProxy as the HTTPS endpoint rather than proxy the SSL
connection to the back-end services. I'm wondering if there's
something about using it in this manner that is contributing to this
scenario. Just a thought.

Thanks.
--
Luke Bakken
CSE
lbak...@basho.com


On Fri, Apr 18, 2014 at 9:22 AM, Adam Leko  wrote:
&gt; We have a 5-node Riak cluster and we're having problems keeping the HTTPS
&gt; listener running properly. The problem typically manifests itself a few
&gt; hours after Riak is started. When it happens, the HTTPS listener on a Riak
&gt; node will accept new connections but will never respond to them. Connections
&gt; made via curl or OpenSSL's s\\_client show the client sending the SSL hello
&gt; but never getting a response. When this happens, the OS does show pending
&gt; data for the socket that isn't being processed (trimmed output):
&gt;
&gt; # ss -lt
&gt; State Recv-Q Send-Q Local Address:Port Peer Address:Port
&gt; LISTEN 129 128 1.2.3.4:8098 \\*:\\*
&gt;
&gt; One of the times the Erlang VM was in this state I grabbed a crash dump via
&gt; SIGUSR1. The Mochiweb process shows up in a "Waiting" state:
&gt;
&gt; =proc:&lt;0.190.0&gt;
&gt; State: Waiting
&gt; Name: 'https\\_1.2.3.4:8098\\_mochiweb'
&gt; Spawned as: proc\\_lib:init\\_p/5
&gt; Spawned by: &lt;0.150.0&gt;
&gt; Started: Thu Apr 17 21:01:12 2014
&gt; Message queue length: 0
&gt; Number of heap fragments: 0
&gt; Heap fragment data: 0
&gt; Link list: [#Port&lt;0.3873&gt;, &lt;0.4203.0&gt;, &lt;0.150.0&gt;, &lt;0.5788.48&gt;, &lt;0.12559.49&gt;,
&gt; &lt;0.4819.45&gt;, &lt;0.17031.51&gt;, &lt;0.19186.51&gt;, &lt;0.18428.51&gt;, &lt;0.25106.51&gt;,
&gt; &lt;0.20568.51&gt;, &lt;0.16399.51&gt;, &lt;0.25307.51&gt;, &lt;0.25382.51&gt;, &lt;0.31884.51&gt;,
&gt; &lt;0.30289.51&gt;, &lt;0.29247.51&gt;, &lt;0.25168.51&gt;]
&gt; Reductions: 50203
&gt; Stack+heap: 1597
&gt; OldHeap: 0
&gt; Heap unused: 495
&gt; OldHeap unused: 0
&gt; Program counter: 0x00007fb03fea4de8 (gen\\_server:loop/6 + 264)
&gt; CP: 0x0000000000000000 (invalid)
&gt; arity = 0
&gt;
&gt; All the processes linked from the main Mochiweb process are also in a
&gt; "Waiting" state. If I connect to the riak console and manually kill the
&gt; mochiweb process (via exit(pid(...), kill)), its supervisor restarts it and
&gt; the node starts servicing HTTPS requests again.
&gt;
&gt; We do have the Erlang cluster behind haproxy but the SSL connections hang
&gt; even if you try to connect locally from the machine running the RIak
&gt; service. We're using a lightly modified config from what is suggested in the
&gt; docs
&gt; (http://docs.basho.com/riak/1.3.1/cookbooks/Load-Balancing-and-Proxy-Configuration/)
&gt; with a much lower max connections setting. When the hangs happen, netstat
&gt; only shows a handful of open connections to the haproxy front end.
&gt;
&gt; It's also worth pointing out that when the hangs happen, there are no
&gt; messages that show up in the log files that indicate any errors. The rest of
&gt; the services on the Riak node don't appear to be affected as well - we still
&gt; get periodic anti-"entropy" exchange log messages and all the usual suspects
&gt; in riak-admin status check out.
&gt;
&gt; We are using a pretty standard OS configuration - Ubuntu 12.04 LTS with the
&gt; Basho apt repo, riak 1.4.8-1, erts-5.9.1 that comes bundled with the Riak
&gt; packages.
&gt;
&gt; Are there any known issues with accessing Riak over its HTTPS interface or
&gt; any known problems with erts' SSL implementation? As of now we're forced to
&gt; use periodic rolling restarts on the nodes in our production cluster to keep
&gt; the HTTPS listeners functional, which is a pretty disgusting workaround.
&gt;
&gt; Thanks for taking the time to read this. I'd appreciate any insight or
&gt; guidance on how to address/track down this problem.
&gt;
&gt; -Adam Leko
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

