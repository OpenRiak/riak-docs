---
title: "Re: adding nodes to cluster"
description: ""
project: community
lastmod: 2015-01-20T06:05:25-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15526"
mailinglist_parent_id: "msg15525"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2015-01-20T06:05:25-08:00
---


Iâ€™ll open a ticket for it. We changed the internal structure of both Maps and 
Sets, and tested that they were backwards compatible, but clearly missed 
something.

On 20 Jan 2015, at 13:54, Alexander Popov  wrote:

&gt; Upgraded riak 2.0.2-&gt; 2.0.4
&gt; trying to add nodes to cluster( was single node ) 
&gt; all new nodes located on another host, but multi-nodes installation from 
&gt; source
&gt; each new node have config settings tuned like 
&gt; 
&gt; nodename = riak1@10.0.0.28
&gt; platform\\_data\\_dir = /var/lib/riak1
&gt; listener.http.internal = 0.0.0.0:18098
&gt; listener.protobuf.internal = 0.0.0.0:18087
&gt; handoff.port = 18099
&gt; search.solr.port = 18093
&gt; search.solr.jmx\\_port = 18985
&gt; search=on
&gt; 
&gt; after adding this nodes to cluster for long time was nothing was transferred 
&gt; for new nodes.
&gt; I was down this nodes and force-remove it from cluster.
&gt; 
&gt; After this strange things happens.
&gt; On new nodes:
&gt; Even after restart cleaning entire data dir and start again, in folder yz 
&gt; indexes somehow appears again. 
&gt; 
&gt; logs contains only 
&gt; 2015-01-20 13:15:04.815 [info] &lt;0.352.0&gt;@riak\\_core:wait\\_for\\_service:483 Wait 
&gt; complete for service riak\\_kv (10 seconds)
&gt; 2015-01-20 13:15:06.660 [info] &lt;0.547.0&gt;@yz\\_index:local\\_create:189 Created 
&gt; index contacts\\_index with schema contacts
&gt; 2015-01-20 13:15:08.683 [info] &lt;0.547.0&gt;@yz\\_index:local\\_create:189 Created 
&gt; index users\\_index with schema users
&gt; 
&gt; 
&gt; Main Node now have bunch of errors on start and periodically after:
&gt; 
&gt; 015-01-20 13:29:00.382 [error] &lt;0.871.0&gt;@riak\\_core\\_vnode:vnode\\_command:348 
&gt; riak\\_kv\\_vnode command failed 
&gt; {{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_map,'-filter\\_unique/4-fun-1-',4,[{file,"src/ria
&gt; k\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_dt\\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{l
&gt; ine,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"orddict.erl"},{line,170}]}]}
&gt; 2015-01-20 13:29:00.382 [error] &lt;0.650.0&gt;@riak\\_core\\_vnode:vnode\\_command:348 
&gt; riak\\_kv\\_vnode command failed 
&gt; {{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_map,'-filter\\_unique/4-fun-1-',4,[{file,"src/ria
&gt; k\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_dt\\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{l
&gt; ine,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"orddict.erl"},{line,170}]}]}
&gt; 2015-01-20 13:29:00.383 [error] &lt;0.4520.0&gt; gen\\_fsm &lt;0.4520.0&gt; in state 
&gt; waiting\\_local\\_vnode terminated with reason: no case clause matching 
&gt; {vnode\\_error,{{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_
&gt; map,'-filter\\_unique/4-fun-1-',4,[{file,"src/riak\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_
&gt; dt\\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{line,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
&gt; in riak\\_kv\\_put\\_fsm:waiting\\_local\\_vnode/2 line 5
&gt; 67
&gt; 2015-01-20 13:29:00.384 [error] &lt;0.4520.0&gt; CRASH REPORT Process &lt;0.4520.0&gt; 
&gt; with 0 neighbours exited with reason: no case clause matching 
&gt; {vnode\\_error,{{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_ma
&gt; p,'-filter\\_unique/4-fun-1-',4,[{file,"src/riak\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_dt
&gt; \\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{line,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
&gt; in riak\\_kv\\_put\\_fsm:waiting\\_local\\_vnode/2 line 567
&gt; in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.384 [error] &lt;0.4521.0&gt; gen\\_fsm &lt;0.4521.0&gt; in state 
&gt; waiting\\_local\\_vnode terminated with reason: no case clause matching 
&gt; {vnode\\_error,{{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_
&gt; map,'-filter\\_unique/4-fun-1-',4,[{file,"src/riak\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_
&gt; dt\\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{line,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
&gt; in riak\\_kv\\_put\\_fsm:waiting\\_local\\_vnode/2 line 5
&gt; 67
&gt; 2015-01-20 13:29:00.384 [error] &lt;0.4521.0&gt; CRASH REPORT Process &lt;0.4521.0&gt; 
&gt; with 0 neighbours exited with reason: no case clause matching 
&gt; {vnode\\_error,{{badrecord,dict},[{dict,filter\\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\\_dt\\_ma
&gt; p,'-filter\\_unique/4-fun-1-',4,[{file,"src/riak\\_dt\\_map.erl"},{line,466}]},{sets,fold\\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\\_dt
&gt; \\_map,merge,2,[{file,"src/riak\\_dt\\_map.erl"},{line,454}]},{riak\\_kv\\_crdt,'-merge\\_value/2-fun-0-',5,[{file,"src/riak\\_kv\\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
&gt; in riak\\_kv\\_put\\_fsm:waiting\\_local\\_vnode/2 line 567
&gt; in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.871.0&gt; gen\\_fsm &lt;0.871.0&gt; in state active 
&gt; terminated with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.871.0&gt; CRASH REPORT Process &lt;0.871.0&gt; with 
&gt; 1 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.167.0&gt; Supervisor riak\\_core\\_vnode\\_sup had 
&gt; child undefined started with {riak\\_core\\_vnode,start\\_link,undefined} at 
&gt; &lt;0.871.0&gt; exit with reason bad record dict in dict:filter\\_dict/2 line 464 in 
&gt; context
&gt; child\\_terminated
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.988.0&gt; gen\\_fsm &lt;0.988.0&gt; in state ready 
&gt; terminated with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.988.0&gt; CRASH REPORT Process &lt;0.988.0&gt; with 
&gt; 10 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.385 [error] &lt;0.650.0&gt; gen\\_fsm &lt;0.650.0&gt; in state active 
&gt; terminated with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.650.0&gt; CRASH REPORT Process &lt;0.650.0&gt; with 
&gt; 1 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.989.0&gt; Supervisor {&lt;0.989.0&gt;,poolboy\\_sup} 
&gt; had child riak\\_core\\_vnode\\_worker started with 
&gt; riak\\_core\\_vnode\\_worker:start\\_link([{worker\\_module,riak\\_core\\_vnode\\_worker},{worker\\_args,[593735040165679310520
&gt; 246963290989976735222595584,...]},...]) at undefined exit with reason bad 
&gt; record dict in dict:filter\\_dict/2 line 464 in context shutdown\\_error
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.989.0&gt; gen\\_server &lt;0.989.0&gt; terminated 
&gt; with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.989.0&gt; CRASH REPORT Process &lt;0.989.0&gt; with 
&gt; 0 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_server:terminate/6 line 744
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.167.0&gt; Supervisor riak\\_core\\_vnode\\_sup had 
&gt; child undefined started with {riak\\_core\\_vnode,start\\_link,undefined} at 
&gt; &lt;0.650.0&gt; exit with reason bad record dict in dict:filter\\_dict/2 line 464 in 
&gt; context
&gt; child\\_terminated
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.696.0&gt; gen\\_fsm &lt;0.696.0&gt; in state ready 
&gt; terminated with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.696.0&gt; CRASH REPORT Process &lt;0.696.0&gt; with 
&gt; 10 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_fsm:terminate/7 line 622
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.702.0&gt; Supervisor {&lt;0.702.0&gt;,poolboy\\_sup} 
&gt; had child riak\\_core\\_vnode\\_worker started with 
&gt; riak\\_core\\_vnode\\_worker:start\\_link([{worker\\_module,riak\\_core\\_vnode\\_worker},{worker\\_args,[228359630832953580969
&gt; 325755111919221821239459840,...]},...]) at undefined exit with reason bad 
&gt; record dict in dict:filter\\_dict/2 line 464 in context shutdown\\_error
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.702.0&gt; gen\\_server &lt;0.702.0&gt; terminated 
&gt; with reason: bad record dict in dict:filter\\_dict/2 line 464
&gt; 2015-01-20 13:29:00.386 [error] &lt;0.702.0&gt; CRASH REPORT Process &lt;0.702.0&gt; with 
&gt; 0 neighbours exited with reason: bad record dict in dict:filter\\_dict/2 line 
&gt; 464 in gen\\_server:terminate/6 line 744
&gt; 
&gt; 
&gt; 
&gt; any advice?
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

