---
title: "Re: Riak Search Map Reduce error"
description: ""
project: community
lastmod: 2013-11-21T11:09:30-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13053"
mailinglist_parent_id: "msg13034"
author_name: "Roger Diller"
project_section: "mailinglistitem"
sent_date: 2013-11-21T11:09:30-08:00
---


Ok, I'm not exactly sure what will be most helpful to you, but I am
attaching an example of a Key/Value.

What you see in the file, we would have thousands of those. Probably would
get to at least a million or so KV's like that.

The bucket is search enabled, so all those JSON fields are going to be
indexed.

However, we are primarily search filtering on the systemId, indexId, &
fullText fields in the value.

We currently have a 6 node cluster with each server having approx 16 cores
& in most cases at least 10 GB (20 GB free on most servers probably) free
memory with all the process running (including Riak). Computing power
should not be an issue period!

Let me know what use that would be useful to provide.



On Wed, Nov 20, 2013 at 12:46 PM, Todd Tyree  wrote:

&gt; Hi Roger,
&gt;
&gt; Sorry, meant to reply to the mailing list, but accidentally replied
&gt; directly to you.
&gt;
&gt; Before I can say whether or not secondary indexes are suitable, I need to
&gt; know more about your data, access patterns and query patterns.
&gt;
&gt; Can you share this information with me here? What kind of data is being
&gt; searched and how frequently is it updated?
&gt;
&gt; Best,
&gt; Todd
&gt;
&gt;
&gt; On Wed, Nov 20, 2013 at 5:05 PM, Roger Diller &lt;
&gt; ro...@flexrentalsolutions.com&gt; wrote:
&gt;
&gt;&gt; Do you have any other suggestions on how we can find data in real time
&gt;&gt; from a bucket (without moving to 2.0)? What about secondary indexes?
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Nov 20, 2013 at 11:59 AM, Todd Tyree  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Roger,
&gt;&gt;&gt;
&gt;&gt;&gt; You are essentially correct in that map reduce was never designed as a
&gt;&gt;&gt; realtime query tool.
&gt;&gt;&gt;
&gt;&gt;&gt; However, we do have a solution in a technology preview release stage
&gt;&gt;&gt; that may solve this problem for you: Yokozuna [0]. It is a tight
&gt;&gt;&gt; integration of Riak and Solr and brings the best of both technologies
&gt;&gt;&gt; together.
&gt;&gt;&gt;
&gt;&gt;&gt; It is currently scheduled for release as part of Riak 2.0, but you can
&gt;&gt;&gt; clone the repo and build it now if you would like. Just be aware it is
&gt;&gt;&gt; still undergoing development and the API may be subject to change before
&gt;&gt;&gt; the final release.
&gt;&gt;&gt;
&gt;&gt;&gt; [0] https://github.com/basho/yokozuna
&gt;&gt;&gt;
&gt;&gt;&gt; Best,
&gt;&gt;&gt; Todd
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt; On Wed, Nov 20, 2013 at 4:45 PM, Roger Diller &lt;
&gt; ro...@flexrentalsolutions.com&gt; wrote:
&gt;
&gt;&gt; I could dig up all our nitty gritty Riak details but I don't think that
&gt;&gt; will help really.
&gt;&gt;
&gt;&gt; The point I think is this: Using search map reduce is not a viable way to
&gt;&gt; do real time search queries. Especially ones that may have 2000+ plus
&gt;&gt; results each. Couple that with search requests coming in every few seconds
&gt;&gt; from 300+ customer app instances and you literally bring Riak to it's
&gt;&gt; knees.
&gt;&gt;
&gt;&gt; Not that Riak is the problem really, it's just we are using it in a way
&gt;&gt; it was not designed for. In essence, we are using Riak as a search engine
&gt;&gt; for our application data. Correct me if I'm wrong but Riak is more for
&gt;&gt; storing large amounts of KV data, but not really for finding that data in a
&gt;&gt; search sense.
&gt;&gt;
&gt;&gt; Am I missing something here? Is there a viable way for doing real time
&gt;&gt; search queries on a bucket with 1 million keys?
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, Nov 18, 2013 at 5:29 PM, Alexander Sicular wrote:
&gt;&gt;
&gt;&gt;&gt; More info please...
&gt;&gt;&gt;
&gt;&gt;&gt; Version
&gt;&gt;&gt; Current config
&gt;&gt;&gt; Hardware
&gt;&gt;&gt; Data size
&gt;&gt;&gt; Search Schema
&gt;&gt;&gt; Etc.
&gt;&gt;&gt;
&gt;&gt;&gt; But I would probably say that your search is returning too many keys to
&gt;&gt;&gt; your mr. More inline.
&gt;&gt;&gt;
&gt;&gt;&gt; @siculars
&gt;&gt;&gt; http://siculars.posthaven.com
&gt;&gt;&gt;
&gt;&gt;&gt; Sent from my iRotaryPhone
&gt;&gt;&gt;
&gt;&gt;&gt; On Nov 18, 2013, at 13:59, Roger Diller 
&gt;&gt;&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Using the Riak Java client, I am executing a search map reduce like this:
&gt;&gt;&gt;
&gt;&gt;&gt; MapReduceResult result = riakClient.mapReduce(SEARCH\\_BUCKET,
&gt;&gt;&gt; search).execute();
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; ^is this part a typo. Cause otherwise it looks like you do a s&gt;mr, set
&gt;&gt;&gt; the search and then another s&gt;mr.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; String search = "systemId:" + systemName + " AND indexId:" + indexId;
&gt;&gt;&gt;
&gt;&gt;&gt; MapReduceResult result = riakClient.mapReduce(SEARCH\\_BUCKET,
&gt;&gt;&gt; search).execute();
&gt;&gt;&gt;
&gt;&gt;&gt; This worked fine when the bucket contained a few thousand keys. Now that
&gt;&gt;&gt; we have far more data stored in the bucket (at least 250K keys), it's
&gt;&gt;&gt; throwing this generic error:
&gt;&gt;&gt;
&gt;&gt;&gt; com.basho.riak.client.RiakException: java.io.IOException:
&gt;&gt;&gt; {"error":"map\\_reduce\\_error"}
&gt;&gt;&gt;
&gt;&gt;&gt; We've also noticed that storing new key/values in the bucket has slowed
&gt;&gt;&gt; WAY down.
&gt;&gt;&gt;
&gt;&gt;&gt; Any idea what's going on?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Your data set is incorrectly sized to your production config.
&gt;&gt;&gt;
&gt;&gt;&gt; Are there limitations to Search Map Reduce?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Certainly
&gt;&gt;&gt;
&gt;&gt;&gt; Are there configuration options that need changed?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Possibly
&gt;&gt;&gt;
&gt;&gt;&gt; Any help would be greatly appreciated.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Roger Diller
&gt;&gt;&gt; Flex Rental Solutions, LLC
&gt;&gt;&gt; Email: ro...@flexrentalsolutions.com
&gt;&gt;&gt; Skype: rogerdiller
&gt;&gt;&gt; Time Zone: Eastern Time
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Roger Diller
&gt;&gt; Flex Rental Solutions, LLC
&gt;&gt; Email: ro...@flexrentalsolutions.com
&gt;&gt; Skype: rogerdiller
&gt;&gt; Time Zone: Eastern Time
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; \\*Todd Tyree\\*
&gt; Client Services Engineer Basho 
&gt;
&gt; mobile: +44(0)7861 220 182
&gt; web: www.basho.com
&gt; github: tatyree 
&gt;



-- 
Roger Diller
Flex Rental Solutions, LLC
Email: ro...@flexrentalsolutions.com
Skype: rogerdiller
Time Zone: Eastern Time
Key: 
qamaster:23e51460-519b-11df-81b5-1231390c71d1:04741560-0754-11e2-bed8-00e08175e43e

Value:

'{"systemId":"qamaster","indexId":"23e51460-519b-11df-81b5-1231390c71d1","documentId":"04741560-0754-11e2-bed8-00e08175e43e","deleted":"false","closed":"false","fieldMap":{"element.parentElement.name":{"fieldId":"element.parentElement.name","fieldValue":"Subrental
 
1","fieldType":"STRING"},"elementName":{"fieldId":"elementName","fieldValue":"Subrental
 
1","fieldType":"STRING"},"element.resolvedStartDate.SHORT\\_DATE":{"fieldId":"element.resolvedStartDate.SHORT\\_DATE","fieldValue":"7/16/2012","fieldType":"STRING"},"element.name":{"fieldId":"element.name","fieldValue":"Subrental
 
1","fieldType":"STRING"},"element.client.company":{"fieldId":"element.client.company","fieldValue":"","fieldType":"STRING"},"parentCaption":{"fieldId":"parentCaption","fieldValue":"Subrental
 1 
(ABWR0)","fieldType":"STRING"},"locationId":{"fieldId":"locationId","fieldValue":"9cd7a7c6-1648-102d-9c2d-00e081c0bae2","fieldType":"STRING"},"element.status.name":{"fieldId":"element.status.name","fieldValue":"Shelved","fieldType":"STRING"},"plannedStartDate":{"fieldId":"plannedStartDate","fieldValue":1342483260000,"fieldType":"DATE"},"pickupLocationId":{"fieldId":"pickupLocationId","fieldValue":"9cd7a7c6-1648-102d-9c2d-00e081c0bae2","fieldType":"STRING"},"deleted":{"fieldId":"deleted","fieldValue":"false","fieldType":"STRING"},"definitionName":{"fieldId":"definitionName","fieldValue":"Manifest","fieldType":"STRING"},"element.resolvedEndDate.SHORT\\_DATE":{"fieldId":"element.resolvedEndDate.SHORT\\_DATE","fieldValue":"7/17/2012","fieldType":"STRING"},"pickupLocation":{"fieldId":"pickupLocation","fieldValue":"Flex
 - 
Utah","fieldType":"STRING"},"element.client.associatedUser.name":{"fieldId":"element.client.associatedUser.name","fieldValue":"","fieldType":"STRING"},"personResponsibleId":{"fieldId":"personResponsibleId","fieldValue":"67c4e24a-c7c5-11e0-be4c-1231390c71d1","fieldType":"STRING"},"plannedEndDate":{"fieldId":"plannedEndDate","fieldValue":1342546200000,"fieldType":"DATE"},"locationString":{"fieldId":"locationString","fieldValue":"Flex
 - 
Utah","fieldType":"STRING"},"closed":{"fieldId":"closed","fieldValue":"false","fieldType":"STRING"},"element.documentNumber":{"fieldId":"element.documentNumber","fieldValue":"ABWR0","fieldType":"STRING"},"displayCaption":{"fieldId":"displayCaption","fieldValue":"Subrental
 1 
(ABWR0)","fieldType":"STRING"},"definitionId":{"fieldId":"definitionId","fieldValue":"23e51460-519b-11df-81b5-1231390c71d1","fieldType":"STRING"}},"fullText":"subrental
 1 subrental 1 7/16/2012 subrental 1 subrental 1 (abwr0) 
9cd7a7c6-1648-102d-9c2d-00e081c0bae2 shelved 
9cd7a7c6-1648-102d-9c2d-00e081c0bae2 false manifest 7/17/2012 flex - utah 
67c4e24a-c7c5-11e0-be4c-1231390c71d1 flex - utah false abwr0 subrental 1 
(abwr0) 23e51460-519b-11df-81b5-1231390c71d1 "}'
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

