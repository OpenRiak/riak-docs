---
title: "Re: Precommit hook function - no error log - how to debug?"
description: ""
project: community
lastmod: 2016-05-16T10:44:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17376"
mailinglist_parent_id: "msg17373"
author_name: "Sanket Agrawal"
project_section: "mailinglistitem"
sent_date: 2016-05-16T10:44:00-07:00
---


Luke, just tested and confirmed that precommit hooks are still not
triggered for normal buckets. Objects get written but precommit hooks don't
trigger. Manually simulating a trigger by executing the function on riak
console works fine.

Since sasl log is not being written despite being turned on, isn't that a
sign that something is wrong with precommit/postcommit setup? This is what
Douglar Rohrer said earlier in the thread:

&gt; Huh - I get a huge amount of logging when I turn on sasl using
&gt; advanced.config - specifically, I have:
&gt; {sasl,[{sasl\\_error\\_logger,{file, "/tmp/sasl-1.log"}}]}
&gt; in my advanced.config, and for just a startup/shutdown cycle I get
&gt; a 191555 byte file.


On Mon, May 16, 2016 at 11:29 AM, Luke Bakken  wrote:

&gt; Sanket,
&gt;
&gt; I can't speak to the output of cluster-info with regard to the precomit
&gt; hook.
&gt;
&gt; If you save an object to the "test\\_kv" bucket, does
&gt; rtriggers:pre\\_all() get called?
&gt;
&gt; I have confirmed that precommit hooks are \\*NOT\\* triggered for buckets
&gt; where "write\\_once" is true, and filed the following docs issue:
&gt; https://github.com/basho/basho\\_docs/issues/2076
&gt;
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Mon, May 16, 2016 at 8:20 AM, Sanket Agrawal
&gt;  wrote:
&gt; &gt; Shouldn't precommit body show up in cluster-info first before we try to
&gt; test
&gt; &gt; it with an object? I just set the precommit hook for test\\_kv bucket type
&gt; &gt; which has no custom property set. Curl on props shows precommit, but
&gt; &gt; cluster-info doesn't (took another dump after 5 minutes of precommit hook
&gt; &gt; creation). No sasl logging is triggered either though the debug mode is
&gt; on.
&gt; &gt;
&gt; &gt; Curl output for test\\_kv props:
&gt; &gt;
&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; $ curl localhost:8098/types/test\\_kv/props
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; {"props":{"active":true,"allow\\_mult":true,"basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"claimant":"
&gt; riak1@127.0.0.1
&gt; ","dvv\\_enabled":true,"dw":"quorum","last\\_write\\_wins":false,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":3,"notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"rtriggers","fun":"pre\\_all"}],"pw":0,"r":"quorum","rw":"quorum","small\\_vclock":50,"w":"quorum","young\\_vclock":20}}
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; Cluster-info dump after setting the props - precommit body is still
&gt; empty in
&gt; &gt; the cluster-info for test\\_kv bucket type:
&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; grep -A15 test\\_kv cluster\\_info.txt |grep precommit
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;&gt; {precommit,[]},
&gt; &gt;
&gt; &gt;
&gt; &gt; On Mon, May 16, 2016 at 10:48 AM, Luke Bakken  wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; Hi Sanket,
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks for providing that information, this is the first time that the
&gt; &gt;&gt; "write\\_once" bucket type property was mentioned.
&gt; &gt;&gt;
&gt; &gt;&gt; If you set the precommit hook on a different bucket type where there
&gt; &gt;&gt; are \\*no other\\* custom bucket type properties set, does the precommit
&gt; &gt;&gt; hook run successfully?
&gt; &gt;&gt;
&gt; &gt;&gt; --
&gt; &gt;&gt; Luke Bakken
&gt; &gt;&gt; Engineer
&gt; &gt;&gt; lbak...@basho.com
&gt; &gt;&gt;
&gt; &gt;&gt; On Mon, May 16, 2016 at 7:17 AM, Sanket Agrawal
&gt; &gt;&gt;  wrote:
&gt; &gt;&gt; &gt; Hi Luke,
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; More on the precommit hook debugging I just did - I might have a
&gt; handle
&gt; &gt;&gt; &gt; on
&gt; &gt;&gt; &gt; what the problem is. I took a cluster-info dump for all the nodes in
&gt; the
&gt; &gt;&gt; &gt; cluster. In the dump, precommit is set to [] for all the buckets in
&gt; the
&gt; &gt;&gt; &gt; cluster. The reason for that seems to be that the bucket type with
&gt; &gt;&gt; &gt; "write-once" property where precommit hook is set, is not in the
&gt; cluster
&gt; &gt;&gt; &gt; somehow!
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; The bucket type name is "test\\_kv\\_wo". Let us grep for it in
&gt; &gt;&gt; &gt; cluster\\_info.txt
&gt; &gt;&gt; &gt; - it doesn't show up at all (another bucket type "test\\_kv" shows up
&gt; &gt;&gt; &gt; instead):
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; $ grep test\\_kv cluster\\_info.txt | sort -u
&gt; &gt;&gt; &gt;&gt; [[{bucket,&lt;&lt;"test\\_kv"&gt;&gt;}|
&gt; &gt;&gt; &gt;&gt; {name,&lt;&lt;"test\\_kv"&gt;&gt;},
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; Now, let us verify we can get the props for the bucket type fine from
&gt; &gt;&gt; &gt; curl:
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; $ curl localhost:8098/types/test\\_kv\\_wo/buckets/uuid\\_log/props:
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;
&gt; {"props":{"name":"uuid\\_log","active":true,"allow\\_mult":true,"basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"claimant":"
&gt; riak1@127.0.0.1
&gt; ","dvv\\_enabled":true,"dw":"quorum","last\\_write\\_wins":false,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":3,"name":"uuid\\_log","notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"rtriggers","fun":"pre\\_uuid"}],"pw":0,"r":"quorum","rw":"quorum","small\\_vclock":50,"w":"quorum","write\\_once":true,"young\\_vclock":20}}
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; So, the problem might be missing bucket types in the cluster since
&gt; they
&gt; &gt;&gt; &gt; don't show up in cluster-info at all? The same thing happens with LWW
&gt; &gt;&gt; &gt; bucket
&gt; &gt;&gt; &gt; type that I created, test\\_kv\\_lww. It doesn't show up either. CRDT
&gt; bucket
&gt; &gt;&gt; &gt; types show up fine.
&gt; &gt;
&gt; &gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

