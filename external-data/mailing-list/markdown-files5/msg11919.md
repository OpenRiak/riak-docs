---
title: "Re: riak core dumped, merge_index corruption?"
description: ""
project: community
lastmod: 2013-08-06T13:50:18-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11919"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2013-08-06T13:50:18-07:00
---


Deyan,

What Riak version are you running? There was a corruption issue discovered
and fixed in the 1.4.0 release.

https://github.com/basho/riak/blob/riak-1.4.0/RELEASE-NOTES.md#issues--prs-resolved
https://github.com/basho/merge\\_index/pull/30

As for fixing, you'll want to delete the buffer files for the partitions
which are having issues. E.g. if you look in crash.log you'll see
partition numbers for the crashing vnodes.

&gt; \\*\\* Data ==
{state,685078892498860742907977265335757665463718379520,riak\\_search\\_vnode,undefined,undefined,none,undefined,undefined,undefined,undefined,0}

In the
/storage/riak/merge\\_index/685078892498860742907977265335757665463718379520
you'll see buffer files. You'll want to delete those. After deleting all
these bad buffers Riak Search should start fine. You'll then want to
upgrade to 1.4.1 to avoid corruption in the future. Finally, since you
have to delete the buffers you'll have missing indexes and you'll want to
re-index your data.

Since only one of your nodes experience corruption you can use the built-in
repair functionality to re-index only data for those partitions. First
you'll want to attach to one of your nodes. Then for each partition run
the following.

&gt; riak\\_search\\_vnode:repair(P)

Make sure to run repair for only one partition at a time to avoid
overloading anything.

To determine when a repair is finished you can periodically call the
following. Once it returns 'no\\_repair' that indicates it has finished.

&gt; riak\\_search\\_vnode:repair\\_status(P)

Here is more information on the repair command.

http://docs.basho.com/riak/latest/cookbooks/Repairing-Search-Indexes/


-Z



On Tue, Aug 6, 2013 at 5:17 AM, Deyan Dyankov  wrote:

&gt; hi,
&gt;
&gt; we have a 3 node cluster and one of the node crashed yesterday.
&gt; Nodes are db1, db2 and db3. We started other services on db1 and db2 and
&gt; db1 crashed. Currently db2 and db3 are fine, balanced, receiving writes and
&gt; serving reads.
&gt; However, db1 has issues starting. When I start the node, it outputs
&gt; numerous errors and this finally results in a core dump. We use Riak search
&gt; and this may be the reason for the dump. After starting the node, these are
&gt; the first errors that are seen in the log file:
&gt;
&gt; […]
&gt; 2013-08-06 11:06:08.989 [info] &lt;0.7.0&gt; Application erlydtl started on node
&gt; 'r...@db1.locations.cxl-cdn.net'
&gt; \\*2013-08-06 11:06:16.675 [warning] &lt;0.5010.0&gt; Corrupted posting detected
&gt; in
&gt; /storage/riak/merge\\_index/456719261665907161938651510223838443642478919680/buffer.598
&gt; after reading 2281\\*
&gt; \\*49 bytes, ignoring remainder.\\*
&gt; 2013-08-06 11:06:18.922 [error] &lt;0.5310.0&gt; CRASH REPORT Process &lt;0.5310.0&gt;
&gt; with 0 neighbours exited with reason: bad argument in call to
&gt; erlang:binary\\_to\\_term(&lt;&lt;131,108,0,0,0,1,10
&gt; 4,4,104,3,109,0,0,0,25,99,120,108,101,118,101,110,116,115,95,99,97,107,101,...&gt;&gt;)
&gt; in mi\\_buffer:read\\_value/2 line 162 in gen\\_server:init\\_it/6 line 328
&gt; 2013-08-06 11:06:20.751 [error] &lt;0.5309.0&gt; gen\\_fsm &lt;0.5309.0&gt; in state
&gt; started terminated with reason: no function clause matching
&gt; riak\\_search\\_vnode:terminate({{badmatch,{error,{b
&gt; adarg,[{erlang,binary\\_to\\_term,[&lt;&lt;131,108,0,0,0,1,104,4,104,3,109,0,0,0,25,...&gt;&gt;],...},...]}}},...},
&gt; undefined) line 233
&gt; […]
&gt;
&gt; Attached is an archive of the /var/log/riak directory. The logs there are
&gt; for the latest starting attempt. Riak core dumped in a minute or two after
&gt; being started.
&gt; Is there a way to fix the merge index corruption and start the node?
&gt;
&gt; thank you for your efforts,
&gt; Deyan
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

