---
title: "Re: Riak-S2 javascript aws-sdk failing on multi-part uploads"
description: ""
project: community
lastmod: 2016-01-14T09:57:37-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16968"
mailinglist_parent_id: "msg16955"
author_name: "John Fanjoy"
project_section: "mailinglistitem"
sent_date: 2016-01-14T09:57:37-08:00
---


Hello,

I have confirmed that the failure occurs I all 3 browsers (FF, Safari, and 
Chrome) due to what appears to be the client closing the connection. I do see 
less unused connections from the other browsers, but the first part is 
successfully uploaded and then the next several part uploads are cancelled. One 
thing I do notice is that I receive the following error which I’m logging in 
the browser console:

Error: No access to ETag property on response. Check CORS configuration to 
expose ETag header. 

Looking through the source this appears to be the default error whenever there 
is no data or data.Etag so I’m not sure it means anything other than just that 
the connection was reset for some reason. I can see the response headers for 
the successfully uploaded part do include an ETag so this is being passed tot 
the client, but perhaps the quotes are problematic? The Etag header is quoted 
in smaller file uploads without issue so I don’t think that's it, but I will 
retest with AWS to see if the quotes are present in their responses.

 1. HTTP/1.1 200 OK
Server: Riak CS
ETag: "a45445a0fc1e21d38eeab671e4dde4ca"
Date: Thu, 14 Jan 2016 17:47:50 GMT
Content-Type: application/xml
Content-Length: 0
Access-Control-Allow-Origin: \\*
Access-Control-Allow-Methods: PUT, POST, DELETE, GET
Access-Control-Allow-Headers: 
DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,X-Amz-Date,X-Amz-User-Agent,Authorization,X-Amz-Acl,Content-MD5,X-Amzn-Authorization


Thanks, 

John Fanjoy
Systems Engineer
jfan...@inetu.net






On 1/14/16, 10:29 AM, "John Fanjoy"  wrote:

&gt;Shino and Luke,
&gt;
&gt;Thank you for helping me work through this. The tcplog mode in haproxy 
&gt;actually doesn’t provide enough information because it doesn’t bother with 
&gt;paths or query strings or anything http like. I am using the httplog mode as a 
&gt;result, and the odd thing is that the error logged indicated the browser is 
&gt;actually responsible for closing the connections. Usually these errors would 
&gt;be generated when a user clicks stop or navigates away from a page. Per the 
&gt;haproxy docs:
&gt;
&gt;CH The client aborted while waiting for the server to start responding.
&gt; It might be the server taking too long to respond or the client
&gt; clicking the 'Stop' button too fast.
&gt;
&gt;
&gt;Here is the log data for a request made using the aws-sdk-js library.
&gt;
&gt;```
&gt;Jan 14 09:46:59 localhost haproxy-gen1[400]: 10.100.88.52:62880 
&gt;[14/Jan/2016:09:46:58.970] www-https~ www-backend/www-1 37/0/0/12/49 200 382 - 
&gt;- ---- 1/1/0/0/0 0/0 "POST /three2016com-devopsdevel/Archive.zip?uploads 
&gt;HTTP/1.1"
&gt;Jan 14 09:46:59 localhost haproxy-gen1[400]: 10.100.88.52:62885 
&gt;[14/Jan/2016:09:46:59.918] www-https~ cors\\_opts/ 48/-1/-1/-1/48 503 399 
&gt;- - SC-- 3/3/0/0/0 0/0 "OPTIONS 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=2&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:00 localhost haproxy-gen1[400]: 10.100.88.52:62886 
&gt;[14/Jan/2016:09:46:59.945] www-https~ cors\\_opts/ 57/-1/-1/-1/57 503 399 
&gt;- - SC-- 2/2/0/0/0 0/0 "OPTIONS 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=3&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:00 localhost haproxy-gen1[400]: 10.100.88.52:62887 
&gt;[14/Jan/2016:09:46:59.960] www-https~ cors\\_opts/ 45/-1/-1/-1/45 503 399 
&gt;- - SC-- 1/1/0/0/0 0/0 "OPTIONS 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=4&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:12 localhost haproxy-gen1[400]: 10.100.88.52:62892 
&gt;[14/Jan/2016:09:47:01.369] www-https~ www-backend/www-1 28/0/0/11442/11470 200 
&gt;165 - - ---- 4/4/3/3/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=2&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1”
&gt;
&gt;Jan 14 09:47:12 localhost haproxy-gen1[400]: 10.100.88.52:62892 
&gt;[14/Jan/2016:09:47:12.840] www-https~ cors\\_opts/ 70/-1/-1/-1/70 503 399 
&gt;- - SC-- 3/3/0/0/0 0/0 "OPTIONS 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D 
&gt;HTTP/1.1”
&gt;Jan 14 09:47:13 localhost haproxy-gen1[400]: 10.100.88.52:62888 
&gt;[14/Jan/2016:09:46:59.965] www-https~ www-backend/www-1 41/0/0/-1/13182 -1 0 - 
&gt;- CH-- 2/2/2/2/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=1&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:13 localhost haproxy-gen1[400]: 10.100.88.52:62894 
&gt;[14/Jan/2016:09:47:03.601] www-https~ www-backend/www-1 63/0/0/-1/9581 -1 0 - 
&gt;- CH-- 1/1/1/1/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=3&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:13 localhost haproxy-gen1[400]: 10.100.88.52:62897 
&gt;[14/Jan/2016:09:47:04.981] www-https~ www-backend/www-1 118/0/0/-1/8268 -1 0 - 
&gt;- CH-- 1/1/0/0/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?partNumber=4&uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D
&gt; HTTP/1.1"
&gt;Jan 14 09:47:13 localhost haproxy-gen1[400]: 10.100.88.52:62899 
&gt;[14/Jan/2016:09:47:13.429] www-https~ www-backend/www-1 40/0/0/22/62 204 126 - 
&gt;- ---- 1/1/0/0/0 0/0 "DELETE 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=xlC0aPjOQ96Mkn8asY62cw%3D%3D 
&gt;HTTP/1.1”
&gt;
&gt;```
&gt;
&gt;The SC errors are expected on the OPTIONS requests as I have a separate 
&gt;backend without any servers handling the preflights which I don’t think 
&gt;riak-cs will do (if it will please enlighten me and I will update my config). 
&gt;The client is actually receiving a 200 response with the CORS headers for 
&gt;OPTIONS requests. There also appear to be a number of BADREQ errors in the 
&gt;log, but these appear to be connections that that the browser initiated and 
&gt;then never used. No HTTP requests are actually being made in those requests 
&gt;and I don’t appear to be missing anything above (OPTIONS + PUT). As mentioned, 
&gt;the first PUT request is successful, but subsequent requests appear to fail, 
&gt;or more accurately appear to be closed by the client. When I use cyberduck for 
&gt;the same file I see the following log entries:
&gt;
&gt;```
&gt;Jan 14 10:01:36 localhost haproxy-gen1[400]: 10.100.88.52:63105 
&gt;[14/Jan/2016:10:01:36.063] www-https~ www-backend/www-1 59/0/0/14/73 200 382 - 
&gt;- ---- 1/1/0/0/0 0/0 "POST /three2016com-devopsdevel/Archive.zip?uploads 
&gt;HTTP/1.1"
&gt;Jan 14 10:02:48 localhost haproxy-gen1[400]: 10.100.88.52:63105 
&gt;[14/Jan/2016:10:01:36.136] www-https~ www-backend/www-1 70/0/1/72138/72209 200 
&gt;190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=3
&gt; HTTP/1.1"
&gt;Jan 14 10:02:53 localhost haproxy-gen1[400]: 10.100.88.52:63119 
&gt;[14/Jan/2016:10:01:36.266] www-https~ www-backend/www-1 136/0/1/76606/76743 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=1
&gt; HTTP/1.1"
&gt;Jan 14 10:02:56 localhost haproxy-gen1[400]: 10.100.88.52:63117 
&gt;[14/Jan/2016:10:01:36.266] www-https~ www-backend/www-1 90/0/1/79916/80007 200 
&gt;190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=10
&gt; HTTP/1.1"
&gt;Jan 14 10:02:57 localhost haproxy-gen1[400]: 10.100.88.52:63116 
&gt;[14/Jan/2016:10:01:36.265] www-https~ www-backend/www-1 100/0/1/81618/81719 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=9
&gt; HTTP/1.1"
&gt;Jan 14 10:03:23 localhost haproxy-gen1[400]: 10.100.88.52:63118 
&gt;[14/Jan/2016:10:01:36.266] www-https~ www-backend/www-1 130/0/0/107459/107589 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=2
&gt; HTTP/1.1"
&gt;Jan 14 10:03:28 localhost haproxy-gen1[400]: 10.100.88.52:63115 
&gt;[14/Jan/2016:10:01:36.265] www-https~ www-backend/www-1 137/0/0/111934/112071 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=8
&gt; HTTP/1.1"
&gt;Jan 14 10:03:52 localhost haproxy-gen1[400]: 10.100.88.52:63113 
&gt;[14/Jan/2016:10:01:36.245] www-https~ www-backend/www-1 112/0/0/136606/136718 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=5
&gt; HTTP/1.1"
&gt;Jan 14 10:04:05 localhost haproxy-gen1[400]: 10.100.88.52:63105 
&gt;[14/Jan/2016:10:02:48.346] www-https~ www-backend/www-1 121/0/1/76853/76975 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=11
&gt; HTTP/1.1"
&gt;Jan 14 10:04:05 localhost haproxy-gen1[400]: 10.100.88.52:63120 
&gt;[14/Jan/2016:10:01:36.266] www-https~ www-backend/www-1 99/0/1/149217/149317 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=4
&gt; HTTP/1.1"
&gt;Jan 14 10:04:08 localhost haproxy-gen1[400]: 10.100.88.52:63112 
&gt;[14/Jan/2016:10:01:36.245] www-https~ www-backend/www-1 112/0/0/152150/152262 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=6
&gt; HTTP/1.1"
&gt;Jan 14 10:04:19 localhost haproxy-gen1[400]: 10.100.88.52:63114 
&gt;[14/Jan/2016:10:01:36.261] www-https~ www-backend/www-1 104/0/1/160670/160775 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=7
&gt; HTTP/1.1"
&gt;Jan 14 10:04:34 localhost haproxy-gen1[400]: 10.100.88.52:63119 
&gt;[14/Jan/2016:10:02:53.008] www-https~ www-backend/www-1 100/0/0/99129/99229 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=12
&gt; HTTP/1.1"
&gt;Jan 14 10:04:39 localhost haproxy-gen1[400]: 10.100.88.52:63116 
&gt;[14/Jan/2016:10:02:57.985] www-https~ www-backend/www-1 181/0/0/99530/99711 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=14
&gt; HTTP/1.1"
&gt;Jan 14 10:04:41 localhost haproxy-gen1[400]: 10.100.88.52:63117 
&gt;[14/Jan/2016:10:02:56.274] www-https~ www-backend/www-1 312/0/0/102647/102959 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=13
&gt; HTTP/1.1"
&gt;Jan 14 10:04:52 localhost haproxy-gen1[400]: 10.100.88.52:63113 
&gt;[14/Jan/2016:10:03:52.963] www-https~ www-backend/www-1 203/0/0/57611/57814 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=17
&gt; HTTP/1.1"
&gt;Jan 14 10:05:11 localhost haproxy-gen1[400]: 10.100.88.52:63118 
&gt;[14/Jan/2016:10:03:23.856] www-https~ www-backend/www-1 109/0/0/105391/105500 
&gt;200 190 - - ---- 10/10/9/9/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=15
&gt; HTTP/1.1"
&gt;Jan 14 10:05:28 localhost haproxy-gen1[400]: 10.100.88.52:63105 
&gt;[14/Jan/2016:10:04:05.320] www-https~ www-backend/www-1 231/0/0/80927/81158 
&gt;200 190 - - ---- 9/9/8/8/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=18
&gt; HTTP/1.1"
&gt;Jan 14 10:05:45 localhost haproxy-gen1[400]: 10.100.88.52:63114 
&gt;[14/Jan/2016:10:04:19.199] www-https~ www-backend/www-1 89/0/0/86180/86269 200 
&gt;190 - - ---- 8/8/7/7/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=21
&gt; HTTP/1.1"
&gt;Jan 14 10:05:46 localhost haproxy-gen1[400]: 10.100.88.52:63113 
&gt;[14/Jan/2016:10:04:52.940] www-https~ www-backend/www-1 172/0/1/53672/53845 
&gt;200 190 - - ---- 8/8/6/6/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=25
&gt; HTTP/1.1"
&gt;Jan 14 10:05:58 localhost haproxy-gen1[400]: 10.100.88.52:63120 
&gt;[14/Jan/2016:10:04:05.583] www-https~ www-backend/www-1 233/0/1/110598/110832 
&gt;200 190 - - ---- 6/6/5/5/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=19
&gt; HTTP/1.1"
&gt;Jan 14 10:05:59 localhost haproxy-gen1[400]: 10.100.88.52:63117 
&gt;[14/Jan/2016:10:04:41.396] www-https~ www-backend/www-1 248/0/0/77581/77829 
&gt;200 190 - - ---- 6/6/4/4/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=24
&gt; HTTP/1.1"
&gt;Jan 14 10:06:00 localhost haproxy-gen1[400]: 10.100.88.52:63119 
&gt;[14/Jan/2016:10:04:34.402] www-https~ www-backend/www-1 197/0/0/85485/85682 
&gt;200 190 - - ---- 6/6/3/3/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=22
&gt; HTTP/1.1"
&gt;Jan 14 10:06:00 localhost haproxy-gen1[400]: 10.100.88.52:63116 
&gt;[14/Jan/2016:10:04:39.859] www-https~ www-backend/www-1 178/0/0/80650/80828 
&gt;200 190 - - ---- 6/6/2/2/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=23
&gt; HTTP/1.1"
&gt;Jan 14 10:06:01 localhost haproxy-gen1[400]: 10.100.88.52:63115 
&gt;[14/Jan/2016:10:03:28.336] www-https~ www-backend/www-1 75/0/0/150705/150780 
&gt;200 190 - - ---- 6/6/1/1/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=16
&gt; HTTP/1.1"
&gt;Jan 14 10:06:06 localhost haproxy-gen1[400]: 10.100.88.52:63112 
&gt;[14/Jan/2016:10:04:08.508] www-https~ www-backend/www-1 126/0/0/116172/116298 
&gt;200 190 - - ---- 6/6/0/0/0 0/0 "PUT 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D&partNumber=20
&gt; HTTP/1.1"
&gt;Jan 14 10:06:07 localhost haproxy-gen1[400]: 10.100.88.52:63112 
&gt;[14/Jan/2016:10:06:06.970] www-https~ www-backend/www-1 86/0/0/21/107 200 468 
&gt;- - ---- 6/6/0/0/0 0/0 "POST 
&gt;/three2016com-devopsdevel/Archive.zip?uploadId=Ui6QDuCuSBqpbGGdf8SHig%3D%3D 
&gt;HTTP/1.1"
&gt;```
&gt;
&gt;
&gt;Since this is not a browser client there is no preflight (OPTIONS) required. 
&gt;There are no errors being logged at all, and the upload completes without 
&gt;issue. 
&gt;
&gt;So far I have only tested this functionality in Chrome. I am going to try and 
&gt;test Safari and FF now and I will let you know if there is any difference (or 
&gt;not).
&gt;
&gt;
&gt;Thanks,
&gt;
&gt;John Fanjoy
&gt;Systems Engineer
&gt;jfan...@inetu.net
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;On 1/14/16, 9:31 AM, "Shunichi Shinohara"  wrote:
&gt;
&gt;&gt;Hi John,
&gt;&gt;
&gt;&gt;I tested Multipart Upload with aws-sdk-js with the patch you
&gt;&gt;mentioned, against riak\\_cs (s2),
&gt;&gt;upload finished without errors up to 1GB object. The environment is
&gt;&gt;all local on my laptop,
&gt;&gt;so latency is small. The script I used is in [1].
&gt;&gt;
&gt;&gt;As Luke mentioned, HAProxy would be the point to be investigated first.
&gt;&gt;Or, if it's possible to get packet capture, by finding some wrong TCP
&gt;&gt;packet, like
&gt;&gt;RST or premature (from the point of HTTP) FIN, one can identify who
&gt;&gt;closes TCP connection
&gt;&gt;actively. In this case, packet should be captured on client box,
&gt;&gt;HAProxy box and riak cs box.
&gt;&gt;
&gt;&gt;[1] https://gist.github.com/shino/ac7d56398557fb936899
&gt;&gt;
&gt;&gt;Thanks,
&gt;&gt;Shino
&gt;&gt;
&gt;&gt;
&gt;&gt;2016-01-14 8:51 GMT+09:00 Luke Bakken :
&gt;&gt;&gt; Hi John,
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for the info. I'm very curious to see what's in the haproxy
&gt;&gt;&gt; logs with regard to TCP.
&gt;&gt;&gt; --
&gt;&gt;&gt; Luke Bakken
&gt;&gt;&gt; Engineer
&gt;&gt;&gt; lbak...@basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Wed, Jan 13, 2016 at 3:50 PM, John Fanjoy  wrote:
&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; As a test I’ve already increased all timeouts to 5 minutes but the failure 
&gt;&gt;&gt;&gt; occurs within under 1 minute so it doesn’t appear to be timeout related. I 
&gt;&gt;&gt;&gt; change the logs to tcplog tomorrow and let you know if I find anything.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 1/13/16, 6:05 PM, "Luke Bakken"  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;haproxy ships with some "short" default timeouts. If CyberDuck is able
&gt;&gt;&gt;&gt;&gt;to upload these files faster than aws-sdk, it may be doing so within
&gt;&gt;&gt;&gt;&gt;the default haproxy timeouts.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;You can also look at haproxy's log to see if you find any TCP
&gt;&gt;&gt;&gt;&gt;connections that it has closed.
&gt;&gt;&gt;&gt;&gt;--
&gt;&gt;&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;&gt;&gt;Engineer
&gt;&gt;&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;On Wed, Jan 13, 2016 at 3:02 PM, John Fanjoy  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; I may be able to do that. The only problem is without haproxy I have no 
&gt;&gt;&gt;&gt;&gt;&gt; way to inject CORS headers which the browser requires, but I may be able 
&gt;&gt;&gt;&gt;&gt;&gt; to write up small nodejs app to get past that and see if it is somehow 
&gt;&gt;&gt;&gt;&gt;&gt; related to haproxy. The fact that these errors are not present when 
&gt;&gt;&gt;&gt;&gt;&gt; using Cyberduck which is also talking to haproxy leads me to believe 
&gt;&gt;&gt;&gt;&gt;&gt; that’s not the cause, but it’s definitely worth testing.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On 1/13/16, 5:55 PM, "Luke Bakken"  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;John -
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;The following error indicates that the connection was unexpectedly
&gt;&gt;&gt;&gt;&gt;&gt;&gt;closed by something outside of Riak while the chunk is uploading:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;{badmatch,{error,closed}}
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;Is it possible to remove haproxy to test using the the aws-sdk?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;That is my first thought as to the cause of this issue, especially
&gt;&gt;&gt;&gt;&gt;&gt;&gt;since writing to S3 works with the same code.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;--
&gt;&gt;&gt;&gt;&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;&gt;&gt;&gt;&gt;Engineer
&gt;&gt;&gt;&gt;&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;On Wed, Jan 13, 2016 at 2:46 PM, John Fanjoy  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Yes on both parts. To confirm cyberduck was using multi-part I 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; actually tailed the console.log while it was uploading the file, and 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; it uploaded the file in approx. 40 parts. Afterwards the parts were 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; reassembled as you would expect. The AWS-SDK for javascript has an 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; object called ManagedUpload which automatically switches to multi-part 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; when the input is larger than the maxpartsize (default 5mb). I have 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; confirmed that it is splitting the files up, but so far I’ve only ever 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; seen one part get successfully uploaded before the others failed at 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; which point it removes the upload (DELETE call) automatically. I also 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; verified that the javascript I have in place does work with an actual 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; AWS S3 bucket to rule out coding issues on my end and the same &gt;400mb 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; file was successfully uploaded to the bucket I created there without 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; issue.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; A few things worth mentioning that I missed before. I am running 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-s2 behind haproxy. Haproxy is handling ssl and enabling CORS for 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; browser based requests. I have tested smaller files (~4-5mb) and GET 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; requests using the browser client and everything works with my current 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; haproxy configuration, but the larger files are failing, usually after 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1 part is successfully uploaded. I can also list bucket contents and 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; delete existing contents. The only feature that is not working appears 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; to be the multi-part uploads. We are running centOS 7 (kernel version 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 3.10.0-327.4.4.el7.x86\\_64). Please let me know if you have any further 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; questions.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

