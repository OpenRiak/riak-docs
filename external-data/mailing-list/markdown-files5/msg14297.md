---
title: "Re: Upgraded riak 1.4.9 is pegging the CPU"
description: ""
project: community
lastmod: 2014-06-05T11:14:31-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14297"
mailinglist_parent_id: "msg14296"
author_name: "Engel Sanchez"
project_section: "mailinglistitem"
sent_date: 2014-06-05T11:14:31-07:00
---


Alain, thanks for the logs you sent me on the side. I'm not yet sure what
the root cause is, but I saw a lot of handoff activity and busy distributed
port messages, which indicate the single TCP connection between two Erlang
nodes is completely saturated. Since there is too much going on, turning
off AAE and examining your cluster with less activity might still be a good
idea. Check the output of riak-admin transfers until it is quiet. I
noticed you have a file limit of 8192. That is not low, but newer Riaks eat
more file handles, so it would be a good idea to double that. Let us know
how the stats and the logs look like after AAE is off to see what else we
can do.


On Thu, Jun 5, 2014 at 1:05 PM, Engel Sanchez  wrote:

&gt; Hi Alain. I don't think you are seeing the AAE issue. The problem with
&gt; upgrading from 1.4.4-1.4.7 to 1.4.8 was a broken hash function in those,
&gt; which made the AAE trees incompatible. You should not have the same problem
&gt; in 1.4.0. It seems that Erlang processes are repeatedly crashing and
&gt; restarting. It would be good to grab all your logs before they rotate so we
&gt; can take a look at exactly what is the first thing crashing and causing
&gt; this snowball effect.
&gt;
&gt;
&gt; On Thu, Jun 5, 2014 at 11:58 AM, Alain Rodriguez  wrote:
&gt;
&gt;&gt; Actually I just noticed it is likely the AAE issue:
&gt;&gt;
&gt;&gt; 2014-06-05 14:53:47.587 [error] &lt;0.16054.31&gt; CRASH REPORT Process
&gt;&gt; &lt;0.16054.31&gt; with 0 neighbours exited with reason: no match of right hand
&gt;&gt; value {error,{db\\_open,"IO error: lock
&gt;&gt; /var/lib/riak/anti\\_entropy/1061872283373234151507364761270424381468763488256/LOCK:
&gt;&gt; already held by process"}} in hashtree:new\\_segment\\_store/2 line 505 in
&gt;&gt; gen\\_server:init\\_it/6 line 328
&gt;&gt; 2014-06-05 14:53:47.588 [error] &lt;0.16056.31&gt; CRASH REPORT Process
&gt;&gt; &lt;0.16056.31&gt; with 0 neighbours exited with reason: no match of right hand
&gt;&gt; value {error,{db\\_open,"IO error: lock
&gt;&gt; /var/lib/riak/anti\\_entropy/1335903840372778448670555667404727447654250840064/LOCK:
&gt;&gt; already held by process"}} in hashtree:new\\_segment\\_store/2 line 505 in
&gt;&gt; gen\\_server:init\\_it/6 line 328
&gt;&gt; 2014-06-05 14:53:47.588 [error] &lt;0.16055.31&gt; CRASH REPORT Process
&gt;&gt; &lt;0.16055.31&gt; with 0 neighbours exited with reason: no match of right hand
&gt;&gt; value {error,{db\\_open,"IO error: lock
&gt;&gt; /var/lib/riak/anti\\_entropy/1267395951122892374379757940871151681107879002112/LOCK:
&gt;&gt; already held by process"}} in hashtree:new\\_segment\\_store/2 line 505 in
&gt;&gt; gen\\_server:init\\_it/6 line 328
&gt;&gt;
&gt;&gt; Bollocks!
&gt;&gt;
&gt;&gt;
&gt;&gt; On Thu, Jun 5, 2014 at 8:49 AM, Alain Rodriguez  wrote:
&gt;&gt;
&gt;&gt;&gt; Thanks for the quick reply and no I did not. Is this something I should
&gt;&gt;&gt; be able to do now (stop, remove files, start again) or is it too late? How
&gt;&gt;&gt; could I verify this is the issue?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Thu, Jun 5, 2014 at 8:42 AM, Shane McEwan  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 05/06/14 16:20, Alain Rodriguez wrote:
&gt;&gt;&gt;&gt; &gt; Hi all,
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; I upgraded 1 of 9 riak nodes in a cluster last night from 1.4.0 to
&gt;&gt;&gt;&gt; &gt; 1.4.9. The rest are running 1.4.0.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; Ever since I am seeing the upgraded node, riak01 consuming a
&gt;&gt;&gt;&gt; &gt; significantly larger percent of CPU and the PUT times on it have
&gt;&gt;&gt;&gt; gotten
&gt;&gt;&gt;&gt; &gt; worse. htop indicicates one particular process pegging the CPU, and
&gt;&gt;&gt;&gt; many
&gt;&gt;&gt;&gt; &gt; many more processes running than I was used to seeing before.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; G'day!
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Did you turn off and remove the Active Anti Entropy files before
&gt;&gt;&gt;&gt; upgrading?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; From the 1.4.8 release notes:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; IMPORTANT We recommend removing current AAE trees before upgrading. That
&gt;&gt;&gt;&gt; is, all files under the anti\\_entropy sub-directory. This will avoid
&gt;&gt;&gt;&gt; potentially large amounts of repair activity once correct hashes start
&gt;&gt;&gt;&gt; being added. The data in the current trees can only be fixed by a full
&gt;&gt;&gt;&gt; rebuild, so this repair activity is wasteful. Trees will start to build
&gt;&gt;&gt;&gt; once AAE is re-enabled. To minimize the impact of this, we recommend
&gt;&gt;&gt;&gt; upgrading during a period of low activity.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Shane.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

