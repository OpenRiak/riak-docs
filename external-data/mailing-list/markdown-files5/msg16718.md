---
title: "Re: Ownership handoff timed out"
description: ""
project: community
lastmod: 2015-10-29T08:27:59-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16718"
mailinglist_parent_id: "msg16715"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2015-10-29T08:27:59-07:00
---


Hi,

There was a known eleveldb bug with handoff receiving that could cause a 
timeout. But it does not sound like bug fits your symptoms. However, I am 
willing to verify my diagnosis. I would need you to gather the LOG files from 
all vnodes on the RECEIVING side (or at least from the vnode that you are 
attempting and is failing).

I will check it for the symptoms of the known bug.

Note: the LOG files reset on each restart of Riak. So you must gather the LOG 
files right after the failure without restarting Riak.

Matthew


&gt; On Oct 29, 2015, at 11:11 AM, Vladyslav Zakhozhai 
&gt;  wrote:
&gt; 
&gt; Hi,
&gt; 
&gt; I want to make small update. Jon your hint about problems on sender side is 
&gt; correct. As I've already told there problems with available resources on 
&gt; sender nodes. There are no enough available RAM which is a cause of swapiness 
&gt; and load on disks. Restarting of sender nodes helps me (at least temoprarily).
&gt; 
&gt; 
&gt; On Thu, Oct 29, 2015 at 12:19 PM Vladyslav Zakhozhai 
&gt; &gt; wrote:
&gt; Hi,
&gt; 
&gt; Average size of objects in Riak - 300 Kb. This objects are images. This data 
&gt; updates very very rearly (there almost no updates).
&gt; 
&gt; I have GC turned on and works:
&gt; root@python:~# riak-cs-gc status
&gt; There is no garbage collection in progress
&gt; The current garbage collection interval is: 900
&gt; The current garbage collection leeway time is: 86400
&gt; Last run started at: 20151029T100600Z
&gt; Next run scheduled for: 20151029T102100Z
&gt; 
&gt; Network misconfigurations were not detected. The result of your script shows 
&gt; correct info.
&gt; 
&gt; But I see that almost all nodes with bitcask suffers from low free memory and 
&gt; they swapped. I think that it can be an issue. But my question is, what 
&gt; workaround is for this problem.
&gt; 
&gt; I've wrote in my first post that I tuned handoff\\_timeout and 
&gt; handoff\\_receive\\_timeout (now this vaules are 300000 and 600000). But 
&gt; situation is the same.
&gt; 
&gt; 
&gt; On Tue, Oct 27, 2015 at 4:06 PM Jon Meredith  &gt; wrote:
&gt; Hi,
&gt; 
&gt; Handoff problems without obvious disk issues can be due to the database 
&gt; containing large objects. Do you frequently update objects in CS, and if so 
&gt; have you had garbage collection running?
&gt; 
&gt; The timeout is happening on the receiver side after not receiving any tcp 
&gt; data for handoff\\_receive\\_timeout \\*milli\\*seconds. I know you said you 
&gt; increased it, but not how high. I would bump that up to 300000 to give the 
&gt; sender a chance to read larger objects off disk.
&gt; 
&gt; To check if the sender is transmitting, on the source node you could run
&gt; redbug:start("riak\\_core\\_handoff\\_sender:visit\\_item", [{arity, 
&gt; true},{print\\_file,"/tmp/visit\\_item.log"},{time, 3600000},{msgs, 1000000}]).
&gt; 
&gt; That file should fill fairly fast with an entry for every object the sender 
&gt; tries to transmit.
&gt; 
&gt; There's a long shot it could be network misconfiguration. Run this from the 
&gt; source node having problems 
&gt; 
&gt; rpc:multicall(erlang, apply, [fun() -&gt; TargetNode = node(), [\\_Name,Host] = 
&gt; string:tokens(atom\\_to\\_list(TargetNode), "@"), {ok, Port} = 
&gt; riak\\_core\\_gen\\_server:call({riak\\_core\\_handoff\\_listener, TargetNode}, 
&gt; handoff\\_port), HandoffIP = riak\\_core\\_handoff\\_listener:get\\_handoff\\_ip(), 
&gt; TNHandoffIP = case HandoffIP of error -&gt; Host; {ok, "0.0.0.0"} -&gt; Host; {ok, 
&gt; Other} -&gt; Other end, {node(), HandoffIP, TNHandoffIP, 
&gt; inet:gethostbyname(TNHandoffIP), Port} end, []]).
&gt; 
&gt; and it will print out a a list of remote nodes and IP addresses (and 
&gt; hopefully an empty list of failed nodes)
&gt; 
&gt; {[{'dev1@127.0.0.1 ', &lt;---- node name
&gt; {ok,"0.0.0.0"}, &lt;---- handoff ip address configured in 
&gt; app.config
&gt; "127.0.0.1", &lt;---- hostname passed to socket open
&gt; {ok,{hostent,"127.0.0.1",[],inet,4,[{127,0,0,1}]}}, &lt;--- DNS entry for 
&gt; hostname
&gt; 10019}], &lt;---- handoff port
&gt; []} &lt;--- empty list of errors
&gt; 
&gt; Good luck, Jon.
&gt; 
&gt; On Tue, Oct 27, 2015 at 3:55 AM Vladyslav Zakhozhai 
&gt; &gt; wrote:
&gt; Hi,
&gt; 
&gt; Jon thank you for the answer. During approval of my mail to this list I've 
&gt; troubleshoot my issue more deep. And yes, your are right. Neither {error, 
&gt; enotconn} nor max\\_concurrency is my problem.
&gt; 
&gt; I'm going to migrate my cluster entierly to eleveldb only, i.e. I need to 
&gt; refuse using bitcask. I have a talk with basho support and they said that it 
&gt; is tricky to tune bitcask on servers with 32 GB RAM (and I guess that it is 
&gt; not tricky, but it is impossible, because bitcask loads all keys in memory 
&gt; regardless of free available RAM). With LevelDB I have opportunity to tune 
&gt; using RAM on servers.
&gt; 
&gt; So I have 15 nodes with multibackend (bitcask for data and leveldb for 
&gt; metadata). 2 additional servers are without multibackend - only with leveldb. 
&gt; Now I'm not sure do I need still use mutibackend with levedb-only backend.
&gt; 
&gt; And my problem is (as I mentioned earlier) the following. On leveldb-only 
&gt; nodes I see handoffs timedout and no further progress.
&gt; 
&gt; On multibackend hosts I have configuration:
&gt; 
&gt; {riak\\_kv, [
&gt; {add\\_paths, ["/usr/lib/riak-cs/lib/riak\\_cs-1.5.0/ebin"]},
&gt; {storage\\_backend, riak\\_cs\\_kv\\_multi\\_backend},
&gt; {multi\\_backend\\_prefix\\_list, [{&lt;&lt;"0b:"&gt;&gt;, be\\_blocks}]},
&gt; {multi\\_backend\\_default, be\\_default},
&gt; {multi\\_backend, [
&gt; {be\\_default, riak\\_kv\\_eleveldb\\_backend, [
&gt; {max\\_open\\_files, 50},
&gt; {data\\_root, "/var/lib/riak/leveldb"}
&gt; ]},
&gt; {be\\_blocks, riak\\_kv\\_bitcask\\_backend, [
&gt; {data\\_root, "/var/lib/riak/bitcask"}
&gt; ]}
&gt; ]},
&gt; 
&gt; And for hosts with leveldb-only backend:
&gt; 
&gt; {riak\\_kv, [
&gt; {storage\\_backend, riak\\_kv\\_eleveldb\\_backend},
&gt; ...
&gt; {eleveldb, [ 
&gt; {data\\_root, "/var/lib/riak/leveldb"}
&gt; (default values for leveldb)
&gt; 
&gt; In leveldb logs I see nothing that could help me (no errors in logs).
&gt; 
&gt; 
&gt; On Mon, Oct 26, 2015 at 3:57 PM Jon Meredith  &gt; wrote:
&gt; Hi,
&gt; 
&gt; I suspect your {error,enotconn} messages are unrelated - that's likely to be 
&gt; caused by an HTTP client closing the connection while Riak looks up some 
&gt; networking information about the requestor.
&gt; 
&gt; The max\\_concurrency message you are seeing is related to the handoff transfer 
&gt; limit - it should be labelled as informational. When a node has data to 
&gt; handoff it starts the handoff sender process and if there are either too many 
&gt; local handoff processes or too many on the remote side it exits with 
&gt; max\\_concurrency. You could increase with riak-admin transfer-limit but that 
&gt; probably won't help if you're timing out.
&gt; 
&gt; As you're using the multi-backend you're transferring data from bitcask and 
&gt; leveldb. The next place I would look is in the leveldb LOG files to see if 
&gt; there are any leveldb vnodes that are having problems that's preventing 
&gt; repair.
&gt; 
&gt; Jon
&gt; 
&gt; On Mon, Oct 26, 2015 at 7:15 AM Vladyslav Zakhozhai 
&gt; &gt; wrote:
&gt; Hello,
&gt; 
&gt; I have a problem with persistent timeouts during ownership handoffs. I've 
&gt; tried to surf over Internet and current mail list but no success.
&gt; 
&gt; I have Riak 1.4.12 cluster with 17 nodes. Almost all nodes use multibackend 
&gt; with bitcask and eleveldb as storage backends (we need multiple backend for 
&gt; Riak CS 1.5.0 integration).
&gt; 
&gt; Now I'm working to migrate Riak cluster to eleveldb as primary and only 
&gt; backend. For now I have 2 nodes with eleveldb backend in the same cluster.
&gt; 
&gt; During ownership handoff process I permanently see errors of timed out 
&gt; handoff receivers and sender.
&gt; 
&gt; Here is partial output of riak-admin transfers:
&gt; ...
&gt; transfer type: ownership\\_transfer
&gt; vnode type: riak\\_kv\\_vnode
&gt; partition: 331121464707782692405522344912282871640797216768
&gt; started: 2015-10-21 08:32:55 [46.66 min ago]
&gt; last update: no updates seen
&gt; total size: unknown
&gt; objects transferred: unknown
&gt; 
&gt; unknown 
&gt; riak@taipan.pleiad.uaprom =======&gt; r...@eggeater.pleiad.uapr
&gt; om 
&gt; | | 0% 
&gt; unknown 
&gt; 
&gt; transfer type: ownership\\_transfer
&gt; vnode type: riak\\_kv\\_vnode
&gt; partition: 336830455478606531929755488790080852186328203264
&gt; started: 2015-10-21 08:32:54 [46.68 min ago]
&gt; last update: no updates seen
&gt; total size: unknown
&gt; objects transferred: unknown
&gt; ...
&gt; 
&gt; Some of partition handoffs state never updates, some of them terminates after 
&gt; partial handoff objects and never starts again.
&gt; 
&gt; I see nothing in logs but following:
&gt; 
&gt; On receiver side:
&gt; 
&gt; 2015-10-21 11:33:55.131 [error] 
&gt; &lt;0.25390.1266&gt;@riak\\_core\\_handoff\\_receiver:handle\\_info:105 Handoff receiver 
&gt; for partition 331121464707782692405522344912282871640797216768 timed out 
&gt; after processing 0 objects.
&gt; 
&gt; On sender side:
&gt; 
&gt; 2015-10-21 11:01:58.879 [error] &lt;0.13177.1401&gt; CRASH REPORT Process 
&gt; &lt;0.13177.1401&gt; with 0 neighbours crashed with reason: no function clause 
&gt; matching webmachine\\_request:peer\\_from\\_peername({error,enotconn}, 
&gt; {webmachine\\_request,{wm\\_reqstate,#Port&lt;0.50978116&gt;,[],undefined,undefined,undefined,{wm\\_reqdata,...},...}})
&gt; line 150
&gt; 2015-10-21 11:32:50.055 [error] &lt;0.207.0&gt; Supervisor 
&gt; riak\\_core\\_handoff\\_sender\\_sup had child riak\\_core\\_handoff\\_sender started with 
&gt; {riak\\_core\\_handoff\\_sender,start\\_link,undefined} at &lt;0.22312.1090&gt; exit with 
&gt; reason max\\_concurrency in context child\\_terminated
&gt; 
&gt; {error, enotconn} - seems to be network issue. But I have no any problems 
&gt; with network. All hosts resolve their neighbors correctly and /etc/hosts on 
&gt; each node are correct.
&gt; 
&gt; I've tried to increase handoff\\_timeout and handoff\\_receive\\_timeout. But no 
&gt; success.
&gt; 
&gt; Forcing handoff helped me but for short period of time:
&gt; 
&gt; rpc:multicall([node() | nodes()], riak\\_core\\_vnode\\_manager, force\\_handoffs, 
&gt; []).
&gt; 
&gt; I see progress of handoffs (riak-admin transfers) but then I see handoff 
&gt; timed out again.
&gt; 
&gt; A week ago I've joined 4 nodes with bitcask. And there was no such problems.
&gt; 
&gt; I'm confused a little bit and need to understand my next steps in 
&gt; troubleshooting this issue.
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com 
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

