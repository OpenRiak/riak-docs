---
title: "Re: documents disappear from riak search index"
description: ""
project: community
lastmod: 2012-01-31T04:45:14-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06468"
mailinglist_parent_id: "msg06283"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2012-01-31T04:45:14-08:00
---


Hi Ryan,

It's happening again.

I think it's even worse now: when I compare books by counting (search
vs k/v) they yield the same amount of documents. Yet users are still
complaining. I was mistakenly relying on those numbers.

This is about users and the books they see on their bookshelves, which
is a search query on bookId AND userId. In this case 'maya012' and
'8542'.

db.get('user\\_books', 'maya012-8542')
=&gt; { }

It's found, k/v works at least.

db.addSearch('user\\_books', 'bookId:8542 AND userId:maya012').reduce({
language: 'erlang', module: 'riak\\_kv\\_mapreduce', function:
'reduce\\_identity' }).run(function(err,d) { console.log(d.length) })
=&gt; 0

Uh oh, nothing there. Let's see what we have:

db.addSearch('user\\_books', 'userId:maya0121').reduce({ language:
'erlang', module: 'riak\\_kv\\_mapreduce', function: 'reduce\\_identity'
}).run(function(err,d) { console.log(d) })
=&gt; [ [ 'user\\_books', 'maya012-8528' ] ]

Aha. User is supposed to have 2 books but has one. Let's see if
there's a disparity between counts in K/V and search:

db.add('user\\_books').map('query', 'where
.bookId:val("8542")').run(function(err, d) { console.log(d.length) })
=&gt; 660

db.addSearch('user\\_books', 'bookId:8542').reduce({ language: 'erlang',
module: 'riak\\_kv\\_mapreduce', function: 'reduce\\_identity'
}).run(function(err,d) { console.log(d.length) })
=&gt; 660

WTH? It seems that 'userId' is introducing some weirdness here.

I fetched/saved the document, and now things are back to normal...

db.addSearch('user\\_books', 'bookId:8542 AND userId:maya012').reduce({
language: 'erlang', module: 'riak\\_kv\\_mapreduce', function:
'reduce\\_identity' }).run(function(err,d) { console.log(d.length) })
=&gt; 1

...for maya012. Go figure how many other users are getting incorrect
data. Oh yea, I need to write another script to check them one by one.

I waded through the logs, because there are tons of errors regarding
Luwak... (oh right, that too! Probably 5% of the files return 0 bytes,
awesome – but I digress) ... and can't find anything that is even
close to be search-related.

I did this for all 3 nodes in the cluster. I did health-checks,
nothing abnormal... enough disk space, no resource spikes, all
transfers complete... I don't know. Things seem to be normal, or maybe
I'm not enough of a mad scientist to notice it. Should I need some
cleanup, restart nodes?

This is starting to get bad.

Thanks,
Francisco


2012/1/14 Ryan Zezeski :
&gt;
&gt;
&gt; On Sat, Jan 14, 2012 at 11:58 AM, francisco treacy
&gt;  wrote:
&gt;&gt;
&gt;&gt;
&gt;&gt; (I don't know how much Search has changed in 1.0.x, but keep in mind
&gt;&gt; I'm running 0.14.2 in production.)
&gt;&gt;
&gt;&gt; I'd love to provide you with more information, but don't have much
&gt;&gt; time to go digging around. The workaround is, well, a workaround, but
&gt;&gt; it let us move on. I'll keep a special eye on this until it happens
&gt;&gt; again, and let's definitely keep each other posted.
&gt;&gt;
&gt;
&gt; Even in 0.14.2 I find it hard to believe the index is dropping 5% of the
&gt; data on the floor.  It's entirely possible, but just not the first, or
&gt; second or third thing I would expect.
&gt;
&gt; Please keep me posted.  I'll keep this incident in the back of my head when
&gt; looking at Search code.

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

