---
title: "Re: Issues with partition distribution across nodes"
description: ""
project: community
lastmod: 2017-05-24T07:46:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18238"
mailinglist_parent_id: "msg18237"
author_name: "Denis"
project_section: "mailinglistitem"
sent_date: 2017-05-24T07:46:05-07:00
---


Hi Russell

Thank you for your suggestions. I found diag is saying: "The following
preflists do not satisfy the n\\_val. Please add more nodes". It seems
because ring size (128) divided in 6 nodes is hard to arrange.
The history of our cluster is long story, cause we testing it in our lab.
Initially it was deployed with 5 nodes without issues. Then it was expanded
to 6 nodes, without issues again. After some time all storage space on
whole cluster was fully utilized and we had to remove all data from leveldb
dir, flush ring dir and rebuild cluster. This has been done by adding all 6
nodes at one time, so this may be the case. We can try to flush cluster
data once again and then add nodes one by one (committing cluster change
each time), waiting to partition transfer to end each time.

2017-05-24 15:44 GMT+03:00 Russell Brown :

&gt; Hi,
&gt;
&gt; This is just a quick reply since this is somewhat a current topic on the
&gt; ML.
&gt;
&gt; On 24 May 2017, at 12:57, Denis Gudtsov  wrote:
&gt;
&gt; &gt; Hello
&gt; &gt;
&gt; &gt; We have 6-nodes cluster with ring size 128 configured. The problem is
&gt; that
&gt; &gt; two partitions has replicas only on two nodes rather than three as
&gt; required
&gt; &gt; (n\\_val=3). We have tried several times to clean leveldb and ring
&gt; directories
&gt; &gt; and then rebuild cluster, but this issue is still present.
&gt;
&gt; There was a fairly long discussion about this very issue recently (see
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.
&gt; basho.com/2017-May/019281.html)
&gt;
&gt; I ran a little code and the following {RingSize, NodeCount, IsViolated}
&gt; tuples were the result. If you built any of these clusters from scratch
&gt; (i.e. you started NodeCount nodes, and used riak-admin cluster join,
&gt; riak-admin cluster plan, riak-admin cluster commit to create a cluster of
&gt; NodeCount from scratch) then you have tail violations in your ring.
&gt;
&gt; [{16,3,true},
&gt; {16,5,true},
&gt; {16,7,true},
&gt; {16,13,true},
&gt; {16,14,true},
&gt; {32,3,true},
&gt; {32,5,true},
&gt; {32,6,true},
&gt; {32,10,true},
&gt; {64,3,true},
&gt; {64,7,true},
&gt; {64,9,true},
&gt; {128,3,true},
&gt; {128,5,true},
&gt; {128,6,true},
&gt; {128,7,true},
&gt; {128,9,true},
&gt; {128,14,true},
&gt; {256,3,true},
&gt; {256,5,true},
&gt; {256,11,true},
&gt; {512,3,true},
&gt; {512,5,true},
&gt; {512,6,true},
&gt; {512,7,true},
&gt; {512,10,true}]
&gt;
&gt;
&gt; &gt; How can we diagnose where the issue is and fix it?
&gt;
&gt; WRT your problem, a quick experiment looks like adding 2 new nodes will
&gt; solve your problem, just adding one doesn’t look like it does. I tried just
&gt; adding one new node and still had a single violated preflist, but I have
&gt; just thrown a little experiment together so I could well be wrong. It
&gt; doesn’t actually build any clusters, and uses the claim code out of
&gt; context, ymmv
&gt;
&gt; &gt; Is there any way how we
&gt; &gt; can assign partition to node manually?
&gt;
&gt; I don’t know of a way, but that would be very useful.
&gt;
&gt; Do you remember if this cluster was built all at once as a 6-node cluster,
&gt; or has it grown over time? Have you run the command riak-admin diag
&gt; ring\\_preflists as documented here http://docs.basho.com/riak/kv/
&gt; 2.2.3/setup/upgrading/checklist/#confirming-configuration-with-riaknostic?
&gt;
&gt; Sorry I can’t be more help
&gt;
&gt; Cheers
&gt;
&gt; Russell
&gt;
&gt; &gt;
&gt; &gt; Please find output of member-status below and screen from riak control
&gt; ring
&gt; &gt; status:
&gt; &gt; [root@riak01 ~]# riak-admin member-status
&gt; &gt; ================================= Membership
&gt; &gt; ==================================
&gt; &gt; Status Ring Pending Node
&gt; &gt; ------------------------------------------------------------
&gt; -------------------
&gt; &gt; valid 17.2% -- 'riak@riak01.
&gt; &gt; valid 17.2% -- 'riak@riak02.
&gt; &gt; valid 16.4% -- 'riak@riak03.
&gt; &gt; valid 16.4% -- 'riak@riak04.
&gt; &gt; valid 16.4% -- 'riak@riak05.
&gt; &gt; valid 16.4% -- 'riak@riak06.
&gt; &gt; ------------------------------------------------------------
&gt; -------------------
&gt; &gt; Valid:6 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt; &gt;
&gt; &gt; 
&gt; &gt;
&gt; &gt; Thank you.
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt; View this message in context: http://riak-users.197444.n3.
&gt; nabble.com/Issues-with-partition-distribution-across-nodes-tp4035179.html
&gt; &gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

