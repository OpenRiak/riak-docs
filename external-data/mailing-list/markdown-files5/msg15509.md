---
title: "Re: Using apache as a reverse proxy"
description: ""
project: community
lastmod: 2015-01-15T14:50:58-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15509"
mailinglist_parent_id: "msg15508"
author_name: "Fred Grim"
project_section: "mailinglistitem"
sent_date: 2015-01-15T14:50:58-08:00
---


So it does not take much time. Less then a second. Here is a little bit
more data. So it looks like (after increasing the buffer windows on both
linux hosts) I get the first connection to fully complete. And then it
looks like riak stops responding to new requests.
I increased the backlog for webmachine and set nodelay to true. I tried
setting disablereuse on apache and can see the connections getting closed
and still the next connection fails. Well the ones that fail give out a
bunch of chunks and then hang without producing more data.

F 

On 1/15/15, 2:06 PM, "Luke Bakken"  wrote:

&gt;Most reverse proxies have a timeout for data being sent from the
&gt;server. If this query takes a long time to run when not using the
&gt;proxy, I suggest investigating increasing timeout values.
&gt;--
&gt;Luke Bakken
&gt;Engineer
&gt;lbak...@basho.com
&gt;
&gt;
&gt;On Thu, Jan 15, 2015 at 12:01 PM, Fred Grim  wrote:
&gt;&gt; The more I look at this the more I am thinking there is something busted
&gt;&gt; in riak or webmachine (I am using riak 1.4.10). The issue seems to be
&gt;&gt; impervious to apache settings or haproxy settings and going through the
&gt;&gt; source there doesnÂ¹t seem to be many knobs to turn to adjust chunked
&gt;&gt; responses. Googling for issues in web machine also turned up nothing.
&gt;&gt; Maybe a pause in the return of map responses is doing it? Can riak be
&gt;&gt; configured to send keepalives?
&gt;&gt;
&gt;&gt; F
&gt;&gt;
&gt;&gt; On 1/14/15, 10:31 PM, "Toby Corkindale"  wrote:
&gt;&gt;
&gt;&gt;&gt;Just a thought, but have you tried to replicate the problem when using
&gt;&gt;&gt;haproxy (with the example configs provided on basho's site)?
&gt;&gt;&gt;That might let you discover if the problem really IS with Apache, or
&gt;&gt;&gt;if it's something to do with your Riak config instead.
&gt;&gt;&gt;
&gt;&gt;&gt;On 15 January 2015 at 11:05, Fred Grim  wrote:
&gt;&gt;&gt;&gt; Hello List,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; So I am using apache on ubuntu as a reverse proxy to a riak cluster.
&gt;&gt;&gt;&gt;Everything seems to work fine except for largish streaming map reduce
&gt;&gt;&gt;&gt;queries. The config is:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; ServerAdmin aper...@acompany.com
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; BalancerMember
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_&d=AwICAg&c=Sqcl0Ez
&gt;&gt;&gt;&gt;6M
&gt;&gt;&gt;&gt;0X8aeM67LKIiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLK
&gt;&gt;&gt;&gt;n7
&gt;&gt;&gt;&gt;PMnXQSchCb1a36y\\_3o9wCTLFVK8KJSs0&s=KekvofgBdK\\_OC9kN2fd0pOMp3lPUDQsQwu4f
&gt;&gt;&gt;&gt;Rr
&gt;&gt;&gt;&gt;kc9WU&e= :8098
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; ProxyPass balancer://riak\\_cluster/
&gt;&gt;&gt;&gt; ProxyPassReverse balancer://riak\\_cluster/
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; What happens is that my streamed queries seem to partially come in
&gt;&gt;&gt;&gt;which makes me think that the load balancer is switching them or
&gt;&gt;&gt;&gt;something. I know I am missing some config value in here but I cannot,
&gt;&gt;&gt;&gt;for the life of me, figure out what it is. Does anyone have an example
&gt;&gt;&gt;&gt;config they could through up?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; F
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_lists.basho.com\\_mai
&gt;&gt;&gt;&gt;lm
&gt;&gt;&gt;&gt;an\\_listinfo\\_riak-2Dusers-5Flists.basho.com&d=AwICAg&c=Sqcl0Ez6M0X8aeM67
&gt;&gt;&gt;&gt;LK
&gt;&gt;&gt;&gt;IiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLKn7PMnXQSch
&gt;&gt;&gt;&gt;Cb
&gt;&gt;&gt;&gt;1a36y\\_3o9wCTLFVK8KJSs0&s=MsEIDP9hnsHgV-B\\_0DwIZR4xJbEmFwP3M1b3ULbDXiU&e=
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;--
&gt;&gt;&gt;Turning and turning in the widening gyre
&gt;&gt;&gt;The falcon cannot hear the falconer
&gt;&gt;&gt;Things fall apart; the center cannot hold
&gt;&gt;&gt;Mere anarchy is loosed upon the world
&gt;&gt;&gt;
&gt;&gt;&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;riak-users mailing list
&gt;&gt;&gt;riak-users@lists.basho.com
&gt;&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_lists.basho.com\\_mail
&gt;&gt;&gt;ma
&gt;&gt;&gt;n\\_listinfo\\_riak-2Dusers-5Flists.basho.com&d=AwICAg&c=Sqcl0Ez6M0X8aeM67LK
&gt;&gt;&gt;Ii
&gt;&gt;&gt;DJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=ZJFOfauLKn7PMnXQSchCb1
&gt;&gt;&gt;a3
&gt;&gt;&gt;6y\\_3o9wCTLFVK8KJSs0&s=MsEIDP9hnsHgV-B\\_0DwIZR4xJbEmFwP3M1b3ULbDXiU&e=
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; 
&gt;&gt;https://urldefense.proofpoint.com/v2/url?u=http-3A\\_\\_lists.basho.com\\_mailm
&gt;&gt;an\\_listinfo\\_riak-2Dusers-5Flists.basho.com&d=AwIFaQ&c=Sqcl0Ez6M0X8aeM67LK
&gt;&gt;IiDJAXVeAw-YihVMNtXt-uEs&r=SlFhcqa96v6kZtniOwCKZQ&m=rXthvrEcXXAveYIMrbBRb
&gt;&gt;5k-fI06lSPsavO9MSjrHoY&s=jIfI93rDVYlJ8Bxca0rKKHLMQ0PGTGTnrP5GBl9QVEI&e= 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

