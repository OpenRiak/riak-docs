---
title: "Re: riak core dumped, merge_index corruption?"
description: ""
project: community
lastmod: 2013-08-12T05:49:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11977"
mailinglist_parent_id: "msg11919"
author_name: "Deyan Dyankov"
project_section: "mailinglistitem"
sent_date: 2013-08-12T05:49:55-07:00
---


Hi Ryan,

sorry for the late reply. We are running 1.3.2 and after deleting the buffer.\\* 
files, riak started. However, running the riak\\_search\\_vnode:repair( P ) 
resulted in plenty of errors like:
[…]
2013-08-08 16:36:08.261 [error] &lt;0.1938.0&gt; Supervisor mi\\_buffer\\_converter\\_sup 
had child ignored started with mi\\_buffer\\_converter:start\\_link(&lt;0.8157.0&gt;, 
"/storage/riak/merge\\_index/1050454301831586472458898473514828420377701515264", 
{buffer,"/storage/riak/merge\\_index/1050454301831586472458898473514828420377701515264/buffer.12",...})
 at &lt;0.30960.49&gt; exit with reason 
{mi\\_segment,segment\\_already\\_exists,"/storage/riak/merge\\_index/1050454301831586472458898473514828420377701515264/segment.12"}
 in context child\\_terminated
[…]

As our Riak Search app isn't yet critical, I decided to do a rolling restart 
with rm -rf /storage/riak/merge\\_index/\\* on each node. The KV (leveldb) + MR 
functionality was working and new keys were properly indexed by Riak search. 
All I had to do was rewrite old keys in Riak search in order to reindex them. 
So everything is working now.

I am now performing a migration to Riak 1.4.1. My initial idea was to use 
yokozuna but I noticed that it's bundled for 1.4.0 only and I'd rather have the 
fixes that come with 1.4.1. So I guess that we'll have to wait a bit more for 
it.

Thanks for the help!

regards,
Deyan

On Aug 6, 2013, at 11:49 PM, Ryan Zezeski  wrote:

&gt; Deyan,
&gt; 
&gt; What Riak version are you running? There was a corruption issue discovered 
&gt; and fixed in the 1.4.0 release.
&gt; 
&gt; https://github.com/basho/riak/blob/riak-1.4.0/RELEASE-NOTES.md#issues--prs-resolved
&gt; https://github.com/basho/merge\\_index/pull/30
&gt; 
&gt; As for fixing, you'll want to delete the buffer files for the partitions 
&gt; which are having issues. E.g. if you look in crash.log you'll see partition 
&gt; numbers for the crashing vnodes.
&gt; 
&gt; &gt; \\*\\* Data == 
&gt; &gt; {state,685078892498860742907977265335757665463718379520,riak\\_search\\_vnode,undefined,undefined,none,undefined,undefined,undefined,undefined,0}
&gt; 
&gt; In the 
&gt; /storage/riak/merge\\_index/685078892498860742907977265335757665463718379520 
&gt; you'll see buffer files. You'll want to delete those. After deleting all 
&gt; these bad buffers Riak Search should start fine. You'll then want to upgrade 
&gt; to 1.4.1 to avoid corruption in the future. Finally, since you have to 
&gt; delete the buffers you'll have missing indexes and you'll want to re-index 
&gt; your data.
&gt; 
&gt; Since only one of your nodes experience corruption you can use the built-in 
&gt; repair functionality to re-index only data for those partitions. First 
&gt; you'll want to attach to one of your nodes. Then for each partition run the 
&gt; following.
&gt; 
&gt; &gt; riak\\_search\\_vnode:repair(P)
&gt; 
&gt; Make sure to run repair for only one partition at a time to avoid overloading 
&gt; anything.
&gt; 
&gt; To determine when a repair is finished you can periodically call the 
&gt; following. Once it returns 'no\\_repair' that indicates it has finished.
&gt; 
&gt; &gt; riak\\_search\\_vnode:repair\\_status(P)
&gt; 
&gt; Here is more information on the repair command.
&gt; 
&gt; http://docs.basho.com/riak/latest/cookbooks/Repairing-Search-Indexes/
&gt; 
&gt; 
&gt; -Z
&gt; 
&gt; 
&gt; 
&gt; On Tue, Aug 6, 2013 at 5:17 AM, Deyan Dyankov  wrote:
&gt; hi,
&gt; 
&gt; we have a 3 node cluster and one of the node crashed yesterday.
&gt; Nodes are db1, db2 and db3. We started other services on db1 and db2 and db1 
&gt; crashed. Currently db2 and db3 are fine, balanced, receiving writes and 
&gt; serving reads.
&gt; However, db1 has issues starting. When I start the node, it outputs numerous 
&gt; errors and this finally results in a core dump. We use Riak search and this 
&gt; may be the reason for the dump. After starting the node, these are the first 
&gt; errors that are seen in the log file:
&gt; 
&gt; […]
&gt; 2013-08-06 11:06:08.989 [info] &lt;0.7.0&gt; Application erlydtl started on node 
&gt; 'r...@db1.locations.cxl-cdn.net'
&gt; 2013-08-06 11:06:16.675 [warning] &lt;0.5010.0&gt; Corrupted posting detected in 
&gt; /storage/riak/merge\\_index/456719261665907161938651510223838443642478919680/buffer.598
&gt; after reading 2281
&gt; 49 bytes, ignoring remainder.
&gt; 2013-08-06 11:06:18.922 [error] &lt;0.5310.0&gt; CRASH REPORT Process &lt;0.5310.0&gt; 
&gt; with 0 neighbours exited with reason: bad argument in call to 
&gt; erlang:binary\\_to\\_term(&lt;&lt;131,108,0,0,0,1,10
&gt; 4,4,104,3,109,0,0,0,25,99,120,108,101,118,101,110,116,115,95,99,97,107,101,...&gt;&gt;)
&gt; in mi\\_buffer:read\\_value/2 line 162 in gen\\_server:init\\_it/6 line 328
&gt; 2013-08-06 11:06:20.751 [error] &lt;0.5309.0&gt; gen\\_fsm &lt;0.5309.0&gt; in state 
&gt; started terminated with reason: no function clause matching 
&gt; riak\\_search\\_vnode:terminate({{badmatch,{error,{b
&gt; adarg,[{erlang,binary\\_to\\_term,[&lt;&lt;131,108,0,0,0,1,104,4,104,3,109,0,0,0,25,...&gt;&gt;],...},...]}}},...},
&gt; undefined) line 233
&gt; […]
&gt; 
&gt; Attached is an archive of the /var/log/riak directory. The logs there are for 
&gt; the latest starting attempt. Riak core dumped in a minute or two after being 
&gt; started.
&gt; Is there a way to fix the merge index corruption and start the node?
&gt; 
&gt; thank you for your efforts,
&gt; Deyan
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

