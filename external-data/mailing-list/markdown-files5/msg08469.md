---
title: "Re: Strategies for testing against Riak"
description: ""
project: community
lastmod: 2012-09-07T10:40:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08469"
mailinglist_parent_id: "msg08467"
author_name: "Pinney Colton"
project_section: "mailinglistitem"
sent_date: 2012-09-07T10:40:27-07:00
---


I ran into this same issue when I was confused by my own initial
benchmarking results. For my purposes, I actually shut down the riak
nodes, delete the data directories, then restart Riak between tests.

I think using a different backend is a good idea that I hadn't considered,
unless using the different backend will create performance issues (or
non-issues) that make those tests less indicative of your production usage
of the platform. I don't know enough to be able to tell you what those
different performance characteristics would be.

Yes, this means I have to reload all of my data between tests. For me,
this is pretty optimized at this point so it's not a big deal. YMMV.

I wonder about the validity of my approach, too. Is it too controlled? At
some point, I'll want to understand the performance of Riak under scenarios
with more variables, but I personally don't need to be there yet. In my
first test, I threw way too much data at Riak and it didn't seem to matter
what I was tweaking, performance was pretty unpredictable and my
measurements weren't helpful to me.

On Fri, Sep 7, 2012 at 7:02 AM, Sean Cribbs  wrote:

&gt; If it's only for your test suite, use a local memory-only node via the
&gt; Ripple::TestServer. If you configure it correctly (there's a bundled
&gt; Rails generator that helps), it will delete all the contents of Riak
&gt; in one fell-swoop after or before each test/example.
&gt;
&gt; On Fri, Sep 7, 2012 at 2:49 AM, Brad Heller  wrote:
&gt; &gt; Hey all,
&gt; &gt;
&gt; &gt; So we're rolling out Riak more and more and so far, so good. In fact
&gt; we're
&gt; &gt; starting to accumulate a pretty sizable test suite of our data access
&gt; layer.
&gt; &gt; To support this we've written some code that helps clean out buckets
&gt; between
&gt; &gt; test runs. We're using Ruby (ripple + ruby-risk-client, obviously) so we
&gt; &gt; just monkey patch the bucket object and detect if it was used or not.
&gt; &gt;
&gt; &gt; If it was used during a test, we iterate over all the keys and delete
&gt; each
&gt; &gt; one. We're cognizant of the risks in doing this for large clusters, but
&gt; in
&gt; &gt; our test enviro the number of documents per test is pretty small and the
&gt; &gt; operations themselves are quite fast.
&gt; &gt;
&gt; &gt; The problem we're having, though, is that when we run the full suite (or
&gt; a
&gt; &gt; large subset of the suite) all at once the churn in Riak seems to be so
&gt; &gt; quick that sometimes Riak isn't quite in the state that we expect it to
&gt; be
&gt; &gt; in when the test runs! For instance, we have a test that checks that the
&gt; &gt; right number of linked documents are created when a given object is
&gt; saved.
&gt; &gt; If we run the test by itself everything works fine--the expectation that
&gt; 10
&gt; &gt; documents are created indeed checks out. If we run this test as part of a
&gt; &gt; large suite of tests, the expectation fails and sometimes 11 documents
&gt; or 12
&gt; &gt; documents appear (we check by counting the keys in the linked bucket).
&gt; &gt;
&gt; &gt; I would think that this has something to do with Riak's eventually
&gt; &gt; consistent delete operation, but wanted to tap in to the brain trust: Is
&gt; &gt; there any tuning we can do in test to prevent this?
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; Brad Heller | Engineering Lead | Cloudability.com | 541-231-1514 |
&gt; Skype:
&gt; &gt; brad.heller | @bradhe | @cloudability
&gt; &gt;
&gt; &gt; We're hiring! http://cloudability.com/jobs
&gt; &gt;
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
\\*Pinney H. Colton\\*
\\*Bitwise Data, LLC\\*
+1.763.220.0793 (o)
+1.651.492.0152 (m)
http://www.bitwisedata.com
\\*
\\*
\\*Be Smart! Get Bitwise.\\*
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

