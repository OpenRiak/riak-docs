---
title: "Re: riak 2.0 - java client 'unavailable' exception"
description: ""
project: community
lastmod: 2014-07-29T15:14:56-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14578"
mailinglist_parent_id: "msg14576"
author_name: "Joseph Blomstedt"
project_section: "mailinglistitem"
sent_date: 2014-07-29T15:14:56-07:00
---


&gt; Is the requirement for having AAE enabled now removed for strong consistency?

Yes. AAE is no longer required to use strong consistency as of RC1.
The strong consistency subsystem now maintains it's own completely
separate set of Merkle trees that are used very differently than how
normal Riak AAE works. This new approach allows the consistency
subsystem to detect and recover from a variety of byzantine faults.

However, AAE is still necessary to detect and repair any corrupted
cold data (eg. data that you never read/write).

The consistency subsystem detects corruption on reads/writes and
automatically repairs data, but there is no mechanism that scans over
all data periodically to re-verify it. However, that's precisely what
normal Riak AAE does on a weekly basis, and normal Riak AAE can repair
both eventually consistent and strongly consistent keys.

Thus, you have the same choice with consistent data as you do with
eventually consistent data. Enable AAE and have Riak guarantee the
integrity of all data against bit-rot / silient on-disk corruption, or
disable AAE for improved performance but lose the ability for Riak to
detect/repair corruption of cold data (hot data is always protected).

-Joe


On Tue, Jul 29, 2014 at 2:29 PM, Sargun Dhillon  wrote:
&gt; Is the requirement for having AAE enabled now removed for strong consistency?
&gt;
&gt; On Mon, Jul 28, 2014 at 4:55 PM, Joseph Blomstedt  wrote:
&gt;&gt; This means the consistency sub-system is not enabled/active. You can
&gt;&gt; verify this with the output of `riak-admin ensemble-status`.
&gt;&gt;
&gt;&gt; To enable strong consistency you must:
&gt;&gt;
&gt;&gt; 1) Set 'strong\\_consistency = on' in riak.conf.
&gt;&gt; 2) Have at least a 3 node cluster.
&gt;&gt;
&gt;&gt; You can address #2 by setting up 3+ local developer nodes as detailed
&gt;&gt; in the 5 minute tutorial:
&gt;&gt; http://docs.basho.com/riak/2.0.0/quickstart
&gt;&gt;
&gt;&gt; Alternatively, you can override the need for 3 nodes and use 1 node.
&gt;&gt;
&gt;&gt; To do that,
&gt;&gt;
&gt;&gt; 1) Run 'riak attach' to attach to your Riak's node console
&gt;&gt; 2) Enter (including the period): riak\\_ensemble\\_manager:enable().
&gt;&gt; 3) Enter (including the period): riak\\_core\\_ring\\_manager:force\\_update().
&gt;&gt; 3) Detach from the console using: Ctrl-C a
&gt;&gt;
&gt;&gt; After either approach, re-check `riak-admin ensemble-status`. It may
&gt;&gt; take up to a minute for the consistency sub-system to be enabled.
&gt;&gt;
&gt;&gt; If you haven't already, please take a look at the temporary (until we
&gt;&gt; finish updating docs.basho.com) strong consistency related
&gt;&gt; documentation (linked from the 2.0 RC1 release notes) here:
&gt;&gt; https://github.com/basho/riak\\_ensemble/blob/wip/riak-2.0-user-docs/riak\\_consistent\\_user\\_docs.md
&gt;&gt;
&gt;&gt; Regards,
&gt;&gt; Joe
&gt;&gt;
&gt;&gt; On Mon, Jul 28, 2014 at 3:05 PM, Jason W  wrote:
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; I am trying out 2.0 w/ just one local node, created a strongly consistent
&gt;&gt;&gt; bucket type. But keep getting below exception. If I just use the default
&gt;&gt;&gt; bucket type, everything works fine. Here is the bucket type detail with
&gt;&gt;&gt; consistency bit on.
&gt;&gt;&gt;
&gt;&gt;&gt; young\\_vclock: 20
&gt;&gt;&gt; w: quorum
&gt;&gt;&gt; small\\_vclock: 50
&gt;&gt;&gt; rw: quorum
&gt;&gt;&gt; r: quorum
&gt;&gt;&gt; pw: 0
&gt;&gt;&gt; precommit: []
&gt;&gt;&gt; pr: 0
&gt;&gt;&gt; postcommit: []
&gt;&gt;&gt; old\\_vclock: 86400
&gt;&gt;&gt; notfound\\_ok: true
&gt;&gt;&gt; n\\_val: 1
&gt;&gt;&gt; linkfun: {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}
&gt;&gt;&gt; last\\_write\\_wins: false
&gt;&gt;&gt; dw: quorum
&gt;&gt;&gt; dvv\\_enabled: true
&gt;&gt;&gt; chash\\_keyfun: {riak\\_core\\_util,chash\\_std\\_keyfun}
&gt;&gt;&gt; big\\_vclock: 50
&gt;&gt;&gt; basic\\_quorum: false
&gt;&gt;&gt; allow\\_mult: true
&gt;&gt;&gt; consistent: true
&gt;&gt;&gt; active: true
&gt;&gt;&gt; claimant: 'riak@0.0.0.0'
&gt;&gt;&gt;
&gt;&gt;&gt; Here is the java code
&gt;&gt;&gt;
&gt;&gt;&gt; List addresses = new LinkedList();
&gt;&gt;&gt;
&gt;&gt;&gt; addresses.add("172.16.0.254");
&gt;&gt;&gt;
&gt;&gt;&gt; RiakClient riakClient = RiakClient.newClient(addresses);
&gt;&gt;&gt;
&gt;&gt;&gt; try {
&gt;&gt;&gt;
&gt;&gt;&gt; Location wildeGeniusQuote = new Location(new
&gt;&gt;&gt; Namespace("strongly\\_consistent2", "sample"), emp.getId());
&gt;&gt;&gt;
&gt;&gt;&gt; BinaryValue text =
&gt;&gt;&gt; BinaryValue.create(objectMapper.writeValueAsBytes(sampleObj));
&gt;&gt;&gt;
&gt;&gt;&gt; RiakObject obj = new RiakObject()
&gt;&gt;&gt;
&gt;&gt;&gt; .setContentType("text/plain")
&gt;&gt;&gt;
&gt;&gt;&gt; .setValue(text);
&gt;&gt;&gt;
&gt;&gt;&gt; StoreValue store = new
&gt;&gt;&gt; StoreValue.Builder(obj).withLocation(wildeGeniusQuote)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.ASIS, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.DW, new Quorum(1))
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.IF\\_NONE\\_MATCH, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.IF\\_NOT\\_MODIFIED, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.PW, new Quorum(1))
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.N\\_VAL, 1)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.RETURN\\_BODY, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.RETURN\\_HEAD, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.SLOPPY\\_QUORUM, true)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.TIMEOUT, 1000)
&gt;&gt;&gt;
&gt;&gt;&gt; .withOption(Option.W, new Quorum(1))
&gt;&gt;&gt;
&gt;&gt;&gt; .build();
&gt;&gt;&gt;
&gt;&gt;&gt; riakClient.execute(store);
&gt;&gt;&gt;
&gt;&gt;&gt; } catch (Exception e) {
&gt;&gt;&gt;
&gt;&gt;&gt; e.printStackTrace();
&gt;&gt;&gt;
&gt;&gt;&gt; return null;
&gt;&gt;&gt;
&gt;&gt;&gt; }
&gt;&gt;&gt;
&gt;&gt;&gt; Am I still missing something? Thanks.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Caused by: com.basho.riak.client.core.netty.RiakResponseException:
&gt;&gt;&gt; unavailable
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:52)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:155)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.handler.codec.ByteToMessageCodec.channelRead(ByteToMessageCodec.java:108)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:785)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:116)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:494)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:461)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:378)
&gt;&gt;&gt;
&gt;&gt;&gt; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:350)
&gt;&gt;&gt;
&gt;&gt;&gt; at
&gt;&gt;&gt; io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:101)
&gt;&gt;&gt;
&gt;&gt;&gt; ... 1 more
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Joseph Blomstedt 
&gt;&gt; Principal Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://www.basho.com/
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com



-- 
Joseph Blomstedt 
Principal Engineer
Basho Technologies, Inc.
http://www.basho.com/

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

