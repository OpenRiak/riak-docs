---
title: "Re: Corrupted Erlang binary term inside LevelDB"
description: ""
project: community
lastmod: 2013-07-25T13:34:56-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11758"
mailinglist_parent_id: "msg11757"
author_name: "Vladimir Shabanov"
project_section: "mailinglistitem"
sent_date: 2013-07-25T13:34:56-07:00
---


Good. Will wait for doctor.

A month ago I mailed about segmentation fault
http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2013-June/012245.html
After looking at core dumps you have found this problem with CRC checks
being skipped. I enabled paranoid\\_checks and got my node up an running.

I've also found that lost/BLOCKS.bad sometimes appears in partitions and
have sent you these blocks for further analysis.

It's very interesting why corrupted data appears in the first place. Nodes
didn't crashed, hardware didn't failed. As I mentioned previously all my
machines are with ECC memory and Riak data is kept on ZFS filesystem (which
also checks CRC for all the data and doesn't report any CRC errors). So it
looks that data is somehow corrupted by Riak itself.

lost/BLOCKS.bad are usually small 2-8kb and appears very infrequently (once
a week, once a month or never for many partitions). I found these
BLOCKS.bad in both data/leveldb and data/anti\\_entropy. So I have suspicion
that there is a bug in LevelDB.

Looking at LOGs they are created during compactions:
"Moving corrupted block to lost/BLOCKS.bad (size 2393)"
but there is no more information. What kind of block is it, where it was
found.

Is it possible to somehow find source of those BLOCKS.bad files? I'm
building Riak from sources, maybe it's possible to enable some additional
logging to find what these BLOCKS.bad are?


2013/7/25 Matthew Von-Maszewski 

&gt; Vladimir,
&gt;
&gt; I can explain what happened, but not how to correct the problem. The
&gt; gentleman that can walk you through a repair is tied up on another project,
&gt; but he intends to respond as soon as he is able.
&gt;
&gt; We recently discovered / realized that Google's leveldb code does not
&gt; check the CRC of each block rewritten during a compaction. This means that
&gt; blocks with bad CRCs get read without being flagged as bad, then rewritten
&gt; to a new file with a new, valid CRC. The corruption is now hidden.
&gt;
&gt; A more thorough discussion of the problem is found here:
&gt;
&gt; https://github.com/basho/leveldb/wiki/mv-verify-compactions
&gt;
&gt;
&gt; We added code to the 1.3.2 and 1.4 Riak releases to have the block CRC
&gt; checked during both read (Get) requests and compaction rewrites. This
&gt; prevents future corruption hiding. Unfortunately, it does NOTHING for
&gt; blocks already corrupted and rewritten with valid CRCs. You are
&gt; encountering this latter condition. We have a developer advocate / client
&gt; services person that has walked others through a fix via the Riak data
&gt; replicas …
&gt;
&gt; … please hold and the doctor will be with you shortly.
&gt;
&gt; Matthew
&gt;
&gt;
&gt; On Jul 24, 2013, at 9:39 PM, Vladimir Shabanov 
&gt; wrote:
&gt;
&gt; Hello,
&gt;
&gt; Recently I've started expanding my Riak cluster and found that handoffs
&gt; were continuously retried for one partition.
&gt;
&gt; Here are logs from two nodes
&gt; https://gist.github.com/vshabanov/41282e622479fbe81974
&gt;
&gt; The most interesting parts of logs are
&gt; "Handoff receiver for partition ... exited abnormally after processing
&gt; 2860338 objects: {{badarg,[{erlang,binary\\_to\\_term,..."
&gt; and
&gt; "bad argument in call to erlang:binary\\_to\\_term(&lt;&lt;131,104,...."
&gt;
&gt; Both nodes are running Riak 1.3.2 (old one was running 1.3.1 previously).
&gt;
&gt;
&gt; When I've printed corrupted binary string I found that it corresponds to
&gt; one value.
&gt;
&gt; When I've tried to "get" it, it was read OK but node with corrupted value
&gt; shown the same binary\\_to\\_term error.
&gt;
&gt; When I've tried to delete corrupted value I've got timeout.
&gt;
&gt;
&gt; I'm running machines with ECC memory and ZFS filesystem (which doesn't
&gt; report any checksum failures) so I doubt data was silently corrupted on
&gt; disk.
&gt;
&gt; LOG from corresponding LevelDB partition doesn't show any errors. But
&gt; there is a lost/BLOCKS.bad file in this partition (7kb, created more than a
&gt; month ago and looks like it doesn't contain corrupted value).
&gt;
&gt; At the moment I've stopped handoffs using "risk-admin transfer-limit 0".
&gt;
&gt; Why the value was corrupted? It there any way to remove it or fix it?
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

