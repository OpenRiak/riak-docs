---
title: "Re: RiakCS poor s3 upload speeds 2MB/s"
description: ""
project: community
lastmod: 2015-01-28T19:36:24-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15608"
mailinglist_parent_id: "msg15537"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2015-01-28T19:36:24-08:00
---


I turned the triggers and thresholds down, to:

 {max\\_file\\_size, 805306368}, %% 768 MB
 {dead\\_bytes\\_merge\\_trigger, 134217728}, %% dead bytes &gt; 128 MB
 {dead\\_bytes\\_threshold, 33554432} %% dead bytes &gt; 32 MB

And restarted nodes; however after 24 hours, disk utilisation remains the same.
ie. For about 6GB of files in CS, 600GB is on disk.
(Previously, when we had &gt;100 GB in CS, we had terabytes on disk)

I do wonder if we hit some kind of issue with Riak CS earlier in the
cluster's life, and have somehow ended up with a lot of "dead" bytes
in there.
This is just data stored by Riak CS, so it should take responsibility
for siblings and their resolution, yes?

If I write something to download files and then re-upload them again,
to the same path, would that cause Riak CS to fix up any issues around
siblings or duplicately-stored data?

Cheers,
Toby

On 22 January 2015 at 03:20, Luke Bakken  wrote:
&gt; You should be able to help with disk usage by "turning down" the
&gt; trigger and threshold values described here:
&gt;
&gt; http://docs.basho.com/riak/latest/ops/advanced/backends/bitcask/
&gt;
&gt; Your cluster will merge more data which should help with disk usage.
&gt; If your typical use is to create and delete objects frequently, this
&gt; will help.
&gt;
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt;
&gt; On Wed, Jan 21, 2015 at 4:40 AM, Toby Corkindale  wrote:
&gt;&gt; On 21 January 2015 at 15:22, Luke Bakken  wrote:
&gt;&gt;&gt; Hi Toby -
&gt;&gt;&gt;
&gt;&gt;&gt; Are you using the stock bitcask configuration for merging?
&gt;&gt;
&gt;&gt; Hi Luke,
&gt;&gt; Yes, pretty much.
&gt;&gt;
&gt;&gt;&gt; On Tue, Jan 20, 2015 at 5:07 PM, Toby Corkindale  wrote:
&gt;&gt;&gt;&gt; Hi Kota,
&gt;&gt;&gt;&gt; I had a bit of an off-list chat about this a while ago, plus continued
&gt;&gt;&gt;&gt; to investigate locally, and eventually achieved some faster speeds,
&gt;&gt;&gt;&gt; around 15MByte/sec writes.
&gt;&gt;&gt;&gt; Things that were changed:
&gt;&gt;&gt;&gt; \\* Adjusted Riak CS GC to be spread out over the cluster much more.
&gt;&gt;&gt;&gt; \\* Tweaked up the put buffers and concurrency further
&gt;&gt;&gt;&gt; \\* Moved most of the files out of CS and into Amazon S3+Glacier
&gt;&gt;&gt;&gt; \\* Switched from nginx to haproxy
&gt;&gt;&gt;&gt; \\* simplified firewalling for internal clients
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Each one of those changes made a small to modest improvement, but
&gt;&gt;&gt;&gt; overall combined to make a quite noticeable improvement.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I did notice something odd though -- despite moving most of the data
&gt;&gt;&gt;&gt; out of the cluster, the disk-space-in-use by Riak is still very large
&gt;&gt;&gt;&gt; compared to the amount stored. I mean, we moved more than 90% of the
&gt;&gt;&gt;&gt; data out of the cluster, yet the actual disk space used only halved.
&gt;&gt;&gt;&gt; For every gigabyte of file stored in CS, dozens of gigabytes are
&gt;&gt;&gt;&gt; actually on disk!
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Either the garbage collection algorithm is very, very lazy, or somehow
&gt;&gt;&gt;&gt; something has gone a bit wrong in the past, which might have explained
&gt;&gt;&gt;&gt; part of the performance problems.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; We're going to look at redeploying a new, fresh cluster based on Riak
&gt;&gt;&gt;&gt; 2 in the not too distant future, once Riak CS looks like it's approved
&gt;&gt;&gt;&gt; for use there, and maybe that'll clear all of this up.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Toby



-- 
Turning and turning in the widening gyre
The falcon cannot hear the falconer
Things fall apart; the center cannot hold
Mere anarchy is loosed upon the world

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

