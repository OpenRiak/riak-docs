---
title: "Re: setting n_val"
description: ""
project: community
lastmod: 2013-06-10T12:40:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11246"
mailinglist_parent_id: "msg11243"
author_name: "Alexander Ilyin"
project_section: "mailinglistitem"
sent_date: 2013-06-10T12:40:34-07:00
---


Dmitri,

thanks a lot for such a comprehensive answer!
I actually can afford some downtime but retries is not an option for me due
to response time requirements.
Of course we're going to add nodes in the future but for now we have to
deal with what we have.

On 10 June 2013 20:42, Dmitri Zagidulin  wrote:

&gt; Alexander,
&gt;
&gt; Your question about n\\_val on a one-node server is very valid (and also the
&gt; question of, so how do you migrate to a larger n\\_val size when you grow
&gt; your cluster).
&gt;
&gt; As an aside -- as John mentioned, Riak is designed from the ground up to
&gt; be run on multi-node clusters, so you have to keep that in mind when
&gt; choosing to run on just one node (when you're a startup on a budget, and
&gt; just testing out an application, etc), in terms of expected performance.
&gt;
&gt; Anyways, you have two options:
&gt;
&gt; 1) Start with the eventual n\\_val in mind (n=3, or n=2 as in your case) and
&gt; live with slow performance on a single node. (The upside is - no migration
&gt; required when adding new nodes, as the extra replicas will be moved to the
&gt; appropriate new machines).
&gt;
&gt; 2) Start with n\\_val=1 on a single node. The benefit of this is - faster
&gt; performance (less replicas to deal with that don't help when you're on one
&gt; node). The drawback is - you need to have some sort of migration strategy
&gt; when expanding your Riak deployment to more nodes.
&gt; It doesn't have to be complicated, but you will have to deal with the fact
&gt; that, if you have a set of data with n=1, and then increase n to 2 in the
&gt; app config when you add a new node, half of the vnodes are going to be
&gt; missing data for any given request. This is not disastrous, but you do need
&gt; to either rely on read-repair to create the missing replicas, or you need
&gt; to do it yourself.
&gt; Here are the options as I see it:
&gt;
&gt; a) If you can afford downtime when adding a new cluster, you could back up
&gt; the contents of your one-node cluster, then add the new node & up n\\_val to
&gt; 2. And then restore to the new cluster. The writes from the restore are
&gt; going to create the new number of replicas (n\\_val=2). You can you logical
&gt; backup tools like 'riak-admin backup' or Riak Data Migrator. (Backing up
&gt; and restoring the data directory won't work, for adding a new node).
&gt;
&gt; b) You can add retries to your application logic. If you get a Not Found
&gt; (and you know that the value is supposed to be there), you can re-try the
&gt; GET. (After the first get and a 404, read-repair takes place to fill in
&gt; missing values, so the second read should be fine).
&gt;
&gt; c) If you're on 1.3+ and have Active Anti-Entropy enabled, you can
&gt; increase n\\_val to 2, and wait for AAE to fill in the missing replicas (this
&gt; should probably still be paired with option b, as you'll need to retry some
&gt; reads while it's working).
&gt;
&gt; The few times that I've built single-node apps (during hackathons, etc), I
&gt; usually go with option 2 (a), and backup/restore the data. But your use
&gt; case requirements may difer.
&gt;
&gt; Dmitri
&gt;
&gt;
&gt;
&gt; On Mon, Jun 10, 2013 at 12:01 PM, Alexander Ilyin 
&gt; wrote:
&gt;
&gt;&gt; Hi all,
&gt;&gt;
&gt;&gt; I have a question regarding setting the n\\_val.
&gt;&gt; In the documentation (
&gt;&gt; http://docs.basho.com/riak/latest/tutorials/fast-track/Tunable-CAP-Controls-in-Riak/)
&gt;&gt; it is stated that:
&gt;&gt;
&gt;&gt; n\\_val must be greater than 0 and less than or equal to the number of
&gt;&gt; actual nodes in your cluster to get all the benefits of replication.
&gt;&gt; And, we advise against modifying the n\\_val of a bucket after its initial
&gt;&gt; creation as this may result in failed reads because the new
&gt;&gt; value may not be replicated to all the appropriate partitions.
&gt;&gt;
&gt;&gt; But this seems contradictory to me. Which value I have to set if I'm
&gt;&gt; setting up one node right now but planning to add second one later?
&gt;&gt; Setting n\\_val=2 means this value will be greater than actual number of
&gt;&gt; nodes. But setting n\\_val=1 is also not advisable since
&gt;&gt; I will have to change it later to n\\_val=2 (I'm planning to have two
&gt;&gt; replicas in the end).
&gt;&gt;
&gt;&gt; I'm also concerned about the performance in case of one node and n\\_val=2.
&gt;&gt; Will it degrade since both replicas are stored on the same server?
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

