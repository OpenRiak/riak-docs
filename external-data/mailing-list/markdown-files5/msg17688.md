---
title: "Re: enotconn error"
description: ""
project: community
lastmod: 2016-10-12T04:52:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17688"
mailinglist_parent_id: "msg17645"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-10-12T04:52:23-07:00
---


Travis -

What are the client failures you are seeing? What Riak client library
are you using, and are you using the PB or HTTP interface to Riak?

The error message you provided indicates that the ping request
returned from Riak after haproxy closed the socket for the request.
One cause would be very high server load causing timeouts.
--
Luke Bakken
Engineer
lbak...@basho.com


On Wed, Sep 14, 2016 at 7:23 AM, Travis Kirstine
 wrote:
&gt; Hi all,
&gt;
&gt;
&gt;
&gt; I’m using haproxy with a riak 2.1.4 in a 5 node cluster. I’m getting fairly
&gt; consistent enotconn errors in riak which happen to coincide with client
&gt; failures. We’ve setup haproxy as recommended
&gt; (https://gist.github.com/gburd/1507077) see below. I’m running a leveldb
&gt; backend with 9 GB max memory (I can go higher if needed). I’m not sure at
&gt; this point if I have a network issue or leveldb / riak issue.
&gt;
&gt;
&gt;
&gt; 2016-09-14 08:10:16 =CRASH REPORT====
&gt;
&gt; crasher:
&gt;
&gt; initial call: mochiweb\\_acceptor:init/3
&gt;
&gt; pid: &lt;0.28104.442&gt;
&gt;
&gt; registered\\_name: []
&gt;
&gt; exception error:
&gt; {function\\_clause,[{webmachine\\_request,peer\\_from\\_peername,[{error,enotconn},{webmachine\\_request,{wm\\_reqstate,#Port&lt;0.6539192&gt;,[],undefined,undefined,undefined,{wm\\_reqdata,'GET',http,{1,0},"defined\\_in\\_wm\\_req\\_srv\\_init","defined\\_in\\_wm\\_req\\_srv\\_init",defined\\_on\\_call,defined\\_in\\_load\\_dispatch\\_data,"/ping","/ping",[],defined\\_in\\_load\\_dispatch\\_data,"defined\\_in\\_load\\_dispatch\\_data",500,1073741824,67108864,[],[],{0,nil},not\\_fetched\\_yet,false,{0,nil},&lt;&lt;&gt;&gt;,follow\\_request,undefined,undefined,[]},undefined,undefined,undefined}}],[{file,"src/webmachine\\_request.erl"},{line,150}]},{webmachine\\_request,get\\_peer,1,[{file,"src/webmachine\\_request.erl"},{line,124}]},{webmachine,new\\_request,2,[{file,"src/webmachine.erl"},{line,69}]},{webmachine\\_mochiweb,loop,2,[{file,"src/webmachine\\_mochiweb.erl"},{line,49}]},{mochiweb\\_http,headers,5,[{file,"src/mochiweb\\_http.erl"},{line,96}]},{proc\\_lib,init\\_p\\_do\\_apply,3,[{file,"proc\\_lib.erl"},{line,239}]}]}
&gt;
&gt; ancestors: ['http://192.168.18.64:8098\\_mochiweb',riak\\_api\\_sup,&lt;0.319.0&gt;]
&gt;
&gt; messages: []
&gt;
&gt; links: [&lt;0.325.0&gt;,#Port&lt;0.6539192&gt;]
&gt;
&gt; dictionary: []
&gt;
&gt; trap\\_exit: false
&gt;
&gt; status: running
&gt;
&gt; heap\\_size: 987
&gt;
&gt; stack\\_size: 27
&gt;
&gt; reductions: 963
&gt;
&gt; neighbours:
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; # haproxy.cfg
&gt;
&gt; global
&gt;
&gt; log 127.0.0.1 local2 info
&gt;
&gt; chroot /var/lib/haproxy
&gt;
&gt; pidfile /var/run/haproxy.pid
&gt;
&gt; maxconn 256000
&gt;
&gt; user haproxy
&gt;
&gt; group haproxy
&gt;
&gt; spread-checks 5
&gt;
&gt; daemon
&gt;
&gt; quiet
&gt;
&gt; stats socket /var/lib/haproxy/stats
&gt;
&gt; defaults
&gt;
&gt; log global
&gt;
&gt; option httplog
&gt;
&gt; option dontlognull
&gt;
&gt; option redispatch
&gt;
&gt; timeout connect 5000
&gt;
&gt; maxconn 256000
&gt;
&gt;
&gt;
&gt; frontend main \\*:80
&gt;
&gt; mode http
&gt;
&gt; acl url\\_static path\\_beg -i /static /images /javascript
&gt; /stylesheets
&gt;
&gt; acl url\\_static path\\_end -i .jpg .gif .png .css .js
&gt;
&gt;
&gt;
&gt; backend static
&gt;
&gt; balance roundrobin
&gt;
&gt; server static 127.0.0.1:4331 check
&gt;
&gt;
&gt;
&gt; backend app
&gt;
&gt; mode http
&gt;
&gt; balance roundrobin
&gt;
&gt; server wmts1riak 192.168.18.72:80 check
&gt;
&gt; server wmts2riak 192.168.18.73:80 check
&gt;
&gt;
&gt;
&gt; backend riak\\_rest\\_backend
&gt;
&gt; mode http
&gt;
&gt; balance roundrobin
&gt;
&gt; option httpchk GET /ping
&gt;
&gt; option httplog
&gt;
&gt; server riak1 192.168.18.64:8098 weight 1 maxconn 1024 check
&gt;
&gt; server riak2 192.168.18.65:8098 weight 1 maxconn 1024 check
&gt;
&gt; server riak3 192.168.18.66:8098 weight 1 maxconn 1024 check
&gt;
&gt; server riak4 192.168.18.67:8098 weight 1 maxconn 1024 check
&gt;
&gt; server riak5 192.168.18.68:8098 weight 1 maxconn 1024 check
&gt;
&gt;
&gt;
&gt; frontend riak\\_rest
&gt;
&gt; bind \\*:8098
&gt;
&gt; mode http
&gt;
&gt; option contstats
&gt;
&gt; default\\_backend riak\\_rest\\_backend
&gt;
&gt;
&gt;
&gt; backend riak\\_protocol\\_buffer\\_backend
&gt;
&gt; balance leastconn
&gt;
&gt; mode tcp
&gt;
&gt; option tcpka
&gt;
&gt; option srvtcpka
&gt;
&gt; server riak1 192.168.18.64:8087 weight 1 maxconn 1024 check
&gt;
&gt; server riak2 192.168.18.65:8087 weight 1 maxconn 1024 check
&gt;
&gt; server riak3 192.168.18.66:8087 weight 1 maxconn 1024 check
&gt;
&gt; server riak4 192.168.18.67:8087 weight 1 maxconn 1024 check
&gt;
&gt; server riak5 192.168.18.68:8087 weight 1 maxconn 1024 check
&gt;
&gt;
&gt;
&gt; frontend riak\\_protocol\\_buffer
&gt;
&gt; bind \\*:8087
&gt;
&gt; mode tcp
&gt;
&gt; option tcplog
&gt;
&gt; option contstats
&gt;
&gt; mode tcp
&gt;
&gt; option tcpka
&gt;
&gt; option srvtcpka
&gt;
&gt; default\\_backend riak\\_protocol\\_buffer\\_backend
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

