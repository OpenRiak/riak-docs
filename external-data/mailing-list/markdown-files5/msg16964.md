---
title: "Re: Riak-S2 javascript aws-sdk failing on multi-part uploads"
description: ""
project: community
lastmod: 2016-01-14T06:33:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16964"
mailinglist_parent_id: "msg16955"
author_name: "Shunichi Shinohara"
project_section: "mailinglistitem"
sent_date: 2016-01-14T06:33:27-08:00
---


Hi John,

I tested Multipart Upload with aws-sdk-js with the patch you
mentioned, against riak\\_cs (s2),
upload finished without errors up to 1GB object. The environment is
all local on my laptop,
so latency is small. The script I used is in [1].

As Luke mentioned, HAProxy would be the point to be investigated first.
Or, if it's possible to get packet capture, by finding some wrong TCP
packet, like
RST or premature (from the point of HTTP) FIN, one can identify who
closes TCP connection
actively. In this case, packet should be captured on client box,
HAProxy box and riak cs box.

[1] https://gist.github.com/shino/ac7d56398557fb936899

Thanks,
Shino


2016-01-14 8:51 GMT+09:00 Luke Bakken :
&gt; Hi John,
&gt;
&gt; Thanks for the info. I'm very curious to see what's in the haproxy
&gt; logs with regard to TCP.
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Wed, Jan 13, 2016 at 3:50 PM, John Fanjoy  wrote:
&gt;&gt; Luke,
&gt;&gt;
&gt;&gt; As a test I’ve already increased all timeouts to 5 minutes but the failure 
&gt;&gt; occurs within under 1 minute so it doesn’t appear to be timeout related. I 
&gt;&gt; change the logs to tcplog tomorrow and let you know if I find anything.
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt;
&gt;&gt; John Fanjoy
&gt;&gt; Systems Engineer
&gt;&gt; jfan...@inetu.net
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On 1/13/16, 6:05 PM, "Luke Bakken"  wrote:
&gt;&gt;
&gt;&gt;&gt;haproxy ships with some "short" default timeouts. If CyberDuck is able
&gt;&gt;&gt;to upload these files faster than aws-sdk, it may be doing so within
&gt;&gt;&gt;the default haproxy timeouts.
&gt;&gt;&gt;
&gt;&gt;&gt;You can also look at haproxy's log to see if you find any TCP
&gt;&gt;&gt;connections that it has closed.
&gt;&gt;&gt;--
&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;Engineer
&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;On Wed, Jan 13, 2016 at 3:02 PM, John Fanjoy  wrote:
&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I may be able to do that. The only problem is without haproxy I have no 
&gt;&gt;&gt;&gt; way to inject CORS headers which the browser requires, but I may be able 
&gt;&gt;&gt;&gt; to write up small nodejs app to get past that and see if it is somehow 
&gt;&gt;&gt;&gt; related to haproxy. The fact that these errors are not present when using 
&gt;&gt;&gt;&gt; Cyberduck which is also talking to haproxy leads me to believe that’s not 
&gt;&gt;&gt;&gt; the cause, but it’s definitely worth testing.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 1/13/16, 5:55 PM, "Luke Bakken"  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;John -
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;The following error indicates that the connection was unexpectedly
&gt;&gt;&gt;&gt;&gt;closed by something outside of Riak while the chunk is uploading:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;{badmatch,{error,closed}}
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;Is it possible to remove haproxy to test using the the aws-sdk?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;That is my first thought as to the cause of this issue, especially
&gt;&gt;&gt;&gt;&gt;since writing to S3 works with the same code.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;--
&gt;&gt;&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;&gt;&gt;Engineer
&gt;&gt;&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;On Wed, Jan 13, 2016 at 2:46 PM, John Fanjoy  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Yes on both parts. To confirm cyberduck was using multi-part I actually 
&gt;&gt;&gt;&gt;&gt;&gt; tailed the console.log while it was uploading the file, and it uploaded 
&gt;&gt;&gt;&gt;&gt;&gt; the file in approx. 40 parts. Afterwards the parts were reassembled as 
&gt;&gt;&gt;&gt;&gt;&gt; you would expect. The AWS-SDK for javascript has an object called 
&gt;&gt;&gt;&gt;&gt;&gt; ManagedUpload which automatically switches to multi-part when the input 
&gt;&gt;&gt;&gt;&gt;&gt; is larger than the maxpartsize (default 5mb). I have confirmed that it 
&gt;&gt;&gt;&gt;&gt;&gt; is splitting the files up, but so far I’ve only ever seen one part get 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded before the others failed at which point it removes 
&gt;&gt;&gt;&gt;&gt;&gt; the upload (DELETE call) automatically. I also verified that the 
&gt;&gt;&gt;&gt;&gt;&gt; javascript I have in place does work with an actual AWS S3 bucket to 
&gt;&gt;&gt;&gt;&gt;&gt; rule out coding issues on my end and the same &gt;400mb file was 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded to the bucket I created there without issue.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; A few things worth mentioning that I missed before. I am running riak-s2 
&gt;&gt;&gt;&gt;&gt;&gt; behind haproxy. Haproxy is handling ssl and enabling CORS for browser 
&gt;&gt;&gt;&gt;&gt;&gt; based requests. I have tested smaller files (~4-5mb) and GET requests 
&gt;&gt;&gt;&gt;&gt;&gt; using the browser client and everything works with my current haproxy 
&gt;&gt;&gt;&gt;&gt;&gt; configuration, but the larger files are failing, usually after 1 part is 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded. I can also list bucket contents and delete 
&gt;&gt;&gt;&gt;&gt;&gt; existing contents. The only feature that is not working appears to be 
&gt;&gt;&gt;&gt;&gt;&gt; the multi-part uploads. We are running centOS 7 (kernel version 
&gt;&gt;&gt;&gt;&gt;&gt; 3.10.0-327.4.4.el7.x86\\_64). Please let me know if you have any further 
&gt;&gt;&gt;&gt;&gt;&gt; questions.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

