---
title: "Re: The best (fastest) way to delete/clear a bucket [python]"
description: ""
project: community
lastmod: 2014-05-19T10:02:25-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14236"
mailinglist_parent_id: "msg14233"
author_name: "Dmitri Zagidulin"
project_section: "mailinglistitem"
sent_date: 2014-05-19T10:02:25-07:00
---


Ah, yes, you bring up a good point. (And, that's another subtlety to keep
in mind, with Option #1).

Tombstones are definitely something to keep in mind, when deleting unit
test data.
As you mentioned in your earlier question, if you're using default
delete\\_mode configuration ( 3 seconds ), it means that if you issue a
delete, a tombstone object is going to be written (and stick around for at
least 3 seconds), and unfortunately, it is going to show up as a false
positive on a List Keys call.

The easiest thing to try, in your case, is to set 'delete\\_mode' to
'immediate', restart the test cluster, and retest. With an immediate
delete, your second test with 10 keys should not take as long as the
previous delete with 10000 keys.




On Mon, May 19, 2014 at 11:46 AM, Paweł Królikowski wrote:

&gt; Hi Dmitri,
&gt;
&gt; Thanks a lot for the answer. Option #1 seems the best, but I have a follow
&gt; up question:
&gt;
&gt; - when do the deleted keys disappear from Riak: a part of my problem (have
&gt; not explained it correctly the first time), is that get\\_keys() returns keys
&gt; that no longer exist. So, I run a test with 10 000 keys, I remove them, it
&gt; takes Nseconds. I then follow with a test with 10 keys, but removing them
&gt; takes just as much time - I imagine it's because I'm going over that 10 000
&gt; keys again.
&gt;
&gt; This article seems relevant:
&gt; http://basho.com/riaks-config-behaviors-part-3/ - it seems like the
&gt; tombstones simply remain in my system indefinitely.
&gt;
&gt; --
&gt; Paweł
&gt;
&gt;
&gt; On 19 May 2014 15:32, Dmitri Zagidulin  wrote:
&gt;
&gt;&gt; Hi Pawel,
&gt;&gt;
&gt;&gt; There's basically three ways to clear data from Riak (for the purposes of
&gt;&gt; automated testing):
&gt;&gt;
&gt;&gt; 1. Iterate through the keys via get\\_keys(), and delete each one. This is
&gt;&gt; what you're currently doing, except you don't need to invoke if.exists().
&gt;&gt; if.exists() makes an additional API call to Riak, and it takes twice as
&gt;&gt; long as just calling delete() (and trapping a potential 404 doesn't exist
&gt;&gt; error).
&gt;&gt;
&gt;&gt; Advantages: Easy to understand, can be done entirely in code (without
&gt;&gt; invoking OS/shell commands).
&gt;&gt;
&gt;&gt; Disadvantages: It can get slow, for large data sets. Another subtle
&gt;&gt; disadvantage is that, as your app grows, it can get difficult to keep track
&gt;&gt; of which buckets you've created and need to be cleared.
&gt;&gt;
&gt;&gt; 2. Stop the Riak cluster, delete the riak data directory, and re-start.
&gt;&gt;
&gt;&gt; Advantages: Very fast, and you can be sure that you're deleting all
&gt;&gt; buckets.
&gt;&gt;
&gt;&gt; Disadvantages: Involves invoking OS/shell commands. This is fairly easy
&gt;&gt; if your Riak node is running on the same machine as your tests (and if it's
&gt;&gt; a single node). To delete the data directories of a multi-node cluster, now
&gt;&gt; you need to involve either a bash script that uses SSH to log in and
&gt;&gt; restart, or a coordination framework like Ansible.
&gt;&gt;
&gt;&gt; 3. Use an in-memory back end. (And to drop all data, just restart the
&gt;&gt; node(s)).
&gt;&gt;
&gt;&gt; Advantages: Same as #2 - fast, thorough.
&gt;&gt;
&gt;&gt; Disadvantages: Same as #2 (involves shell commands, potentially SSH etc).
&gt;&gt; In addition, since you're likely not going to be running your production
&gt;&gt; code on an in-memory back end, this method introduces a potential
&gt;&gt; environmental/functional difference between your testing and production
&gt;&gt; clusters.
&gt;&gt;
&gt;&gt; I generally use method #1 in my unit tests, and manually delete each key.
&gt;&gt;
&gt;&gt; Dmitri
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, May 19, 2014 at 8:53 AM, Paweł Królikowski wrote:
&gt;&gt;
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; For testing, I'd like to be able to throw a large number of data at Riak
&gt;&gt;&gt; (100k+ entries), check how it performed, change something in the
&gt;&gt;&gt; application, run the test again. I'd like to use the same data every time,
&gt;&gt;&gt; so, I'd like to clear the bucket between every test.
&gt;&gt;&gt;
&gt;&gt;&gt; The documentation (
&gt;&gt;&gt; http://docs.basho.com/riak/2.0.0beta1/dev/references/http/) says:
&gt;&gt;&gt;
&gt;&gt;&gt; \\*Delete Buckets\\*
&gt;&gt;&gt; There is no straightforward way to delete an entire Bucket. To delete
&gt;&gt;&gt; all the keys in a bucket, you’ll need to delete them all individually.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; So, I'm currently using something like:
&gt;&gt;&gt;
&gt;&gt;&gt; for k in r\\_bk.get\\_keys():
&gt;&gt;&gt; v = r\\_bk.get(k)
&gt;&gt;&gt; if v.exists:
&gt;&gt;&gt; r\\_bk.delete(v)
&gt;&gt;&gt;
&gt;&gt;&gt; The problem is that r\\_bk.get\\_keys() returns a lot of elements that don't
&gt;&gt;&gt; exist (tombstones?) and iterating over all of them takes time.
&gt;&gt;&gt;
&gt;&gt;&gt; Is that the way it's supposed to work? Or am I missing something?
&gt;&gt;&gt;
&gt;&gt;&gt; - I'm using default delete\\_mode configuration ( 3 seconds )
&gt;&gt;&gt; - I'm using Riak 2.0 alpha 19 with Python. ( there's a bug with strong
&gt;&gt;&gt; consistency in Beta1, cannot use it)
&gt;&gt;&gt; - changing the bucket name for every run seems .. impractical?
&gt;&gt;&gt;
&gt;&gt;&gt; Any advices welcomed,
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Paweł
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

