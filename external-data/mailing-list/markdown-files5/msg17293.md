---
title: "Re: How to increase Riak write performance for sequential	alpha-numeric keys"
description: ""
project: community
lastmod: 2016-05-05T06:30:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17293"
mailinglist_parent_id: "msg17292"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2016-05-05T06:30:17-07:00
---


CRDTs are all about mutation, why would you use a CRDT for immutable data? I 
think write-once is what you need.

On 5 May 2016, at 14:14, Sanket Agrawal  wrote:

&gt; Two questions about write-once bucket:
&gt; - is it useful from performance-perspective for immutable CRDTs as well? 
&gt; - If the objects are immutable, is map CRDT generally performant, compared to 
&gt; equivalent JSON with write-once property? Let us say map has 1-9 registers 
&gt; with about 2KB size total in string/number.
&gt; 
&gt; It seems to me there is no way to enforce key check before writing CRDTs (to 
&gt; enforce true immutability by making sure the new key doesn't exist already) 
&gt; as it is for key-value. We could tell Riak not to insert a key if it already 
&gt; exists for key-value objects. I don't know of any such mechanism for CRDTs.
&gt; 
&gt; I have immutable CRDTs with map type, allow\\_mult true, and lww false. I 
&gt; looked into "write-once" property before but couldn't figure out how to truly 
&gt; enforce it for CRDT.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Thu, May 5, 2016 at 8:51 AM, Matthew Von-Maszewski  
&gt; wrote:
&gt; Alex,
&gt; 
&gt; The successor to "last\\_write\\_wins" is the "write\\_once" bucket type. You can 
&gt; read about its characteristics and limitations here:
&gt; 
&gt; http://docs.basho.com/riak/kv/2.1.4/developing/app-guide/write-once/
&gt; 
&gt; This bucket type eliminates the Riak's typical read-before-write operation. 
&gt; Your experience with better performance by reversing the keys suggests to me 
&gt; that this bucket type might be what you need.
&gt; 
&gt; Also, I would be willing to review your general environment and particularly 
&gt; leveldb's actions. I would need you to run "riak-debug" on one of the 
&gt; servers then post the tar file someplace private such as dropbox. There 
&gt; might be other insights I can share based upon leveldb's actions and your 
&gt; physical server configuration.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; 
&gt;&gt; On May 5, 2016, at 8:32 AM, alexc155  wrote:
&gt;&gt; 
&gt;&gt; We're using Riak as a simple key value store and we're having write 
&gt;&gt; performance problems which we think is due to the format of our keys which 
&gt;&gt; we can't easily change because they're tied into different parts of the 
&gt;&gt; business and systems.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; We're not trying to do anything complicated with Riak: No solr, secondary 
&gt;&gt; indexes or map reducing - just simple keys to strings of around 10Kb of JSON.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; We've got upwards of 3 billion records to store so we've opted for LevelDb 
&gt;&gt; as the backend.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; It's a 3 node cluster running on 3 dedicated Ubuntu VMs each with 16 cpu 
&gt;&gt; cores and 12GB memory backed by SSDs on a 10Gb network.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Using basho bench we know that it's capable of speeds upwards of ​5000 rows 
&gt;&gt; per sec when using randomised keys, but the problem comes when we use our 
&gt;&gt; actual data.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; The keys are formatted using the following pattern:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; USC~1930~100000000~10000~001
&gt;&gt; USC~1930~100000000~10000~002
&gt;&gt; USC~1930~100000000~10000~003
&gt;&gt; USC~1930~100000000~10000~004
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Most of the long key stays the same with numbers at the end going up. (The 
&gt;&gt; "~" are changeable - we can set them to whatever character. They're just 
&gt;&gt; delimiters in the keys)
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Using these keys, write performance is a tenth of the speed at 400 rows per 
&gt;&gt; sec.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; We don't need to worry about different versions of the data so we've set the 
&gt;&gt; following in our bucket type:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; "allow\\_mult": false
&gt;&gt; "last\\_write\\_wins": true
&gt;&gt; "DW": 0
&gt;&gt; "n\\_val": 2
&gt;&gt; "w": 1
&gt;&gt; "r": 1
&gt;&gt; "basic\\_quorum": false
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On the riak servers we've set the ulimit to:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; riak soft nofile 32768
&gt;&gt; riak hard nofile 65536
&gt;&gt; 
&gt;&gt; 
&gt;&gt; and other settings like this:
&gt;&gt; 
&gt;&gt; 
&gt;&gt; ring\\_size = 128
&gt;&gt; protobuf.backlog = 1024
&gt;&gt; anti\\_entropy = passive
&gt;&gt; 
&gt;&gt; 
&gt;&gt; We're using the v2 .net client from basho to do the putting which runs in an 
&gt;&gt; API on 3 machines.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; We've checked all the usual bottlenecks: CPU, memory, network IO, disk IO 
&gt;&gt; and throttles on the Riak servers and windows API servers.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; As a kicker, if we reverse the keys e.g.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 100~00001~000000001~0391~CSU
&gt;&gt; speed goes up to over ​3000 rows, but that's a dirty kludge.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Can anyone explain why Riak doesn't like sequential alpha-numeric keys and 
&gt;&gt; what we can change to improve performance?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Thanks!
&gt;&gt; 
&gt;&gt; 
&gt;&gt; View this message in context: How to increase Riak write performance for 
&gt;&gt; sequential alpha-numeric keys
&gt;&gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

