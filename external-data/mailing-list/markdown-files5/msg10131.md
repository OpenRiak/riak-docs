---
title: "Re: Riak Java client 100% CPU"
description: ""
project: community
lastmod: 2013-02-14T09:23:35-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10131"
mailinglist_parent_id: "msg10130"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2013-02-14T09:23:35-08:00
---


Daniel -

Yes, sorry about that. This has been corrected in the current master
on github and version 1.1.0 of the client will be released today.
https://github.com/basho/riak-java-client/pull/212

Thanks!
Brian Roach

On Thu, Feb 14, 2013 at 9:31 AM, Daniel Iwan  wrote:
&gt; I see 100% CPU very regularly on one of the Riak client (v1.0.7) threads.
&gt; I think the place where it spins is connection reaper in RiakConnectionPool
&gt;
&gt; I looked at it briefly and it seems that when it finds first connection
&gt; using peek but that does not expired it can spin in tight while loop.
&gt; I guess second peek() should be outside if block?
&gt;
&gt; private synchronized void doStart() {
&gt; if (idleConnectionTTLNanos &gt; 0) {
&gt; idleReaper.scheduleWithFixedDelay(new Runnable() {
&gt; public void run() {
&gt; RiakConnection c = available.peek();
&gt; while (c != null) {
&gt; long connIdleStartNanos = c.getIdleStartTimeNanos();
&gt; if (connIdleStartNanos + idleConnectionTTLNanos &lt;
&gt; System.nanoTime()) {
&gt; if (c.getIdleStartTimeNanos() ==
&gt; connIdleStartNanos) {
&gt; // still a small window, but better than
&gt; locking
&gt; // the whole pool
&gt; boolean removed = available.remove(c);
&gt; if (removed) {
&gt; c.close();
&gt; permits.release();
&gt; }
&gt; }
&gt; c = available.peek();
&gt; }
&gt; }
&gt; }
&gt; }, idleConnectionTTLNanos, idleConnectionTTLNanos,
&gt; TimeUnit.NANOSECONDS);
&gt; }
&gt;
&gt; state = State.RUNNING;
&gt; }
&gt;
&gt;
&gt; Regards
&gt; Daniel Iwan
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

