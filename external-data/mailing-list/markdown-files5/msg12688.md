---
title: "Re: Deleting data in a map-reduce job"
description: ""
project: community
lastmod: 2013-10-17T23:13:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12688"
mailinglist_parent_id: "msg12580"
author_name: "Daniel Abrahamsson"
project_section: "mailinglistitem"
sent_date: 2013-10-17T23:13:41-07:00
---


Hi,

Does anyone have any experience with a similar setup?

We have resolved questions 4 and 5 - they occurred due to a firewall
misconfiguration, but I would still very much like to hear if there are any
drawbacks with deleting data in the map reduce job itself compared to just
collecting the keys and then deleting the data with the client.

Regards,
Daniel Abrahamsson


On Thu, Oct 10, 2013 at 11:14 AM, Daniel Abrahamsson &lt;
daniel.abrahams...@klarna.com&gt; wrote:

&gt; Hi, I've some questions regarding map-reduce jobs. The main one regards
&gt; deleting data in a map-reduce job.
&gt;
&gt; I have a map-reduce job that traverses an entire bucket to clean up
&gt; old/unusable data once a day. The deletion of objects is done in the
&gt; map-reduce job itself. Here is an example map-reduce job expressed as a
&gt; qfun explaining what I am doing:
&gt;
&gt; fun({error, notfound}, \\_, \\_) -&gt; [];
&gt; (O, \\_, Condition) -&gt;
&gt; Obj = case hd(riak\\_object:get\\_values(O)) of
&gt; &lt;&lt;&gt;&gt; -&gt; % Ignore tombstones
&gt; default\\_object\\_not\\_to\\_be\\_deleted()
&gt; Bin -&gt; binary\\_to\\_term(Bin)
&gt; end,
&gt; case should\\_be\\_deleted(Obj, Condition) of
&gt; false -&gt; [{total, 1}, {removed, 0}];
&gt; true -&gt;
&gt; Key = riak\\_object:key(O),
&gt; Bucket = riak\\_object:bucket(O),
&gt; {ok, Client} = riak:local\\_client(),
&gt; Client:delete(Bucket,Key),
&gt; [{total, 1}, {removed, 1}]
&gt; end
&gt; end.
&gt;
&gt; And now to the questions:
&gt; 1. I have noted that deleting data this way leaves the keys around if I do
&gt; a subsequent
&gt; list\\_keys() operation. They are pruned when I try to get the objects
&gt; and get {error, notfound}.
&gt; With this approach, will the keys ever be removed unless someone tries
&gt; to get them first?
&gt;
&gt; 2. Are there any other drawbacks with deleting data in the map-reduce job
&gt; itself, rather than
&gt; reading up the keys with the job, and the using the regular riak client
&gt; to delete the objects?
&gt;
&gt; 3. Handling of tombstones in map-reduce jobs is very poorly documented.
&gt; The approach above has worked for us. However, the approach feels very
&gt; akward with both an {error, notfound} clase and checking for an empty
&gt; binary as value. I know you can also check for the "X-Riak-Deleted" flag in
&gt; the metadata. Under what circumstances do the different values appear, and
&gt; most importantly, which is the recommended way of dealing with tombstones
&gt; in map-reduce jobs?
&gt;
&gt; Considering that we will have quite much data in our bucket, we run the
&gt; job during off-hours not to
&gt; disturb regular traffic. However, when we run the job we often get an
&gt; "error, disconnected" error after approximately 15 minutes, even if our
&gt; timeout is even greater than that. Running the job manually afterwards
&gt; usually takes just ~30 seconds.
&gt;
&gt; 4. Have anyone else experienced this with a "cold" database? We have not
&gt; yet configured all the tuning parameters reported by "riak diag", but will
&gt; do so soon. Might this have an effect in this case?
&gt;
&gt; 5. What does the "disconnected" message mean, considering that the timeout
&gt; value has not yet been reached?
&gt;
&gt; Regards,
&gt; Daniel Abrahamsson
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

