---
title: "Re: Exploring Riak, need to confirm throughput"
description: ""
project: community
lastmod: 2013-04-04T15:29:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10705"
mailinglist_parent_id: "msg10698"
author_name: "Matthew MacClary"
project_section: "mailinglistitem"
sent_date: 2013-04-04T15:29:23-07:00
---


PBC is certainly something I have on my list of things to explore.
Conceptually I am not sure if the speed gains from this protocol will be
apparent with large binary payloads. I thought that main speed gains were
from 1) more compact binary representation and 2) lower interpretation
overhead. In my situation I already have a largish binary payload that does
not need to be parsed. I could be wrong and may find that out as I explore
this further.

-Matt


On Thu, Apr 4, 2013 at 1:45 PM, Shuhao  wrote:

&gt; Just as a side note, you might want to retry the test with PBC. While I
&gt; have only did testings with &lt; 10kb documents, my tests indicates that PBC
&gt; is twice as fast as HTTP in almost all cases.
&gt;
&gt; Shuhao
&gt;
&gt;
&gt; On 13-04-04 04:14 PM, Matthew MacClary wrote:
&gt;
&gt;&gt; Thanks for the feedback. I made two changes to my test setup and saw
&gt;&gt; better
&gt;&gt; throughput:
&gt;&gt;
&gt;&gt; 1) Don't write to the same key over and over. Updating a key appears to be
&gt;&gt; a lot slower than creating a new key
&gt;&gt;
&gt;&gt; 2) I used parallel PUTs
&gt;&gt;
&gt;&gt; The throughput I was measuring before was about 26MB/s on localhost. With
&gt;&gt; these changes it went to around 200MB/s on a disk that can write at about
&gt;&gt; 480MB/s. That is more the type of performance I need for the data store we
&gt;&gt; have in mind. I am going to proceed with testing on 8 nodes with RAID0
&gt;&gt; drives.
&gt;&gt;
&gt;&gt; Here are some details of the testing I did if it will help others. I tried
&gt;&gt; the test with 1MB, 10MB, and 20MB binary data. I didn't notice a big
&gt;&gt; signal
&gt;&gt; with regard to larger objects slowing things down.
&gt;&gt;
&gt;&gt; wget
&gt;&gt; http://downloads.basho.com.s3-\\*\\*website-us-east-1.amazonaws.\\*\\*
&gt;&gt; com/riak/1.2/1.2.1/rhel/5/\\*\\*riak-1.2.1-1.el5.x86\\_64.rpm
&gt;&gt;
&gt;&gt; sudo rpm -Uvh riak-1.2.1-1.el5.x86\\_64.rpm
&gt;&gt; /usr/sbin/riak start
&gt;&gt; mkdir data-dir && cd data-dir
&gt;&gt; seq -w 0 100 | parallel dd if=/dev/zero of={}.10meg bs=8k count=1280
&gt;&gt; http\\_proxy= # donâ€™t contact proxy
&gt;&gt; time find . -name \\\\*.10meg | parallel -j8 -n1 wget --post-file {}
&gt;&gt; http://127.0.0.1:8098/riak/\\*\\*test1/{}
&gt;&gt;
&gt;&gt; During these tests I saw beam.smp jumping to 350-550 while watching %CPU
&gt;&gt; under top. When I was seeing slower thoughput beam.smp was using much less
&gt;&gt; CPU.
&gt;&gt;
&gt;&gt; Kind regards,
&gt;&gt;
&gt;&gt; -Matt
&gt;&gt;
&gt;&gt; On Wed, Apr 3, 2013 at 7:20 AM, Reid Draper  wrote:
&gt;&gt;
&gt;&gt; inline:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Apr 2, 2013, at 6:48 PM, Matthew MacClary &lt;
&gt;&gt;&gt; macclary@lifetime.oregonstate.\\*\\*edu &gt;
&gt;&gt;&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi all, I am new to this list. Thanks for taking the time to read my
&gt;&gt;&gt; questions! I just want to know if the data throughput I am seeing is
&gt;&gt;&gt; expected for the bitcask backend or if it is too low.
&gt;&gt;&gt;
&gt;&gt;&gt; I am doing the preliminary feasibility study to decide if we should
&gt;&gt;&gt; implement a Riak data store. Our application involves rendering chunks of
&gt;&gt;&gt; data that range in size from about 1MB-9MB or so. This rendering work is
&gt;&gt;&gt; CPU intensive so it is spread over a bunch of compute nodes which write
&gt;&gt;&gt; the
&gt;&gt;&gt; output into a data store.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Riak is not intended to store objects of this size, not at the moment
&gt;&gt;&gt; anyway. Riak CS [1], on the other hand, can store files up to several TB.
&gt;&gt;&gt; That being said, Riak CS may or may not have other qualities you desire.
&gt;&gt;&gt; It's a known issue [2] that the Riak object size limitations should be
&gt;&gt;&gt; better documented.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; After rendering, a second process consumes that data chunks from the data
&gt;&gt;&gt; store at a rate of about 480MB/s in a streaming configuration so there
&gt;&gt;&gt; is &gt;
&gt;&gt;&gt; 480MB/s of new data coming in at the same time the data is being read.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Is this a single-socket, or is there some concurrency here?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; My testing so far involves a one node cluster on a dev box. What I wanted
&gt;&gt;&gt; to show is that Riak writes were limited by the hard disk throughput. So
&gt;&gt;&gt; far I haven't seen writes to localhost come anywhere close to the hard
&gt;&gt;&gt; disk
&gt;&gt;&gt; throughput:
&gt;&gt;&gt;
&gt;&gt;&gt; $ MYFILE=/tmp/output.png
&gt;&gt;&gt; $ dd if=/dev/zero of=$MYFILE bs=8k count=256k
&gt;&gt;&gt; 262144+0 records in
&gt;&gt;&gt; 262144+0 records out
&gt;&gt;&gt; 2147483648 bytes (2.1 GB) copied, 4.48906 seconds, 478 MB/s
&gt;&gt;&gt; $ rm $MYFILE
&gt;&gt;&gt;
&gt;&gt;&gt; So the hard disk throughput is around 478MB/s for this simple write test.
&gt;&gt;&gt;
&gt;&gt;&gt; The next test I did was to load a 39MB binary file into my one node
&gt;&gt;&gt; cluster. I used a script to do 12 POSTs with curl and 12 POSTSs with
&gt;&gt;&gt; wget.
&gt;&gt;&gt;
&gt;&gt;&gt; curl --tcp-nodelay -XPOST http://${IP}:${PORT}/riak/\\*\\*test/file3 \\
&gt;&gt;&gt; -H "Content-Type:application/\\*\\*octet-stream" \\
&gt;&gt;&gt; --data-binary @${UPLOAD\\_FILE} \\
&gt;&gt;&gt; --write-out "%{speed\\_upload}\\n"
&gt;&gt;&gt;
&gt;&gt;&gt; wget --post-file ${UPLOAD\\_FILE} 
&gt;&gt;&gt; http://127.0.0.1:8098/riak/\\*\\*test/file1
&gt;&gt;&gt;
&gt;&gt;&gt; What I found was that I could get only about 26MB/s with this command
&gt;&gt;&gt; line
&gt;&gt;&gt; testing. Does this seam about right? Should I see an 18x slow down over
&gt;&gt;&gt; the
&gt;&gt;&gt; write speed of the disk drive?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Was this running the 24 (12 \\* 2) uploads in serial or parallel? With a
&gt;&gt;&gt; single-threaded workload, you're unlikely to get Riak to be able to
&gt;&gt;&gt; saturate a disk. Furthermore, there are design decisions in Riak at the
&gt;&gt;&gt; moment that make it less than optimal for single objects of 39MB.
&gt;&gt;&gt; Single-object high throughput (measured in MB) is more in the wheelhouse
&gt;&gt;&gt; of
&gt;&gt;&gt; Riak CS than Riak on it's own, which is primarily designed for
&gt;&gt;&gt; low-latency
&gt;&gt;&gt; and high-throughput (measured in ops/sec). One of the ways that Riak CS
&gt;&gt;&gt; achieves this on top of Riak is by introducing concurrency between the
&gt;&gt;&gt; end-user and Riak.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for your comments on my application and test approach!
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hope this helps,
&gt;&gt;&gt; Reid
&gt;&gt;&gt;
&gt;&gt;&gt; [1] 
&gt;&gt;&gt; http://docs.basho.com/riakcs/\\*\\*latest/
&gt;&gt;&gt; [2] 
&gt;&gt;&gt; https://github.com/basho/\\*\\*basho\\_docs/issues/256
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; -Matt
&gt;&gt;&gt;
&gt;&gt;&gt; ------------------------------\\*\\*-----------------
&gt;&gt;&gt; Dev Environment Details:
&gt;&gt;&gt; dev box running RHEL6.2, 12 cores, 48GB, 6Gb/s SAS 15k HD
&gt;&gt;&gt; Riak 1.2.1 from
&gt;&gt;&gt; http://downloads.basho.com.s3-\\*\\*website-us-east-1.amazonaws.\\*\\*
&gt;&gt;&gt; com/riak/1.2/1.2.1/rhel/5/\\*\\*riak-1.2.1-1.el5.x86\\_64.rpm
&gt;&gt;&gt; n\\_val=1
&gt;&gt;&gt; r=1
&gt;&gt;&gt; w=1
&gt;&gt;&gt; backend=bitcask
&gt;&gt;&gt;
&gt;&gt;&gt; Deploy Environment Details:
&gt;&gt;&gt; Node to node bandwidth &gt; 40Gb/s
&gt;&gt;&gt; similar config for node servers
&gt;&gt;&gt; n\\_val=3
&gt;&gt;&gt; r=1
&gt;&gt;&gt; w=1
&gt;&gt;&gt; backend=?
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\*\\*\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/\\*\\*mailman/listinfo/riak-users\\_\\*\\*lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\*\\*\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/\\*\\*mailman/listinfo/riak-users\\_\\*\\*lists.basho.com
&gt;&gt;
&gt;&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\*\\*\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/\\*\\*mailman/listinfo/riak-users\\_\\*\\*lists.basho.com
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

