---
title: "Re: Riak CS/Stanchion troubleshooting (Retrieval of user record)"
description: ""
project: community
lastmod: 2015-11-15T18:03:13-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16770"
mailinglist_parent_id: "msg16767"
author_name: "Kazuhiro Suzuki"
project_section: "mailinglistitem"
sent_date: 2015-11-15T18:03:13-08:00
---


Hi,

ha\\_proxy's timeout settings often causes disconnected errors on a Riak
CS deployment by high work load. termination\\_stat [1] in tcplog [2]
lets you know if timeout happens or not.

&gt; 2015-11-13 13:13:09.514 [error] 
&gt; &lt;0.11264.1387&gt;@riak\\_cs\\_wm\\_common:maybe\\_create\\_user:222 Retrieval of user 
&gt; record for s3 failed. Reason: disconnected

This means Riak CS failed to read a user data from Riak for
authentication due to a disconnected error.

&gt; Riak CS adds, removes, gets properties through Stanchion service. Am I right? 
&gt; I can't exactly understand where is my bottleneck - Riak, Riak CS or 
&gt; Stanchion.

Mainly Stanchion is only used to update/delete data of users and
buckets. To inspect a node, Riak S2/CS 2.1 introduced new metrics
including various latencies and counters, which help to identify
bottleneck.

&gt; When we need authenticated access for reading object from bucket do we need 
&gt; Stanchion? If not I can't understand why I had a lot of error during getting 
&gt; objects from Riak CS.

Authenticated access is always necessary but a read request of user
data for auth is issued from Riak CS to Riak directly, not through
Stanchion.

&gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion 
&gt; connectivity I need to restart Riak CS.

Riak CS 1.5.0 has connection pool leak problem [3]. You might hit the issue...

[1]: https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.5
[2]: https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.2.2
[3]: 
http://docs.basho.com/riakcs/latest/cookbooks/Riak-CS-Release-Notes/#Riak-CS-1-5-2

On Sat, Nov 14, 2015 at 2:04 AM, Vladyslav Zakhozhai
 wrote:
&gt;
&gt; Hello.
&gt;
&gt; I have Riak CS cluster with 18 nodes. On each node there is Riak CS and Riak
&gt; service and one Stanchion node.
&gt;
&gt; Versions:
&gt; Riak 1.4.12
&gt; Riak CS 1.5.0
&gt; Stanchion 1.5.0
&gt;
&gt; Riak CS and Riak allocated behind HAProxy balancers:
&gt;
&gt; WAN -&gt; HAProxy -&gt; Riak CS nodes -&gt; HAProxy -&gt; Riak nodes.
&gt; ans
&gt; Stanchion -&gt; HAProxy -&gt; Riak
&gt;
&gt; Today due a spike of traffic load (about 1000 rps) on the cluster 50% of
&gt; Riak CS returned HTTP 500 and 503 (querying /riak-cs/ping resource also was
&gt; not successful).
&gt;
&gt; In Riak CS logs I've seen the following messages:
&gt;
&gt; 2015-11-13 13:13:09.514 [error]
&gt; &lt;0.11264.1387&gt;@riak\\_cs\\_wm\\_common:maybe\\_create\\_user:222 Retrieval of user
&gt; record for s3 failed. Reason: disconnected
&gt;
&gt; In Riak CS logs I see the following:
&gt; 2015-11-13 17:31:52.995 [error] &lt;0.11254.6534&gt; Lager event handler
&gt; error\\_logger\\_lager\\_h exited with reason
&gt; {'EXIT',{{badmatch,["/buckets/uaprom-image/objects/272547384\\_cid1322007\\_pid183135512-26a7c1f3.jpg",{error,{error,{badmatch,{error,closed}},[{webmachine\\_request,recv\\_unchunked\\_body,3,[{file,"src/webmachine\\_request.erl"},{line,471}]},{webmachine\\_request,call,2,[{file,"src/webmachine\\_request.erl"},{line,193}]},{wrq,stream\\_req\\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\\_cs\\_wm\\_object,handle\\_normal\\_put,2,[{file,"src/riak\\_cs\\_wm\\_object.erl"},{line,341}]},{riak\\_cs\\_wm\\_common,accept\\_body,2,[{file,...},...]},...]}},...]},...}}
&gt;
&gt; I suspect that there were problem between Riak CS - Stanhion or Stanhion -
&gt; Riak. I have no clear idea in Stanchion troubleshooting. The main reason is
&gt; the following. Stanhion works fine, service is up (answers on ping command).
&gt; But it is very laconic: there is almost nothing in console and error logs
&gt; (even with debug log level).
&gt;
&gt; Riak CS adds, removes, gets properties through Stanchion service. Am I
&gt; right? I can't exactly understand where is my bottleneck - Riak, Riak CS or
&gt; Stanhion.
&gt;
&gt; When we need authenticated access for reading object from bucket do we need
&gt; Stanchion? If not I can't understand why I had a lot of error during getting
&gt; objects from Riak CS.
&gt;
&gt; Thank you in advance.
&gt;
&gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion
&gt; connectivity I need to restart Riak CS.
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
Kazuhiro Suzuki | Basho Japan KK

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

