---
title: "Re: Associating Riak CRDT Sets to Buckets / Keys via Erlang Client"
description: ""
project: community
lastmod: 2016-11-17T07:42:55-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17758"
mailinglist_parent_id: "msg17757"
author_name: "Vikram Lalit"
project_section: "mailinglistitem"
sent_date: 2016-11-17T07:42:55-08:00
---


This is awesome...! Many thanks Magnus - much appreciated...

Must have overlooked some of these details in my initial analysis but am
sure I have a very good starting point / details now!

Thanks again!

On Thu, Nov 17, 2016 at 7:48 AM, Magnus Kessler  wrote:

&gt; On 16 November 2016 at 17:40, Vikram Lalit  wrote:
&gt;
&gt;&gt; Hi - I am trying to leveraging CRDT sets to store chat messages that my
&gt;&gt; distributed Riak infrastructure would store. Given the intrinsic
&gt;&gt; conflict-resolution, I thought this might be more beneficial than me
&gt;&gt; putting together a merge implementation based on the causal context.
&gt;&gt;
&gt;&gt; However, my data model requires each chat message to be associated to
&gt;&gt; something like a post, hence I was thinking of having the post reference as
&gt;&gt; the bucket, and chat references as keys in that bucket. With of course the
&gt;&gt; bucket-type datasource equated to 'set'. Unfortunately though, from the
&gt;&gt; documentation, I'm not able to ascertain how to associate a created set
&gt;&gt; with an existing bucket and a new key reference if I use the Erlang client.
&gt;&gt; This seems possible for other languages but not for Erlang, with the Basho
&gt;&gt; doc mentioning "%% Sets in the Erlang client are opaque data structures
&gt;&gt; that collect operations as you mutate them. We will associate the data 
&gt;&gt; structure
&gt;&gt; with a bucket type, bucket, and key later on.".
&gt;&gt;
&gt;&gt; Subsequent code only seems to fetch the set from the bucket / key but
&gt;&gt; where exactly is the allocation happening?
&gt;&gt;
&gt;&gt; {ok, SetX} = riakc\\_pb\\_socket:fetch\\_type(Pid, {&lt;&lt;"sets"&gt;&gt;,&lt;&lt;"travel"&gt;&gt;},
&gt;&gt; &lt;&lt;"cities"&gt;&gt;).
&gt;&gt;
&gt;&gt; Perhaps I'm missing something, or is there a code snippet that I can
&gt;&gt; leverage?
&gt;&gt;
&gt;&gt; Thanks!
&gt;&gt;
&gt;&gt;
&gt; Hi Vikram,
&gt;
&gt; Please have a look at the following snippet, that shows the complete set
&gt; of operations used to update a CRDT set with the Erlang client:
&gt;
&gt; update\\_crdt\\_set(Server, BType, Bucket, Key, Val) -&gt;
&gt; T = unicode:characters\\_to\\_binary(BType),
&gt; B = unicode:characters\\_to\\_binary(Bucket),
&gt; K = unicode:characters\\_to\\_binary(Key),
&gt;
&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link(Server, 8087),
&gt;
&gt; Set = case
&gt; riakc\\_pb\\_socket:fetch\\_type(Pid, {T, B}, K)
&gt; of
&gt; {ok, O} -&gt; O;
&gt; {error, {notfound, set}} -&gt; riakc\\_set:new()
&gt; end,
&gt;
&gt; Set1 = riakc\\_set:add\\_element(unicode:characters\\_to\\_binary(Val),
&gt; Set),
&gt;
&gt; {ok, {set, Vals, \\_Adds, \\_Dels, \\_Ctx}} =
&gt; riakc\\_pb\\_socket:update\\_type(
&gt; Pid, {T, B}, K, riakc\\_set:to\\_op(Set1), [return\\_body]),
&gt; Vals.
&gt;
&gt; The set is updated with riakc\\_set:add\\_element/2, and sent back to the
&gt; server with riakc\\_pb\\_socket:update\\_type/5, which in turn takes an
&gt; argument returned from riakc\\_set:to\\_op/1.
&gt;
&gt; More information and samples can be found in the Riak documentation [0]
&gt; and the Riak Erlang client API docs [1][2].
&gt;
&gt; Please let me know if this answered your question.
&gt;
&gt; Kind Regards,
&gt;
&gt; Magnus
&gt;
&gt; [0]: http://docs.basho.com/riak/kv/2.1.4/developing/data-types/sets/
&gt; [1]: https://basho.github.io/riak-erlang-client/riakc\\_set.html
&gt; [2]: https://basho.github.io/riak-erlang-client/riakc\\_pb\\_
&gt; socket.html#update\\_type-5
&gt;
&gt; --
&gt; Magnus Kessler
&gt; Client Services Engineer
&gt; Basho Technologies Limited
&gt;
&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

