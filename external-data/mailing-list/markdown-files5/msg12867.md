---
title: "Re: Keys that won't disappear from indexes"
description: ""
project: community
lastmod: 2013-11-05T20:59:51-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12867"
mailinglist_parent_id: "msg12864"
author_name: "Evan Vigil-McClanahan"
project_section: "mailinglistitem"
sent_date: 2013-11-05T20:59:51-08:00
---


Since we're talking about indices:

you can attach to the console with `riak attach` (then detach with
control-d (1.3 and below) or control-c (1.4+) note that this is can
kill your node on older versions, so be careful to use the correct
one). Then edit the below to match up with your query, and then paste
it in (note that all the period below are intentional and required):

{ok, C} = riak:local\\_client().
{ok, Query} = riak\\_index:to\\_index\\_query(&lt;&lt;"fieldname\\_bin"&gt;&gt;,
[&lt;&lt;"begin\\_point"&gt;&gt;, &lt;&lt;"end\\_point"&gt;&gt;]).
C:get\\_index(&lt;&lt;"bucket\\_name"&gt;&gt;, Query).

If you need to adjust the Query because of a typo or something, just
do f(Query). to unbind it.

fieldname\\_bin is the binary index or whatever you're searching for. If
you were using $key, your Query might look something like this:

(perfdev@127.0.0.1)17&gt; {ok, Query} =
riak\\_index:to\\_index\\_query(&lt;&lt;"$key"&gt;&gt;, [&lt;&lt;""&gt;&gt;,
&lt;&lt;255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255&gt;&gt;]).
{ok,{range,&lt;&lt;"$key"&gt;&gt;,&lt;&lt;&gt;&gt;,&lt;&lt;"ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ"&gt;&gt;}}
(perfdev@127.0.0.1)20&gt; C:put(riak\\_object:new(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"b"&gt;&gt;, &lt;&lt;"c"&gt;&gt;)).
ok
(perfdev@127.0.0.1)21&gt; C:get\\_index(&lt;&lt;"test"&gt;&gt;, Query).
{ok,[&lt;&lt;"b"&gt;&gt;]}

This should get you a list of keys in erlang binary format, which will
look something like &lt;&lt;"asdasdasd"&gt;&gt; or &lt;&lt;44,0,32,130&gt;&gt; if there are
unprintable characters in the string.


On Tue, Nov 5, 2013 at 4:40 PM, Toby Corkindale
 wrote:
&gt; On 06/11/13 11:30, Evan Vigil-McClanahan wrote:
&gt;&gt;
&gt;&gt; You can replace int\\_to\\_bin with int\\_to\\_str to make it easier to debug
&gt;&gt; in the future, I suppose. I am not sure how to get them to be fetched
&gt;&gt; as bytes, without may altering the client.
&gt;&gt;
&gt;&gt; You could just attach to the console and run whatever listing command
&gt;&gt; you're running there, which would give you the answer as unfiltered
&gt;&gt; erlang binaries, which are easy to understand.
&gt;
&gt;
&gt; Ah, I'm really not familiar enough with Erlang and Riak to be doing that.
&gt; Which API applies to console commands? I'll take a look. (Is it just the
&gt; same as the Erlang client?)
&gt;
&gt;
&gt;
&gt;&gt; Is this easily replicable on a new cluster?
&gt;
&gt;
&gt; I think it should be -- the only difference over default configuration is
&gt; that LevelDB is configured as the default backend.
&gt; Run basho\\_bench with the pbc-client test to generate the initial keys and
&gt; you should be set.
&gt;
&gt;
&gt; T
&gt;
&gt;&gt; On Tue, Nov 5, 2013 at 4:17 PM, Toby Corkindale
&gt;&gt;  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Evan,
&gt;&gt;&gt; These keys were originally created by basho-bench, using:
&gt;&gt;&gt; {key\\_generator, {int\\_to\\_bin, {uniform\\_int, 10000}}}.
&gt;&gt;&gt;
&gt;&gt;&gt; Of the 10k keys, it seems half could be removed, but not the other half.
&gt;&gt;&gt;
&gt;&gt;&gt; Now I've tried storing keys with the same key as the un-deleteable ones,
&gt;&gt;&gt; waiting a minute, and then deleting them again.. this isn't seeming to
&gt;&gt;&gt; help!
&gt;&gt;&gt;
&gt;&gt;&gt; I don't know if it's significant, but I'm working with the Java client
&gt;&gt;&gt; here
&gt;&gt;&gt; (protocol buffers). I note that the bad keys are basically just bytes,
&gt;&gt;&gt; not
&gt;&gt;&gt; actual ascii strings, and they do contain nulls.
&gt;&gt;&gt;
&gt;&gt;&gt; Actually, here's something I just noticed -- the keys I'm getting from
&gt;&gt;&gt; the
&gt;&gt;&gt; index are repeating! It's the same 39 keys, repeated 128 times.
&gt;&gt;&gt;
&gt;&gt;&gt; O.o
&gt;&gt;&gt;
&gt;&gt;&gt; Are there any known bugs in the PBC interface when it comes to binary
&gt;&gt;&gt; keys?
&gt;&gt;&gt; I know the HTTP interface just crashes out completely.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm fetching the keys in a manner that returns strings; is there a way to
&gt;&gt;&gt; fetch them as bytes? Maybe that would work better; I'm wondering if the
&gt;&gt;&gt; client is attempting to convert the bytes into unicode strings and
&gt;&gt;&gt; dropping
&gt;&gt;&gt; invalid characters?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 05/11/13 03:44, Evan Vigil-McClanahan wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi Toby.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; It's possible, since they're stored separately, that the objects were
&gt;&gt;&gt;&gt; deleted but the indices were left in place because of some error (e.g.
&gt;&gt;&gt;&gt; the operation failed for some reason between the object removal and
&gt;&gt;&gt;&gt; the index removal). One of the things on the feature list for the
&gt;&gt;&gt;&gt; next release is AAE of index values, which should take care of this
&gt;&gt;&gt;&gt; case. This is really rare, but not unknown. It'd be interesting to
&gt;&gt;&gt;&gt; know how you ended up with so many.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; In the mean time, the only way I can think of to get rid of them
&gt;&gt;&gt;&gt; (other than deleting them from the console, which would require taking
&gt;&gt;&gt;&gt; nodes down and a lot of manual effort), would be to write another
&gt;&gt;&gt;&gt; value that would have the same index, then delete it, which should
&gt;&gt;&gt;&gt; normally succeed.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'll ask around to see if there is anything that might work better.
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

