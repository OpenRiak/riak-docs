---
title: "Re: Yokozuna inconsistent search results"
description: ""
project: community
lastmod: 2016-03-24T01:46:02-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17170"
mailinglist_parent_id: "msg17139"
author_name: "Oleksiy Krivoshey"
project_section: "mailinglistitem"
sent_date: 2016-03-24T01:46:02-07:00
---


This is how things are looking after two weeks:

- there are no solr indexing issues for a long period (2 weeks)
- there are no yokozuna errors at all for 2 weeks
- there is an index with all empty schema, just \\_yz\\_\\* fields, objects
stored in a bucket(s) are binary and so are not analysed by yokozuna
- same yokozuna query repeated gives different number for num\\_found,
typically the difference between real number of keys in a bucket and
num\\_found is about 25%
- number of keys repaired by AAE (according to logs) is about 1-2 per few
hours (number of keys "missing" in index is close to 1,000,000)

Should I now try to delete the index and yokozuna AAE data and wait another
2 weeks? If yes - how should I delete the index and AAE data?
Will RpbYokozunaIndexDeleteReq be enough?

On 18 March 2016 at 18:54, Oleksiy Krivoshey  wrote:

&gt; Hi Magnus,
&gt;
&gt; As of today I had no Yokozuna messages (in sol.log) for 5 days. In Riak
&gt; log I can see some small amount of keys repaired by AAE:
&gt;
&gt; @riak\\_kv\\_exchange\\_fsm:key\\_exchange:263 Repaired 1 keys during active
&gt; anti-entropy exchange of {148433760041419827630061740822747494183805648896,3}
&gt; between {159851741583067506678528028578343455274867621888,'riak@10.0.1.4'}
&gt; and {171269723124715185726994316333939416365929594880,'riak@10.0.1.5'}
&gt;
&gt; However amount of such repaired keys is not larger than 1-2 keys per hour,
&gt; while amount of keys missing in search index (for different buckets of the
&gt; same fs\\_chunks type) is close to 1,000,000.
&gt;
&gt; Thanks!
&gt;
&gt; On 16 March 2016 at 21:49, Oleksiy Krivoshey  wrote:
&gt;
&gt;&gt; Hi Magnus,
&gt;&gt;
&gt;&gt; I don't see any Solr indexing errors anymore. As well as no timeout
&gt;&gt; errors (I've throttled down the application that was querying Yokozuna).
&gt;&gt;
&gt;&gt; I've attached `search aae-status` results from all nodes.
&gt;&gt;
&gt;&gt; Few days ago I saw the following error (few of them) from Yokozuna Solr
&gt;&gt; (not sure if it got to the riak-debug output):
&gt;&gt;
&gt;&gt; @SolrException.java:120 IO error while trying to get
&gt;&gt; the size of the Directory:java.io.FileNotFoundException: \\_2hky\\_1.del at
&gt;&gt; org.apache.lucene.store.FSDirectory.fileLength(FSDirectory.java:261) at
&gt;&gt; org.apache.lucene.store.NRTCachingDirectory.fileLength(NRTCachingDirectory.java:178)
&gt;&gt; at org.apache.solr.core.DirectoryFactory.sizeOf(DirectoryFactory.java:209)
&gt;&gt; at
&gt;&gt; org.apache.solr.core.DirectoryFactory.sizeOfDirectory(DirectoryFactory.java:195)
&gt;&gt; at
&gt;&gt; org.apache.solr.handler.admin.CoreAdminHandler.getIndexSize(CoreAdminHandler.java:1129)
&gt;&gt; at
&gt;&gt; org.apache.solr.handler.admin.CoreAdminHandler.getCoreStatus(CoreAdminHandler.java:1105)
&gt;&gt; at
&gt;&gt; org.apache.solr.handler.admin.CoreAdminHandler.handleStatusAction(CoreAdminHandler.java:705)
&gt;&gt; at
&gt;&gt; org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:167)
&gt;&gt; at
&gt;&gt; org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
&gt;&gt; at
&gt;&gt; org.apache.solr.servlet.SolrDispatchFilter.handleAdminRequest(SolrDispatchFilter.java:732)
&gt;&gt; at
&gt;&gt; org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:268)
&gt;&gt; at
&gt;&gt; org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:217)
&gt;&gt;
&gt;&gt;
&gt;&gt; Should I delete Yokozuna AAE trees?
&gt;&gt;
&gt;&gt; Thanks!
&gt;&gt;
&gt;&gt;
&gt;&gt; On 16 March 2016 at 17:51, Magnus Kessler  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;
&gt;&gt;&gt; Whether or not 'brod' has anything to do with the failure to eventually
&gt;&gt;&gt; reach consistency in the Solr indexes remains to be seen. I just had never
&gt;&gt;&gt; come across this application in a Riak context and wanted to establish why
&gt;&gt;&gt; there appear to be frequent errors in the Riak logs associated with it. As
&gt;&gt;&gt; the brod application is not in use, could you temporarily remove it from
&gt;&gt;&gt; the erlang module path while you troubleshoot Solr indexing?
&gt;&gt;&gt;
&gt;&gt;&gt; We recommend having a catch-all field in all Solr schemas, as this
&gt;&gt;&gt; prevents indexing failures. However, you are correct that arbitrary mime
&gt;&gt;&gt; types are not analysed unless they have a Yokozuna extractor associated
&gt;&gt;&gt; with them. By default the yz\\_noop\\_extractor is used.
&gt;&gt;&gt;
&gt;&gt;&gt; We do not have an easy way to query for missing keys that should be
&gt;&gt;&gt; indexed. The necessary code is obviously part of Yokozuna's AAE repair
&gt;&gt;&gt; mechanism, but there is currently no tool that exposes this functionality
&gt;&gt;&gt; to the end user. This is why one re-indexing strategy is based on deleting
&gt;&gt;&gt; the Yokozuna AAE trees, which causes a rebuild of these trees and checks if
&gt;&gt;&gt; the appropriate entries exist in Solr.
&gt;&gt;&gt;
&gt;&gt;&gt; Looking at the output of 'riak-admin search aae\\_status' from the debug
&gt;&gt;&gt; logs, I notice that on the majority of nodes the trees have been rebuilt
&gt;&gt;&gt; very recently, but the most current YZ AAE exchanges have happened around 8
&gt;&gt;&gt; days before (with the exception of one node). Re-indexing occurs during the
&gt;&gt;&gt; AAE exchanges. Therefore I have to conclude that the discrepancies in
&gt;&gt;&gt; numbers are due to the majority of the exchanges not yet having taken
&gt;&gt;&gt; place. We will have to understand why YZ AAE exchanges are not occurring or
&gt;&gt;&gt; not terminating successfully.
&gt;&gt;&gt;
&gt;&gt;&gt; Can you provide more recent results from running `riak-admin search
&gt;&gt;&gt; aae\\_status` on all nodes, please? Also please state if you observe any more
&gt;&gt;&gt; indexing failures or solr query timeouts in your logs.
&gt;&gt;&gt;
&gt;&gt;&gt; Kind Regards,
&gt;&gt;&gt;
&gt;&gt;&gt; Magnus
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 15 March 2016 at 17:03, Oleksiy Krivoshey  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I wasn't correct in my email, application brod was running before but
&gt;&gt;&gt;&gt; was not used. Its being used from a post-commit hook and that hook wasn't
&gt;&gt;&gt;&gt; enabled on a bucket yet.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Is there any way I can enable more debug output from Yokozuna? Can I
&gt;&gt;&gt;&gt; somehow see which node (in coverage plan) is missing indexed keys?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 15 March 2016 at 18:46, Oleksiy Krivoshey 
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Hi Magnus,
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Thank you, I really appreciate you spending your time on this.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The application brod included in a post-commit hook wasn't running
&gt;&gt;&gt;&gt;&gt; when I was removing the index and/or expiring AAE trees. As well as there
&gt;&gt;&gt;&gt;&gt; were no Yokozuna queries running. I started these processes just yesterday
&gt;&gt;&gt;&gt;&gt; and they were running when I issued riak-debug but not before.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The schema I use for xxxxx.chunks is:
&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/ab3br7dxhnjx1sl/Screenshot%202016-03-15%2018.38.52.png?dl=0
&gt;&gt;&gt;&gt;&gt; I will try moving "ignore" line above \\_yz\\_\\* fields. However objects in
&gt;&gt;&gt;&gt;&gt; xxxx.chunks bucket are binary (contentType is set to 
&gt;&gt;&gt;&gt;&gt; 'binary/octet-stream')
&gt;&gt;&gt;&gt;&gt; and I assume Yokozuna shouldn't even try to analyse such object content. 
&gt;&gt;&gt;&gt;&gt; Is
&gt;&gt;&gt;&gt;&gt; this correct?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Can a "failed to index" error for a "xxxx.files" bucket be the reason
&gt;&gt;&gt;&gt;&gt; for indexing issues for another bucket xxxxx.chunks that is using 
&gt;&gt;&gt;&gt;&gt; different
&gt;&gt;&gt;&gt;&gt; index? I mean, does it affect AAE repair or something?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Thanks!
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On 15 March 2016 at 18:30, Magnus Kessler  wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Thank you for providing the debug files. I have downloaded them and
&gt;&gt;&gt;&gt;&gt;&gt; had a first look, but can only work on them when there's time between
&gt;&gt;&gt;&gt;&gt;&gt; working issues for paying customers.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Having said that, I'd like to know the origin of messages like
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-14 04:11:59.283 [error] &lt;0.14213.1803&gt; CRASH REPORT Process
&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.14213.1803&gt; with 0 neighbours exited with reason: tcp\\_closed in
&gt;&gt;&gt;&gt;&gt;&gt; brod\\_sock:handle\\_msg/3 line 158
&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-14 04:11:59.284 [error] &lt;0.20875.1802&gt; gen\\_server
&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.20875.1802&gt; terminated with reason: {socket\\_down,tcp\\_closed}
&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-14 04:11:59.284 [error] &lt;0.20875.1802&gt; CRASH REPORT Process
&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.20875.1802&gt; with 1 neighbours exited with reason:
&gt;&gt;&gt;&gt;&gt;&gt; {socket\\_down,tcp\\_closed} in gen\\_server:terminate/6 line 744
&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-14 04:11:59.285 [error] &lt;0.29923.0&gt; Supervisor
&gt;&gt;&gt;&gt;&gt;&gt; replication\\_sup had child replication started with 
&gt;&gt;&gt;&gt;&gt;&gt; replication:start\\_link()
&gt;&gt;&gt;&gt;&gt;&gt; at &lt;0.19687.1802&gt; exit with reason {socket\\_down,tcp\\_closed} in context
&gt;&gt;&gt;&gt;&gt;&gt; child\\_terminated
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; These appear to be related to the 'brod' module (
&gt;&gt;&gt;&gt;&gt;&gt; https://github.com/klarna/brod), which has never been part of an
&gt;&gt;&gt;&gt;&gt;&gt; official Riak release. I'd like to rule out that this module interferes
&gt;&gt;&gt;&gt;&gt;&gt; with the 'yokozuna' module in any way.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; The log also contains an indexing failure
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-11 09:06:32.612 [error] &lt;0.1215.0&gt;@yz\\_kv:index\\_internal:237
&gt;&gt;&gt;&gt;&gt;&gt; failed to index object
&gt;&gt;&gt;&gt;&gt;&gt; {{&lt;&lt;"fs\\_files"&gt;&gt;,&lt;&lt;"o9hkcblhhunwm15ec5cicdmr6fgbz3id.files"&gt;&gt;},&lt;&lt;"/products/BRAND/BRAND\\_108884.PNG"&gt;&gt;}
&gt;&gt;&gt;&gt;&gt;&gt; with error {"Failed to index docs",other,{error,req\\_timedout}} because
&gt;&gt;&gt;&gt;&gt;&gt; [{yz\\_solr,index,3,[{file,"src/yz\\_solr.erl"},{line,205}]},{yz\\_kv,index,7,[{file,"src/yz\\_kv.erl"},{line,293}]},{yz\\_kv,index\\_internal,5,[{file,"src/yz\\_kv.erl"},{line,224}]},{riak\\_kv\\_vnode,actual\\_put,6,[{file,"src/riak\\_kv\\_vnode.erl"},{line,1619}]},{riak\\_kv\\_vnode,perform\\_put,3,[{file,"src/riak\\_kv\\_vnode.erl"},{line,1607}]},{riak\\_kv\\_vnode,do\\_put,7,[{file,"src/riak\\_kv\\_vnode.erl"},{line,1398}]},{riak\\_kv\\_vnode,handle\\_command,3,[{file,"src/riak\\_kv\\_vnode.erl"},{line,558}]},{riak\\_core\\_vnode,vnode\\_command,3,[{file,"src/riak\\_core\\_vnode.erl"},{line,346}]}]
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; The root cause of this appears to be a timeout, which is a sign that
&gt;&gt;&gt;&gt;&gt;&gt; the cluster was overloaded at this point in time. If this happens during
&gt;&gt;&gt;&gt;&gt;&gt; re-indexing, any affected objects will be missing from the index on one 
&gt;&gt;&gt;&gt;&gt;&gt; or
&gt;&gt;&gt;&gt;&gt;&gt; more Solr instances. This should be fixed in time by a subsequent AAE
&gt;&gt;&gt;&gt;&gt;&gt; repair, but will obviously contribute to inconsistent indexes.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Other signs of overload can be seen when searches time out, too:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; ./riak@10.0.1.2-riak-debug/logs/platform\\_log\\_dir/console.log.2:2016-03-11
&gt;&gt;&gt;&gt;&gt;&gt; 09:06:32.612 [info] &lt;0.10458.1086&gt;@yz\\_pb\\_search:maybe\\_process:106 "Failed
&gt;&gt;&gt;&gt;&gt;&gt; to search" "http://localhost:8093/internal\\_solr/files\\_index/select"
&gt;&gt;&gt;&gt;&gt;&gt; {error,req\\_timedout}
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; If you observe regular timeouts (or very long search related
&gt;&gt;&gt;&gt;&gt;&gt; latencies for that matter), you should either throttle the client load on
&gt;&gt;&gt;&gt;&gt;&gt; the cluster or add more nodes to spread the load. Please also keep an eye
&gt;&gt;&gt;&gt;&gt;&gt; on IO waits, and provide better provisioned disks if these are constantly
&gt;&gt;&gt;&gt;&gt;&gt; high. We find disk IO to be the root cause of many performance issues.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Finally, I'd like to suggest that the minimal schema used has at
&gt;&gt;&gt;&gt;&gt;&gt; least the catch-all dynamic field definition in addition to the '\\_yz\\*'
&gt;&gt;&gt;&gt;&gt;&gt; fields. Please consider adding
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; before the '\\_yz\\*' fields.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Kind Regards,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Magnus
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On 14 March 2016 at 15:47, Oleksiy Krivoshey 
&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Magnus,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Thank you!
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Here are the files:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/rjide53i9wnzc03/riak%4010.0.1.1-riak-debug.tar.gz?dl=0
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/zdpbkp8j210qxut/riak%4010.0.1.2-riak-debug.tar.gz?dl=0
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/e1kaaozd7s0oxz1/riak%4010.0.1.3-riak-debug.tar.gz?dl=0
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/3rwliv2dgpvre1o/riak%4010.0.1.4-riak-debug.tar.gz?dl=0
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; https://www.dropbox.com/s/ptwq7gobo73d802/riak%4010.0.1.5-riak-debug.tar.gz?dl=0
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Its a busy cluster, so I can explain any additional settings we have.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Just want to add that I also get inconsistent results with search
&gt;&gt;&gt;&gt;&gt;&gt;&gt; index that only has \\_yz\\_\\* fields (unlike the search index that first 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; raised
&gt;&gt;&gt;&gt;&gt;&gt;&gt; this problem, which had Solr indexing issues).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 14 March 2016 at 17:20, Magnus Kessler 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Would you mind sharing the output of 'riak-debug' from all nodes?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; You can upload the files to a location of your choice and PM me the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; details. As far as we are aware we have fixed all previously existing
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; issues that would prevent a full YZ AAE tree rebuild from succeeding 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; when
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; non-indexable data was present. However, the logs may still contain 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; hints
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; that may help us to identify the root cause of your issue.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Many Thanks,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Magnus
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 14 March 2016 at 09:45, Oleksiy Krivoshey 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; I would like to continue as this seems to me like a serious
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; problem, on a bucket with 700,000 keys the difference in num\\_found 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; can be
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; up to 200,000!
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; And thats a search index that doesn't index, analyse or store ANY
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; of the document fields, the schema has only required \\_yz\\_\\* fields and
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; nothing else.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; I have tried deleting the search index (with PBC call) and tried
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; expiring AAE trees. Nothing helps. I can't get consistent search 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; results
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; from Yokozuna.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Please help.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 11 March 2016 at 18:18, Oleksiy Krivoshey 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Fred,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; This is production environment but I can delete the index.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; However this index covers ~3500 buckets and there are probably 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 10,000,000
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; keys.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; The index was created after the buckets. The schema for the index
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; is just the basic required fields (\\_yz\\_\\*) and nothing else.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Yes, I'm willing to resolve this. When you say to delete
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; chunks\\_index, do you mean the simple RpbYokozunaIndexDeleteReq or 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; something
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; else is required?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Thanks!
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 11 March 2016 at 17:08, Fred Dushin  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; This is definitely pointing to an issue either in the coverage
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; plan (which determines the distributed query you are seeing) or in 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the data
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; you have in Solr. I am wondering if it is possible that you have 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; some data
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; in Solr that is causing the rebuild of the YZ AAE tree to 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; incorrectly
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; represent what is actually stored in Solr.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; What you did was to manually expire the YZ (Riak Search) AAE
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; trees, which caused them to rebuild from the entropy data stored in 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Solr.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Another thing we could try (if you are willing) would be to delete 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 'chunks\\_index' data in Solr (as well as the Yokozuna AAE data), and 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; then
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; let AAE repair the missing data. What Riak will essentially do is 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; compare
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the KV hash trees with the YZ hash trees (which will be empty), too 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; that it
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; is missing in Solr, and add it to Solr, as a result. This would
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; effectively result in re-indexing all of your data, but we are only 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; talking
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; about ~30k entries (times 3, presumably, if your n\\_val is 3), so 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; that
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; shouldn't take too much time, I wouldn't think. There is even some
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; configuration you can use to accelerate this process, if necessary.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Is that something you would be willing to try? It would result
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; in down time on query. Is this production data or a test 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; environment?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; -Fred
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 07970431
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt;&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg
&gt;&gt;&gt;&gt;&gt;&gt; 07970431
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;
&gt;&gt;&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg 07970431
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

