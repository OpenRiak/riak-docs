---
title: "Re: Riak stalls, leveldb backend"
description: ""
project: community
lastmod: 2015-02-11T11:48:19-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15688"
mailinglist_parent_id: "msg15445"
author_name: "Andy Pellett"
project_section: "mailinglistitem"
sent_date: 2015-02-11T11:48:19-08:00
---


Hi All,

I ran across this page:

http://docs.basho.com/riak/1.0.0/tutorials/choosing-a-backend/LevelDB/

and ended up tuning the following parameters:

max\\_open\\_files 16384
write\\_buffer\\_size\\_min 1gb
write\\_buffer\\_size\\_max 2gb
cache\\_size 15gb
block\\_size 262144

Since making these changes about a week ago, I've seen considerably fewer
compactions, and no stalls. Hoping this holds up.

Andy

On Tue, Jan 6, 2015 at 7:29 PM, Drew Pirrone-Brusse &lt;
dpirrone-bru...@basho.com&gt; wrote:

&gt; Hey all,
&gt;
&gt; So, the long and short of it is that Riak doesn't handle objects
&gt; larger than 2Mb very well at all. We try to be pretty up-front about
&gt; this in the documentation (for example[1]) be we're also aware that
&gt; sometimes you need to store big objects. Riak CS was actually created
&gt; to deal with these exact performance issues, so I'd highly recommend
&gt; you take a look at it, if your usecase requires large objects.
&gt;
&gt; When talking specifically about LevelDB, we have some useful
&gt; implementation details[2] in our docs. Take special note of the file
&gt; sizes and total size limits for Level-0 and Level-1---each file is
&gt; limited to 2Mb, and Level-1 will only store up to 10Mb. The disk I/O
&gt; required to flush Level-0 and Level-1 completely so that you can write
&gt; -- and then compact -- a &gt;10Mb file (as is your case, Andy) adds up
&gt; pretty quickly.
&gt;
&gt; I hope that helps.
&gt; Best,
&gt; -Drew
&gt;
&gt; [1] -
&gt; http://docs.basho.com/riak/latest/dev/using/application-guide/#What-Kind-of-Data-Are-You-Storing-
&gt; [2] -
&gt; http://docs.basho.com/riak/latest/ops/advanced/backends/leveldb/#Implementation-Details
&gt;
&gt; On Tue, Jan 6, 2015 at 6:01 AM, Sorin Manole 
&gt; wrote:
&gt; &gt;
&gt; &gt; Hey Andy,
&gt; &gt;
&gt; &gt; We had the same issue few days ago. We were getting timeouts when trying
&gt; to read a key from riak.
&gt; &gt;
&gt; &gt; Also we were seeing in the logs a warning about reading/writing a large
&gt; object. In our case that object was first read from riak and after written
&gt; back. It was that big (17Mb) because of some load testing that we did.
&gt; &gt;
&gt; &gt; We deleted the object and we didn't experience timeouts anymore.
&gt; &gt;
&gt; &gt; We tried to repro the issue, so we can be sure it was this and we posted
&gt; a 20Mb json to the same key and the timeouts came back again, deleted the
&gt; 20Mb object and everything worked fine again.
&gt; &gt;
&gt; &gt; I don't know why this is happening but we can say that this was the
&gt; issue for our timeouts.
&gt; &gt;
&gt; &gt; Maybe someone has a better understanding on this.. I'd like to be in the
&gt; loop of this conversation if possible.
&gt; &gt;
&gt; &gt; Thanks!
&gt; &gt; Sorin.
&gt; &gt;
&gt; &gt; On 5 January 2015 at 18:07, Andy Pellett  wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; Hi all,
&gt; &gt;&gt;
&gt; &gt;&gt; I've been experiencing stalls where riak won't return any data (queries
&gt; time out) with my riak cluster. Here are some basic details:
&gt; &gt;&gt;
&gt; &gt;&gt; - 8 nodes
&gt; &gt;&gt; - riak 1.4.10 (upgraded from 1.4.6 -&gt; 1.4.8 -&gt; 1.4.10)
&gt; &gt;&gt; - leveldb backend
&gt; &gt;&gt; - n\\_val is 2
&gt; &gt;&gt; - allow\\_mult is false
&gt; &gt;&gt; - ec2 i2.2xlarge boxes (8 cores, 61gb ram, 800gb disk space)
&gt; &gt;&gt; - about 33% disk space utilization per node
&gt; &gt;&gt;
&gt; &gt;&gt; The riak cluster will stall for as long as a few minutes at a time, but
&gt; will otherwise work as expected for hours. There doesn't seem to be an
&gt; obvious pattern as to when the stalls happen.
&gt; &gt;&gt;
&gt; &gt;&gt; My first thought was that the stalls may be related to AAE, but I've
&gt; disabled that via 'riak attach' and the settings file. Sidenote, I still
&gt; see messages like:
&gt; &gt;&gt;
&gt; &gt;&gt; 2015-01-05 12:24:04.666 [info]
&gt; &lt;0.574.0&gt;@riak\\_kv\\_entropy\\_manager:perhaps\\_log\\_throttle\\_change:826 Changing
&gt; AAE throttle from 0 -&gt; 10 msec/key, based on maximum vnode mailbox size 209
&gt; from 'riak-user@riak-host'
&gt; &gt;&gt;
&gt; &gt;&gt; which makes me question whether AAE is actually turned off.
&gt; &gt;&gt;
&gt; &gt;&gt; Now I'm leaning towards leveldb compactions being the issue. What can I
&gt; do to verify this is the issue, and how can I fix it?
&gt; &gt;&gt;
&gt; &gt;&gt; I see log messages about large objects:
&gt; &gt;&gt;
&gt; &gt;&gt; 2015-01-05 16:11:28.046 [warning]
&gt; &lt;0.6398.0&gt;@riak\\_kv\\_vnode:encode\\_and\\_put\\_no\\_sib\\_check:1830 Writing very
&gt; large object (11307735 bytes) to &lt;&lt;"BucketName"&gt;&gt;/&lt;&lt;"keys\\_1420466400"&gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Could these be causing longer-running compactions, or more frequent
&gt; compactions?
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks for reading,
&gt; &gt;&gt; Andy
&gt; &gt;&gt;
&gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt; Sorin Manole
&gt; &gt; Senior Software Engineer, Trustev
&gt; &gt; m:+353 86 051 2658 | e:sorin.man...@trustev.com | w:www.trustev.com| a:
&gt; Trustev Ltd, 2100 Airport Business Park, Cork, Ireland.
&gt; &gt;
&gt; &gt; This message is for the named person's use only. If you received this
&gt; message in error, please immediately delete it and all copies and notify
&gt; the sender. You must not, directly or indirectly, use, disclose,
&gt; distribute, print, or copy any part of this message if you are not the
&gt; intended recipient. Any views expressed in this message are those of the
&gt; individual sender and not Trustev Ltd. Trustev is registered in Ireland No.
&gt; 516425 and trades from 2100 Cork Airport Business Park, Cork, Ireland.
&gt; &gt;
&gt; &gt;
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

