---
title: "Re: slow mapred_search key lookups for single terms"
description: ""
project: community
lastmod: 2012-04-02T08:46:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07104"
mailinglist_parent_id: "msg07103"
author_name: "Michael Radford"
project_section: "mailinglistitem"
sent_date: 2012-04-02T08:46:22-07:00
---


Hi Ryan,

This is getting interesting: the same queries when executed using
local clients from 'riak attach' are taking only 100-250 ms.

However, I just tried the same test I was running remotely on Saturday
on one of the machines in the Riak cluster, using the protobufs client
to connect to 127.0.0.1, and it's still taking 6-7 seconds per query.
(Still with an occasional dip down to 2-3 seconds).

These machines are on Amazon EC2, so I have little control over the
network layout. But that includes the 4 Riak boxes, so if their
inter-node communication was suffering from similar issues I would
have expected to see it affecting other map-reduce queries. (We're
running lots of multi-key lookups via map-reduce that return thousands
of objects in a few ms, much larger than the keys returned from these
searches.)

And again, there is a huge difference between the same query using the
local client (200 ms), and using the protobufs client from the exact
same Riak machine connecting to localhost (6-7 sec but occasionally
2-3 sec).

Mike

On Mon, Apr 2, 2012 at 7:44 AM, Ryan Zezeski  wrote:
&gt; Hi Michael, you'll find my responses inline...
&gt;
&gt; On Sat, Mar 31, 2012 at 5:04 PM, Michael Radford  wrote:
&gt;&gt;
&gt;&gt; I'm seeing very slow performance from Riak search even when querying
&gt;&gt; single terms, and I'd appreciate any advice on how to get insight into
&gt;&gt; where the time is going.
&gt;&gt;
&gt;&gt; Right now, I'm using this function to time queries with the Erlang pb
&gt;&gt; client:
&gt;&gt;
&gt;&gt; TS =
&gt;&gt;  fun (Pid, Bucket, Query) -&gt;
&gt;&gt;    T0 = now(),
&gt;&gt;    {ok, Results} = riakc\\_pb\\_socket:search(Pid, Bucket, Query),
&gt;&gt;    MuSec = timer:now\\_diff(now(), T0),
&gt;&gt;    io:format(user, "~b results, ~f sec~n", [length(Results),
&gt;&gt; MuSec/1000000])
&gt;&gt;  end.
&gt;
&gt;
&gt; Just an FYI, you should checkout `timer:tc`.
&gt;&gt;
&gt;&gt;
&gt;&gt; The bucket I'm querying currently has ~300k keys total (each 16
&gt;&gt; bytes). (The whole cluster has maybe 1.5M entries in about a dozen
&gt;&gt; buckets. It's running 1.0.2, 4 nodes on 4 8-core c1.xlarge EC2
&gt;&gt; instances.)
&gt;&gt;
&gt;&gt; For single-term queries that return 10k+ keys, I'm routinely seeing
&gt;&gt; times above 6 seconds to run the above function. Intermittently,
&gt;&gt; however, I'll see the same queries take only 2 seconds:
&gt;&gt;
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt; 12574 results, 6.094149 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt; 12574 results, 1.938894 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt; 12574 results, 1.981492 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt; 12574 results, 6.120589 sec
&gt;&gt; ok
&gt;&gt;
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt; 13461 results, 6.572473 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt; 13461 results, 6.626049 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt; 13461 results, 2.155847 sec
&gt;&gt; ok
&gt;&gt;
&gt;&gt; Queries with fewer results are still slow, but not quite as slow as 6
&gt;&gt; seconds:
&gt;&gt;
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt; 6446 results, 2.831806 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt; 6446 results, 3.037162 sec
&gt;&gt; ok
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt; 6447 results, 0.780944 sec
&gt;&gt; ok
&gt;&gt;
&gt;&gt; And queries with no matches only take a few milliseconds:
&gt;&gt;
&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:blorf"&gt;&gt;).
&gt;&gt; 0 results, 0.003269 sec
&gt;&gt; ok
&gt;&gt;
&gt;&gt; During the slow queries, none of the 4 machines seems to be fully
&gt;&gt; taxing even one cpu, or doing almost any disk i/o.
&gt;
&gt;
&gt; What does intra/inter network look like?
&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; As far as I can tell from looking at the riak\\_kv/riak\\_search source,
&gt;&gt; my query should only be hitting the index and streaming back the keys,
&gt;&gt; not trying to read every document from disk or sort by score. Is that
&gt;&gt; correct?
&gt;
&gt;
&gt; It will not read the documents at all but it will sort on score.  Currently
&gt; there is no way to disable sorting.
&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; Assuming that's the case, I can't imagine why it takes so long to look
&gt;&gt; up 10k keys from the index for a single term, or why the times seem to
&gt;&gt; be bimodal (which seems like a big clue). Any pointers welcome!
&gt;
&gt;
&gt; Where is your client sitting in regards to your cluster?  Is it in the local
&gt; network?  Could you try attaching to one of your riak nodes, running the
&gt; query there and compare results?
&gt;
&gt; e.g.
&gt;
&gt; riak attach
&gt;
&gt;&gt; search:search(Bucket, Query).
&gt;
&gt; -Ryan
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

