---
title: "Fwd: Query on Riak Search in a cluster of 3 nodes behind ELB is	giving different result everytime"
description: ""
project: community
lastmod: 2015-03-05T08:54:26-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15842"
author_name: "Zeeshan Lakhani"
project_section: "mailinglistitem"
sent_date: 2015-03-05T08:54:26-08:00
---


Hello Baskar, Santi.

I’d definitely like to know what your AAE status is like, as per my last email. 
The fix here may just be clearing the AAE trees and rebuilding them.

Yes, index creation is currently async and you have to wait for it to be 
created before sending data. You can poll to check for the index, similar to 
this function used in the search java-client tests, 
https://github.com/basho/riak-java-client/blob/89778ae5a2274ce8693709bcc4c5ea3558d72971/src/test/java/com/basho/riak/client/core/operations/itest/ITestBase.java#L264
 
.
 We do something similarly in our erlang tests for search. 

I’m not aware of a better way right now. Currently, I’m actually working on 
making index creation synchronous before returning a response (within a 
timeout), which could solve your issues.

Thanks.


&gt; Begin forwarded message:
&gt; 
&gt; Date: March 5, 2015 at 11:21:59 AM EST
&gt; Subject: Re: Query on Riak Search in a cluster of 3 nodes behind ELB is 
&gt; giving different result everytime
&gt; From: Baskar Srinivasan 
&gt; To: Santi Kumar 
&gt; Cc: Zeeshan Lakhani 
&gt; 
&gt; Hello Zeeshan,
&gt; 
&gt; I work with Santi on the same server backend component. Our primary issue 
&gt; seems to be that Index creation and Bucket association with the indices is 
&gt; being done via load balancer. After we do that, we move onto actually 
&gt; creating data. When data is created is getting into Riak fine. However not 
&gt; all data make it to the indices. 
&gt; 
&gt; It appears that depending when a node gets the Riak data persist call it may 
&gt; not have completed index creation and bucket to index association for that 
&gt; node which in turns means that particular data doesn't get indexed anywhere.
&gt; 
&gt; Is it possible to ensure that the call to create indices and associate 
&gt; buckets with indices guarantees that this action has been completed on all 
&gt; nodes of a cluster?
&gt; 
&gt; The API we are using are as follows:
&gt; 
&gt; 1. Index creation
&gt; YokozunaSchema yschema = getSchema();
&gt; 
&gt; YokozunaIndex vdIndex = new YokozunaIndex(indexName,yschema.getName());
&gt; 
&gt; 
&gt; StoreIndex storeIndex =new StoreIndex.Builder(vdIndex).build();
&gt; 
&gt; RiakFuture storeIndexFuture = 
&gt; client.executeAsync(storeIndex);
&gt; 
&gt; storeIndexFuture.await();
&gt; 
&gt; if(!storeIndexFuture.isSuccess()){
&gt; 
&gt; throw new Exception("....");
&gt; 
&gt; 
&gt; }
&gt; 
&gt; 
&gt; 
&gt; 2. Bucket association
&gt; 
&gt; 
&gt; 
&gt; StoreBucketProperties storeBucketProps = new 
&gt; StoreBucketProperties.Builder(bucket)
&gt; 
&gt; .withSearchIndex(indexName)
&gt; 
&gt; .build();
&gt; 
&gt; 
&gt; RiakFuture storeBucketPropsFuture = 
&gt; client.executeAsync(storeBucketProps);
&gt; 
&gt; try{
&gt; 
&gt; storeBucketPropsFuture.await();
&gt; 
&gt; if(storeBucketPropsFuture.isDone() && 
&gt; storeBucketPropsFuture.isSuccess()){
&gt; 
&gt; logger.info(" Associated index "+indexName+" With bucket 
&gt; "+bucketName);
&gt; 
&gt; }else{
&gt; 
&gt; logger.warn(" Unable to associate bucket "+bucketName);
&gt; 
&gt; }
&gt; 
&gt; }catch(Exception e){
&gt; 
&gt; logger.warn("Issues with ");
&gt; 
&gt; 
&gt; }
&gt; 
&gt; 
&gt; 
&gt; Regards,
&gt; 
&gt; Baskar
&gt; 
&gt; 
&gt; On Thu, Mar 5, 2015 at 8:06 AM, Santi Kumar  &gt; wrote:
&gt; This issue is happening for \\*:\\* query only. It doesn't have lot of objects so 
&gt; we are doing \\*:\\* query. Ever time it fetches different number when I switched 
&gt; to list all keys and do a multi get its returning all objects
&gt; 
&gt; Another thing what we do is we create indexes on the fly and wait for index 
&gt; creation by checking Listindex operation. Once it found the index then we are 
&gt; associating the Bucket with index. After that we write some entries into that 
&gt; bucket.
&gt; 
&gt; I fetched the key and tried searching again but it's the same again. So read 
&gt; repair would have happened so that wouldn't be the issue I can check AAE
&gt; 
&gt; Can you suggest any better way for these index creations and bucket 
&gt; association? I suspect that might be the reason
&gt; Is there any way to check what's the data each shard has? I tried solr query 
&gt; with shards param 
&gt; 
&gt; Thanks 
&gt; Santi
&gt; 
&gt; On Mar 5, 2015 8:05 PM, "Zeeshan Lakhani"  &gt; wrote:
&gt; Hello Santi, 
&gt; 
&gt; Have you deleted an object in that bucket/index at some point? 
&gt; 
&gt; Please make sure AAE is running by checking search’s AAE status, `riak-admin 
&gt; search aae-status`, and that data exists in the correct directory, 
&gt; `./data/yz\\_anti\\_entropy` 
&gt; (http://docs.basho.com/riak/latest/ops/advanced/configs/search/ 
&gt; ). 
&gt; 
&gt; You may just need to perform a read-repair by performing a fetch of the 
&gt; object itself first, before performing search queries again.
&gt; 
&gt; Thanks.
&gt; 
&gt; Zeeshan Lakhani
&gt; programmer | 
&gt; software engineer at @basho | 
&gt; org. member/founder of @papers\\_we\\_love | paperswelove.org 
&gt; 
&gt; twitter =&gt; @zeeshanlakhani
&gt; 
&gt;&gt; On Mar 4, 2015, at 9:06 PM, Santi Kumar &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; But in our case we didnt have spaces in keys. All our keys are UUID's so I 
&gt;&gt; wouldn't suspect that. AAE I haven't verified .
&gt;&gt; 
&gt;&gt; On Thu, Mar 5, 2015 at 7:16 AM, John O'Brien &gt; &gt; wrote:
&gt;&gt; I'd lean towards AAE issues on Yokozuna... Same problems we were having with 
&gt;&gt; our 'spaces-in-keys' issue... Once we cleaned those up, things were great 
&gt;&gt; again.
&gt;&gt; 
&gt;&gt; On Wed, Mar 4, 2015 at 8:36 PM, Santi Kumar &gt; &gt; wrote:
&gt;&gt; Raik 2.0.0
&gt;&gt; 
&gt;&gt; On Mar 5, 2015 12:31 AM, "Christopher Meiklejohn" &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; &gt; On Mar 4, 2015, at 1:15 PM, Santi Kumar &gt; &gt; &gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Hi,
&gt;&gt; &gt; We are running into a strange issue with Riak Search. Our setup is with 3 
&gt;&gt; &gt; nodes of Riak (with search enabled) in 3 different ec2 instances behind 
&gt;&gt; &gt; ELB. App server talks to the cluster through ELB. We are querying for list 
&gt;&gt; &gt; of objects through \\*:\\* query instead of list bucket keys and every time 
&gt;&gt; &gt; the result is different. We have only 4 objects in that bucket / index, 
&gt;&gt; &gt; only few times it's giving all 4 but ofther it returns 2 or 3.
&gt;&gt; &gt;
&gt;&gt; &gt; This wasn't happening when we have one instance of Riak. Any insight?
&gt;&gt; 
&gt;&gt; Hi Santi,
&gt;&gt; 
&gt;&gt; Can you provide information regarding what versions of Riak you are running?
&gt;&gt; 
&gt;&gt; - Chris
&gt;&gt; 
&gt;&gt; Christopher Meiklejohn
&gt;&gt; Senior Software Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; cmeiklej...@basho.com 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com 
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com 
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt;&gt; 
&gt; 
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

