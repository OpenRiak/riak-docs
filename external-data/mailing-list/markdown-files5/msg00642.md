---
title: "Re: riak_multi_backend and bitcask"
description: ""
project: community
lastmod: 2010-06-23T11:36:54-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00642"
mailinglist_parent_id: "msg00640"
author_name: "Tamas Nagy"
project_section: "mailinglistitem"
sent_date: 2010-06-23T11:36:54-07:00
---


Hi,

Thanks for the link. Should I create a ticket there from this thread?

Well the error I saw was this (actually a lot of these because of the restarts):

=ERROR REPORT==== 23-Jun-2010::12:40:34 ===
\\*\\* State machine &lt;0.201.0&gt; terminating
\\*\\* Last message in was {riak\\_kv\\_bitcask\\_backend,merge\\_check}
\\*\\* When State == active
\\*\\* Data == {state,0,[],riak\\_kv\\_multi\\_backend,
 {state,
 [{riak\\_ets,riak\\_kv\\_ets\\_backend,&lt;0.203.0&gt;},
 {riak\\_bitcask,riak\\_kv\\_bitcask\\_backend,
 {#Ref&lt;0.0.0.762&gt;,"data/bitcask/0"}}],
 riak\\_ets},
 not\\_in\\_handoff,undefined}
\\*\\* Reason for termination =
\\*\\* {function\\_clause,
 [{riak\\_kv\\_vnode,handle\\_info,
 [{riak\\_kv\\_bitcask\\_backend,merge\\_check},
 active,
 {state,0,[],riak\\_kv\\_multi\\_backend,
 {state,
 [{riak\\_ets,riak\\_kv\\_ets\\_backend,&lt;0.203.0&gt;},
 {riak\\_bitcask,riak\\_kv\\_bitcask\\_backend,
 {#Ref&lt;0.0.0.762&gt;,"data/bitcask/0"}}],
 riak\\_ets},
 not\\_in\\_handoff,undefined}]},
 {gen\\_fsm,handle\\_msg,7},
 {proc\\_lib,init\\_p\\_do\\_apply,3}]}

So as you can see riak\\_kv\\_vnode cannot handle riak\\_kv\\_bitcask\\_backend messages 
({riak\\_kv\\_bitcask, Whatever}) if the backend type is riak\\_kv\\_multi\\_backend. 
There is simply no case for it in the handle\\_info callback of riak\\_kv\\_vnode 
module. In the current handle\\_info cases the Mod tag of the message has to be 
the same as the value of the state's mod element. One of the possible fixes 
relaxes this check.

Regards,
 Tamas

----- "Dan Reverri"  wrote:

&gt; Hi Tamas,
&gt; 
&gt; 
&gt; You can find the public bug tracker here:
&gt; https://issues.basho.com/
&gt; 
&gt; 
&gt; Regarding using Bitcask with multiple backends, the only issue I've
&gt; seen is trying to setup multiple bitcask backends. Bitcask defines
&gt; options using the "bitcask" application specification which is
&gt; globally set for the node; this prevents multiple instances of the
&gt; bitcask backend from running on a single node:
&gt; https://issues.basho.com/show\\_bug.cgi?id=210
&gt; 
&gt; 
&gt; You should be able to run a bitcask backend along side other backend
&gt; types such as dets.
&gt; 
&gt; 
&gt; I did not completely follow your description; what issues did you see
&gt; after setting bitcask as a backend in the multibackend options? Were
&gt; keys not stored? Did you see errors in the log files? Did you try to
&gt; setup multiple bitcask backends?
&gt; 
&gt; 
&gt; Thanks,
&gt; Dan
&gt; 
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt; 
&gt; 
&gt; 
&gt; On Wed, Jun 23, 2010 at 1:45 PM, Tamas Nagy &lt;
&gt; tamas.n...@erlang-solutions.com &gt; wrote:
&gt; 
&gt; 
&gt; Hi,
&gt; 
&gt; I'm pretty new to the list (and riak) so please forgive my ignorance
&gt; but I didn't manage to find a public bugtracker for riak. Hence I'm
&gt; posting my problem here. (Bitbucket and Internet Explorer(using it not
&gt; by choice) do not mix well. So that might be the problem why I didn't
&gt; find it).
&gt; 
&gt; I've tried to use riak\\_kv\\_multi\\_backend with one of the backends being
&gt; the riak\\_kv\\_bitcask\\_backend. This does not seem to work with
&gt; riak-0.11.0. I checked tip as well, and I do not think it would work
&gt; either. The problem boils to these few lines (code snippets from tip):
&gt; 
&gt; riak\\_kv\\_vnode:
&gt; 
&gt; handle\\_info({Mod, Msg}, StateName, #state { mod = Mod } = StateData)
&gt; -&gt;
&gt;    Mod:handle\\_info(StateData#state.modstate, Msg),
&gt;    {next\\_state, StateName, StateData, ?TIMEOUT}.
&gt; 
&gt; riak\\_kv\\_bitcask\\_backend:
&gt; 
&gt; start(Partition, \\_Config) -&gt;
&gt;    %% Schedule sync (if necessary)
&gt;    case application:get\\_env(bitcask, sync\\_strategy) of
&gt;        {ok, {seconds, Seconds}} -&gt;
&gt;            SyncIntervalMs = timer:seconds(Seconds),
&gt;            erlang:send\\_after(SyncIntervalMs, self(),
&gt;                              {?MODULE, {sync, SyncIntervalMs}});
&gt;        \\_ -&gt;            ok    end,
&gt;    %% Schedule merge checks
&gt;    erlang:send\\_after(?MERGE\\_CHECK\\_INTERVAL, self(), {?MODULE,
&gt; merge\\_check}),
&gt; 
&gt; 
&gt; riak\\_kv\\_multi\\_backend:
&gt; 
&gt; handle\\_info(State, Msg) -&gt;
&gt;    F = fun(\\_Name, Module, SubState) -&gt;
&gt;                Module:handle\\_info(SubState, Msg)
&gt;        end,    [F(X) || X &lt;- State#state.backends],
&gt;    ok.
&gt; 
&gt; If riak\\_kv\\_multi\\_backend is configured in riak\\_kv\\_vnode the state's
&gt; mod is riak\\_kv\\_multi\\_backend but the messages scheduled in
&gt; riak\\_kv\\_bitcask\\_backend are going to have riak\\_kv\\_bitcask\\_backend as
&gt; their Mod tag.
&gt; 
&gt; With my limited understanding about the rest of the sytem it seems to
&gt; me that adding this case to riak\\_kv\\_vnode would fix the problem:
&gt; handle\\_info({Mod, Msg}, StateName, #state { mod =
&gt; riak\\_kv\\_multi\\_backend } = StateData) -&gt;
&gt;    riak\\_kv\\_multi\\_backend:handle\\_info(StateData#state.modstate, Msg),
&gt;    {next\\_state, StateName, StateData, ?TIMEOUT};
&gt; 
&gt; It is a bit wasteful because all the configured backends will get
&gt; called with this message, but it is the best I can think of without
&gt; leaking too much information about the specific backends into the
&gt; generic code.
&gt; 
&gt; Modifying the handle\\_info case would work as well however one check
&gt; would need to disappear:
&gt; 
&gt; handle\\_info({\\_ModTag, Msg}, StateName, #state { mod = Mod } =
&gt; StateData) -&gt;
&gt;    Mod:handle\\_info(StateData#state.modstate, Msg),
&gt;    {next\\_state, StateName, StateData, ?TIMEOUT}.
&gt; 
&gt; There are a plethora of other ways to fix this like passing the Mod
&gt; tag to riak\\_kv\\_multi\\_backend so that it can filter based on it (this
&gt; is probably my favourite as it is not wasteful and there aren't many
&gt; code changes needed either):
&gt; riak\\_kv\\_vnode:
&gt; handle\\_info({Mod, Msg}, StateName, #state { mod =
&gt; riak\\_kv\\_multi\\_backend } = StateData) -&gt;
&gt;    riak\\_kv\\_multi\\_backend:handle\\_info(StateData#state.modstate, {Mod,
&gt; Msg}),
&gt;    {next\\_state, StateName, StateData, ?TIMEOUT};
&gt; 
&gt; riak\\_kv\\_multi\\_backend:
&gt; handle\\_info(State, {Mod, Msg}) -&gt;
&gt;    F = fun(\\_Name, Module, SubState) -&gt;
&gt;                Module:handle\\_info(SubState, Msg)
&gt;        end,    [F(X) || X = {\\_, Module, \\_} &lt;- State#state.backends,
&gt; Module =:= Mod],
&gt;    ok.
&gt; 
&gt; Code is not tested, but should compile. :)
&gt; 
&gt; Regards,
&gt;    Tamas
&gt; 
&gt; --
&gt; Tamas Nagy
&gt; Erlang Solutions Ltd.
&gt; http://www.erlang-solutions.com
&gt; ---------------------------------------------------
&gt; 
&gt; ---------------------------------------------------
&gt; 
&gt; WE'VE CHANGED NAMES!
&gt; 
&gt; Since January 1st 2010 Erlang Training and Consulting Ltd. has become
&gt; ERLANG SOLUTIONS LTD.
&gt; 
&gt; www.erlang-solutions.com
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

-- 
Tamas Nagy
Erlang Solutions Ltd.
http://www.erlang-solutions.com
---------------------------------------------------

---------------------------------------------------

WE'VE CHANGED NAMES!

Since January 1st 2010 Erlang Training and Consulting Ltd. has become ERLANG 
SOLUTIONS LTD.

www.erlang-solutions.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

