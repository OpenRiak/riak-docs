---
title: "Re: Using Riak to perform aggregate queries"
description: ""
project: community
lastmod: 2013-11-24T00:02:36-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13074"
mailinglist_parent_id: "msg13066"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-11-24T00:02:36-08:00
---


Hi,

Instead of updating a summary object for every insert, you could also 
precompute by periodically aggregating data for a specific time period. If you 
are using LevelDB and e.g. have a secondary index that contains a timestamp, 
you could create an hourly summary using a batch job every hour. You could also 
choose to then daily roll these hourly summary objects up into even larger 
daily objects. This allows you to spread out the computation effort and 
provides different levels of granularity for analysis.

While you in a relational database usually store each event as a separate row 
in a table, storing each event as a separate object in Riak is not always the 
optimal approach. When modelling data in Riak it is important to consider how 
you need to access and query your data when structuring it. As Riak at its core 
is a key-value store and accessing data directly by key is the most efficient 
and scalable query method, you ideally want to ensure that the vast majority of 
querying is done directly by key. In order to do this it is often recommended 
to use semantic keys that describe the data instead of automatically generated 
UUIDs.

As retrieving a large number of individual keys is considerably less efficient 
that retrieving a single larger object containing the same data, it often makes 
sense to de-normalise in Riak. In your case you might e.g. consider creating 
objects that contain events of a specific type for a vendor for a set time 
period. These parameters, which identifies the data held in the object should 
be used to create the key. This could take the form \\_\\_. Instead of just inserting a new event 
as a single record in the database, you would update the appropriate object. 
Although this results in a bit more work up front, it allows you to retrieve 
data much more efficiently. 

Examples of how this can be done in real scenarios can be found in these 
presentations:

Temetra: http://basho.com/riak-at-temetra/
Boundary: 
http://boundary.com/blog/2012/08/21/boundary-techtalk-large-scale-olap-with-kobayashi/

I hope this gives you a better idea of how data can be modelled in Riak and how 
it differs from working with a RDBMS. If you can share more details about your 
use case, data and how you need to access and query it, we would love to help 
you bounce ideas and find a solution that works for you.

Best regards,

Christian




On 22 Nov 2013, at 22:34, Hector Castro  wrote:

&gt; On Thu, Nov 21, 2013 at 4:47 PM, NC  wrote:
&gt;&gt; Our use-case is very similar to what Chris has described till now. I am new
&gt;&gt; to the riak store and have a background with RDBMS.
&gt;&gt; 
&gt;&gt; Going over this thread, there was a suggestion to pre-compute things. I am
&gt;&gt; trying to understand what pre-compute exactly means. Does it mean using pre
&gt;&gt; or post commit hooks to perform aggregation as different events enter our
&gt;&gt; system? Or does it mean running map reduce jobs in the background to
&gt;&gt; precompute the aggregations?
&gt;&gt; 
&gt;&gt; A brief background on our use-case. We have vendors in our system that get
&gt;&gt; millions of events every week. Every two weeks, we sum the amount on all the
&gt;&gt; events for the vendor to generate an invoice. Querying millions of events
&gt;&gt; for the vendor using secondary indices or key filters doesn't seem feasible
&gt;&gt; in riak. I am wondering if we can use post-commit hooks so that as events
&gt;&gt; enter our system, we maintain a real-time account for the vendor, adding and
&gt;&gt; subtracting things on the go. When the time comes to create an invoice, we
&gt;&gt; just look at the account to find the amount to pay to the vendor.
&gt; 
&gt; You're on the right track. Avoiding the commit hooks might work better though.
&gt; 
&gt; Precomputing in the content of your use case could look something like:
&gt; 
&gt; At write time, store the event data in a key/value pair, but also
&gt; create another key that has an invoice sum for a specific vendor along
&gt; with a date:
&gt; 
&gt; INVOICE\\_SUM:VENDOR\\_NAME:DATE
&gt; 
&gt; At the end of two weeks, you can get all of the keys that make up two
&gt; weeks for a specific vendor and sum them up in your client-side code:
&gt; 
&gt; INVOICE\\_SUM:VENDORX:20131122 = 5
&gt; INVOICE\\_SUM:VENDORX:20131121 = 10
&gt; INVOICE\\_SUM:VENDORX:20131120 = 54
&gt; 
&gt; Then do the same for the next vendor. If it makes sense to roll up the
&gt; sums at something larger than a day, you can do that too.
&gt; 
&gt;&gt; My questions are: can we even use post-commit hook in that manner where we
&gt;&gt; insert / update multiple records? Is there a different way to design such a
&gt;&gt; schema that I am missing?
&gt;&gt; 
&gt;&gt; Thanks.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; --
&gt;&gt; View this message in context: 
&gt;&gt; http://riak-users.197444.n3.nabble.com/Using-Riak-to-perform-aggregate-queries-tp4027668p4029900.html
&gt;&gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

