---
title: "Re: Performance slows down with write heavy use"
description: ""
project: community
lastmod: 2014-04-15T06:01:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14088"
mailinglist_parent_id: "msg14087"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2014-04-15T06:01:26-07:00
---


Jie,

A colleague points out that I typed "40" in one place and "50" in another. 
"40" is the appropriate setting. 

Matthew


On Apr 15, 2014, at 8:41 AM, Matthew Von-Maszewski  wrote:

&gt; Jie,
&gt; 
&gt; 4G ram is small for your ring size and node count. My first recommendation 
&gt; is that you reduce your ring size to 32 {ring\\_creation\\_size, 32}. Then 
&gt; change the max\\_open\\_files setting of eleveldb to 40 {max\\_open\\_files, 50} and 
&gt; block\\_size to 32768 {sst\\_block\\_size, 32768}. These three settings should 
&gt; quickly improve performance â€¦ but require you start over with your cluster.
&gt; 
&gt; Active Anti-Entropy has a bug in 1.4.7. You might as well disable it too: 
&gt; {anti\\_entropy, {off, []}}. The recommendation is that you upgrade to 1.4.8.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Apr 14, 2014, at 10:10 PM, Jie Lu  wrote:
&gt; 
&gt;&gt; 
&gt;&gt; I also have a problem in performance test of Riak Cluster.
&gt;&gt; ~~~~~~~~~~~~
&gt;&gt; Riak version: 1.4.7
&gt;&gt; OS: openSUSE 11.3
&gt;&gt; RAM: 4G
&gt;&gt; ring size is 64
&gt;&gt; backend: leveldb
&gt;&gt; Nodes in cluster: 6 nodes
&gt;&gt; 
&gt;&gt; ~~~~~~~~~~~~~
&gt;&gt; 
&gt;&gt; I write a key/value with value is 1K bytes, and 25 concurrent threads on 
&gt;&gt; one client nodes. The test result only 20 ops/s performance. 
&gt;&gt; 
&gt;&gt; Is there any performance benchmark to compare with?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Tue, Apr 15, 2014 at 6:26 AM, Luke Bakken  wrote:
&gt;&gt; Hi Matthew -
&gt;&gt; 
&gt;&gt; Some suggestions:
&gt;&gt; 
&gt;&gt; \\* Upgrade to Riak 1.4.8
&gt;&gt; 
&gt;&gt; \\* Test with a ring size of 64
&gt;&gt; 
&gt;&gt; \\* Use staggered merge windows in your cluster 
&gt;&gt; (http://docs.basho.com/riak/latest/ops/advanced/backends/bitcask/)
&gt;&gt; 
&gt;&gt; \\* Since you're on dedicated hardware RAID, use the noop scheduler for your 
&gt;&gt; Riak data volumes:
&gt;&gt; 
&gt;&gt; cat /sys/block/sd\\*/queue/scheduler
&gt;&gt; noop anticipatory deadline [cfq]
&gt;&gt; 
&gt;&gt; \\* Increase +zdbbl in /etc/riak/vm.args to 96000
&gt;&gt; 
&gt;&gt; Thanks
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; CSE
&gt;&gt; lbak...@basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Mon, Apr 14, 2014 at 2:33 PM, Matthew MacClary 
&gt;&gt;  wrote:
&gt;&gt; I have a persistent issue I am trying to diagnose. In our use of Riak we 
&gt;&gt; have multiple data creators writing into a 7 node cluster. The value size is 
&gt;&gt; a bit large at around 2MB. The behavior I am seeing is that if I delete all 
&gt;&gt; data out of bitcask, then test performance I get fast writes. As I keep 
&gt;&gt; doing the same work of writing to the cluster, then the Riak write times 
&gt;&gt; will start tailing off and getting really bad.
&gt;&gt; 
&gt;&gt; Initial write times seen by my application: 0.5 seconds for 100MB worth of 
&gt;&gt; values (~200MB/s)
&gt;&gt; Subsequent write times: 11 seconds for 100MB worth of values (~9MB/s)
&gt;&gt; 
&gt;&gt; This slow down can happen over roughly 20-40 minutes of writing or about 
&gt;&gt; 200GB worth of key/value pairs written.
&gt;&gt; 
&gt;&gt; I can reset the cluster to get fast performance again by stopping Riak and 
&gt;&gt; deleting the bitcask directories, then starting Riak again. This step is not 
&gt;&gt; feasible for production, but during testing at least the write speed goes up 
&gt;&gt; by 20x.
&gt;&gt; 
&gt;&gt; Watching iostat I see that every few seconds the disk io jumps to ~11%. It 
&gt;&gt; doesn't seem that highly loaded from my cursory look. Watching top I see 
&gt;&gt; that beam.smp runs at around 100 for CPU% or less when heavily loaded. I am 
&gt;&gt; not sure how to tell what it is doing though :-)
&gt;&gt; 
&gt;&gt; Thanks for any suggestions!!
&gt;&gt; 
&gt;&gt; -Matt
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; ================
&gt;&gt; System Description
&gt;&gt; 
&gt;&gt; 
&gt;&gt; avg value size = 2MB
&gt;&gt; Riak version = 1.4.1
&gt;&gt; n\\_val = 2
&gt;&gt; client threads total = 105
&gt;&gt; backend = bitcask
&gt;&gt; ring\\_creation\\_size = 128
&gt;&gt; node count = 7
&gt;&gt; node OS = RHEL 6.2
&gt;&gt; server RAM = 128GB
&gt;&gt; RAID = RAID0 across 8 SAS drives
&gt;&gt; FS = ext4
&gt;&gt; FS options = /dev/mapper/vg0-lv0 / ext4 
&gt;&gt; rw,noatime,barrier=0,stripe=512,data=ordered 0 0
&gt;&gt; bitcask size on one server = 133GB
&gt;&gt; AAE = off
&gt;&gt; interface = protobuf
&gt;&gt; client library = riak java client
&gt;&gt; file-max = 65536
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Best Regards.
&gt;&gt; Lu Jie
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Best Regards.
&gt;&gt; Lu Jie
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

