---
title: "Re: Riak/LevelDB Memory Usage"
description: ""
project: community
lastmod: 2013-09-06T13:32:51-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12203"
mailinglist_parent_id: "msg12201"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-09-06T13:32:51-07:00
---


Shane,

Several points for your consideration:

- "cache\\_size" is broken in 1.3.x, fixed in 1.4.x. Any cache\\_size above the 
default 8M can ruin performance because some idiot (me) put a linear walk in 
the cache code. Reverted for 1.4 and cache\\_size tested to 2G.

- do you have AAE (active anti-entropy) running? AAE creates a parallel set of 
vnodes/databases to track hash trees of the primary vnodes. This will add to 
your memory load.

- max\\_open\\_files in 1.3 puts a limit on the count of open files, but NOT on the 
amount of memory that is used by each file. The larger .sst files create 
larger bloom filters which take up a greater amount of memory for same 
max\\_open\\_files setting. Poor accounting. 1.4.x has a correction that changes 
file cache accounting from file count to amount of memory used per file (limit 
is 4Mbyte \\* max\\_open\\_files). I am aware of one other 1.3.x site that had to 
reduce their max\\_open\\_files from 300 or more, to around 70 to stabilize memory.

That said, I have attached a spreadsheet that simplifies the math discussed on 
our web site. I have plugged in your numbers and see a "balance" around 
cache\\_size=8388603 and max\\_open\\_files=200. 


I am currently writing a dynamic cache size model for Riak 2.0. All the smoke 
and mirrors for memory sizing will then go away. The code will automatically 
change caches as vnodes migrate to and from a given node (no need to "reserve 
50%") â€¦ you just say total memory you want to allocate to Riak and walk away.

Matthew



LevelDB1.2MemModel.Shane.xls
Description: Binary data


On Sep 6, 2013, at 12:10 PM, Shane McEwan  wrote:

&gt; G'day!
&gt; 
&gt; Our Riak nodes have 48GB of RAM in them. When we installed Riak 1.2.0 on them 
&gt; we tuned the LevelDB settings as per the Parameter Planning section in 
&gt; http://docs.basho.com/riak/1.2.0/tutorials/choosing-a-backend/LevelDB/
&gt; 
&gt; {eleveldb, [
&gt; {write\\_buffer\\_size\\_min, 31457280},
&gt; {write\\_buffer\\_size\\_max, 62914560},
&gt; {cache\\_size, 300000000},
&gt; {max\\_open\\_files, 300}
&gt; ]},
&gt; 
&gt; With 64 vnodes per node, an average SST size of 2MB, key size of 150B and 
&gt; average value size of 1024B we were expecting our Riak memory usage to peak 
&gt; at around 24GB . . . the recommended 50% of system memory.
&gt; 
&gt; Currently the Riak process on each of our nodes is using 32GB of RAM and 
&gt; still rising.
&gt; 
&gt; I've noticed that since we moved to Riak 1.3.1 new SST files are no longer 
&gt; 2MB but are now 100MB. Recalculating memory usage based on that gives me an 
&gt; expected usage of 32GB. So maybe that explains the higher memory usage than 
&gt; expected.
&gt; 
&gt; So, 2 questions:
&gt; 
&gt; Can we expect the memory usage to plateau soon?
&gt; 
&gt; The cache\\_size of 300MB should allow for one of our nodes to go down and 
&gt; we'll still be under the 50% threshold when the 64 down vnodes are shared 
&gt; amongst the remaining three nodes . . . except we're already using more than 
&gt; the 24GB threshold (or the new 32GB threshold with 100MB SSTs) with all four 
&gt; nodes still up. How can this be?
&gt; 
&gt; I'd appreciate if someone could do the math for me and come up with suggested 
&gt; tuning parameters because I'm losing faith in the documentation:
&gt; 
&gt; Riak: 1.3.1
&gt; Nodes: 4
&gt; Total RAM per node: 48GB
&gt; Desired RAM allocated to Riak: 24GB
&gt; ring\\_creation\\_size: 256
&gt; Partitions per node: 64
&gt; 
&gt; Thanks!
&gt; 
&gt; Shane.
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

