---
title: "Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys"
description: ""
project: community
lastmod: 2011-05-26T11:19:39-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03433"
mailinglist_parent_id: "msg03427"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-05-26T11:19:39-07:00
---


Kyle, you bring up a good point that I feel strongly about -- most people use 
list-keys as a substitute for better solutions (also known as an anti-pattern). 
 In most cases what they really need is one of:

\\* Better key/schema design, so keys are at least guessable if not knowable.
\\* Secondary indexes, which can sometimes be built manually, but are also in the 
product roadmap.
\\* Full-text search.

None of these require list keys, but all of them require strong knowledge of 
your problem domain and creative thinking.

With all of this discussion it has been pointed out to me there are two issues 
at hand, possibly conflated as one:

\\* Which is the least surprise, caching the key list or the incurring the large 
cost of the operation? Or is it that it is apparently performant in development 
(small numbers of keys) but not in production (large numbers of keys)?
\\* How can we better discourage use of list-keys while still exposing to 
developers who can handle the performance hit (or enjoy holes in their feet)?

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On May 26, 2011, at 12:52 PM, Aphyr wrote:

&gt; Agreed. In fact, jrecursive pointed out to me last week that vnode operations 
&gt; are synchronous. That means that when you call list-keys, not only is it 
&gt; going to take a long time (right now upwards of 5 minutes) to complete, but 
&gt; while each vnode is returning its list of keys \\*it blocks any other requests\\*.
&gt; 
&gt; While list-keys is an unfortunate necessity for some things, its use should 
&gt; be minimized if you're going to get to any appreciable (100M keys) scale. I 
&gt; don't even know how we're going to use it at all above a billion. Possibly by 
&gt; listing the keys periodically from bitcask directly, and maintaining an index 
&gt; ourselves.
&gt; 
&gt; --Kyle
&gt; 
&gt; On 05/26/2011 09:40 AM, Sean Cribbs wrote:
&gt;&gt; With recent commits (
&gt;&gt; https://github.com/seancribbs/ripple/compare/35d7323fb0e179c8c971...da3ab71a19d194c65a7b
&gt;&gt; 
&gt;&gt; ), it is cached until you either refresh it manually by passing :reload
&gt;&gt; =&gt; true or a block (for streaming key lists). This was the compromise
&gt;&gt; reached in that pull-request.
&gt;&gt; 
&gt;&gt; All of this caching discussion glosses over the fact that you \\*should
&gt;&gt; not list keys\\* in any real application. It really begs the question --
&gt;&gt; how often do you list keys in Redis, or memcached? I suspect that
&gt;&gt; generally you don't. This isn't a relational database. (Also, how often
&gt;&gt; do you actually do a full-table scan in MySQL? You don't if you're sane
&gt;&gt; -- you use an index, or even LIMIT + OFFSET.)
&gt;&gt; 
&gt;&gt; I'm tempted to remove Document::all and make Bucket#keys harder to
&gt;&gt; access, but the balance between discouraging bad behavior and exposing
&gt;&gt; available functionality is a hard one to strike. I don't want new
&gt;&gt; developers to immediately use list-keys and then be discouraged from
&gt;&gt; using Riak because it's slow; on the other hand, it /can be useful/ in
&gt;&gt; some circumstances. In those cases where it's useful, the developer
&gt;&gt; should probably be responsible enough to request the key list only once;
&gt;&gt; the caching behavior simply does this for them. I guess whether it
&gt;&gt; /should/ do this for them is the issue at hand.
&gt;&gt; 
&gt;&gt; All that said, I'm really torn on this issue, and the same problem
&gt;&gt; applies to full-bucket MapReduce. Caveat emptor.
&gt;&gt; 
&gt;&gt; Sean Cribbs &gt;
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://basho.com/
&gt;&gt; 
&gt;&gt; On May 26, 2011, at 10:35 AM, Jonathan Langevin wrote:
&gt;&gt; 
&gt;&gt;&gt; How long is the key list cached like that, naturally?\\*
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; \\*/
&gt;&gt;&gt; /\\*Jonathan Langevin\\*/
&gt;&gt;&gt; Systems Administrator
&gt;&gt;&gt; \\*Loom Inc.\\*
&gt;&gt;&gt; Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com
&gt;&gt;&gt;  - www.loomlearning.com
&gt;&gt;&gt;  - Skype: intel352
&gt;&gt;&gt; 
&gt;&gt;&gt; /\\*
&gt;&gt;&gt; 
&gt;&gt;&gt; \\*
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Thu, May 26, 2011 at 10:35 AM, Sean Cribbs &gt;&gt; &gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Keith,
&gt;&gt;&gt; 
&gt;&gt;&gt; There was a pull-request issue out for this on the Github project
&gt;&gt;&gt; (https://github.com/seancribbs/ripple/pull/168). For various
&gt;&gt;&gt; reasons, the list of keys is memoized in the Riak::Bucket
&gt;&gt;&gt; instance. Passing :reload =&gt; true to the #keys method will cause
&gt;&gt;&gt; it to refresh. I like to discourage list-keys, but with the
&gt;&gt;&gt; memoized list you don't shoot yourself in the foot as often.
&gt;&gt;&gt; 
&gt;&gt;&gt; Sean Cribbs &gt;
&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt; 
&gt;&gt;&gt; On May 26, 2011, at 10:29 AM, Keith Bennett wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; &gt; All -
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; I just started working with Riak, and am using the riak-client
&gt;&gt;&gt; Ruby gem.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; When I delete a key from a bucket, and try to fetch the value
&gt;&gt;&gt; associated with that key, I get a 404 error (which is reasonable).
&gt;&gt;&gt; However, it remains in the bucket's list of keys (i.e. the value
&gt;&gt;&gt; returned by bucket.keys(). Why is the key still reported to exist
&gt;&gt;&gt; in the bucket? Is bucket.keys cached, and therefore unaware of the
&gt;&gt;&gt; deletion? Here's a riak-client Ruby script and its output in irb
&gt;&gt;&gt; that illustrates this:
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :001 &gt; require 'riak'
&gt;&gt;&gt; &gt; =&gt; true
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :002 &gt;
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :003 &gt; client = Riak::Client.new
&gt;&gt;&gt; &gt; =&gt; #&gt;
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :004 &gt; bucket = client['links']
&gt;&gt;&gt; &gt; =&gt; #
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :005 &gt; key = bucket.keys.first
&gt;&gt;&gt; &gt; =&gt; "4000-17.xml"
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :006 &gt; object = bucket[key]
&gt;&gt;&gt; &gt; =&gt; #
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :007 &gt; object.delete
&gt;&gt;&gt; &gt; =&gt; #
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :008 &gt; bucket.keys.first
&gt;&gt;&gt; &gt; =&gt; "4000-17.xml"
&gt;&gt;&gt; &gt; ree-1.8.7-2010.02 :009 &gt; object = bucket[key]
&gt;&gt;&gt; &gt; Riak::HTTPFailedRequest: Expected [200, 300] from Riak but
&gt;&gt;&gt; received 404. not found
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:55:in
&gt;&gt;&gt; `perform'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1054:in
&gt;&gt;&gt; `request'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:2142:in
&gt;&gt;&gt; `reading\\_body'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1053:in
&gt;&gt;&gt; `request'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1037:in
&gt;&gt;&gt; `request'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:543:in
&gt;&gt;&gt; `start'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/rubies/ree-1.8.7-2010.02/lib/ruby/1.8/net/http.rb:1035:in
&gt;&gt;&gt; `request'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:47:in
&gt;&gt;&gt; `perform'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:46:in
&gt;&gt;&gt; `tap'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/net\\_http\\_backend.rb:46:in
&gt;&gt;&gt; `perform'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/http\\_backend/transport\\_methods.rb:59:in
&gt;&gt;&gt; `get'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/client/http\\_backend.rb:72:in
&gt;&gt;&gt; `fetch\\_object'
&gt;&gt;&gt; &gt; from
&gt;&gt;&gt; 
&gt;&gt;&gt; /Users/kbennett/.rvm/gems/ree-1.8.7-2010.02/gems/riak-client-0.9.4/lib/riak/bucket.rb:101:in
&gt;&gt;&gt; `[]'
&gt;&gt;&gt; &gt; from riak-delete-failure.rb:9
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; Thanks,
&gt;&gt;&gt; &gt; Keith
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt; &gt; riak-users@lists.basho.com 
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_listsbasho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com 
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_listsbasho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

