---
title: "Re: "all nodes failed" while using doc sample code"
description: ""
project: community
lastmod: 2010-04-15T14:06:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00053"
mailinglist_parent_id: "msg00035"
author_name: "ben six"
project_section: "mailinglistitem"
sent_date: 2010-04-15T14:06:04-07:00
---


Kevin,

This means the code which creates the anonymous functions needs to be on the
> server-side codepath so the VM receiving the pointer can resolve it to
> runnable code.
>

ok


> If you're just experimenting with the map/reduce API AND you have a single
> Riak server (no cluster)


yes


> then you can get this to work by following these steps:
>
> 1) Start riak via 'bin/riak console'
> 2) Inside the console, obtain a Riak client instance like so: {ok, Client}
> = riak:local\_client()
> 3) Build and execute your map/reduce job inside the riak console
>

i tried the above, so mostly replacing client\_connect with local\_client and
i still get the same type or err :

::./bin/riak console
Exec: /Users/bensix/FromFtp/riak/riak-0.9.1/erts-5.7.5/bin/erlexec -boot
/Users/bensix/FromFtp/riak/riak-0.9.1/releases/0.9.1/riak -embedded -config
/Users/bensix/FromFtp/riak/riak-0.9.1/etc/app.config -args\_file
/Users/bensix/FromFtp/riak/riak-0.9.1/etc/vm.args -- console
Root: /Users/bensix/FromFtp/riak/riak-0.9.1
Erlang R13B04 (erts-5.7.5) [source] [smp:2:2] [rq:2] [async-threads:5]
[hipe] [kernel-poll:true]


=INFO REPORT==== 15-Apr-2010::11:07:21 ===
 alarm\_handler: {set,{{disk\_almost\_full,"/"},[]}}

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.105.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
 alarm\_handler: {set,{system\_memory\_high\_watermark,[]}}

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.106.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.107.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.108.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.109.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.110.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.111.0>)

=INFO REPORT==== 15-Apr-2010::11:07:21 ===
Spidermonkey VM host starting (<0.112.0>)
Eshell V5.7.5 (abort with ^G)
(r...@127.0.0.1)1> {ok, Client} = riak:local\_client().
{ok,{riak\_client,'r...@127.0.0.1',<<4,211,148,124>>}}
(r...@127.0.0.1)2> Count = fun(G, undefined, none) ->
(r...@127.0.0.1)2> [dict:from\_list([{I, 1} || I <-
riak\_object:get\_value(G)])]
(r...@127.0.0.1)2> end.
#Fun
(r...@127.0.0.1)3> Merge = fun(Gcounts, none) ->
(r...@127.0.0.1)3> [lists:foldl(fun(G, Acc) ->
(r...@127.0.0.1)3> dict:merge(fun(\_, X, Y) ->
X+Y end,
(r...@127.0.0.1)3> G, Acc)
(r...@127.0.0.1)3> end,
(r...@127.0.0.1)3> dict:new(),
(r...@127.0.0.1)3> Gcounts)]
(r...@127.0.0.1)3> end.
#Fun
(r...@127.0.0.1)4> {ok, [R]} = Client:mapred([{<<"groceries">>,
<<"mine">>},
(r...@127.0.0.1)4> {<<"groceries">>,
<<"yours">>}],
(r...@127.0.0.1)4> [{map, {qfun, Count}, none,
false},
(r...@127.0.0.1)4> {reduce, {qfun, Merge},
none, true}]).

=ERROR REPORT==== 15-Apr-2010::11:09:24 ===
\*\* State machine <0.325.0> terminating
\*\* Last event in was {mapexec\_error,<0.326.0>,"all nodes failed"}
\*\* When State == executing
\*\* Data == {state,0,riak\_map\_phase,
 {state,true,
 {erlang,
 {map,
 {qfun,#Fun},
 none,false}},
 [],
 {chstate,'r...@127.0.0.1',[],
 {64,
 [{0,'r...@127.0.0.1'},

{22835963083295358096932575511191922182123945984,
 'r...@127.0.0.1'},

{45671926166590716193865151022383844364247891968,
 'r...@127.0.0.1'},

{68507889249886074290797726533575766546371837952,
 'r...@127.0.0.1'},

{91343852333181432387730302044767688728495783936,
 'r...@127.0.0.1'},

{114179815416476790484662877555959610910619729920,
 'r...@127.0.0.1'},

{137015778499772148581595453067151533092743675904,
 'r...@127.0.0.1'},

{159851741583067506678528028578343455274867621888,
 'r...@127.0.0.1'},

{182687704666362864775460604089535377456991567872,
 'r...@127.0.0.1'},

{205523667749658222872393179600727299639115513856,
 'r...@127.0.0.1'},

{228359630832953580969325755111919221821239459840,
 'r...@127.0.0.1'},

{251195593916248939066258330623111144003363405824,
 'r...@127.0.0.1'},

{274031556999544297163190906134303066185487351808,
 'r...@127.0.0.1'},

{296867520082839655260123481645494988367611297792,
 'r...@127.0.0.1'},

{319703483166135013357056057156686910549735243776,
 'r...@127.0.0.1'},

{342539446249430371453988632667878832731859189760,
 'r...@127.0.0.1'},

{365375409332725729550921208179070754913983135744,
 'r...@127.0.0.1'},

{388211372416021087647853783690262677096107081728,
 'r...@127.0.0.1'},

{411047335499316445744786359201454599278231027712,
 'r...@127.0.0.1'},

{433883298582611803841718934712646521460354973696,
 'r...@127.0.0.1'},

{456719261665907161938651510223838443642478919680,
 'r...@127.0.0.1'},

{479555224749202520035584085735030365824602865664,
 'r...@127.0.0.1'},

{502391187832497878132516661246222288006726811648,
 'r...@127.0.0.1'},

{525227150915793236229449236757414210188850757632,
 'r...@127.0.0.1'},

{548063113999088594326381812268606132370974703616,
 'r...@127.0.0.1'},

{570899077082383952423314387779798054553098649600,
 'r...@127.0.0.1'},

{593735040165679310520246963290989976735222595584,
 'r...@127.0.0.1'},

{616571003248974668617179538802181898917346541568,
 'r...@127.0.0.1'},

{639406966332270026714112114313373821099470487552,
 'r...@127.0.0.1'},

{662242929415565384811044689824565743281594433536,
 'r...@127.0.0.1'},

{685078892498860742907977265335757665463718379520,
 'r...@127.0.0.1'},

{707914855582156101004909840846949587645842325504,
 'r...@127.0.0.1'},

{730750818665451459101842416358141509827966271488,
 'r...@127.0.0.1'},

{753586781748746817198774991869333432010090217472,
 'r...@127.0.0.1'},

{776422744832042175295707567380525354192214163456,
 'r...@127.0.0.1'},

{799258707915337533392640142891717276374338109440,
 'r...@127.0.0.1'},

{822094670998632891489572718402909198556462055424,
 'r...@127.0.0.1'},

{844930634081928249586505293914101120738586001408,
 'r...@127.0.0.1'},

{867766597165223607683437869425293042920709947392,
 'r...@127.0.0.1'},

{890602560248518965780370444936484965102833893376,
 'r...@127.0.0.1'},

{913438523331814323877303020447676887284957839360,
 'r...@127.0.0.1'},

{936274486415109681974235595958868809467081785344,
 'r...@127.0.0.1'},

{959110449498405040071168171470060731649205731328,
 'r...@127.0.0.1'},

{981946412581700398168100746981252653831329677312,
 'r...@127.0.0.1'},

{1004782375664995756265033322492444576013453623296,
 'r...@127.0.0.1'},

{1027618338748291114361965898003636498195577569280,
 'r...@127.0.0.1'},

{1050454301831586472458898473514828420377701515264,
 'r...@127.0.0.1'},

{1073290264914881830555831049026020342559825461248,
 'r...@127.0.0.1'},

{1096126227998177188652763624537212264741949407232,
 'r...@127.0.0.1'},

{1118962191081472546749696200048404186924073353216,
 'r...@127.0.0.1'},

{1141798154164767904846628775559596109106197299200,
 'r...@127.0.0.1'},

{1164634117248063262943561351070788031288321245184,
 'r...@127.0.0.1'},

{1187470080331358621040493926581979953470445191168,
 'r...@127.0.0.1'},

{1210306043414653979137426502093171875652569137152,
 'r...@127.0.0.1'},

{1233142006497949337234359077604363797834693083136,
 'r...@127.0.0.1'},

{1255977969581244695331291653115555720016817029120,
 'r...@127.0.0.1'},

{1278813932664540053428224228626747642198940975104,
 'r...@127.0.0.1'},

{1301649895747835411525156804137939564381064921088,
 'r...@127.0.0.1'},

{1324485858831130769622089379649131486563188867072,
 'r...@127.0.0.1'},

{1347321821914426127719021955160323408745312813056,
 'r...@127.0.0.1'},

{1370157784997721485815954530671515330927436759040,
 'r...@127.0.0.1'},

{1392993748081016843912887106182707253109560705024,
 'r...@127.0.0.1'},

{1415829711164312202009819681693899175291684651008,
 'r...@127.0.0.1'},

{1438665674247607560106752257205091097473808596992,
 'r...@127.0.0.1'}]},
 {dict,0,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 [],[]},

{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 [],[]}}}},
 [<0.326.0>,<0.327.0>]},
 false,false,undefined,undefined,
 [<0.324.0>,<0.323.0>],
 0,<0.322.0>,66000}
\*\* Reason for termination =
\*\* "all nodes failed"
\*\* exception error: no match of right hand side value "all nodes failed"

but earlier :
(r...@127.0.0.1)5> riak:client\_test(node()).
ok
(r...@127.0.0.1)6>
=INFO REPORT==== 15-Apr-2010::13:15:52 ===
Successfully completed 1 read/write cycle to 'r...@127.0.0.1'



>
> Alternatively, you'll need to define your map/reduce functions in a proper
> Erlang module and distribute it to all the Riak nodes and insure it's on the
> codepath. If you decide to go this route you can use Erlang's hot code
> loading to load updated versions of the functions without needing to reboot
> the Riak nodes.
>
> --Kevin
> On Apr 13, 2010, at 11:58 PM, ben six wrote:
>
> >
> > on macos 10.6.3 using riak-0.9.1 following instructions at
> https://wiki.basho.com/display/RIAK/Installing+on+Mac+OS+X
> > install and test passed without issue.
> > then tried the erland mapreduce example at
> https://wiki.basho.com/display/RIAK/MapReduce#MapReduce-MapReduceviatheErlangAPI
> >
> > ~/FromFtp/riak/riak-0.9.1/erts-5.7.5/bin/erl -name 
> > riakcli...@127.0.0.1-setcookie riak -pa 
> > `pwd`/lib/riak-0.9.1.ez/riak-0.9.1/ebin
> > Erlang R13B04 (erts-5.7.5) [source] [smp:2:2] [rq:2] [async-threads:0]
> [hipe] [kernel-poll:false]
> >
> > Eshell V5.7.5 (abort with ^G)
> > (riakcli...@127.0.0.1)1> code:which(riak).
> > "~/FromFtp/riak/riak-0.9.1/lib/riak-0.9.1.ez/riak-0.9.1/ebin/riak.beam"
> > (riakcli...@127.0.0.1)2> {ok, Client} = riak:client\_connect('
> r...@127.0.0.1').
> > {ok,{riak\_client,'r...@127.0.0.1',<<6,202,197,138>>}}
> > (riakcli...@127.0.0.1)4> Count = fun(G, undefined, none) ->
> > (riakcli...@127.0.0.1)4> [dict:from\_list([{I, 1} || I <-
> riak\_object:get\_value(G)])]
> > (riakcli...@127.0.0.1)4> end.
> > #Fun
> > (riakcli...@127.0.0.1)5> Merge = fun(Gcounts, none) ->
> > (riakcli...@127.0.0.1)5> [lists:foldl(fun(G, Acc) ->
> > (riakcli...@127.0.0.1)5> dict:merge(fun(\_,
> X, Y) -> X+Y end,
> > (riakcli...@127.0.0.1)5> G, Acc)
> > (riakcli...@127.0.0.1)5> end,
> > (riakcli...@127.0.0.1)5> dict:new(),
> > (riakcli...@127.0.0.1)5> Gcounts)]
> > (riakcli...@127.0.0.1)5> end.
> > #Fun
> > (riakcli...@127.0.0.1)6> {ok, [R]} = Client:mapred([{<<"groceries">>,
> <<"mine">>},
> > (riakcli...@127.0.0.1)6> {<<"groceries">>,
> <<"yours">>}],
> > (riakcli...@127.0.0.1)6> [{map, {qfun,
> Count}, none, false},
> > (riakcli...@127.0.0.1)6> {reduce, {qfun,
> Merge}, none, true}]).
> > \*\* exception error: no match of right hand side value "all nodes failed"
> >
> > above happened when starting riak with console or plain ./bin/riak start
> (riak's erl shell : Erlang R13B04 (erts-5.7.5) [source] [smp:2:2] [rq:2]
> [async-threads:0] [hipe] [kernel-poll:false])
> >
> > also error when using erlang shell (from port : Erlang R13B03
> (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2] [async-threads:0] [hipe]
> [kernel-poll:false]) :
> > ::erl -name riakcli...@127.0.0.1 -setcookie riak -pa
> `pwd`/lib/riak-0.9.1.ez/riak-0.9.1/ebin
> > Erlang R13B03 (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2]
> [async-threads:0] [hipe] [kernel-poll:false]
> >
> > Eshell V5.7.4 (abort with ^G)
> > (riakcli...@127.0.0.1)1> code:which(riak).
> > "~/FromFtp/riak/riak-0.9.1/lib/riak-0.9.1.ez/riak-0.9.1/ebin/riak.beam"
> > (riakcli...@127.0.0.1)2> {ok, Client} = riak:client\_connect('
> r...@127.0.0.1').
> > {ok,{riak\_client,'r...@127.0.0.1',<<4,181,78,207>>}}
> > (riakcli...@127.0.0.1)4> Count = fun(G, undefined, none) ->
> > (riakcli...@127.0.0.1)4> [dict:from\_list([{I, 1} || I <-
> riak\_object:get\_value(G)])]
> > (riakcli...@127.0.0.1)4> end.
> > #Fun
> > (riakcli...@127.0.0.1)5> Merge = fun(Gcounts, none) ->
> > (riakcli...@127.0.0.1)5> [lists:foldl(fun(G, Acc) ->
> > (riakcli...@127.0.0.1)5> dict:merge(fun(\_,
> X, Y) -> X+Y end,
> > (riakcli...@127.0.0.1)5> G, Acc)
> > (riakcli...@127.0.0.1)5> end,
> > (riakcli...@127.0.0.1)5> dict:new(),
> > (riakcli...@127.0.0.1)5> Gcounts)]
> > (riakcli...@127.0.0.1)5> end.
> > #Fun
> > (riakcli...@127.0.0.1)6> {ok, [R]} = Client:mapred([{<<"groceries">>,
> <<"mine">>},
> > (riakcli...@127.0.0.1)6> {<<"groceries">>,
> <<"yours">>}],
> > (riakcli...@127.0.0.1)6> [{map, {qfun,
> Count}, none, false},
> > (riakcli...@127.0.0.1)6> {reduce, {qfun,
> Merge}, none, true}]).
> > \*\* exception error: undefined function luke:new\_flow/5
> > in function riak\_client:mapred\_stream/4
> > in call from riak\_client:mapred/4
> >
> > i used the default config files so the cookie is also consistant.
> > new to this so not sure where to get from there.
> > \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> > riak-users mailing list
> > riak-users@lists.basho.com
> > http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>
>
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

