---
title: "Re: Using protobuf client in Java"
description: ""
project: community
lastmod: 2010-04-19T15:09:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00079"
mailinglist_parent_id: "msg00078"
author_name: "Matthew Pflueger"
project_section: "mailinglistitem"
sent_date: 2010-04-19T15:09:28-07:00
---


Thanks Jon! That was exactly my problem... Quick note on your
example, msgLen should be msgLen-1 because you already read the
msgCode byte which is included in the msgLen...


--Matthew



On Mon, Apr 19, 2010 at 17:46, Jon Meredith  wrote:
> Hi Matthew,
>
> When you read the serverInfoResp you need to read the header to find the
> length of the response message. The header is 5-bytes - 4-bytes of length
> and 1-byte of message code. You should just use the parseFrom calls - not
> the parseFromDelimited ones.
>
> Please excuse my java - I haven't done any in a long time (a quick googling
> couldn't find what to use for ntohl)
>
>    byte[] hdr = in.readRawBytes(5);
>    int msgLen = (hdr[0] << 24) + (hdr[1] << 16) + (hdr[2] << 8) + hdr[3]; //
> ntohl
>    byte msgCode = hdr[4];
>    byte[] resp = in.readRawBytes(msgLen);
>    RpbGetServerInfoResp serverInfoResp =
> RpbGetServerInfoResp.parseFrom(resp)
>
> Jon
>
>
> On 4/19/10 3:33 PM, Matthew Pflueger wrote:
>>
>> Hi,
>>
>> I’m having issues using the protobuf stuff.  Writing/reading bytes
>> directly to/from the socket works but using the protoc generated Java
>> message builders either gives me nothing useful back or throws invalid
>> protocol exceptions.  I’ve never used the protobuf stuff before so
>> maybe I’m doing something stupid...
>>
>> First I modified the riakclient.proto file inserting a package
>> declaration: option java\_package = "";
>>
>>         protoc -I=. --java\_out=./src riakclient.proto
>>
>>         //ping
>>         out.writeRawBytes(new byte[] {0, 0, 0, 1, 1});
>>         out.flush();
>>
>>         //pong {0, 0, 0, 1, 2}
>>         byte[] bytes = in.readRawBytes(5);
>>         assert bytes[4] == 2;
>>
>>         //get server info
>>         out.writeRawBytes(new byte[] {0, 0, 0, 1, 7});
>>         out.flush();
>>
>>         RpbGetServerInfoResp serverInfoResp =
>> RpbGetServerInfoResp.parseDelimitedFrom(socket.getInputStream());
>>         System.out.println("Connected to: " +
>> serverInfoResp.getNode().toStringUtf8());//toString());
>>
>> parseDelimitedFrom doesn't throw an error but I get nothing back...
>> Using parseFrom I get an error...  Any help would be appreciated...
>>
>> --Matthew
>>
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>>
>
>

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

