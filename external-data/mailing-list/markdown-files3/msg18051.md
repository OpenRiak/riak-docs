---
title: "[CRDT_OP-in-CommitHook]"
description: ""
project: community
lastmod: 2017-03-01T22:59:28-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18051"
author_name: "李明"
project_section: "mailinglistitem"
sent_date: 2017-03-01T22:59:28-08:00
---


Hi
 I am new to erlang and riak. I started to use riak as a kv store couple
of months ago. Now i want to implement a commit hook to riak so that riak
could help me to make some statistics.
i read some docs and write a pre-hook scripts, which will fetch the object
key and store it into a set.
 This hook works fine if there is only one client write to riak, but if i
increase the connection to riak writing, i found it lost some elements in
the set. Looks like the crdt\_op did not do the merge operation.And there is
no obvious error in the log files.

 Could someone help me to finger out what happened or what i has missed.

i am using the riak 2.1.3

Thanks all!


Here is the hook scripts:

------------------------------------------------------------
------------------------------------------

-module(myhook).
-export([pretest/1]).

now\_to\_local\_string({MegaSecs, Secs, MicroSecs}) ->
 LocalTime = calendar:now\_to\_local\_time({MegaSecs, Secs, MicroSecs}),
 {{Year, Month, Day}, {Hour, Minute, \_}} = LocalTime,
 TimeStr = lists:flatten(io\_lib:format("~4..0w~2..0w~2..0w~2..0w~2..0w",
 [Year, Month, Day, Hour, Minute])),
 TimeStr.

is\_deleted(Object)->
 case dict:find(<<"X-Riak-Deleted">>,riak\_object:get\_metadata(Object)) of
 {ok,\_} ->
 true;
 \_ ->
 false
 end.

pretest(Object) ->
 % timer:sleep(10000),
 try
 ObjBucket = riak\_object:bucket(Object),
 % riak\_object:bucket(Obj).
% {<<"cn-archive">>,<<"local-test">>}

Bucket = element(2, ObjBucket),
BucketType = element(1, ObjBucket),

ObjKey = riak\_object:key(Object),
% Key = binary\_to\_list(ObjKey),
% ObjData = riak\_object:get\_value(Object),
% Msg = binary\_to\_list(ObjData),
 CommitItem = iolist\_to\_binary(mochijson2:encode({struct, [{b, Bucket},
{k, ObjKey}, {t, BucketType}]})),

 case is\_deleted(Object) of
 true ->
 KeyPrefix = "delete";
\_ ->
KeyPrefix = "update"
end,

CurMin = now\_to\_local\_string(os:timestamp()),
 IndexKey = binary:list\_to\_bin(io\_lib:format("~s-~s", [CurMin,
KeyPrefix])),

 %% Get a riak client
 {ok, C} = riak:local\_client(),
 % get node obj
ThisNode = atom\_to\_binary(node(), latin1),

% get index obj and set context
BType = <<"archive">>,
B = <<"local-test">>,
{SetObj, Context} = case C:get({BType, B}, IndexKey) of
 {error, notfound} ->
 ThisSetObj = riak\_kv\_crdt:new({BType, B}, IndexKey, riak\_dt\_orswot),
 {ThisSetObj, undefined};
 {ok, ThisSetObj} ->
 % The datatype update requires the context if the value exists
 {{Ctx, \_}, \_} = riak\_kv\_crdt:value(ThisSetObj, riak\_dt\_orswot),
 {ThisSetObj, Ctx}
end,

UpdateIndex = [{add, CommitItem}],
% UpdateOp = {crdt\_op, riak\_dt\_orswot, {update, UpdateIndex}, Context},
UpdateOp = {crdt\_op, riak\_dt\_orswot, {update, UpdateIndex}, undefined},
NewObj = riak\_kv\_crdt:update(SetObj, ThisNode, UpdateOp),

error\_logger:info\_msg("Updating index for ~s,to set ~s~n",
[binary:bin\_to\_list(CommitItem), IndexKey]),

C:put(NewObj),
Object
 catch
 error:Error ->
{fail, lists:flatten(io\_lib:format("[PREHOOKEXCEPTION]~p",[Error]))}
end.

------------------------------------------------------------
------------------------------------------


This is the set bucket props
------------------------------------------------------------
------------------------------------------

active: true
allow\_mult: true
basic\_quorum: false
big\_vclock: 50
chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
claimant: 'riak@192.168.100.2'
datatype: set
dvv\_enabled: true
dw: quorum
last\_write\_wins: false
linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
n\_val: 3
notfound\_ok: true
old\_vclock: 86400
postcommit: []
pr: 0
precommit: []
pw: 0
r: quorum
rw: quorum
small\_vclock: 50
w: quorum
young\_vclock: 20
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

