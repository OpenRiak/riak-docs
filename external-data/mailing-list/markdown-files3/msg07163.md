---
title: "Re: slow mapred_search key lookups for single terms"
description: ""
project: community
lastmod: 2012-04-06T08:00:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07163"
mailinglist_parent_id: "msg07153"
author_name: "Michael Radford"
project_section: "mailinglistitem"
sent_date: 2012-04-06T08:00:34-07:00
---


Calling riak\_kv\_mrc\_pipe directly from the console is just as slow as
using the pb interface.

Re: the pb interface itself, I noticed looking at the fprof analysis
that it seemed to be encoding one PB message per search result and
spending quite a bit of time doing it, e.g., this stanza:

{[{{riakc\_pb,encode,1}, 15188, 7779.607, 1063.390}],
 { {riakclient\_pb,iolist,2}, 15188, 7779.607, 1063.390}, %
 [{{riakclient\_pb,pack,5}, 45564, 6304.788, 482.190},
 {{riakclient\_pb,with\_default,2}, 45564, 406.986, 406.986},
 {garbage\_collect, 2, 2.792, 2.792},
 {suspend, 149, 1.651, 0.000}]}.

and similar numbers on the client side. So if there's an opportunity
for batching the search results, that seems like it would be a big
improvement as well.

(It looks like that is currently up to whatever process is sending the
results in the first place. But maybe it would be a good idea for the
pb socket to accumulate M/R results until it reaches some threshold of
bytes to send...calling term\_to\_binary to estimate is pretty fast.)

Mike

On Fri, Apr 6, 2012 at 5:56 AM, Bryan Fink  wrote:
> On Thu, Apr 5, 2012 at 3:51 PM, Bryan Fink  wrote:
>> This \*might\* be the wrong intuition for Search, since there is
>> funneling happening to process the query anyway, but it's likely a
>> good place to start.
>
> Whoops.  I \*really\* should have included a suggestion for how to
> figure out whether this is the case, or if it is PB related.  The most
> straightforward test will be to run the same query one more time, but
> this time use the `riak\_kv\_mrc\_pipe` module.  Attach to the Riak
> console, just as you did for the internal-cluster client test, but
> instead of
>
>    {ok, Client} = riak:local\_client(),
>    Client:mapred(Inputs, Phases).
>
> use instead
>
>    riak\_kv\_mrc\_pipe:mapred(Inputs, Phases).
>
> If that is also much slower than the native client, then the problem
> is not with the PB interface.  If it's nearly on-par, then the PB
> interface needs inspection.
>
> -Bryan

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

