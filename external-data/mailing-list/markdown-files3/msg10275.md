---
title: "Re: How to call mapreduce from Riak client?"
description: ""
project: community
lastmod: 2013-02-27T07:29:45-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10275"
author_name: "Miroslav Urbanek"
project_section: "mailinglistitem"
sent_date: 2013-02-27T07:29:45-08:00
---


Answering my own e-mail:

The function has to be executed on a Riak node. The script should call

rpc:call(Host, riak\_kv\_mrc\_pipe, mapred, [Inputs, Phases])

instead of

riak\_kv\_mrc\_pipe:mapred(Inputs, Phases).

Miro

On Tue, Feb 26, 2013 at 10:39 PM, Miroslav Urbanek
 wrote:
> Dear Riak users,
>
> I have an Erlang script for counting the number of objects in a Riak bucket:
>
> ...
> Inputs = <<"buckets">>,
> Phases = [{reduce,{modfun,riak\_kv\_mapreduce,reduce\_count\_inputs},none,true}],
> ...
> {ok, Client} = riak:client\_connect(Host)
> Client:mapred(Inputs, Phases)
> ...
>
> After the update to 1.3, this no longer works. In the mailing list
> archive I found an alternative method:
>
> riak\_kv\_mrc\_pipe:mapred(Inputs, Phases)
>
> However, I'm getting the following error:
>
> escript: exception exit: {noproc,{gen\_server,call,
> [riak\_kv\_mrc\_sink\_sup,
> {start\_child,[<0.2.0>,[]]},
> infinity]}}
> in function gen\_server:call/3 (gen\_server.erl, line 188)
> in call from riak\_kv\_mrc\_pipe:mapred\_stream\_sink/3
> (src/riak\_kv\_mrc\_pipe.erl, line 266)
> in call from riak\_kv\_mrc\_pipe:mapred/3 (src/riak\_kv\_mrc\_pipe.erl, line 219)
>
> What does it mean? What's the optimal way to count number of keys in a
> bucket in Riak 1.3 anyway?
>
> Here's the complete script:
>
> #!/usr/bin/env escript
>
> main(\_) ->
>
> Host = 'riak@domain',
> Inputs = <<"bucket">>,
> Phases = 
> [{reduce,{modfun,riak\_kv\_mapreduce,reduce\_count\_inputs},none,true}],
>
> ok = application:start(inets),
> {ok, \_} = net\_kernel:start([count]),
> true = auth:set\_cookie('riak'),
> true = net\_kernel:connect\_node(Host),
>
> case riak\_kv\_mrc\_pipe:mapred(Inputs, Phases) of
> {ok, Result} -> io:format("OK: ~p~n", Result);
> {error, Reason} -> io:format("Error: ~p~n", Reason)
> end.
>
> Thanks,
> Miro

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

