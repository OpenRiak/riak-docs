---
title: "Re: broken values in luwak"
description: ""
project: community
lastmod: 2012-01-14T09:01:58-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06284"
mailinglist_parent_id: "msg06264"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2012-01-14T09:01:58-08:00
---


Hi Ryan, thanks.

In this case I also came up with a workaround: serving those files
from disk. Which solved our user problem. I'll try out your code and
let you know how it went.

Francisco


2012/1/12 Ryan Zezeski :
> Francisco,
>
> I'm not sure how it happend, but perhaps the file was updated at some point
> and the root became a pointer to an empty tree.  If you didn't already know
> Luwak keeps all old versions of your file around, but it doesn't really have
> any APIs for accessing it.  Try attaching to the Riak console and run the
> following:
>
>
> {ok, C} = riak:local\_client().
> {ok, F} = luwak\_file:get(C, <<"filename">>).
> PrevRoot = hd(luwak\_file:get\_property(F, ancestors)).
> V = riak\_object:get\_value(F).
> V2 = lists:keyreplace(root, 1, V, {root, PrevRoot}).
> TempF = riak\_object:apply\_updates(riak\_object:update\_value(F, V2)).
> Bytes = luwak\_io:get\_range(C, TempF, 0, Length). % where Length is number of
> bytes you want to read
>
> I also made a gist of the above: https://gist.github.com/1602953
>
> If the first ancestor doesn't give you anything then keep moving down the
> list.  Otherwise, if you do find the data you are looking for let me know
> and we'll see if we can't get your file object fixed.
>
> -Ryan
>
> On Thu, Jan 12, 2012 at 2:12 PM, francisco treacy
>  wrote:
>>
>> Hi Kelly,
>>
>> Yes, I had removed a node from the cluster and then forced
>> read-repair. I think it was you actually help me out a couple of
>> months ago with this.
>>
>> So far we didn't run into any other broken assets, but we need to get
>> these up. Ideas?
>>
>> Thanks,
>>
>> Francisco
>>
>> 2012/1/12 Kelly McLaughlin :
>> > Francisco,
>> >
>> > Is it the case that you have already tried to force read repair on the
>> > file chunks and are still seeing these errors?
>> >
>> > Kelly
>> >
>> > On Jan 12, 2012, at 10:57 AM, francisco treacy wrote:
>> >
>> >> Hi,
>> >>
>> >> One of my users is preparing an exam but can't load an image because
>> >> Luwak is serving it broken (i.e. responds with HTTP 200; 0 bytes)
>> >>
>> >> Visibly caused by a non-existing chunk of that file on that partition.
>> >> I would've expected read-repair to kick in and update the value. But
>> >> it keeps on serving 0 bytes.
>> >>
>> >> Why is this happening and how can I fix it?
>> >>
>> >> Thanks,
>> >>
>> >> Francisco
>> >>
>> >>
>> >> =CRASH REPORT==== 12-Jan-2012::18:42:29 ===
>> >>  crasher:
>> >>    initial call: luke\_flow:init/1
>> >>    pid: <0.16316.2941>
>> >>    registered\_name: []
>> >>    exception exit:
>> >>
>> >> {error,{phase\_error,{error,{throw,{function\_clause,[{riak\_object,get\_value,[{error,notfound}]},{luwak\_get\_stream,-map\_fun/0-fun-0-,3},{riak\_kv\_mapper,run\_map,9},{riak\_kv\_mapper,-do\_map/2-fun-0-,9},{lists,foldl,3},{riak\_kv\_mapper,do\_map,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]},[{luwak\_get\_stream,-map\_fun/0-fun-0-,3},{riak\_kv\_mapper,run\_map,9},{riak\_kv\_mapper,-do\_map/2-fun-0-,9},{lists,foldl,3},{riak\_kv\_mapper,do\_map,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}}}}
>> >>      in function  gen\_fsm:terminate/7
>> >>      in call from proc\_lib:init\_p\_do\_apply/3
>> >>    ancestors: [luke\_flow\_sup,luke\_sup,<0.10483.536>]
>> >>    messages: []
>> >>    links: [<0.10485.536>]
>> >>    dictionary: []
>> >>    trap\_exit: true
>> >>    status: running
>> >>    heap\_size: 610
>> >>    stack\_size: 24
>> >>    reductions: 258
>> >>  neighbours:
>> >>
>> >> =SUPERVISOR REPORT==== 12-Jan-2012::18:42:29 ===
>> >>     Supervisor: {local,luke\_flow\_sup}
>> >>     Context:    child\_terminated
>> >>     Reason:
>> >>
>> >> {error,{phase\_error,{error,{throw,{function\_clause,[{riak\_object,get\_value,[{error,notfound}]},{luwak\_get\_stream,-map\_fun/0-fun-0-,3},{riak\_kv\_mapper,run\_map,9},{riak\_kv\_mapper,-do\_map/2-fun-0-,9},{lists,foldl,3},{riak\_kv\_mapper,do\_map,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]},[{luwak\_get\_stream,-map\_fun/0-fun-0-,3},{riak\_kv\_mapper,run\_map,9},{riak\_kv\_mapper,-do\_map/2-fun-0-,9},{lists,foldl,3},{riak\_kv\_mapper,do\_map,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}}}}
>> >>     Offender:
>> >>
>> >> [{pid,<0.16316.2941>},{name,undefined},{mfa,{luke\_flow,start\_link,[<10351.27714.2432>,18337056,[{riak\_kv\_map\_phase,[],[{erlang,{map,{qfun,#Fun},{map,{riak\_client,ri...@xx.165.253.xx,<<[2,139,139,84]>>},1000000,#Ref<0.0.487.249801>,<0.16313.2941>,0,76134},false}}]}],undefined,66000]}},{restart\_type,temporary},{shutdown,brutal\_kill},{child\_type,worker}]
>> >>
>> >> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> >> riak-users mailing list
>> >> riak-users@lists.basho.com
>> >> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>> >
>>
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>
>

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

