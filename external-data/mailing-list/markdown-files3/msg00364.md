---
title: "question about postcommit hooks and patch"
description: ""
project: community
lastmod: 2010-05-13T15:16:30-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00364"
author_name: "Bruce Lowekamp"
project_section: "mailinglistitem"
sent_date: 2010-05-13T15:16:30-07:00
---


I've been playing with using postcommit hooks in some code. I
couldn't find an example, so looking at the source, I think the right
way to set one up is something like:

PHook = {struct, [ {<<"mod">>, <MODULE\_STRING>}, {<<"fun">>,
<<"notify\_change">>}]},
RiakClient:set\_bucket(<MY\_KEY>, [{postcommit, [PHook]}]),

Is there a better way?


Also, in debugging my hook, I found that wrapping the hook so I could
see exceptions made it much easier. I made the following patch that I
think might be useful to others, as well:

diff -r e836ea266eca apps/riak\_kv/src/riak\_kv\_put\_fsm.erl
--- a/apps/riak\_kv/src/riak\_kv\_put\_fsm.erl Thu May 13 17:28:01 2010 -0400
+++ b/apps/riak\_kv/src/riak\_kv\_put\_fsm.erl Thu May 13 14:50:07 2010 -0700
@@ -314,7 +314,7 @@
 invoke\_hook(precommit, Mod0, Fun0, undefined, RObj) ->
 Mod = binary\_to\_atom(Mod0, utf8),
 Fun = binary\_to\_atom(Fun0, utf8),
- Mod:Fun(RObj);
+ wrap\_hook(Mod, Fun, RObj);
 invoke\_hook(precommit, undefined, undefined, JSName, RObj) ->
 case riak\_kv\_js\_manager:blocking\_dispatch({{jsfun, JSName}, RObj}) of
 {ok, <<"fail">>} ->
@@ -331,13 +331,22 @@
 invoke\_hook(postcommit, Mod0, Fun0, undefined, Obj) ->
 Mod = binary\_to\_atom(Mod0, utf8),
 Fun = binary\_to\_atom(Fun0, utf8),
- proc\_lib:spawn(fun() -> Mod:Fun(Obj) end);
+ proc\_lib:spawn(fun() -> wrap\_hook(Mod,Fun,Obj) end);
 invoke\_hook(postcommit, undefined, undefined, \_JSName, \_Obj) ->
 error\_logger:warning\_msg("Javascript post-commit hooks aren't
implemented");
 %% NOP to handle all other cases
 invoke\_hook(\_, \_, \_, \_, RObj) ->
 RObj.

+wrap\_hook(Mod, Fun, Obj)->
+ try Mod:Fun(Obj)
+ catch
+ EType:X ->
+ error\_logger:error\_msg("problem invoking hook ~p:~p ->
~p:~p~n~p~n",
+ [Mod, Fun, EType, X,
erlang:get\_stacktrace()]),
+ fail
+ end.
+
 merge\_robjs(RObjs0,AllowMult) ->
 RObjs1 = [X || X <- [riak\_kv\_util:obj\_not\_deleted(O) ||
 O <- RObjs0], X /= undefined],



Bruce

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

