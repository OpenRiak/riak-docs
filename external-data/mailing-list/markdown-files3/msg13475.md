---
title: "Re: riak2 erlang mapreduce counters"
description: ""
project: community
lastmod: 2014-01-24T00:00:16-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13475"
mailinglist_parent_id: "msg13473"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2014-01-24T00:00:16-08:00
---


Hi Bryce,

Sorry about this, and thanks for the detailed info. I do need to add MapReduce 
friendly functions.

On 23 Jan 2014, at 23:51, Bryce Verdier  wrote:

> Thank you both Eric & Russeli for the answer, sadly it leads to more 
> questions. Regardless of the type (though I can say in this case the counters 
> were pushed from the python 2.0.2 client, so I assume its riak\_dt\_pncounter)

It is a riak\_kv\_pncounter, I don’t think any of the clients support the new API 
end points (bucket types) so you’ll be using the 1.4 counter.

> 
> I get this error:
> {"phase":0,"error":"badarg","input":"{ok,{r\_object,<<\"ogir-fp\">>,<<\"682l2fp6\">>,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[<<\"content-type\">>,97,112,112,108,105,99,97,116,105,111,110,47,114,105,97,107,95,99,111,117,110,116,101,114],[<<\"X-Riak-VTag\">>,52,103,66,88,71,122,56,55,111,105,66,112,103,65,75,99,54,72,55,69,110,79]],[[<<\"index\">>]],[],[[<<\"X-Riak-Last-Modified\">>|{1390,508268,984013}]],[],[]}}},<<69,1,71,1,0,0,0,29,70,1,131,108,0,0,0,1,104,2,109,...>>}],...},...}","type":"error","stack":"[{erlang,apply,[<<\"riak\_kv\_pncounter\">>,new,[]],[]},{riak\_kv\_crdt,crdt\_value,2,[{file,\"src/riak\_kv\_crdt.erl\"},{line,94}]},{riak\_kv\_crdt,value,2,[{file,\"src/riak\_kv\_crdt.erl\"},{line,86}]},{mr\_kv\_counters,value,3,[{file,\"mr\_kv\_counters.erl\"},{line,38}]},{riak\_kv\_mrc\_map,map,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,165}]},{riak\_kv\_mrc\_map,process,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,141}]},{riak\_pipe\_vnode\_worker,process\_input,3,[{file,\"src/riak\_pipe\_vnode\_worker.erl\"},{line,445}]},{riak\_pipe\_vnode\_worker,...}]”}

That binary (<<69,1,71…>>) says CRDT(69), Version 1(1), riak\_kv\_pncounter (71). 
The error says that erlang is trying to apply the Module, Function, Arguments 
of <<“riak\_kv\_pncounter”>>, new, []. But modules need to be atoms.

> Just to help, this is my erlang MR code:
> value(RiakObject, \_KeyData, \_Arg) ->
> Key = riak\_object:key(RiakObject),
> Count = riak\_kv\_crdt:value(RiakObject, <<"riak\_kv\_pncounter">>),

Type needs to be an atom, as it is the module name (so riak\_kv\_pncounter). 
Also, the return value is now a tuple of

 {{Context :: binary(), Value :: term()}, Stats :: proplist()}. You probably 
only want the Value bit. So:

 {{\_Ctx, Count}, \_Stats} = riak\_kv\_crdt:value(RiakObject, riak\_kv\_pncounter),

Should be what you need, let me know if that works, please?

Cheers

Russell

> [ {Key, Count} ].
> 
> What am I doing wrong? I can't seem to figure it out... I'm sure its 
> something simple thing I'm just not seeing.
> 
> Thanks again,
> Bryce
> 
> On 01/23/2014 01:07 PM, Russell Brown wrote:
>> On 23 Jan 2014, at 20:51, Eric Redmond  wrote:
>> 
>>> For version 1.4 counters, riak\_kv\_pncounter. For 2.0 CRDT counters, 
>>> riak\_dt\_pncounter.
>> As in, if the data was written in 1.4, or in 2.0 using the legacy, backwards 
>> compatible 1.4 API endpoints, the the type is risk\_kv\_pncounter. If the 
>> counter is 2.0, bucket types counter, then risk\_dt\_pncounter.
>> 
>> Really, we need to re-introduce the riak\_kv\_counter module for backwards 
>> compatibility, and add some friendly `value’ functions to risk\_kv\_crdt. I’m 
>> opening an issue for just this now.
>> 
>> The other option is to include the riak\_kv\_types.hrl and use the macros 
>> ?MAP\_TYPE, ?SET\_TYPE, ?V1\_COUNTER\_TYPE, ?COUNTER\_TYPE for now, and assume 
>> that we’ll have some helper functions for MapReduce in before 2.0.
>> 
>> Cheers
>> 
>> Russell
>> 
>>> Eric
>>> 
>>> On Jan 23, 2014, at 3:44 PM, Bryce Verdier  wrote:
>>> 
>>>> In 1.4 there was just the simple function riak\_kv\_counters:value. In 2.0 I 
>>>> found the riak\_kv\_crdt module, which has a value function in it. But I'm 
>>>> not sure what "type" to use for second value argument for a counter.
>>>> 
>>>> Can someone share that with me?
>>>> 
>>>> Thanks in advance,
>>>> Bryce
>>>> 
>>>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>>>> riak-users mailing list
>>>> riak-users@lists.basho.com
>>>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>>> 
>>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>>> riak-users mailing list
>>> riak-users@lists.basho.com
>>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
> 
> 
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

