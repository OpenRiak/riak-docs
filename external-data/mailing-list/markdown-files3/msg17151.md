---
title: "Re: Yokozuna inconsistent search results"
description: ""
project: community
lastmod: 2016-03-11T07:10:19-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17151"
mailinglist_parent_id: "msg17139"
author_name: "Fred Dushin"
project_section: "mailinglistitem"
sent_date: 2016-03-11T07:10:19-08:00
---


Hi Oleksiy,

This is definitely pointing to an issue either in the coverage plan (which 
determines the distributed query you are seeing) or in the data you have in 
Solr. I am wondering if it is possible that you have some data in Solr that is 
causing the rebuild of the YZ AAE tree to incorrectly represent what is 
actually stored in Solr.

What you did was to manually expire the YZ (Riak Search) AAE trees, which 
caused them to rebuild from the entropy data stored in Solr. Another thing we 
could try (if you are willing) would be to delete the 'chunks\_index' data in 
Solr (as well as the Yokozuna AAE data), and then let AAE repair the missing 
data. What Riak will essentially do is compare the KV hash trees with the YZ 
hash trees (which will be empty), too that it is missing in Solr, and add it to 
Solr, as a result. This would effectively result in re-indexing all of your 
data, but we are only talking about ~30k entries (times 3, presumably, if your 
n\_val is 3), so that shouldn't take too much time, I wouldn't think. There is 
even some configuration you can use to accelerate this process, if necessary.

Is that something you would be willing to try? It would result in down time on 
query. Is this production data or a test environment?

-Fred

> On Mar 11, 2016, at 7:38 AM, Oleksiy Krivoshey  wrote:
> 
> Here are two consequent requests, one returns 30118 keys, another 37134
> 
> xml version="1.0" encoding="UTF-8"?
> 
> 
> 0
> 6
> 
> \_yz\_pn:92 OR 
> \_yz\_pn:83 OR \_yz\_pn:71 OR \_yz\_pn:59 OR \_yz\_pn:50 OR \_yz\_pn:38 OR \_yz\_pn:17 OR 
> \_yz\_pn:5
> \_yz\_pn:122 OR 
> \_yz\_pn:110 OR \_yz\_pn:98 OR \_yz\_pn:86 OR \_yz\_pn:74 OR \_yz\_pn:62 OR \_yz\_pn:26 
> OR \_yz\_pn:14 OR \_yz\_pn:2
>  name="shards">10.0.1.1:8093/internal\_solr/chunks\_index,10.0.1.2:8093/internal\_solr/chunks\_index,10.0.1.3:8093/internal\_solr/chunks\_index,10.0.1.4:8093/internal\_solr/chunks\_index,10.0.1.5:8093/internal\_solr/chunks\_index
> 
> 
> \_yz\_rb:0dmid2ilpyrfiuaqtvnc482f1esdchb5.chunks
> (\_yz\_pn:124 AND 
> (\_yz\_fpn:124 OR \_yz\_fpn:123)) OR \_yz\_pn:116 OR \_yz\_pn:104 OR \_yz\_pn:80 OR 
> \_yz\_pn:68 OR \_yz\_pn:56 OR \_yz\_pn:44 OR \_yz\_pn:32 OR \_yz\_pn:20 OR 
> \_yz\_pn:8
> \_yz\_pn:113 OR 
> \_yz\_pn:101 OR \_yz\_pn:89 OR \_yz\_pn:77 OR \_yz\_pn:65 OR \_yz\_pn:53 OR \_yz\_pn:41 
> OR \_yz\_pn:29
> \_yz\_pn:127 OR 
> \_yz\_pn:119 OR \_yz\_pn:107 OR \_yz\_pn:95 OR \_yz\_pn:47 OR \_yz\_pn:35 OR \_yz\_pn:23 
> OR \_yz\_pn:11
> 0
> 
> 
>  start="0">
> 
> 
> ------
> 
> 
> xml version="1.0" encoding="UTF-8"?
> 
> 
> 0
> 10
> 
> \_yz\_pn:100 OR 
> \_yz\_pn:88 OR \_yz\_pn:79 OR \_yz\_pn:67 OR \_yz\_pn:46 OR \_yz\_pn:34 OR \_yz\_pn:25 OR 
> \_yz\_pn:13 OR \_yz\_pn:1
> (\_yz\_pn:126 AND 
> (\_yz\_fpn:126 OR \_yz\_fpn:125)) OR \_yz\_pn:118 OR \_yz\_pn:106 OR \_yz\_pn:94 OR 
> \_yz\_pn:82 OR \_yz\_pn:70 OR \_yz\_pn:58 OR \_yz\_pn:22 OR \_yz\_pn:10
>  name="shards">10.0.1.1:8093/internal\_solr/chunks\_index,10.0.1.2:8093/internal\_solr/chunks\_index,10.0.1.3:8093/internal\_solr/chunks\_index,10.0.1.4:8093/internal\_solr/chunks\_index,10.0.1.5:8093/internal\_solr/chunks\_index
> 
> 
> \_yz\_rb:0dmid2ilpyrfiuaqtvnc482f1esdchb5.chunks
> \_yz\_pn:124 OR 
> \_yz\_pn:112 OR \_yz\_pn:76 OR \_yz\_pn:64 OR \_yz\_pn:52 OR \_yz\_pn:40 OR \_yz\_pn:28 
> OR \_yz\_pn:16 OR \_yz\_pn:4
> \_yz\_pn:121 OR 
> \_yz\_pn:109 OR \_yz\_pn:97 OR \_yz\_pn:85 OR \_yz\_pn:73 OR \_yz\_pn:61 OR \_yz\_pn:49 
> OR \_yz\_pn:37
> \_yz\_pn:115 OR 
> \_yz\_pn:103 OR \_yz\_pn:91 OR \_yz\_pn:55 OR \_yz\_pn:43 OR \_yz\_pn:31 OR \_yz\_pn:19 
> OR \_yz\_pn:7
> 0
> 
> 
>  start="0">
> 
> 
> On 11 March 2016 at 12:05, Oleksiy Krivoshey  > wrote:
> So event when I fixed 3 documents which caused AAE errors,
> restarted AAE with riak\_core\_util:rpc\_every\_member\_ann(yz\_entropy\_mgr, 
> expire\_trees, [], 5000). 
> waited 5 days (now I see all AAE trees rebuilt in last 5 days and no AAE or 
> Solr errors), I still get inconsistent num\_found.
> 
> For a bucket with 30,000 keys each new search request can result in 
> difference in num\_found for over 5,000. 
> 
> What else can I do to get consistent index, or at least not a 15% difference. 
> 
> I even tried to walk through all the bucket keys and modifying them in a hope 
> that all Yokozuna instances in a cluster will pick them up, but no luck.
> 
> Thanks!
> â€‹
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

