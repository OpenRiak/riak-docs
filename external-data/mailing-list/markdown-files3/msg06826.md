---
title: "Re: basho_metrics re-entrant?"
description: ""
project: community
lastmod: 2012-03-01T11:52:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06826"
mailinglist_parent_id: "msg06790"
author_name: "Joel Meyer"
project_section: "mailinglistitem"
sent_date: 2012-03-01T11:52:23-08:00
---


On Wed, Feb 29, 2012 at 2:58 PM, Bob Ippolito  wrote:

> I don't believe that you'll be able to store these NIF instances in
> mochiglobal. You can only store things that can be represented as BEAM code.
>

Ah, you're right. I tested putting and getting, but I didn't test calling
the nif with the result of getting, which fails with a bad argument
exception.

Eshell V5.8.4 (abort with ^G)
1> {ok, Stat} = basho\_metrics\_nifs:histogram\_new().
{ok,<<>>}
2> mochiglobal:put(stat,Stat).
ok
3> MGStat = mochiglobal:get(stat).
<<>>
4> basho\_metrics\_nifs:histogram\_stats(MGStat).
\*\* exception error: bad argument
 in function basho\_metrics\_nifs:histogram\_stats/1
 called as basho\_metrics\_nifs:histogram\_stats(<<>>)
5>

It looks like storing the refs in an ets table works, so I'll try that.

Thanks,
Joel


>
> On Wed, Feb 29, 2012 at 2:46 PM, Joel Meyer  wrote:
>
>> Hello,
>>
>> I'd like to capture statistics on all calls to my riak\_core service and
>> the execution time of vnode commands. I looked at folsom\_metrics, but for a
>> service that does 10-30k QPS I'm concerned about the overhead introduced of
>> doing ets calls. Given that, my current plan was to create several
>> basho\_metrics on startup and store the opaque refs using mochiglobal. Then
>> my service will make module calls to update the metrics. Will using
>> basho\_metrics in that matter cause problems?
>>
>> Here's what I'm thinking:
>>
>> -module(freqserver\_stats).
>>
>> -export([ init/0,
>> vnode\_count/1,
>> ... ]).
>>
>> -define( VNODE\_COUNT, freqserver\_stats\_vnode\_count ).
>>
>>
>> ...
>>
>> -define( METRICS,
>> [ { ?VNODE\_COUNT, histogram },
>> ... ] ).
>>
>> -define( STAT(Name), mochiglobal:get(Name) ).
>>
>> init() ->
>>
>>
>> F = fun( { S, Type } , \_ ) ->
>> Ref = case Type of
>> histogram -> basho\_metrics\_nifs:histogram\_new();
>> meter -> basho\_metrics\_nifs:meter\_new()
>> end,
>> ok = mochiglobal:put( S, Ref )
>> end,
>> lists:foldl( F, [], ?METRICS ).
>>
>> vnode\_count( Micros ) ->
>> basho\_metrics\_nifs:histogram\_update( ?STAT( ?VNODE\_COUNT ), Micros ).
>>
>> I'm also open to better ideas, if people have them. I'm concerned about
>> back pressure and/or overflowing the message queue if I dedicate a process
>> to handling these statistics. Let me know if I'm needlessly concerned about
>> that.
>>
>> Thanks,
>> Joel
>>
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>>
>>
>
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

