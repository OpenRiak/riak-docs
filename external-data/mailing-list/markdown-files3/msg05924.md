---
title: "Bitcask won't merge without explicit merge() call"
description: ""
project: community
lastmod: 2011-12-12T14:04:44-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05924"
author_name: "Dmitry Groshev"
project_section: "mailinglistitem"
sent_date: 2011-12-12T14:04:44-08:00
---


I'm using standalone Bitcask (no Riak at all). It is used as a storage
backend for an in-memory database, so the load is as follows: every 5
minutes I write ~1.2GB of data (~20k keys ~60kb data each) to the same
keys as before, overwriting their contents. Then I call
bitcask:sync(BitcaskRef). The problem is that if I don't call
bitcask:merge(Path) explicitly, Bitcask won't shrink it's size (and it
shrinks if I call it). Here is an example of what I'm talking about:

after ~15 minutes from the start:

total 4.4G
drwxr-xr-x 2 root root 260K Dec 12 22:51 .
drwxr-xr-x 22 root root 4.0K Dec 5 05:16 ..
-rw------- 1 root root 2.0G Dec 12 22:41 1323714971.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 22:41 1323714971.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 22:51 1323715283.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 22:51 1323715283.bitcask.hint
-rw------- 1 root root 366M Dec 12 22:51 1323715882.bitcask.data
-rw-r--r-- 1 root root 286K Dec 12 22:51 1323715882.bitcask.hint
-rw------- 1 root root 45 Dec 12 22:51 bitcask.write.lock

after an hour:

total 19G
drwxr-xr-x 2 root root 260K Dec 12 23:56 .
drwxr-xr-x 22 root root 4.0K Dec 5 05:16 ..
-rw------- 1 root root 2.0G Dec 12 22:41 1323714971.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 22:41 1323714971.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 22:51 1323715283.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 22:51 1323715283.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:01 1323715882.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:01 1323715882.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:11 1323716480.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:11 1323716480.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:21 1323717078.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:21 1323717078.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:31 1323717676.bitcask.data
-rw-r--r-- 1 root root 2.3M Dec 12 23:31 1323717676.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:36 1323718271.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:36 1323718271.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:46 1323718583.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:46 1323718583.bitcask.hint
-rw------- 1 root root 2.0G Dec 12 23:56 1323719182.bitcask.data
-rw-r--r-- 1 root root 2.7M Dec 12 23:56 1323719182.bitcask.hint
-rw------- 1 root root 541M Dec 12 23:56 1323719779.bitcask.data
-rw-r--r-- 1 root root 422K Dec 12 23:56 1323719779.bitcask.hint
-rw------- 1 root root 45 Dec 12 23:56 bitcask.write.lock

I didn't change any Bitcask settings:

application:get\_all\_env(bitcask).
[{frag\_merge\_trigger,60},
 {dead\_bytes\_merge\_trigger,536870912},
 {frag\_threshold,40},
 {included\_applications,[]},
 {open\_timeout,4},
 {dead\_bytes\_threshold,134217728},
 {max\_file\_size,2147483648},
 {max\_fold\_puts,0},
 {max\_fold\_age,-1},
 {small\_file\_threshold,10485760},
 {sync\_strategy,none},
 {expiry\_secs,-1},
 {merge\_window,always}]

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

