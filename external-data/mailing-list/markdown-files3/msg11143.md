---
title: "Riak CS 1.3 S3 access does not seem to mark s3 deleted file as truly	deleted"
description: ""
project: community
lastmod: 2013-05-21T13:19:30-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11143"
author_name: "Idan Shinberg"
project_section: "mailinglistitem"
sent_date: 2013-05-21T13:19:30-07:00
---


Thus , I fear Riak never treats their data as "dead-bytes" and they never
get merged

I created 2 buckets using s3cmd and made several tens of uploads of 32mb
sized files , deleting them right afterwards ( with proper s3cmd commands ,
of course) .

I ended up with no buckets and no keys in my riak s3 database ,
however , directory /var/lib/riak/bitcask/ 64 partitions now occupy 15GB
worth of space

several riak restarts did not trigger any merges , and my merge settings
are set to impose very though merge triggering criterias , So I'm guessing
the only reason the data is not being cleared is the fact that it's still
in use ...

Relevant riak-cs config :

\* %% == Garbage Collection ==\*
\*
\*
\* %% The number of seconds to retain the block\*
\* %% for an object after it has been deleted.\*
\* %% This leeway time is set to give the delete\*
\* %% indication time to propogate to all replicas.\*
\* %% 86400 is 24-hours.\*
\* {leeway\_seconds, 30},\*
\*
\*
\* %% How often the garbage collection daemon\*
\* %% waits in-between gc batches.\*
\* %% 900 is 15-minutes.\*
\* {gc\_interval, 60},\*
\*
\*
\* %% How long a move to the garbage\*
\* %% collection to do list can remain\*
\* %% failed, before we retry it.\*
\* %% 21600 is 6-hours.\*
\* {gc\_retry\_interval,300},\*



Relevant Riak Config

\*{riak\_kv, [\*
\* %% Storage\_backend specifies the Erlang module defining the
storage\*
\* %% mechanism that will be used on this node.\*
\* {add\_paths, ["/usr/lib64/riak-cs/lib/riak\_cs-1.3.1/ebin"]},
\*
\* {storage\_backend, riak\_cs\_kv\_multi\_backend},\*
\* {multi\_backend\_prefix\_list, [{<<"0b:">>, be\_blocks}]},\*
\* {multi\_backend\_default, be\_default},\*
\* {multi\_backend, [\*
\* {be\_default, riak\_kv\_eleveldb\_backend, [\*
\* {max\_open\_files, 50},\*
\* {data\_root, "/var/lib/riak/leveldb"}\*
\* ]},\*
\* {be\_blocks, riak\_kv\_bitcask\_backend, [\*
\*
\*
\* {max\_file\_size, 16#4000000}, %% 64MB\*
\*
\*
\* %% Trigger a merge if any of the following are
true:\*
\* {frag\_merge\_trigger, 10}, %% fragmentation >= 10%\*
\* {dead\_bytes\_merge\_trigger, 33554432}, %% dead
bytes > 32 MB\*
\*
\*
\* %% Conditions that determine if a file will be
examined during a merge:\*
\* {frag\_threshold, 5}, %% fragmentation >= 5%\*
\* {dead\_bytes\_threshold, 8388608}, %% dead bytes > 8
MB\*
\* {small\_file\_threshold, 16#80000000}, %% file is <
2GB\*
\*
\*
\* {data\_root, "/var/lib/riak/bitcask"}\*
\* ]}\*
\* ]},\*

...
...
...

\* {bitcask, [\*
\* %% Configure how Bitcask writes data to disk.\*
\* %% erlang: Erlang's built-in file API\*
\* %% nif: Direct calls to the POSIX C API\*
\* %%\*
\* %% The NIF mode provides higher throughput for certain\*
\* %% workloads, but has the potential to negatively impact\*
\* %% the Erlang VM, leading to higher worst-case latencies\*
\* %% and possible throughput collapse.\*
\* {io\_mode, erlang},\*
\*
\*
\* {max\_file\_size, 16#4000000}, %% 64MB\*
\* {merge\_window, always}, %% Span of hours during which merge
is acceptable.\*
\*
\*
\* %% Trigger a merge if any of the following are true:\*
\* {frag\_merge\_trigger, 10}, %% fragmentation >= 10%\*
\* {dead\_bytes\_merge\_trigger, 33554432}, %% dead bytes > 32 MB\*
\*
\*
\* %% Conditions that determine if a file will be examined
during a merge:\*
\* {frag\_threshold, 5}, %% fragmentation >= 5%\*
\* {dead\_bytes\_threshold, 8388608}, %% dead bytes > 8 MB\*
\* {small\_file\_threshold, 16#80000000}, %% file is < 2GB\*
\*
\*
\* {data\_root, "/var/lib/riak/bitcask"}\*
\*
\*
\* ]},\*

I do see merges taking place in riak's console.log , they're just not
making that much of a difference ...

Any idea what I might be missing here ?

Thanks

Idan Shinberg
idomoo
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

