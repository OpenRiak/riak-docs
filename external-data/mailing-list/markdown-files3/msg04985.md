---
title: "Re: Timeout when storing"
description: ""
project: community
lastmod: 2011-10-03T04:45:49-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04985"
mailinglist_parent_id: "msg04971"
author_name: "David Smith"
project_section: "mailinglistitem"
sent_date: 2011-10-03T04:45:49-07:00
---


Jim,

If you look at your bitcask directories, do you have a large number of
zero-byte files, perchance?

D.

On Sat, Oct 1, 2011 at 1:58 PM, Jim Adler  wrote:
> After upgrading my single-node instance to 1.0, I'm still seeing the
> "timeout when storing" issue.  Here are the changes I made based on
> everyone's suggestions (much appreciated!):
>
> - Ubuntu 11.04 (natty) 32-bit
> - Python client 1.3.0
> - /etc/riak/vm.args: -env ERL\_MAX\_PORTS 32768
> - /etc/default/riak: ulimit -n 32768
>
> Here's the /var/log/crash.log report:
>
> 2011-10-01 12:31:03 =ERROR REPORT====
> \*\* State machine <0.3452.0> terminating
> \*\* Last event in was
> {'riak\_vnode\_req\_v1',1136089163393944065322395631681798128560666312704,{fsm,undefined,<0.3451.0>},{'riak\_kv\_put\_req\_v1',{<<"nodes">>,<<"user\_id-17527747-info">>},{r\_object,<<"nodes">>,<<"user\_id-17527747-info">>,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[<<"content-type">>,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[<<"X-Riak-VTag">>,49,88,88,75,75,51,90,88,68,117,90,122,85,53,57,85,53,101,107,89,115,110]],[[<<"index">>]],[],[[<<"X-Riak-Last-Modified">>|{1317,497463,847242}]],[],[]}}},<<"{DATA
> DELETED}">>}],[],{dict,1,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[[clean|true]],[]}}},undefined},51456853,63484716663,[coord]}}
>
> \*\* When State == active
> \*\*      Data  ==
> {state,1136089163393944065322395631681798128560666312704,riak\_kv\_vnode,{state,1136089163393944065322395631681798128560666312704,false,riak\_kv\_bitcask\_backend,{state,#Ref<0.0.0.10359>,"1136089163393944065322395631681798128560666312704",[{async\_folds,true},[{vnode\_vclocks,true},{included\_applications,[]},{add\_paths,[]},{allow\_strfun,false},{storage\_backend,riak\_kv\_bitcask\_backend},{legacy\_keylisting,false},{reduce\_js\_vm\_count,6},{js\_thread\_stack,16},{pb\_ip,"0.0.0.0"},{riak\_kv\_stat,true},{map\_js\_vm\_count,8},{mapred\_system,pipe},{js\_max\_vm\_mem,8},{pb\_port,8087},{legacy\_stats,true},{mapred\_name,"mapred"},{stats\_urlpath,"stats"},{http\_url\_encoding,on},{hook\_js\_vm\_count,2}],{read\_write,true}],1136089163393944065322395631681798128560666312704,"/var/lib/riak/bitcask"},{dict,0,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},<<35,9,254,249,78,135,82,106>>,3000,1000,100,100,true,false},undefined,undefined,none,undefined,<0.3454.0>,60000}
> \*\* Reason for termination =
> \*\* {bad\_return\_value,{error,{write\_locked,emfile}}}
> 2011-10-01 12:31:03 =CRASH REPORT====
>   crasher:
>     initial call: riak\_core\_vnode:init/1
>     pid: <0.3452.0>
>     registered\_name: []
>     exception exit: {bad\_return\_value,{error,{write\_locked,emfile}}}
>       in function  gen\_fsm:terminate/7
>       in call from proc\_lib:init\_p\_do\_apply/3
>     ancestors: [riak\_core\_vnode\_sup,riak\_core\_sup,<0.92.0>]
>     messages: [{'EXIT',<0.3454.0>,shutdown}]
>     links: [<0.96.0>]
>     dictionary: []
>     trap\_exit: true
>     status: running
>     heap\_size: 6765
>     stack\_size: 24
>     reductions: 160650
>   neighbours:
> 2011-10-01 12:31:03 =SUPERVISOR REPORT====
>      Supervisor: {local,riak\_core\_vnode\_sup}
>      Context:    child\_terminated
>      Reason:     {bad\_return\_value,{error,{write\_locked,emfile}}}
>      Offender:
> [{pid,<0.3452.0>},{name,undefined},{mfargs,{riak\_core\_vnode,start\_link,undefined}},{restart\_type,temporary},{shutdown,300000},{child\_type,worker}]
>
> 2011-10-01 12:45:28 =ERROR REPORT====
> Failed to merge
> "/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1315770213.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316329673.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316330222.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316879145.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316995340.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1317493005.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1317495168.bitcask.data":
> {{badmatch,{error,emfile}},[{bitcask,'-merge1/3-lc$^0/1-1-',1},{bitcask,'-merge1/3-lc$^0/1-1-',1},{bitcask,'merge1',3},{bitcask\_merge\_worker,do\_merge,1}]}
>
>
> -----Original Message-----
> From: David Smith [mailto:diz...@basho.com]
> Sent: Fri 9/30/2011 9:56 AM
> To: Jim Adler
> Cc: Sean Cribbs; riak-users@lists.basho.com
> Subject: Re: Timeout when storing
>
> IIRC, {error, emfile} indicates that the max # of ports (in the erlang
> VM) is being exceeded. Try bumping up ERL\_MAX\_PORTS in vm.args.
>
> D.
>
> On Thu, Sep 29, 2011 at 10:52 PM, Jim Adler  wrote:
>> Thanks Sean.  I added the ulimit -n 10240 to /etc/default/riak, restarted
>> riak, but that didn't work.
>>
>> Fyodor Yarochkin suggested that the bitcask files could be corrupted, but
>> I
>> wasn't sure which bitcask \*.data or \*.hint file to delete.  Any pointers?
>>
>> Here's the /var/log/riak/erlang.log:
>>
>> =ERROR REPORT==== 29-Sep-2011::20:27:42 ===
>> \*\* State machine <0.369.0> terminating
>> \*\* Last event in was {riak\_vnode\_req\_v1,
>>                       941983477185933521498468739836666790012612771840,
>>                       {fsm,undefined,<0.27704.1>},
>>                       {riak\_kv\_put\_req\_v1,
>>                        {<<"nodes">>,<<"screen\_name-psych\_ic-info">>},
>>
>> {r\_object,<<"nodes">>,<<"screen\_name-psych\_ic-info">>,
>>                         [{r\_content,
>>                           {dict,3,16,16,8,80,48,
>>
>> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
>>                            {{[],[],[],[],[],[],[],[],[],[],
>>
>> [[<<"content-type">>,97,112,112,108,105,99,97,
>>                                116,105,111,110,47,106,115,111,110],
>>
>> [<<"X-Riak-VTag">>,49,90,120,65,84,100,56,99,48,
>>
>> 80,86,99,111,122,71,79,108,90,70,97,53,87]],
>>                              [],[],
>>                              [[<<"X-Riak-Last-Modified">>|
>>                                {1317,353201,695471}]],
>>                              [],[]}}},
>>                           <<"{DELETED DATA}">>}],
>>                         [{<<2,65,205,48>>,{1,63484572401}}],
>>                         {dict,1,16,16,8,80,48,
>>
>> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
>>                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
>>                            [[clean|true]],
>>                            []}}},
>>                         undefined},
>>                        1174401,63484572401,
>>                        [{returnbody,true}]}}
>> \*\* When State == active
>> \*\*      Data  == {state,941983477185933521498468739836666790012612771840,
>>                         riak\_kv\_vnode,
>>
>> {state,941983477185933521498468739836666790012612771840,
>>                                riak\_kv\_bitcask\_backend,
>>                                {#Ref<0.0.0.3952>,
>>
>> "/var/lib/riak/bitcask/941983477185933521498468739836666790012612771840"},
>>                                {dict,0,16,16,8,80,48,
>>
>> {[],[],[],[],[],[],[],[],[],[],[],[],[],
>>                                       [],[],[]},
>>
>> {{[],[],[],[],[],[],[],[],[],[],[],[],[],
>>                                        [],[],[]}}},
>>                                false},
>>                         undefined,none,60000}
>> \*\* Reason for termination =
>> \*\* {{badmatch,{error,emfile}},
>>     [{bitcask\_fileops,create\_file\_loop,3},
>>      {bitcask,put,3},
>>      {riak\_kv\_bitcask\_backend,put,3},
>>      {riak\_kv\_vnode,perform\_put,3},
>>      {riak\_kv\_vnode,do\_put,7},
>>      {riak\_kv\_vnode,handle\_command,3},
>>      {riak\_core\_vnode,vnode\_command,3},
>>      {gen\_fsm,handle\_msg,7}]}
>>
>>
>>
>> -----Original Message-----
>> From: Sean Cribbs [mailto:s...@basho.com]
>> Sent: Thu 9/29/2011 3:02 PM
>> To: Jim Adler
>> Cc: riak-users@lists.basho.com
>> Subject: Re: Timeout when storing
>>
>> Your environment has too few file handles.  Retry starting riak after
>> setting `ulimit -n 1024` in the shell.  Also see our wiki page about this
>> issue: http://wiki.basho.com/Open-Files-Limit.html  You may need to set
>> this
>> limit specifically for the 'riak' user.
>>
>> Cheers,
>>
>> --
>> Sean Cribbs 
>> Developer Advocate
>> Basho Technologies, Inc.
>> http://www.basho.com/
>>
>>
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>>
>>
>
>
>
> --
> Dave Smith
> Director, Engineering
> Basho Technologies, Inc.
> diz...@basho.com
>
>



-- 
Dave Smith
Director, Engineering
Basho Technologies, Inc.
diz...@basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

