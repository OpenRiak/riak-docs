---
title: "Question regarding recent riak_core_vnode_master changes"
description: ""
project: community
lastmod: 2011-12-19T10:14:48-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05996"
author_name: "Jeff Thompson"
project_section: "mailinglistitem"
sent_date: 2011-12-19T10:14:48-08:00
---


As a project to better learn riak\_core and to think more about distributed
problems, I've been writing a little mud app using riak\_core.

I just updated to the latest riak\_core version and am running into a
problem when riak\_core\_vnode\_master gets a handle\_cast.

In the previous version handle\_cast would:

handle\_cast(Req=?VNODE\_REQ{index=Idx}, State) ->
 Pid = get\_vnode(Idx, State),
 gen\_fsm:send\_event(Pid, Req),
 {noreply, State};

get\_vnode:

get\_vnode(Idx, State=#state{vnode\_mod=Mod}) ->
 case idx2vnode(Idx, State) of
 no\_match ->
 {ok, Pid} = riak\_core\_vnode\_sup:start\_vnode(Mod, Idx),
 MonRef = erlang:monitor(process, Pid),
 add\_vnode\_rec(#idxrec{idx=Idx,pid=Pid,monref=MonRef}, State),
 Pid;
 X -> X
 end.



I would see the get\_vnode code successfully start my vnode and the
subsequent gen\_fsm:send\_event/2 call would succeed.

However, the new version of get\_vnode looks like:

handle\_cast(Req=?VNODE\_REQ{index=Idx}, State=#state{vnode\_mod=Mod}) ->
 Proxy = riak\_core\_vnode\_proxy:reg\_name(Mod, Idx),
 gen\_fsm:send\_event(Proxy, Req),
 {noreply, State};


and riak\_core\_vnode\_proxy:reg\_name/2 just returns an atom:

reg\_name(Mod, Index) ->
 ModBin = atom\_to\_binary(Mod, latin1),
 IdxBin = list\_to\_binary(integer\_to\_list(Index)),
 AllBin = <<$p,$r,$o,$x,$y,$\_, ModBin/binary, $\_, IdxBin/binary>>,
 binary\_to\_atom(AllBin, latin1).



This is resulting in a:

{badarg,[{gen\_fsm,send\_event,2},
 {riak\_core\_vnode\_master,handle\_cast,2},
 {gen\_server,handle\_msg,5},
 {proc\_lib,init\_p\_do\_apply,3}]}

Based on the above, there doesn't seem to be an 'on demand' starting of
vnodes anymore?

I'm happy to dig into this more (which I will anyway to learn whats going
on), but if there are any quick pointers that can be given as to how the
recent changes impact the writing of riak\_core vnodes and what I'm seeing
above, I would certainly appreciate it.

Thanks!

Jeff

\*
\*
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

