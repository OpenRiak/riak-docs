---
title: "Re: Write_lock error has occurred after inserting 12M data"
description: ""
project: community
lastmod: 2010-07-30T16:03:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00814"
mailinglist_parent_id: "msg00812"
author_name: "David Smith"
project_section: "mailinglistitem"
sent_date: 2010-07-30T16:03:55-07:00
---


Yup, that looks like the file handle leak. You can verify by using
lsof on the server and looking for multiple handles to
bitcask.write.lock. Something like:

lsof -p pid | awk '{print $9}'| uniq -c

D.

On Friday, July 30, 2010, Alex Wolfe  wrote:
> Hey David.
> Does the below log output look like it could be caused by the issue you fixed?
> Alex
>
> ==== Fri Jul 30 14:22:34 CDT 2010
> =ERROR REPORT==== 30-Jul-2010::14:22:34 ===\*\* State machine <0.176.0> 
> terminating \*\* Last event in was {riak\_vnode\_req\_v1,                     
> 593735040165679310520246963290989976735222595584,                     
> {fsm,undefined,<0.12466.0>},                     {riak\_kv\_put\_req\_v1,         
>              {<<"test.groups">>,<<"EghzXywWrGGtp2fCcSLoatIdjML">>},           
>            {r\_object,<<"test.groups">>,                       
> <<"EghzXywWrGGtp2fCcSLoatIdjML">>,                       [{r\_content,         
>                 {dict,5,16,16,8,80,48,                          
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
> {{[],[],                            [[<<"Links">>]],                          
>  [],[],[],[],[],[],[],                            
> [[<<"content-type">>,97,112,112,108,105,99,97,                              
> 116,105,111,110,47,106,115,111,110],                             
> [<<"X-Riak-VTag">>,89,69,78,55,55,111,66,121,73,                              
> 69,78,53,122,101,85,105,117,68,89,80,52]],                            
> [],[],                            [[<<"X-Riak-Last-Modified">>|               
>                {1280,517754,951062}]],                            [],         
>                    [[<<"X-Riak-Meta">>]]}}},                         
> <<"{\"name\":\"foo\",\"created\_at\":\"2010-07-30T19:22:34.947Z\",\"type\":\"group\",\"version\":1}">>}],  
>                     [{<<0,55,119,231>>,{1,63447736954}}],                    
>   {dict,1,16,16,8,80,48,                        
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
> [[clean|true]],                          []}}},                       
> undefined},                      33218311,63447736954,                      
> [{returnbody,true}]}}\*\* When State == active\*\*      Data  == 
> {state,593735040165679310520246963290989976735222595584,                      
> riak\_kv\_vnode,                       
> {state,593735040165679310520246963290989976735222595584,                      
>          riak\_kv\_bitcask\_backend,                              
> {#Ref<0.0.0.611>,                               
> "data/bitcask/593735040165679310520246963290989976735222595584"},             
>                  [],false},                       undefined,none}\*\* Reason 
> for termination = \*\* {{badmatch,{error,emfile}},   
> [{bitcask\_fileops,create\_file\_loop,3},    {bitcask,put,3},    
> {riak\_kv\_bitcask\_backend,put,3},    {riak\_kv\_vnode,perform\_put,3},    
> {riak\_kv\_vnode,do\_put,7},    {riak\_kv\_vnode,handle\_command,3},    
> {riak\_core\_vnode,vnode\_command,3},    {gen\_fsm,handle\_msg,7}]}
> =ERROR REPORT==== 30-Jul-2010::14:22:35 ===Failed to open lock file 
> data/bitcask/593735040165679310520246963290989976735222595584/bitcask.write.lock:
> emfile
> =ERROR REPORT==== 30-Jul-2010::14:22:35 ===\*\* State machine <0.12471.0> 
> terminating \*\* Last event in was {riak\_vnode\_req\_v1,                     
> 593735040165679310520246963290989976735222595584,                     
> {fsm,undefined,<0.12470.0>},                     {riak\_kv\_put\_req\_v1,         
>              {<<"test.users">>,<<"ZrAxzFghd51VG902GuCcJ2gYOMJ">>},            
>          {r\_object,<<"test.users">>,                       
> <<"ZrAxzFghd51VG902GuCcJ2gYOMJ">>,                       [{r\_content,         
>                 {dict,5,16,16,8,80,48,                          
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
> {{[],[],                            [[<<"Links">>,                            
>  {{<<"test.groups">>,                                
> <<"EghzXywWrGGtp2fCcSLoatIdjML">>},                               
> <<"groups">>}]],                            [],[],[],[],[],[],[],             
>                [[<<"content-type">>,97,112,112,108,105,99,97,                 
>              116,105,111,110,47,106,115,111,110],                             
> [<<"X-Riak-VTag">>,50,88,97,105,85,49,70,49,55,                              
> 54,48,71,113,115,75,103,54,102,84,56,118,84]],                            
> [],[],                            
> [[<<"X-Riak-Last-Modified">>|{1280,517755,638}]],                            
> [],                            [[<<"X-Riak-Meta">>]]}}},                      
>   
> <<"{\"name\":\"bar\",\"created\_at\":\"2010-07-30T19:22:34.998Z\",\"type\":\"user\",\"version\":1}">>}],  
>                     [{<<3,30,180,15>>,{1,63447736955}}],                     
>   {dict,1,16,16,8,80,48,                        
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
> [[clean|true]],                          []}}},                       
> undefined},                      122945524,63447736955,                      
> [{returnbody,true}]}}\*\* When State == active\*\*      Data  == 
> {state,593735040165679310520246963290989976735222595584,                      
> riak\_kv\_vnode,                       
> {state,593735040165679310520246963290989976735222595584,                      
>          riak\_kv\_bitcask\_backend,                              
> {#Ref<0.0.0.16357>,                               
> "data/bitcask/593735040165679310520246963290989976735222595584"},             
>                  [],false},                       undefined,none}\*\* Reason 
> for termination = \*\* {bad\_return\_value,{error,{write\_locked,emfile}}}
> ==> sasl-error.log <==
> =CRASH REPORT==== 30-Jul-2010::14:22:35 === crasher:   initial call: 
> riak\_core\_vnode:init/1   pid: <0.176.0>   registered\_name: []   exception 
> exit: {{badmatch,{error,emfile}},                    
> [{bitcask\_fileops,create\_file\_loop,3},                     {bitcask,put,3},   
>                   {riak\_kv\_bitcask\_backend,put,3},                     
> {riak\_kv\_vnode,perform\_put,3},                     
> {riak\_kv\_vnode,do\_put,7},                     
> {riak\_kv\_vnode,handle\_command,3},                     
> {riak\_core\_vnode,vnode\_command,3},                     
> {gen\_fsm,handle\_msg,7}]}     in function  gen\_fsm:terminate/7   ancestors: 
> [riak\_core\_vnode\_sup,riak\_core\_sup,<0.98.0>]   messages: []   links: 
> [#Port<0.3507>,<0.100.0>]   dictionary: []   trap\_exit: true   status: 
> running   heap\_size: 1597   stack\_size: 24   reductions: 11185 neighbours:
> =SUPERVISOR REPORT==== 30-Jul-2010::14:22:35 ===    Supervisor: 
> {local,riak\_core\_vnode\_sup}    Context:    child\_terminated    Reason:     
> {{badmatch,{error,emfile}},                 
> [{bitcask\_fileops,create\_file\_loop,3},                  {bitcask,put,3},      
>            {riak\_kv\_bitcask\_backend,put,3},                  
> {riak\_kv\_vnode,perform\_put,3},                  {riak\_kv\_vnode,do\_put,7},     
>              {riak\_kv\_vnode,handle\_command,3},                  
> {riak\_core\_vnode,vnode\_command,3},                  
> {gen\_fsm,handle\_msg,7}]}    Offender:   [{pid,<0.176.0>},                 
> {name,undefined},                 {mfa,                     
> {riak\_core\_vnode,start\_link,                         [riak\_kv\_vnode,          
>                593735040165679310520246963290989976735222595584]}},          
>       {restart\_type,temporary},                 {shutdown,brutal\_kill},      
>           {child\_type,worker}]
>
> =CRASH REPORT==== 30-Jul-2010::14:22:35 === crasher:   initial call: 
> riak\_core\_vnode:init/1   pid: <0.12471.0>   registered\_name: []   exception 
> exit: {bad\_return\_value,{error,{write\_locked,emfile}}}     in function  
> gen\_fsm:terminate/7   ancestors: 
> [riak\_core\_vnode\_sup,riak\_core\_sup,<0.98.0>]   messages: []   links: 
> [<0.100.0>]   dictionary: []   trap\_exit: true   status: running   heap\_size: 
> 2584   stack\_size: 24   reductions: 1955 neighbours:
> =SUPERVISOR REPORT==== 30-Jul-2010::14:22:35 ===    Supervisor: 
> {local,riak\_core\_vnode\_sup}    Context:    child\_terminated    Reason:     
> {bad\_return\_value,{error,{write\_locked,emfile}}}    Offender:   
> [{pid,<0.12471.0>},                 {name,undefined},                 {mfa,   
>                   {riak\_core\_vnode,start\_link,                         
> [riak\_kv\_vnode,                          
> 593735040165679310520246963290989976735222595584]}},                 
> {restart\_type,temporary},                 {shutdown,brutal\_kill},             
>     {child\_type,worker}]
>
> ==> erlang.log.4 <==
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* Generic server memsup 
> terminating \*\* Last message in was {'EXIT',<0.21020.78>,                      
>    {emfile,                              [{erlang,open\_port,                 
>                   [{spawn,"/bin/sh -s unix:cmd 2>&1"},                        
>            [stream]]},                               
> {os,start\_port\_srv\_loop,2}]}}\*\* When Server state == {state,{unix,darwin},    
>                          false,                              
> {1897500000,7776508000},                              {<0.81.0>,972008},      
>                        false,60000,30000,0.8,0.05,<0.21020.78>,              
>                #Ref<0.0.2.58535>,undefined,                              
> [reg],                              []}\*\* Reason for termination == \*\* 
> {emfile,[{erlang,open\_port,[{spawn,"/bin/sh -s unix:cmd 2>&1"},[stream]]},    
>       {os,start\_port\_srv\_loop,2}]}
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* Generic server memsup 
> terminating \*\* Last message in was {'EXIT',<0.21186.78>,                      
>    {emfile,                              [{erlang,open\_port,                 
>                   [{spawn,"/bin/sh -s unix:cmd 2>&1"},                        
>            [stream]]},                               
> {os,start\_port\_srv\_loop,2}]}}\*\* When Server state == {state,{unix,darwin},    
>                          false,undefined,undefined,false,60000,30000,        
>                      0.8,0.05,<0.21186.78>,#Ref<0.0.2.58551>,                
>              undefined,                              [reg],                  
>            []}\*\* Reason for termination == \*\* 
> {emfile,[{erlang,open\_port,[{spawn,"/bin/sh -s unix:cmd 2>&1"},[stream]]},    
>       {os,start\_port\_srv\_loop,2}]}
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* Generic server memsup 
> terminating \*\* Last message in was {'EXIT',<0.21252.78>,                      
>    {emfile,                              [{erlang,open\_port,                 
>                   [{spawn,"/bin/sh -s unix:cmd 2>&1"},                        
>            [stream]]},                               
> {os,start\_port\_srv\_loop,2}]}}\*\* When Server state == {state,{unix,darwin},    
>                          false,undefined,undefined,false,60000,30000,        
>                      0.8,0.05,<0.21252.78>,#Ref<0.0.2.58559>,                
>              undefined,                              [reg],                  
>            []}\*\* Reason for termination == \*\* 
> {emfile,[{erlang,open\_port,[{spawn,"/bin/sh -s unix:cmd 2>&1"},[stream]]},    
>       {os,start\_port\_srv\_loop,2}]}
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* Generic server memsup 
> terminating \*\* Last message in was {'EXIT',<0.21374.78>,                      
>    {emfile,                              [{erlang,open\_port,                 
>                   [{spawn,"/bin/sh -s unix:cmd 2>&1"},                        
>            [stream]]},                               
> {os,start\_port\_srv\_loop,2}]}}\*\* When Server state == {state,{unix,darwin},    
>                          false,undefined,undefined,false,60000,30000,        
>                      0.8,0.05,<0.21374.78>,#Ref<0.0.2.58569>,                
>              undefined,                              [reg],                  
>            []}\*\* Reason for termination == \*\* 
> {emfile,[{erlang,open\_port,[{spawn,"/bin/sh -s unix:cmd 2>&1"},[stream]]},    
>       {os,start\_port\_srv\_loop,2}]}
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* Generic server memsup 
> terminating \*\* Last message in was {'EXIT',<0.21396.78>,                      
>    {emfile,                              [{erlang,open\_port,                 
>                   [{spawn,"/bin/sh -s unix:cmd 2>&1"},                        
>            [stream]]},                               
> {os,start\_port\_srv\_loop,2}]}}\*\* When Server state == {state,{unix,darwin},    
>                          false,undefined,undefined,false,60000,30000,        
>                      0.8,0.05,<0.21396.78>,#Ref<0.0.2.58575>,                
>              undefined,                              [reg],                  
>            []}\*\* Reason for termination == \*\* 
> {emfile,[{erlang,open\_port,[{spawn,"/bin/sh -s unix:cmd 2>&1"},[stream]]},    
>       {os,start\_port\_srv\_loop,2}]}
> =ERROR REPORT==== 30-Jul-2010::14:23:27 ===\*\* State machine <0.175.0> 
> terminating \*\* Last event in was {riak\_vnode\_req\_v1,                     
> 570899077082383952423314387779798054553098649600,                     
> {fsm,undefined,<0.12470.0>},                     {riak\_kv\_put\_req\_v1,         
>              {<<"test.users">>,<<"ZrAxzFghd51VG902GuCcJ2gYOMJ">>},            
>          {r\_object,<<"test.users">>,                       
> <<"ZrAxzFghd51VG902GuCcJ2gYOMJ">>,                       [{r\_content,         
>                 {dict,5,16,16,8,80,48,                          
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                          
> {{[],[],                            [[<<"Links">>,                            
>  {{<<"test.groups">>,                                
> <<"EghzXywWrGGtp2fCcSLoatIdjML">>},                               
> <<"groups">>}]],                            [],[],[],[],[],[],[],             
>                [[<<"content-type">>,97,112,112,108,105,99,97,                 
>              116,105,111,110,47,106,115,111,110],                             
> [<<"X-Riak-VTag">>,50,88,97,105,85,49,70,49,55,                              
> 54,48,71,113,115,75,103,54,102,84,56,118,84]],                            
> [],[],                            
> [[<<"X-Riak-Last-Modified">>|{1280,517755,638}]],                            
> [],                            [[<<"X-Riak-Meta">>]]}}},                      
>   
> <<"{\"name\":\"bar\",\"created\_at\":\"2010-07-30T19:22:34.998Z\",\"type\":\"user\",\"version\":1}">>}],  
>                     [{<<3,30,180,15>>,{1,63447736955}}],                     
>   {dict,1,16,16,8,80,48,                        
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},                        
> {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],                          
> [[clean|true]],                          []}}},                       
> undefined},                      122945524,63447736955,                      
> [{returnbody,true}]}}\*\* When State == active\*\*      Data  == 
> {state,570899077082383952423314387779798054553098649600,                      
> riak\_kv\_vnode,                       
> {state,570899077082383952423314387779798054553098649600,
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

