---
title: "Re: to escape or not to escape?"
description: ""
project: community
lastmod: 2010-12-01T03:24:33-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01683"
mailinglist_parent_id: "msg00881"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2010-12-01T03:24:33-08:00
---


I recently incorporated a pull request into riak-js that involved URI
escaping for the HTTP client.

Shallow tests show that everything works fine, but once you start
messing with links... you get bitten by this bug (#617). And I don't
want to resort to the hack of double-escaping links.

I think `mochiweb\_util:unquote` should not be called there:
https://github.com/basho/riak\_kv/blob/master/src/riak\_kv\_wm\_raw.erl#L1217-1219

(Imagine having a Protobuf (or native Erlang) client adding a link to
['bucket', 'r4nd0m-%40b0e-key'], to later stumble onto not\_founds
because ['bucket', 'r4nd...@b0e-key'] does not exist.)

Base64url-encoding is not an option for us, because we heavily rely on
meaningful keys.

Thanks,
Francisco


2010/8/13 francisco treacy :
&gt; 2010/8/12 Bryan Fink :
&gt;&gt; Hi, Francisco.  I've run into this myself in developing a recent
&gt;&gt; application.  I've been loathe to change the Riak behavior, for
&gt;&gt; worries of breaking existing client expectations.  The original
&gt;&gt; escaping was put in to deal with objects that had been created by the
&gt;&gt; native Erlang client, and therefore might have non-url-safe keys.  I'm
&gt;&gt; fairly certain I now agree that Riak should never mess with escaping,
&gt;&gt; though (and that non-url-safe keys should be treated as errors for the
&gt;&gt; HTTP interface).
&gt;
&gt; Yes, we agree Riak should never mess with escaping \*and\* non-url-safe
&gt; keys should be treated as errors for the HTTP interface (or for all,
&gt; what if you save a document via Erlang or the protobuf interface and
&gt; then you want to retrieve it with HTTP GET?).
&gt;
&gt; I think not only it's important to fix
&gt; https://issues.basho.com/show\_bug.cgi?id=617 , but also to clearly
&gt; state how client lib implementors should deal with this (basically,
&gt; that they should take care of all escaping in a uniform manner).
&gt;
&gt;&gt; In the meantime, a good workaround is to base64-encode keys used over
&gt;&gt; HTTP.  As long as you use alternate characters for + and / (like - and
&gt;&gt; \_, called "base64url" on http://en.wikipedia.org/wiki/Base64), you end
&gt;&gt; up with urlencode(base64encode(Key)) == urldecode(base64encode(Key))
&gt;&gt; == base64encode(Key).
&gt;
&gt; If I understand correctly this would involve changing my keys and atm
&gt; it's not really feasible in our app. As a workaround until this is
&gt; fixed, I patched Ripple so that it doesn't escape:
&gt; http://github.com/frank06/ripple/commit/baa326f0f6041f9ab2401e0606cd35533e878cf0
&gt; (works ok so far).
&gt;
&gt; Thanks,
&gt; Francisco
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

