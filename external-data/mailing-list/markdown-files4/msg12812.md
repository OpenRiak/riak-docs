---
title: "bitcask issue - write_locked"
description: ""
project: community
lastmod: 2013-10-31T07:44:33-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12812"
author_name: "Konstantin Kalin"
project_section: "mailinglistitem"
sent_date: 2013-10-31T07:44:33-07:00
---


We use riak 1.2.1 in production. Recently we had two incidents when a Riak
node (out of 27 nodes) was in limbo state: riak-core worked fine but
bitcask backend was constantly crashing (see below). Both times it happened
immediately after Riak was restarted due to Linux reboot.

I looked at the source code of bitcask and looks like it happens because
there was a stuck alive process that held the lock.

Major issue that this node causes timeouts on others and as result Java
client got timeout error and bad-message code. Thus it was impossible to do
any update for data that lands to that node as a primary replica (It's my
guess). For reads there was significant delay ~60 seconds. We have W=3, R=2.

Is it known issue ? What I can do besides of upgrading to latest version
and hoping it will solve the issue :)

Thank you,
Konstantin.

Bad Riak node.
==================
2013-10-30 21:40:27.000 [info] &lt;0.7.0&gt; Application erlydtl started on node '
r...@dirapp81.mlp.marquee.net'
2013-10-30 21:40:45.229 [info] &lt;0.407.0&gt;@riak\_core:wait\_for\_service:439
Wait complete for service riak\_kv (18 seconds)
2013-10-30 21:40:45.473 [error] &lt;0.798.0&gt; gen\_fsm &lt;0.798.0&gt; in state active
terminated with reason: bad return value:
{error,{write\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
2013-10-30 21:40:45.485 [error] &lt;0.798.0&gt; CRASH REPORT Process &lt;0.798.0&gt;
with 1 neighbours exited with reason: bad return value:
{error,{write\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
in gen\_fsm:terminate/7 line 611
2013-10-30 21:40:45.486 [error] &lt;0.140.0&gt; Supervisor riak\_core\_vnode\_sup
had child undefined started with {riak\_core\_vnode,start\_link,undefined} at
&lt;0.798.0&gt; exit with reason bad return value:
{error,{write\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
in context child\_terminated
2013-10-30 21:40:45.487 [error] &lt;0.845.0&gt; gen\_fsm &lt;0.845.0&gt; in state ready
terminated with reason: bad return value:
{error,{write\_locked,locked,"/var/lib/riak/bitcask/1324485858831130769622089379649131486563188867072"}}
==================


Another good Riak node:
==================
2013-10-30 21:37:36.348 [error] &lt;0.15018.5661&gt;@riak\_kv\_put\_fsm:prepare:220
Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"123"&gt;&gt;} to '
r...@dirapp81.mlp.marquee.net' - nodedown
2013-10-30 21:37:36.348 [error] &lt;0.14950.5661&gt;@riak\_kv\_put\_fsm:prepare:220
Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"123"&gt;&gt;} to '
r...@dirapp81.mlp.marquee.net' - nodedown
2013-10-30 21:41:52.313 [error]
&lt;0.16728.5661&gt;@riak\_api\_pb\_server:handle\_info:170 Unrecognized message
{11673037,{error,timeout}}
2013-10-30 21:41:52.313 [error]
&lt;0.16733.5661&gt;@riak\_api\_pb\_server:handle\_info:170 Unrecognized message
{105876903,{error,timeout}}
==================


One more good Riak node (that temporary held vnode of bad Riak node during
it's down):
==================
2013-10-30 21:37:37.345 [error] &lt;0.3663.0&gt; \*\* Node '
r...@dirapp81.mlp.marquee.net' not responding \*\*
\*\* Removing (timedout) connection \*\*

2013-10-30 21:37:37.345 [error] &lt;0.30864.17&gt;@riak\_kv\_put\_fsm:prepare:220
Unable to forward put for {&lt;&lt;"userSessions"&gt;&gt;,&lt;&lt;"5457016"&gt;&gt;} to '
r...@dirapp81.mlp.marquee.net' - nodedown
2013-10-30 21:41:44.358 [info]
&lt;0.151.0&gt;@riak\_core\_handoff\_manager:handle\_info:271 An outbound handoff of
partition riak\_kv\_vnode 1438665674247607560106752257205091097473808596992
was terminated for reason: {shutdown,max\_concurrency}
2013-10-30 21:42:44.361 [info]
&lt;0.151.0&gt;@riak\_core\_handoff\_manager:handle\_info:271 An outbound handoff of
partition riak\_kv\_vnode 1438665674247607560106752257205091097473808596992
was terminated for reason: {shutdown,max\_concurrency}
2013-10-30 21:44:30.164 [info]
&lt;0.151.0&gt;@riak\_core\_handoff\_manager:handle\_info:271 An outbound handoff of
partition riak\_kv\_vnode 1438665674247607560106752257205091097473808596992
was terminated for reason: {shutdown,max\_concurrency}
2013-10-30 21:45:30.384 [info]
&lt;0.2262.18&gt;@riak\_core\_handoff\_sender:start\_fold:126 Starting hinted\_handoff
transfer of riak\_kv\_vnode from 'r...@dirapp41.mlp.marquee.net'
1438665674247607560106752257205091097473808596992 to '
r...@dirapp81.mlp.marquee.net'
1438665674247607560106752257205091097473808596992
2013-10-30 21:45:43.917 [error]
&lt;0.2262.18&gt;@riak\_core\_handoff\_sender:start\_fold:215 hinted\_handoff transfer
of riak\_kv\_vnode from 'r...@dirapp41.mlp.marquee.net'
1438665674247607560106752257205091097473808596992 to '
r...@dirapp81.mlp.marquee.net'
1438665674247607560106752257205091097473808596992 failed because of
error:{case\_clause,{error,closed}}
[{riak\_core\_handoff\_sender,start\_fold,5,[{file,"src/riak\_core\_handoff\_sender.erl"},{line,174}]}]
2013-10-30 21:46:30.382 [error]
&lt;0.969.18&gt;@riak\_api\_pb\_server:handle\_info:170 Unrecognized message
{67827933,{error,timeout}}
2013-10-30 21:47:30.167 [info]
&lt;0.151.0&gt;@riak\_core\_handoff\_manager:handle\_info:271 An outbound handoff of
partition riak\_kv\_vnode 1438665674247607560106752257205091097473808596992
was terminated for reason: {shutdown,max\_concurrency}
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

