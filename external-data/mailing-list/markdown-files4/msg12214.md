---
title: "Re: Multi-backend, eLevelDB, & Too many open files"
description: ""
project: community
lastmod: 2013-09-09T14:22:52-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12214"
mailinglist_parent_id: "msg12209"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2013-09-09T14:22:52-07:00
---


Hi Matt -

Can you attach to a node in your cluster with "riak attach" and run
this erlang snippet (before the node errors out)?

os:cmd("ulimit -n").

This will show the actual value for ulimit for that running riak node.
I suspect that this value hasn't been updated for the running process,
even though you've modified limits.conf.

Depending on your OS there may be more configuration necessary for the
open files limit to "stick":
http://docs.basho.com/riak/latest/ops/tuning/open-files-limit/#Linux

On Sun, Sep 8, 2013 at 9:15 PM, Matt Black  wrote:
&gt; Hey list,
&gt;
&gt; We're migrating from our currently operational cluster to a new one in a
&gt; different EC2 region. As part of this migration, we'd like to move from
&gt; Bitcask to eLevelDB - mostly for the benefits provided by secondary indexes.
&gt;
&gt; We also use Multi-backend configuration, in order to split our various
&gt; client's data into entirely separate spaces on disk (this is useful for
&gt; legal reasons). I made the simple change from "riak\_kv\_bitcask\_backend" to
&gt; "riak\_kv\_eleveldb\_backend" in our config, and did some calculations for
&gt; "max\_open\_files", and then started a new node.
&gt;
&gt; It fails with the following error in short order:
&gt;
&gt;&gt; cat error.log
&gt; 2013-09-09 03:49:51.391 [error] &lt;0.715.0&gt;@riak\_kv\_vnode:init:375 Failed to
&gt; start riak\_kv\_multi\_backend Reason: [{riak\_kv\_eleveldb\_backend,{db\_open,"IO
&gt; error:
&gt; /mnt/riak/eleveldb/client1/365375409332725729550921208179070754913983135744/000015.dbtmp:
&gt; Too many open files"}}]
&gt; 2013-09-09 03:49:51.392 [error] &lt;0.940.0&gt;@riak\_kv\_vnode:init:375 Failed to
&gt; start riak\_kv\_multi\_backend Reason: [{riak\_kv\_eleveldb\_backend,{db\_open,"IO
&gt; error:
&gt; /mnt/riak/eleveldb/client2/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
&gt; /mnt/riak/eleveldb/client3/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
&gt; /mnt/riak/eleveldb/client4/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
&gt; /mnt/riak/eleveldb/client5/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
&gt; /mnt/riak/eleveldb/client6/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files"}}]
&gt;
&gt; And some relevant app.config:
&gt;
&gt; {multi\_backend\_default, &lt;&lt;"default"&gt;&gt;},
&gt; {multi\_backend, [
&gt; %% Default fallback: this is unused
&gt; {&lt;&lt;"default"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/default"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client1"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client1"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client2"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client2"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client3"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client3"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client4"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client4"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client5"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client5"}
&gt; ]},
&gt; {&lt;&lt;"eleveldb\_client6"&gt;&gt;, riak\_kv\_eleveldb\_backend, [
&gt; {data\_root, "/mnt/riak/eleveldb/client6"}
&gt; ]}
&gt; ]},
&gt;
&gt; .. snip ..
&gt;
&gt; %% Default cache size of 8MB
&gt; {cache\_size, 8388608},
&gt; %% Maximum number of files open at once per partition
&gt; {max\_open\_files, 50}
&gt;
&gt; I've set the "riak soft/hard nofile 65536" in /etc/security/limits.conf, so
&gt; presumably this "Too many open files" error is referring to the
&gt; "max\_open\_files" option as part of eLevelDB config. The RAM in each machine
&gt; is 3.5GB free, so I calculated on a 5 node cluster this 50 max\_open\_files
&gt; limit.
&gt;
&gt; - Is there something about Multi-backend I haven't taken into account?
&gt; - Do I need a larger max\_open\_files? (And thus more RAM? :)
&gt;
&gt; Cheers!
&gt; Matt
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;



-- 
Luke Bakken
CSE
lbak...@basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

