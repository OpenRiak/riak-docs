---
title: "Re: Riak 1.4.2 10G Ethernet Performance Problems"
description: ""
project: community
lastmod: 2014-06-20T18:24:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14337"
mailinglist_parent_id: "msg14336"
author_name: "Earl Ruby"
project_section: "mailinglistitem"
sent_date: 2014-06-20T18:24:17-07:00
---


True, but if I test random-writes of 1M objects using fio on the filesystem
-- no Riak involved -- the disk random write aggregate speed (32 fio
threads all randomly writing to one node's array) is 9.4 Gbits/sec \*\*\*per
node\*\*\*, and I have 6 nodes. If Riak was distributing all writes evenly and
I had infinite network bandwidth I'd expect something closer to 9.4 \* 6 =
56.4 Gbits/s over the whole cluster.

However, iperf3 shows the network topping out at 9.92 Gbits/s, so I expect
to run out of network bandwidth before disk speed became a bottleneck.

If I use basho\_bench to test RiakCS with a new bucket, an 8M file\_size and
a 1M ibrowse\_chunk\_size, when I check the aggregate network speed using
jnettop it hovers right around 3Gbps, and my CPUs are mostly idle -- it
seems like writes should be 3x faster.

I just read an interesting blog post
http://www.snookles.com/slf-blog/2012/01/05/tcp-incast-what-is-it/ which
sounds like the same issue. I'm going to try some of the tests suggested
there and see if I'm seeing the same problem described by the author.



On 20 June 2014 11:09, Evan Vigil-McClanahan  wrote:

&gt; In my testing with large but smaller binaries (median 40k), I found
&gt; that the settings gave a noticeable bump (8000 -&gt; 10000 ops/s) , but
&gt; only so far as the disk could keep up (and the disk cache, of course).
&gt; Typically, for larger objects, you're going to be disk limited most of
&gt; the time. Remember that riak is basically doing a bunch of random,
&gt; mid-sized (to the disk, at least) reads and writes here, so disk
&gt; limitations are going to make it really hard to get near to your
&gt; disk's theoretical maximums.
&gt;
&gt; On Fri, Jun 20, 2014 at 10:53 AM, Chris Read  wrote:
&gt; &gt; We still have this problem (we're on riak 1.4.9) and it's very
&gt; frustrating!
&gt; &gt;
&gt; &gt; Our average object size right now is ~250k. We're running with:
&gt; &gt;
&gt; &gt; +zdbbl 2097151
&gt; &gt;
&gt; &gt;
&gt; &gt; I've tried the settings above on a 5 node test cluster, no improvement.
&gt; &gt;
&gt; &gt; I then bumped both buffers up to 1048576 on all nodes - no improvement.
&gt; &gt;
&gt; &gt; Finally I tried putting the buffers up to 4194304 - still no improvement.
&gt; &gt;
&gt; &gt; For the record my kernel is Ubuntu 3.13.0-27, with the following
&gt; &gt; network settings:
&gt; &gt;
&gt; &gt; net.core.netdev\_max\_backlog = 10000
&gt; &gt; net.core.rmem\_default = 8388608
&gt; &gt; net.core.rmem\_max = 104857600
&gt; &gt; net.core.somaxconn = 4000
&gt; &gt; net.core.wmem\_default = 8388608
&gt; &gt; net.core.wmem\_max = 104857600
&gt; &gt; net.ipv4.tcp\_congestion\_control = cubic
&gt; &gt; net.ipv4.tcp\_fin\_timeout = 15
&gt; &gt; net.ipv4.tcp\_low\_latency = 0
&gt; &gt; net.ipv4.tcp\_max\_syn\_backlog = 40000
&gt; &gt; net.ipv4.tcp\_slow\_start\_after\_idle = 0
&gt; &gt; net.ipv4.tcp\_tw\_reuse = 1
&gt; &gt;
&gt; &gt; Chris
&gt; &gt;
&gt; &gt; On Wed, Jun 18, 2014 at 7:32 PM, Evan Vigil-McClanahan
&gt; &gt;  wrote:
&gt; &gt;&gt; Hi Earl,
&gt; &gt;&gt;
&gt; &gt;&gt; There are some known internode bottlenecks in riak 1.4.x. We've
&gt; &gt;&gt; addressed some of them in 2.0, but others likely remain. If you're
&gt; &gt;&gt; willing to run some code at the console, running the following at the
&gt; &gt;&gt; console (from `riak attach`) should tell you whether or not the 2.0
&gt; &gt;&gt; changes are likely to help you. I am not sure when 2.0 ready versions
&gt; &gt;&gt; of CS are slated for, however.
&gt; &gt;&gt;
&gt; &gt;&gt; -----
&gt; &gt;&gt; [inet:setopts(Port, [{sndbuf, 393216}, {recbuf, 786432}])
&gt; &gt;&gt; || {\_Node, Port} &lt;- erlang:system\_info(dist\_ctrl)].
&gt; &gt;&gt;
&gt; &gt;&gt; or to run this on all nodes (which you'll have to do to see if it
&gt; helps):
&gt; &gt;&gt;
&gt; &gt;&gt; FF = fun() -&gt;
&gt; &gt;&gt; [inet:setopts(Port, [{sndbuf, 393216}, {recbuf,
&gt; 786432}])
&gt; &gt;&gt; || {\_Node, Port} &lt;- erlang:system\_info(dist\_ctrl)]
&gt; &gt;&gt; end.
&gt; &gt;&gt; rpc:multicall(erlang, apply, [FF, []]).
&gt; &gt;&gt;
&gt; &gt;&gt; You should not run any of this on production machines without
&gt; &gt;&gt; extensive testing first. Also if you have huge objects, like in a CS
&gt; &gt;&gt; cluster, it may help to increase the buffer sizes somewhat.
&gt; &gt;&gt;
&gt; &gt;&gt; Note that increasing +zdbbl in your vm.args can also help somewhat, if
&gt; &gt;&gt; it isn't already prohibitively large.
&gt; &gt;&gt;
&gt; &gt;&gt; Hope that this helps. Let us know what you find.
&gt; &gt;&gt;
&gt; &gt;&gt; Evan
&gt; &gt;&gt;
&gt; &gt;&gt; On Wed, Jun 18, 2014 at 4:57 PM, Earl Ruby 
&gt; wrote:
&gt; &gt;&gt;&gt; Chris Read:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Back in 2013 you reported a performance problem with Riak 1.4.2
&gt; running on a
&gt; &gt;&gt;&gt; 10GbE network where Riak would never hit speeds faster than 2.5Gbps on
&gt; the
&gt; &gt;&gt;&gt; network.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I'm seeing the same thing with Riak 1.4.2 and RiakCS. I've followed
&gt; all of
&gt; &gt;&gt;&gt; the tuning suggestions, my MTU is set to 9000 on the ethernet
&gt; interfaces, I
&gt; &gt;&gt;&gt; have one 10GbE network just for the backend inter-node data and one
&gt; 10GbE
&gt; &gt;&gt;&gt; "public" network where RiakCS listens for connections and which
&gt; basho\_bench
&gt; &gt;&gt;&gt; uses to generate the load. I have 1-4 client systems on the public side
&gt; &gt;&gt;&gt; running basho\_bench and no matter how much traffic I generate with
&gt; &gt;&gt;&gt; basho\_bench I never see more than 3Gbits/s on the network. (It doesn't
&gt; seem
&gt; &gt;&gt;&gt; to matter if I run 1 or 4 clients, each with 200 concurrent sessions,
&gt; the
&gt; &gt;&gt;&gt; network data rate is about the same.) I'm running jnettop in two
&gt; different
&gt; &gt;&gt;&gt; windows during the tests to watch the aggregate network traffic on the
&gt; &gt;&gt;&gt; private inter-node data network and the "public" basho\_bench
&gt; &gt;&gt;&gt; traffic-generating network.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I've tested the network with iperf3 and it shows 9.92Gbits/s
&gt; throughput with
&gt; &gt;&gt;&gt; a TCP maximum segment size of 9000.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I've tested the filesystems on each of the 6 Riak nodes using fio, and
&gt; I can
&gt; &gt;&gt;&gt; write to the filesystems at ~12.8Gbits/s, so the filesystem is not the
&gt; &gt;&gt;&gt; bottleneck. Each node has 128GB RAM and is running the bitcask
&gt; backend. The
&gt; &gt;&gt;&gt; servers are mostly idle.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I tried Sean's solution of increasing these values to:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; {riak\_core, [
&gt; &gt;&gt;&gt; {handoff\_batch\_threshold, 4194304},
&gt; &gt;&gt;&gt; {handoff\_concurrency, 10} ]}
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; ... as described in
&gt; &gt;&gt;&gt;
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2013-October/013787.html
&gt; ,
&gt; &gt;&gt;&gt; but that had no effect.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; With my current hardware I'd expect that the 10GbE network would be the
&gt; &gt;&gt;&gt; bottleneck, and I'd expect write speeds to top out at the top end of
&gt; the
&gt; &gt;&gt;&gt; network speed.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; There was no follow-up message on the mailing list to indicate how or
&gt; if
&gt; &gt;&gt;&gt; you'd solved the problem. Did you find a solution?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; (Please direct replies to the mailing list.)
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;



-- 

\*Earl C. Ruby III\*
\*Software Staff Engineer (Cloud Platform)\*
\*+1 (415) 527-7275\*
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

