---
title: "Re: Beginners performance problem"
description: ""
project: community
lastmod: 2013-02-24T05:16:48-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10228"
mailinglist_parent_id: "msg10215"
author_name: "Lars J. Nilsson"
project_section: "mailinglistitem"
sent_date: 2013-02-24T05:16:48-08:00
---


Dmitri,

Sure, I can upload the entire project as well if you like. There's no
secret source in it :-)

Creating the client (shared by all "actors"):

&gt;&gt;&gt;
if(sharedClient == null) {
 Configuration config = new
PBClientConfig.Builder().withHost(host).withPoolSize(threads).build();
 // Configuration config = new
HTTPClientConfig.Builder().withHost(host).build();
 sharedClient = RiakFactory.newClient(config);
}
&gt;&gt;&gt;

Where "threads" is the concurrency of the test, ie how many worker threads
are controlling the actors. So in this instance there'll be one connection
per executing actor

One actor, "acting":

&gt;&gt;&gt;
Bucket bucket = sharedClient.createBucket("accounts1").execute();
bucket.store(a.getId().toString(), mapper.writeValueAsString(a)).execute();
&gt;&gt;&gt;

Where "a" is an account object and "mapper" is a Jackson object mapper. The
bucket has been created using a rest client prior to the first call with
n\_val = 1.

Cheers
/Lars J. Nilsson
Executive VP, Cubeia Ltd
+46 (0) 704 / 10 69 53


On 22 February 2013 23:20, Dmitri Zagidulin  wrote:

&gt; Lars,
&gt; If increasing number of worker threads and using connection pooling
&gt; did not improve performance, then maybe we're looking at some kind of
&gt; environmental or setting issue.
&gt;
&gt; But just in case -- can you post snippets of the code that's setting
&gt; up the java riak client and issuing the writes?
&gt;
&gt;
&gt; On Fri, Feb 22, 2013 at 5:09 PM, Lars J. Nilsson
&gt;  wrote:
&gt; &gt; Sorry, yes. I've used anything from single threads to one thread per
&gt; &gt; "actor". Including anything from one connection to one per process, and
&gt; &gt; pooling, etc.
&gt; &gt;
&gt; &gt; /Lars J. Nilsson
&gt; &gt; [sent from my mobile]
&gt; &gt;
&gt; &gt; Den 22 feb 2013 19:49 skrev "Sean Cribbs" :
&gt; &gt;
&gt; &gt;&gt; Use multiple threads in your Java program to parallelize the writes.
&gt; &gt;&gt;
&gt; &gt;&gt; On Fri, Feb 22, 2013 at 9:40 AM, Lars J. Nilsson
&gt; &gt;&gt;  wrote:
&gt; &gt;&gt; &gt; Hi Sean,
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; Thanks for pipjng in. And how do I do that?
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; Cheers
&gt; &gt;&gt; &gt; /Lars J. Nilsson
&gt; &gt;&gt; &gt; Executive VP, Cubeia Ltd
&gt; &gt;&gt; &gt; +46 (0) 704 / 10 69 53
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; On 22 February 2013 16:28, Sean Cribbs  wrote:
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; Given iostat says ~10% utilization, I would suggest increasing the
&gt; &gt;&gt; &gt;&gt; concurrency of your writes. It's obviously not using up the capacity
&gt; &gt;&gt; &gt;&gt; of the disk, your bottleneck is elsewhere. 2MB/sec is low for any
&gt; &gt;&gt; &gt;&gt; commodity hardware.
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; On Fri, Feb 22, 2013 at 9:21 AM, Lars J. Nilsson
&gt; &gt;&gt; &gt;&gt;  wrote:
&gt; &gt;&gt; &gt;&gt; &gt; Hi all,
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; I'm micro-testing a simple update pattern (key + short json
&gt; document)
&gt; &gt;&gt; &gt;&gt; &gt; on
&gt; &gt;&gt; &gt;&gt; &gt; my
&gt; &gt;&gt; &gt;&gt; &gt; local workstation (8 core intel CPU, 8 gig of RAM, 10K disk) to get
&gt; &gt;&gt; &gt;&gt; &gt; baseline
&gt; &gt;&gt; &gt;&gt; &gt; before moving to cluster on AWS. With Riak I get about 60 mods/s
&gt; &gt;&gt; &gt;&gt; &gt; before
&gt; &gt;&gt; &gt;&gt; &gt; maxing out (as compared to approx 3000 mods/s on a vanilla MySQL
&gt; &gt;&gt; &gt;&gt; &gt; using
&gt; &gt;&gt; &gt;&gt; &gt; exactly the same code).
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; It feels like I must be doing something hideously wrong. (For the
&gt; &gt;&gt; &gt;&gt; &gt; record,
&gt; &gt;&gt; &gt;&gt; &gt; I'm a decent Java programmer but a riak/erlang n00b).
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Riak is installed via a vanilla Ununtu 12.04 package as described
&gt; in
&gt; &gt;&gt; &gt;&gt; &gt; the
&gt; &gt;&gt; &gt;&gt; &gt; docs. The test ran on the same disk as the mentioned MySQL test.
&gt; The
&gt; &gt;&gt; &gt;&gt; &gt; same
&gt; &gt;&gt; &gt;&gt; &gt; Java code was doing both tests (just a DAO swapped).
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; The bucket was using n\_val = 1.
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; The problem seems to be in high disk-writing, despite the low load.
&gt; &gt;&gt; &gt;&gt; &gt; Here's
&gt; &gt;&gt; &gt;&gt; &gt; what iostat says during the run:
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; [...]
&gt; &gt;&gt; &gt;&gt; &gt; wrqm/s : 434.50
&gt; &gt;&gt; &gt;&gt; &gt; w/s: 182.90
&gt; &gt;&gt; &gt;&gt; &gt; wkB/s: 2618.00
&gt; &gt;&gt; &gt;&gt; &gt; avgrq-sz: 28.63
&gt; &gt;&gt; &gt;&gt; &gt; [...]
&gt; &gt;&gt; &gt;&gt; &gt; %util: 10.60
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Which seems to be too much considering the small load (the stored
&gt; &gt;&gt; &gt;&gt; &gt; JSON
&gt; &gt;&gt; &gt;&gt; &gt; blobs
&gt; &gt;&gt; &gt;&gt; &gt; are roughly 1K each).
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; I'm using the official PB Java client.
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; This is an evaluation for a customer. Any hint of what I'm missing
&gt; or
&gt; &gt;&gt; &gt;&gt; &gt; what
&gt; &gt;&gt; &gt;&gt; &gt; the problem could be would be appreciated.
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Cheers
&gt; &gt;&gt; &gt;&gt; &gt; /Lars J. Nilsson
&gt; &gt;&gt; &gt;&gt; &gt; Executive VP, Cubeia Ltd
&gt; &gt;&gt; &gt;&gt; &gt; +46 (0) 704 / 10 69 53
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; &gt;&gt; &gt; riak-users mailing list
&gt; &gt;&gt; &gt;&gt; &gt; riak-users@lists.basho.com
&gt; &gt;&gt; &gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; --
&gt; &gt;&gt; &gt;&gt; Sean Cribbs 
&gt; &gt;&gt; &gt;&gt; Software Engineer
&gt; &gt;&gt; &gt;&gt; Basho Technologies, Inc.
&gt; &gt;&gt; &gt;&gt; http://basho.com/
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; --
&gt; &gt;&gt; Sean Cribbs 
&gt; &gt;&gt; Software Engineer
&gt; &gt;&gt; Basho Technologies, Inc.
&gt; &gt;&gt; http://basho.com/
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

