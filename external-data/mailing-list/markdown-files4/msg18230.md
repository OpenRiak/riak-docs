---
title: "Re: Long delays when trying to recover from errors in Java client at	startup"
description: ""
project: community
lastmod: 2017-05-22T00:32:54-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18230"
mailinglist_parent_id: "msg18229"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2017-05-22T00:32:54-07:00
---


Hi Magnus,
I can't use riak-admin in a script like this, because Riak KV is not
installed on the client containers.

Ah, I forgot that bucket listing was the same as key listing. I'll switch
that to a different test.
In this use case, though, it's not too important -- I'm trying to deal with
unit tests that start up Riak fixtures via Docker.

So there is literally no content in them to start up. Unfortunately, doing
a simple HTTP request to /ping isn't sufficient to really tell if the Riak
fixture has spun up properly, as sometimes it'll return OK to /ping, but
still return errors on other requests.

Do you know why there is this eight minute delay before RiakClient sees the
node as good?
It's not the Riak KV instance -- because if I cheat and put a ten second
delay in, so that the very first attempt to scan for buckets succeeds, then
things proceed instantly.

On Mon, 22 May 2017 at 17:14 Magnus Kessler  wrote:

&gt; On 22 May 2017 at 07:02, Toby Corkindale  wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt; I've been trying to make a JVM-based app have better error recovery when
&gt;&gt; the Riak cluster is still in a starting-up state.
&gt;&gt; I have a fairly naive wait-loop that tries to connect and list buckets,
&gt;&gt; and if there's an exception, retry again after a short delay.
&gt;&gt;
&gt;&gt; However once the Riak cluster comes good, the java client hangs on the
&gt;&gt; first operation it makes, for a really long time. Minutes.
&gt;&gt; -- in particular, at
&gt;&gt; com.basho.riak.client.core.RiakCluster.retryOperation(RiakCluster.java:479)
&gt;&gt;
&gt;&gt; I've tried shutting down and recreating the RiakClient between attempts,
&gt;&gt; but this doesn't seem to help.
&gt;&gt; I guess the node manager has its own back-offs and delays.. Is there a
&gt;&gt; way to reduce these timeouts?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Toby
&gt;&gt;
&gt;&gt;
&gt; Hi Toby,
&gt;
&gt; Using bucket listing as a method to determine live-ness is a really bad
&gt; idea. Bucket-listing, just as key-listing, requires a coverage query across
&gt; ALL objects stored in the cluster, and will take a really long time if the
&gt; cluster contains many objects.
&gt;
&gt; A better alternative would be to have a canary object with a known key,
&gt; that can be read quickly.
&gt;
&gt; In startup scripts, that need to wait until Riak KV is operational, we
&gt; recommend using `riak-admin wait-for-service riak\_kv`.
&gt;
&gt; Kind Regards,
&gt;
&gt; Magnus
&gt;
&gt; --
&gt; Magnus Kessler
&gt; Client Services Engineer
&gt; Basho Technologies Limited
&gt;
&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

