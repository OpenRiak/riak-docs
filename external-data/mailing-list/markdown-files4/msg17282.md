---
title: "Re: Very slow acquisition time (99 percentile) while fast median times"
description: ""
project: community
lastmod: 2016-05-03T07:52:56-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17282"
mailinglist_parent_id: "msg17275"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-05-03T07:52:56-07:00
---


Guillaume -

You said earlier "My data are stored on an openstack volume that
support up to 3000IOPS". There is a likelihood that your write load is
exceeding the capacity of your virtual environment, especially if some
Riak nodes are sharing physical disk or server infrastructure.

Some suggestions:

\* If you're not using Riak Search, set "search = off" in riak.conf

\* Be sure to carefully read and apply all tunings:
http://docs.basho.com/riak/kv/2.1.4/using/performance/

\* You may wish to increase the memory dedicated to leveldb:
http://docs.basho.com/riak/kv/2.1.4/configuring/backend/#leveldb

--
Luke Bakken
Engineer
lbak...@basho.com


On Tue, May 3, 2016 at 7:33 AM, Guillaume Boddaert
 wrote:
&gt; Hi,
&gt;
&gt; Sorry for the delay, I've spent a lot of time trying to understand if the
&gt; problem was elsewhere.
&gt; I've simplified my infrastructure and got a simple layout that don't rely
&gt; anymore on loadbalancer and also corrected some minor performance issue on
&gt; my workers.
&gt;
&gt; At the moment, i have up to 32 workers that are calling riak for writes,
&gt; each of them are set to :
&gt; w=1
&gt; dw=0
&gt; timeout=1000
&gt; using protobuf
&gt; a timeouted attempt is rerun 180s later
&gt;
&gt; From my application server perspective, 23% of the calls are rejected by
&gt; timeout (75446 tries, 57564 success, 17578 timeout).
&gt;
&gt; Here is a sample riak-admin stat for one of my 5 hosts:
&gt;
&gt; node\_put\_fsm\_time\_100 : 999331
&gt; node\_put\_fsm\_time\_95 : 773682
&gt; node\_put\_fsm\_time\_99 : 959444
&gt; node\_put\_fsm\_time\_mean : 156242
&gt; node\_put\_fsm\_time\_median : 20235
&gt; vnode\_put\_fsm\_time\_100 : 5267527
&gt; vnode\_put\_fsm\_time\_95 : 2437457
&gt; vnode\_put\_fsm\_time\_99 : 4819538
&gt; vnode\_put\_fsm\_time\_mean : 175567
&gt; vnode\_put\_fsm\_time\_median : 6928
&gt;
&gt; I am using leveldb, so i can't tune bitcask backend as suggested.
&gt;
&gt; I've changed the vmdirty settings and enabled them:
&gt; admin@riak1:~$ sudo sysctl -a | grep dirtyvm.dirty\_background\_ratio = 0
&gt; vm.dirty\_background\_bytes = 209715200
&gt; vm.dirty\_ratio = 40
&gt; vm.dirty\_bytes = 0
&gt; vm.dirty\_writeback\_centisecs = 100
&gt; vm.dirty\_expire\_centisecs = 200
&gt;
&gt; I've seen less idle time between writes, iostat is showing near constant
&gt; writes between 20 and 500 kb/s, with some surges around 4000 kb/s. That's
&gt; better, but not that great.
&gt;
&gt; Here is the current configuration for my "activity\_fr" bucket type and
&gt; "tweet" bucket:
&gt;
&gt;
&gt; admin@riak1:~$ http localhost:8098/types/activity\_fr/props
&gt; HTTP/1.1 200 OK
&gt; Content-Encoding: gzip
&gt; Content-Length: 314
&gt; Content-Type: application/json
&gt; Date: Tue, 03 May 2016 14:30:21 GMT
&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt; Vary: Accept-Encoding
&gt; {
&gt; "props": {
&gt; "active": true,
&gt; "allow\_mult": false,
&gt; "basic\_quorum": false,
&gt; "big\_vclock": 50,
&gt; "chash\_keyfun": {
&gt; "fun": "chash\_std\_keyfun",
&gt; "mod": "riak\_core\_util"
&gt; },
&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt; "dvv\_enabled": false,
&gt; "dw": "quorum",
&gt; "last\_write\_wins": true,
&gt; "linkfun": {
&gt; "fun": "mapreduce\_linkfun",
&gt; "mod": "riak\_kv\_wm\_link\_walker"
&gt; },
&gt; "n\_val": 3,
&gt; "notfound\_ok": true,
&gt; "old\_vclock": 86400,
&gt; "postcommit": [],
&gt; "pr": 0,
&gt; "precommit": [],
&gt; "pw": 0,
&gt; "r": "quorum",
&gt; "rw": "quorum",
&gt; "search\_index": "activity\_fr.20160422104506",
&gt; "small\_vclock": 50,
&gt; "w": "quorum",
&gt; "young\_vclock": 20
&gt; }
&gt; }
&gt;
&gt; admin@riak1:~$ http localhost:8098/types/activity\_fr/buckets/tweet/props
&gt; HTTP/1.1 200 OK
&gt; Content-Encoding: gzip
&gt; Content-Length: 322
&gt; Content-Type: application/json
&gt; Date: Tue, 03 May 2016 14:30:02 GMT
&gt; Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
&gt; Vary: Accept-Encoding
&gt;
&gt; {
&gt; "props": {
&gt; "active": true,
&gt; "allow\_mult": false,
&gt; "basic\_quorum": false,
&gt; "big\_vclock": 50,
&gt; "chash\_keyfun": {
&gt; "fun": "chash\_std\_keyfun",
&gt; "mod": "riak\_core\_util"
&gt; },
&gt; "claimant": "r...@riak2.lighthouse-analytics.co",
&gt; "dvv\_enabled": false,
&gt; "dw": "quorum",
&gt; "last\_write\_wins": true,
&gt; "linkfun": {
&gt; "fun": "mapreduce\_linkfun",
&gt; "mod": "riak\_kv\_wm\_link\_walker"
&gt; },
&gt; "n\_val": 3,
&gt; "name": "tweet",
&gt; "notfound\_ok": true,
&gt; "old\_vclock": 86400,
&gt; "postcommit": [],
&gt; "pr": 0,
&gt; "precommit": [],
&gt; "pw": 0,
&gt; "r": "quorum",
&gt; "rw": "quorum",
&gt; "search\_index": "activity\_fr.20160422104506",
&gt; "small\_vclock": 50,
&gt; "w": "quorum",
&gt; "young\_vclock": 20
&gt; }
&gt; }
&gt;
&gt; I really don't know what to do. Can you help ?
&gt;
&gt; Guillaume

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

