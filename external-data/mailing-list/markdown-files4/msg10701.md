---
title: "Re: Exploring Riak, need to confirm throughput"
description: ""
project: community
lastmod: 2013-04-04T14:47:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10701"
mailinglist_parent_id: "msg10697"
author_name: "Reid Draper"
project_section: "mailinglistitem"
sent_date: 2013-04-04T14:47:08-07:00
---



On Apr 4, 2013, at 4:14 PM, Matthew MacClary 
 wrote:

&gt; Thanks for the feedback. I made two changes to my test setup and saw better 
&gt; throughput:
&gt; 
&gt; 1) Don't write to the same key over and over. Updating a key appears to be a 
&gt; lot slower than creating a new key
&gt; 
&gt; 2) I used parallel PUTs
&gt; 
&gt; The throughput I was measuring before was about 26MB/s on localhost. With 
&gt; these changes it went to around 200MB/s on a disk that can write at about 
&gt; 480MB/s. That is more the type of performance I need for the data store we 
&gt; have in mind. I am going to proceed with testing on 8 nodes with RAID0 drives.

How are you measuring throughput? HTTP throughput, or disk throughput with 
something like iostat?

&gt; 
&gt; Here are some details of the testing I did if it will help others. I tried 
&gt; the test with 1MB, 10MB, and 20MB binary data. I didn't notice a big signal 
&gt; with regard to larger objects slowing things down.

The issues with larger objects will likely only present themselves when you 
have more than one node.

&gt; 
&gt; wget 
&gt; http://downloads.basho.com.s3-website-us-east-1.amazonaws.com/riak/1.2/1.2.1/rhel/5/riak-1.2.1-1.el5.x86\_64.rpm
&gt; 
&gt; sudo rpm -Uvh riak-1.2.1-1.el5.x86\_64.rpm
&gt; /usr/sbin/riak start
&gt; mkdir data-dir && cd data-dir
&gt; seq -w 0 100 | parallel dd if=/dev/zero of={}.10meg bs=8k count=1280
&gt; http\_proxy= # donâ€™t contact proxy
&gt; time find . -name \\*.10meg | parallel -j8 -n1 wget --post-file {} 
&gt; http://127.0.0.1:8098/riak/test1/{}
&gt; 
&gt; During these tests I saw beam.smp jumping to 350-550 while watching %CPU 
&gt; under top. When I was seeing slower thoughput beam.smp was using much less 
&gt; CPU.
&gt; 
&gt; Kind regards,
&gt; 
&gt; -Matt
&gt; 
&gt; On Wed, Apr 3, 2013 at 7:20 AM, Reid Draper  wrote:
&gt; inline:
&gt; 
&gt; 
&gt; On Apr 2, 2013, at 6:48 PM, Matthew MacClary 
&gt;  wrote:
&gt; 
&gt;&gt; Hi all, I am new to this list. Thanks for taking the time to read my 
&gt;&gt; questions! I just want to know if the data throughput I am seeing is 
&gt;&gt; expected for the bitcask backend or if it is too low.
&gt;&gt; 
&gt;&gt; I am doing the preliminary feasibility study to decide if we should 
&gt;&gt; implement a Riak data store. Our application involves rendering chunks of 
&gt;&gt; data that range in size from about 1MB-9MB or so. This rendering work is CPU 
&gt;&gt; intensive so it is spread over a bunch of compute nodes which write the 
&gt;&gt; output into a data store.
&gt; 
&gt; Riak is not intended to store objects of this size, not at the moment anyway. 
&gt; Riak CS [1], on the other hand, can store files up to several TB. That being 
&gt; said, Riak CS may or may not have other qualities you desire. It's a known 
&gt; issue [2] that the Riak object size limitations should be better documented.
&gt; 
&gt;&gt; 
&gt;&gt; After rendering, a second process consumes that data chunks from the data 
&gt;&gt; store at a rate of about 480MB/s in a streaming configuration so there is &gt; 
&gt;&gt; 480MB/s of new data coming in at the same time the data is being read.
&gt; 
&gt; Is this a single-socket, or is there some concurrency here?
&gt; 
&gt;&gt; 
&gt;&gt; My testing so far involves a one node cluster on a dev box. What I wanted to 
&gt;&gt; show is that Riak writes were limited by the hard disk throughput. So far I 
&gt;&gt; haven't seen writes to localhost come anywhere close to the hard disk 
&gt;&gt; throughput:
&gt;&gt; 
&gt;&gt; $ MYFILE=/tmp/output.png
&gt;&gt; $ dd if=/dev/zero of=$MYFILE bs=8k count=256k
&gt;&gt; 262144+0 records in
&gt;&gt; 262144+0 records out
&gt;&gt; 2147483648 bytes (2.1 GB) copied, 4.48906 seconds, 478 MB/s
&gt;&gt; $ rm $MYFILE
&gt;&gt; 
&gt;&gt; So the hard disk throughput is around 478MB/s for this simple write test.
&gt;&gt; 
&gt;&gt; The next test I did was to load a 39MB binary file into my one node cluster. 
&gt;&gt; I used a script to do 12 POSTs with curl and 12 POSTSs with wget. 
&gt;&gt; 
&gt;&gt; curl --tcp-nodelay -XPOST http://${IP}:${PORT}/riak/test/file3 \
&gt;&gt; -H "Content-Type:application/octet-stream" \
&gt;&gt; --data-binary @${UPLOAD\_FILE} \
&gt;&gt; --write-out "%{speed\_upload}\n"
&gt;&gt; 
&gt;&gt; wget --post-file ${UPLOAD\_FILE} http://127.0.0.1:8098/riak/test/file1
&gt;&gt; 
&gt;&gt; What I found was that I could get only about 26MB/s with this command line 
&gt;&gt; testing. Does this seam about right? Should I see an 18x slow down over the 
&gt;&gt; write speed of the disk drive?
&gt; 
&gt; Was this running the 24 (12 \* 2) uploads in serial or parallel? With a 
&gt; single-threaded workload, you're unlikely to get Riak to be able to saturate 
&gt; a disk. Furthermore, there are design decisions in Riak at the moment that 
&gt; make it less than optimal for single objects of 39MB. Single-object high 
&gt; throughput (measured in MB) is more in the wheelhouse of Riak CS than Riak on 
&gt; it's own, which is primarily designed for low-latency and high-throughput 
&gt; (measured in ops/sec). One of the ways that Riak CS achieves this on top of 
&gt; Riak is by introducing concurrency between the end-user and Riak.
&gt; 
&gt;&gt; 
&gt;&gt; Thanks for your comments on my application and test approach!
&gt; 
&gt; Hope this helps,
&gt; Reid
&gt; 
&gt; [1] http://docs.basho.com/riakcs/latest/
&gt; [2] https://github.com/basho/basho\_docs/issues/256
&gt; 
&gt; 
&gt;&gt; 
&gt;&gt; -Matt
&gt;&gt; 
&gt;&gt; -----------------------------------------------
&gt;&gt; Dev Environment Details:
&gt;&gt; dev box running RHEL6.2, 12 cores, 48GB, 6Gb/s SAS 15k HD
&gt;&gt; Riak 1.2.1 from 
&gt;&gt; http://downloads.basho.com.s3-website-us-east-1.amazonaws.com/riak/1.2/1.2.1/rhel/5/riak-1.2.1-1.el5.x86\_64.rpm
&gt;&gt; n\_val=1
&gt;&gt; r=1
&gt;&gt; w=1
&gt;&gt; backend=bitcask
&gt;&gt; 
&gt;&gt; Deploy Environment Details:
&gt;&gt; Node to node bandwidth &gt; 40Gb/s
&gt;&gt; similar config for node servers
&gt;&gt; n\_val=3
&gt;&gt; r=1
&gt;&gt; w=1
&gt;&gt; backend=?
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

