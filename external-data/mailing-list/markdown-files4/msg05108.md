---
title: "Re: Timeout when storing"
description: ""
project: community
lastmod: 2011-10-09T15:55:14-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05108"
mailinglist_parent_id: "msg04922"
author_name: "Jim Adler"
project_section: "mailinglistitem"
sent_date: 2011-10-09T15:55:14-07:00
---


Thanks David - I'll try that on my single-node instance, but I'm working 
another Riak issue on another thread. 


Jim 

----- Original Message -----
From: "David Smith"  
To: "jim adler"  
Sent: Friday, October 7, 2011 7:02:01 AM 
Subject: Re: Timeout when storing 

Hi Jim, 

Sorry for the slow response -- email is like a running battle at times. :) 

How many partitions are you running? 

Also, take down the node and then remove any \*.lock files. 

Thanks, 

D. 

On Mon, Oct 3, 2011 at 11:23 AM,  wrote: 
&gt; About 90 out of 3000 are zero-bytes. 
&gt; 
&gt; Jim 
&gt; 
&gt; -----Original Message----- 
&gt; From: riak-users-boun...@lists.basho.com 
&gt; [mailto:riak-users-boun...@lists.basho.com] On Behalf Of David Smith 
&gt; Sent: Monday, October 03, 2011 4:46 AM 
&gt; To: Jim Adler 
&gt; Cc: riak-users@lists.basho.com 
&gt; Subject: Re: Timeout when storing 
&gt; 
&gt; Jim, 
&gt; 
&gt; If you look at your bitcask directories, do you have a large number of 
&gt; zero-byte files, perchance? 
&gt; 
&gt; D. 
&gt; 
&gt; On Sat, Oct 1, 2011 at 1:58 PM, Jim Adler  wrote: 
&gt;&gt; After upgrading my single-node instance to 1.0, I'm still seeing the 
&gt;&gt; "timeout when storing" issue. Here are the changes I made based on 
&gt;&gt; everyone's suggestions (much appreciated!): 
&gt;&gt; 
&gt;&gt; - Ubuntu 11.04 (natty) 32-bit 
&gt;&gt; - Python client 1.3.0 
&gt;&gt; - /etc/riak/vm.args: -env ERL\_MAX\_PORTS 32768 
&gt;&gt; - /etc/default/riak: ulimit -n 32768 
&gt;&gt; 
&gt;&gt; Here's the /var/log/crash.log report: 
&gt;&gt; 
&gt;&gt; 2011-10-01 12:31:03 =ERROR REPORT==== 
&gt;&gt; \*\* State machine &lt;0.3452.0&gt; terminating 
&gt;&gt; \*\* Last event in was 
&gt;&gt; {'riak\_vnode\_req\_v1',1136089163393944065322395631681798128560666312704 
&gt;&gt; ,{fsm,undefined,&lt;0.3451.0&gt;},{'riak\_kv\_put\_req\_v1',{&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"user 
&gt;&gt; \_id-17527747-info"&gt;&gt;},{r\_object,&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"user\_id-17527747-info"&gt; 
&gt;&gt; &gt;,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[], 
&gt;&gt; [],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;"content-type"&gt;&gt;,9 
&gt;&gt; 7,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;"X-Riak 
&gt;&gt; -VTag"&gt;&gt;,49,88,88,75,75,51,90,88,68,117,90,122,85,53,57,85,53,101,107, 
&gt;&gt; 89,115,110]],[[&lt;&lt;"index"&gt;&gt;]],[],[[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1317,497 
&gt;&gt; 463,847242}]],[],[]}}},&lt;&lt;"{DATA 
&gt;&gt; DELETED}"&gt;&gt;}],[],{dict,1,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[], 
&gt;&gt; [],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[[clean 
&gt;&gt; |true]],[]}}},undefined},51456853,63484716663,[coord]}} 
&gt;&gt; 
&gt;&gt; \*\* When State == active 
&gt;&gt; \*\* Data == 
&gt;&gt; {state,1136089163393944065322395631681798128560666312704,riak\_kv\_vnode 
&gt;&gt; ,{state,1136089163393944065322395631681798128560666312704,false,riak\_k 
&gt;&gt; v\_bitcask\_backend,{state,#Ref&lt;0.0.0.10359&gt;,"11360891633939440653223956 
&gt;&gt; 31681798128560666312704",[{async\_folds,true},[{vnode\_vclocks,true},{in 
&gt;&gt; cluded\_applications,[]},{add\_paths,[]},{allow\_strfun,false},{storage\_b 
&gt;&gt; ackend,riak\_kv\_bitcask\_backend},{legacy\_keylisting,false},{reduce\_js\_v 
&gt;&gt; m\_count,6},{js\_thread\_stack,16},{pb\_ip,"0.0.0.0"},{riak\_kv\_stat,true}, 
&gt;&gt; {map\_js\_vm\_count,8},{mapred\_system,pipe},{js\_max\_vm\_mem,8},{pb\_port,80 
&gt;&gt; 87},{legacy\_stats,true},{mapred\_name,"mapred"},{stats\_urlpath,"stats"} 
&gt;&gt; ,{http\_url\_encoding,on},{hook\_js\_vm\_count,2}],{read\_write,true}],11360 
&gt;&gt; 89163393944065322395631681798128560666312704,"/var/lib/riak/bitcask"}, 
&gt;&gt; {dict,0,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[] 
&gt;&gt; },{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},&lt;&lt;35,9,254,249, 
&gt;&gt; 78,135,82,106&gt;&gt;,3000,1000,100,100,true,false},undefined,undefined,none 
&gt;&gt; ,undefined,&lt;0.3454.0&gt;,60000} 
&gt;&gt; \*\* Reason for termination = 
&gt;&gt; \*\* {bad\_return\_value,{error,{write\_locked,emfile}}} 
&gt;&gt; 2011-10-01 12:31:03 =CRASH REPORT==== 
&gt;&gt; crasher: 
&gt;&gt; initial call: riak\_core\_vnode:init/1 
&gt;&gt; pid: &lt;0.3452.0&gt; 
&gt;&gt; registered\_name: [] 
&gt;&gt; exception exit: {bad\_return\_value,{error,{write\_locked,emfile}}} 
&gt;&gt; in function gen\_fsm:terminate/7 
&gt;&gt; in call from proc\_lib:init\_p\_do\_apply/3 
&gt;&gt; ancestors: [riak\_core\_vnode\_sup,riak\_core\_sup,&lt;0.92.0&gt;] 
&gt;&gt; messages: [{'EXIT',&lt;0.3454.0&gt;,shutdown}] 
&gt;&gt; links: [&lt;0.96.0&gt;] 
&gt;&gt; dictionary: [] 
&gt;&gt; trap\_exit: true 
&gt;&gt; status: running 
&gt;&gt; heap\_size: 6765 
&gt;&gt; stack\_size: 24 
&gt;&gt; reductions: 160650 
&gt;&gt; neighbours: 
&gt;&gt; 2011-10-01 12:31:03 =SUPERVISOR REPORT==== 
&gt;&gt; Supervisor: {local,riak\_core\_vnode\_sup} 
&gt;&gt; Context: child\_terminated 
&gt;&gt; Reason: {bad\_return\_value,{error,{write\_locked,emfile}}} 
&gt;&gt; Offender: 
&gt;&gt; [{pid,&lt;0.3452.0&gt;},{name,undefined},{mfargs,{riak\_core\_vnode,start\_link 
&gt;&gt; ,undefined}},{restart\_type,temporary},{shutdown,300000},{child\_type,wo 
&gt;&gt; rker}] 
&gt;&gt; 
&gt;&gt; 2011-10-01 12:45:28 =ERROR REPORT==== 
&gt;&gt; Failed to merge 
&gt;&gt; 
&gt; "/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/var/ 
&gt; lib/riak/bitcask/605153021707326989568713251046585937826284568576/1315770213 
&gt; .bitcask.data/var/lib/riak/bitcask/60515302170732698956871325104658593782628 
&gt; 4568576/1316329673.bitcask.data/var/lib/riak/bitcask/60515302170732698956871 
&gt; 3251046585937826284568576/1316330222.bitcask.data/var/lib/riak/bitcask/60515 
&gt; 3021707326989568713251046585937826284568576/1316879145.bitcask.data/var/lib/ 
&gt; riak/bitcask/605153021707326989568713251046585937826284568576/1316995340.bit 
&gt; cask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568 
&gt; 576/1317493005.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251 
&gt; 046585937826284568576/1317495168.bitcask.data": 
&gt;&gt; {{badmatch,{error,emfile}},[{bitcask,'-merge1/3-lc$^0/1-1-',1},{bitcas 
&gt;&gt; k,'-merge1/3-lc$^0/1-1-',1},{bitcask,'merge1',3},{bitcask\_merge\_worker 
&gt;&gt; ,do\_merge,1}]} 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -----Original Message----- 
&gt;&gt; From: David Smith [mailto:diz...@basho.com] 
&gt;&gt; Sent: Fri 9/30/2011 9:56 AM 
&gt;&gt; To: Jim Adler 
&gt;&gt; Cc: Sean Cribbs; riak-users@lists.basho.com 
&gt;&gt; Subject: Re: Timeout when storing 
&gt;&gt; 
&gt;&gt; IIRC, {error, emfile} indicates that the max # of ports (in the erlang 
&gt;&gt; VM) is being exceeded. Try bumping up ERL\_MAX\_PORTS in vm.args. 
&gt;&gt; 
&gt;&gt; D. 
&gt;&gt; 
&gt;&gt; On Thu, Sep 29, 2011 at 10:52 PM, Jim Adler  wrote: 
&gt;&gt;&gt; Thanks Sean. I added the ulimit -n 10240 to /etc/default/riak, 
&gt;&gt;&gt; restarted riak, but that didn't work. 
&gt;&gt;&gt; 
&gt;&gt;&gt; Fyodor Yarochkin suggested that the bitcask files could be corrupted, 
&gt;&gt;&gt; but I wasn't sure which bitcask \*.data or \*.hint file to delete. Any 
&gt;&gt;&gt; pointers? 
&gt;&gt;&gt; 
&gt;&gt;&gt; Here's the /var/log/riak/erlang.log: 
&gt;&gt;&gt; 
&gt;&gt;&gt; =ERROR REPORT==== 29-Sep-2011::20:27:42 === 
&gt;&gt;&gt; \*\* State machine &lt;0.369.0&gt; terminating 
&gt;&gt;&gt; \*\* Last event in was {riak\_vnode\_req\_v1, 
&gt;&gt;&gt; 
&gt;&gt;&gt; 941983477185933521498468739836666790012612771840, 
&gt;&gt;&gt; {fsm,undefined,&lt;0.27704.1&gt;}, 
&gt;&gt;&gt; {riak\_kv\_put\_req\_v1, 
&gt;&gt;&gt; {&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"screen\_name-psych\_ic-info"&gt;&gt;}, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {r\_object,&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"screen\_name-psych\_ic-info"&gt;&gt;, 
&gt;&gt;&gt; [{r\_content, 
&gt;&gt;&gt; {dict,3,16,16,8,80,48, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}, 
&gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[], 
&gt;&gt;&gt; 
&gt;&gt;&gt; [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97, 
&gt;&gt;&gt; 116,105,111,110,47,106,115,111,110], 
&gt;&gt;&gt; 
&gt;&gt;&gt; [&lt;&lt;"X-Riak-VTag"&gt;&gt;,49,90,120,65,84,100,56,99,48, 
&gt;&gt;&gt; 
&gt;&gt;&gt; 80,86,99,111,122,71,79,108,90,70,97,53,87]], 
&gt;&gt;&gt; [],[], 
&gt;&gt;&gt; [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;| 
&gt;&gt;&gt; {1317,353201,695471}]], 
&gt;&gt;&gt; [],[]}}}, 
&gt;&gt;&gt; &lt;&lt;"{DELETED DATA}"&gt;&gt;}], 
&gt;&gt;&gt; [{&lt;&lt;2,65,205,48&gt;&gt;,{1,63484572401}}], 
&gt;&gt;&gt; {dict,1,16,16,8,80,48, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}, 
&gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],[], 
&gt;&gt;&gt; [[clean|true]], 
&gt;&gt;&gt; []}}}, 
&gt;&gt;&gt; undefined}, 
&gt;&gt;&gt; 1174401,63484572401, 
&gt;&gt;&gt; [{returnbody,true}]}} 
&gt;&gt;&gt; \*\* When State == active 
&gt;&gt;&gt; \*\* Data == 
&gt;&gt;&gt; {state,941983477185933521498468739836666790012612771840, 
&gt;&gt;&gt; riak\_kv\_vnode, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {state,941983477185933521498468739836666790012612771840, 
&gt;&gt;&gt; riak\_kv\_bitcask\_backend, 
&gt;&gt;&gt; {#Ref&lt;0.0.0.3952&gt;, 
&gt;&gt;&gt; 
&gt;&gt;&gt; "/var/lib/riak/bitcask/9419834771859335214984687398366667900126127718 
&gt;&gt;&gt; 40"}, 
&gt;&gt;&gt; {dict,0,16,16,8,80,48, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[], 
&gt;&gt;&gt; [],[],[]}, 
&gt;&gt;&gt; 
&gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[], 
&gt;&gt;&gt; [],[],[]}}}, 
&gt;&gt;&gt; false}, 
&gt;&gt;&gt; undefined,none,60000} 
&gt;&gt;&gt; \*\* Reason for termination = 
&gt;&gt;&gt; \*\* {{badmatch,{error,emfile}}, 
&gt;&gt;&gt; [{bitcask\_fileops,create\_file\_loop,3}, 
&gt;&gt;&gt; {bitcask,put,3}, 
&gt;&gt;&gt; {riak\_kv\_bitcask\_backend,put,3}, 
&gt;&gt;&gt; {riak\_kv\_vnode,perform\_put,3}, 
&gt;&gt;&gt; {riak\_kv\_vnode,do\_put,7}, 
&gt;&gt;&gt; {riak\_kv\_vnode,handle\_command,3}, 
&gt;&gt;&gt; {riak\_core\_vnode,vnode\_command,3}, 
&gt;&gt;&gt; {gen\_fsm,handle\_msg,7}]} 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; -----Original Message----- 
&gt;&gt;&gt; From: Sean Cribbs [mailto:s...@basho.com] 
&gt;&gt;&gt; Sent: Thu 9/29/2011 3:02 PM 
&gt;&gt;&gt; To: Jim Adler 
&gt;&gt;&gt; Cc: riak-users@lists.basho.com 
&gt;&gt;&gt; Subject: Re: Timeout when storing 
&gt;&gt;&gt; 
&gt;&gt;&gt; Your environment has too few file handles. Retry starting riak after 
&gt;&gt;&gt; setting `ulimit -n 1024` in the shell. Also see our wiki page about 
&gt;&gt;&gt; this 
&gt;&gt;&gt; issue: http://wiki.basho.com/Open-Files-Limit.html You may need to 
&gt;&gt;&gt; set this limit specifically for the 'riak' user. 
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers, 
&gt;&gt;&gt; 
&gt;&gt;&gt; -- 
&gt;&gt;&gt; Sean Cribbs  
&gt;&gt;&gt; Developer Advocate 
&gt;&gt;&gt; Basho Technologies, Inc. 
&gt;&gt;&gt; http://www.basho.com/ 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ 
&gt;&gt;&gt; riak-users mailing list 
&gt;&gt;&gt; riak-users@lists.basho.com 
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Dave Smith 
&gt;&gt; Director, Engineering 
&gt;&gt; Basho Technologies, Inc. 
&gt;&gt; diz...@basho.com 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Dave Smith 
&gt; Director, Engineering 
&gt; Basho Technologies, Inc. 
&gt; diz...@basho.com 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ 
&gt; riak-users mailing list 
&gt; riak-users@lists.basho.com 
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com 
&gt; 
&gt; 



-- 
Dave Smith 
Director, Engineering 
Basho Technologies, Inc. 
diz...@basho.com 
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

