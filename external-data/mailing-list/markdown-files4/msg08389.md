---
title: "Re: riak-erlang-client issue with Riak EE 1.2"
description: ""
project: community
lastmod: 2012-08-28T22:33:46-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08389"
mailinglist_parent_id: "msg08387"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2012-08-28T22:33:46-07:00
---


Julian,

I might also add that those header files (like riak\_search\_pb.hrl) are
not checked in because they are generated when the .proto files are
compiled. It should be sufficient to add riakc as your rebar
dependency.

In the meantime we'll get those docs updated on Github pages.

On Tue, Aug 28, 2012 at 10:26 PM, Dave Parfitt  wrote:
&gt; Hello Julian -
&gt;
&gt; Map-reduce is still available, it's just not what riakc\_pb\_socket:search/\* 
&gt; uses under the hood anymore. Both map/reduce and Riak search functionality 
&gt; are implemented in the client using Protocol Buffers now.
&gt;
&gt; The Map/Reduce functions are available here:
&gt; https://github.com/basho/riak-erlang-client/blob/master/src/riakc\_pb\_socket.erl#L454
&gt;
&gt; and the Search functions are available here:
&gt; https://github.com/basho/riak-erlang-client/blob/master/src/riakc\_pb\_socket.erl#L618
&gt;
&gt; Cheers -
&gt; Dave
&gt;
&gt; On Aug 28, 2012, at 3:06 PM, Julian wrote:
&gt;
&gt;&gt; Hi Dave,
&gt;&gt;
&gt;&gt; I don't see documentation up on basho.github.com for client 1.3.0, and
&gt;&gt; I don't see some of those include files referenced from riak\_pb (ex
&gt;&gt; riak\_search\_pb.hrl) in your repo, so I'll assume those are meant to be
&gt;&gt; internal. But how am I supposed to know how to migrate to the new
&gt;&gt; parameters? I was using mapreduce in the prior version to return
&gt;&gt; portions of the stored objects rather than the bucket/key. I was using
&gt;&gt; this anonymous js function:
&gt;&gt;
&gt;&gt; function(v, keyData, arg) {
&gt;&gt; var o = JSON.parse(v.values[0].data);
&gt;&gt; var p = {id:o.id, account\_id:o.account\_id,
&gt;&gt; account\_type\_id:o.account\_type\_id, deleted:o.deleted, status:o.status,
&gt;&gt; hidden:o.hidden, currency:o.currency};
&gt;&gt; return [JSON.stringify(p)]
&gt;&gt; }
&gt;&gt;
&gt;&gt; On Fri, Aug 17, 2012 at 6:22 AM, Dave Parfitt  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hello Julian -
&gt;&gt;&gt;
&gt;&gt;&gt; A new version of the riak-erlang-client [1] was recently released that 
&gt;&gt;&gt; changes riakc\_pb\_socket:search/\* to use protobuffs instead of map/reduce. 
&gt;&gt;&gt; Give that a shot first and let us know if it works for you.
&gt;&gt;&gt;
&gt;&gt;&gt; Cheers -
&gt;&gt;&gt; Dave
&gt;&gt;&gt;
&gt;&gt;&gt; [1] https://github.com/basho/riak-erlang-client/
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Aug 16, 2012, at 6:51 PM, Julian wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; Recently, we upgraded our Riak cluster to 1.2. I hear that one of our 
&gt;&gt;&gt; buckets has been wiped and reloaded, but our index (Riak search is enabled) 
&gt;&gt;&gt; may not be in a consistent state. This has led to an error in code using 
&gt;&gt;&gt; riak-erlang-client 1.2, shown below.
&gt;&gt;&gt;
&gt;&gt;&gt; One of the intriguing things I find is that the exception is listed as 
&gt;&gt;&gt; occuring in one of my own processes that is doing json decoding, however I 
&gt;&gt;&gt; have checked the json by saving it to a file and it does not contain the 
&gt;&gt;&gt; data shown inside the 'struct' in the exception. The only explanation I can 
&gt;&gt;&gt; come up with is that the badmatch is occurring within riakc\_pb socket and 
&gt;&gt;&gt; was triggered by my call to riakc\_pb\_socket:search/6, and the process link 
&gt;&gt;&gt; is somehow influencing the crash report.
&gt;&gt;&gt;
&gt;&gt;&gt; 1. Is there a newer version of riak-erlang-client that might fix the issue? 
&gt;&gt;&gt; I noticed that though labeled v1.2, it came out in April; has there been a 
&gt;&gt;&gt; client code update for EE 1.2?
&gt;&gt;&gt; 2. Would it help make my code more robust if I tried to filter out these 
&gt;&gt;&gt; not\_found's so it wouldn't reach the client? As in 
&gt;&gt;&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2012-January/007075.html
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; (module names edited slightly)
&gt;&gt;&gt;
&gt;&gt;&gt; =CRASH REPORT==== 16-Aug-2012::21:44:52 ===
&gt;&gt;&gt; crasher:
&gt;&gt;&gt; initial call: xx\_acl\_query:init/1
&gt;&gt;&gt; pid: &lt;0.159.0&gt;
&gt;&gt;&gt; registered\_name: []
&gt;&gt;&gt; exception exit: {{badmatch,
&gt;&gt;&gt; {not\_found,
&gt;&gt;&gt; {&lt;&lt;"a65796222ea26bb7b355bf140dbd5b72e81efee1"&gt;&gt;,
&gt;&gt;&gt; &lt;&lt;"000018e5-accf-fff1-8123-1efee1"&gt;&gt;},
&gt;&gt;&gt; {struct,
&gt;&gt;&gt; [{p,[0]},
&gt;&gt;&gt; {&lt;&lt;"account\_id"&gt;&gt;,[&lt;&lt;"0000005427"&gt;&gt;]},
&gt;&gt;&gt; {&lt;&lt;"account\_type\_id"&gt;&gt;,[&lt;&lt;"3"&gt;&gt;]},
&gt;&gt;&gt; {&lt;&lt;"id"&gt;&gt;,[&lt;&lt;"6373"&gt;&gt;]},
&gt;&gt;&gt; {&lt;&lt;"status"&gt;&gt;,[&lt;&lt;"Deleted"&gt;&gt;]},
&gt;&gt;&gt; {&lt;&lt;"type"&gt;&gt;,[&lt;&lt;"account"&gt;&gt;]},
&gt;&gt;&gt; {score,[1.0]}]}}},
&gt;&gt;&gt; [{mochijson2,tokenize,2},
&gt;&gt;&gt; {mochijson2,decode1,2},
&gt;&gt;&gt; {mochijson2,json\_decode,2},
&gt;&gt;&gt; {lists,map,2},
&gt;&gt;&gt; {lists,map,2},
&gt;&gt;&gt; {xx\_acl\_tree,from\_json,2},
&gt;&gt;&gt; {xx\_acl\_query,load\_instance\_,2},
&gt;&gt;&gt; {xx\_acl\_query,bootstrap\_accounts,1}]}
&gt;&gt;&gt; in function gen\_server:init\_it/6
&gt;&gt;&gt; ancestors: [xx\_cache\_sup,xx\_acl\_sup,&lt;0.108.0&gt;]
&gt;&gt;&gt; messages: []
&gt;&gt;&gt; links: [&lt;0.132.0&gt;]
&gt;&gt;&gt; dictionary: []
&gt;&gt;&gt; trap\_exit: true
&gt;&gt;&gt; status: running
&gt;&gt;&gt; heap\_size: 832040
&gt;&gt;&gt; stack\_size: 24
&gt;&gt;&gt; reductions: 30690459
&gt;&gt;&gt; neighbours:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Cheers,
&gt;&gt;&gt; Julian Pellico
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



-- 
Sean Cribbs 
Software Engineer
Basho Technologies, Inc.
http://basho.com/

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

