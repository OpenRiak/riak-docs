---
title: "Re: simpler implementation of RiakMap"
description: ""
project: community
lastmod: 2015-11-16T21:16:43-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16776"
mailinglist_parent_id: "msg16768"
author_name: "Alex Moore"
project_section: "mailinglistitem"
sent_date: 2015-11-16T21:16:43-08:00
---


Hey David,

So with the CRDT Map implementation, you can have a register, a counter, an
inner map, a set, and a flag embedded within a map, all with the same name
(oh my!).

In the underlying API the map entry identifier is actually made of both the
name and the type, so you can pull off that bit of trickery. You can see
this bleed through a little bit in the HTTP JSON API, where map field id's
are represented as \_ :

curl -XPOST 
http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed\_info
\ -H "Content-Type: application/json" \ -d ' { "update": {
"annika\_info\_map": { "update": { "first\_name\_register": "Annika",
"last\_name\_register": "Weiss", "phone\_number\_register": "5559876543" } } }
} '

Also since the API's been out for awhile now, doing the changes you listed
could break compatibility with other clients / users :-/

I'll take a look at getRegister and friends, and see if there's a better
way to implement them though.

Thanks,
Alex

On Fri, Nov 13, 2015 at 7:49 PM, David Byron  wrote:

&gt; As I stare at the code for RiakMap in the riak-java-client (
&gt; https://github.com/basho/riak-java-client/blob/develop/src/main/java/com/basho/riak/client/core/query/crdt/types/RiakMap.java),
&gt; I have the urge for a simpler implementation.
&gt;
&gt; If I'm reading the code right, it looks like it handles a value of each
&gt; RiakDatatype for each key. As in, it's possible for the same key in a map
&gt; to have all of a counter, map, flag, register and set value.
&gt;
&gt; If it turns out that the underlying data has only one of those, or perhaps
&gt; that I only care about one of those, it feels like
&gt;
&gt; private final Map&gt; entries =
&gt; new HashMap&gt;();
&gt;
&gt; could become
&gt;
&gt; private final Map entries =
&gt; new HashMap();
&gt;
&gt; What I'm getting at is that the code I'm writing to iterate over the
&gt; elements in a map is doing way more than I'd like. For a map whose values
&gt; are all registers, I've got something like:
&gt;
&gt; RiakMap myMap;
&gt; for (BinaryValue key : myMap.view().keySet()) {
&gt; RiakRegister register = myMap.getRegister(key);
&gt; }
&gt;
&gt; which looks clean enough, but is busy under the covers. I'm really
&gt; whining about the implementation of getRegister and friends:
&gt;
&gt; public RiakRegister getRegister(BinaryValue key)
&gt; {
&gt; if (entries.containsKey(key)) {
&gt; for (RiakDatatype dt : entries.get(key)) {
&gt; if (dt.isRegister()) {
&gt; return dt.getAsRegister();
&gt; }
&gt; }
&gt; }
&gt; return null;
&gt; }
&gt;
&gt; Because I'm iterating I already know the key is one of the entries, so
&gt; would you consider a patch with an unsafe\* (or any other name) set of
&gt; accessors that assumes the key is present? I could of course call view and
&gt; implement my own method, but I can't see how to take out the loop without
&gt; changing the underlying data structure for entries.
&gt;
&gt; If I'm iterating over lots and lots of keys (i.e. myMap.view().keySet()
&gt; contains lots and lots of elements), it might actually be enough savings to
&gt; notice. In addition though, I think it's simpler enough to be helpful when
&gt; trying to read/understand the code.
&gt;
&gt; It is of course possible that the underlying data isn't what I expect, and
&gt; contains other data types too. So a full implementation might need hints
&gt; from the caller about whether to use the more general/existing data
&gt; structure, or the simplified one...and then whether to fail in the face of
&gt; data that doesn't fit in the simplified one, or silently ignore it...or
&gt; ignore it but notify the caller that it's present...and probably other
&gt; stuff I haven't considered yet.
&gt;
&gt; I'd love to hear what you think about all of this.
&gt;
&gt; Thanks much for your help.
&gt;
&gt; -DB
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

