---
title: "Re: riakc_pb_socket client & poolboy"
description: ""
project: community
lastmod: 2012-09-24T02:20:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08660"
mailinglist_parent_id: "msg08659"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2012-09-24T02:20:41-07:00
---


My main concern about poolboy is the fact that it wraps another gen\_server
process around the actual worker process. This makes you send an extra
message every time you query the database, which is quite an overhead when
you have a lot of concurrent users. Since you guys are fighting for
performance, that could be an issue for you.

At Mochi, we have a client of our own, which is somewhat close to gen\_pool
behaviour I implemented and open-sourced. This client incomplete in many
ways, and uses parametrized modules, which a lot of people tend to dislike,
but it is very fast, stable and production-proven.

Nevertheless, I would really like to hear about Basho's opinion on poolboy
too. Not only they included it into Riak distribution, but they also spent
a handful of effort to test it through and fix a number of quite serious
errors.

On Mon, Sep 24, 2012 at 12:56 PM, Yuri Lukyanov  wrote:

&gt; Hi Dmitry, ;)
&gt;
&gt; Yes, thank you. I'm also thinking about this approach. I just wanted
&gt; to know how people use poolboy for that (It seems they do).
&gt; But even considering your case, imagine that you have quite a big
&gt; cluster and quite a big amount of rps.
&gt; In this case you may want to have more than one load balancer to
&gt; spread the load and be more tolerant to LB failures.
&gt; Exactly the same situation arises.
&gt; It's not a problem to implement a pooler in this case on my own. I'm
&gt; just asking about using poolboy for that.
&gt;
&gt; On Mon, Sep 24, 2012 at 12:08 PM, Dmitry Demeshchuk
&gt;  wrote:
&gt; &gt; Why not use load balancer on top of Riak cluster, independently from
&gt; &gt; clients? If load balancing is sophisticated enough, it can even do a
&gt; greater
&gt; &gt; job than just uniformly spreading requests between machines.
&gt; &gt;
&gt; &gt; Consider the following situation. You happen to send several requests
&gt; for a
&gt; &gt; huge piece of data (each can be just a simple get, or even a complicated
&gt; &gt; map-reduce query), but the rest of the nodes, or just some of them,
&gt; receive
&gt; &gt; much smaller queries.
&gt; &gt;
&gt; &gt; What an external load balancer can do is gathering some basic stats from
&gt; &gt; each machine (like load average, memory and IO consumption, number of
&gt; rps to
&gt; &gt; Riak and so on) and balancing the requests according to this data.
&gt; Another
&gt; &gt; benefit from this approach is that you can easily add any other Riak
&gt; client
&gt; &gt; (Python, Ruby, whatever else) on top of it, and load will be still nicely
&gt; &gt; distributed between the machines.
&gt; &gt;
&gt; &gt; On Mon, Sep 24, 2012 at 11:38 AM, Yuri Lukyanov 
&gt; wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; Hi,
&gt; &gt;&gt;
&gt; &gt;&gt; I'm trying to use poolboy to organize a pool of connections to riak
&gt; &gt;&gt; nodes with protobuf client.
&gt; &gt;&gt;
&gt; &gt;&gt; This has come from the suggestion here:
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2012-September/009346.html
&gt; &gt;&gt;
&gt; &gt;&gt; The quote:
&gt; &gt;&gt; "Using Poolboy is convenient because it comes as a dependency of
&gt; &gt;&gt; riak\_core.
&gt; &gt;&gt;
&gt; &gt;&gt; If you use Poolboy, you'll have to modify riakc\_pb\_socket slightly to
&gt; &gt;&gt; account for the way poolboy initializes connections (add a
&gt; start\_link/1),
&gt; &gt;&gt; or create a simple module to pass the initialization from poolboy to
&gt; &gt;&gt; riakc\_pb\_socket."
&gt; &gt;&gt;
&gt; &gt;&gt; What I'm pondering about is what would be a convenient way to start
&gt; &gt;&gt; riakc\_pb\_socket clients in a pool.
&gt; &gt;&gt; For example, if I have 10 riak nodes in a cluster and want to open a
&gt; &gt;&gt; single connection to each of them (using riakc\_pb\_socket), I need one
&gt; &gt;&gt; poolboy worker per one riakc\_pb\_socket instance. In this case, I need
&gt; &gt;&gt; a host/port of a single riak node for each
&gt; &gt;&gt; riakc\_pb\_socket:start\_link(). So I use WorkerArgs in
&gt; &gt;&gt; poolboy:start\_link/3 to pass a list of riak nodes. And here comes a
&gt; &gt;&gt; confusion. poolboy passes WorkerArgs to each of its workers, so each
&gt; &gt;&gt; worker gets the list of riak nodes. Now I need to somehow choose a
&gt; &gt;&gt; node, maybe like proposed here:
&gt; &gt;&gt; https://github.com/basho/riak-erlang-client/pull/45/files
&gt; &gt;&gt; But I don't think it's a good solution.
&gt; &gt;&gt;
&gt; &gt;&gt; Maybe my idea of using riakc\_pb\_socket together with poolboy is not
&gt; &gt;&gt; convenient? Maybe I should start a pool per each riak node? Maybe
&gt; &gt;&gt; poolboy is not that convenient in this case as it seems?
&gt; &gt;&gt;
&gt; &gt;&gt; Would you share your experiences and thoughts on the subject?
&gt; &gt;&gt;
&gt; &gt;&gt; Thank you.
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt; Best regards,
&gt; &gt; Dmitry Demeshchuk
&gt;



-- 
Best regards,
Dmitry Demeshchuk
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

