---
title: "Re: question about postcommit hooks and patch"
description: ""
project: community
lastmod: 2010-05-13T23:03:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00366"
mailinglist_parent_id: "msg00364"
author_name: "Andy Gross"
project_section: "mailinglistitem"
sent_date: 2010-05-13T23:03:01-07:00
---


Hi Bruce,

Thanks for the patch - it's definitely worthwhile and we'll likely commit it
to tip soon.

- Andy

--
Andy Gross 
VP, Engineering
Basho Technologies, Inc.


On Thu, May 13, 2010 at 6:16 PM, Bruce Lowekamp wrote:

&gt; I've been playing with using postcommit hooks in some code. I
&gt; couldn't find an example, so looking at the source, I think the right
&gt; way to set one up is something like:
&gt;
&gt; PHook = {struct, [ {&lt;&lt;"mod"&gt;&gt;, &lt;MODULE\_STRING&gt;}, {&lt;&lt;"fun"&gt;&gt;,
&gt; &lt;&lt;"notify\_change"&gt;&gt;}]},
&gt; RiakClient:set\_bucket(&lt;MY\_KEY&gt;, [{postcommit, [PHook]}]),
&gt;
&gt; Is there a better way?
&gt;
&gt;
&gt; Also, in debugging my hook, I found that wrapping the hook so I could
&gt; see exceptions made it much easier. I made the following patch that I
&gt; think might be useful to others, as well:
&gt;
&gt; diff -r e836ea266eca apps/riak\_kv/src/riak\_kv\_put\_fsm.erl
&gt; --- a/apps/riak\_kv/src/riak\_kv\_put\_fsm.erl Thu May 13 17:28:01 2010
&gt; -0400
&gt; +++ b/apps/riak\_kv/src/riak\_kv\_put\_fsm.erl Thu May 13 14:50:07 2010
&gt; -0700
&gt; @@ -314,7 +314,7 @@
&gt; invoke\_hook(precommit, Mod0, Fun0, undefined, RObj) -&gt;
&gt; Mod = binary\_to\_atom(Mod0, utf8),
&gt; Fun = binary\_to\_atom(Fun0, utf8),
&gt; - Mod:Fun(RObj);
&gt; + wrap\_hook(Mod, Fun, RObj);
&gt; invoke\_hook(precommit, undefined, undefined, JSName, RObj) -&gt;
&gt; case riak\_kv\_js\_manager:blocking\_dispatch({{jsfun, JSName}, RObj}) of
&gt; {ok, &lt;&lt;"fail"&gt;&gt;} -&gt;
&gt; @@ -331,13 +331,22 @@
&gt; invoke\_hook(postcommit, Mod0, Fun0, undefined, Obj) -&gt;
&gt; Mod = binary\_to\_atom(Mod0, utf8),
&gt; Fun = binary\_to\_atom(Fun0, utf8),
&gt; - proc\_lib:spawn(fun() -&gt; Mod:Fun(Obj) end);
&gt; + proc\_lib:spawn(fun() -&gt; wrap\_hook(Mod,Fun,Obj) end);
&gt; invoke\_hook(postcommit, undefined, undefined, \_JSName, \_Obj) -&gt;
&gt; error\_logger:warning\_msg("Javascript post-commit hooks aren't
&gt; implemented");
&gt; %% NOP to handle all other cases
&gt; invoke\_hook(\_, \_, \_, \_, RObj) -&gt;
&gt; RObj.
&gt;
&gt; +wrap\_hook(Mod, Fun, Obj)-&gt;
&gt; + try Mod:Fun(Obj)
&gt; + catch
&gt; + EType:X -&gt;
&gt; + error\_logger:error\_msg("problem invoking hook ~p:~p -&gt;
&gt; ~p:~p~n~p~n",
&gt; + [Mod, Fun, EType, X,
&gt; erlang:get\_stacktrace()]),
&gt; + fail
&gt; + end.
&gt; +
&gt; merge\_robjs(RObjs0,AllowMult) -&gt;
&gt; RObjs1 = [X || X &lt;- [riak\_kv\_util:obj\_not\_deleted(O) ||
&gt; O &lt;- RObjs0], X /= undefined],
&gt;
&gt;
&gt;
&gt; Bruce
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

