---
title: "Re: Map/Red Function Cache Corruption?"
description: ""
project: community
lastmod: 2011-07-05T00:05:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03925"
mailinglist_parent_id: "msg03919"
author_name: "Mathias Meyer"
project_section: "mailinglistitem"
sent_date: 2011-07-05T00:05:17-07:00
---


Eric,

are you by any chance still running Riak 0.14.1? There was a bug showing the 
same symptoms you're describing, which was fixed in the recent 0.14.2 release.

Mathias Meyer
Developer Advocate, Basho Technologies


On Samstag, 2. Juli 2011 at 14:40, Eric Stevens wrote:

&gt; I've been struggling with this for a few days now. I have a pair of related 
&gt; Map/Reduce queries. Executed individually they produce the expected results, 
&gt; but when executed in parallel (simultaneous XHR calls from the browser), 
&gt; their results tend to get mixed up with each other; I see values from both 
&gt; mixed together in a single result. 
&gt; 
&gt; Once that corruption happens, even the calls executed individually can end up 
&gt; with cross-pollinated results. It seems to be related to the caching of the 
&gt; anonymous javascript functions used, as adding a space to the function 
&gt; declaration clears the issue up. Taking that space back out causes the 
&gt; problem again. 
&gt; 
&gt; I can confirm that the corruption can become persistent by using a line such 
&gt; as (PHP client):
&gt; ejsLog('/tmp/mapred/reduce\_" . join('.', explode('\\', get\_class($this))) . 
&gt; ".log', JSON.stringify(values));
&gt; 
&gt; After the corruption happens, if I clear the log path, execute just the one 
&gt; map/red operation, I will see log entries appear for both classes (the class 
&gt; name being encoded as part of the function declaration). The problem seems to 
&gt; happen for both map and reduce operations, though I have not specifically 
&gt; noticed cross-contamination between map and reduce functions, just 
&gt; map-for-map and reduce-for-reduce. 
&gt; 
&gt; Adding this as the first line of the function declaration seems to solve the 
&gt; problem, but this is obviously something intended to defeat caching, so I'm 
&gt; sure there's a performance cost to this (note, just get\_class($this) is not 
&gt; sufficient, cross-contamination can still happen, each call needs to be 
&gt; unique call-to-call, thus the mt\_rand()). 
&gt; "//".get\_class($this).' '.mt\_rand()."
&gt; 
&gt; 
&gt; I noticed Francisco Treacy had this same problem back in September: 
&gt; http://riak-users.197444.n3.nabble.com/reduce-headaches-td1524860.html but I 
&gt; didn't see any resolution there. Is there a potential longer term cost to my 
&gt; cachebusting, such as memory exhaustion (i.e. is there any garbage collection 
&gt; on the function cache)? 
&gt; 
&gt; Any help would be sincerely appreciated! 
&gt; 
&gt; -Eric 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

