---
title: "Re: deleting keys"
description: ""
project: community
lastmod: 2011-06-01T06:38:03-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03515"
mailinglist_parent_id: "msg03513"
author_name: "Dingwell, Robert A."
project_section: "mailinglistitem"
sent_date: 2011-06-01T06:38:03-07:00
---




Thanks,

I was trying to use the number of keys as an indication of how many objects 
there were in a bucket but I see that is not the smartest approach. I didn't 
see anything that was an indication of the number of items in a bucket , is 
there anything if riak like this or do I need to create a map reduce job for 
this? 


This is totally off the original topic but another question I have is related 
to javascript Date objects. In ripple if I have a field that is a Time field 
it serializes to riak as a iso8601 string representation of the object. When 
performing a map reduce job on the bucket related to the ripple class I have if 
I attempt to create a javascript Date object from the string in the stored 
object I get an Invalid Date error. Is this just due to a limitation in the 
version of spider monkey being used?

Thanks

Rob

On May 31, 2011, at 8:44 PM, Sean Cribbs wrote:

&gt; Robert,
&gt; 
&gt; What Keith said is misleading -- that key cache was solely in the Ruby client 
&gt; driver and not part of Riak itself.
&gt; 
&gt; In Riak, deletes have two phases; in the first, so-called "tombstones" are 
&gt; written to the partitions that own replicas of the key. The tombstone has 
&gt; special metadata marking it as such and an empty value, but has a descendant 
&gt; vector clock from the last known value. In the second phase, the tombstones 
&gt; are read back from the replicas, and iff they all are tombstones (that is, 
&gt; all replicas respond, and all are tombstones), a reaping command is sent such 
&gt; that they will be cleared from the backend.
&gt; 
&gt; In your case, what may have occurred is that the replica chosen for 
&gt; key-listing did not receive the tombstone write (only 1/n\_val of all 
&gt; partitions are consulted for key-lists), or had not yet received the reaping 
&gt; command. When you read the key again, you obviously get a "not found" because 
&gt; the other replicas will resolve to a tombstone. Eventually your read requests 
&gt; will invoke read-repair, updating the stale partition and causing the value 
&gt; to be reaped.
&gt; 
&gt; The moral of the story here is, again, don't rely on key-listings for strong 
&gt; indications of cluster state.
&gt; 
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt; 
&gt; On May 31, 2011, at 8:12 PM, Keith Bennett wrote:
&gt; 
&gt;&gt; Robert -
&gt;&gt; 
&gt;&gt; Until a source code change a few days ago, riak would by default cache the 
&gt;&gt; keys reported to be in a bucket, so after fetching them once they would not 
&gt;&gt; be updated after deletions, additions, etc. The key is indeed gone, but the 
&gt;&gt; keys API did not report the change.
&gt;&gt; 
&gt;&gt; If you go to the message archive at 
&gt;&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-May/thread.html,
&gt;&gt; and search for "Riak cleint resources", you'll see the ruckus that I 
&gt;&gt; started a week and a half ago about this very subject. ;)
&gt;&gt; 
&gt;&gt; There is an option to force the reloading of keys but I forget what it is, 
&gt;&gt; and anyway it is now gone from the current code base since the strategy was 
&gt;&gt; changed. Be warned that using the keys method is, anyway, as Sean Cribbs 
&gt;&gt; pointed out to me, in general an awful idea, and almost always should be 
&gt;&gt; avoided. This is because it's a very expensive operation -- in order to 
&gt;&gt; accomplish it, all keys in the data store need to be accessed.
&gt;&gt; 
&gt;&gt; My guess is that testing for the exception you encountered is probably the 
&gt;&gt; best way to test for existence/absence of a key, but hopefully those more 
&gt;&gt; knowledgeable than I will enlighten us on that.
&gt;&gt; 
&gt;&gt; - Keith
&gt;&gt; 
&gt;&gt; On May 31, 2011, at 7:23 PM, Dingwell, Robert A. wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi,
&gt;&gt;&gt; 
&gt;&gt;&gt; When deleting a key from a bucket I'm noticing that the object associated 
&gt;&gt;&gt; with the key is gone but the key itself is still sticking around. I loop 
&gt;&gt;&gt; though all of the keys in a bucket and then call delete on each one, the 
&gt;&gt;&gt; object for the key is then gone so if I try to get the object for that key 
&gt;&gt;&gt; I get a 404 as expected. But if I look at the bucket in the browser with 
&gt;&gt;&gt; the keys=true parameter, all of the keys are still there. Is this normal 
&gt;&gt;&gt; and if so how do I get rid of the keys?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 



smime.p7s
Description: S/MIME cryptographic signature
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

