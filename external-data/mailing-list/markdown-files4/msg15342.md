---
title: "Re: How you are dealing with spikes?"
description: ""
project: community
lastmod: 2014-12-09T09:56:21-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15342"
mailinglist_parent_id: "msg15341"
author_name: "Bryan Hunt"
project_section: "mailinglistitem"
sent_date: 2014-12-09T09:56:21-08:00
---


Hey Alexander,
The times are missing from the leftmost graph (requests). We also don't
recommend mapreduce and 2i for user initiated requests. You would have much
more stable response times if you precalculated that stuff (just as when
using a relational database). mapreduce and 2i are coverage queries,
meaning that typically they will hit 1/3 of your nodes.

Bryan
On 9 Dec 2014 16:55, "Alexander Popov"  wrote:

&gt; Stats when recent spike happens for 15 minutes around it
&gt; get (826)
&gt; save (341)
&gt; listByIndex (1161)
&gt; mapReduce (621) //Input is IDs list
&gt; SOLR (4294)
&gt;
&gt; 6 Solr requests was longer than 9sec ( all returns 0 rows )
&gt; 4 Solr requests was longer within 4-5s ( both returns 0 rows )
&gt; 11 listByIndex requests was longer than within 4-5s ( both returns 0 rows )
&gt; all another requests was less than 300ms
&gt;
&gt;
&gt; Sometimes more load do not make such spikes
&gt; Some graphs from maintanance tasks:
&gt; 1. http://i.imgur.com/xAE6B06.png
&gt; 3 simple tasks, first 2 of them reads all keys, decide to do
&gt; nothing and continue so just read happens, third task resave all data
&gt; in bucket.
&gt; since rate is pretty good, some peaks happens
&gt;
&gt; 2. More complex task
&gt; http://i.imgur.com/7nwHb3Q.png, it have more serious computing, and
&gt; updating typed bucked( map ), but no peaks to 9s
&gt;
&gt;
&gt;
&gt; sysctl -a | fgrep vm.dirty\_:
&gt;
&gt; vm.dirty\_background\_bytes = 0
&gt; vm.dirty\_background\_ratio = 10
&gt; vm.dirty\_bytes = 0
&gt; vm.dirty\_expire\_centisecs = 3000
&gt; vm.dirty\_ratio = 20
&gt; vm.dirty\_writeback\_centisecs = 500
&gt;
&gt; On Tue, Dec 9, 2014 at 5:46 PM, Luke Bakken  wrote:
&gt; &gt; Hi Alexander,
&gt; &gt;
&gt; &gt; Can you comment on the read vs. write load of this cluster/
&gt; &gt;
&gt; &gt; Could you please run the following command and reply with the output?
&gt; &gt;
&gt; &gt; sysctl -a | fgrep vm.dirty\_
&gt; &gt;
&gt; &gt; We've seen cases where dirty pages get written in a synchronous manner
&gt; &gt; all at once, causing latency spikes due to I/O blocking.
&gt; &gt; --
&gt; &gt; Luke Bakken
&gt; &gt; Engineer / CSE
&gt; &gt; lbak...@basho.com
&gt; &gt;
&gt; &gt;
&gt; &gt; On Tue, Dec 9, 2014 at 4:58 AM, Alexander Popov 
&gt; wrote:
&gt; &gt;&gt; I have Riak 2.0.1 cluster with 5 nodes ( ec2 m3-large ) with elnm in
&gt; front
&gt; &gt;&gt; sometimes I got spikes up to 10 seconds
&gt; &gt;&gt;
&gt; &gt;&gt; I can't say that I have huge load at this time, max 200 requests per
&gt; &gt;&gt; second for all 5 nodes.
&gt; &gt;&gt;
&gt; &gt;&gt; Most expensive queries is
&gt; &gt;&gt; \* list by secondary index ( usually returns from 0 to 100 records )
&gt; &gt;&gt; \* and solr queries( max 10 records )
&gt; &gt;&gt;
&gt; &gt;&gt; save operations is slowdown sometimes but not so much ( up to 1 sec )
&gt; &gt;&gt;
&gt; &gt;&gt; It's slowdown not for specific requests, same one work pretty fast
&gt; later.
&gt; &gt;&gt;
&gt; &gt;&gt; Does it any possibilities to profile|log somehow to determine reason
&gt; &gt;&gt; why this happen?
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

