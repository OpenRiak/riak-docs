---
title: "Re: Using Key Filters to fetch object keys efficiently"
description: ""
project: community
lastmod: 2011-01-25T06:57:28-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02120"
mailinglist_parent_id: "msg02119"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-01-25T06:57:28-08:00
---


I'm not sure why that's crashing (I suspect it's string\_to\_int on 0-prefixed 
numbers), but your phase has to have "keep":true to return any data to the 
client.

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On Jan 25, 2011, at 9:53 AM, Gordon Tillman wrote:

&gt; Sean thanks again for the feedback. 
&gt; 
&gt; Using just a reduce function seems to cause Riak problems (unless it's me 
&gt; doing something wrong).
&gt; 
&gt; For example, I populated a bucket called "junk" with with the following 
&gt; command:
&gt; 
&gt; for s in `seq 00000 10000`; do curl -X POST -H 'Content-Type: text/plain' 
&gt; http://localhost:8091/riak/junk/$s -d 0; done
&gt; 
&gt; Now if I try and select some keys using key filters and a map function it 
&gt; works:
&gt; 
&gt; curl -X POST -H 'Content-Type: application/json' http://localhost:8091/mapred 
&gt; -d...@kfm.json
&gt; ["5","25","37","10", ... ,"18","22","17"]
&gt; 
&gt; where kfm.json is:
&gt; 
&gt; {
&gt; "inputs": {
&gt; "bucket": "junk",
&gt; "key\_filters": [ ["string\_to\_int"], ["less\_than", 100] ]
&gt; },
&gt; "query": [
&gt; {
&gt; "map": {
&gt; "language": "javascript",
&gt; "source": "function(v, a) { return [v.key]; }"
&gt; }
&gt; }
&gt; ]
&gt; }
&gt; 
&gt; But if I try the same thing with just a reduce phase like this:
&gt; 
&gt; curl -X POST -H 'Content-Type: application/json' http://localhost:8091/mapred 
&gt; -d...@kfr.json -i
&gt; 
&gt; where kfr.json is:
&gt; 
&gt; {
&gt; "inputs": {
&gt; "bucket": "junk",
&gt; "key\_filters": [ ["string\_to\_int"], ["less\_than", 100] ]
&gt; },
&gt; "query": [
&gt; {
&gt; "reduce": {
&gt; "language": "javascript",
&gt; "source": "function(v, a) { return v; }"
&gt; }
&gt; }
&gt; ]
&gt; }
&gt; 
&gt; The curl command just hangs and I see this in the logs:
&gt; 
&gt; =CRASH REPORT==== 25-Jan-2011::08:46:11 ===
&gt; crasher:
&gt; initial call: riak\_kv\_keys\_fsm:init/1
&gt; pid: &lt;0.26942.19&gt;
&gt; registered\_name: []
&gt; exception exit: badmsg
&gt; in function gen\_fsm:terminate/7
&gt; in call from proc\_lib:init\_p\_do\_apply/3
&gt; ancestors: [&lt;0.26941.19&gt;]
&gt; messages: 
&gt; [{EXIT,&lt;0.26942.19&gt;,normal},{EXIT,&lt;0.26942.19&gt;,normal},{$gen\_event,{66195534,{kl,1278813932664540053428224228626747642198940975104,[&lt;&lt;"83"&gt;&gt;,&lt;&lt;"9"&gt;&gt;]}}},{$gen\_event,{66195534,{kl,1278813932664540053428224228626747642198940975104,[&lt;&lt;"76"&gt;&gt;]}}},{$gen\_event,{66195534,{kl,1278813932664540053428224228626747642198940975104,[&lt;&lt;"95"&gt;&gt;]}}},{$gen\_event,{66195534,{kl,1278813932664540053428224228626747642198940975104,[&lt;&lt;"61"&gt;&gt;]}}},{$gen\_event,{66195534,1278813932664540053428224228626747642198940975104,done}}]
&gt; links: []
&gt; dictionary: []
&gt; trap\_exit: true
&gt; status: running
&gt; heap\_size: 2584
&gt; stack\_size: 24
&gt; reductions: 94951
&gt; neighbours:
&gt; 
&gt; --gordon
&gt; 
&gt; On Jan 25, 2011, at 07:24, Sean Cribbs wrote:
&gt; 
&gt;&gt; Use a reduce phase instead, which doesn't force loading of the objects. A 
&gt;&gt; simple identity reduce should do what you want: function(values,arg){ return 
&gt;&gt; values; }
&gt;&gt; 
&gt;&gt; Sean Cribbs 
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://basho.com/
&gt;&gt; 
&gt;&gt; On Jan 24, 2011, at 7:43 PM, Gordon Tillman wrote:
&gt;&gt; 
&gt;&gt;&gt; Greetings All,
&gt;&gt;&gt; 
&gt;&gt;&gt; I have a use case for our app where I need to fetch a list of keys that 
&gt;&gt;&gt; match some pattern and was hoping to be able to use key filters for that.
&gt;&gt;&gt; 
&gt;&gt;&gt; In my test I defined a key filter for the input phase of mapred and then 
&gt;&gt;&gt; defined just a single map phase that returns the object key. But there is 
&gt;&gt;&gt; considerable overhead with that map phase because (I'm assuming this part) 
&gt;&gt;&gt; Riak is having to load each object to provide the necessary inputs to the 
&gt;&gt;&gt; map function.
&gt;&gt;&gt; 
&gt;&gt;&gt; Is there a way to do this without Riak having to actually load the objects?
&gt;&gt;&gt; 
&gt;&gt;&gt; Many thanks,
&gt;&gt;&gt; 
&gt;&gt;&gt; --gordon
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

