---
title: "Re: Pre-commit hook debug"
description: ""
project: community
lastmod: 2015-12-01T11:22:12-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16838"
mailinglist_parent_id: "msg16837"
author_name: "Jon Meredith"
project_section: "mailinglistitem"
sent_date: 2015-12-01T11:22:12-08:00
---


Hi Geoff,

Looks like the WM endpoint isn't handling that crash well.

As for your precommit hook, the hook runs inside the server context so
you'll need to use the riak\_object module instead. riakc\_obj is a cut-down
version for use in the Erlang client.

Jon

On Tue, Dec 1, 2015 at 11:53 AM Geoff Simonds 
wrote:

&gt; Good afternoon,
&gt;
&gt; I am writing to ask for some help regarding a pre-commit hook in Riak
&gt; 2.1.1. I am locally running a 5 node Riak dev cluster (
&gt; https://github.com/xing/riak-dev-cluster) on a Mac and am having trouble
&gt; with a pre-commit hook. I have added the "add\_paths" to my advanced.config:
&gt; [
&gt; Riak KV config
&gt; {riak\_kv,
&gt; [
&gt; %% Paths to custom erlang modules.
&gt; {add\_paths, ["/tmp/ls/custom\_modules"]}
&gt; ]}
&gt; ].
&gt;
&gt; and then copied the compiled beam to this directory. I then issued a curl
&gt; PUT to add the pre-commit to the bucket props:
&gt;
&gt; curl -XPUT -H "Content-Type: application/json" -d
&gt; '{"props":{"precommit":[{"mod":"rr\_pre\_commit","fun":"set\_process\_datetime\_index"}]}}'
&gt; http://127.0.0.1:11098/buckets/LS\~News/props
&gt;
&gt; and am able to confirm it worked when I do a GET on the bucket
&gt; properties. The bucket already had a single key stored in it and when I do
&gt; another PUT on that object (hoping to get the pre-commit to fire), I get
&gt; the following error:
&gt;
&gt; {error,badarg,
&gt; [{erlang,iolist\_to\_binary,
&gt; [{hook\_crashed,
&gt; {rr\_pre\_commit,set\_process\_datetime\_index,error,
&gt; function\_clause}}],
&gt; []},
&gt; {wrq,append\_to\_response\_body,2,[{file,"src/wrq.erl"},{line,215}]},
&gt; {riak\_kv\_wm\_object,handle\_common\_error,3,
&gt; [{file,"src/riak\_kv\_wm\_object.erl"},{line,1178}]},
&gt; {webmachine\_resource,resource\_call,3,
&gt; [{file,"src/webmachine\_resource.erl"},{line,186}]},
&gt; {webmachine\_resource,do,3,
&gt; [{file,"src/webmachine\_resource.erl"},{line,142}]},
&gt; {webmachine\_decision\_core,resource\_call,1,
&gt; [{file,"src/webmachine\_decision\_core.erl"},{line,48}]},
&gt; {webmachine\_decision\_core,accept\_helper,1,
&gt; [{file,"src/webmachine\_decision\_core.erl"},{line,616}]},
&gt; {webmachine\_decision\_core,decision,1,
&gt; [{file,"src/webmachine\_decision\_core.erl"},{line,521}]}]}}
&gt;
&gt;
&gt; I am able to run the pre-commit function when I attach to the Riak shell and 
&gt; add the paths manually (code:add\_patha) but not when it triggers via a PUT. 
&gt; Also, in my pre-commit hook module/function I am using the riak erlang client 
&gt; to access the object metadata. Is this module compiled into Riak or do I 
&gt; also need to add a path for this?
&gt;
&gt;
&gt; The pre-commit module/function is below:
&gt;
&gt;
&gt; set\_process\_datetime\_index(Obj) -&gt;
&gt; case is\_deleted(Obj) of
&gt; true -&gt;
&gt; Obj;
&gt; \_ -&gt;
&gt; MD = riakc\_obj:get\_update\_metadata(Obj),
&gt; case riakc\_obj:get\_user\_metadata\_entry(MD, 
&gt; &lt;&lt;"process\_messagedate"&gt;&gt;) of
&gt; %% if user "process messagedate" metadata is not found
&gt; notfound -&gt;
&gt; %% add it
&gt; MD2 = 
&gt; riakc\_obj:set\_user\_metadata\_entry(MD,{&lt;&lt;"process\_messagedate"&gt;&gt;,format\_date\_index(calendar:local\_time())}),
&gt; %% and modify the message\_date 2i index
&gt; MD3 = riakc\_obj:set\_secondary\_index(MD2,{{binary\_index, 
&gt; &lt;&lt;"messagedate"&gt;&gt;}, [format\_date\_index(calendar:local\_time())]}),
&gt; riakc\_obj:update\_metadata(Obj,MD3);
&gt; \_ -&gt;
&gt; %% otherwise, don't do anything as we have already stored the 
&gt; process time
&gt; Obj
&gt; end
&gt;
&gt; end.
&gt;
&gt; is\_deleted(Obj)-&gt;
&gt; case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riakc\_obj:get\_metadata(Obj)) of
&gt; {ok,\_} -&gt;
&gt; true;
&gt; \_ -&gt;
&gt; false
&gt; end.
&gt;
&gt;
&gt; Any help or advice is appreciated.
&gt;
&gt;
&gt; Geoff
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

