---
title: "Re: [Basho Riak] Fail To Update Document Repeatly With Cluster of 5	Nodes"
description: ""
project: community
lastmod: 2017-02-07T03:06:19-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17934"
mailinglist_parent_id: "msg17930"
author_name: "my hue"
project_section: "mailinglistitem"
sent_date: 2017-02-07T03:06:19-08:00
---


Dear Russel,

Let me try with your suggestion with an new, empty key and use modify\_type
to update a single register.
And I will feedback to you on my result test.

Best regards,
Hue Tran


On Tue, Feb 7, 2017 at 5:37 PM, Russell Brown  wrote:

&gt;
&gt; On 7 Feb 2017, at 10:27, my hue  wrote:
&gt;
&gt; &gt; Dear Russell,
&gt; &gt;
&gt; &gt; Yes, I updated all registers in one go.
&gt; &gt; And I do not try yet with updating a single register at a time.
&gt; &gt; let me try to see. But I wonder that any affect on solving conflict at
&gt; riak cluster
&gt; &gt; if update all in one go?
&gt; &gt;
&gt;
&gt; Just trying to make the search space as small as possible. I don’t think
&gt; \_any\_ of this should fail. The maps code is very well tested and well used,
&gt; so it’s all kind of odd.
&gt;
&gt; Without hands on it’s hard to debug, and email back and forth is slow, so
&gt; if you try the simplest possible thing and that still fails, it helps.
&gt;
&gt; IMO the simplest possible thing is to start with a new, empty key and use
&gt; modify\_type to update a single register.
&gt;
&gt; Many thanks
&gt;
&gt; Russell
&gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; On Tue, Feb 7, 2017 at 5:18 PM, Russell Brown 
&gt; wrote:
&gt; &gt; So in you’re updating all those registers in one go? Out of interest,
&gt; what happens if you update a single register at a time?
&gt; &gt;
&gt; &gt; On 7 Feb 2017, at 10:02, my hue  wrote:
&gt; &gt;
&gt; &gt; &gt; Dear Russel,
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; Can you run riakc\_map:to\_op(Map). and show me the output of that,
&gt; please?
&gt; &gt; &gt;
&gt; &gt; &gt; The following is output of riakc\_map:to\_op(Map) :
&gt; &gt; &gt;
&gt; &gt; &gt; {map, {update, [{update, {&lt;&lt;"updated\_time\_dt"&gt;&gt;,
&gt; register},{assign,&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}},
&gt; {update,{&lt;&lt;"updated\_by\_id"&gt;&gt;,register}, {assign,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{update,{&lt;&lt;"
&gt; status\_id"&gt;&gt;,register},{assign,&lt;&lt;"show"&gt;&gt;}},{update,{&lt;
&gt; &lt;"start\_time"&gt;&gt;,register},{assign,&lt;&lt;"dont\_use"&gt;&gt;}},{
&gt; update,{&lt;&lt;"restaurant\_status\_id"&gt;&gt;,register}, {assign,&lt;&lt;"inactive"&gt;&gt;}},
&gt; {update,{&lt;&lt;"restaurant\_id"&gt;&gt;,register}, {assign,&lt;&lt;"
&gt; rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}},{update,{&lt;&lt;"rest\_location\_p"&gt;&gt;,register},
&gt; {assign,&lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}},
&gt; {update,{&lt;&lt;"order\_i"&gt;&gt;,register},{assign,&lt;&lt;"0"&gt;&gt;}},
&gt; {update,{&lt;&lt;"name"&gt;&gt;,register},{assign,&lt;&lt;"fullmenu"&gt;&gt;}},
&gt; {update,{&lt;&lt;"menu\_category\_revision\_id"&gt;&gt;,register}, {assign,&lt;&lt;"0-
&gt; 634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}}, {update,{&lt;&lt;"maintain\_mode\_b"&gt;&gt;
&gt; ,register},{assign,&lt;&lt;"false"&gt;&gt;}}, {update,{&lt;&lt;"id"&gt;&gt;,register}, {assign,&lt;&lt;"
&gt; menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}}, {update,{&lt;&lt;"end\_time"&gt;&gt;,
&gt; register},{assign,&lt;&lt;"dont\_use"&gt;&gt;}},{update,{&lt;&lt;"currency"&gt;&gt;,register},{assign,&lt;&lt;"cad"&gt;&gt;}},
&gt; {update,{&lt;&lt;"created\_time\_dt"&gt;&gt;,register}, 
&gt; {assign,&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}},
&gt; {update,{&lt;&lt;"created\_by\_id"&gt;&gt;,register}, {assign,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}}, 
&gt; {update,{&lt;&lt;"account\_id"&gt;&gt;,register},
&gt; {assign,&lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}}]},
&gt; &lt;&lt;131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,
&gt; 233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,
&gt; 103,5,182,208,0,0,118,2,97,39,104,2,109,0,0,0,12,137,252,
&gt; 139,186,176,202,25,96,0,0,195,164,97,53,106&gt;&gt;}
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue, Feb 7, 2017 at 4:36 PM, Russell Brown 
&gt; wrote:
&gt; &gt; &gt;
&gt; &gt; &gt; On 7 Feb 2017, at 09:34, my hue  wrote:
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; Dear Russell,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;What operation are you performing? What is the update you perform?
&gt; Do you set a register value, add a register, remove a register?
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I used riakc\_map:update to update value with map. I do the following
&gt; steps :
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; - Get FetchData map with fetch\_type
&gt; &gt; &gt; &gt; - Extract key, value, context from FetchData
&gt; &gt; &gt; &gt; - Obtain UpdateData with:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; + Init map with context
&gt; &gt; &gt;
&gt; &gt; &gt; I don’t understand this step
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; + Use :
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; riakc\_map:update({K, register}, fun(R) -&gt; riakc\_register:set(V,
&gt; R) end, InitMap)
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; to obtain UpdateData
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Note:
&gt; &gt; &gt; &gt; K : key
&gt; &gt; &gt; &gt; V: value
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; - Then update UpdateData with update\_type
&gt; &gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Can you run riakc\_map:to\_op(Map). and show me the output of that,
&gt; please?
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; The following is sample about Update data :
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; {map, [] ,
&gt; &gt; &gt; &gt; [{{&lt;&lt;"account\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_
&gt; by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"accounta25a424b8484181e8ba1bec
&gt; 25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_time\_dt"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}},{{&lt;&lt;"currency"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"cad"&gt;&gt;}},{{&lt;&lt;"end\_time"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}},{{&lt;&lt;"id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}},{{&lt;&lt;"maintain\_
&gt; mode\_b"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"false"&gt;&gt;}},{{&lt;&lt;"menu\_
&gt; category\_revision\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"0-
&gt; 634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}},{{&lt;&lt;"name"&gt;&gt;,register}
&gt; ,{register,&lt;&lt;&gt;&gt;,&lt;&lt;"fullmenu"&gt;&gt;}},{{&lt;&lt;"order\_i"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"0"&gt;&gt;}},{{&lt;&lt;"rest\_location\_p"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}},{{&lt;&lt;"
&gt; restaurant\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}},{{&lt;&lt;"restaurant\_
&gt; status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"inactive"&gt;&gt;}}
&gt; ,{{&lt;&lt;"start\_time"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}
&gt; },{{&lt;&lt;"status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"show"&gt;&gt;}},{{
&gt; &lt;&lt;"updated\_by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"updated\_
&gt; time\_dt"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}}],
&gt; &gt; &gt; &gt; [] , &lt;&lt;131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,
&gt; 233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,
&gt; 103,5,182,208,0,0,118,2,97,39,104,2,109,0,0,0,12,137,252,
&gt; 139,186,176,202,25,96,0,0,195,164,97,53,106&gt;&gt;
&gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue, Feb 7, 2017 at 3:43 PM, Russell Brown 
&gt; wrote:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On 7 Feb 2017, at 08:17, my hue  wrote:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Dear John and Russell Brown,
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* How fast is your turnaround time between an update and a fetch?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; The turnaround time between an update and a fetch about 1 second.
&gt; &gt; &gt; &gt; &gt; During my team and I debug, we adjusted haproxy with the scenario
&gt; as follow:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Scenario 1 : round robin via 5 nodes of cluster
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; We meet issue at scenario 1 and we are afraid of that timeout can
&gt; be occurs between nodes,
&gt; &gt; &gt; &gt; &gt; make us still get stale data. Then we performed scenario 2
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Scenario 2: Disable round robin and only route request to node 1.
&gt; Cluster still is 5 nodes.
&gt; &gt; &gt; &gt; &gt; With this case we ensure that request update and fetch always come
&gt; to and from node 1.
&gt; &gt; &gt; &gt; &gt; And the issue still occurs.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; At the fail time, I hoped that can get any error log from riak
&gt; nodes to give me any information.
&gt; &gt; &gt; &gt; &gt; But riak log show to me nothing and everything is ok.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* What operation are you performing?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I used :
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; riakc\_pb\_socket:update\_type(Pid, {Bucket-Type, Bucket}, Key,
&gt; riakc\_map:to\_op(Map), []).
&gt; &gt; &gt; &gt; &gt; riakc\_pb\_socket:fetch\_type(Pid, {BucketType, Bucket}, Key, []).
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; What operation are you performing? What is the update you perform?
&gt; Do you set a register value, add a register, remove a register?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* It looks like the map is a single level map of last-write-wins
&gt; registers. Is there a chance that the time on the node handling the update
&gt; is behind the value in the lww-register?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; =&gt; I am not sure about logic show conflict of internal riak node.
&gt; And the issue never happens if I used single node.
&gt; &gt; &gt; &gt; &gt; My bucket properties as follow :
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; {"props":{"name":"menu","active":true,"allow\_mult":
&gt; true,"backend":"bitcask\_mult","basic\_quorum":false,"big\_
&gt; vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"
&gt; chash\_std\_keyfun"},"claimant":"riak-node1@64.137.190.244","
&gt; datatype":"map","dvv\_enabled":true,"dw":"quorum","last\_
&gt; write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker",
&gt; "fun":"mapreduce\_linkfun"},"n\_val":3,"name":"menu","
&gt; notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,
&gt; "precommit":[],"pw":0,"r":"quorum","rw":"quorum","search\_
&gt; index":"menu\_idx","small\_vclock":50,"w":"quorum","young\_vclock":20}}
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Note :
&gt; &gt; &gt; &gt; &gt; + "datatype":"map"
&gt; &gt; &gt; &gt; &gt; + "last\_write\_wins": false
&gt; &gt; &gt; &gt; &gt; + "dvv\_enabled": true
&gt; &gt; &gt; &gt; &gt; + "allow\_mult": true
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* Have you tried using the `modify\_type` operation in
&gt; riakc\_pb\_socket which does the fetch/update operation in sequence for you?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; =&gt; I dot not use yet, but my action is sequence with fetch and
&gt; then update. Might be I will try modify\_type to see.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* Anything in the error logs on any of the nodes?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; =&gt; From the node log, no errror report at fail time.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; \* Is the opaque context identical from the fetch and then later
&gt; after the update?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; =&gt; There is the context got from fetch and that context used with
&gt; update.
&gt; &gt; &gt; &gt; &gt; And during our debug time with string of sequence : fetch ,
&gt; update, fetch , update , .... the context I saw always the same at
&gt; &gt; &gt; &gt; &gt; fetch data.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Best regards,
&gt; &gt; &gt; &gt; &gt; Hue Tran
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Tue, Feb 7, 2017 at 2:11 AM, John Daily 
&gt; wrote:
&gt; &gt; &gt; &gt; &gt; Originally I suspected the context which allows Riak to resolve
&gt; conflicts was not present in your data, but I see it in your map structure.
&gt; Thanks for supplying such a detailed description.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; How fast is your turnaround time between an update and a fetch?
&gt; Even if the cluster is healthy it’s not impossible to see a timeout between
&gt; nodes, which could result in a stale retrieval. Have you verified whether
&gt; the stale data persists?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; A single node cluster gives an advantage that you’ll never see in
&gt; a real cluster: a perfectly synchronized clock. It also reduces (but does
&gt; not completely eliminate) the possibility of an internal timeout between
&gt; processes.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; -John
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;&gt; On Feb 6, 2017, at 1:02 PM, my hue 
&gt; wrote:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Dear Riak Team,
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; I and my team used riak as database for my production with an
&gt; cluster including 5 nodes.
&gt; &gt; &gt; &gt; &gt;&gt; While production run, we meet an critical bug that is sometimes
&gt; fail to update document.
&gt; &gt; &gt; &gt; &gt;&gt; I and my colleagues performed debug and detected an issue with
&gt; the scenario as follow:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; + fetch document
&gt; &gt; &gt; &gt; &gt;&gt; + change value of document
&gt; &gt; &gt; &gt; &gt;&gt; + update document
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Repeat about 10 times and will meet fail. With the document is
&gt; updated continually,
&gt; &gt; &gt; &gt; &gt;&gt; sometimes will face update fail.
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; The first time, 5 nodes of cluster we used riak version 2.1.1.
&gt; &gt; &gt; &gt; &gt;&gt; After meet above bug, we upgraded to use riak version 2.2.0 and
&gt; this issue still occurs.
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Via many time test, debug using Tcpdump at riak node :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; tcpdump -A -ttt -i {interface} src host {host} and dst port
&gt; {port}
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; And together with the command:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; riak-admin status | grep "node\_puts\_map\| node\_puts\_map\_total\|
&gt; node\_puts\_total\| vnode\_map\_update\_total\| vnode\_puts\_total\"
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; we got that the riak server already get the update request.
&gt; &gt; &gt; &gt; &gt;&gt; However, do not know why riak backend fail to update document.
&gt; &gt; &gt; &gt; &gt;&gt; At the fail time, from riak server log everything is ok.
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Then we removed cluster and use a single riak server, and see
&gt; that above bug never happen.
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; For that reason, think that is only happen with cluster work. We
&gt; took research on basho riak document and our riak configure
&gt; &gt; &gt; &gt; &gt;&gt; seems that like suggestion from document. We totally blocked on
&gt; this issue and hope that can get support from you
&gt; &gt; &gt; &gt; &gt;&gt; so that can obtain a stable work from riak database for our
&gt; production.
&gt; &gt; &gt; &gt; &gt;&gt; Thank you so much. Hope that can get your reply soon.
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* The following is our riak node information :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Riak version: 2.2.0
&gt; &gt; &gt; &gt; &gt;&gt; OS : CentOS Linux release 7.2.1511
&gt; &gt; &gt; &gt; &gt;&gt; Cpu : 4 core
&gt; &gt; &gt; &gt; &gt;&gt; Memory : 4G
&gt; &gt; &gt; &gt; &gt;&gt; Riak configure : the attached file "riak.conf"
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Note :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - We mostly using default configure of riak configure except
&gt; that we used storage backend is multi
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; storage\_backend = multi
&gt; &gt; &gt; &gt; &gt;&gt; multi\_backend.bitcask\_mult.storage\_backend = bitcask
&gt; &gt; &gt; &gt; &gt;&gt; multi\_backend.bitcask\_mult.bitcask.data\_root =
&gt; /var/lib/riak/bitcask\_mult
&gt; &gt; &gt; &gt; &gt;&gt; multi\_backend.default = bitcask\_mult
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Bucket type created with the following command:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; riak-admin bucket-type create dev\_restor
&gt; '{"props":{"backend":"bitcask\_mult","datatype":"map"}}'
&gt; &gt; &gt; &gt; &gt;&gt; riak-admin bucket-type activate dev\_restor
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Bucket Type Status :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; &gt;&gt; riak-admin bucket-type status dev\_restor
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; dev\_restor is active
&gt; &gt; &gt; &gt; &gt;&gt; young\_vclock: 20
&gt; &gt; &gt; &gt; &gt;&gt; w: quorum
&gt; &gt; &gt; &gt; &gt;&gt; small\_vclock: 50
&gt; &gt; &gt; &gt; &gt;&gt; rw: quorum
&gt; &gt; &gt; &gt; &gt;&gt; r: quorum
&gt; &gt; &gt; &gt; &gt;&gt; pw: 0
&gt; &gt; &gt; &gt; &gt;&gt; precommit: []
&gt; &gt; &gt; &gt; &gt;&gt; pr: 0
&gt; &gt; &gt; &gt; &gt;&gt; postcommit: []
&gt; &gt; &gt; &gt; &gt;&gt; old\_vclock: 86400
&gt; &gt; &gt; &gt; &gt;&gt; notfound\_ok: true
&gt; &gt; &gt; &gt; &gt;&gt; n\_val: 3
&gt; &gt; &gt; &gt; &gt;&gt; linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
&gt; &gt; &gt; &gt; &gt;&gt; last\_write\_wins: false
&gt; &gt; &gt; &gt; &gt;&gt; dw: quorum
&gt; &gt; &gt; &gt; &gt;&gt; dvv\_enabled: true
&gt; &gt; &gt; &gt; &gt;&gt; chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
&gt; &gt; &gt; &gt; &gt;&gt; big\_vclock: 50
&gt; &gt; &gt; &gt; &gt;&gt; basic\_quorum: false
&gt; &gt; &gt; &gt; &gt;&gt; backend: &lt;&lt;"bitcask\_mult"&gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; allow\_mult: true
&gt; &gt; &gt; &gt; &gt;&gt; datatype: map
&gt; &gt; &gt; &gt; &gt;&gt; active: true
&gt; &gt; &gt; &gt; &gt;&gt; claimant: 'riak-node1@64.137.190.244'
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Bucket Property :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; {"props":{"name":"menu","active":true,"allow\_mult":
&gt; true,"backend":"bitcask\_mult","basic\_quorum":false,"big\_
&gt; vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"
&gt; chash\_std\_keyfun"},"claimant":"riak-node1@64.137.190.244","
&gt; datatype":"map","dvv\_enabled":true,"dw":"quorum","last\_
&gt; write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker",
&gt; "fun":"mapreduce\_linkfun"},"n\_val":3,"name":"menu","
&gt; notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,
&gt; "precommit":[],"pw":0,"r":"quorum","rw":"quorum","search\_
&gt; index":"menu\_idx","small\_vclock":50,"w":"quorum","young\_vclock":20}}
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Member status :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; &gt;&gt; riak-admin member-status
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ================================= Membership
&gt; ==================================
&gt; &gt; &gt; &gt; &gt;&gt; Status Ring Pending Node
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -------------------
&gt; &gt; &gt; &gt; &gt;&gt; valid 18.8% -- 'riak-node1@64.137.190.244'
&gt; &gt; &gt; &gt; &gt;&gt; valid 18.8% -- 'riak-node2@64.137.247.82'
&gt; &gt; &gt; &gt; &gt;&gt; valid 18.8% -- 'riak-node3@64.137.162.64'
&gt; &gt; &gt; &gt; &gt;&gt; valid 25.0% -- 'riak-node4@64.137.161.229'
&gt; &gt; &gt; &gt; &gt;&gt; valid 18.8% -- 'riak-node5@64.137.217.73'
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -------------------
&gt; &gt; &gt; &gt; &gt;&gt; Valid:5 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Ring
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; &gt;&gt; riak-admin status | grep ring
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ring\_creation\_size : 64
&gt; &gt; &gt; &gt; &gt;&gt; ring\_members : ['riak-node1@64.137.190.244','
&gt; riak-node2@64.137.247.82', 'riak-node3@64.137.162.64','ri
&gt; ak-node4@64.137.161.229', 'riak-node5@64.137.217.73']
&gt; &gt; &gt; &gt; &gt;&gt; ring\_num\_partitions : 64
&gt; &gt; &gt; &gt; &gt;&gt; ring\_ownership : &lt;&lt;"[{'riak-node2@64.137.247.82',12},\n {'
&gt; riak-node5@64.137.217.73',12},\n {'riak-node1@64.137.190.244',12},\n {'
&gt; riak-node3@64.137.162.64',12},\n {'riak-node4@64.137.161.229',16}]"&gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; rings\_reconciled : 0
&gt; &gt; &gt; &gt; &gt;&gt; rings\_reconciled\_total : 31
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* The riak client :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; + riak-erlang-client: https://github.com/basho/riak-
&gt; erlang-client
&gt; &gt; &gt; &gt; &gt;&gt; + release : 2.4.2
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* Riak client API used:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; + Insert/Update:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; riakc\_pb\_socket:update\_type(Pid, {Bucket-Type, Bucket}, Key,
&gt; riakc\_map:to\_op(Map), []).
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; + Fetch :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; riakc\_pb\_socket:fetch\_type(Pid, {BucketType, Bucket}, Key, []).
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* Step to perform an update :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; - Fetch document
&gt; &gt; &gt; &gt; &gt;&gt; - Update document
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; ------------------------------------------------------------
&gt; -----------------------------------------------------------------
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* Data got from fetch\_type:
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; {map, [{{&lt;&lt;"account\_id"&gt;&gt;,register}, &lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;},
&gt; &gt; &gt; &gt; &gt;&gt; {{&lt;&lt;"created\_by\_id"&gt;&gt;,register}, &lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}, {{&lt;&lt;"created\_time\_dt"&gt;&gt;,
&gt; register},&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}, {{&lt;&lt;"currency"&gt;&gt;,register},&lt;&lt;"cad"&gt;&gt;},
&gt; {{&lt;&lt;"end\_time"&gt;&gt;,register},&lt;&lt;"dont\_use"&gt;&gt;}, {{&lt;&lt;"id"&gt;&gt;,register},&lt;&lt;"
&gt; menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}, 
&gt; {{&lt;&lt;"maintain\_mode\_b"&gt;&gt;,register},&lt;&lt;"false"&gt;&gt;},
&gt; {{&lt;&lt;"menu\_category\_revision\_id"&gt;&gt;,register}, &lt;&lt;"0-
&gt; 634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}, {{&lt;&lt;"name"&gt;&gt;,register},&lt;&lt;"fullmenu"&gt;&gt;},
&gt; {{&lt;&lt;"order\_i"&gt;&gt;,register},&lt;&lt;"0"&gt;&gt;}, {{&lt;&lt;"rest\_location\_p"&gt;&gt;,register},
&gt; &lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}, {{&lt;&lt;"restaurant\_id"&gt;&gt;,register},
&gt; &lt;&lt;"rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}, 
&gt; {{&lt;&lt;"restaurant\_status\_id"&gt;&gt;,register},&lt;&lt;"inactive"&gt;&gt;},
&gt; {{&lt;&lt;"start\_time"&gt;&gt;,register},&lt;&lt;"dont\_use"&gt;&gt;},
&gt; {{&lt;&lt;"status\_id"&gt;&gt;,register},&lt;&lt;"hide"&gt;&gt;}, {{&lt;&lt;"updated\_by\_id"&gt;&gt;,register},
&gt; &lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}, {{&lt;&lt;"updated\_time\_dt"&gt;&gt;,
&gt; register},&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}],
&gt; &gt; &gt; &gt; &gt;&gt; [],
&gt; &gt; &gt; &gt; &gt;&gt; [], &lt;&lt;131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,
&gt; 233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,
&gt; 103,5,182,208,0,0,118,2,97,40,104,2,109,0,0,0,12,137,252,
&gt; 139,186,176,202,25,96,0,0,195,164,97,54,106&gt;&gt;}
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; \* Update with update\_type
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Below is Map data before using riakc\_map:to\_op(Map) :
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; {map, [] ,
&gt; &gt; &gt; &gt; &gt;&gt; [{{&lt;&lt;"account\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_
&gt; by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"accounta25a424b8484181e8ba1bec
&gt; 25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_time\_dt"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}},{{&lt;&lt;"currency"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"cad"&gt;&gt;}},{{&lt;&lt;"end\_time"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}},{{&lt;&lt;"id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}},{{&lt;&lt;"maintain\_
&gt; mode\_b"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"false"&gt;&gt;}},{{&lt;&lt;"menu\_
&gt; category\_revision\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"0-
&gt; 634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}},{{&lt;&lt;"name"&gt;&gt;,register}
&gt; ,{register,&lt;&lt;&gt;&gt;,&lt;&lt;"fullmenu"&gt;&gt;}},{{&lt;&lt;"order\_i"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"0"&gt;&gt;}},{{&lt;&lt;"rest\_location\_p"&gt;&gt;,register},{
&gt; register,&lt;&lt;&gt;&gt;,&lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}},{{&lt;&lt;"
&gt; restaurant\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}},{{&lt;&lt;"restaurant\_
&gt; status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"inactive"&gt;&gt;}}
&gt; ,{{&lt;&lt;"start\_time"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}
&gt; },{{&lt;&lt;"status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"show"&gt;&gt;}},{{
&gt; &lt;&lt;"updated\_by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"
&gt; accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"updated\_
&gt; time\_dt"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}}],
&gt; &gt; &gt; &gt; &gt;&gt; [] , &lt;&lt;131,108,0,0,0,3,104,2,109,0,
&gt; 0,0,12,39,21,84,209,219,42,57,233,0,0,156,252,97,34,104,2,
&gt; 109,0,0,0,12,132,107,248,226,103,5,182,208,0,0,118,2,97,39,
&gt; 104,2,109,0,0,0,12,137,252,139,186,176,202,25,96,0,0,195,164,97,53,106&gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; }
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; -
&gt; &gt; &gt; &gt; &gt;&gt;
&gt; &gt; &gt; &gt; &gt;&gt; Best regards,
&gt; &gt; &gt; &gt; &gt;&gt; Hue Tran
&gt; &gt; &gt; &gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt; &gt; &gt;&gt; riak-users mailing list
&gt; &gt; &gt; &gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_
&gt; lists.basho.com
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt;
&gt; &gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

