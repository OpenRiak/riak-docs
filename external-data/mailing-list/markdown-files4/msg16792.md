---
title: "Re: Riak CS/Stanchion troubleshooting (Retrieval of user record)"
description: ""
project: community
lastmod: 2015-11-19T03:06:02-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16792"
mailinglist_parent_id: "msg16770"
author_name: "Vladyslav Zakhozhai"
project_section: "mailinglistitem"
sent_date: 2015-11-19T03:06:02-08:00
---


Hi,

Sorry for my long silence. Kazhuiro thank you for your answer. The
situation is more clear. I think that I need to extend my Riak cluster with
more nodes to increase performance. The reason for my opinion is:

Nov 19 11:42:40 localhost haproxy[24678]: 172.18.103.31:49608
[19/Nov/2015:11:42:40.137] riak riak\_backend/viper 3/5/113 1471 --
8191/2594/2594/138/0 0/0
Nov 19 11:42:41 localhost haproxy[24678]: 172.18.108.170:44517
[19/Nov/2015:11:41:42.264] riak riak\_backend/serpent 1/0/58806 5982 cD
8191/2849/2849/155/0 0/0
Nov 19 11:59:46 localhost haproxy[24678]: 172.18.102.39:42919
[19/Nov/2015:11:42:14.566] riak riak\_backend/mussurana 1/0/1052250 1484789
-- 3134/2888/2888/154/0 0/0
Nov 19 12:07:26 localhost haproxy[24678]: 172.18.40.2:44946
[19/Nov/2015:11:42:14.508] riak riak\_backend/rattler 1/0/1511814 2471638 cD
3172/2888/2888/161/0 0/0
Nov 19 12:17:56 localhost haproxy[24678]: 172.18.103.30:58654
[19/Nov/2015:11:42:40.141] riak riak\_backend/mamba 3/1/2116572 3383878 cD
2988/2886/2886/166/0 0/0
Nov 19 12:23:55 localhost haproxy[24678]: 172.18.40.4:59089
[19/Nov/2015:11:41:39.831] riak riak\_backend/eggeater 1/0/2535854 4109579
CD 3020/2888/2888/153/0 0/0
Nov 19 12:38:54 localhost haproxy[24678]: 172.18.40.4:37536
[19/Nov/2015:11:41:47.533] riak riak\_backend/cobra 1/0/3427457 3387298 --
2983/2886/2886/159/0 0/0
Nov 19 12:50:37 localhost haproxy[24678]: 172.18.102.39:51870
[19/Nov/2015:11:41:49.413] riak riak\_backend/lora 1/0/4128262 6445878 --
2989/2889/2889/164/0 0/0

I think that it is not haproxy's timeouts issue. Am I right?

Regarding to HAProxy config I have the following config for Riak pb:
frontend riak
 bind 172.18.108.170:8087

 mode tcp
 option tcplog
 option contstats

 timeout client 30s

 default\_backend riak\_backend

backend riak\_backend
 mode tcp
 balance roundrobin
 option tcpka
 option srvtcpka
 option httpchk GET /ping

 timeout server 60s

 server rinkhals rinkhals.pleiad.uaprom:8087 weight 1 maxconn 1024 check
port 8090
 server chuckwalla chuckwalla.pleiad.uaprom:8087 weight 1 maxconn 1024
check port 8090
 and so on...

And config for Riak CS:
frontend riakcs
 bind 193.34.169.1:80
 mode http
 option contstats
 option httplog
 option http-server-close
 timeout client 30s

 default\_backend riakcs\_backend

backend riakcs\_backend
 mode http
 balance roundrobin

 option httpchk GET /riak-cs/ping
 option redispatch
 retries 3

 timeout server 60s
 timeout connect 60s
 timeout http-request 60s

 server rinkhals rinkhals.pleiad.uaprom:8080 weight 1 maxconn 1024 check
port 8000
 server chuckwalla chuckwalla.pleiad.uaprom:8080 weight 1 maxconn 1024
check port 8000
 and so on...

And default section:
defaults
 log global
 option dontlognull
 retries 3
 option redispatch
 maxconn 8192
 timeout connect 5000
 timeout client 4h
 timeout server 4h
 balance leastconn

I want to mention again taht I have about 1000 rps to Riak CS, average
object size is 10 Kb.

Thank you.


On Mon, Nov 16, 2015 at 4:01 AM Kazuhiro Suzuki  wrote:

&gt; Hi,
&gt;
&gt; ha\_proxy's timeout settings often causes disconnected errors on a Riak
&gt; CS deployment by high work load. termination\_stat [1] in tcplog [2]
&gt; lets you know if timeout happens or not.
&gt;
&gt; &gt; 2015-11-13 13:13:09.514 [error]
&gt; &lt;0.11264.1387&gt;@riak\_cs\_wm\_common:maybe\_create\_user:222 Retrieval of user
&gt; record for s3 failed. Reason: disconnected
&gt;
&gt; This means Riak CS failed to read a user data from Riak for
&gt; authentication due to a disconnected error.
&gt;
&gt; &gt; Riak CS adds, removes, gets properties through Stanchion service. Am I
&gt; right? I can't exactly understand where is my bottleneck - Riak, Riak CS or
&gt; Stanchion.
&gt;
&gt; Mainly Stanchion is only used to update/delete data of users and
&gt; buckets. To inspect a node, Riak S2/CS 2.1 introduced new metrics
&gt; including various latencies and counters, which help to identify
&gt; bottleneck.
&gt;
&gt; &gt; When we need authenticated access for reading object from bucket do we
&gt; need Stanchion? If not I can't understand why I had a lot of error during
&gt; getting objects from Riak CS.
&gt;
&gt; Authenticated access is always necessary but a read request of user
&gt; data for auth is issued from Riak CS to Riak directly, not through
&gt; Stanchion.
&gt;
&gt; &gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion
&gt; connectivity I need to restart Riak CS.
&gt;
&gt; Riak CS 1.5.0 has connection pool leak problem [3]. You might hit the
&gt; issue...
&gt;
&gt; [1]: https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.5
&gt; [2]: https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.2.2
&gt; [3]:
&gt; http://docs.basho.com/riakcs/latest/cookbooks/Riak-CS-Release-Notes/#Riak-CS-1-5-2
&gt;
&gt; On Sat, Nov 14, 2015 at 2:04 AM, Vladyslav Zakhozhai
&gt;  wrote:
&gt; &gt;
&gt; &gt; Hello.
&gt; &gt;
&gt; &gt; I have Riak CS cluster with 18 nodes. On each node there is Riak CS and
&gt; Riak
&gt; &gt; service and one Stanchion node.
&gt; &gt;
&gt; &gt; Versions:
&gt; &gt; Riak 1.4.12
&gt; &gt; Riak CS 1.5.0
&gt; &gt; Stanchion 1.5.0
&gt; &gt;
&gt; &gt; Riak CS and Riak allocated behind HAProxy balancers:
&gt; &gt;
&gt; &gt; WAN -&gt; HAProxy -&gt; Riak CS nodes -&gt; HAProxy -&gt; Riak nodes.
&gt; &gt; ans
&gt; &gt; Stanchion -&gt; HAProxy -&gt; Riak
&gt; &gt;
&gt; &gt; Today due a spike of traffic load (about 1000 rps) on the cluster 50% of
&gt; &gt; Riak CS returned HTTP 500 and 503 (querying /riak-cs/ping resource also
&gt; was
&gt; &gt; not successful).
&gt; &gt;
&gt; &gt; In Riak CS logs I've seen the following messages:
&gt; &gt;
&gt; &gt; 2015-11-13 13:13:09.514 [error]
&gt; &gt; &lt;0.11264.1387&gt;@riak\_cs\_wm\_common:maybe\_create\_user:222 Retrieval of user
&gt; &gt; record for s3 failed. Reason: disconnected
&gt; &gt;
&gt; &gt; In Riak CS logs I see the following:
&gt; &gt; 2015-11-13 17:31:52.995 [error] &lt;0.11254.6534&gt; Lager event handler
&gt; &gt; error\_logger\_lager\_h exited with reason
&gt; &gt;
&gt; {'EXIT',{{badmatch,["/buckets/uaprom-image/objects/272547384\_cid1322007\_pid183135512-26a7c1f3.jpg",{error,{error,{badmatch,{error,closed}},[{webmachine\_request,recv\_unchunked\_body,3,[{file,"src/webmachine\_request.erl"},{line,471}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,193}]},{wrq,stream\_req\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\_cs\_wm\_object,handle\_normal\_put,2,[{file,"src/riak\_cs\_wm\_object.erl"},{line,341}]},{riak\_cs\_wm\_common,accept\_body,2,[{file,...},...]},...]}},...]},...}}
&gt; &gt;
&gt; &gt; I suspect that there were problem between Riak CS - Stanhion or Stanhion
&gt; -
&gt; &gt; Riak. I have no clear idea in Stanchion troubleshooting. The main reason
&gt; is
&gt; &gt; the following. Stanhion works fine, service is up (answers on ping
&gt; command).
&gt; &gt; But it is very laconic: there is almost nothing in console and error logs
&gt; &gt; (even with debug log level).
&gt; &gt;
&gt; &gt; Riak CS adds, removes, gets properties through Stanchion service. Am I
&gt; &gt; right? I can't exactly understand where is my bottleneck - Riak, Riak CS
&gt; or
&gt; &gt; Stanhion.
&gt; &gt;
&gt; &gt; When we need authenticated access for reading object from bucket do we
&gt; need
&gt; &gt; Stanchion? If not I can't understand why I had a lot of error during
&gt; getting
&gt; &gt; objects from Riak CS.
&gt; &gt;
&gt; &gt; Thank you in advance.
&gt; &gt;
&gt; &gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion
&gt; &gt; connectivity I need to restart Riak CS.
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kazuhiro Suzuki | Basho Japan KK
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

