---
title: "Re: riak2 erlang mapreduce counters"
description: ""
project: community
lastmod: 2014-01-24T00:00:16-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13475"
mailinglist_parent_id: "msg13473"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2014-01-24T00:00:16-08:00
---


Hi Bryce,

Sorry about this, and thanks for the detailed info. I do need to add MapReduce 
friendly functions.

On 23 Jan 2014, at 23:51, Bryce Verdier  wrote:

&gt; Thank you both Eric & Russeli for the answer, sadly it leads to more 
&gt; questions. Regardless of the type (though I can say in this case the counters 
&gt; were pushed from the python 2.0.2 client, so I assume its riak\_dt\_pncounter)

It is a riak\_kv\_pncounter, I don’t think any of the clients support the new API 
end points (bucket types) so you’ll be using the 1.4 counter.

&gt; 
&gt; I get this error:
&gt; {"phase":0,"error":"badarg","input":"{ok,{r\_object,&lt;&lt;\"ogir-fp\"&gt;&gt;,&lt;&lt;\"682l2fp6\"&gt;&gt;,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;\"content-type\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,114,105,97,107,95,99,111,117,110,116,101,114],[&lt;&lt;\"X-Riak-VTag\"&gt;&gt;,52,103,66,88,71,122,56,55,111,105,66,112,103,65,75,99,54,72,55,69,110,79]],[[&lt;&lt;\"index\"&gt;&gt;]],[],[[&lt;&lt;\"X-Riak-Last-Modified\"&gt;&gt;|{1390,508268,984013}]],[],[]}}},&lt;&lt;69,1,71,1,0,0,0,29,70,1,131,108,0,0,0,1,104,2,109,...&gt;&gt;}],...},...}","type":"error","stack":"[{erlang,apply,[&lt;&lt;\"riak\_kv\_pncounter\"&gt;&gt;,new,[]],[]},{riak\_kv\_crdt,crdt\_value,2,[{file,\"src/riak\_kv\_crdt.erl\"},{line,94}]},{riak\_kv\_crdt,value,2,[{file,\"src/riak\_kv\_crdt.erl\"},{line,86}]},{mr\_kv\_counters,value,3,[{file,\"mr\_kv\_counters.erl\"},{line,38}]},{riak\_kv\_mrc\_map,map,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,165}]},{riak\_kv\_mrc\_map,process,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,141}]},{riak\_pipe\_vnode\_worker,process\_input,3,[{file,\"src/riak\_pipe\_vnode\_worker.erl\"},{line,445}]},{riak\_pipe\_vnode\_worker,...}]”}

That binary (&lt;&lt;69,1,71…&gt;&gt;) says CRDT(69), Version 1(1), riak\_kv\_pncounter (71). 
The error says that erlang is trying to apply the Module, Function, Arguments 
of &lt;&lt;“riak\_kv\_pncounter”&gt;&gt;, new, []. But modules need to be atoms.

&gt; Just to help, this is my erlang MR code:
&gt; value(RiakObject, \_KeyData, \_Arg) -&gt;
&gt; Key = riak\_object:key(RiakObject),
&gt; Count = riak\_kv\_crdt:value(RiakObject, &lt;&lt;"riak\_kv\_pncounter"&gt;&gt;),

Type needs to be an atom, as it is the module name (so riak\_kv\_pncounter). 
Also, the return value is now a tuple of

 {{Context :: binary(), Value :: term()}, Stats :: proplist()}. You probably 
only want the Value bit. So:

 {{\_Ctx, Count}, \_Stats} = riak\_kv\_crdt:value(RiakObject, riak\_kv\_pncounter),

Should be what you need, let me know if that works, please?

Cheers

Russell

&gt; [ {Key, Count} ].
&gt; 
&gt; What am I doing wrong? I can't seem to figure it out... I'm sure its 
&gt; something simple thing I'm just not seeing.
&gt; 
&gt; Thanks again,
&gt; Bryce
&gt; 
&gt; On 01/23/2014 01:07 PM, Russell Brown wrote:
&gt;&gt; On 23 Jan 2014, at 20:51, Eric Redmond  wrote:
&gt;&gt; 
&gt;&gt;&gt; For version 1.4 counters, riak\_kv\_pncounter. For 2.0 CRDT counters, 
&gt;&gt;&gt; riak\_dt\_pncounter.
&gt;&gt; As in, if the data was written in 1.4, or in 2.0 using the legacy, backwards 
&gt;&gt; compatible 1.4 API endpoints, the the type is risk\_kv\_pncounter. If the 
&gt;&gt; counter is 2.0, bucket types counter, then risk\_dt\_pncounter.
&gt;&gt; 
&gt;&gt; Really, we need to re-introduce the riak\_kv\_counter module for backwards 
&gt;&gt; compatibility, and add some friendly `value’ functions to risk\_kv\_crdt. I’m 
&gt;&gt; opening an issue for just this now.
&gt;&gt; 
&gt;&gt; The other option is to include the riak\_kv\_types.hrl and use the macros 
&gt;&gt; ?MAP\_TYPE, ?SET\_TYPE, ?V1\_COUNTER\_TYPE, ?COUNTER\_TYPE for now, and assume 
&gt;&gt; that we’ll have some helper functions for MapReduce in before 2.0.
&gt;&gt; 
&gt;&gt; Cheers
&gt;&gt; 
&gt;&gt; Russell
&gt;&gt; 
&gt;&gt;&gt; Eric
&gt;&gt;&gt; 
&gt;&gt;&gt; On Jan 23, 2014, at 3:44 PM, Bryce Verdier  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; In 1.4 there was just the simple function riak\_kv\_counters:value. In 2.0 I 
&gt;&gt;&gt;&gt; found the riak\_kv\_crdt module, which has a value function in it. But I'm 
&gt;&gt;&gt;&gt; not sure what "type" to use for second value argument for a counter.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Can someone share that with me?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thanks in advance,
&gt;&gt;&gt;&gt; Bryce
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

