---
title: "Re: Streaming video from Luwak to browsers not working so well"
description: ""
project: community
lastmod: 2011-09-13T15:39:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04689"
mailinglist_parent_id: "msg04687"
author_name: "John Axel Eriksson"
project_section: "mailinglistitem"
sent_date: 2011-09-13T15:39:42-07:00
---


I have no idea why Safari won't work unfortunately. Perhaps it's the type of
range-requests it's doing - I know Safari is a bit special in this regard
(as are the iDevices). Is there at least a way, other than changing the
erlang code and recompiling, to get luwak to not gzip the response? Seems
that the browsers ask for it even though it won't work. Although the
browsers may be stupid - that's what I have to work with. Another idea I had
was that perhaps I could change the headers when proxying using node.js.

(sorry for the dupe Sean - that got sent only to you).

On Tue, Sep 13, 2011 at 10:40 PM, Sean Cribbs  wrote:

&gt; John,
&gt;
&gt; If the browser negotiated a gzip response, the results when streaming would
&gt; be incorrect (or at least incompatible) if the response were ever larger
&gt; than a single chunk. Webmachine would send each chunk through the gzip
&gt; compressor individually, whereas browsers would expect the entire response
&gt; to be a single gzip blob (with a single header/checksum). At least, that's
&gt; why the gzip thing didn't work. Not sure why Safari broke even when you
&gt; turned that off.
&gt;
&gt; On Tue, Sep 13, 2011 at 4:04 PM, John Axel Eriksson wrote:
&gt;
&gt;&gt; First a little background:
&gt;&gt;
&gt;&gt; We've been putting videos in luwak without much trouble for quite a while
&gt;&gt; now, small and a little bigger (by bigger I mean around 6 or 7 megs).
&gt;&gt;
&gt;&gt; To stream these so far, we've basically done this:
&gt;&gt;
&gt;&gt; Get the web app to download the video over http from luwak and store on
&gt;&gt; local disk.
&gt;&gt; Get nginx, through an x-accel, to actually send it to the client (i.e the
&gt;&gt; browser).
&gt;&gt;
&gt;&gt; For various reasons this isn't really how we want to do it. There is one
&gt;&gt; big reason why we do this currently. We need all clients to authenticate
&gt;&gt; through
&gt;&gt; our rails-app. So we first tried to have rails send an x-accel to nginx
&gt;&gt; which would then proxy to luwak. This won't work because nginx doesn't
&gt;&gt; support
&gt;&gt; http 1.1, chunked encoding and all that jazz to backends at least (it's
&gt;&gt; 2011… why I just don't know).
&gt;&gt;
&gt;&gt; Anyway, for a while now we've thrown node.js into the mix(for other
&gt;&gt; reasons) and recently I started working on some code for node.js to
&gt;&gt; recognize
&gt;&gt; x-sendfile (similar to x-accel). I also made it do the same type of
&gt;&gt; proxying as nginx can do - but this time it does http 1.1. Unfortunately I
&gt;&gt; couldn't get it
&gt;&gt; to work. So I started investigating riak/luwak directly. Could we even
&gt;&gt; stream a video out of luwak directly? No we couldn't. So the problem goes
&gt;&gt; all the
&gt;&gt; way back to riak.
&gt;&gt;
&gt;&gt; Using Safari it won't stream more than a few seconds and then sound and
&gt;&gt; video stops (though the progress bar keeps moving).
&gt;&gt; Using Chrome and Firefox I could stream perhaps half the video before more
&gt;&gt; or less the same thing happened.
&gt;&gt;
&gt;&gt; I then cloned riak and removed one line in
&gt;&gt; deps/luwak/src/luwak\_wm\_file.erl, specifically line 363 - {"gzip",
&gt;&gt; fun(X) -&gt; zlib:gzip(X) end}]. So that the list
&gt;&gt; now only contains [{"identity", fun(X) -&gt; X end}]. (Those are the
&gt;&gt; default\_encodings). I will admit I didn't know exactly what I was doing.
&gt;&gt;
&gt;&gt; Built riak and did some more testing. The results were interesting.
&gt;&gt; Suddenly Chrome and Firefox would play the whole file through (a .webm).
&gt;&gt; Unfortunately Safari still did the same thing, i.e played 4 seconds and
&gt;&gt; then stopped video and sound (while still showing progress).
&gt;&gt;
&gt;&gt; I didn't try IE and quite frankly I'm afraid that one might just blow up
&gt;&gt; my computer…
&gt;&gt;
&gt;&gt; Anyway, I just wanted to ask the list if anyone ever tried the same thing
&gt;&gt; or if any of the good people at basho knows more than I do (which I suspect
&gt;&gt; they do :-).
&gt;&gt;
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; John
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

