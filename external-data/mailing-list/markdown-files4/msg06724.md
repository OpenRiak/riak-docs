---
title: "Re: Faster way to store a lot of small data?"
description: ""
project: community
lastmod: 2012-02-23T23:13:49-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06724"
mailinglist_parent_id: "msg06722"
author_name: "István"
project_section: "mailinglistitem"
sent_date: 2012-02-23T23:13:49-08:00
---


;))

On Thu, Feb 23, 2012 at 11:12 PM, Eric Fong  wrote:

&gt; Hi
&gt;
&gt; 1.1.0 version did save my life...
&gt; Thanks
&gt;
&gt; Eric
&gt;
&gt;
&gt; On Fri, Feb 24, 2012 at 2:30 PM, István  wrote:
&gt;
&gt;&gt; Hi Eric,
&gt;&gt;
&gt;&gt; How feasible is to upgrade to 1.1?
&gt;&gt;
&gt;&gt; I just inserted 27547 png files to Riak using bitcask. I have a test
&gt;&gt; cluster running on my laptop in a linux VM with 8 nodes and 2G ram
&gt;&gt; allocated from the host to it. I am using a SSD drive and this config
&gt;&gt; gives 110 inserts/s. The files are on average 150K. The CPU is pretty idle,
&gt;&gt; the load is 0.3 using 4 cores. (n=3 and the ring size is 128)
&gt;&gt;
&gt;&gt; Cheers,
&gt;&gt; I.
&gt;&gt;
&gt;&gt;
&gt;&gt; On Thu, Feb 23, 2012 at 8:01 PM, Eric Fong  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Russell
&gt;&gt;&gt;
&gt;&gt;&gt; I end up deleted all my old data and start from fresh db.
&gt;&gt;&gt; And use your script to put 23622 pngs (861M) into my localhost riak
&gt;&gt;&gt; again.
&gt;&gt;&gt; It is much faster but also make the riak stop to response and the
&gt;&gt;&gt; riak/data folder getting larger and larger (5GB now).
&gt;&gt;&gt; Seems something wrong...
&gt;&gt;&gt;
&gt;&gt;&gt; I stopped the script but seems riak is still eating my 100% cpu and disk
&gt;&gt;&gt; space.
&gt;&gt;&gt; My server is something like 6 cpu and 48GB Ram already. \*\_\*
&gt;&gt;&gt;
&gt;&gt;&gt; Eric
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Fri, Feb 24, 2012 at 10:08 AM, Eric Fong  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I have a bash script put.sh:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; ----------------------------------------------------------------------------------------------------------
&gt;&gt;&gt;&gt; # upload file
&gt;&gt;&gt;&gt; #
&gt;&gt;&gt;&gt; # Bulk Upload:
&gt;&gt;&gt;&gt; # put.sh local-folder bucket-name prefix-inside-bucket
&gt;&gt;&gt;&gt; #
&gt;&gt;&gt;&gt; file=$1
&gt;&gt;&gt;&gt; bucket=$2
&gt;&gt;&gt;&gt; prefix=$3
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; if [ -d "$file" ]; then
&gt;&gt;&gt;&gt; prefixRemove=$file find $file -type f -exec $0 {} $bucket $prefix \;
&gt;&gt;&gt;&gt; exit 0
&gt;&gt;&gt;&gt; fi
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; if [ -z "$type" ]; then
&gt;&gt;&gt;&gt; type=`file -i $file | awk '{print $2}'`
&gt;&gt;&gt;&gt; fi
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; # escape
&gt;&gt;&gt;&gt; bucket=$(echo $bucket | sed 's/~/~~/g' | sed 's/\/\+/~/g' )
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; key=$file
&gt;&gt;&gt;&gt; key=$(echo $key | sed 's/^\.\/\+//g')
&gt;&gt;&gt;&gt; if [ -n "$prefixRemove" ]; then
&gt;&gt;&gt;&gt; prefixRemove=$(echo $prefixRemove | sed 's/\(\/\)/\\\1/g')
&gt;&gt;&gt;&gt; key=$(echo $key | eval "sed 's/$prefixRemove//g'")
&gt;&gt;&gt;&gt; fi
&gt;&gt;&gt;&gt; key=$(echo $prefix$key | sed 's/~/~~/g' | sed 's/\/\+/~/g')
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; #-H "x-riak-index-date\_int:`date +%s`"
&gt;&gt;&gt;&gt; if [ -z "$test" ]; then
&gt;&gt;&gt;&gt; curl -s -X PUT -T ${file} -H content-type:${type}
&gt;&gt;&gt;&gt; http://magic1:8098/buckets/${bucket}/keys/${key}
&gt;&gt;&gt;&gt; fi
&gt;&gt;&gt;&gt; echo http://magic1:8098/buckets/${bucket}/keys/${key}
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; ----------------------------------------------------------------------------------------------------------
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I think it is similar to what Russell did.
&gt;&gt;&gt;&gt; I think xargs -P is the key!
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I have one machine and all bucket setting is default. Then, I think the
&gt;&gt;&gt;&gt; N is 3
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Actually, I found another problem. Last night, I started to upload a
&gt;&gt;&gt;&gt; lot of small pngs into riak (total size is 900MB and each of them are
&gt;&gt;&gt;&gt; 10KB). This morning, I come back and found that riak eat up 40GB of my
&gt;&gt;&gt;&gt; harddisk and it is 100% full. I try to restart riak few times. Still cannot
&gt;&gt;&gt;&gt; get the whole riak work well again. I am using levelDB. Try to recover the
&gt;&gt;&gt;&gt; whole system first.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Eric
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Thu, Feb 23, 2012 at 10:59 PM, Russell Brown wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On 23 Feb 2012, at 14:37, Jeremiah Peschka wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Out of interest, to those of us who are rusty on their shell
&gt;&gt;&gt;&gt;&gt; scripting, could you share the aforementioned script?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; find png\_test -name "\*.png" -print0 | xargs -0 -P 4 -I file curl
&gt;&gt;&gt;&gt;&gt; -X PUT localhost:8098/riak/file --data-binary @file -H"Content-Type:
&gt;&gt;&gt;&gt;&gt; image/png"
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I'm a shell scripting n00b so there is probably a much better way. In
&gt;&gt;&gt;&gt;&gt; this case png\_test is a directory I created with 1000\*10k pngs. So the
&gt;&gt;&gt;&gt;&gt; bucket name is the directory name 'png\_test'. Only works for a flat dir, 
&gt;&gt;&gt;&gt;&gt; it
&gt;&gt;&gt;&gt;&gt; was just something to check the times that Eric mentioned, please don't
&gt;&gt;&gt;&gt;&gt; think it is like a working script or anything.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Cheers
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Russell
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; ---
&gt;&gt;&gt;&gt;&gt; Jeremiah Peschka
&gt;&gt;&gt;&gt;&gt; Managing Director, Brent Ozar PLF, LLC
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On Thu, Feb 23, 2012 at 2:02 AM, Russell Brown wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Hi Eric,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On 23 Feb 2012, at 08:45, Eric Fong wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Hi
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Help. I want to store few thousands of small png (each of them will
&gt;&gt;&gt;&gt;&gt;&gt; just be 10K) into riak.
&gt;&gt;&gt;&gt;&gt;&gt; &gt; But I find that is really slow (1 to 2 second for one png).
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Currently, I use a bash script to find and loop the directory
&gt;&gt;&gt;&gt;&gt;&gt; &gt; And curl PUT the png onto riak.
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Do we have a bulk upload or will it be faster if I use erlang or or
&gt;&gt;&gt;&gt;&gt;&gt; driver?
&gt;&gt;&gt;&gt;&gt;&gt; &gt; I need to upload 1000 small png within one minute. Can it be done?
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; I imagine it is possible. I just managed to do it in 10seconds on my
&gt;&gt;&gt;&gt;&gt;&gt; laptop, single node with n=3 and r=2 using xargs and curl to put in
&gt;&gt;&gt;&gt;&gt;&gt; parallel.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; How many nodes do you have? What is your n-val?
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; cheers
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Russell
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Currently, I am on riak 1.01 and levelDB backend.
&gt;&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Thanks a lot!
&gt;&gt;&gt;&gt;&gt;&gt; &gt; --
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Best Regards,
&gt;&gt;&gt;&gt;&gt;&gt; &gt; Eric Fong
&gt;&gt;&gt;&gt;&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; Best Regards,
&gt;&gt;&gt;&gt; Eric Fong
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Best Regards,
&gt;&gt;&gt; Eric Fong
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; the sun shines for all
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Best Regards,
&gt; Eric Fong
&gt;



-- 
the sun shines for all
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

