---
title: "Re: Runaway \"Failed to compact\" errors"
description: ""
project: community
lastmod: 2013-11-24T17:01:55-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13084"
mailinglist_parent_id: "msg13083"
author_name: "Justin Long"
project_section: "mailinglistitem"
sent_date: 2013-11-24T17:01:55-08:00
---


Update: after checking the Java-client and my bucket code I noticed that I am 
doing the following:

val bucket = DB.client.createBucket(bucketName).enableForSearch().execute()

I have a feeling that “enableForSearch” is causing each object in its entirety 
to be indexed, instead of the explicit fields. Checking this Javadoc 
http://basho.github.io/riak-java-client/1.0.5/com/basho/riak/client/bucket/WriteBucket.html
 shows that search=true is written for the bucket.

Would that cause the entire object to be indexed, not just the explicit fields?



On Nov 24, 2013, at 3:02 PM, Justin Long  wrote:

&gt; Interesting, as I mentioned previously any objects in the “collector” buckets 
&gt; all share the same structure. It is trying to index a field that is actually 
&gt; inside a String. “data\_followers” is a key inside the “data” map and the 
&gt; value for that key is escaped JSON (it goes into offline processing FYI 
&gt; later). And as you can see there isn’t any indexing set for that field.
&gt; 
&gt; 
&gt; On Nov 24, 2013, at 2:56 PM, Joe Caswell  wrote:
&gt; 
&gt;&gt; Justin,
&gt;&gt; 
&gt;&gt; The binary in the log entry below equates to:
&gt;&gt; {&lt;&lt;"collector-collect-twitter"&gt;&gt;,&lt;&lt;"data\_followers"&gt;&gt;,&lt;&lt;32897-byte string&gt;&gt;}
&gt;&gt; 
&gt;&gt; Hope this helps.
&gt;&gt; 
&gt;&gt; Joe
&gt;&gt; From: Justin Long 
&gt;&gt; Date: Sunday, November 24, 2013 5:17 PM
&gt;&gt; To: Joe Caswell 
&gt;&gt; Cc: Richard Shaw , riak-users 
&gt;&gt; Subject: Re: Runaway "Failed to compact" errors
&gt;&gt; 
&gt;&gt; Thanks Joe. I would agree that would probably be the problem. I am concerned 
&gt;&gt; since none of the fields of objects I am storing in Riak would produce a key 
&gt;&gt; larger than 32kb. Here’s a sample Scala (Java-based) POJO that represents an 
&gt;&gt; object in the problem bucket using the Riak-Java-Client:
&gt;&gt; 
&gt;&gt; case class InstagramCache(
&gt;&gt; @(JsonProperty@field)("identityId")
&gt;&gt; @(RiakKey@field)
&gt;&gt; val identityId: String, // ID of user on social network
&gt;&gt; 
&gt;&gt; @(JsonProperty@field)("userId")
&gt;&gt; @(RiakIndex@field)(name = "userId")
&gt;&gt; val userId: String, // associated user ID on platform
&gt;&gt; 
&gt;&gt; @(JsonProperty@field)("data")
&gt;&gt; val data: Map[String, Option[String]],
&gt;&gt; 
&gt;&gt; @(JsonProperty@field)("updated")
&gt;&gt; var updated: Date
&gt;&gt; 
&gt;&gt; )
&gt;&gt; 
&gt;&gt; The fields identityId and userId would rarely exceed 30 characters. Is Riak 
&gt;&gt; trying to index the whole object?
&gt;&gt; 
&gt;&gt; Thanks
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Nov 24, 2013, at 2:11 PM, Joe Caswell  wrote:
&gt;&gt; 
&gt;&gt;&gt; Justin,
&gt;&gt;&gt; 
&gt;&gt;&gt; The terms being stored in merge index are too large. The maximum size for 
&gt;&gt;&gt; an {Index, Field, Term} key is 32k bytes.
&gt;&gt;&gt; The binary blob in your log entry represents a tuple that was 32952 bytes. 
&gt;&gt;&gt; Since merge index uses a 15-bit integer to store term size, if the 
&gt;&gt;&gt; term\_to\_binary of the given key is larger than 32767, high bits are lost, 
&gt;&gt;&gt; effectively storing ( mod 32767) bytes.
&gt;&gt;&gt; When this data is read back, binary\_to\_term is unable to reconstruct the 
&gt;&gt;&gt; key due the missing bytes, and throws a badarg exception.
&gt;&gt;&gt; 
&gt;&gt;&gt; Search index repair is document here: 
&gt;&gt;&gt; http://docs.basho.com/riak/1.4.0/cookbooks/Repairing-Search-Indexes/ 
&gt;&gt;&gt; However, you would need to first modify your extractor to not produce 
&gt;&gt;&gt; search keys larger than 32k or the corruption issues will recur.
&gt;&gt;&gt; 
&gt;&gt;&gt; Joe Caswell
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; From: Richard Shaw 
&gt;&gt;&gt; Date: Sunday, November 24, 2013 4:25 PM
&gt;&gt;&gt; To: Justin Long 
&gt;&gt;&gt; Cc: riak-users 
&gt;&gt;&gt; Subject: Re: Runaway "Failed to compact" errors
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

