---
title: "Re: Pruning (merging) after storage reaches a certain size?"
description: ""
project: community
lastmod: 2011-06-13T15:19:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03676"
mailinglist_parent_id: "msg03675"
author_name: "Chad DePue"
project_section: "mailinglistitem"
sent_date: 2011-06-13T15:19:42-07:00
---


that's a hex number or 2147483648 decimal

Chad DePue
inakanetworks.com - development consulting | skype cdepue | @chaddepue
+1 206.866.5707



On Mon, Jun 13, 2011 at 7:08 PM, Steve Webb  wrote:

&gt; Dan -
&gt;
&gt; Q: What does the syntax: 16#80000000 represent in the max\_file\_size
&gt; parameter? It's supposed to be 2GB, but I can't see where that means 2GB
&gt; anywhere.
&gt;
&gt; Even if that meant 16 files of 80MB each, that only comes out to slightly
&gt; over 1GB.
&gt;
&gt;
&gt; - Steve
&gt;
&gt; --
&gt; Steve Webb - Senior System Administrator for gnip.com
&gt; http://twitter.com/GnipWebb
&gt;
&gt; On Mon, 13 Jun 2011, Dan Reverri wrote:
&gt;
&gt; Hi Steve,
&gt;&gt;
&gt;&gt; The article points out that the active data file is not considered during
&gt;&gt; merge checks. Your 250-ish MB data file is the active file and not
&gt;&gt; considered during the merge check. The file will eventually role over to a
&gt;&gt; non-active file when it hits 2 GB in size. Once the file is not active it
&gt;&gt; will be considered during the merge check and merging will take place.
&gt;&gt;
&gt;&gt; The 2 GB file size is configurable via the max\_file\_size parameter:
&gt;&gt; https://github.com/basho/bitcask/blob/master/ebin/bitcask.app#L22
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Dan
&gt;&gt;
&gt;&gt; Daniel Reverri
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; d...@basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, Jun 13, 2011 at 2:38 PM, Steve Webb  wrote:
&gt;&gt;
&gt;&gt; Dan -
&gt;&gt;&gt;
&gt;&gt;&gt; I've got dead\_bytes\_threshold=5242880 (5M) and
&gt;&gt;&gt; dead\_bytes\_merge\_trigger=10242880. My bitcask \*.data files are 250-ish
&gt;&gt;&gt; MB
&gt;&gt;&gt; in size:
&gt;&gt;&gt;
&gt;&gt;&gt; root@ha2
&gt;&gt;&gt; :/data/riaksearch/bitcask/1027618338748291114361965898003636498195577569280#
&gt;&gt;&gt; ls -lah
&gt;&gt;&gt; total 771M
&gt;&gt;&gt; drwxr-xr-x 2 riak riak 4.0K 2011-06-12 01:08 .
&gt;&gt;&gt; drwxr-xr-x 34 riak riak 4.0K 2011-06-12 01:10 ..
&gt;&gt;&gt; -rw------- 1 riak riak 229M 2011-06-08 13:11 1307415077.bitcask.data
&gt;&gt;&gt; -rw-r--r-- 1 riak riak 4.3M 2011-06-08 13:11 1307415077.bitcask.hint
&gt;&gt;&gt; -rw------- 1 riak riak 276M 2011-06-10 13:30 1307562153.bitcask.data
&gt;&gt;&gt; -rw-r--r-- 1 riak riak 5.1M 2011-06-10 13:30 1307562153.bitcask.hint
&gt;&gt;&gt; -rw------- 1 riak riak 1.4M 2011-06-08 13:45 1307562333.bitcask.data
&gt;&gt;&gt; -rw-r--r-- 1 riak riak 27K 2011-06-08 13:45 1307562333.bitcask.hint
&gt;&gt;&gt; -rw------- 1 riak riak 246M 2011-06-13 15:34 1307862506.bitcask.data
&gt;&gt;&gt; -rw-r--r-- 1 riak riak 9.4M 2011-06-13 15:34 1307862506.bitcask.hint
&gt;&gt;&gt; -rw------- 1 riak riak 107 2011-06-12 01:08 bitcask.write.lock
&gt;&gt;&gt;
&gt;&gt;&gt; I'm pretty sure that 50% or more of the data in these files should've
&gt;&gt;&gt; aged-off by now and the merge trigger should've happened. The article
&gt;&gt;&gt; shows
&gt;&gt;&gt; why merges happen when a restart is done, but it doesn't really explain
&gt;&gt;&gt; why
&gt;&gt;&gt; merges don't happen at normal runtime.
&gt;&gt;&gt;
&gt;&gt;&gt; I really don't want to restart riak every day to merge files.
&gt;&gt;&gt;
&gt;&gt;&gt; Q: What are some good trigger settings for my use case?
&gt;&gt;&gt;
&gt;&gt;&gt; I want to collect and store 1 day worth of tweets from the twitter
&gt;&gt;&gt; spritzer
&gt;&gt;&gt; feed and have the data files auto-merge once in a while (once a day or
&gt;&gt;&gt; more
&gt;&gt;&gt; frequently) when they've gotten 10% of 'dead' data in them (aka, the
&gt;&gt;&gt; tweets
&gt;&gt;&gt; expire after 1 day).
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; - Steve
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Steve Webb - Senior System Administrator for gnip.com
&gt;&gt;&gt; http://twitter.com/GnipWebb
&gt;&gt;&gt;
&gt;&gt;&gt; On Mon, 13 Jun 2011, Dan Reverri wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Steve,
&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; This Knowledge Base article may be related:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; https://help.basho.com/entries/20141178-why-does-it-seem-that-bitcask-merging-is-only-triggered-when-a-riak-node-is-restarted
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt; Dan
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Daniel Reverri
&gt;&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt; d...@basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Mon, Jun 13, 2011 at 10:25 AM, Steve Webb  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Justin -
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; My current bitcask settings are:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; %% Bitcask Config
&gt;&gt;&gt;&gt;&gt; {bitcask, [
&gt;&gt;&gt;&gt;&gt; {data\_root, "/var/lib/riaksearch/bitcask" },
&gt;&gt;&gt;&gt;&gt; {dead\_bytes\_merge\_trigger, 10242880 },
&gt;&gt;&gt;&gt;&gt; {dead\_bytes\_threshold, 5242880 },
&gt;&gt;&gt;&gt;&gt; {expiry\_secs, 86400}
&gt;&gt;&gt;&gt;&gt; ]},
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; My understanding of these settings mean that the data should
&gt;&gt;&gt;&gt;&gt; auto-expire
&gt;&gt;&gt;&gt;&gt; after one day. Also, once each bitcask file in
&gt;&gt;&gt;&gt;&gt; .../riaksearch/bitcask/xxx/\*.data once it has 10M of "dead" or expired
&gt;&gt;&gt;&gt;&gt; data
&gt;&gt;&gt;&gt;&gt; in it, should be merged, right?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I'm collecting the spritzer twitter stream and loading it into two
&gt;&gt;&gt;&gt;&gt; buckets
&gt;&gt;&gt;&gt;&gt; (one non-indexed bucket holds the full tweet, one indexed bucket holds
&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt; tweet string, id, date and username). I used to see about 10 GB of
&gt;&gt;&gt;&gt;&gt; data
&gt;&gt;&gt;&gt;&gt; total, but it's growing and currently at 26GB of data total.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I'm seeing these in the logs:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; INFO REPORT==== 13-Jun-2011::08:28:19 ===
&gt;&gt;&gt;&gt;&gt; Pid &lt;0.6844.0&gt; compacted 3 segments for 942232 bytes in 4.900694
&gt;&gt;&gt;&gt;&gt; seconds,
&gt;&gt;&gt;&gt;&gt; 0.18 MB/sec
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; =INFO REPORT==== 13-Jun-2011::08:29:01 ===
&gt;&gt;&gt;&gt;&gt; Pid &lt;0.6267.0&gt; compacted 3 segments for 1721790 bytes in 9.690511
&gt;&gt;&gt;&gt;&gt; seconds,
&gt;&gt;&gt;&gt;&gt; 0.17 MB/sec
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; =INFO REPORT==== 13-Jun-2011::08:31:23 ===
&gt;&gt;&gt;&gt;&gt; Pid &lt;0.6924.0&gt; compacted 3 segments for 6988416 bytes in 44.659753
&gt;&gt;&gt;&gt;&gt; seconds,
&gt;&gt;&gt;&gt;&gt; 0.15 MB/sec
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; ... but I'm not seeing any "merging" related entries.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; - Steve
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt; Steve Webb - Senior System Administrator for gnip.com
&gt;&gt;&gt;&gt;&gt; http://twitter.com/GnipWebb
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On Wed, 8 Jun 2011, Justin Sheehy wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Hi, Steve.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Check out this page:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; http://wiki.basho.com/Bitcask-Configuration.html#Disk-Usage-and-Merging-Settings
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Basically, a "merge trigger" must be met in order to have the merge
&gt;&gt;&gt;&gt;&gt;&gt; process occur. When it does occur, it will affect all existing files
&gt;&gt;&gt;&gt;&gt;&gt; that
&gt;&gt;&gt;&gt;&gt;&gt; meet a "merge threshold."
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; One note that is relevant for your specific use: the expiry\_secs
&gt;&gt;&gt;&gt;&gt;&gt; parameter
&gt;&gt;&gt;&gt;&gt;&gt; will cause a given item to disappear from the client API immediately
&gt;&gt;&gt;&gt;&gt;&gt; after
&gt;&gt;&gt;&gt;&gt;&gt; expiry, and to be cleaned if it is in a file already being merged, but
&gt;&gt;&gt;&gt;&gt;&gt; will
&gt;&gt;&gt;&gt;&gt;&gt; not currently contribute toward merge triggers or thresholds on its
&gt;&gt;&gt;&gt;&gt;&gt; own
&gt;&gt;&gt;&gt;&gt;&gt; if
&gt;&gt;&gt;&gt;&gt;&gt; not otherwise "dead".
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; -Justin
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On Jun 7, 2011, at 4:29 PM, Steve Webb wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Hello there.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I'm curious - I'm up to about 10GB of storage and I'm guessing that
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I'll
&gt;&gt;&gt;&gt;&gt;&gt;&gt; be full in 3-4 more days of ingesting data. I have no idea if/when a
&gt;&gt;&gt;&gt;&gt;&gt;&gt; merge
&gt;&gt;&gt;&gt;&gt;&gt;&gt; will run to expire the older data.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I'm loading a 2-node (1GB mem, 20GB storage, vmware VMs) riaksearch
&gt;&gt;&gt;&gt;&gt;&gt;&gt; cluster with the spritzer twitter feed. I used the bitcask
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 'expiry\_secs' to
&gt;&gt;&gt;&gt;&gt;&gt;&gt; expire data after 3 days. Q: Is there a method or command to force a
&gt;&gt;&gt;&gt;&gt;&gt;&gt; merge
&gt;&gt;&gt;&gt;&gt;&gt;&gt; at any time? Q: Is there a way to run a merge when the storage size
&gt;&gt;&gt;&gt;&gt;&gt;&gt; reaches
&gt;&gt;&gt;&gt;&gt;&gt;&gt; a specific threshold?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; - Steve
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Steve Webb - Senior System Administrator for gnip.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://twitter.com/GnipWebb
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

