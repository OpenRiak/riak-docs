---
title: "Re: ssl support?"
description: ""
project: community
lastmod: 2012-07-13T11:41:18-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07924"
mailinglist_parent_id: "msg07923"
author_name: "John E. Vincent"
project_section: "mailinglistitem"
sent_date: 2012-07-13T11:41:18-07:00
---


SSL is working for me (for riak-control) using self-signed
certificates. However I've not yet tried it with an external client.

On Fri, Jul 13, 2012 at 2:34 PM, Michael Johnson  wrote:
&gt; I've been having problems getting riak to function via https and have not
&gt; been able to find anything online that seems to help so far. I am using a
&gt; self-signed certificate (which is one I generated specifically for this
&gt; testing, and thus could post as it will not be used for anything else) and
&gt; have it stored as separate .crt and .key files. I've used open SSL to
&gt; verify the certificate and it appears to be all good. Here is what the
&gt; relevant bits of my app.config look like (I can post the rest as needed, but
&gt; I'm trying to be consise):
&gt;
&gt; {http, [{"0.0.0.0", 8091}]},
&gt; {https, [{"0.0.0.0", 8092}]},
&gt; {ssl, [
&gt; {certfile, "/etc/riak/ssl.crt"},
&gt; {keyfile, "/etc/riak/ssl.key"}
&gt; ]},
&gt;
&gt; Starting riak does not generate any errors, and 'riak-admin test' works:
&gt; [root@riak01 riak]# riak-admin test
&gt; Attempting to restart script through sudo -u riak
&gt; Successfully completed 1 read/write cycle to 'r...@riak01.mediatemple.net'
&gt;
&gt; Manuallly querying riak via http also works fine:
&gt;
&gt; [root@riak01 riak]# curl -k -vvv
&gt; http://127.0.0.1:8091/riak/\_\_riak\_client\_test\_\_
&gt; \* About to connect() to 127.0.0.1 port 8091 (#0)
&gt; \* Trying 127.0.0.1... connected
&gt; \* Connected to 127.0.0.1 (127.0.0.1) port 8091 (#0)
&gt;&gt; GET /riak/\_\_riak\_client\_test\_\_ HTTP/1.1
&gt;&gt; User-Agent: curl/7.19.7 (x86\_64-redhat-linux-gnu) libcurl/7.19.7
&gt;&gt; NSS/3.13.1.0 zlib/1.2.3 libidn/1.18 libssh2/1.2.2
&gt;&gt; Host: 127.0.0.1:8091
&gt;&gt; Accept: \*/\*
&gt;&gt;
&gt; &lt; HTTP/1.1 200 OK
&gt; &lt; Vary: Accept-Encoding
&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt; &lt; Date: Fri, 13 Jul 2012 18:03:13 GMT
&gt; &lt; Content-Type: application/json
&gt; &lt; Content-Length: 410
&gt; &lt;
&gt; \* Connection #0 to host 127.0.0.1 left intact
&gt; \* Closing connection #0
&gt; {"props":{"name":"\_\_riak\_client\_test\_\_","allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":1,"last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":1,"notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":1,"rw":1,"small\_vclock":50,"w":1,"young\_vclock":20}}
&gt;
&gt;
&gt; But the minute I try to connect via https I have problems:
&gt;
&gt; [root@riak01 riak]# curl -k -vvv
&gt; https://127.0.0.1:8092/riak/\_\_riak\_client\_test\_\_
&gt; \* About to connect() to 127.0.0.1 port 8092 (#0)
&gt; \* Trying 127.0.0.1... connected
&gt; \* Connected to 127.0.0.1 (127.0.0.1) port 8092 (#0)
&gt; \* Initializing NSS with certpath: sql:/etc/pki/nssdb
&gt; \* warning: ignoring value of ssl.verifyhost
&gt; \* NSS error -5938
&gt; \* Closing connection #0
&gt; \* SSL connect error
&gt; curl: (35) SSL connect error
&gt;
&gt; And I see the following in the logs:
&gt;
&gt; console.log:
&gt; 2012-07-13 11:05:52.023 [error] &lt;0.5313.0&gt; CRASH REPORT Process &lt;0.5313.0&gt;
&gt; with 0 neighbours crashed with reason:
&gt; {ekeyfile,[{gen\_fsm,init\_it,6},{proc\_lib,init\_p\_do\_apply,3}]}
&gt; 2012-07-13 11:05:52.026 [error] &lt;0.134.0&gt; Supervisor ssl\_connection\_sup had
&gt; child undefined started with {ssl\_connection,start\_link,undefined} at
&gt; &lt;0.5313.0&gt; exit with reason ekeyfile in context child\_terminated
&gt; 2012-07-13 11:05:52.031 [error] &lt;0.139.0&gt; application: mochiweb, "Accept
&gt; failed error", "{error,ekeyfile}"
&gt; 2012-07-13 11:05:52.033 [error] &lt;0.139.0&gt; CRASH REPORT Process &lt;0.139.0&gt;
&gt; with 0 neighbours crashed with reason: {error,accept\_failed}
&gt; 2012-07-13 11:05:52.035 [error] &lt;0.135.0&gt;
&gt; {mochiweb\_socket\_server,310,{acceptor\_error,{error,accept\_failed}}}
&gt;
&gt; crash.log:
&gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt; [83,83,76,58,32,"1112",58,32,"error",58,"[]",32,"/etc/riak/ssl.key","\n",32,32,[91,[[123,["ssl\_connection",44,"init\_private\_key",44,"5"],125],44,10,"
&gt; ",[123,["ssl\_connection",44,"ssl\_init",44,"2"],125],44,10,"
&gt; ",[123,["ssl\_connection",44,"init",44,"1"],125],44,10,"
&gt; ",[123,["gen\_fsm",44,"init\_it",44,"6"],125],44,10,"
&gt; ",[123,["proc\_lib",44,"init\_p\_do\_apply",44,"3"],125]],93],"\n"]2012-07-13
&gt; 11:05:52 =CRASH REPORT====
&gt; crasher:
&gt; initial call: ssl\_connection:init/1
&gt; pid: &lt;0.5313.0&gt;
&gt; registered\_name: []
&gt; exception exit: ekeyfile
&gt; in function gen\_fsm:init\_it/6
&gt; in call from proc\_lib:init\_p\_do\_apply/3
&gt; ancestors: [ssl\_connection\_sup,ssl\_sup,&lt;0.130.0&gt;]
&gt; messages: []
&gt; links: [&lt;0.134.0&gt;]
&gt; dictionary: []
&gt; trap\_exit: false
&gt; status: running
&gt; heap\_size: 1597
&gt; stack\_size: 24
&gt; reductions: 1185
&gt; neighbours:
&gt; 2012-07-13 11:05:52 =SUPERVISOR REPORT====
&gt; Supervisor: {local,ssl\_connection\_sup}
&gt; Context: child\_terminated
&gt; Reason: ekeyfile
&gt; Offender:
&gt; [{pid,&lt;0.5313.0&gt;},{name,undefined},{mfargs,{ssl\_connection,start\_link,undefined}},{restart\_type,temporary},{shutdown,4000},{child\_type,worker}]
&gt;
&gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt; [{application,mochiweb},"Accept failed error","{error,ekeyfile}"]2012-07-13
&gt; 11:05:52 =CRASH REPORT====
&gt; crasher:
&gt; initial call: mochiweb\_acceptor:init/3
&gt; pid: &lt;0.139.0&gt;
&gt; registered\_name: []
&gt; exception exit: {error,accept\_failed}
&gt; in function mochiweb\_acceptor:init/3
&gt; in call from proc\_lib:init\_p\_do\_apply/3
&gt; ancestors: ['https\_0.0.0.0:8092',riak\_core\_sup,&lt;0.88.0&gt;]
&gt; messages: []
&gt; links: [&lt;0.135.0&gt;,#Port&lt;0.5661&gt;]
&gt; dictionary: []
&gt; trap\_exit: false
&gt; status: running
&gt; heap\_size: 233
&gt; stack\_size: 24
&gt; reductions: 818
&gt; neighbours:
&gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt; {mochiweb\_socket\_server,310,{acceptor\_error,{error,accept\_failed}}}
&gt;
&gt; erlang.log.1 and error.log (which are identical):
&gt; 11:05:52.018 [error] SSL: 1112: error:[] /etc/riak/ssl.key
&gt; [{ssl\_connection,init\_private\_key,5},
&gt; {ssl\_connection,ssl\_init,2},
&gt; {ssl\_connection,init,1},
&gt; {gen\_fsm,init\_it,6},
&gt; {proc\_lib,init\_p\_do\_apply,3}]
&gt;
&gt; 11:05:52.023 [error] CRASH REPORT Process &lt;0.5313.0&gt; with 0 neighbours
&gt; crashed with reason:
&gt; {ekeyfile,[{gen\_fsm,init\_it,6},{proc\_lib,init\_p\_do\_apply,3}]}
&gt; 11:05:52.026 [error] Supervisor ssl\_connection\_sup had child undefined
&gt; started with {ssl\_connection,start\_link,undefined} at &lt;0.5313.0&gt; exit with
&gt; reason ekeyfile in context child\_terminated
&gt; 11:05:52.031 [error] application: mochiweb, "Accept failed error",
&gt; "{error,ekeyfile}"
&gt; 11:05:52.033 [error] CRASH REPORT Process &lt;0.139.0&gt; with 0 neighbours
&gt; crashed with reason: {error,accept\_failed}
&gt; 11:05:52.035 [error]
&gt; {mochiweb\_socket\_server,310,{acceptor\_error,{error,accept\_failed}}}
&gt;
&gt;
&gt; Everything I am finding says this means my key file is bad. However, as
&gt; previously mentioned, I've verified this with openssl:
&gt;
&gt; [root@riak01 riak]# openssl verify /etc/riak/ssl.crt
&gt; /etc/riak/ssl.crt: C = US, ST = California, L = Culver City, O = Default
&gt; Company Ltd, CN = example.com, emailAddress = ad...@example.com
&gt; error 18 at 0 depth lookup:self signed certificate
&gt; OK
&gt;
&gt; [root@riak01 riak]# ( openssl x509 -noout -modulus -in /etc/riak/ssl.crt |
&gt; openssl md5; openssl rsa -noout -modulus -in /etc/riak/ssl.key | openssl md5
&gt; ) | uniq
&gt; (stdin)= b3d4187d8472f2d0b73cf5597d5d65b8
&gt;
&gt;
&gt; I'm just really not sure what else to look at. Everything seems to be fine
&gt; except for that fact it's not working. Does anybody have SSL working with
&gt; self-signed certificate using the basho provided binary packages on CentOS
&gt; 6.3? I'm beginning to thing that they might be the problem and I just don't
&gt; know where to go from here.
&gt;
&gt; Any suggestions will be appreciated.
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

