---
title: "Re: luwak questions"
description: ""
project: community
lastmod: 2011-02-23T06:57:25-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02417"
mailinglist_parent_id: "msg02406"
author_name: "Bryan Fink"
project_section: "mailinglistitem"
sent_date: 2011-02-23T06:57:25-08:00
---


On Tue, Feb 22, 2011 at 12:17 PM, francisco treacy
 wrote:
&gt;&gt; db.add({ bucket: 'luwak\_tld', key\_filters: [['starts\_with', 
&gt;&gt; 'e276814e96e0616eb7c07d3bb744d333']]}).map(function(v) { return [1] }).run()
&gt; POST /mapred
&gt;&gt; { message: 'HTTP error 500: {"error":"bad\_json"}'
&gt; , stack: [Getter/Setter]
&gt; , statusCode: 500
&gt; , notFound: false
&gt; }
&gt;
&gt; but I get "bad\_json" errors... Any other bucket works just fine. Why
&gt; won't this work like a regular bucket?

The data stored in the luwak\_tld Riak objects is an Erlang term that
is not directly convertible to JSON. Riak is trying to convert that
object to JSON in order to hand it to the Javascript map function you
specified.

I recommend using riak\_kv\_mapreduce:reduce\_identity/2 in a reduce
phase, instead of that Javascript map phase to assemble your keylist.
That will avoid the JSON conversion in two ways: it's Erlang native
(so it doesn't need the conversion), and reduce phases don't both with
reading the object from storage anyway. If you really do need to look
at the object before deciding whether or not its key qualifies, you'll
need to code your logic in an Erlang function instead of Javascript.

If you need something closer to the Javascript function in your
example (which could be used to produce a count of the filtered keys,
instead of the keys themselves), I have a 'reduce\_count\_inputs'
function waiting in a pull request:
https://github.com/basho/riak\_kv/pull/32

-Bryan

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

