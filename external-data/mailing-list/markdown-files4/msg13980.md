---
title: "Re: very slow write speed to riak-cs"
description: ""
project: community
lastmod: 2014-04-02T20:49:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13980"
mailinglist_parent_id: "msg13975"
author_name: "Stanislav Vlasov"
project_section: "mailinglistitem"
sent_date: 2014-04-02T20:49:15-07:00
---


2014-04-02 19:38 GMT+06:00 Luke Bakken :

&gt; In your Riak /etc/riak/app.config files, please use the following value:
&gt;
&gt; {pb\_backlog, 256},

I try even {pb\_backlog, 512} - no changes.

&gt; After changing this, you will have to restart Riak in a rolling fashion.

&gt; Could you please run riak-debug on one node in your cluster and make the
&gt; generated archive available? (dropbox, for instance).

# riak-debug
............................................./usr/sbin/riak-debug:
538: [: =: argument expected
Unable to locate be\_default LevelDB data directory. Aborting.
Using riak\_kv\_eleveldb\_backend data\_root:

Generated data in archive: http://ovh.to/QmPhSAy

&gt; Also, could you run
&gt; tar -czf /tmp/riak-cs-$(hostname).tgz and make the archive available?

What data you need in archive if not debug info?

&gt; Thanks
&gt; --
&gt; Luke Bakken
&gt; CSE
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Tue, Apr 1, 2014 at 9:32 PM, Stanislav Vlasov 
&gt; wrote:
&gt;&gt;
&gt;&gt; Hello!
&gt;&gt;
&gt;&gt; I have 8x cluster of riak+riak-cs on debian. Config templates attached
&gt;&gt; Versions:
&gt;&gt; ii riak 1.4.8-1
&gt;&gt; amd64 Riak is a distributed data store
&gt;&gt; ii riak-cs 1.4.5-1
&gt;&gt; amd64 Riak CS
&gt;&gt;
&gt;&gt; Every riak-cs connect to local node. Between clients and riak-cs exist
&gt;&gt; frontend (Tengine version: Tengine/1.5.1 (nginx/1.2.9)), config
&gt;&gt; attached
&gt;&gt; Clients - s3cmd + some numbers of php (read-only)
&gt;&gt;
&gt;&gt; When 1-3 clients wants write to riak-cs, write speed is near 3-4MB/sec.
&gt;&gt; If 30-40 clients wants write, write speed slow down to lower than
&gt;&gt; 100kB/sec.
&gt;&gt;
&gt;&gt; In riak-cs crash.log:
&gt;&gt;
&gt;&gt; 2014-04-02 03:52:11 =ERROR REPORT====
&gt;&gt; webmachine error:
&gt;&gt; path="/buckets/test/objects/win.img/uploads/PuqEyz0BRCCk6rDxtH7tRQ=="
&gt;&gt;
&gt;&gt; {error,{error,{badmatch,{error,closed}},[{webmachine\_request,recv\_unchunked\_body,3,[{file,"src/webmachine\_request.erl"},{line,474}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,193}]},{wrq,stream\_req\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\_cs\_wm\_object\_upload\_part,accept\_body,2,[{file,"src/riak\_cs\_wm\_object\_upload\_part.erl"},{line,235}]},{riak\_cs\_wm\_common,accept\_body,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,337}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,[{file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]}}
&gt;&gt;
&gt;&gt; [{webmachine\_request,recv\_unchunked\_body,3,[{file,"src/webmachine\_request.erl"},{line,474}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,193}]},{wrq,stream\_req\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\_cs\_wm\_object\_upload\_part,accept\_body,2,[{file,"src/riak\_cs\_wm\_object\_upload\_part.erl"},{line,235}]},{riak\_cs\_wm\_common,accept\_body,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,337}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,[{file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]
&gt;&gt;
&gt;&gt; After this event s3cmd makes throttling to slower speed:
&gt;&gt;
&gt;&gt; $ s3cmd put win.img s3://test/
&gt;&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt;&gt; 184320 of 15728640 1% in 0s 2.16 MB/s failed
&gt;&gt; WARNING: Upload failed:
&gt;&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt;&gt; Connection reset by peer)
&gt;&gt; WARNING: Retrying on lower speed (throttle=0.00)
&gt;&gt; WARNING: Waiting 3 sec...
&gt;&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt;&gt; 13799424 of 15728640 87% in 2s 5.18 MB/s failed
&gt;&gt; WARNING: Upload failed:
&gt;&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt;&gt; Connection reset by peer)
&gt;&gt; WARNING: Retrying on lower speed (throttle=0.01)
&gt;&gt; WARNING: Waiting 6 sec...
&gt;&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt;&gt; 167936 of 15728640 1% in 0s 249.46 kB/s failed
&gt;&gt; WARNING: Upload failed:
&gt;&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt;&gt; Connection reset by peer)
&gt;&gt; WARNING: Retrying on lower speed (throttle=0.05)
&gt;&gt; WARNING: Waiting 9 sec...
&gt;&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt;&gt; 6225920 of 15728640 39% in 76s 79.51 kB/s failed
&gt;&gt; WARNING: Upload failed:
&gt;&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt;&gt; Connection reset by peer)
&gt;&gt; WARNING: Retrying on lower speed (throttle=0.25)
&gt;&gt; WARNING: Waiting 12 sec...
&gt;&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt;&gt; 15728640 of 15728640 100% in 962s 15.96 kB/s done
&gt;&gt;
&gt;&gt; I think, even on 1Gbit network betwen nodes, write speed should be
&gt;&gt; higher, but i don't understand where the bottleneck.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Stanislav
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;



-- 
Stanislav

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

