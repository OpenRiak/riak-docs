---
title: "Re: Using Riak to perform aggregate queries"
description: ""
project: community
lastmod: 2013-04-14T19:56:06-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10882"
mailinglist_parent_id: "msg10881"
author_name: "Chris Corbyn"
project_section: "mailinglistitem"
sent_date: 2013-04-14T19:56:06-07:00
---


So then Riak will be good to perform this sort of aggregate query over 500K 
records? Or am I trying to flex what is effectively a key-value store to do 
something it's not really good at doing? ;) It feels like I probably need a lot 
of hardware to get Riak to do this in the same amount of time MySQL does it.


Il giorno 15/apr/2013, alle ore 12:41, Evan Vigil-McClanahan 
 ha scritto:

&gt; The most common issue with large MapReduce jobs is one of the nodes
&gt; starting to swap (typically the node the request was made on).
&gt; 
&gt; Streaming results and pre-reduction[0] (where applicable) can often
&gt; lower the memory overhead of running MapReduce jobs on large numbers
&gt; of objects.
&gt; 
&gt; That would be the first thing I would check. Also potentially
&gt; applicable: 
&gt; http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/
&gt; 
&gt; 
&gt; 0: 
&gt; http://docs.basho.com/riak/1.1.4/references/appendices/MapReduce-Implementation/,
&gt; pre-reduce is down at the bottom.
&gt; 
&gt; 
&gt; 
&gt; On Sun, Apr 14, 2013 at 6:47 PM, Chris Corbyn  wrote:
&gt;&gt; All,
&gt;&gt; 
&gt;&gt; Just copying this from my stackoverflow post, as the riak tag doesn't get
&gt;&gt; much love over there :) It's fine to just outright say that Riak is never
&gt;&gt; going to work efficiently in this case because I'm inherently depending on
&gt;&gt; MapReduce.
&gt;&gt; 
&gt;&gt; Everywhere I read, people say you shouldn't use Riak's MapReduce over an
&gt;&gt; entire bucket and that there are other ways of achieving your goals. I'm not
&gt;&gt; sure how, though. I'm also not clear on why using an entire bucket is slow,
&gt;&gt; if you only have one bucket in the entire system, so either way, you need to
&gt;&gt; go over all the entries. Passing in a list of key-bucket pairs has the same
&gt;&gt; effect. Maybe the rule should be "don't use MapReduce with more than a
&gt;&gt; handful of keys". Which makes me wonder (apart from link traversal) what use
&gt;&gt; it really has in the real world.
&gt;&gt; 
&gt;&gt; I have a list of 500K+ documents that represent sales data. I need to view
&gt;&gt; this data in different ways: for example, how much revenue was made in each
&gt;&gt; month the business was operating? How much revenue did each product raise?
&gt;&gt; How many of each product were sold in a given month? I always thought
&gt;&gt; MapReduce was supposed to be good at solving these types of aggregate
&gt;&gt; problems. That sounds like a myth now though, unless we're just looking at
&gt;&gt; Hadoop.
&gt;&gt; 
&gt;&gt; My documents are all in a bucket named 'sales' and they are records with the
&gt;&gt; following fields (as native Erlang records, not JSON):
&gt;&gt; 
&gt;&gt; {"id":1, "product\_key": "cyber-pet-toy", "price": "10.00", "tax":
&gt;&gt; "1.00", "created\_at": 1365931758}.
&gt;&gt; 
&gt;&gt; Let's take the example where I need to report the total revenue for each
&gt;&gt; product in each month over the past 4 years (that's basically the entire
&gt;&gt; bucket, but that's just the requirement), how does one use Riak's MapReduce
&gt;&gt; to do that efficiently? Even just trying to use an identity map operation on
&gt;&gt; the data I get a timeout after ~30 seconds, which MySQL handles in
&gt;&gt; milliseconds.
&gt;&gt; 
&gt;&gt; I'm doing this in Erlang (using the protocol buffers client), but any
&gt;&gt; language is fine for an explanation.
&gt;&gt; 
&gt;&gt; The equivalent SQL (MySQL) would be:
&gt;&gt; 
&gt;&gt; SELECT SUM(price) AS revenue,
&gt;&gt; FROM\_UNIXTIME(created\_at, '%Y-%m') AS month,
&gt;&gt; product\_key
&gt;&gt; FROM sales
&gt;&gt; GROUP BY month, product\_key
&gt;&gt; ORDER BY month ASC;
&gt;&gt; 
&gt;&gt; Even with secondary indexes, there's still a MapReduce involved in this
&gt;&gt; query, once you have the list of keys to process.
&gt;&gt; 
&gt;&gt; (Ordering not important right now).
&gt;&gt; 
&gt;&gt; Cheers,
&gt;&gt; 
&gt;&gt; Chris
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

