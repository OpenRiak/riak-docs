---
title: "Re: Possibility of a CAS API"
description: ""
project: community
lastmod: 2012-02-24T19:21:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06739"
mailinglist_parent_id: "msg06738"
author_name: "Armon Dadgar"
project_section: "mailinglistitem"
sent_date: 2012-02-24T19:21:27-08:00
---


It sounds like the "If-Unmodified-Since" and "If-None-Match" flags could do 
what I
need, but the docs specify "it is possible for the condition to evaluate to 
true for
multiple requests if the requests occur at the same time."

From my understanding, the KV vnode's process their requests in a serial 
fashion.
I'm not sure I fully understand how It could be that the request evaluates to 
true
for multiple requests, if the PUTs are handled serially.

If it is a matter of the vnodes being interleaved, would it be solvable by
setting w = r = n?

I'm not convinced that a CAS operation is inevitably subject to data races.
There are proven techniques for avoiding races at the cost of latency,
which is acceptable in certain situations.

I will take a look at Zab, thanks for the reference!

Best Regards,

Armon Dadgar

On Feb 24, 2012, at 6:09 PM, Dietrich Featherston wrote:

&gt; If you need CAS semantics, then coordinate that outside of riak. Any 
&gt; check-then-act type of operation where atomicity is important is going to 
&gt; leave some room for a data race in a system with the distribution semantics 
&gt; of riak. Would suggest thinking about the problem in such a way that handling 
&gt; of siblings is tolerant of duplicate writes and eventually the correct value 
&gt; bubbles up to the readers. That or do the coordination of unique indexes in 
&gt; something not dynamo shaped.
&gt; 
&gt; I can't say I'm intimately familiar with the work yet, but others have 
&gt; prototyped/postulated consistency layers on top of riak (a la zab) that might 
&gt; more closely match what you're trying to do. None of this is in a released / 
&gt; supported version of riak to my knowledge though.
&gt; 
&gt; Thanks,
&gt; D
&gt; 
&gt; 
&gt; On Fri, Feb 24, 2012 at 4:41 PM, Armon Dadgar  wrote:
&gt; As part of a new feature we are working on, we've run into
&gt; a situation where it would be incredibly convenient to have a 
&gt; check-and-set (CAS) API for Riak KV. In short, we are trying to build
&gt; a unique index of a bucket, using a second bucket which acts as a 
&gt; reverse index.
&gt; 
&gt; The CAS API would operate in the same manner as a PUT, except it
&gt; should take a "last vclock". The new value + last vclock are submitted
&gt; to the responsible vnodes. The vnodes respond if the last vclock
&gt; for the key matches the specified last value. If we get "r" nodes responding
&gt; that the last value matches, then we should commit the write. This method
&gt; is basically a two-phase commit.
&gt; 
&gt; It would also be great if no-value sentinel could be specified to indicate
&gt; the CAS should only succeed if there is not already a key. We need this
&gt; to make sure uniqueness constraints are not violated.
&gt; 
&gt; I wanted to gauge the interest from the community in something like this,
&gt; and see if I could get thoughts from the Basho team on if this could be
&gt; implemented.
&gt; 
&gt; Best Regards,
&gt; 
&gt; Armon Dadgar
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

