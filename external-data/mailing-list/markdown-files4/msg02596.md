---
title: "Re: annoying javascript problem in Reduce phases"
description: ""
project: community
lastmod: 2011-03-10T05:26:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02596"
mailinglist_parent_id: "msg02595"
author_name: "Antonio Rohman Fernandez"
project_section: "mailinglistitem"
sent_date: 2011-03-10T05:26:27-08:00
---


Dear Sean,
thank you for your quick reply.

"Your reduce function can (almost) never assume that it is operating on the 
entire result set." -&gt; wow! that totally kills my implementation... i wanted to 
use the Reduce phase to cut the array as a Limit + Pagination ( like LIMIT 10 
PAGE 2 in SQL )... but if i don't have the full result set is impossible and 
useless. I will have to get all the rows and then process it outside Riak for 
that.

"you must structure your reduce function such that it can receive as inputs 
anything that it outputs" -&gt; what do you mean with that? can i merge Reduce 
phases? any example?

i'm building a php MVC framework in top of Riak, and i would like to clone from 
my SQL implementation as much functionality as i can, so people can easily use 
Riak as if they were using MySQL/PostgreSQL/etc without noticing.
thanks.

Rohman


 Antonio Rohman Fernandez
CEO, Founder & Lead Engineer
roh...@mahalostudio.com
 Projects
MaruBatsu.es
PupCloud.com
Wedding Album
 

On Mar 10, 2011, at 8:50 PM, Sean Cribbs wrote:

&gt; Antonio,
&gt; 
&gt; Sorry it's a little buried in the documentation, but be aware that Reduce 
&gt; phases \*may\* be called more than once (CouchDB calls this rereduce). What 
&gt; you experience in the last example is a demonstration of that: you must 
&gt; structure your reduce function such that it can receive as inputs anything 
&gt; that it outputs. The array/list that you return as the output will be 
&gt; concatenated with more values on the subsequent applications of the function. 
&gt; Your reduce function can (almost) never assume that it is operating on the 
&gt; entire result set.
&gt; 
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt; 
&gt; On Mar 10, 2011, at 5:32 AM, Antonio Rohman Fernandez wrote:
&gt; 
&gt;&gt; Dear All,
&gt;&gt; I'm having a pretty annoying Javascript problem and would like to know if is 
&gt;&gt; a bug (most likely) or if somebody has a solution.
&gt;&gt; 
&gt;&gt; This is the sample data i'm playing with:
&gt;&gt; bucket -&gt; 'testbucket'
&gt;&gt; key00001:{"name":"antonio","dob":1981,"country":"Spain"}
&gt;&gt; key00002:{"name":"rohman","dob":1982,"country":"Taiwan"}
&gt;&gt; key00003:{"name":"fernandez","dob":1983,"country":"US"}
&gt;&gt; key00004:{"name":"lee","dob":1984,"country":"Japan"}
&gt;&gt; key00005:{"name":"bruce","dob":1985,"country":"China"}
&gt;&gt; 
&gt;&gt; MAP ONLY: 
&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt; { return [v.values[0].data]; }"}}]}
&gt;&gt; 
&gt;&gt; The Mapping phase ( nothing special, just gives back the values of all keys 
&gt;&gt; in the bucket ) gives the correct data, an array of all my key's values:
&gt;&gt; ["{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt; "{\"name\":\"bruce\",\"dob\":1985,\"country\":\"China\"}",
&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt; "{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}",
&gt;&gt; "{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}"]
&gt;&gt; 
&gt;&gt; REDUCE (try1:OK): 
&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt; {"language":"javascript","source":"function(v,a) { return v; }"}}]}
&gt;&gt; 
&gt;&gt; This kinda useless Reduce phase returns the data as it is, even the order is 
&gt;&gt; reversed... seems ok:
&gt;&gt; ["{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}",
&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt; "{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt; "{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}",
&gt;&gt; "{\"name\":\"bruce\",\"dob\":1985,\"country\":\"China\"}"]
&gt;&gt; 
&gt;&gt; REDUCE (try2:OK): 
&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v[1]]; }"}}]}
&gt;&gt; 
&gt;&gt; This Reduce phase just return the 2nd item array[1] of the result... seems 
&gt;&gt; ok too!:
&gt;&gt; ["{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}"]
&gt;&gt; 
&gt;&gt; REDUCE (try3:!!!!!): 
&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v[3]]; }"}}]}
&gt;&gt; 
&gt;&gt; This Reduce phase SHOULD return the 4th item of the array... but returns 
&gt;&gt; NULL!!!!:
&gt;&gt; [null] &lt;-- WTF... works for [v[0]], [v[1]], [v[2]] but fails from [v[3]]...
&gt;&gt; 
&gt;&gt; REDUCE (try4:!!!!!): 
&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v]; }"}}]}
&gt;&gt; 
&gt;&gt; This Reduce phase returns the data inside an array... but with a wrong 
&gt;&gt; patter [[1,1,1,[1,1]]]!!!:
&gt;&gt; [
&gt;&gt; ["{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}",
&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt; "{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt; ["{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}", &lt;---- See the 
&gt;&gt; weird extra array?
&gt;&gt; "{\"name\":\"bitch\",\"dob\":1985,\"country\":\"China\"}"]
&gt;&gt; ]
&gt;&gt; ]
&gt;&gt; 
&gt;&gt; that is transformed to this:
&gt;&gt; 
&gt;&gt; Array (
&gt;&gt; [0] =&gt; {"name":"lee","dob":1984,"country":"Japan"}
&gt;&gt; [1] =&gt; {"name":"fernandez","dob":1983,"country":"US"}
&gt;&gt; [2] =&gt; {"name":"rohman","dob":1982,"country":"Taiwan"}
&gt;&gt; [3] =&gt; Array (
&gt;&gt; [0] =&gt; {"name":"antonio","dob":1981,"country":"Spain"}
&gt;&gt; [1] =&gt; {"name":"bruce","dob":1985,"country":"China"}
&gt;&gt; )
&gt;&gt; )
&gt;&gt; 
&gt;&gt; I don't know what is going on with the javascript Reduce phase... but is 
&gt;&gt; killing me...
&gt;&gt; return v --&gt; OK
&gt;&gt; return [v[0]] --&gt; OK
&gt;&gt; return [v[1]] --&gt; OK
&gt;&gt; return [v[2]] --&gt; OK
&gt;&gt; return [v[3]] --&gt; ERROR ( and so on )
&gt;&gt; 
&gt;&gt; any ideas? thanks
&gt;&gt; Rohman
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Antonio Rohman Fernandez
&gt;&gt; CEO, Founder & Lead Engineer
&gt;&gt; roh...@mahalostudio.com Projects
&gt;&gt; MaruBatsu.es
&gt;&gt; PupCloud.com
&gt;&gt; Wedding Album
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

