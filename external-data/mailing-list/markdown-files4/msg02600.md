---
title: "Re: annoying javascript problem in Reduce phases"
description: ""
project: community
lastmod: 2011-03-10T06:12:02-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02600"
mailinglist_parent_id: "msg02599"
author_name: "Antonio Rohman Fernandez"
project_section: "mailinglistitem"
sent_date: 2011-03-10T06:12:02-08:00
---


thanks, so... we can assume there will be maximum only 2 reduce phases? even if 
there are hundreds of maps? just for curiosity.

Rohman


 Antonio Rohman Fernandez
CEO, Founder & Lead Engineer
roh...@mahalostudio.com
 Projects
MaruBatsu.es
PupCloud.com
Wedding Album
 

On Mar 10, 2011, at 10:03 PM, Alexander Sicular wrote:

&gt; Echo what Sean said. Also I have a post on my blog about pagination and riak. 
&gt; As Sean said, it is basically a reduce(sort) , reduce(slice) to get it 
&gt; working. 
&gt; 
&gt; -Alexander. 
&gt; 
&gt; @siculars on twitter
&gt; http://siculars.posterous.com
&gt; 
&gt; Sent from my iPhone
&gt; 
&gt; On Mar 10, 2011, at 8:26, Antonio Rohman Fernandez  
&gt; wrote:
&gt; 
&gt;&gt; Dear Sean,
&gt;&gt; thank you for your quick reply.
&gt;&gt; 
&gt;&gt; "Your reduce function can (almost) never assume that it is operating on the 
&gt;&gt; entire result set." -&gt; wow! that totally kills my implementation... i wanted 
&gt;&gt; to use the Reduce phase to cut the array as a Limit + Pagination ( like 
&gt;&gt; LIMIT 10 PAGE 2 in SQL )... but if i don't have the full result set is 
&gt;&gt; impossible and useless. I will have to get all the rows and then process it 
&gt;&gt; outside Riak for that.
&gt;&gt; 
&gt;&gt; "you must structure your reduce function such that it can receive as inputs 
&gt;&gt; anything that it outputs" -&gt; what do you mean with that? can i merge Reduce 
&gt;&gt; phases? any example?
&gt;&gt; 
&gt;&gt; i'm building a php MVC framework in top of Riak, and i would like to clone 
&gt;&gt; from my SQL implementation as much functionality as i can, so people can 
&gt;&gt; easily use Riak as if they were using MySQL/PostgreSQL/etc without noticing.
&gt;&gt; thanks.
&gt;&gt; 
&gt;&gt; Rohman
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Antonio Rohman Fernandez
&gt;&gt; CEO, Founder & Lead Engineer
&gt;&gt; roh...@mahalostudio.com
&gt;&gt; Projects
&gt;&gt; MaruBatsu.es
&gt;&gt; PupCloud.com
&gt;&gt; Wedding Album
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Mar 10, 2011, at 8:50 PM, Sean Cribbs wrote:
&gt;&gt; 
&gt;&gt;&gt; Antonio,
&gt;&gt;&gt; 
&gt;&gt;&gt; Sorry it's a little buried in the documentation, but be aware that Reduce 
&gt;&gt;&gt; phases \*may\* be called more than once (CouchDB calls this rereduce). What 
&gt;&gt;&gt; you experience in the last example is a demonstration of that: you must 
&gt;&gt;&gt; structure your reduce function such that it can receive as inputs anything 
&gt;&gt;&gt; that it outputs. The array/list that you return as the output will be 
&gt;&gt;&gt; concatenated with more values on the subsequent applications of the 
&gt;&gt;&gt; function. Your reduce function can (almost) never assume that it is 
&gt;&gt;&gt; operating on the entire result set.
&gt;&gt;&gt; 
&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt; 
&gt;&gt;&gt; On Mar 10, 2011, at 5:32 AM, Antonio Rohman Fernandez wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Dear All,
&gt;&gt;&gt;&gt; I'm having a pretty annoying Javascript problem and would like to know if 
&gt;&gt;&gt;&gt; is a bug (most likely) or if somebody has a solution.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This is the sample data i'm playing with:
&gt;&gt;&gt;&gt; bucket -&gt; 'testbucket'
&gt;&gt;&gt;&gt; key00001:{"name":"antonio","dob":1981,"country":"Spain"}
&gt;&gt;&gt;&gt; key00002:{"name":"rohman","dob":1982,"country":"Taiwan"}
&gt;&gt;&gt;&gt; key00003:{"name":"fernandez","dob":1983,"country":"US"}
&gt;&gt;&gt;&gt; key00004:{"name":"lee","dob":1984,"country":"Japan"}
&gt;&gt;&gt;&gt; key00005:{"name":"bruce","dob":1985,"country":"China"}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; MAP ONLY: 
&gt;&gt;&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt;&gt;&gt; { return [v.values[0].data]; }"}}]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The Mapping phase ( nothing special, just gives back the values of all 
&gt;&gt;&gt;&gt; keys in the bucket ) gives the correct data, an array of all my key's 
&gt;&gt;&gt;&gt; values:
&gt;&gt;&gt;&gt; ["{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"bruce\",\"dob\":1985,\"country\":\"China\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}"]
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; REDUCE (try1:OK): 
&gt;&gt;&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt;&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt;&gt;&gt; {"language":"javascript","source":"function(v,a) { return v; }"}}]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This kinda useless Reduce phase returns the data as it is, even the order 
&gt;&gt;&gt;&gt; is reversed... seems ok:
&gt;&gt;&gt;&gt; ["{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"bruce\",\"dob\":1985,\"country\":\"China\"}"]
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; REDUCE (try2:OK): 
&gt;&gt;&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt;&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt;&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v[1]]; }"}}]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This Reduce phase just return the 2nd item array[1] of the result... seems 
&gt;&gt;&gt;&gt; ok too!:
&gt;&gt;&gt;&gt; ["{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}"]
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; REDUCE (try3:!!!!!): 
&gt;&gt;&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt;&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt;&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v[3]]; }"}}]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This Reduce phase SHOULD return the 4th item of the array... but returns 
&gt;&gt;&gt;&gt; NULL!!!!:
&gt;&gt;&gt;&gt; [null] &lt;-- WTF... works for [v[0]], [v[1]], [v[2]] but fails from [v[3]]...
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; REDUCE (try4:!!!!!): 
&gt;&gt;&gt;&gt; {"inputs":"testbucket","query":[{"map":{"language":"javascript","source":"function(v,k,a)
&gt;&gt;&gt;&gt; { return [v.values[0].data]; }"}},{"reduce": 
&gt;&gt;&gt;&gt; {"language":"javascript","source":"function(v,a) { return [v]; }"}}]}
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This Reduce phase returns the data inside an array... but with a wrong 
&gt;&gt;&gt;&gt; patter [[1,1,1,[1,1]]]!!!:
&gt;&gt;&gt;&gt; [
&gt;&gt;&gt;&gt; ["{\"name\":\"lee\",\"dob\":1984,\"country\":\"Japan\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"fernandez\",\"dob\":1983,\"country\":\"US\"}",
&gt;&gt;&gt;&gt; "{\"name\":\"rohman\",\"dob\":1982,\"country\":\"Taiwan\"}",
&gt;&gt;&gt;&gt; ["{\"name\":\"antonio\",\"dob\":1981,\"country\":\"Spain\"}", &lt;---- See 
&gt;&gt;&gt;&gt; the weird extra array?
&gt;&gt;&gt;&gt; "{\"name\":\"bitch\",\"dob\":1985,\"country\":\"China\"}"]
&gt;&gt;&gt;&gt; ]
&gt;&gt;&gt;&gt; ]
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; that is transformed to this:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Array (
&gt;&gt;&gt;&gt; [0] =&gt; {"name":"lee","dob":1984,"country":"Japan"}
&gt;&gt;&gt;&gt; [1] =&gt; {"name":"fernandez","dob":1983,"country":"US"}
&gt;&gt;&gt;&gt; [2] =&gt; {"name":"rohman","dob":1982,"country":"Taiwan"}
&gt;&gt;&gt;&gt; [3] =&gt; Array (
&gt;&gt;&gt;&gt; [0] =&gt; {"name":"antonio","dob":1981,"country":"Spain"}
&gt;&gt;&gt;&gt; [1] =&gt; {"name":"bruce","dob":1985,"country":"China"}
&gt;&gt;&gt;&gt; )
&gt;&gt;&gt;&gt; )
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I don't know what is going on with the javascript Reduce phase... but is 
&gt;&gt;&gt;&gt; killing me...
&gt;&gt;&gt;&gt; return v --&gt; OK
&gt;&gt;&gt;&gt; return [v[0]] --&gt; OK
&gt;&gt;&gt;&gt; return [v[1]] --&gt; OK
&gt;&gt;&gt;&gt; return [v[2]] --&gt; OK
&gt;&gt;&gt;&gt; return [v[3]] --&gt; ERROR ( and so on )
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; any ideas? thanks
&gt;&gt;&gt;&gt; Rohman
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Antonio Rohman Fernandez
&gt;&gt;&gt;&gt; CEO, Founder & Lead Engineer
&gt;&gt;&gt;&gt; roh...@mahalostudio.com Projects
&gt;&gt;&gt;&gt; MaruBatsu.es
&gt;&gt;&gt;&gt; PupCloud.com
&gt;&gt;&gt;&gt; Wedding Album
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

