---
title: "Re: Riak-S2 javascript aws-sdk failing on multi-part uploads"
description: ""
project: community
lastmod: 2016-01-13T15:06:38-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16954"
mailinglist_parent_id: "msg16953"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-01-13T15:06:38-08:00
---


haproxy ships with some "short" default timeouts. If CyberDuck is able
to upload these files faster than aws-sdk, it may be doing so within
the default haproxy timeouts.

You can also look at haproxy's log to see if you find any TCP
connections that it has closed.
--
Luke Bakken
Engineer
lbak...@basho.com


On Wed, Jan 13, 2016 at 3:02 PM, John Fanjoy  wrote:
&gt; Luke,
&gt;
&gt; I may be able to do that. The only problem is without haproxy I have no way 
&gt; to inject CORS headers which the browser requires, but I may be able to write 
&gt; up small nodejs app to get past that and see if it is somehow related to 
&gt; haproxy. The fact that these errors are not present when using Cyberduck 
&gt; which is also talking to haproxy leads me to believe that’s not the cause, 
&gt; but it’s definitely worth testing.
&gt;
&gt; --
&gt; John Fanjoy
&gt; Systems Engineer
&gt; jfan...@inetu.net
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; On 1/13/16, 5:55 PM, "Luke Bakken"  wrote:
&gt;
&gt;&gt;John -
&gt;&gt;
&gt;&gt;The following error indicates that the connection was unexpectedly
&gt;&gt;closed by something outside of Riak while the chunk is uploading:
&gt;&gt;
&gt;&gt;{badmatch,{error,closed}}
&gt;&gt;
&gt;&gt;Is it possible to remove haproxy to test using the the aws-sdk?
&gt;&gt;
&gt;&gt;That is my first thought as to the cause of this issue, especially
&gt;&gt;since writing to S3 works with the same code.
&gt;&gt;
&gt;&gt;--
&gt;&gt;Luke Bakken
&gt;&gt;Engineer
&gt;&gt;lbak...@basho.com
&gt;&gt;
&gt;&gt;On Wed, Jan 13, 2016 at 2:46 PM, John Fanjoy  wrote:
&gt;&gt;&gt; Luke,
&gt;&gt;&gt;
&gt;&gt;&gt; Yes on both parts. To confirm cyberduck was using multi-part I actually 
&gt;&gt;&gt; tailed the console.log while it was uploading the file, and it uploaded the 
&gt;&gt;&gt; file in approx. 40 parts. Afterwards the parts were reassembled as you 
&gt;&gt;&gt; would expect. The AWS-SDK for javascript has an object called ManagedUpload 
&gt;&gt;&gt; which automatically switches to multi-part when the input is larger than 
&gt;&gt;&gt; the maxpartsize (default 5mb). I have confirmed that it is splitting the 
&gt;&gt;&gt; files up, but so far I’ve only ever seen one part get successfully uploaded 
&gt;&gt;&gt; before the others failed at which point it removes the upload (DELETE call) 
&gt;&gt;&gt; automatically. I also verified that the javascript I have in place does 
&gt;&gt;&gt; work with an actual AWS S3 bucket to rule out coding issues on my end and 
&gt;&gt;&gt; the same &gt;400mb file was successfully uploaded to the bucket I created 
&gt;&gt;&gt; there without issue.
&gt;&gt;&gt;
&gt;&gt;&gt; A few things worth mentioning that I missed before. I am running riak-s2 
&gt;&gt;&gt; behind haproxy. Haproxy is handling ssl and enabling CORS for browser based 
&gt;&gt;&gt; requests. I have tested smaller files (~4-5mb) and GET requests using the 
&gt;&gt;&gt; browser client and everything works with my current haproxy configuration, 
&gt;&gt;&gt; but the larger files are failing, usually after 1 part is successfully 
&gt;&gt;&gt; uploaded. I can also list bucket contents and delete existing contents. The 
&gt;&gt;&gt; only feature that is not working appears to be the multi-part uploads. We 
&gt;&gt;&gt; are running centOS 7 (kernel version 3.10.0-327.4.4.el7.x86\_64). Please let 
&gt;&gt;&gt; me know if you have any further questions.
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt; jfan...@inetu.net

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

