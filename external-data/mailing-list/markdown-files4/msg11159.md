---
title: "Re: Servers keep dying. How to understand why?"
description: ""
project: community
lastmod: 2013-05-23T12:24:57-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11159"
mailinglist_parent_id: "msg11099"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-05-23T12:24:57-07:00
---


Hi Julien,

Changing to LevelDB would probably make sense for your environment as all keys 
will no longer need to be kept in memory. You should therefore be able to 
handle larger amount of data. 4GB is however not a lot of RAM, so the default 
settings will need to be tuned as these generally are optimised for servers 
with more available RAM.

In order to reduce resource consumption with leveldb, I would recommend using a 
much smaller ring size. For a 5 node cluster we usually recommend a minimum 
ring size of 64, but in your case 32 may actually be a more suitable option.

Riak also runs best without swap, so you should ensure that the 4GB of RAM you 
have available are backed by real RAM and not swap space as this will 
negatively affect performance. Also follow the linux tuning guidelines and 
ensure you do not have swap enabled.

As Riak performance also heavily depends on the speed of the disks, ensure 
these are configured to be as fast and efficient as possible.

This is the best advise I have at the moment. If I find any other settings that 
may need to be tweaked I will let you know.

Best regards,

Christian



On 23 May 2013, at 09:23, Julien Genestoux  wrote:

&gt; Hello Christian, all
&gt; 
&gt; So, after thinking a little bit and reading more we decided to switch to 
&gt; leveldb. For now, we use the default config, but we probably will have to 
&gt; change a couple things in the future.
&gt; 
&gt; We also monitor the whole cluster using collectd and we see some interestng 
&gt; behaviors on which I'd love to have your feedback.
&gt; 
&gt; We monitor the node\_[get|put]\_fsm\_time\_\* and we noticed that our 100% 
&gt; percentile behaves particularly bad. I have attached a collectd graph for it. 
&gt; (ignore the 'hole' in data collection, as we had to updates a couple thing on 
&gt; the collecting server).
&gt; 
&gt; The mean for get is 1259ms, the average is 3334ms, which is in the same order 
&gt; of magnitude, but the 100% percentile is at 401996ms on average, which is 2 
&gt; orders of magnitude larger. Is that common? We see the exact same thing for 
&gt; put request.
&gt; 
&gt; I am not sure whether this is the cause, but we have a big difference for the 
&gt; sizes of objects. The median and mean are respectively 1545 and 1951 and 
&gt; 32315 for the 100% percentile. (just 1 order of magnitude larger though). 
&gt; Could this be related?
&gt; 
&gt; To investigate this, we have started 'instrumenting' our clients too to see 
&gt; what could be the slow queries, and well, we have not found them! What's even 
&gt; weirder is that for get and out request, we consistently get a responses we 
&gt; see on average latency of 150ms roughly, and we \*never\* see anything like 
&gt; 402kms! Where could the come from? My idea is that node\_[get|put]\_fsm\_time\_\* 
&gt; shows more how internal (inside the cluster) get/put work, with n,r and w, 
&gt; but could you confirm? Would you say these values make sense?
&gt; 
&gt; For your reference, we have a cluster of 5 Xen instances (differents hosts), 
&gt; with 4GB of RAM each.
&gt; The cluster currently has 2 buckets:
&gt; - "feeds" which has allow\_mult enabled and stores basically arrays of at most 
&gt; 10 elements. Each element is a key for the 2nd bucket. n\_val=3. We have about 
&gt; 213,644 objects i this bucket.
&gt; - "entries" which holds complex json objects, allow\_mult is not enabled, and 
&gt; the n\_val=2. We have about 2,398,908 of these elements.
&gt; 
&gt; As you can see we have a bunch of 'lost' elements, which sucks, but we're not 
&gt; sure what's the best way to deal with them.
&gt; 
&gt; That's it for now :)
&gt; 
&gt; Thanks a lot!
&gt; 
&gt; 
&gt; 
&gt; 
&gt; --
&gt; Got a blog? Make following it simple: https://www.subtome.com/
&gt; 
&gt; Julien Genestoux,
&gt; http://twitter.com/julien51
&gt; 
&gt; +1 (415) 830 6574
&gt; +33 (0)9 70 44 76 29
&gt; 
&gt; 
&gt; On Fri, May 17, 2013 at 3:25 PM, Christian Dahlqvist  
&gt; wrote:
&gt; Hi Julian,
&gt; 
&gt; You will need to update the app.config file and restart the servers in order 
&gt; for the changes to take effect.
&gt; 
&gt; Best regards,
&gt; 
&gt; Christian
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On 17 May 2013, at 14:05, Julien Genestoux  wrote:
&gt; 
&gt;&gt; Great! Thanks Christian, is that something I can change at runtime or do I 
&gt;&gt; have to stop the server?
&gt;&gt; Also, would it make sense to change the backend if we have a lot of delete? 
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; 
&gt;&gt; On Fri, May 17, 2013 at 2:45 PM, Christian Dahlqvist  
&gt;&gt; wrote:
&gt;&gt; Hi Julien,
&gt;&gt; 
&gt;&gt; I believe from an earlier email that you are using bitcask as a backend. 
&gt;&gt; This works with immutable append-only files, and data that is deleted or 
&gt;&gt; overwritten will stay in the files and take up disk space until the file is 
&gt;&gt; closed and can be merged. The max file size is by default 2GB, but this and 
&gt;&gt; other parameters determining how and when merging of closed files is 
&gt;&gt; performed can be tuned. Please see 
&gt;&gt; http://docs.basho.com/riak/latest/tutorials/choosing-a-backend/Bitcask/ for 
&gt;&gt; further details.
&gt;&gt; 
&gt;&gt; If you wish to reduce the amount of disk space used, you may want to set a 
&gt;&gt; smaller max file size in order to allow merging to occur more frequently.
&gt;&gt; 
&gt;&gt; Best regards,
&gt;&gt; 
&gt;&gt; Christian
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 17 May 2013, at 13:06, Julien Genestoux  
&gt;&gt; wrote:
&gt;&gt; 
&gt;&gt;&gt; Christian, All
&gt;&gt;&gt; 
&gt;&gt;&gt; Our servers still have not died... but we see another strange behavior: our 
&gt;&gt;&gt; data store needs a lot more space that what we expect.
&gt;&gt;&gt; 
&gt;&gt;&gt; Based on the status command, the average size of our object 
&gt;&gt;&gt; (node\_get\_fsm\_objsize\_mean) is about 1500 bytes.
&gt;&gt;&gt; We have 2 buckets, but both of them have a n value of 3. 
&gt;&gt;&gt; 
&gt;&gt;&gt; When we count the values in each of the buckets (using the following 
&gt;&gt;&gt; mapreduce)
&gt;&gt;&gt; curl -XPOST http://192.168.134.42:8098/mapred -H 'Content-Type: 
&gt;&gt;&gt; application/json' -d 
&gt;&gt;&gt; '{"inputs":"BUCKET","query":[{"reduce":{"language":"erlang","module":"riak\_kv\_mapreduce","function":"reduce\_count\_inputs","arg":{"do\_prereduce":true}}}],"timeout":
&gt;&gt;&gt; 100000}'
&gt;&gt;&gt; 
&gt;&gt;&gt; We get 194556 for one and 1572661 for the other one (these numbers are 
&gt;&gt;&gt; consistent with what we expected), so if our math is right, we do need a 
&gt;&gt;&gt; total disk of 
&gt;&gt;&gt; 3 \* (194556 + 1572661 ) \* 1500 bytes = 7.4 GB.
&gt;&gt;&gt; 
&gt;&gt;&gt; Now, though, when I inspect the storage actually occupied on our hard 
&gt;&gt;&gt; drives, we see something weird:
&gt;&gt;&gt; (this is the du output)
&gt;&gt;&gt; riak1. 2802888 /var/lib/riak
&gt;&gt;&gt; riak2. 4159976 /var/lib/riak
&gt;&gt;&gt; riak5. 4603312 /var/lib/riak
&gt;&gt;&gt; riak3. 4915180 /var/lib/riak
&gt;&gt;&gt; riak4. 37466784 /var/lib/riak
&gt;&gt;&gt; 
&gt;&gt;&gt; As you can see not all nodes have the same "size". What's even weirder is 
&gt;&gt;&gt; that up until a couple hours ago, they were all growing "together" and 
&gt;&gt;&gt; close to what the riak4 node shows. Could this be due to the "delete" 
&gt;&gt;&gt; policy? It turns out that we delete a lot of items (is there a way to get 
&gt;&gt;&gt; the list of commands sent to a node/cluster?)
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks!
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Wed, May 15, 2013 at 11:29 PM, Julien Genestoux 
&gt;&gt;&gt;  wrote:
&gt;&gt;&gt; Christian, all,
&gt;&gt;&gt; 
&gt;&gt;&gt; Not sure what kind of magic happend, but no server died in the last 2 
&gt;&gt;&gt; days... and counting.
&gt;&gt;&gt; We have not changed a single line of code, which is quite odd...
&gt;&gt;&gt; I'm still monitoring everything and hope (sic!) for a failure soon so we 
&gt;&gt;&gt; can fix the problem!
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; --
&gt;&gt;&gt; Got a blog? Make following it simple: https://www.subtome.com/
&gt;&gt;&gt; 
&gt;&gt;&gt; Julien Genestoux,
&gt;&gt;&gt; http://twitter.com/julien51
&gt;&gt;&gt; 
&gt;&gt;&gt; +1 (415) 830 6574
&gt;&gt;&gt; +33 (0)9 70 44 76 29
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Tue, May 14, 2013 at 12:31 PM, Julien Genestoux 
&gt;&gt;&gt;  wrote:
&gt;&gt;&gt; Thanks Christian. 
&gt;&gt;&gt; We do indeed use mapreduce but it's a fairly simple function:
&gt;&gt;&gt; We retrieve a first object whose value is an array of at most 10 ids and 
&gt;&gt;&gt; then we fetch all the values for these 10 ids.
&gt;&gt;&gt; However, this mapreduce job is quite rare (maybe 10 times a day at most at 
&gt;&gt;&gt; this point...) so I don't think that's our issue.
&gt;&gt;&gt; I'll try to run the cluster without any call to that to see if that's 
&gt;&gt;&gt; better, but I'd be very surprised. Also, we were doing this already even 
&gt;&gt;&gt; before we allowed for multiple value and the cluster was stable back then.
&gt;&gt;&gt; We do not do key listing or anything like that.
&gt;&gt;&gt; 
&gt;&gt;&gt; I'll try looking at the statistics too.
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Tue, May 14, 2013 at 11:50 AM, Christian Dahlqvist  
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; Hi Julien,
&gt;&gt;&gt; 
&gt;&gt;&gt; The node appear to have crashed due to inability to allocate memory. How 
&gt;&gt;&gt; are you accessing your data? Are you running any key listing or large 
&gt;&gt;&gt; MapReduce jobs that could use up a lot of memory?
&gt;&gt;&gt; 
&gt;&gt;&gt; In order to ensure that you are efficiently resolving siblings I would 
&gt;&gt;&gt; recommend you monitor the statistics in Riak 
&gt;&gt;&gt; (http://docs.basho.com/riak/latest/cookbooks/Statistics-and-Monitoring/). 
&gt;&gt;&gt; Specifically look at node\_get\_fsm\_objsize\_\* and node\_get\_fsm\_siblings\_\* 
&gt;&gt;&gt; statistics in order to identify objects that are very large or have lots of 
&gt;&gt;&gt; siblings.
&gt;&gt;&gt; 
&gt;&gt;&gt; Best regards,
&gt;&gt;&gt; 
&gt;&gt;&gt; Christian
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On 13 May 2013, at 16:44, Julien Genestoux  
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Christian, All,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Bad news: my laptop is completely dead. Good news: I have a new one, and 
&gt;&gt;&gt;&gt; it's now fully operational (backups FTW!).
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The log files have finally been uploaded: 
&gt;&gt;&gt;&gt; https://www.dropbox.com/s/j7l3lniu0wogu29/riak-died.tar.gz
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I have attached to that mail our config.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The machine is a virtual Xen instance at Linode with 4GB of memory. I know 
&gt;&gt;&gt;&gt; it's probably not the very best setup, but 1) we're on a budget and 2) we 
&gt;&gt;&gt;&gt; assumed that would fit our needs quite well.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Just to put things in more details. Initially we did not use allow\_mult 
&gt;&gt;&gt;&gt; and things worked out fine for a couple of days. As soon as we enabled 
&gt;&gt;&gt;&gt; allow\_mult, we were not able to run the cluster for more then 5 hours 
&gt;&gt;&gt;&gt; without seeing failing nodes, which is why I'm convinced we must be doing 
&gt;&gt;&gt;&gt; something wrong. The question is: what? 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thanks
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Sun, May 12, 2013 at 8:07 PM, Christian Dahlqvist  
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt; Hi Julien,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I was not able to access the logs based on the link you provided.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Could you please attach a copy of your app.config file so we can get a 
&gt;&gt;&gt;&gt; better understanding of the configuration of your cluster? Also, what is 
&gt;&gt;&gt;&gt; the specification of the machines in the cluster?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; How much data do you have in the cluster and how are you querying it?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Best regards,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Christian
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On 12 May 2013, at 19:11, Julien Genestoux  
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; We are running a cluster of 5 servers, or at least trying to, because 
&gt;&gt;&gt;&gt;&gt; nodes seem to be dying 'randomly'
&gt;&gt;&gt;&gt;&gt; without us knowing any reason why. We don't have a great Erlang guy 
&gt;&gt;&gt;&gt;&gt; aboard, and the error logs are not
&gt;&gt;&gt;&gt;&gt; that verbose.
&gt;&gt;&gt;&gt;&gt; So I've just .tgz the whole log directory and I was hoping somebody could 
&gt;&gt;&gt;&gt;&gt; give us a clue.
&gt;&gt;&gt;&gt;&gt; It's there: https://www.dropbox.com/s/z9ezv0qlxgfhcyq/riak-died.tar.gz 
&gt;&gt;&gt;&gt;&gt; (might not be fully uploaded to dropbox yet!)
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I've looked at the archive and some people said their server was dying 
&gt;&gt;&gt;&gt;&gt; because some object's size was just 
&gt;&gt;&gt;&gt;&gt; too big to allocate the whole memory. Maybe that's what we're seeing?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; As one of our buckets is set with allow\_mult, I am tempted to think that 
&gt;&gt;&gt;&gt;&gt; some object's size may be exploding.
&gt;&gt;&gt;&gt;&gt; However, we do actually try to resolve conflicts in our code. Any idea 
&gt;&gt;&gt;&gt;&gt; how to confirm and then debug that we 
&gt;&gt;&gt;&gt;&gt; have an issue there?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thanks a lot for your precious help...
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Julien
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

