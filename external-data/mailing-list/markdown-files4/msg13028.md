---
title: "Re: Ownership handoff never completes"
description: ""
project: community
lastmod: 2013-11-20T00:13:44-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13028"
mailinglist_parent_id: "msg13024"
author_name: "Jeppe Toustrup"
project_section: "mailinglistitem"
sent_date: 2013-11-20T00:13:44-08:00
---


Hi

Thank you for the guide. I stopped two of the nodes (the source and
the destination of the partition transfers), renamed the folders
inside the merge\_index folder and started them again. The ownership
handoff does however not seem to be retried.

Looking at the logs it seems like the last attempt was 48 hours ago.
Is there any logic inside Riak which causes it to give up after a
certain amount of tries?
Is there a way I can retrigger the handoffs?
I have tried to set the transfer-limit on the cluster to 0 and then
back to 2, but it doesn't seem to do anything.

I wonder if we need the merge\_index folder at all, as we have disabled
Riak search since the initial configuration of the cluster. We found a
better way to query our data so that we don't need Riak search
anymore. We disabled it by resetting the properties on the buckets
where search was enabled, and then disabled search in app.config
followed by a restart of each of the nodes. This was done after the
ownership handoff issue first occurred.

-- 
Jeppe Fihl Toustrup
Operations Engineer
Falcon Social


On 19 November 2013 23:17, Mark Phillips  wrote:
&gt; Hi Jeppe,
&gt;
&gt;
&gt;
&gt; As you suspected, this looks like index corruption in Search that's
&gt; preventing handoff from finishing. Specifically, you'll need to delete the
&gt;
&gt; segment files for the two partitions' indexes and rebuild those indexes
&gt; post-transfer.
&gt;
&gt;
&gt; Here's the full process:
&gt;
&gt;
&gt;
&gt; - Stop each node that owns the partitions in question.
&gt; - Delete the data directory for each partition (which contains the segment
&gt; files). It should be something like:
&gt;
&gt;
&gt;
&gt;
&gt; "rm -rf /var/lib/riak/merge\_index/"
&gt;
&gt;
&gt; - Restart each node
&gt;
&gt; - Wait for the transfers to complete
&gt; - Rebuild the indexes in question [1]
&gt;
&gt;
&gt; Let us know if you run into any further issues.
&gt;
&gt;
&gt;
&gt; Mark
&gt;
&gt;
&gt; [1]
&gt; http://docs.basho.com/riak/latest/ops/running/recovery/repairing-indexes/
&gt;
&gt;
&gt;
&gt; On Tue, Nov 19, 2013 at 4:26 AM, Jeppe Toustrup 
&gt; wrote:
&gt;&gt;
&gt;&gt; Hi
&gt;&gt;
&gt;&gt; I have recently added two extra nodes to the now seven node Riak
&gt;&gt; cluster. The rebalancing following the expansion worked fine, except
&gt;&gt; for two partitions which seem to not being able to go through. Running
&gt;&gt; "riak-admin ring-status" shows the following:
&gt;&gt;
&gt;&gt; ============================== Ownership Handoff
&gt;&gt; ==============================
&gt;&gt; Owner: riak@10.0.0.96
&gt;&gt; Next Owner: riak@10.0.0.93
&gt;&gt;
&gt;&gt; Index: 239777612374601260017792042867515182912301432832
&gt;&gt; Waiting on: []
&gt;&gt; Complete: [riak\_kv\_vnode,riak\_pipe\_vnode]
&gt;&gt;
&gt;&gt; Index: 696496874040508421956443553091353626554780352512
&gt;&gt; Waiting on: []
&gt;&gt; Complete: [riak\_kv\_vnode,riak\_pipe\_vnode]
&gt;&gt;
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt;
&gt;&gt; I can see from the log file on the source node (10.0.0.96) that it has
&gt;&gt; made numerous attempt to transfer the partitions, but it ends up
&gt;&gt; failing all the time. Here's an except of the log file showing the
&gt;&gt; lines from when the transfer attempt ends up failing:
&gt;&gt;
&gt;&gt; 2013-11-18 12:29:03.694 [error] emulator Error in process &lt;0.5745.8&gt;
&gt;&gt; on node 'riak@10.0.0.96' with exit value:
&gt;&gt; {badarg,[{erlang,binary\_to\_term,[&lt;&lt;29942
&gt;&gt;
&gt;&gt; bytes&gt;&gt;],[]},{mi\_segment,iterate\_all\_bytes,2,[{file,"src/mi\_segment.erl"},{line,167}]},{mi\_server,'-group\_iterator/2-fun-1-',2,[{file,"src/mi\_server.erl"},{line,725}]},{mi\_server,'-group\_iterator/2-fun-0-'...
&gt;&gt; 2013-11-18 12:29:03.885 [error] &lt;0.3269.0&gt;@mi\_server:handle\_info:524
&gt;&gt; lookup/range failure:
&gt;&gt;
&gt;&gt; {badarg,[{erlang,binary\_to\_term,[&lt;&lt;131,109,0,0,244,240,108,109,102,97,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,1
 
11,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,11
 
1,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111
 
,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,
 111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,...&gt;&gt;],...},...]}
&gt;&gt; 2013-11-18 12:29:03.889 [error]
&gt;&gt; &lt;0.30353.0&gt;@merge\_index\_backend:async\_fold\_fun:116 failed to iterate
&gt;&gt; the index with reason
&gt;&gt;
&gt;&gt; {badarg,[{erlang,binary\_to\_term,[&lt;&lt;131,109,0,0,244,240,108,109,102,97,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,1
 
11,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,...&gt;&gt;]
 ,...},...]}
&gt;&gt; and partial acc
&gt;&gt;
&gt;&gt; {{ho\_acc,1,{error,closed},#Fun,riak\_search\_vnode,&lt;0.3268.0&gt;,#Port&lt;0.133923&gt;,{696496874040508421956443553091353626554780352512,696496874040508421956443553091353626554780352512},{ho\_stats,{1384,775537,708230},undefined,249,1050473},gen\_tcp,246,1053542,[&lt;&lt;1,131,104,4,109,0,0,0,8,109,111,114,101,111,118,101,114,109,0,0,0,13,99,97,110,111,110,105,99,97,108,68,97,116,101,109,0,0,0,14,50,48,49,51,49,48,48,55,49,50,49,49,53,52,108,0,0,0,57,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,53,52,35,102,98,56,55,98,102,50,51,55,51,98,51,98,56,56,100,52,48,51,52,51,50,100,97,97,55,51,99,55,101,98,99,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,154,61,194,52,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,53,52,35,102,51,101,54,55,54,57,56,99,55,52,49,102,57,56,50,101,50,102,48,55,54,101,57,57,101,97,56,100,100,102,57,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,137,181,162,60,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,
 
48,48,55,49,50,49,49,53,52,35,101,98,57,51,102,52,55,48,53,52,55,52,50,56,98,49,49,50,101,57,98,50,98,49,52,51,52,57,52,52,98,50,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,31,143,101,69,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,53,52,35,101,55,49,52,57,49,53,52,49,102,48,55,102,102,97,99,51,48,98,51,52,51,56,52,49,98,56,50,54,55,56,48,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,214,30,30,54,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,53,52,35,101,53,56,53,97,52,48,49,98,55,97,52,56,57,56,48,53,55,54,53,101,99,98,98,98,98,101,52,97,101,48,100,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,41,65,120,56,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,53,52,35,100,101,56,99,99,99,51,56,53,56,52,48,53,97,51,49,57,49,48,97,51,55,57,57,98,49,54,52,53,100,55,50,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,110,7,0,222,186,251,66,243,234,4,104,3,109,0,0,0,47,50,48,49,51,49,48,48,55,49,50,49,49,...&gt;&gt;,...],...},..
 .}
&gt;&gt; 2013-11-18 12:29:03.889 [error]
&gt;&gt; &lt;0.15384.7&gt;@riak\_core\_handoff\_sender:start\_fold:269 ownership\_transfer
&gt;&gt; transfer of riak\_search\_vnode from 'riak@10.0.0.96'
&gt;&gt; 696496874040508421956443553091353626554780352512 to 'riak@10.0.0.93'
&gt;&gt; 696496874040508421956443553091353626554780352512 failed because of
&gt;&gt; error:{badrecord,ho\_acc}
&gt;&gt;
&gt;&gt; [{riak\_core\_handoff\_sender,start\_fold,5,[{file,"src/riak\_core\_handoff\_sender.erl"},{line,193}]}]
&gt;&gt;
&gt;&gt;
&gt;&gt; I've got an idea that it me be caused by corrupt data, but the
&gt;&gt; question is then how I can get this corrected, enabling the transfer
&gt;&gt; to complete. Any suggestions?
&gt;&gt;
&gt;&gt; We are using Riak 1.4.2 with LevelDB as the backend on Ubuntu 12.04.
&gt;&gt; Riak was installed through the apt.basho.com repository. Let me know
&gt;&gt; if you need any more information.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Jeppe Fihl Toustrup
&gt;&gt; Operations Engineer
&gt;&gt; Falcon Social
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



