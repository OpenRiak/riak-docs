---
title: "Performance of write requests?"
description: ""
project: community
lastmod: 2010-05-10T13:49:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00301"
mailinglist_parent_id: "msg00298"
author_name: "Stephan Maka"
project_section: "mailinglistitem"
sent_date: 2010-05-10T13:49:07-07:00
---


(Sorry for breaking the thread, I just subscribed.)

I am experiencing very low performance as well. I'm attaching a small
benchmark script. Writing 32 KB chunks yields a much higher rate first,
then disk activity starts after about 4 seconds and throughput is
trashed to about 30-50 put/s. This is on a standard 60 MB/s 12ms
drive.

I've tested both innostore\_riak and riak\_kv\_bitcask\_backend. The
latter shows /slightly/ improved performance. What's odd is that there's
always a lot of data read, despite the script not reading data.

Are there any special Linux knobs or secret backend parameters?


Stephan
-module(riak\_bench).

-export([run/1]).

-define(BUCKET, &lt;&lt;"benchmark"&gt;&gt;).
-record(state, {last\_print = make\_timestamp(),
 i = 0,
 pending = 0,
 threshold = 1,
 done = 0, last\_done = 0,
 client, 
 doc = gen\_doc(32 \* 1024)}).

run(Threshold) -&gt;
 {ok, Client} = riak:client\_connect('r...@127.0.0.1'),
 loop(#state{client = Client,
 threshold = Threshold}).

gen\_doc(Size) -&gt;
 list\_to\_binary([&lt;&lt;(I rem 256)&gt;&gt;
 || I &lt;- lists:seq(1, Size)]).

loop(#state{i = I,
 pending = Pending,
 threshold = Threshold,
 client = Client,
 doc = Doc} = State)
 when Pending &lt; Threshold -&gt;
 J = I + 1,
 Caller = self(),
 spawn\_link(fun() -&gt;
 K = list\_to\_binary(io\_lib:format("test-~B", [J])),
 RObj = riak\_object:new(?BUCKET, K, Doc),
 ok = Client:put(RObj, 1, 1),
 Caller ! done
 end),
 loop(State#state{i = J,
 pending = Pending + 1});
loop(#state{pending = Pending, last\_print = LastPrint,
 done = Done, last\_done = LastDone} = State) -&gt;
 receive
 done -&gt;
 Now = make\_timestamp(),
 NewDone = Done + 1,
 if
 Now &gt;= LastPrint + 1.0 -&gt;
 io:format("~B done, ~.1f put/s~n", [NewDone, (NewDone - 
LastDone) / (Now - LastPrint)]),
 loop(State#state{pending = Pending - 1,
 done = NewDone,
 last\_print = Now,
 last\_done = NewDone});
 true -&gt;
 loop(State#state{pending = Pending - 1,
 done = NewDone})
 end
 end.

make\_timestamp() -&gt;
 {MS, S, SS} = now(),
 MS \* 1000000 + S + SS / 1000000.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

