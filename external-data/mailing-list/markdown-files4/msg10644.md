---
title: "Re: Keys not listed during vnode transfers"
description: ""
project: community
lastmod: 2013-04-02T16:12:18-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10644"
mailinglist_parent_id: "msg10642"
author_name: "Daniel Iwan"
project_section: "mailinglistitem"
sent_date: 2013-04-02T16:12:18-07:00
---


Hi Mark

Thanks for info. For the moment I thought we were the only one experiencing
this.

At the moment the only workaround for us is to wait until vnode transfer is
finished.
I suspect attaching a node also will trigger that behaviour. Considering
that expanding cluster from 3 to 4 nodes can take quite some time
the fact that we are not able to receive all keys via 2i means system is
not available during attaching a node(s).

I'll keep an eye on the issue and I'll put as much information I can.

Daniel.






On 2 April 2013 22:46, Mark Phillips  wrote:

&gt; Hi Daniel,
&gt;
&gt; Sorry for the delay here.
&gt;
&gt; It looks like it's going to take a more investigation to nail down the
&gt; cause. Engel just opened an issue you can keep an eye on:
&gt;
&gt; https://github.com/basho/riak/issues/305
&gt;
&gt; Thanks for reporting. Feel free to add any relevant information to the
&gt; issue.
&gt;
&gt; Mark
&gt;
&gt; On Thursday, March 14, 2013, Daniel Iwan wrote:
&gt;
&gt;&gt; Maybe someone from Basho could shed some light on that issue?
&gt;&gt;
&gt;&gt; Regards
&gt;&gt; Daniel
&gt;&gt;
&gt;&gt;
&gt;&gt; On 12 March 2013 11:55, Daniel Iwan  wrote:
&gt;&gt;
&gt;&gt;&gt; Just to add to that.
&gt;&gt;&gt; Further test shows that 2i searches aso suffer form the problem of not
&gt;&gt;&gt; showing all results durring active vnode transfer.
&gt;&gt;&gt; Is this a known issue with Riak 1.2.1? Has it been solved in 1.3?
&gt;&gt;&gt;
&gt;&gt;&gt; Anyone else experienced that? I guess attaching a node would trigger
&gt;&gt;&gt; that as well, maybe in less severe way.
&gt;&gt;&gt; Also I've read somewhere that you should attach one node at a time to
&gt;&gt;&gt; Riak cluster, and wait until vnode transfer completes.
&gt;&gt;&gt; I think it's no longer true in 1.2 since you have a plan that you
&gt;&gt;&gt; commit, but attaching a node and shuffling vnodes will cause problem
&gt;&gt;&gt; described
&gt;&gt;&gt;
&gt;&gt;&gt; What is the solution here? Waiting until vnode transfer finishes is not
&gt;&gt;&gt; acceptable (availability) and recent findings show it may take a while on
&gt;&gt;&gt; big clusters.
&gt;&gt;&gt;
&gt;&gt;&gt; Regards
&gt;&gt;&gt; Daniel
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 11 March 2013 23:06, Daniel Iwan  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'm aware that listing keys is not for production.
&gt;&gt;&gt;&gt; I'm using it mainly during testing, which started to be unreliable
&gt;&gt;&gt;&gt; after changes described above.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; What I was not expecting at all was that some of the keys won't be
&gt;&gt;&gt;&gt; listed.
&gt;&gt;&gt;&gt; I'm not sure if that is stated in documentation to tell the truth.
&gt;&gt;&gt;&gt; To me it looks like it should be called 'listSomeKeys'
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; About alternatives.
&gt;&gt;&gt;&gt; Some time ago I did comparison of listing and 2i and MapReduce and
&gt;&gt;&gt;&gt; surprisingly listing was quickest.
&gt;&gt;&gt;&gt; I'm not sure why it was happening. I did similar tests today and what I
&gt;&gt;&gt;&gt; got is:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 1000 keys, grouped with 2i into 10 equal groups, each value &lt; 1kB
&gt;&gt;&gt;&gt; Listing:
&gt;&gt;&gt;&gt; - via listkeys 276ms
&gt;&gt;&gt;&gt; - via keyindex $key: 255ms
&gt;&gt;&gt;&gt; - via 2i (10 calls), total 2480ms
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; So for that simple case 2i is 10 times slower.
&gt;&gt;&gt;&gt; Further test shows that 100k keys (100 groups, 1000 each) gives query
&gt;&gt;&gt;&gt; response between 250-5500ms.
&gt;&gt;&gt;&gt; Not good. It's almost silly NOT to use listing keys.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I may need to do that test on different hardware to compare. At the
&gt;&gt;&gt;&gt; moment I'm using just one 7200rpm HDD for Riak db.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Daniel
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

