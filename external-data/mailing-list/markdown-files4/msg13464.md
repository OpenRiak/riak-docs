---
title: "Re: Riak Search and Yokozuna Backup Strategy"
description: ""
project: community
lastmod: 2014-01-23T10:45:34-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13464"
mailinglist_parent_id: "msg13463"
author_name: "Joe Caswell"
project_section: "mailinglistitem"
sent_date: 2014-01-23T10:45:34-08:00
---


Apologies, clicked send in the middle of an incomplete thought. It should
have read:

Backing up the LevelDB data files while the node is stopped would remove the
necessity of using the LevelDB repair process upon restoring to make the
vnode self-consistent.

From: Joe Caswell 
Date: Thursday, January 23, 2014 1:25 PM
To: Sean McKibben , Elias Levy

Cc: "riak-users@lists.basho.com" 
Subject: Re: Riak Search and Yokozuna Backup Strategy

Backing up LevelDB data files can be accomplished while the node is running
if the sst\_x directories are backed up in numerical order. The undesirable
side effects of that could be duplicated data, inconsistent manifest, or
incomplete writes, which necessitates running the leveldb repair process
upon restoration for any vnode backed up while the node was running. Since
the data is initially written to the recovery log before being appended to
level 0, and any compaction operation fully writes the data to its new
location before removing it from its old location, if any of these
operations are interrupted, the data can be completely recovered by leveldb
repair. 

The only incomplete write that won't be recovered by the LevelDB repair
process is the initial write to the recovery log, limiting exposure to the
key being actively written at the time of the snapshot/backup. As long as 2
vnodes in the same preflist are not backed up while simultaneously writing
the same key to the recovery log (i.e. rolling backups are good), this key
will be recovered by AAE/read repair after restoration.

Backing up the LevelDB data files while the node is stopped would remove the
necessity of repairing the

Backing up Riak Search data, on the other hand, is a dicey proposition.
There are 3 bits to riak search data: the document you store, the output of
the extractor, and the merge index.

When you put a document in &lt;&lt;"key"&gt;&gt; in a &lt;&lt;"bucket"&gt;&gt; with search enabled,
Riak uses the pre-defined extractor to parse the document into terms,
possibly flattening the structure, and stores the result in
&lt;&lt;"\_rsid\_bucket"&gt;&gt;/&lt;&lt;"key"&gt;&gt;, which is used during update operations to
remove stale entries before adding new ones, and would most likely be stored
in a different vnode, possibly on a different node entirely. The document
id/link is inserted into the merge index entry for each term identified by
the extractor, any or all of which may reside on different nodes. Since the
document, its index document, and the term indexes could not be guaranteed
to be captured in any single backup operation, it is a very real probability
that these would be out of sync in the event that a restore is required.

If restore is only required for a single node, consistency could be restored
by running a repair operation for each riak\_kv vnode and riak\_search vnode
stored on the node, which would repair the data from other nodes in the
cluster. If more than one node is restored, it is quite likely that they
both stored replicas of the same data, for some subset of the full data set.
The only way to ensure consistency is fully restored in the latter case is
to reindex the data set. This can be accomplished by reading and rewriting
all of the data, or by reindexing via MapReduce as suggested in this earlier
mailing list post: 
http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2012-October/009
861.html

In either restore case, having a backup of the merge\_index data files is not
helpful, so there does not appear to be any point in backing them up.

Joe Caswell
From: Sean McKibben 
Date: Tuesday, January 21, 2014 1:04 PM
To: Elias Levy 
Cc: "riak-users@lists.basho.com" 
Subject: Re: Riak Search and Yokozuna Backup Strategy

+1 LevelDB backup information is important to us


On Jan 20, 2014, at 4:38 PM, Elias Levy  wrote:

&gt; Anyone from Basho care to comment?
&gt; 
&gt; 
&gt; On Thu, Jan 16, 2014 at 10:19 AM, Elias Levy 
&gt; wrote:
&gt;&gt; 
&gt;&gt; Also, while LevelDB appears to be largely an append only format, the
&gt;&gt; documentation currently does not recommend live backups, presumably because
&gt;&gt; there are some issues that can crop up if restoring a DB that was not cleanly
&gt;&gt; shutdown. 
&gt;&gt; 
&gt;&gt; I am guessing those issues are the ones documented as edge cases here:
&gt;&gt; https://github.com/basho/leveldb/wiki/repair-notes
&gt;&gt; 
&gt;&gt; That said, it looks like as of 1.4 those are largely cleared up, at least
&gt;&gt; from what I gather from that page, and that one must only ensure that data is
&gt;&gt; copied in a certain order and that you run the LevelDB repair algorithm when
&gt;&gt; retiring the files.
&gt;&gt; 
&gt;&gt; So is the backup documentation on LevelDB still correct? Will Basho will
&gt;&gt; enable hot backups on LevelDB backends any time soon?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Thu, Jan 16, 2014 at 10:05 AM, Elias Levy 
&gt;&gt; wrote:
&gt;&gt;&gt; How well does Riak Search play with backups? Can you backup the Riak Search
&gt;&gt;&gt; data without bringing the node down?
&gt;&gt;&gt; 
&gt;&gt;&gt; The Riak documentation backup page is completely silent on Riak Search and
&gt;&gt;&gt; its merge\_index backend.
&gt;&gt;&gt; 
&gt;&gt;&gt; And looking forward, what is the backup strategy for Yokozuna? Will it make
&gt;&gt;&gt; use of Solr's Replication Handler, or something more lower level? Will the
&gt;&gt;&gt; node need to be offline to backup it up?
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ riak-users mailing list
riak-users@lists.basho.comhttp://lists.basho.com/mailman/listinfo/riak-users
\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

