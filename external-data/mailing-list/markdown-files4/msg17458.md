---
title: "Re: How to cold (re)boot a cluster with already existing node data"
description: ""
project: community
lastmod: 2016-06-06T10:39:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17458"
mailinglist_parent_id: "msg17456"
author_name: "Jan-Philip Loos"
project_section: "mailinglistitem"
sent_date: 2016-06-06T10:39:09-07:00
---


On Mon, 6 Jun 2016 at 16:52 Alex Moore  wrote:

&gt; Hi Jan,
&gt;
&gt; When you update the Kubernates nodes, do you have to do them all at once
&gt; or can they be done in a rolling fashion (one after another)?
&gt;

Thnaks for your reply,

sadly this is not possible. Kubernetes with GKE just tears all nodes down,
creating new nodes with new kubernets version and reschedule all services
on these nodes. So after an upgrade, all riak nodes are stand-alone (when
starting after deleting /var/lib/riak/ring)

Greetings

Jan


&gt; If you can do them rolling-wise, you should be able to:
&gt;
&gt; For each node, one at a time:
&gt; 1. Shut down Riak
&gt; 2. Shutdown/restart/upgrade Kubernates
&gt; 3. Start Riak
&gt; 4. Use `riak-admin force-replace` to rename the old node name to the new
&gt; node name
&gt; 5. Repeat on remaining nodes.
&gt;
&gt; This is covered in "Renaming Multi-node clusters
&gt; "
&gt; doc.
&gt;
&gt; As for your current predicament, have you created any new buckets/changed
&gt; bucket props in the default namespace since you restarted? Or have you only
&gt; done regular operations since?
&gt;
&gt; Thanks,
&gt; Alex
&gt;
&gt;
&gt; On Mon, Jun 6, 2016 at 5:25 AM Jan-Philip Loos  wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; we are using riak in a kuberentes cluster (on GKE). Sometimes it's
&gt;&gt; necessary to reboot the complete cluster to update the kubernetes-nodes.
&gt;&gt; This results in a complete shutdown of the riak cluster and the riak-nodes
&gt;&gt; are rescheduled with a new IP. So how can I handle this situation? How can
&gt;&gt; I form a new riak cluster out of the old nodes with new names?
&gt;&gt;
&gt;&gt; The /var/lib/riak directory is persisted. I had to delete the
&gt;&gt; /var/lib/riak/ring folder otherwise "riak start" crashed with this message
&gt;&gt; (but saved the old ring state in a tar):
&gt;&gt;
&gt;&gt; {"Kernel pid
&gt;&gt;&gt; terminated",application\_controller,"{application\_start\_failure,riak\_core,{{shutdown,{failed\_to\_start\_child,riak\_core\_broadcast,{'EXIT',{function\_clause,[{orddict,fetch,['
&gt;&gt;&gt; riak@10.44.2.8
&gt;&gt;&gt; ',[]],[{file,\"orddict.erl\"},{line,72}]},{riak\_core\_broadcast,init\_peers,1,[{file,\"src/riak\_core\_broadcast.erl\"},{line,616}]},{riak\_core\_broadcast,start\_link,0,[{file,\"src/riak\_core\_broadcast.erl\"},{line,116}]},{supervisor,do\_start\_child,2,[{file,\"supervisor.erl\"},{line,310}]},{supervisor,start\_children,3,[{file,\"supervisor.erl\"},{line,293}]},{supervisor,init\_children,2,[{file,\"supervisor.erl\"},{line,259}]},{gen\_server,init\_it,6,[{file,\"gen\_server.erl\"},{line,304}]},{proc\_lib,init\_p\_do\_apply,3,[{file,\"proc\_lib.erl\"},{line,239}]}]}}}},{riak\_core\_app,start,[normal,[]]}}}"}
&gt;&gt;&gt; Crash dump was written to: /var/log/riak/erl\_crash.dump
&gt;&gt;&gt; Kernel pid terminated (application\_controller)
&gt;&gt;&gt; ({application\_start\_failure,riak\_core,{{shutdown,{failed\_to\_start\_child,riak\_core\_broadcast,{'EXIT',{function\_clause,[{orddict,fetch,['
&gt;&gt;&gt; riak@10.44.2.8',
&gt;&gt;
&gt;&gt;
&gt;&gt; The I formed a new cluster via join & plan & commit.
&gt;&gt;
&gt;&gt; But now, I discovered a problems with incomplete and inconsistent
&gt;&gt; partitions:
&gt;&gt;
&gt;&gt; \*$ \*curl -Ss "
&gt;&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt;&gt; | jq '.[] | length'
&gt;&gt;
&gt;&gt; 3064
&gt;&gt;
&gt;&gt; \*$\* curl -Ss "
&gt;&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt;&gt; | jq '.[] | length'
&gt;&gt;
&gt;&gt; 2987
&gt;&gt;
&gt;&gt; \*$\* curl -Ss "
&gt;&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt;&gt; | jq '.[] | length'
&gt;&gt;
&gt;&gt; 705
&gt;&gt;
&gt;&gt; \*$\* curl -Ss "
&gt;&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt;&gt; | jq '.[] | length'
&gt;&gt; 3064
&gt;&gt;
&gt;&gt; Is there a way to fix this? I guess this is caused by the missing old
&gt;&gt; ring-state?
&gt;&gt;
&gt;&gt; Greetings
&gt;&gt;
&gt;&gt; Jan
&gt;&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

