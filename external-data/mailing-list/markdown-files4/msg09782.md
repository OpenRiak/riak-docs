---
title: "Re: Riak and host names"
description: ""
project: community
lastmod: 2013-01-09T22:09:30-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09782"
mailinglist_parent_id: "msg09752"
author_name: "Matt Black"
project_section: "mailinglistitem"
sent_date: 2013-01-09T22:09:30-08:00
---


A quick update on this subject.

Using an Elastic IP won't help with AWS since that only binds to the public
interface - not the internal private one. The hostname command still
returns the same internal IP address as before, which is what's seen by
Riak.

In AWS an internal IP address will actually persist across reboots. It does
not persist across shutdown and startup.


On 8 January 2013 10:16, Richard Shaw  wrote:

&gt; Hi Matt,
&gt;
&gt; Just to add to Charlie's suggestion, you could take a look at EC2 elastic
&gt; IP addresses which would allow you to permanently map a public and private
&gt; address to an EC2 instance, assignDNS hostnames and not have them change on
&gt; reboot[1]
&gt;
&gt; [1] http://aws.amazon.com/articles/1346
&gt;
&gt; Regards
&gt;
&gt; Richard
&gt;
&gt; On 7 Jan 2013, at 23:03, Charlie Voiselle  wrote:
&gt;
&gt; &gt; Matt:
&gt; &gt;
&gt; &gt; You would need to use (or implement your own) DNS service that you could
&gt; programmatically access--Route 53 has an API that you could use to create
&gt; DNS entries that point to the internal addresses of your nodes. In very
&gt; carefully re-reading the thread Deepak mentions, one problem that will
&gt; occur is that each node needs to be able to resolve the other nodes by name
&gt; also. The only way for this to occur reasonably, would be to register the
&gt; internal addresses with a single point that they share. Some examples of
&gt; free services that you might use for this are DynDns[1], DNSDynamic[2], or
&gt; DNS-O-Matic[3]. I have also seen some projects floating around the web
&gt; that might enable you to create a self-hosted dynamic DNS like opendyn[4]
&gt; and GnuDIP[5]; however, I have had no occasion to use something like this
&gt; in my own environment. Some additional discussion about creating your own
&gt; Dynamic DNS server is also at
&gt; http://unix.stackexchange.com/questions/29049/how-to-create-a-custom-dynamic-dns-solution
&gt; &gt;
&gt; &gt; Hope this helps!
&gt; &gt; Charlie
&gt; &gt;
&gt; &gt; [1] http://www.dyn.com
&gt; &gt; [2] http://www.dnsdynamic.org
&gt; &gt; [3] http://www.dnsomatic.com
&gt; &gt; [4] http://code.google.com/p/opendyn/
&gt; &gt; [5] http://gnudip2.sourceforge.net/
&gt; &gt;
&gt; &gt; On Jan 7, 2013, at 5:00 PM, Matt Black 
&gt; wrote:
&gt; &gt;
&gt; &gt;&gt; Thanks for this Charlie.
&gt; &gt;&gt;
&gt; &gt;&gt; I'm running a production Riak cluster on AWS which runs constantly, and
&gt; I've been wondering how I might be able to easliy stop and start AWS nodes
&gt; for a testing and benchmarking cluster (to save on cost).
&gt; &gt;&gt;
&gt; &gt;&gt; By using the 'riaknode1.priv' hostname method you describe, would I be
&gt; able to stop and then restart a whole cluster of nodes at once? (As
&gt; described by Deepak, AWS assigns new IPs when a VM starts).
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks
&gt; &gt;&gt; Matt
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; On 8 January 2013 01:31, Charlie Voiselle  wrote:
&gt; &gt;&gt; Deepak:
&gt; &gt;&gt;
&gt; &gt;&gt; When you name a node in app.config with -name it has to have a '.' in
&gt; it, like r...@hostname.net As you have surmised, you can get around
&gt; that if you use the -sname argument instead.
&gt; &gt;&gt;
&gt; &gt;&gt; They have to be done consistently. In your example, had you used the
&gt; -sname argument, `riak@riaknode1` would work. Making a host entry
&gt; `riaknode1.priv` that points to the local address would work with the -name
&gt; argument.
&gt; &gt;&gt;
&gt; &gt;&gt; The inportant thing about -name and -sname is that they can't mix
&gt; within a cluster.
&gt; &gt;&gt;
&gt; &gt;&gt; Cluster replace is designed to replace a node with a new one and
&gt; transfer all the partitions. You can cheat and use it to rename a node
&gt; though.
&gt; &gt;&gt;
&gt; &gt;&gt; The process to do this would look like the following:
&gt; &gt;&gt;
&gt; &gt;&gt; • Stop the node to rename with `riak stop`
&gt; &gt;&gt; • Mark it 'down' from another node in the cluster using
&gt; `riak-admin down «old nodename».
&gt; &gt;&gt; • Rename the node in vm.args.
&gt; &gt;&gt; • Delete the ring directory.
&gt; &gt;&gt; • Start the node with `riak start`.
&gt; &gt;&gt; • It will come up as a single instance which you can verify with
&gt; `riak-admin member-status`.
&gt; &gt;&gt; • Join the node to the cluster with `riak-admin cluster join
&gt; «cluster nodename» `
&gt; &gt;&gt; • Set it to replace the old instance of itself with `riak-admin
&gt; cluster replace «old nodename» «new nodename»
&gt; &gt;&gt; • Plan the changes with `riak-admin cluster plan`
&gt; &gt;&gt; • Commit the changes with `riak-admin cluster commit`
&gt; &gt;&gt;
&gt; &gt;&gt; As you can see, this is a very large effort, so best to use hostnames
&gt; that aren't moving around. Apologies for you getting this twice, Deepak. I
&gt; failed to reply to the list as well.
&gt; &gt;&gt;
&gt; &gt;&gt; Hope this makes sense...
&gt; &gt;&gt; Charlie
&gt; &gt;&gt;
&gt; &gt;&gt; On Jan 1, 2013, at 2:43 PM, Deepak Balasubramanyam &lt;
&gt; deepak.b...@gmail.com&gt; wrote:
&gt; &gt;&gt;
&gt; &gt;&gt;&gt; I took the AWS EC2 riak image for a spin today. I have a query
&gt; regarding riak nodes and how they behave when the machine reboots.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; When an EC2 instance reboots, the internal ip / internal DNS /
&gt; external DNS change. This renders the app.config and -name argument on
&gt; vm.args incorrect. I was exploring solutions to deal with this problem.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; 1. Preventive measures
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Someone on this thread dated May 2011 suggested using host file
&gt; entries that point to the local internal IP address. That does not seem to
&gt; work. Riak fails with the following error when I add a new entry to
&gt; /etc/hosts and configure vm.args with -name riak@riaknode1
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Hostname riaknode1 is illegal
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I confirmed that riaknode1 pings correctly before starting riak. I
&gt; guess erlang tries to match the hostname of the system resulting in this
&gt; failure ? Can anyone throw some light on this ?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; 2. Use -sname
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Is starting the erlang VM with the sname flag an option if it will
&gt; help prevent the 'illegal hostname' error ?
&gt; &gt;&gt;&gt; Disclaimer: My knowledge of erlang is close to zilch, so sorry if that
&gt; option sounded like something you could dismiss easily :)
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; 3. Use cluster replace
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; a. I understand that the IPs in app.config and vm.args can be replaced
&gt; with the correct IP on a restart and using a subsequent 'cluster replace'
&gt; command will do. Will executing the 'cluster plan' and 'cluster commit'
&gt; commands now produce network chatter ?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; b . What happens if 2 nodes go down and one was joined with the other.
&gt; They both have 2 different IP addresses on restart. How will 'cluster
&gt; replace' work now ?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Do let me know your thoughts.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thanks
&gt; &gt;&gt;&gt; -Deepak
&gt; &gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

