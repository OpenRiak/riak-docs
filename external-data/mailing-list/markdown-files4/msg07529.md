---
title: "Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys"
description: ""
project: community
lastmod: 2012-05-24T08:28:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07529"
mailinglist_parent_id: "msg07521"
author_name: "Reid Draper"
project_section: "mailinglistitem"
sent_date: 2012-05-24T08:28:00-07:00
---


I have a pretty good idea what is causing this problem.

Riak uses "tombstone" values to denote that an object has been deleted.
Under normal conditions, this tombstone value (really, the key/value pair)
will be deleted three (3) seconds after the delete. The delete\_mode config
lets you change the time from three seconds, or to put it at immediate or
keep.

Regardless of the value of delete\_mode, the key will continue to show
up in list-keys and 2i $key queries as long as the tombstone is still
around. This is because those calls simply iterate through the keys,
and don't inspect the values for tombstones (this could potentially
by quite costly, depending on the backend). 

For a more detailed explanation of deletes in Riak, I highly
suggest you read Jon Meredith's ML post [1].

Since in both of these cases, you have delete\_mode set to either
3s or immediate, we are seeing a case where the first time the tombstone
is attempted to be reaped, it fails. The tombstone reaping isn't attempted
again until you do a GET on the object, which is why you see it no longer
appear in 2i and list-keys queries afterward. This is because a read-repair-like
mechanism runs and sees that the tombstone needs to be reaped.

So why is the tombstone reap failing the first time? There could be several
reasons. It's important to know, first, that the reaping process requires all
N \_primary\_ replicas to be up and responding. Here are some potential
reasons:

1. One of the primaries is temporarily unreachable.
2. The original tombstone writes didn't go to all N primaries, for any reason
3. The async GET after that starts the tombstone reaping times out, for any 
reason

I don't have a silver-bullet recommendation for this problem at the moment.
If you'd like to favor having deleted keys \_not\_ show up in 2i/list-keys
requests over delete-availability, you can make your delete requests
with PR = PW = R = W = all (note 'all' is equivalent to whatever your bucket's
N value is).

We'll also be exploring how we can fix or mitigate this situation for
an upcoming release.

[1]: 
http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html

Thanks,
Reid Draper
Software Engineer
Basho

On May 23, 2012, at 4:42 PM, Steve Warren wrote:

&gt; I have a 5 node cluster and given a successful delete call, I expect to get 
&gt; the latest data back given the bucket properties (as shown below)...
&gt; 
&gt; Bucket properties:
&gt; 
&gt; {"props":{"name":"mybucket","allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":4,"notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":"quorum","precommit":[],"pw":"quorum","r":"quorum","rw":"quorum","small\_vclock":50,"w":"quorum","young\_vclock":20}}
&gt; 
&gt; Is my understanding not correct in this (the important properties to me are 
&gt; the pw/pr settings to ensure a good distribution and consistency).
&gt; 
&gt; Regards
&gt; Steve
&gt; 
&gt; On Wed, May 23, 2012 at 1:31 PM, Shuhao Wu  wrote:
&gt; Riak is eventually consistent. Deleting it doesn't show up immediately. There 
&gt; is an option like delete\_immediate
&gt; 
&gt; Shuhao
&gt; 
&gt; On May 23, 2012 4:08 PM, "Steve Warren"  wrote:
&gt; I'm seeing this pretty consistently and have no explanation for it. I delete 
&gt; a large number of keys (20k to 100k), but when I then search on the keys 
&gt; ($key/0/g) anywhere from 0-200 or so of the deleted keys show up in the 
&gt; results. It doesn't matter how long I wait after completing the deletion 
&gt; step, the keys stay in the list until I try to access the object and then it 
&gt; goes away. I'm using 1.1.2 and the riak-java client, and getting no errors on 
&gt; the deletion step.
&gt; 
&gt; On Tue, May 22, 2012 at 9:34 AM, Steve Warren  wrote:
&gt; Thank you for the reply. My observation does not quite match up with this 
&gt; though so I'm still a bit confused. The deleted keys appeared to stay long 
&gt; past the 3 seconds described in the post you referenced. In fact, I don't 
&gt; know if they ever "went away". I'll run some more tests to see if I can 
&gt; narrow down the exact behavior, for example not all key deletions exhibited 
&gt; this behavior (the test I ran resulted in 118 residual keys out of around 20K 
&gt; deletes). If I directly queried any of the keys it would respond with "not 
&gt; found" and immediately stop showing up in the key list or $key index query.
&gt; 
&gt; I'm still running a bunch of tests just to learn the behavior of the system 
&gt; so I'll keep plugging away at it. For example, I'm observing that $key index 
&gt; queries halt inserts into the same bucket while the query is running, I don't 
&gt; know yet if this halts all server activity or just the inserts for that 
&gt; bucket though.
&gt; 
&gt; Regards
&gt; Steve
&gt; 
&gt; On Tue, May 22, 2012 at 8:58 AM, Kelly McLaughlin  wrote:
&gt; Hi Steve. There is no caching of key lists in riak. What you are seeing is 
&gt; likely the fact that listing of keys or index queries can pick up deleted 
&gt; keys due to the fact that riak keeps tombstone markers around for deleted 
&gt; objects for some period. For a really good explanation of riak's delete 
&gt; behavior check out this writeup by Jon Meredith: 
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html.
&gt; You can set delete\_mode to immediate as described in that post and you will 
&gt; most likely not see any deleted keys when you do an index query or key list. 
&gt; The tradeoff is that you may get the unexpected behavior when doing 
&gt; concurrent updates to the same set of keys that the delete\_mode changes were 
&gt; designed to address as Jon also indicates in that post. We are considering 
&gt; different options on this front, but at this time no actual changes have been 
&gt; made to address this. 
&gt; 
&gt; Kelly
&gt; 
&gt; On May 20, 2012, at 10:13 AM, Steve Warren wrote:
&gt; 
&gt;&gt; The last message I saw on this (from a year ago) says the caching of key 
&gt;&gt; lists will be removed. I just ran into it while running a $key index range 
&gt;&gt; search. I then ran a ?key=stream search on the bucket and the same stale key 
&gt;&gt; list appeared (I had created a bunch of data and then deleted it as a test). 
&gt;&gt; Did the caching removal not happen? I'm running 1.1.2
&gt;&gt; 
&gt;&gt; The query:
&gt;&gt; 
&gt;&gt; curl 'localhost:8098/buckets/testbucket/index/$key/0/g'
&gt;&gt; 
&gt;&gt; As others have noted, this behavior is quite disconcerting and I don't want 
&gt;&gt; to pepper the application with otherwise unnecessary checks for stale keys 
&gt;&gt; even on 2i range queries. Or is that unavoidable?
&gt;&gt; 
&gt;&gt; Regards
&gt;&gt; Steve
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

