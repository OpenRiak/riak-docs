---
title: "some problems with storage statistic calculation"
description: ""
project: community
lastmod: 2014-08-11T04:05:30-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14637"
author_name: "Stanislav Vlasov"
project_section: "mailinglistitem"
sent_date: 2014-08-11T04:05:30-07:00
---


Hello!

We have 8 nodes with riak+riak-cs, about 7 Tb data in cluster.
Some time riak process dead by OOM on several nodes when large
(~100Gb) file was writed via s3cmd, because riak-cs eated all memory.
After recovering we experiencing the following problems:

1) very slow storage statistic calculation (about two hour). Before
oom it was done in 40 minutes.

2) 4000000+ files in bucket touristerru, no storage statistic counted:
riak-cs/error.log:
2014-08-11 00:12:28.096 [error]
&lt;0.5987.49&gt;@riak\_cs\_storage:maybe\_sum\_bucket:74 failed to calculate
usage of bucket 'touristerru' of user 'OF6DQ0FRBTEVLKGY-X0
P'. Reason: {error,&lt;&lt;"{\"phase\":0,\"error\":\"[{vnode\_proxy\_timeout,

After statistic request for this user we see some like this:

{u'Access': u'not\_requested',
 u'Storage': {u'Errors': [],
 u'Samples': [{u'EndTime': u'20140811T091836Z',
 u'StartTime': u'20140811T091113Z',
 u'touristerru':
u'{error,&lt;&lt;"{\\"phase\\":0,\\"error\\":\\"[{vnode\_proxy\_timeout,{228359630832953580969325755111919221821239459840,\'riak@192.168.0.8\'}}]\\",\\"input\\":\\"{&lt;&lt;48,111,58,185,253,24,64,48,197,1,20,36,130,111,222,189,75,202,107&gt;&gt;,&lt;&lt;\\\\\\"files/3/8/6/5/3/5/2/clones/870\_527\_fixedwidth.jpg\\\\\\"&gt;&gt;}\\",\\"type\\":\\"result\\",\\"stack\\":\\"[{gen,do\_call,4,[{file,\\\\\\"gen.erl\\\\\\"},{line,234}]},{riak\_core\_vnode\_proxy,call,2,[{file,\\\\\\"src/riak\_core\_vnode\_proxy.erl\\\\\\"},{line,109}]},{riak\_pipe\_vnode,queue\_work\_send,4,[{file,\\\\\\"src/riak\_pipe\_vnode.erl\\\\\\"},{line,333}]},{riak\_pipe\_vnode,queue\_work\_erracc,6,[{file,\\\\\\"src/riak\_pipe\_vnode.erl\\\\\\"},{line,281}]},{riak\_kv\_pipe\_get,process,3,[{file,\\\\\\"src/riak\_kv\_pipe\_get.erl\\\\\\"},{line,92}]},{riak\_pipe\_vnode\_worker,process\_input,3,[{file,\\\\\\"src/riak\_pipe\_vnode\_worker.erl\\\\\\"},{line,445}]},{riak\_pipe\_vnode\_worker,wait\_for\_input,...},...]\\"}"&gt;&gt;}'}]}}

3) Crash calculation process:
riak-cs/console.log
2014-08-11 09:22:51.580 [warning]
&lt;0.24095.1&gt;@riak\_cs\_storage\_d:read\_storage\_schedule1:300 No storage
schedule defined. Calculation must be triggered manually.
2014-08-11 09:22:51.580 [error] &lt;0.438.0&gt; gen\_fsm riak\_cs\_storage\_d in
state calculating terminated with reason: no match of right hand value
false in riak\_cs\_storage:sum\_bucket/1 line 104
2014-08-11 09:22:51.580 [error] &lt;0.438.0&gt; CRASH REPORT Process
riak\_cs\_storage\_d with 1 neighbours exited with reason: no match of
right hand value false in riak\_cs\_storage:sum\_bucket/1 line 104 in
gen\_fsm:terminate/7 line 611
2014-08-11 09:22:51.581 [error] &lt;0.153.0&gt; Supervisor riak\_cs\_sup had
child riak\_cs\_storage\_d started with riak\_cs\_storage\_d:start\_link() at
&lt;0.438.0&gt; exit with reason no match of right hand value false in
riak\_cs\_storage:sum\_bucket/1 line 104 in context child\_terminated

What has been done:

System:
1) RAM upgrade from 30 to 61Gb on every node.
2) add some swap on additional ssd (only to avoid OOM, sysctl
vm.swappiness=0 is set)

Riak configs:
1) increase cache\_size in backend config
2) set {mapred\_reduce\_phase\_batch\_size, 5000}
3) set {mapred\_always\_prereduce, true}

Riak-CS configs:
1) set {storage\_archive\_period, 14400}
2) upgrade to 1.5.0 from 1.4.8

Configs: http://ovh.to/iwTiMby
Last logs: http://ovh.to/AHaASw

I don't know what i must to do now.

-- 
Stanislav

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

