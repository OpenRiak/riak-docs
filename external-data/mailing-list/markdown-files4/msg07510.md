---
title: "Re: Riak Map / Reduce / Map capacity limit reached at 20000 keys /	Doubt about reduce step"
description: ""
project: community
lastmod: 2012-05-22T15:45:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07510"
mailinglist_parent_id: "msg07502"
author_name: "Matthew Tovbin"
project_section: "mailinglistitem"
sent_date: 2012-05-22T15:45:32-07:00
---


Claude,

This should work:

 function(v) {return [v.reduce(function(total, value) {if
(isNaN(parseInt(value))) { return total + 1;} else{return total + value;}},
0)];}


(It's an example from http://riakhandbook.com/)


-Matthew



On Tue, May 22, 2012 at 9:09 AM,  wrote:

&gt; Dear Matthew,
&gt;
&gt; The capacity adjustment at the Java script engines worked fine. I was able
&gt; to run a clean-up on the database. I also decided o double the JS memory
&gt; space to 16 MB, as RAM is not the issue on our server, There is still a
&gt; doubt about the Map & Reduce syntax which is not giving a matching result:
&gt;
&gt; My simple JavaScript, pattern scan & count works OK and delivers a counter
&gt; for a pattern search :
&gt;
&gt; query.map("""function(v) { var str = '"""+search\_string+"""'; var data =
&gt; JSON.parse(v.values[0].data); if
&gt; (v.values[0].data.toString().toUpperCase().search(str) != -1) { return
&gt; [[v.key, data]]; } return []; }""")
&gt; query.reduce("function(v) { var counteri = 0; for(var i in v) {counteri
&gt; += 1;} return [['counter\_found', counteri]]; } ")
&gt;
&gt; The map function as you sent below returns a list of keys and 1 like this
&gt;
&gt;
&gt; query.map("""function(v) {if
&gt; (v.values[0].data.search('"""+search\_string+"""') != -1) { return [[v.key,
&gt; 1]]; } return []; }""")
&gt;
&gt; How many keys in the bucket: 1000
&gt; agFa82470070 - 1
&gt; sDko48992336 - 1
&gt; eFxO66269553 - 1
&gt; Sovt26572593 - 1
&gt; ..
&gt;
&gt; This looks good. By using the JavaScript \*reduce\* function I get a zero
&gt; result
&gt;
&gt; Source: query.reduce("function(v) { return
&gt; [v.reduce(function(acc,value){return acc + value;},0)]}")
&gt;
&gt; Output: 0 - 0
&gt;
&gt; Thanks in advance for clarification.
&gt;
&gt; Regards,
&gt; Claude
&gt; \*
&gt; Claude Falbriard
&gt; Certified IT Specialist L2 - Middleware
&gt; AMS Hortolândia / SP - Brazil
&gt; phone: +55 19 9837 0789
&gt; cell: +55 13 8117 3316
&gt; e-mail: clau...@br.ibm.com
&gt; blog: 
&gt; \*\*https://w3.tap.ibm.com/weblogs/inovarMF/\*
&gt; \*
&gt; \*\*
&gt; Project CallOwn Blue \*
&gt;
&gt;
&gt;
&gt; From: Matthew Tovbin 
&gt; To: clau...@br.ibm.com
&gt; Cc: riak-users@lists.basho.com
&gt; Date: 21/05/2012 17:01
&gt; Subject: Re: Riak Map / Reduce / Map capacity limit reached at
&gt; 20000 keys
&gt; Sent by: tovb...@gmail.com
&gt; ------------------------------
&gt;
&gt;
&gt;
&gt; Claude,
&gt;
&gt; 1.
&gt; try to increase js\_vm\_counts as follows:
&gt;
&gt; {riak\_kv, [
&gt; ...
&gt; {map\_js\_vm\_count, 24 },
&gt; {reduce\_js\_vm\_count, 18 },
&gt; ...]
&gt;
&gt; 2. optimize your js function:
&gt; query.map("""function(v) {if
&gt; (v.values[0].data.search('"""+search\_string+"""') != -1) { return [[v.key,
&gt; 1]]; } return []; }""")
&gt; query.reduce("function(v) { return [v.reduce(function(acc,value){return
&gt; acc + value;},0]; } ")
&gt;
&gt;
&gt; -Matthew
&gt;
&gt;
&gt;
&gt; On Mon, May 21, 2012 at 10:02 AM, &lt;\*clau...@br.ibm.com\*&gt;
&gt; wrote:
&gt; Dear colleagues,
&gt;
&gt; During my pilot testing I've got an error message during a text pattern
&gt; search operation coded as a Riak Client "map" logic. This error appeared at
&gt; a volume of approximately 20.000 keys, each with an 1 KB free text data
&gt; block associated. The Map function was coded in JavaScript. Here the
&gt; source:
&gt;
&gt; query.map("""function(v) { var str = '"""+search\_string+"""'; var data =
&gt; JSON.parse(v.values[0].data); if (v.values[0].data.toString().search(str)
&gt; != -1) { return [[v.key, data]]; } return []; }""")
&gt; query.reduce("function(v) { var counteri = 0; for(var i in v) {counteri
&gt; += 1;} return [['counter\_found', counteri]]; } ")
&gt;
&gt; The error shown is the following : \*[preflist\_exhausted]\*
&gt;
&gt; zbra:/opt/python/myprojects/riak # python pilot3.py
&gt; starts at : 2012-05-21 07:35:49.070470
&gt; How many keys in the bucket: 19760
&gt; Riak client exception: Error running MapReduce operation. Status: 500 :
&gt; {"phase":0,"error":"[preflist\_exhausted]","input":"{ok,{r\_object,&lt;&lt;\"ramtest\"&gt;&gt;,&lt;&lt;\"XDHt25887344\"&gt;&gt;,[{r\_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[&lt;&lt;\"Links\"&gt;&gt;]],[],[],[],[],[],[],[],[[&lt;&lt;\"content-type\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\"X-Riak-VTag\"&gt;&gt;,53,86,72,48,120,77,53,99,114,86,111,77,77,54,109,114,79,70,54,52,49,109]],[[&lt;&lt;\"index\"&gt;&gt;]],[],[[&lt;&lt;\"X-Riak-Last-Modified\"&gt;&gt;|{1337,595548,374416}]],[],[[&lt;&lt;\"X-Riak-Meta\"&gt;&gt;]]}}},&lt;&lt;\"{\"is\_valid\":
&gt; true, \"cEDO\":
&gt; \"GQZumfdWBCfX...\"&gt;&gt;}],...},...}","type":"forward\_preflist","stack":"[]"}
&gt;
&gt; Any suggestions how to improve the pattern scan capability in the in the
&gt; RiakClient map function, or how enhance the JavaScript code for better
&gt; capacity?
&gt; Are there any servers setup tuning options to adjust?
&gt;
&gt; Thanks in advance for your support.
&gt;
&gt; Regards,
&gt; Claude\*
&gt;
&gt; Claude Falbriard
&gt; Certified IT Specialist L2 - Middleware
&gt; AMS Hortolândia / SP - Brazil
&gt; phone: \*\*+55 19 9837 0789\* &lt;%2B55%2019%209837%200789&gt;\*
&gt; cell: \*\*+55 13 8117 3316\* &lt;%2B55%2013%208117%203316&gt;\*
&gt; e-mail: \*\*clau...@br.ibm.com\* 
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list\*
&gt; \*\*riak-users@lists.basho.com\* \*
&gt; \*\*http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com\*
&gt;
&gt;
&gt;
&lt;&gt;\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

