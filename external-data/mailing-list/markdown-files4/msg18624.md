---
title: "Re: Riak 2.9.0 - Update Available"
description: ""
project: community
lastmod: 2019-06-28T03:06:06-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18624"
mailinglist_parent_id: "msg18622"
author_name: "Bryan Hunt"
project_section: "mailinglistitem"
sent_date: 2019-06-28T03:06:06-07:00
---


Top quality spelunking - always fun to read - thanks Martin !

&gt; On 28 Jun 2019, at 10:24, Martin Sumner  wrote:
&gt; 
&gt; Bryan,
&gt; 
&gt; We saw that Riak was using much more memory than was expected at the end of 
&gt; the handoffs. Using `riak-admin top` we could see that this wasn't process 
&gt; memory, but binaries. Firstly did some work via attach looping over 
&gt; processes and running GC to confirm that this wasn't a failure to collect 
&gt; garbage - the references to memory were real. Then did a bit of work in 
&gt; attach writing some functions to analyse process\_info/2 for each process 
&gt; (looking at binary and memory), and discovered that there were penciller 
&gt; processes that had lots of references to lots of large binaries (and this 
&gt; accounted for all the unexpected memory use), and where the penciller was the 
&gt; only process with a reference to the binary. This made no sense initially as 
&gt; the penciller should only have small binaries (metadata). Then looked at the 
&gt; running state of the penciller processes and could see no large binaries in 
&gt; the state, but could see that a lot of the active keys in the penciller were 
&gt; keys that were known to have large object values (but small amounts of 
&gt; metadata) - and that the size of the object values were the same as the size 
&gt; of the binary references found on the penciller process via process\_info/2.. 
&gt; 
&gt; I then recalled the first part of this: 
&gt; https://dieswaytoofast.blogspot.com/2012/12/erlang-binaries-and-garbage-collection.html
&gt; 
&gt; .
&gt; It was obvious that in extracting the metadata the beam was naturally 
&gt; retaining a reference to the whole binary, as long as the sub-binary was 
&gt; retained by the a process (the Penciller). Forcing a binary copy resolved 
&gt; this referencing issue. It was nice that the same tools used to detect the 
&gt; issue, made it quite easy to write a test to confirm resolution - 
&gt; https://github.com/martinsumner/leveled/blob/master/test/end\_to\_end/riak\_SUITE.erl#L1214-L1239
&gt; 
&gt; .
&gt; 
&gt; The memory leak section of Fred Herbert's http://www.erlang-in-anger.com/ 
&gt;  is great reading for helping with these 
&gt; types of issues. 
&gt; 
&gt; Thanks
&gt; 
&gt; Martin
&gt; 
&gt; 
&gt; On Fri, 28 Jun 2019 at 09:46, b h  &gt; wrote:
&gt; Nice work - I've read issue / PR - how did you discover / track it down - 
&gt; tools or just reading the code ? 
&gt; 
&gt; On Fri, 28 Jun 2019 at 09:35, Martin Sumner  &gt; wrote:
&gt; There is now a second update available for 2.9.0: 
&gt; https://github.com/basho/riak/tree/riak-2.9.0p2 
&gt; .
&gt; 
&gt; This patch, like the patch before, resolves a memory management issue in 
&gt; leveled, which this time could be triggered by sending many large objects in 
&gt; a short period of time. The underlying problem is described a bit further 
&gt; here https://github.com/martinsumner/leveled/issues/285 
&gt; , and is resolved by 
&gt; leveled working more sympathetically with the beam binary memory management. 
&gt; 
&gt; Switching to the patched version is not urgent unless you are using the 
&gt; leveled backend, and may send a large number of large objects in a burst. 
&gt; 
&gt; Updated packages are available (thanks to Nick Adams at TI Tokyo) - 
&gt; https://files.tiot.jp/riak/kv/2.9/2.9.0p2/ 
&gt; 
&gt; 
&gt; Thanks again to the testing team at the NHS Spine project, Aaron Gibbon 
&gt; (BJSS) and Ramen Sen, who discovered the problem. The issue was discovered 
&gt; in a handoff scenario where there were a tens of thousands of 2MB objects 
&gt; stored in a portion of the keyspace at the end of the handoff - which led to 
&gt; memory issues until either more PUTs were received (to force a persist to 
&gt; disk) or a restart occurred..
&gt; 
&gt; Regards
&gt; 
&gt; 
&gt; On Sat, 25 May 2019 at 09:35, Martin Sumner  &gt; wrote:
&gt; Unfortunately, Riak 2.9.0 was released with an issue whereby a race condition 
&gt; in heavy-PUT scenarios (e.g. handoffs), could cause a leak of file 
&gt; descriptors.
&gt; 
&gt; The issue is described here - https://github.com/basho/riak\_kv/issues/1699 
&gt; , and the underlying issue here 
&gt; - https://github.com/martinsumner/leveled/issues/278 
&gt; .
&gt; 
&gt; There is a new patched version of the release available (2.9.0p1) at 
&gt; https://github.com/basho/riak/tree/riak-2.9.0p1 
&gt; . This should be used in 
&gt; preference to the original release of 2.9.0.
&gt; 
&gt; Updated packages are available (thanks to Nick Adams at TI Tokyo) - 
&gt; https://files.tiot.jp/riak/kv/2.9/2.9.0p1/ 
&gt; 
&gt; 
&gt; Thanks also to the testing team at the NHS Spine project, Aaron Gibbon (BJSS) 
&gt; and Ramen Sen, who discovered the problem.
&gt; 
&gt; Regards
&gt; 
&gt; Martin
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com 
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


-- 


Code Sync & Erlang Solutions Conferences

Code Elixir LDN 
 - London: 18 
July 2019

Code BEAM Lite BD 
 - Budapest: 
20 September 2019

Code BEAM Lite NYC 
 - NYC: 01 
October 2019

RabbitMQ Summit 
 - London: 4 
November 2019

Code Mesh LDN 
 - London: 7-8 
November 2019

Code BEAM Lite India - Bangalore: 14 November 2019

Code 
BEAM Lite AMS  
- Amsterdam: 29 November 2019

Lambda Days 
 - Kraków: 
13-14 February 2020

Code BEAM SF - San Francisco: 5-6 March 2020





\*Erlang Solutions cares about your data and privacy; please find all 
details about the basis for communicating with you and the way we process 
your data in our \*\*Privacy Policy\* 
\*.You can update your 
email preferences or opt-out from receiving Marketing emails here 
.\*
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

