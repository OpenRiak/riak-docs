---
title: "Re: erlang precommit hook error"
description: ""
project: community
lastmod: 2011-11-09T18:18:28-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05532"
mailinglist_parent_id: "msg05481"
author_name: "Joseph Lambert"
project_section: "mailinglistitem"
sent_date: 2011-11-09T18:18:28-08:00
---


AFAIK,

When you do riak\_object:get\_value(), it will return a binary and you are
calling string:tokens on a binary value.

- Joe Lambert

joseph.g.lamb...@gmail.com
+86 13656213284


On Wed, Nov 9, 2011 at 4:01 AM, Hal Eisen  wrote:

&gt; I've made some progress. Looks like I was not compiling my module,
&gt; nor did I have the add\_paths set in app.config.
&gt;
&gt; However, now I'm getting a new failure:
&gt; error:function\_clause
&gt;
&gt; When I look in my erlang.log file, I see this:
&gt; [{string,'tokens1',[&lt;&lt;"my actual data that I am trying to store before
&gt; being processed by the precommit hook"&gt;&gt;,"
&gt; ",[]]},{haleisen,mangle,1},{riak\_kv\_put\_fsm,invoke\_hook,4},{riak\_kv\_put\_fsm,precommit,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]
&gt;
&gt;
&gt; I've updated my mangle/1 function:
&gt; mangle(X) -&gt;
&gt; crypto:start(),
&gt; {\_, Tokens} = lists:partition(fun(Arg) -&gt; lists:member(Arg,
&gt; haleisen:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
&gt; riak\_object:update\_value(X,
&gt; list\_to\_binary(lists:flatten(lists:map(fun(Arg) -&gt; crypto:md5(Arg) end,
&gt; Tokens)))),
&gt; riak\_object:apply\_updates(X).
&gt;
&gt; Am I manipulating the riak\_object correctly?
&gt;
&gt; Is there a recommended way to emit debug message from within Erlang hooks?
&gt;
&gt; Thanks,
&gt; Hal
&gt;
&gt; On Tue, Nov 08, 2011 at 10:01:26AM -0800, Hal Eisen wrote:
&gt; &gt; Sorry, typo in code. the mangle function is actually:
&gt; &gt;
&gt; &gt; mangle(X) -&gt;
&gt; &gt; crypto:start(),
&gt; &gt; {\_, Tokens} = lists:partition(fun(Arg) -&gt; lists:member(Arg,
&gt; mangle:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
&gt; &gt; riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -&gt;
&gt; crypto:md5(Arg) end, Tokens))),
&gt; &gt; riak\_object:apply\_updates(X).
&gt; &gt;
&gt; &gt; In other words, I fixed the module reference.
&gt; &gt;
&gt; &gt; Hal
&gt; &gt;
&gt; &gt; On Tue, Nov 08, 2011 at 09:59:26AM -0800, Hal Eisen wrote:
&gt; &gt; &gt; Hello again. I have given up on using the JavaScript precommit hook
&gt; &gt; &gt; because I could not find anything which did not produce timeouts under
&gt; &gt; &gt; the load for my application.
&gt; &gt; &gt;
&gt; &gt; &gt; So, I have ported my hook to Erlang. Alas, I'm not getting very far.
&gt; &gt; &gt; I've installed my hook in /etc/riak/erl/hooks.erl. The code looks
&gt; &gt; &gt; like this:
&gt; &gt; &gt;
&gt; &gt; &gt; -module(haleisen).
&gt; &gt; &gt; -export([stopwords/0, mangle/1]).
&gt; &gt; &gt; stopwords() -&gt;
&gt; &gt; &gt;
&gt; ["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"].
&gt; &gt; &gt; mangle(X) -&gt;
&gt; &gt; &gt; crypto:start(),
&gt; &gt; &gt; {\_, Tokens} = lists:partition(fun(Arg) -&gt; lists:member(Arg,
&gt; ask:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
&gt; &gt; &gt; riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -&gt;
&gt; crypto:md5(Arg) end, Tokens))),
&gt; &gt; &gt; riak\_object:apply\_updates(X).
&gt; &gt; &gt;
&gt; &gt; &gt; I originally tested the code in the Erlang repl, using a plain string
&gt; &gt; &gt; instead of riak\_object:get\_value, and it worked perfectly.
&gt; &gt; &gt;
&gt; &gt; &gt; I installed my hook into a test bucket:
&gt; &gt; &gt; bash$ curl http://127.0.0.1:8098/riak/test-hook
&gt; &gt; &gt;
&gt; {"props":{"allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"test-with","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"haleisen","fun":"mangle"}],"pw":0,"r":"quorum","rw":"quorum","small\_vclock":10,"w":"quorum","young\_vclock":20}}
&gt; &gt; &gt;
&gt; &gt; &gt; When I try to insert a key into this bucket, I get:
&gt; &gt; &gt; Error:
&gt; &gt; &gt; {precommit\_fail,{hook\_crashed,{haleisen,mangle,error,undef}}}
&gt; &gt; &gt;
&gt; &gt; &gt; Any help would be appreciated.
&gt; &gt; &gt;
&gt; &gt; &gt; Thanks,
&gt; &gt; &gt; Hal
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

