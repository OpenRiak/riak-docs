---
title: "Pre-commit hook debug"
description: ""
project: community
lastmod: 2015-12-01T10:54:12-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16837"
author_name: "Geoff Simonds"
project_section: "mailinglistitem"
sent_date: 2015-12-01T10:54:12-08:00
---


Good afternoon,

I am writing to ask for some help regarding a pre-commit hook in Riak
2.1.1. I am locally running a 5 node Riak dev cluster (
https://github.com/xing/riak-dev-cluster) on a Mac and am having trouble
with a pre-commit hook. I have added the "add\_paths" to my advanced.config:
[
 Riak KV config
{riak\_kv,
 [
 %% Paths to custom erlang modules.
 {add\_paths, ["/tmp/ls/custom\_modules"]}
 ]}
].

and then copied the compiled beam to this directory. I then issued a curl
PUT to add the pre-commit to the bucket props:

curl -XPUT -H "Content-Type: application/json" -d
'{"props":{"precommit":[{"mod":"rr\_pre\_commit","fun":"set\_process\_datetime\_index"}]}}'
http://127.0.0.1:11098/buckets/LS\~News/props

and am able to confirm it worked when I do a GET on the bucket properties.
The bucket already had a single key stored in it and when I do another PUT
on that object (hoping to get the pre-commit to fire), I get the following
error:

{error,badarg,
 [{erlang,iolist\_to\_binary,
 [{hook\_crashed,
 {rr\_pre\_commit,set\_process\_datetime\_index,error,
 function\_clause}}],
 []},
 {wrq,append\_to\_response\_body,2,[{file,"src/wrq.erl"},{line,215}]},
 {riak\_kv\_wm\_object,handle\_common\_error,3,
 [{file,"src/riak\_kv\_wm\_object.erl"},{line,1178}]},
 {webmachine\_resource,resource\_call,3,
 [{file,"src/webmachine\_resource.erl"},{line,186}]},
 {webmachine\_resource,do,3,
 [{file,"src/webmachine\_resource.erl"},{line,142}]},
 {webmachine\_decision\_core,resource\_call,1,
 [{file,"src/webmachine\_decision\_core.erl"},{line,48}]},
 {webmachine\_decision\_core,accept\_helper,1,
 [{file,"src/webmachine\_decision\_core.erl"},{line,616}]},
 {webmachine\_decision\_core,decision,1,
 [{file,"src/webmachine\_decision\_core.erl"},{line,521}]}]}}


I am able to run the pre-commit function when I attach to the Riak
shell and add the paths manually (code:add\_patha) but not when it
triggers via a PUT. Also, in my pre-commit hook module/function I am
using the riak erlang client to access the object metadata. Is this
module compiled into Riak or do I also need to add a path for this?


The pre-commit module/function is below:


set\_process\_datetime\_index(Obj) -&gt;
 case is\_deleted(Obj) of
 true -&gt;
 Obj;
 \_ -&gt;
 MD = riakc\_obj:get\_update\_metadata(Obj),
 case riakc\_obj:get\_user\_metadata\_entry(MD,
&lt;&lt;"process\_messagedate"&gt;&gt;) of
 %% if user "process messagedate" metadata is not found
 notfound -&gt;
 %% add it
 MD2 =
riakc\_obj:set\_user\_metadata\_entry(MD,{&lt;&lt;"process\_messagedate"&gt;&gt;,format\_date\_index(calendar:local\_time())}),
 %% and modify the message\_date 2i index
 MD3 = riakc\_obj:set\_secondary\_index(MD2,{{binary\_index,
&lt;&lt;"messagedate"&gt;&gt;}, [format\_date\_index(calendar:local\_time())]}),
 riakc\_obj:update\_metadata(Obj,MD3);
 \_ -&gt;
 %% otherwise, don't do anything as we have already
stored the process time
 Obj
 end

 end.

is\_deleted(Obj)-&gt;
 case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riakc\_obj:get\_metadata(Obj)) of
 {ok,\_} -&gt;
 true;
 \_ -&gt;
 false
 end.


Any help or advice is appreciated.


Geoff
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

