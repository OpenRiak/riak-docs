---
title: "Re: [Basho Riak] Fail To Update Document Repeatly With Cluster of 5	Nodes"
description: ""
project: community
lastmod: 2017-02-06T11:12:29-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17924"
mailinglist_parent_id: "msg17923"
author_name: "John Daily"
project_section: "mailinglistitem"
sent_date: 2017-02-06T11:12:29-08:00
---


Originally I suspected the context which allows Riak to resolve conflicts was 
not present in your data, but I see it in your map structure. Thanks for 
supplying such a detailed description.

How fast is your turnaround time between an update and a fetch? Even if the 
cluster is healthy it’s not impossible to see a timeout between nodes, which 
could result in a stale retrieval. Have you verified whether the stale data 
persists?

A single node cluster gives an advantage that you’ll never see in a real 
cluster: a perfectly synchronized clock. It also reduces (but does not 
completely eliminate) the possibility of an internal timeout between processes.

-John

&gt; On Feb 6, 2017, at 1:02 PM, my hue  wrote:
&gt; 
&gt; Dear Riak Team,
&gt; 
&gt; I and my team used riak as database for my production with an cluster 
&gt; including 5 nodes. 
&gt; While production run, we meet an critical bug that is sometimes fail to 
&gt; update document. 
&gt; I and my colleagues performed debug and detected an issue with the scenario 
&gt; as follow: 
&gt; 
&gt; + fetch document 
&gt; + change value of document 
&gt; + update document
&gt; 
&gt; Repeat about 10 times and will meet fail. With the document is updated 
&gt; continually, 
&gt; sometimes will face update fail.
&gt; 
&gt; The first time, 5 nodes of cluster we used riak version 2.1.1. 
&gt; After meet above bug, we upgraded to use riak version 2.2.0 and this issue 
&gt; still occurs.
&gt; 
&gt; Via many time test, debug using Tcpdump at riak node :
&gt; 
&gt; tcpdump -A -ttt -i {interface} src host {host} and dst port {port} 
&gt; 
&gt; And together with the command: 
&gt; 
&gt; riak-admin status | grep "node\_puts\_map\| node\_puts\_map\_total\| 
&gt; node\_puts\_total\| vnode\_map\_update\_total\| vnode\_puts\_total\"
&gt; 
&gt; we got that the riak server already get the update request. 
&gt; However, do not know why riak backend fail to update document. 
&gt; At the fail time, from riak server log everything is ok. 
&gt; 
&gt; Then we removed cluster and use a single riak server, and see that above bug 
&gt; never happen.
&gt; 
&gt; For that reason, think that is only happen with cluster work. We took 
&gt; research on basho riak document and our riak configure 
&gt; seems that like suggestion from document. We totally blocked on this issue 
&gt; and hope that can get support from you 
&gt; so that can obtain a stable work from riak database for our production. 
&gt; Thank you so much. Hope that can get your reply soon.
&gt; 
&gt; 
&gt; \* The following is our riak node information : 
&gt; 
&gt; Riak version: 2.2.0
&gt; OS : CentOS Linux release 7.2.1511
&gt; Cpu : 4 core
&gt; Memory : 4G 
&gt; Riak configure : the attached file "riak.conf"
&gt; 
&gt; Note : 
&gt; 
&gt; - We mostly using default configure of riak configure except that we used 
&gt; storage backend is multi 
&gt; 
&gt; storage\_backend = multi
&gt; multi\_backend.bitcask\_mult.storage\_backend = bitcask
&gt; multi\_backend.bitcask\_mult.bitcask.data\_root = /var/lib/riak/bitcask\_mult
&gt; multi\_backend.default = bitcask\_mult
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; - Bucket type created with the following command:
&gt; 
&gt; riak-admin bucket-type create dev\_restor 
&gt; '{"props":{"backend":"bitcask\_mult","datatype":"map"}}'
&gt; riak-admin bucket-type activate dev\_restor
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; - Bucket Type Status :
&gt; 
&gt; &gt;&gt; riak-admin bucket-type status dev\_restor
&gt; 
&gt; dev\_restor is active
&gt; young\_vclock: 20
&gt; w: quorum
&gt; small\_vclock: 50
&gt; rw: quorum
&gt; r: quorum
&gt; pw: 0
&gt; precommit: []
&gt; pr: 0
&gt; postcommit: []
&gt; old\_vclock: 86400
&gt; notfound\_ok: true
&gt; n\_val: 3
&gt; linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
&gt; last\_write\_wins: false
&gt; dw: quorum
&gt; dvv\_enabled: true
&gt; chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
&gt; big\_vclock: 50
&gt; basic\_quorum: false
&gt; backend: &lt;&lt;"bitcask\_mult"&gt;&gt;
&gt; allow\_mult: true
&gt; datatype: map
&gt; active: true
&gt; claimant: 'riak-node1@64.137.190.244 '
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; - Bucket Property :
&gt; 
&gt; {"props":{"name":"menu","active":true,"allow\_mult":true,"backend":"bitcask\_mult","basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"claimant":"riak-node1@64.137.190.244
&gt; 
&gt; ","datatype":"map","dvv\_enabled":true,"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"menu","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":"quorum","rw":"quorum","search\_index":"menu\_idx","small\_vclock":50,"w":"quorum","young\_vclock":20}}
&gt; 
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; - Member status :
&gt; 
&gt; &gt;&gt; riak-admin member-status
&gt; 
&gt; ================================= Membership 
&gt; ==================================
&gt; Status Ring Pending Node
&gt; -------------------------------------------------------------------------------
&gt; valid 18.8% -- 'riak-node1@64.137.190.244 
&gt; '
&gt; valid 18.8% -- 'riak-node2@64.137.247.82 
&gt; '
&gt; valid 18.8% -- 'riak-node3@64.137.162.64 
&gt; '
&gt; valid 25.0% -- 'riak-node4@64.137.161.229 
&gt; '
&gt; valid 18.8% -- 'riak-node5@64.137.217.73 
&gt; '
&gt; -------------------------------------------------------------------------------
&gt; Valid:5 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt; 
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; - Ring 
&gt; 
&gt; &gt;&gt; riak-admin status | grep ring
&gt; 
&gt; ring\_creation\_size : 64
&gt; ring\_members : ['riak-node1@64.137.190.244 
&gt; ','riak-node2@64.137.247.82 
&gt; ', 'riak-node3@64.137.162.64 
&gt; ','riak-node4@64.137.161.229 
&gt; ', 'riak-node5@64.137.217.73 
&gt; ']
&gt; ring\_num\_partitions : 64
&gt; ring\_ownership : &lt;&lt;"[{'riak-node2@64.137.247.82 
&gt; ',12},\n {'riak-node5@64.137.217.73 
&gt; ',12},\n {'riak-node1@64.137.190.244 
&gt; ',12},\n {'riak-node3@64.137.162.64 
&gt; ',12},\n {'riak-node4@64.137.161.229 
&gt; ',16}]"&gt;&gt;
&gt; rings\_reconciled : 0
&gt; rings\_reconciled\_total : 31
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; \* The riak client :
&gt; 
&gt; + riak-erlang-client: https://github.com/basho/riak-erlang-client 
&gt;  
&gt; + release : 2.4.2 
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; \* Riak client API used: 
&gt; 
&gt; + Insert/Update: 
&gt; 
&gt; riakc\_pb\_socket:update\_type(Pid, {Bucket-Type, Bucket}, Key, 
&gt; riakc\_map:to\_op(Map), []).
&gt; 
&gt; + Fetch :
&gt; 
&gt; riakc\_pb\_socket:fetch\_type(Pid, {BucketType, Bucket}, Key, []). 
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; \* Step to perform an update :
&gt; 
&gt; - Fetch document 
&gt; - Update document 
&gt; 
&gt; -----------------------------------------------------------------------------------------------------------------------------
&gt; 
&gt; \* Data got from fetch\_type: 
&gt; 
&gt; {map, [{{&lt;&lt;"account\_id"&gt;&gt;,register}, 
&gt; &lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;},
&gt; {{&lt;&lt;"created\_by\_id"&gt;&gt;,register}, 
&gt; &lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}, 
&gt; {{&lt;&lt;"created\_time\_dt"&gt;&gt;,register},&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}, 
&gt; {{&lt;&lt;"currency"&gt;&gt;,register},&lt;&lt;"cad"&gt;&gt;}, 
&gt; {{&lt;&lt;"end\_time"&gt;&gt;,register},&lt;&lt;"dont\_use"&gt;&gt;}, 
&gt; {{&lt;&lt;"id"&gt;&gt;,register},&lt;&lt;"menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}, 
&gt; {{&lt;&lt;"maintain\_mode\_b"&gt;&gt;,register},&lt;&lt;"false"&gt;&gt;}, 
&gt; {{&lt;&lt;"menu\_category\_revision\_id"&gt;&gt;,register}, 
&gt; &lt;&lt;"0-634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}, 
&gt; {{&lt;&lt;"name"&gt;&gt;,register},&lt;&lt;"fullmenu"&gt;&gt;}, {{&lt;&lt;"order\_i"&gt;&gt;,register},&lt;&lt;"0"&gt;&gt;}, 
&gt; {{&lt;&lt;"rest\_location\_p"&gt;&gt;,register}, 
&gt; &lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}, 
&gt; {{&lt;&lt;"restaurant\_id"&gt;&gt;,register}, &lt;&lt;"rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}, 
&gt; {{&lt;&lt;"restaurant\_status\_id"&gt;&gt;,register},&lt;&lt;"inactive"&gt;&gt;}, 
&gt; {{&lt;&lt;"start\_time"&gt;&gt;,register},&lt;&lt;"dont\_use"&gt;&gt;}, 
&gt; {{&lt;&lt;"status\_id"&gt;&gt;,register},&lt;&lt;"hide"&gt;&gt;}, {{&lt;&lt;"updated\_by\_id"&gt;&gt;,register}, 
&gt; &lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}, 
&gt; {{&lt;&lt;"updated\_time\_dt"&gt;&gt;,register},&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}],
&gt; [],
&gt; [], 
&gt; &lt;&lt;131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,103,5,182,208,0,0,118,2,97,40,104,2,109,0,0,0,12,137,252,139,186,176,202,25,96,0,0,195,164,97,54,106&gt;&gt;}
&gt; 
&gt; 
&gt; \* Update with update\_type
&gt; 
&gt; Below is Map data before using riakc\_map:to\_op(Map) : 
&gt; 
&gt; {map, [] , 
&gt; 
&gt; [{{&lt;&lt;"account\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"created\_time\_dt"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-01-27T03:34:04Z"&gt;&gt;}},{{&lt;&lt;"currency"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"cad"&gt;&gt;}},{{&lt;&lt;"end\_time"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}},{{&lt;&lt;"id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"menufe89488afa948875cab6b0b18d579f21"&gt;&gt;}},{{&lt;&lt;"maintain\_mode\_b"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"false"&gt;&gt;}},{{&lt;&lt;"menu\_category\_revision\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"0-634736bc14e0bd3ed7e3fe0f1ee64443"&gt;&gt;}},{{&lt;&lt;"name"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"fullmenu"&gt;&gt;}},{{&lt;&lt;"order\_i"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"0"&gt;&gt;}},{{&lt;&lt;"rest\_location\_p"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"10.844117421366443,106.63982392275398"&gt;&gt;}},{{&lt;&lt;"restaurant\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"rest848e042b3a0488640981c8a6dc4a8281"&gt;&gt;}},{{&lt;&lt;"restaurant\_status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"inactive"&gt;&gt;}},{{&lt;&lt;"start\_time"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"dont\_use"&gt;&gt;}},{{&lt;&lt;"status\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"show"&gt;&gt;}},{{&lt;&lt;"updated\_by\_id"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"accounta25a424b8484181e8ba1bec25bf7c491"&gt;&gt;}},{{&lt;&lt;"updated\_time\_dt"&gt;&gt;,register},{register,&lt;&lt;&gt;&gt;,&lt;&lt;"2017-02-06T17:22:39Z"&gt;&gt;}}],
&gt; 
&gt; [] , 
&gt; &lt;&lt;131,108,0,0,0,3,104,2,109,0,0,0,12,39,21,84,209,219,42,57,233,0,0,156,252,97,34,104,2,109,0,0,0,12,132,107,248,226,103,5,182,208,0,0,118,2,97,39,104,2,109,0,0,0,12,137,252,139,186,176,202,25,96,0,0,195,164,97,53,106&gt;&gt;
&gt; }
&gt; 
&gt; 
&gt; 
&gt; 
&gt; - 
&gt; 
&gt; Best regards,
&gt; Hue Tran
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

