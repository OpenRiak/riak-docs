---
title: "riak_core questions"
description: ""
project: community
lastmod: 2011-07-28T05:46:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04107"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2011-07-28T05:46:00-07:00
---


Greetings. I'm building an application on top of riak\_core and I got
several questions about how all this stuff works.

1. When a node goes down, I need to force its exclusion from the
cluster, so the vnodes will be redistributed between the working
nodes.

As far as I understad, the easiest way to do it is something like that:


==================================================
...
riak\_core\_node\_watcher\_events:add\_handler(failover\_module, []),
...
==================================================
-module(failover\_module).
-behaviour(gen\_event).
....
handle\_event({service\_update, [Service]}, State) -&gt;
 NewNodes = riak\_core\_node\_watcher:nodes(Service),
 OldNodes = riak\_core\_ring:all\_members(riak\_core\_ring\_manager:get\_my\_ring()),
 [Node2Remove] = OldNodes -- NewNodes,
 riak\_core:remove\_from\_cluster(Node2Remove),
 {ok, State}
======================================================

Isn't there an easier way than that? Also, it's not obvious to me if I
should execute this code on each node, or when it's executed all the
nodes in the ring are automatically updated.

2. When a node goes up, there are 2 possible scenarios: if the node
did exist in the cluster before, we have to add it manually (which is
okay); and if the node did exist in the cluster before going down, it
gets the master node from the ring file and makes rpc:call which adds
this node back to the cluster.

3. Each vnode has an attached process that does some stuff. When the
cluster is re-arranged (and vnodes are re-distributed among Erlang
nodes), I still need those attached processes to finish all the stuff
they are doing, and only then start moving the corresponding vnode to
the new node. Is it enough just to wait for the corresponding message
{you\_can\_move\_vnode\_now} at riak\_more\_vnode\_module:terminate/2, or it
needs to be done in some other way?

4. Finally, I'm a bit concerned about what happens to the cluster if
the master node goes down. Probably, we cannot remove master node from
the cluster. Or riak\_core automatically elects the new master node in
such a case (unlikely, I haven't found any gen\_leader-like stuff).
What's the best way to handle such situations?

Thank you.


-- 
Best regards,
Dmitry Demeshchuk

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

