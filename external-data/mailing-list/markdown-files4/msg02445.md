---
title: "Re: Java HTTP Client running out of FD's"
description: ""
project: community
lastmod: 2011-02-24T12:37:19-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02445"
mailinglist_parent_id: "msg02444"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2011-02-24T12:37:19-08:00
---



On 24 Feb 2011, at 17:20, Abhishek Kona wrote:

&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; Each thread has a RiakClient.
&gt;&gt; RiakClient uses Apache HttpClient's MultiThreadedConnectionManager so
&gt;&gt; you could create a single RiakClient and share it among your threads
&gt;&gt; instead.
&gt; Could you provide me an example (sample code / test case ) for that?
&gt; In the ITestDataLoad.java file of the GitHub repo (http://goo.gl/Bu3gi), each 
&gt; thread seems to create a new RiakClient instead of sharing a single 
&gt; RiakClient, so am I missing something in following the same example.

Not really missing something, that \_is\_ how the test is coded, but it would be 
(marginally?) better to create the RiakClient once with the "right" number of 
threads. The HttpClient connection manager can pool the connections and reuse 
them, which you don't get if you bring a RiakClient into existence for a one 
request then lose it again. These tests are sort of artificial, but an 
application with (say) a service providing access to Riak could have a single 
RiakClient instance with the right number of threads and you can take advantage 
of connection persistence in HttpClient rather than creating and dropping and 
creating sockets.

Have a look at https://gist.github.com/842829 for an example of sharing a 
client across threads in ITestDataLoad

&gt;&gt; 
&gt;&gt;&gt;&gt; Is it possible to see the test code, maybe?
&gt;&gt;&gt; I will try to post some snippets by tomorrow.
&gt;&gt; Cool, thanks. http://gist.github.com would be handy.
&gt; https://gist.github.com/842472
&gt; Here is a sample code, if you need more detail let me know. (there are a few 
&gt; internal libraries in use).

Thanks for that. I can't really see how it is being run, can the task be reused 
or does it do one request then get binned? Using a client for single request is 
not the best test though. Create a client, share it across threads and use it 
for repeated requests. I'll try and knock together and example that shows this 
vs. creating a new client per call.

I'll try and reproduce your issue at this end.


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

