---
title: "Re: Upgrade to 1.1.2 problems"
description: ""
project: community
lastmod: 2012-04-25T16:40:02-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07328"
mailinglist_parent_id: "msg07324"
author_name: "Joseph Blomstedt"
project_section: "mailinglistitem"
sent_date: 2012-04-25T16:40:02-07:00
---


Phil,

Given the following lines,

&gt;         {reason,
&gt;          {{badmatch,{'EXIT',noproc}},
&gt;           [{riak\_core\_vnode\_proxy,call,2},

I'm inclined to think this is an issue with the new vnode routing
layer introduced in Riak 1.1. On your Riak 1.1.2 node, make sure your
app.config does not contain {legacy\_vnode\_routing, false} in the
riak\_core section. If it does, either delete the line or change it to
false. If this was the issue, you should set it back to false after
upgrading the rest of your cluster.

Also, if this turns out to be the issue, could you please let me know
how you performed the upgrade? Our official packages are supposed to
be designed so that they retain your old app.config file when
installed over an existing Riak installation (and thus, this line
would have been missing from the 1.0.3 config). It would be useful to
know if you used an official package and the app.config was
overwritten, or if you manually setup your app.config and simply
missed this option.

On the plus side, the next release of Riak should include built-in
capability negotiation that should remove the need for users to have
to manually deal with legacy, mapred, listkeys, etc settings during an
upgrade.

-Joe

On Wed, Apr 25, 2012 at 2:05 PM, Phil Sorber  wrote:
&gt; We have a 4 node riak 1.0.0 cluster running in production that we want
&gt; to upgrade to 1.1.2. We set up a test environment that closely mimic's
&gt; the production one. As close as we possibly can with ec2 hosts. First
&gt; attempt to jump from 1.0.0 -&gt; 1.1.2 failed. We took into account the
&gt; mapred\_system issue and the listkeys\_backpressure issue. We decided to
&gt; try 1.0.0 -&gt; 1.0.3 since that would involve the mapred\_system issue
&gt; only. That upgrade worked. We then tried to upgrade 1.0.3 -&gt; 1.1.2 and
&gt; had similar problems. Details below.
&gt;
&gt; --
&gt; # riak-admin transfers
&gt; Attempting to restart script through sudo -u riak
&gt; 'riak@50.16.31.226' waiting to handoff 14 partitions
&gt; --
&gt;
&gt; Sometimes this would show as many as 48 transfers. Always from the
&gt; node that we upgraded. It would eventually show no transfers left. The
&gt; upgrade from 1.0.0 -&gt; 1.0.3 didn't do this.
&gt;
&gt; We tested a link walking query that is similar to what we run in
&gt; production. On 2 of the 3 nodes still running 1.0.3 it worked fine. On
&gt; the 3rd node, this happened:
&gt;
&gt; Curl run on 1.0.3 node:
&gt;
&gt; --
&gt; curl -v http://localhost:8098/riak/email\_address/riakupgr...@gmail.com/\_,\_,1
&gt; \* About to connect() to localhost port 8098 (#0)
&gt; \*   Trying 127.0.0.1... connected
&gt; \* Connected to localhost (127.0.0.1) port 8098 (#0)
&gt;&gt; GET /riak/email\_address/riakupgr...@gmail.com/\_,\_,1 HTTP/1.1
&gt;&gt; User-Agent: curl/7.19.7 (x86\_64-pc-linux-gnu) libcurl/7.19.7 OpenSSL/0.9.8k 
&gt;&gt; zlib/1.2.3.3 libidn/1.15
&gt;&gt; Host: localhost:8098
&gt;&gt; Accept: \*/\*
&gt;&gt;
&gt; &lt; HTTP/1.1 500 Internal Server Error
&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt; &lt; Expires: Wed, 25 Apr 2012 20:55:30 GMT
&gt; &lt; Date: Wed, 25 Apr 2012 20:45:30 GMT
&gt; &lt; Content-Type: text/html
&gt; &lt; Content-Length: 2068
&gt; &lt;
&gt; 500 Internal Server
&gt; ErrorInternal Server Error
=====================

The server
&gt; encountered an error while processing this request:  

```
{error,
&gt;  {error,
&gt;  {badmatch,
&gt;   {eoi,[],
&gt;    [{{reduce,0},
&gt;      {trace,
&gt;       [error],
&gt;       {error,
&gt;        [{module,riak_kv_w_reduce},
&gt;         {partition,1438665674247607560106752257205091097473808596992},
&gt;         {details,
&gt;          [{fitting,
&gt;            {fitting,&lt;0.848.0&gt;,#Ref&lt;0.0.0.5472&gt;,
&gt;             #Fun,1}},
&gt;           {name,{reduce,0}},
&gt;           {module,riak\_kv\_w\_reduce},
&gt;           {arg,{rct,#Fun,none}},
&gt;           {output,
&gt;            {fitting,&lt;0.847.0&gt;,#Ref&lt;0.0.0.5472&gt;,
&gt;             #Fun,
&gt;             #Fun}},
&gt;           {options,
&gt;            [{sink,{fitting,&lt;0.119.0&gt;,#Ref&lt;0.0.0.5472&gt;,sink,undefined}},
&gt;             {log,sink},
&gt;             {trace,
&gt;              {set,1,16,16,8,80,48,
&gt;               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;               {{[],[],[error],[],[],[],[],[],[],[],[],[],[],[],[],[]}}}}]},
&gt;           {q\_limit,64}]},
&gt;         {reason,
&gt;          {{badmatch,{'EXIT',noproc}},
&gt;           [{riak\_core\_vnode\_proxy,call,2},
&gt;            {riak\_pipe\_vnode,queue\_work\_send,4},
&gt;            {riak\_pipe\_vnode,queue\_work\_erracc,6},
&gt;            {riak\_kv\_w\_reduce,'-done/1-lc$^0/1-0-',3},
&gt;            {riak\_kv\_w\_reduce,done,1},
&gt;            {riak\_pipe\_vnode\_worker,wait\_for\_input,2},
&gt;            {gen\_fsm,handle\_msg,7},
&gt;            {proc\_lib,init\_p\_do\_apply,3}]}},
&gt;         {state,{working,done}}]}}}]}},
&gt;  [{riak\_kv\_mrc\_pipe,collect\_outputs,3},
&gt;   {riak\_kv\_wm\_link\_walker,execute\_segment,3},
&gt;   {riak\_kv\_wm\_link\_walker,execute\_query,3},
&gt;   {riak\_kv\_wm\_link\_walker,to\_multipart\_mixed,2},
&gt;   {webmachine\_resource,resource\_call,3},
&gt;   {webmachine\_resource,do,3},
&gt;   {webmachine\_decision\_core,resource\_call,1},
&gt;   
&gt; {webmachine\_decision\_core,decision,1}]}}
```


---

mochiweb+webmachine
&gt; web server \* Closing connection #0
&gt; --
&gt;
&gt; After that, this appeared in the error.log on that node:
&gt;
&gt; error.log on 1.0.3 node:
&gt;
&gt; --
&gt; 2012-04-25 20:45:30.373 [error] &lt;0.119.0&gt; webmachine error:
&gt; path="/riak/email\_address/riakupgr...@gmail.com/\_,\_,1"
&gt; {error,{error,{badmatch,{eoi,[],[{{reduce,0},{trace,[error],{error,[{module,riak\_kv\_w\_reduce},{partition,1438665674247607560106752257205091097473808596992},{details,[{fitting,{fitting,&lt;0.848.0&gt;,#Ref&lt;0.0.0.5472&gt;,#Fun,1}},{name,{reduce,0}},{module,riak\_kv\_w\_reduce},{arg,{rct,#Fun,none}},{output,{fitting,&lt;0.847.0&gt;,#Ref&lt;0.0.0.5472&gt;,#Fun,#Fun}},{options,[{sink,{fitting,&lt;0.119.0&gt;,#Ref&lt;0.0.0.5472&gt;,sink,undefined}},{log,sink},{trace,{set,1,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[error],[],[],[],[],[],[],[],[],[],[],[],[],[]}}}}]},{q\_limit,64}]},{reason,{{badmatch,{'EXIT',noproc}},[{riak\_core\_vnode\_proxy,call,2},{riak\_pipe\_vnode,queue\_work\_send,4},{riak\_pipe\_vnode,queue\_work\_erracc,6},{riak\_kv\_w\_reduce,'-done/1-lc$^0/1-0-',3},{riak\_kv\_w\_reduce,done,1},{riak\_pipe\_vnode\_worker,wait\_for\_input,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}},{state,{working,done}}]}}}]}},[{riak\_kv\_mrc\_pipe,collect\_outputs,3},{riak\_kv\_wm\_link\_walker,execute\_segment,3},{riak\_kv\_wm\_link\_walker,execute\_query,3},{riak\_kv\_wm\_link\_walker,to\_multipart\_mixed,2},{webmachine\_resource,resource\_call,3},{webmachine\_resource,do,3},{webmachine\_decision\_core,resource\_call,1},{webmachine\_decision\_core,decision,1}]}}
&gt; --
&gt;
&gt; And this was in the error.log on the 1.1.2 node:
&gt;
&gt; error.log on 1.1.2 node:
&gt;
&gt; --
&gt; 2012-04-25 20:45:30.234 [error] &lt;0.1710.0&gt; gen\_fsm &lt;0.1710.0&gt; in state
&gt; wait\_for\_input terminated with reason: no match of right hand value
&gt; {'EXIT',noproc} in riak\_core\_vnode\_proxy:call/2
&gt; 2012-04-25 20:45:30.243 [error] &lt;0.1710.0&gt; CRASH REPORT Process
&gt; &lt;0.1710.0&gt; with 0 neighbours crashed with reason: no match of right
&gt; hand value {'EXIT',noproc} in riak\_core\_vnode\_proxy:call/2
&gt; 2012-04-25 20:45:30.245 [error] &lt;0.331.0&gt; Supervisor
&gt; riak\_pipe\_vnode\_worker\_sup had child undefined started with
&gt; {riak\_pipe\_vnode\_worker,start\_link,undefined} at &lt;0.1710.0&gt; exit with
&gt; reason no match of right hand value {'EXIT',noproc} in
&gt; riak\_core\_vnode\_proxy:call/2 in context child\_terminated
&gt; --
&gt;
&gt; On the 1.1.2 node, running the same curl, it returned a 404 after a
&gt; long timeout:
&gt;
&gt; Curl run on the 1.1.2 node:
&gt;
&gt; --
&gt; curl -v http://localhost:8098/riak/email\_address/riakupgr...@gmail.com/\_,\_,1
&gt; \* About to connect() to localhost port 8098 (#0)
&gt; \*   Trying 127.0.0.1... connected
&gt; \* Connected to localhost (127.0.0.1) port 8098 (#0)
&gt;&gt; GET /riak/email\_address/riakupgr...@gmail.com/\_,\_,1 HTTP/1.1
&gt;&gt; User-Agent: curl/7.19.7 (x86\_64-pc-linux-gnu) libcurl/7.19.7 OpenSSL/0.9.8k 
&gt;&gt; zlib/1.2.3.3 libidn/1.15
&gt;&gt; Host: localhost:8098
&gt;&gt; Accept: \*/\*
&gt;&gt;
&gt; &lt; HTTP/1.1 404 Object Not Found
&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt; &lt; Date: Wed, 25 Apr 2012 20:49:40 GMT
&gt; &lt; Content-Type: text/html
&gt; &lt; Content-Length: 193
&gt; &lt;
&gt; \* Connection #0 to host localhost left intact
&gt; \* Closing connection #0
&gt; 404 Not FoundNot
&gt; Found
===========

The requested document was not found on this
&gt; server.

---

mochiweb+webmachine web
&gt; server


&gt; --
&gt;
&gt; There was nothing more in any error logs after this. Also pulling up
&gt; direct keys fails on this node. Riak is installed from the debian
&gt; packages. I can send you whatever other info is neccesary. We tried
&gt; many different combinations, but I think this one is the most correct
&gt; and produced the most useful error messages. Any help is appreciated.
&gt;
&gt; Thanks.
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



-- 
Joseph Blomstedt 
Software Engineer
Basho Technologies, Inc.
http://www.basho.com/

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



