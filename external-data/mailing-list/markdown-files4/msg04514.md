---
title: "Re: innostore performance tuning"
description: ""
project: community
lastmod: 2011-08-30T10:09:33-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04514"
mailinglist_parent_id: "msg04513"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2011-08-30T10:09:33-07:00
---

I never learned to 
read!

For performance metrics, you could see if there are any dtrace points for 
InnoDB. I wouldn't be able to tell you how to write them, but you'd want to 
look for things like page splits writes/second, file growth operations. That'll 
tell you what kind of storage operations are causing your performance slow 
down. There's an Oracle blog that looks like it contains some basics on writing 
this sort of thing: 
http://blogs.oracle.com/realneel/entry/inniostat\_innodb\_io\_statistics

The other obvious options to switch up are adding noatime to skip the file 
access time writes and switching innostore to use dynamic format tables to 
avoid the large write issues. I think InnoDB uses 16K pages by default, so 8K 
objects are going to leave a lot of empty space in the data file leading to 
increased I/O. The write performance on previously seen objects is probably 
coincidence because InnoDB doesn't have to grow the data files and isn't 
performing page splits.

With very sparse page population (large values), you're going to have to update 
a lot of data pages when you insert a single row since every leaf level page 
contains pointers to the next and previous page. Worst case scenario - writing 
a single record could lead to four updates - data page, intermediate page, and 
next and previous page. So, 8k of data could result in 32k of write. With a 16k 
data page, a 9k write becomes a 64k write because of updates to other pages. 

Also, if you can put the log files on separate disks than your data files (at 
least for this load process) then you'll get much better throughput (less I/O 
contention, etc blah blah blah DBA blah blah).
---
Jeremiah Peschka - Founder, Brent Ozar PLF, LLC
Microsoft SQL Server MVP

On Aug 30, 2011, at 9:55 AM, Jonathan Langevin wrote:

&gt; He's already running Raid 10
&gt; 
&gt; 
&gt; Jonathan Langevin
&gt; Systems Administrator
&gt; Loom Inc.
&gt; Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com - 
&gt; www.loomlearning.com - Skype: intel352
&gt; 
&gt; 
&gt; 
&gt; On Tue, Aug 30, 2011 at 12:51 PM, Jeremiah Peschka 
&gt;  wrote:
&gt; InnoStore is going to insert the data in key order. When you attempt to 
&gt; insert a record that would fit in between two keys (inserting "apple" between 
&gt; "aardvark" and "Byzantium") you're probably going to get a page split, just 
&gt; like in an RDBMS. The data needs to be re-shuffled in order to write it in 
&gt; key order. Despite using MVCC, InnoDB is an index ordered table. Data is 
&gt; written in key order. LevelDB shouldn't have the ordered write issues that 
&gt; InnoStore has.
&gt; 
&gt; The procedure to bulk load your data is going to be the same as bulk loading 
&gt; data for any large Data Warehouse - ordered inserts will help you.
&gt; 
&gt; If there's a way to load your data in smaller ordered chunks, that's going to 
&gt; help you out too.
&gt; 
&gt; Some other options would be to increase the buffer\_pool\_size for InnoStore. 
&gt; InnoDB will use RAM as a disk cache to avoid disk hits. This would be a "Good 
&gt; Thing". Since you're writing in 8k chunks, roughly, you could also increase 
&gt; the page size. This would be something to experiment with, but increasing 
&gt; database page size could improve write performance. Odds are if your average 
&gt; record size is 8kb, then you're writing multiple pages per record (key + 
&gt; value), which is causing even more I/O (two or more page reads per object). 
&gt; Some filesystem tuning could be in order. SQL Server, for instance, performs 
&gt; sequential reads in 64k chunks. The best practice for disk performance there 
&gt; is to format NTFS to use 64k blocks. The throughput between the defaults and 
&gt; 64k reads is amazing.
&gt; 
&gt; Also, you may want to look at your storage configuration in the back end. If 
&gt; you have that much data, are you using a SAN or DAS? Both of these can help 
&gt; get additional write performance, especially if you adjust the storage device 
&gt; to cache writes in a battery backed cache. What kind of drive configuration 
&gt; do you have? You can get tremendous write performance improvements by moving 
&gt; to RAID10.
&gt; 
&gt; ---
&gt; Jeremiah Peschka - Founder, Brent Ozar PLF, LLC
&gt; Microsoft SQL Server MVP
&gt; 
&gt; On Aug 30, 2011, at 9:34 AM, David Koblas wrote:
&gt; 
&gt; &gt; Yes - but the thought of sorting 800M records which are all about 8k in 
&gt; &gt; size is a little daunting... Something like a 6TB sort... Plus it doesn't 
&gt; &gt; answer the ongoing insert problem, which is 20 keys/sec isn't functional.
&gt; &gt;
&gt; &gt; --david
&gt; &gt;
&gt; &gt; On 8/30/11 9:27 AM, Kresten Krab Thorup wrote:
&gt; &gt;&gt; If you can insert the objects in ascending key order, then innostore will 
&gt; &gt;&gt; be much faster than a random insert.
&gt; &gt;&gt;
&gt; &gt;&gt; Mobile: + 45 2343 4626 | Skype: krestenkrabthorup | Twitter: @drkrab
&gt; &gt;&gt; Trifork A/S | Margrethepladsen 4 | DK- 8000 Aarhus C | Phone : +45 
&gt; &gt;&gt; 8732 8787 | www.trifork.com
&gt; &gt;&gt;
&gt; &gt;&gt; Trifork organizes the world class conference on software development: GOTO 
&gt; &gt;&gt; Aarhus - check it out!
&gt; &gt;&gt;
&gt; &gt;&gt; [cid:part1.09040606.08080401@trifork.com]
&gt; &gt;&gt;
&gt; &gt;&gt; On Aug 30, 2011, at 6:14 PM, David Koblas wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; I'm currently working on importing a very large dataset (800M) into Riak 
&gt; &gt;&gt; and running into some serious performance problems. Hopefully this is 
&gt; &gt;&gt; just configuration issues and nothing deeper...
&gt; &gt;&gt;
&gt; &gt;&gt; Hardware -
&gt; &gt;&gt; \* 8 proc box
&gt; &gt;&gt; \* 32 Gb ram
&gt; &gt;&gt; \* 5TB disk - RAID10
&gt; &gt;&gt;
&gt; &gt;&gt; Have a cluster of 4 for these boxes all running riak - riak configuration 
&gt; &gt;&gt; options that are different from stock:
&gt; &gt;&gt;
&gt; &gt;&gt; \* Listening on all IP address "0.0.0.0"
&gt; &gt;&gt; \* {storage\_backend, riak\_kv\_innostore\_backend},
&gt; &gt;&gt; \* innostore section - {buffer\_pool\_size, 17179869184}, %% 16GB
&gt; &gt;&gt; \* innostore section - {flush\_method, "O\_DIRECT"}
&gt; &gt;&gt;
&gt; &gt;&gt; What I see is that the performance of my import script runs at about 
&gt; &gt;&gt; 200...300 keys per/second for keys that it's seen recently (e.g. re-runs) 
&gt; &gt;&gt; then drops to 20ish keys per/sec for new keys.
&gt; &gt;&gt; STATS: 1000 keys handled in 3 seconds 250.75 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 3 seconds 258.20 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 4 seconds 240.11 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 5 seconds 177.63 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 4 seconds 246.26 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 5 seconds 184.79 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 5 seconds 195.95 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 47 seconds 21.02 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 44 seconds 22.63 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 42 seconds 23.64 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 43 seconds 22.88 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 45 seconds 22.12 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 43 seconds 22.83 keys/sec
&gt; &gt;&gt; STATS: 1000 keys handled in 43 seconds 23.11 keys/sec
&gt; &gt;&gt; Of course with 800M records to import a performance of 20 keys/sec is not 
&gt; &gt;&gt; useful, plus as time goes on having an insert rate at that level is going 
&gt; &gt;&gt; to be problematic.
&gt; &gt;&gt;
&gt; &gt;&gt; Questions -
&gt; &gt;&gt; Is there additional things to change for imports and datasets on this 
&gt; &gt;&gt; scale?
&gt; &gt;&gt; Is there a way to get additional debugging to see where the performance 
&gt; &gt;&gt; issues are?
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks,
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

