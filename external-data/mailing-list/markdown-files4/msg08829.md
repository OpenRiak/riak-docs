---
title: "Re: riak exiting when number partitions > 128"
description: ""
project: community
lastmod: 2012-10-08T19:02:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08829"
mailinglist_parent_id: "msg08828"
author_name: "David Lowell"
project_section: "mailinglistitem"
sent_date: 2012-10-08T19:02:22-07:00
---


Thanks guys. I had raised the max open files limit at the system level for the 
'riak' user to 100k, and confirmed that had taken affect with "sudo -u riak 
bash -c 'ulimit -a'". However, it appears that you are correct that this system 
setting is not affecting the actual startup of riak when I run riak's 
/etc/init.d/riak init script.

Digging further, reveals that 'su' seems not to be helping. Witness:

$ sudo -u riak bash -c 'ulimit -n'
100000
$ sudo su - riak -c 'ulimit -n'
1024

I've seen weirdness like this with su in the past, and have been phasing it out 
of my vocabulary.

So, to confirm this was the issue I tweaked riak's init script, replacing

 su - riak -c "$DAEMON $DAEMON\_ARGS" || return 2
 
with

 sudo -u riak $DAEMON $DAEMON\_ARGS || return 2 

And now riak starts up properly with 512 partitions.

So now the question becomes: is there some way to get "su" to behave more like 
"sudo" in this case? Or do we just need to use a custom init script until the 
stock init script evolves past su?

Dave

--
Dave Lowell
d...@connectv.com

On Oct 8, 2012, at 6:21 PM, Jeremiah Peschka wrote:

&gt; Like Alex, I state ulimit -n directly in my start Riak start up scripts. For 
&gt; my local dev instance it looks like this:
&gt; 
&gt; ### Generic Riak dev version setup
&gt; function riak\_dev\_start() {
&gt; local CURRENT=`pwd`;
&gt; 
&gt; ulimit -n 1024;
&gt; 
&gt; cd ~/Projects/riak/dev
&gt; echo "Starting riak node 1 on 127.0.0.1"
&gt; dev1/bin/riak start
&gt; echo "Starting riak node 2 on 127.0.0.1"
&gt; dev2/bin/riak start
&gt; echo "Starting riak node 3 on 127.0.0.1"
&gt; dev3/bin/riak start
&gt; echo "Starting riak node 4 on 127.0.0.1"
&gt; dev4/bin/riak start
&gt; 
&gt; cd $CURRENT
&gt; }
&gt; 
&gt; I'd definitely try bumping ulimit in your riak startup scripts themselves and 
&gt; see if that eliminates the issues that you're running into.
&gt; ---
&gt; Jeremiah Peschka
&gt; Managing Director, Brent Ozar PLF, LLC
&gt; 
&gt; 
&gt; On Mon, Oct 8, 2012 at 6:11 PM, Alexander Sicular  wrote:
&gt; I don't think you're setting it correctly. I usually set it in the terminal 
&gt; before calling riak start. Or set it system wide, different ways to do it 
&gt; depending on your os. 
&gt; 
&gt; 
&gt; @siculars
&gt; http://siculars.posterous.com
&gt; 
&gt; Sent from my iRotaryPhone
&gt; 
&gt; On Oct 8, 2012, at 21:00, David Lowell  wrote:
&gt; 
&gt;&gt; I'm starting to want to move past the default Riak configs, for example, by 
&gt;&gt; running with a larger number of partitions than the default 64. However, 
&gt;&gt; today when bumping up the "ring\_creation\_size" config param to 256 or higher 
&gt;&gt; Riak started failing soon after startup with messages about "Too many open 
&gt;&gt; files". For the record, I'm using the ELevelDB back-end.
&gt;&gt; 
&gt;&gt; I've seen the documentation about the need for ring\_creation\_size \* 
&gt;&gt; max\_open\_files file descriptors with levelDB. I've upped the system open 
&gt;&gt; files limit for the riak user to 100k, so I don't think I'm hitting that 
&gt;&gt; system limit. So it feels like I'm hitting a limit configured within the 
&gt;&gt; application somewhere.
&gt;&gt; 
&gt;&gt; It doesn't feel like changing levelDB's 'max\_open\_files' configuration is 
&gt;&gt; the issue here, as I'm using the default/minimum value of 20 for that 
&gt;&gt; parameter. Any other setting would increase open files.
&gt;&gt; 
&gt;&gt; So I could use a pointer here from folks who have been here. I suspect there 
&gt;&gt; is something very simple required here. 
&gt;&gt; 
&gt;&gt; Thanks folks!
&gt;&gt; 
&gt;&gt; Dave
&gt;&gt; 
&gt;&gt; ps. For the record, my data set is empty on this host, and for completeness 
&gt;&gt; I'm blowing away the ring state when I fiddle with the ring\_creation\_size 
&gt;&gt; parameter.
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Dave Lowell
&gt;&gt; d...@connectv.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 2012-10-09 00:50:17.430 [info] &lt;0.7.0&gt; Application riak\_kv started on node 
&gt;&gt; 'riak@10.0.3.81'
&gt;&gt; 2012-10-09 00:50:17.456 [info] &lt;0.7.0&gt; Application merge\_index started on 
&gt;&gt; node 'riak@10.0.3.81'
&gt;&gt; 2012-10-09 00:50:17.459 [info] &lt;0.1316.0&gt;@riak\_core:wait\_for\_service:445 
&gt;&gt; Waiting for service riak\_kv to start (0 seconds)
&gt;&gt; 2012-10-09 00:50:17.525 [info] &lt;0.1303.0&gt;@riak\_core:wait\_for\_application:419 
&gt;&gt; Wait complete for application riak\_kv (0 seconds)
&gt;&gt; 2012-10-09 00:50:37.366 [error] &lt;0.5081.0&gt;@riak\_kv\_vnode:init:265 Failed to 
&gt;&gt; start riak\_kv\_eleveldb\_backend Reason: {db\_open,"IO error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"}
&gt;&gt; 2012-10-09 00:50:37.423 [notice] &lt;0.5081.0&gt;@riak:stop:46 "backend module 
&gt;&gt; failed to start."
&gt;&gt; 2012-10-09 00:50:37.424 [error] &lt;0.5081.0&gt; CRASH REPORT Process &lt;0.5081.0&gt; 
&gt;&gt; with 0 neighbours exited with reason: {db\_open,"IO error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"} in gen\_fsm:init\_it/6 line 371
&gt;&gt; 2012-10-09 00:50:37.429 [info] &lt;0.494.0&gt;@riak\_kv\_js\_vm:terminate:240 
&gt;&gt; Spidermonkey VM (pool: riak\_kv\_js\_hook) host stopping (&lt;0.494.0&gt;)
&gt;&gt; 2012-10-09 00:50:37.673 [error] &lt;0.138.0&gt; Supervisor riak\_core\_vnode\_sup had 
&gt;&gt; child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
&gt;&gt; &lt;0.5081.0&gt; exit with reason {db\_open,"IO error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"} in context child\_terminated
&gt;&gt; 2012-10-09 00:50:37.736 [error] &lt;0.153.0&gt; gen\_server riak\_core\_vnode\_manager 
&gt;&gt; terminated with reason: no match of right hand value {error,{db\_open,"IO 
&gt;&gt; error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"}} in riak\_core\_vnode\_manager:get\_vnode/3 line 489
&gt;&gt; 2012-10-09 00:50:37.799 [error] &lt;0.153.0&gt; CRASH REPORT Process 
&gt;&gt; riak\_core\_vnode\_manager with 0 neighbours exited with reason: no match of 
&gt;&gt; right hand value {error,{db\_open,"IO error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"}} in riak\_core\_vnode\_manager:get\_vnode/3 line 489 in 
&gt;&gt; gen\_server:terminate/6 line 747
&gt;&gt; 2012-10-09 00:50:37.844 [error] &lt;0.136.0&gt; Supervisor riak\_core\_sup had child 
&gt;&gt; riak\_core\_vnode\_manager started with riak\_core\_vnode\_manager:start\_link() at 
&gt;&gt; &lt;0.153.0&gt; exit with reason no match of right hand value {error,{db\_open,"IO 
&gt;&gt; error: 
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files"}} in riak\_core\_vnode\_manager:get\_vnode/3 line 489 in 
&gt;&gt; context child\_terminated
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

