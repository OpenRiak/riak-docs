---
title: "Re: riak-0.14.2 memory crash"
description: ""
project: community
lastmod: 2011-07-09T23:01:54-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03978"
mailinglist_parent_id: "msg03977"
author_name: "Sylvain Niles"
project_section: "mailinglistitem"
sent_date: 2011-07-09T23:01:54-07:00
---


Unfortunately not the case for us. Every document is under 2k in size
and are almost all identical with just some differences in text.
Unless you mean the documents grew to that size for some conflict
scenario?

-Sylvain


On Sat, Jul 9, 2011 at 10:55 PM, Jeff Pollard  wrote:
&gt; We had a similar problem recently where we had several large documents
&gt; (500MB - 1.1gigs) that was causing Erlang to crash with eheap\_alloc errors.
&gt;  Likely, the documents we so large due to high amounts of conflict.
&gt;  Deleting the documents fixed the problem.
&gt;
&gt; On Fri, Jul 8, 2011 at 5:29 PM, Sylvain Niles 
&gt; wrote:
&gt;&gt;
&gt;&gt; Double checked and yes that's sorted by Stack+heap. There's two ets
&gt;&gt; tables that are 8 and 9mb respectively and that's all I can find for
&gt;&gt; memory usage. Anywhere else I can look for the culprit if it's not a
&gt;&gt; process or ets table?
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Fri, Jul 8, 2011 at 5:20 PM, Dan Reverri  wrote:
&gt;&gt; &gt; The Stack+heap for that process is only ~0.17 GB which isn't that much.
&gt;&gt; &gt; Are
&gt;&gt; &gt; you sorting the process list by Reductions or Stack+heap?
&gt;&gt; &gt; Regarding the messages in queue, I think you should be able to explore
&gt;&gt; &gt; each
&gt;&gt; &gt; Pid and look at it's process dictionary. The process dictionary will
&gt;&gt; &gt; have a
&gt;&gt; &gt; messages property.
&gt;&gt; &gt; Thanks,
&gt;&gt; &gt; Dan
&gt;&gt; &gt; Daniel Reverri
&gt;&gt; &gt; Developer Advocate
&gt;&gt; &gt; Basho Technologies, Inc.
&gt;&gt; &gt; d...@basho.com
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; On Fri, Jul 8, 2011 at 5:03 PM, Sylvain Niles 
&gt;&gt; &gt; wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Thanks Dan, very useful tool. Here's the big offender:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Pid             Name/Spawned as State   Reductions       Stack+heap
&gt;&gt; &gt;&gt; MsgQ Length
&gt;&gt; &gt;&gt; &lt;0.163.0&gt;       riak\_kv\_map\_master      Garbing (limited info)
&gt;&gt; &gt;&gt;  23815122240     182452560       3
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; So it looks like there was a huge amount of data in the process queue
&gt;&gt; &gt;&gt; for the riak\_kv\_map\_master. The pid info for that process shows there
&gt;&gt; &gt;&gt; were only 3 messages in its queue. Any tricks for figuring out what
&gt;&gt; &gt;&gt; those messages looked like?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; -Sylvain
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; On Fri, Jul 8, 2011 at 4:42 PM, Daniel Reverri  wrote:
&gt;&gt; &gt;&gt; &gt; Can you check if an erl\_crash.dump file was created? The crash dump
&gt;&gt; &gt;&gt; &gt; should give some indication of which processes were taking up memory.
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; The crashdump\_viewer built into Erlang is very useful for reviewing
&gt;&gt; &gt;&gt; &gt; crash dumps.
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; Thanks
&gt;&gt; &gt;&gt; &gt; Dan
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; Sent from my iPhone
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; On Jul 8, 2011, at 4:18 PM, Sylvain Niles 
&gt;&gt; &gt;&gt; &gt; wrote:
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt;&gt; Our system had been humming along fine for a week and crashed today
&gt;&gt; &gt;&gt; &gt;&gt; with almost no load. This is the only thing in the erlang.log:
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; =INFO REPORT==== 8-Jul-2011::16:46:14 ===
&gt;&gt; &gt;&gt; &gt;&gt; [{alarm\_handler,{clear,system\_memory\_high\_watermark}}]
&gt;&gt; &gt;&gt; &gt;&gt; =INFO REPORT==== 8-Jul-2011::16:50:14 ===
&gt;&gt; &gt;&gt; &gt;&gt; [{alarm\_handler,{set,{system\_memory\_high\_watermark,[]}}}]
&gt;&gt; &gt;&gt; &gt;&gt; =INFO REPORT==== 8-Jul-2011::16:51:14 ===
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; [{alarm\_handler,{clear,system\_memory\_high\_watermark}}]/usr/local/src/riak-0.14.2/rel/riak/lib/os\_mon-2.2.5/priv/bin/memsup:
&gt;&gt; &gt;&gt; &gt;&gt; Erlang has closed.
&gt;&gt; &gt;&gt; &gt;&gt; Erlang has closed
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Crash dump was written to: erl\_crash.dump
&gt;&gt; &gt;&gt; &gt;&gt; eheap\_alloc: Cannot allocate 1824525600 bytes of memory (of type
&gt;&gt; &gt;&gt; &gt;&gt; "heap").
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Looking in the sasl-error log I see that an erlang function I wrote
&gt;&gt; &gt;&gt; &gt;&gt; was crashing in some cases:
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; \*\* Reason for termination = \*\* {error,       {phase\_error,
&gt;&gt; &gt;&gt; &gt;&gt; {error,               {error,undef,
&gt;&gt; &gt;&gt; &gt;&gt; [{get\_erl,past\_events,
&gt;&gt; &gt;&gt; &gt;&gt;  [{r\_object,&lt;&lt;"events"&gt;&gt;,
&gt;&gt; &gt;&gt; &gt;&gt;                            &lt;&lt;"LRs2PibmMZknPm44IMzoZflCHUP"&gt;&gt;,
&gt;&gt; &gt;&gt; &gt;&gt;                             [{r\_content,
&gt;&gt; &gt;&gt; &gt;&gt; ...ETC
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; So I definitely need to fix my code, but I'm wondering if this is
&gt;&gt; &gt;&gt; &gt;&gt; expected behavior that this would cause a memory leak that
&gt;&gt; &gt;&gt; &gt;&gt; eventually
&gt;&gt; &gt;&gt; &gt;&gt; brings down riak? I thought if the process running my module crashed
&gt;&gt; &gt;&gt; &gt;&gt; everything would just be garbage collected and that'd be the end of
&gt;&gt; &gt;&gt; &gt;&gt; it. Any advice on the right way to approach this would be great,
&gt;&gt; &gt;&gt; &gt;&gt; thanks!
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; -Sylvain
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt;&gt; &gt;&gt; riak-users mailing list
&gt;&gt; &gt;&gt; &gt;&gt; riak-users@lists.basho.com
&gt;&gt; &gt;&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

