---
title: "Re: about hash calculation in reference page at docs.basho.com"
description: ""
project: community
lastmod: 2013-01-29T13:26:48-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09912"
mailinglist_parent_id: "msg09910"
author_name: "Charlie Voiselle"
project_section: "mailinglistitem"
sent_date: 2013-01-29T13:26:48-08:00
---


Donald:

Since the list of partitions can easily be segmented using a filter on 
partition values
that are greater than the hashed value, it makes for a simple determination of 
the ordered
preflist.

For Example: Hash = 1045375627425331784151332358177649483819648417632

Parition | P &gt; H | List |
----------------------------------------------------+-------+-------+ 
0 | False | B |
182687704666362864775460604089535377456991567872 | False | B |
365375409332725729550921208179070754913983135744 | False | B |
548063113999088594326381812268606132370974703616 | False | B |
730750818665451459101842416358141509827966271488 | False | B |
913438523331814323877303020447676887284957839360 | False | B |
1096126227998177188652763624537212264741949407232 | True | A |
1278813932664540053428224228626747642198940975104 | True | A |
----------------------------------------------------+-------+-------+

Then so long as order is maintained, your sorted preflist is simply A ++ B.

It would be a (if only slightly) more complex algorithm, requiring 
determination by
lookahead if you were in the correct partition, in order to have the partitions 
names be
starting values.

To answer your second question, the partitions are named by dividing the 
integer keyspace
by the num partitions to create an incrementor[1]. This incrementor is used as 
the
stepping factor in a sequence from 0 to RINGTOP value -- 
`trunc(math:pow(2,160)-1)`.

You can call these functions yourself in the `riak attach` as follows:

(dev1@127.0.0.1)1&gt; Inc = chash:ring\_increment(8).
182687704666362864775460604089535377456991567872

(dev1@127.0.0.1)2&gt; [{IndexAsInt} || IndexAsInt &lt;-lists:seq(0,( trunc( 
math:pow(2,160) -1)
-1),Inc)]. 
[{0}, 
{182687704666362864775460604089535377456991567872},
{365375409332725729550921208179070754913983135744},
{548063113999088594326381812268606132370974703616},
{730750818665451459101842416358141509827966271488},
{913438523331814323877303020447676887284957839360},
{1096126227998177188652763624537212264741949407232},
{1278813932664540053428224228626747642198940975104}]}


Hope this helps! 
Charlie Voiselle

--- 
[0] https://github.com/basho/riak\_core/blob/master/src/chash.erl#L88 
[1] https://github.com/basho/riak\_core/blob/master/src/chash.erl#L162





On Jan 29, 2013, at 9:47 AM, Donald Yan  wrote:

&gt; Hi Charlie, 
&gt; 
&gt; That really helps to clear the confusion. Thanks again!
&gt; 
&gt; Then it comes to the next question :-) Just curious to know: is there a 
&gt; special reason why using the end value as the partition's name? Normally, 
&gt; most people I think would pick the beginning value as the partition's name in 
&gt; common logic. 
&gt; 
&gt; And a second question related to the above question is how this end value is 
&gt; picked: partition named "0" is actually ending with number 0, and so forth 
&gt; for the other partitions. This is like the 160-bit space got right-shifted 
&gt; one number relative to 0-started numbering system. Is there a special reason 
&gt; for it in Riak, or simply want to use 1-started numbering system.
&gt; 
&gt; 
&gt; wr, donald
&gt; 
&gt; On Mon, Jan 28, 2013 at 3:21 PM, Charlie Voiselle  wrote:
&gt; Donald:
&gt; 
&gt; Since we are traversing the ring in a clockwise fashion, the data is written 
&gt; into the next partition you would run into moving forward. You can see how 
&gt; the partitions are chosen in chash:ordered\_from/2 at 
&gt; https://github.com/basho/riak\_core/blob/master/src/chash.erl#L138. The 
&gt; preference list is built using the partitions that come after the hashed 
&gt; value.
&gt; 
&gt; If you consider the partition's name to be the end value that the partition 
&gt; holds, the an object that hashes to 
&gt; 1045375627425331784151332358177649483819648417632 being assigned to 
&gt; 1096126227998177188652763624537212264741949407232 makes sense. That partition 
&gt; would hold items that hash from 
&gt; 913438523331814323877303020447676887284957839361 to 
&gt; 1096126227998177188652763624537212264741949407232
&gt; 
&gt; 
&gt; Does this help?
&gt; 
&gt; Thanks,
&gt; Charlie Voiselle
&gt; 
&gt; 
&gt; On Jan 24, 2013, at 12:05 AM, Donald Yan  wrote:
&gt; 
&gt;&gt; Hi there,
&gt;&gt; 
&gt;&gt; I'm reading this page at 
&gt;&gt; http://docs.basho.com/riak/latest/references/appendices/concepts/Replication/#Understanding-replication-by-example
&gt;&gt; and have a question about the example given in the page. I quote it here:
&gt;&gt; "
&gt;&gt; The DocIdx hash is a 160 bit integer:
&gt;&gt; 
&gt;&gt; (dev1@127.0.0.1)5&gt; &lt;&gt; = DocIdx.
&gt;&gt; &lt;&lt;183,28,67,173,80,128,26,94,190,198,65,15,27,243,135,127,121,101,255,96&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)6&gt; I.
&gt;&gt; 1045375627425331784151332358177649483819648417632
&gt;&gt; The node looks up the hashed key in the ring which returns a list of 
&gt;&gt; “preferred” partitions for the given key.
&gt;&gt; 
&gt;&gt; (node1@127.0.0.1)&gt; Preflist = riak\_core\_ring:preflist(DocIdx, Ring).
&gt;&gt; [{1096126227998177188652763624537212264741949407232, 'dev1@127.0.0.1'},
&gt;&gt; {1278813932664540053428224228626747642198940975104, 'dev2@127.0.0.1'},
&gt;&gt; {0, 'dev1@127.0.0.1'},
&gt;&gt; {182687704666362864775460604089535377456991567872, 'dev2@127.0.0.1'},
&gt;&gt; {365375409332725729550921208179070754913983135744, 'dev3@127.0.0.1'},
&gt;&gt; {548063113999088594326381812268606132370974703616, 'dev1@127.0.0.1'},
&gt;&gt; {730750818665451459101842416358141509827966271488, 'dev2@127.0.0.1'},
&gt;&gt; {913438523331814323877303020447676887284957839360, 'dev3@127.0.0.1'}]
&gt;&gt; 
&gt;&gt; "
&gt;&gt; 
&gt;&gt; I question is since the key is calculated as 
&gt;&gt; "1045375627425331784151332358177649483819648417632", shouldn't the prefer 
&gt;&gt; list be like the following instead?
&gt;&gt; "
&gt;&gt; [{913438523331814323877303020447676887284957839360, 'dev3@127.0.0.1'},
&gt;&gt; {1096126227998177188652763624537212264741949407232, 'dev1@127.0.0.1'},
&gt;&gt; {1278813932664540053428224228626747642198940975104, 'dev2@127.0.0.1'},
&gt;&gt; {0, 'dev1@127.0.0.1'},
&gt;&gt; {182687704666362864775460604089535377456991567872, 'dev2@127.0.0.1'},
&gt;&gt; {365375409332725729550921208179070754913983135744, 'dev3@127.0.0.1'},
&gt;&gt; {548063113999088594326381812268606132370974703616, 'dev1@127.0.0.1'},
&gt;&gt; {730750818665451459101842416358141509827966271488, 'dev2@127.0.0.1'}]
&gt;&gt; "
&gt;&gt; because value "1045375627425331784151332358177649483819648417632" falls 
&gt;&gt; between 913438523331814323877303020447676887284957839360 (partition 5) and 
&gt;&gt; 1096126227998177188652763624537212264741949407232 (partition 6)?
&gt;&gt; 
&gt;&gt; Please Riak experts help to clear my confusion here. Why partition 6, 7, 0 
&gt;&gt; are on the top 3 of the list?
&gt;&gt; 
&gt;&gt; Appreciate in advance.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -donald
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

