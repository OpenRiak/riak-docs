---
title: "Re: Trying to revamp the clj-riak driver"
description: ""
project: community
lastmod: 2012-12-18T15:04:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09625"
author_name: "Reid Draper"
project_section: "mailinglistitem"
sent_date: 2012-12-18T15:04:27-08:00
---



On Dec 18, 2012, at 4:05 PM, bgp2396  wrote:

&gt; Thanks! I did check out both of those, but as far as I could tell neither one 
&gt; supported conflict resolution, or at least it's not documented. If it is 
&gt; supported, do you think you could give an example of how to do it with sumo? 
&gt; I tried passing in the :vector-clock with in the map you pass into put, but 
&gt; that didn't yield any results.

Yeah sumo documentation could use some work :). You were right to use 
:vector-clock, and turns out it doesn't work because of a bug. The good news is 
I just fixed it [1] and pushed up a new release, 0.2.0. Readme is now updated 
and the release should be on Clojars already [2].

The rest of this explanation assumes you have {allow\_mult, true} set as a 
bucket property. You can find a description of how to change that here [3]

The basic workflow with sumo (and likely any other Riak client) should be:

1. GET values, which in sumo will return a seq of 0 or more results (0 
corresponds with not found, more than one means a conflict)
2. If there are more than 1 result, resolve the conflicts (I'll expand on this 
later in the response)
3. Update the single, resolved value with whatever you were trying to do
4. Write back to Riak with the vector clock returned from step 1. (sumo will 
return a seq of riak objects, each of which have identical vclocks, so you it 
doesn't matter which one you choose).

Here's a gist that shows this more explicitly [4].

Now, how do you actually do the conflict resolution? The short story is it's 
'app specific', but things like CRDTs [5] make it easier. I have a Clojure 
implementation of some basic
CRDTs, called knockbox [6].

Hope this helps, and don't hesitate ask more.

Reid

[1] 
https://github.com/reiddraper/sumo/commit/a7f080403622e0afb31a39a2f22984df28bba220
[2] https://clojars.org/sumo
[3] http://docs.basho.com/riak/latest/references/Configuration-Files/
[4] https://gist.github.com/4332614
[5] http://pagesperso-systeme.lip6.fr/Marc.Shapiro/papers/RR-6956.pdf
[6] https://github.com/reiddraper/knockbox


&gt; 
&gt; My use case right now is that I'm writing a little proxy server in clojure to 
&gt; interact with riak. The client will be getting (possibly multiple) values out 
&gt; of riak, and passing in the one that it wants to be correct (possibly 
&gt; changing that correct one in some way was well before sending it back).
&gt; 
&gt; --- On Tue, 12/18/12, Reid Draper  wrote:
&gt; 
&gt;&gt; From: Reid Draper 
&gt;&gt; Subject: Re: Trying to revamp the clj-riak driver
&gt;&gt; To: "bgp2396" 
&gt;&gt; Cc: riak-users@lists.basho.com
&gt;&gt; Date: Tuesday, December 18, 2012, 3:44 PM
&gt;&gt; For a more up-to-date Clojure client,
&gt;&gt; I'd recommend looking at Welle [1] or Sumo [2]. Not to
&gt;&gt; discourage you from doing some hacking, just throwing some
&gt;&gt; other options out there.
&gt;&gt; 
&gt;&gt; [1] http://clojureriak.info/
&gt;&gt; [2] https://github.com/reiddraper/sumo
&gt;&gt; 
&gt;&gt; Reid
&gt;&gt; 
&gt;&gt; On Dec 18, 2012, at 3:12 PM, bgp2396 
&gt;&gt; wrote:
&gt;&gt; 
&gt;&gt;&gt; I'm working on updating this driver to be in some kind
&gt;&gt; of working state:
&gt;&gt;&gt; https://github.com/mmcgrana/clj-riak
&gt;&gt;&gt; 
&gt;&gt;&gt; I've actually made some good progress, you can find my
&gt;&gt; fork of it here:
&gt;&gt;&gt; https://github.com/mediocregopher/clj-riak
&gt;&gt;&gt; 
&gt;&gt;&gt; I've gotten all the dependencies and such updated, and
&gt;&gt; (afaik) all of the old functionality is working again
&gt;&gt; (although I haven't tested mapreduce).
&gt;&gt;&gt; 
&gt;&gt;&gt; Right now I'm trying to add in support for vclocks and
&gt;&gt; conflict resolution. As it stands the driver always passes
&gt;&gt; in the vclock as blank. I've switched to using one of the
&gt;&gt; RiakObject constructors which has a vclock passed in as
&gt;&gt; well, but now the code throws a
&gt;&gt; "NullPointerException clojure.lang.Reflector.invokeNoArgInstanceMember"
&gt;&gt; when calling buildContent() on it. I wanted to check on the
&gt;&gt; mailing list to see if anyone might know why this is before
&gt;&gt; I started diving into the java code and trying to debug that
&gt;&gt; to figure out where exactly in buildContent() it's failing.
&gt;&gt;&gt; 
&gt;&gt;&gt; Here's a gist with relevant the relevant code:
&gt;&gt;&gt; https://gist.github.com/4331526
&gt;&gt;&gt; 
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt;&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

