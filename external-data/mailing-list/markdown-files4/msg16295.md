---
title: "Re: Riak LevelDB Deletion Problem"
description: ""
project: community
lastmod: 2015-07-14T14:29:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16295"
mailinglist_parent_id: "msg16294"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2015-07-14T14:29:04-07:00
---


Antonio,

Someone reminded me that you could make temporary space on your servers by 
deactivating active\_anti\_entropy, then deleting its data. Of course, this 
assumes you are running “anti\_entropy = active” in your riak.conf file.

I will send you some better notes if you think this is worth researching. Let 
me know your thoughts.

Matthew



&gt; On Jul 14, 2015, at 4:21 PM, Antonio Teixeira  wrote:
&gt; 
&gt; Ok Matthew,
&gt; 
&gt; We will proceed with the deletion , will monitor the disk space and will come 
&gt; back with further reports to the list.
&gt; 
&gt; Thanks for your time,
&gt; Antonio
&gt; 
&gt; 2015-07-14 18:32 GMT+01:00 Matthew Von-Maszewski  &gt;:
&gt; Antonio,
&gt; 
&gt; A Riak delete operation happens in these steps:
&gt; 
&gt; - Riak writes a “tombstone” value for the key to the N vnodes that contain it 
&gt; (this is a new record)
&gt; 
&gt; - Riak by default, waits 3 seconds to verify all vnodes agree to the 
&gt; tombstone/delete 
&gt; 
&gt; - Riak issues an actual delete operation against the key to leveldb
&gt; 
&gt; - leveldb creates its own tombstone
&gt; 
&gt; - the leveldb tombstone “floats” through level-0 and level-1 as part of 
&gt; normal compactions
&gt; 
&gt; - upon reaching level-2, leveldb will initiate immediate compaction and 
&gt; propagation of tombstones in .sst table files containing 1000 or more 
&gt; tombstones. This is when disk space recovery begins.
&gt; 
&gt; 
&gt; Yes, this means that initially the leveldb vnodes will grow in size until 
&gt; enough stuff (new data and/or tombstones) forces the tombstones to level-2 
&gt; via normal compaction operations. “Enough stuff” to fill levels 0 and 1 is 
&gt; about 4.2Gbytes of compressed Riak objects.
&gt; 
&gt; The “get” operation you mentioned is something that happens internally. A 
&gt; manual “get” by your code will not influence the operation.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt;&gt; On Jul 14, 2015, at 1:01 PM, Antonio Teixeira &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; Hi Matthew,
&gt;&gt; 
&gt;&gt; We will be removing close to 1 TB of data from the node , and since we are 
&gt;&gt; short on "disk space" when we saw that the disk space was actually rising we 
&gt;&gt; halted the data removal.
&gt;&gt; 
&gt;&gt; Now according to some docs I have read, if after a deletion ( a few seconds 
&gt;&gt; ) we make a .get() it force the release of the diskspace , is this true ?
&gt;&gt; 
&gt;&gt; For us it's not possible to move data to another node, is there any way even 
&gt;&gt; manually to release the space ? or at least to force :
&gt;&gt; " The actual release occurs significantly later (days, weeks, or even months 
&gt;&gt; later) when the tombstone record merges with the actual data in a background 
&gt;&gt; compaction."
&gt;&gt; 
&gt;&gt; Thanks for all the help,
&gt;&gt; Antonio
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 2015-07-14 17:43 GMT+01:00 Matthew Von-Maszewski &gt; &gt;:
&gt;&gt; Antonio,
&gt;&gt; 
&gt;&gt; Here is a detailed discussion of the Riak / leveldb delete scenario:
&gt;&gt; 
&gt;&gt; https://github.com/basho/leveldb/wiki/mv-aggressive-delete 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Pay close attention to the section titled “Update April 6, 2014”. This 
&gt;&gt; explains why as much as 4.2G bytes per vnode might remain within leveldb 
&gt;&gt; after deleting all keys. There is no mechanism to override the logic that 
&gt;&gt; causes the disk space retention.
&gt;&gt; 
&gt;&gt; One workaround is to use Riak’s handoff mechanism to transfer vnodes from 
&gt;&gt; one physical server to another. The vnode transfer will remove all deletion 
&gt;&gt; tombstones on the destination. The last step of the transfer then deletes 
&gt;&gt; all leveldb files on the original server, recovering the space.
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; &gt; On Jul 14, 2015, at 12:32 PM, Antonio Teixeira &gt; &gt; &gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Hello,
&gt;&gt; &gt;
&gt;&gt; &gt; We have been migrating our Riak Database to another infrastructure through 
&gt;&gt; &gt; a "streaming" process and right now we should have somewhere around 2Gb of 
&gt;&gt; &gt; free space the Hard Disk, however those 2Gb are still being used by Riak. 
&gt;&gt; &gt; After some research I believe the problem is the Objects are only being 
&gt;&gt; &gt; marked for deletion and not actually deleted at runtime. What we need is a 
&gt;&gt; &gt; way to aggressively deleted those keys or some way to force Riak to delete 
&gt;&gt; &gt; those marked keys and subsequently release the Disk Space. The Riak 
&gt;&gt; &gt; version we are using is v2.0.2
&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com 
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com 
&gt;&gt; &gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

