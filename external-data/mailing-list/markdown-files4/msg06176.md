---
title: "Re: riak-erlang-client write, riak-java-client read problem"
description: ""
project: community
lastmod: 2012-01-09T04:56:39-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06176"
mailinglist_parent_id: "msg06166"
author_name: "Marcel MÃ¼ller"
project_section: "mailinglistitem"
sent_date: 2012-01-09T04:56:39-08:00
---


Hi Sean, 

thanks for your help but we found another problem:

after we insert the valid json:
 {ok,Pid} = riakc\_pb\_socket:start\_link("10.10.10.74", 8087),
 Value = mochijson2:encode({struct, [{id, 22}]}),
 In = riakc\_obj:new(&lt;&lt;"mm"&gt;&gt;,&lt;&lt;"1"&gt;&gt;,Value,"application/json"),
 riakc\_pb\_socket:put(Pid,In)

we read it from erlang:

 {ok, Obj} = riakc\_pb\_socket:get(Pid,"mm","1"),
 io:format("Obj: ~p~n",[Obj]),
 ContentType = riakc\_obj:get\_content\_type(Obj),
 io:format("ContentType: ~p~n",[ContentType]),

Obj: {riakc\_obj,"mm","1",
 &lt;&lt;107,206,97,96,96,96,204,96,202,5,82,28,202,156,255,126,250,
 
115,109,75,206,96,74,228,206,99,101,152,17,87,127,130,47,11,0&gt;&gt;,
 [{{dict,3,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,51,122,101,57,117,75,111,98,113,
 118,97,77,100,117,114,76,97,56,122,68,115,70],
 [&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,116,
 105,111,110,47,120,45,101,114,108,97,110,103,45,
 98,105,110,97,114,121]],
 [],[],
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1326,113432,240315}]],
 [],[]}}},
 &lt;&lt;131,107,0,4,84,69,83,84&gt;&gt;}],
 undefined,undefined}
ContentType: "application/x-erlang-binary"

We received every time x-erlang-binary

When we wrote the same over the http api for example: 

curl -X PUT -H "Content-Type: application/json" -i 
http://127.0.0.1:8098/riak/mm/2 -d '{"email:","email to 
email.com","pass":"123123"}'

Obj: {riakc\_obj,"mm","2",
 &lt;&lt;107,206,97,96,96,96,204,96,202,5,82,28,202,156,255,126,250,
 115,157,14,206,96,74,100,204,99,101,232,115,175,63,193,151,5,
 0&gt;&gt;,
 [{{dict,3,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,122,97,52,89,80,115,106,112,121,
 57,118,98,68,81,114,66,56,72,109,78,52],
 [&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,116,
 105,111,110,47,106,115,111,110]],
 [],[],
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1326,107534,668061}]],
 [],[]}}},
 &lt;&lt;"{\"email:\",\"email to 
email.com\",\"pass\":\"123123\"}"&gt;&gt;}],
 undefined,undefined}
ContentType: "application/json"


It looks like the risk\_obj:new don't write the right content-type. 

Can you imagine why ? 

Thanks
Marcel 


Am 07.01.2012 um 18:29 schrieb Sean Cribbs:

&gt; Marcel,
&gt; 
&gt; {ok,Pid} = riakc\_pb\_socket:start\_link("127.0.0.1", 8087),
&gt; Tuple = "{\"id\",22}",
&gt; 
&gt; That is not valid JSON, first of all. 
&gt; 
&gt; Obj = riakc\_obj:new("mm","1",Tuple),
&gt; 
&gt; Make sure that you set the content type here, otherwise it won't be detected 
&gt; on the Java side. (example below)
&gt; 
&gt; riakc\_pb\_socket:put(Pid,Obj),
&gt; 
&gt; After then we try to read from risk-java-client:
&gt; 
&gt; RiakClient httpClient = new RiakClient("http://10.10.10.61:8098/riak");
&gt; IRiakClient client = RiakFactory.httpClient(httpClient);
&gt; Bucket b = client.fetchBucket("mm").execute();
&gt; IRiakObject fetched = b.fetch("1").execute();
&gt; String decodedString = new String(fetched.getValue());
&gt; System.out.println(decodedString);
&gt; 
&gt; I convert the Object to an HexString: 83 6B 00 05 7B 22 6E 22 7D
&gt; 
&gt; 
&gt; Decoding that byte array in Erlang gives:
&gt; 
&gt; 1&gt; &lt;&lt;16#83,16#6B,0,5,16#7B,16#22,16#6E,16#22,16#7D&gt;&gt;.
&gt; &lt;&lt;131,107,0,5,123,34,110,34,125&gt;&gt;
&gt; 2&gt; binary\_to\_term(v(1)).
&gt; "{\"n\"}"
&gt; 3&gt; 
&gt; 
&gt; The default behavior of the Erlang client is to serialize terms to binary 
&gt; unless the content type is explicit and the value of the object is a binary. 
&gt; Try this instead:
&gt; 
&gt; Value = mochijson2:encode({struct, [{id, 22}]}),
&gt; Obj = riakc\_obj:new(&lt;&lt;"mm"&gt;&gt;,&lt;&lt;"1"&gt;&gt;,Value,"application/json"),
&gt; riakc\_pb\_socket:put(Pid, Obj)
&gt; 
&gt; Then re-read it from the Java side and you should get what you expect.
&gt; 
&gt; My question is: 
&gt; 
&gt; 1. What are the first 4 bytes ? 
&gt; 
&gt; A binary that starts with byte 131 is typically in Erlang 
&gt; term\_to\_binary/binary\_to\_term format.
&gt; 
&gt; 2. how can i receive a string with out the 4 bytes ? 
&gt; 
&gt; See above.
&gt; 
&gt; 3. How can i convert the string into a JSON Object ? 
&gt; 
&gt; 
&gt; See above, and then use Jackson to decode the value (I believe the Java 
&gt; client may do this automatically for you).
&gt; 
&gt; -- 
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

