---
title: "Re: EC2 and RIAK"
description: ""
project: community
lastmod: 2011-04-01T10:00:37-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02841"
mailinglist_parent_id: "msg02836"
author_name: "Mark Steele"
project_section: "mailinglistitem"
sent_date: 2011-04-01T10:00:37-07:00
---


I've done some rather disappointing tests with Riak using Rackspace cloud
servers. Much better off on dedicated hardware if you can find it.

Mark Steele
Bering Media Inc.


On Fri, Apr 1, 2011 at 11:51 AM, David Dawson wrote:

&gt; Mathias and Alexander,
&gt;
&gt; Thanks for both of your replies they were very informative and
&gt; really have helped me to make my mind up, but to summarise:
&gt;
&gt; - If you want good predictable performance but you are happy to live
&gt; with the risk of loosing some of your data ( in the event of a cluster
&gt; failure where the number of nodes that fail &gt; than your n\_val ) then run
&gt; with the local ephemeral storage in RAID 5 or 10 and take snapshots of the
&gt; data periodically or run in dual DC mode with replication.
&gt; - If you want 100% assurance that your data is available and you
&gt; are happy with unpredictable performance then use EBS.
&gt; - If you want 100% assurance that your data is available and also
&gt; has predictable performance then Amazon EC2 is not the most optimal choice.
&gt;
&gt; In our scenario we are doing a equal amount of reads and writes, and
&gt; will need to guarantee about 32K ops/sec from a RIAK cluster over a 2 hour
&gt; period with minimal risks of a outage or drop in performance, hence I am
&gt; guessing that maybe EC2 is not the right choice for us. We are going to look
&gt; at Joyent as an alternative, that said has anyone else used other solutions
&gt; e.g. RackSpace cloud?
&gt;
&gt; Dave
&gt;
&gt;
&gt; On 1 Apr 2011, at 14:21, Mathias Meyer wrote:
&gt;
&gt; &gt; Hi David,
&gt; &gt;
&gt; &gt; Alexander already gave you a good rundown on EC2 and Riak, but let me add
&gt; some of my own experiences running databases on EC2 in general.
&gt; &gt;
&gt; &gt; The short answer is, Riak is certainly successfully used in production on
&gt; EC2, so nothing should hold you back from testing a setup on EC2. But
&gt; there's a whole bunch of things you should keep in mind.
&gt; &gt;
&gt; &gt; First, it's probably a good idea to avoid using ephemeral storage as
&gt; persistent storage. Even though it rarely happens, instances can crash on
&gt; EC2 for any kind of reason, mostly a hardware failure of the underlying host
&gt; of course.
&gt; &gt;
&gt; &gt; Cluster compute instances offer especially high CPU power, but what you
&gt; really want is really fast and reliable storage I/O, persisted for eternity
&gt; if need be. CC instances are certainly a lot better than any other instance
&gt; in that terms of general I/O (see [2] for a comparison), but fall prey to
&gt; similar limitations in terms of network storage I/O as other instance types,
&gt; see below.
&gt; &gt;
&gt; &gt; The RAID 0'd ephemeral storage on the cluster compute instances may sound
&gt; good in theory in terms of performance, but in practice it takes away data
&gt; durability in case of a single disk failure. One disk fails, and the data on
&gt; that node is gone. Depending on what kinds of seek your doing, an EBS setup
&gt; may even turn out to be faster. See [6] and [4] for a comparison and some
&gt; initial and extended measurements, and [7] for another comparison. But
&gt; certainly, the cluster compute instance's ephemeral storage can achieve a
&gt; good amount of throughput, see [5] for some pretty graphs comparing both
&gt; RAID and non-RAID setups.
&gt; &gt;
&gt; &gt; As Alexander pointed out, multiple instance failures can make this
&gt; scenario a real killer, though you end up with the same risks as running on
&gt; raw iron servers. Both ephemeral storage and EBS don't make the problem of a
&gt; proper backup disappear. You could e.g. run off ephemeral storage, relying
&gt; on both Riak's replication and a good backup e.g. to an EBS volume or to S3.
&gt; &gt;
&gt; &gt; EBS on the other hand is prone to a large variance in network latency,
&gt; making performance at any point unpredictable and unreliable. Every
&gt; measurement you take is likely to be different an hour later. This may sound
&gt; extreme, but it turns out to be a very big issue for databases where there's
&gt; lots of disk I/O involved to read and write data, as is the case with Riak's
&gt; Bitcask storage.
&gt; &gt;
&gt; &gt; You can increase the performance and reliability of EBS by using a RAID
&gt; of volumes. Preferrably go for a RAID 5 or RAID 10 to add redundancy.
&gt; There's mixed opinions on whether that's really necessary on EBS, with
&gt; Amazon keeping the data redundant on their end as well, but in general, it's
&gt; a good tradeoff between increased performance through striping and increased
&gt; redundancy through mirroring. [1] has a good summary of when it's better to
&gt; choose RAID 5 vs. 10.
&gt; &gt;
&gt; &gt; RAID 0 will obviously bring the best performance, it's certainly a valid
&gt; setup. We've been running RAID 0 setups with 4 volumes, and got great
&gt; improvements over a single volume. You're also likely to achieve more
&gt; throughput on bigger instances with a setup like this. The caveat once again
&gt; is that one corrupted volume is enough to make a RAID 0 setup unusable.
&gt; &gt;
&gt; &gt; Another crazy thought is to setup a RAID striping across a bunch of
&gt; ephemeral drives and EBS volumes, maximizing throughput on both local and
&gt; network storage. But know what you're getting yourself into with this kind
&gt; of setup, especially when your write load is a lot heavier then the
&gt; available network bandwidth can handle, a scenario where your network
&gt; volumes will never be able to catch up with the local storage.
&gt; &gt;
&gt; &gt; All that said, EBS I/O sure is reasonably fast, but it depends on your
&gt; particular use case and performance requirements. It's also worth noting
&gt; that the I/O capabilities of EBS increase with the instance size. The bigger
&gt; your instance, the more throughput you'll achieve (see [3]). Bigger
&gt; instances tend to have better network throughput in general, with cluster
&gt; compute instances obviously having some of the highest bandwidth available.
&gt; &gt;
&gt; &gt; All this turns out to be much less of a problem when data can be held in
&gt; memory very easily, e.g. with Innostore, where you can read and write
&gt; to/from cache buffers first and then have InnoDB take care of flushing to
&gt; disk.
&gt; &gt;
&gt; &gt; Personally, I don't think you're overcomplicating things in regard to
&gt; multiple availability zones, it's a good idea to do that, when highest
&gt; availability possible is your goal, as when it's usually just a single
&gt; availability zone that's affected by increased latency or network timeouts,
&gt; but as Alexander said, you should think about having cross-datacenter
&gt; replication in that scenario, as availability zones are data centers located
&gt; in different physical locations. Usually they're not that far apart, but far
&gt; enough to increase latency considerably. But as always, it depends on your
&gt; particular use case.
&gt; &gt;
&gt; &gt; Now, after all this realtalk, here's the kicker. Riak's way of
&gt; replicating data can make both scenarios work. When it's ensured that your
&gt; data is replicated on more than one node, it can work in both ways. You
&gt; could use both ephemeral storage and be somewhat safe because data will
&gt; reside on multiple nodes. The same is true for EBS volumes, as potential
&gt; variances in I/O or even minutes of total unavailabilities (as seen on the
&gt; recent Reddit outage) can be recovered a lot easier thanks to handoff and
&gt; read repairs. You can increase the number of replicas (n\_val) to increase
&gt; your tolerance of instance failure, just make sure that n\_val is less than
&gt; the number of nodes in your cluster.
&gt; &gt;
&gt; &gt; Don't get me wrong, I love EC2 and EBS, being able to spin up servers at
&gt; any time and to attache more storage to a running instance is extremely
&gt; powerful, when you can handle the downsides. But if very low latency is what
&gt; you're looking for, raw iron with lots of memory and SSD as storage device
&gt; thrown on top is hard to beat.
&gt; &gt;
&gt; &gt; When in doubt, start with a RAID 0 setup on EBS with 4 volumes, and
&gt; compare it with a RAID 5 in terms of performance. They're known to give a
&gt; good enough performance in a lot of cases. If you decide to go with a RAID,
&gt; be sure to add LVM on top for simpler snapshotting, which will be quite
&gt; painful if not impossible to get consistent snapshots using just EBS
&gt; snapshots on a bunch of striped volumes.
&gt; &gt;
&gt; &gt; Let us know if you have more questions, there's lots of details involved
&gt; when you're going under the hood, but this should cover the most important
&gt; bases.
&gt; &gt;
&gt; &gt; Mathias Meyer
&gt; &gt; Developer Advocate, Basho Technologies
&gt; &gt;
&gt; &gt; [1]
&gt; http://en.wikipedia.org/wiki/RAID#RAID\_10\_versus\_RAID\_5\_in\_Relational\_Databases
&gt; &gt; [2]
&gt; http://blog.cloudharmony.com/2010/09/benchmarking-of-ec2s-new-cluster.html
&gt; &gt; [3]
&gt; http://blog.cloudharmony.com/2010/06/disk-io-benchmarking-in-cloud.html
&gt; &gt; [4]
&gt; http://blog.bioteam.net/2010/07/boot-ephemeral-ebs-storage-performance-on-amazon-cc1-4xlarge-instance-types/
&gt; &gt; [5]
&gt; http://blog.bioteam.net/2010/07/local-storage-performance-of-aws-cluster-compute-instances/
&gt; &gt; [6]
&gt; http://blog.bioteam.net/2010/07/preliminary-ebs-performance-tests-on-amazon-compute-cluster-cc1-4xlarge-instance-types/
&gt; &gt; [7] http://victortrac.com/EC2\_Ephemeral\_Disks\_vs\_EBS\_Volumes
&gt; &gt;
&gt; &gt; On Mittwoch, 30. MÃ¤rz 2011 at 18:29, David Dawson wrote:
&gt; &gt;&gt; I am not sure if this has already been discussed, but I am looking at
&gt; the feasibility of running RIAK in a EC2 cloud, as we have a requirement
&gt; that may require us to scale up and down quite considerably on a month by
&gt; month basis. After some initial testing and investigation we have come to
&gt; the conclusion that there are 2 solutions although both have their downsides
&gt; in my opinion:
&gt; &gt;&gt;
&gt; &gt;&gt; 1. Run multiple cluster compute( cc1.4xlarge ) instances ( 23 GB RAM, 10
&gt; Gigabit ethernet, 2 x 845 GB disks running RAID 0 )
&gt; &gt;&gt; 2. Same as above but using EBS as the storage instead of the local
&gt; disks.
&gt; &gt;&gt;
&gt; &gt;&gt; The problems I see are as follows with solution 1:
&gt; &gt;&gt;
&gt; &gt;&gt; - A instance failure results in complete loss of data on that machine,
&gt; as the disks are ephemeral storage ( e.g. they only exist whilst the machine
&gt; is up ).
&gt; &gt;&gt;
&gt; &gt;&gt; The problems I see are as follows with solution 2:
&gt; &gt;&gt;
&gt; &gt;&gt; - EBS is slower than the local disks and from what I have read is
&gt; susceptible to latency depending on factors out of your control.
&gt; &gt;&gt; - There has been a bit of press lately about availability problems with
&gt; EBS, so we would have to use multiple availability zones although there are
&gt; only 4 in total and it just seems as though I am over complicating things.
&gt; &gt;&gt;
&gt; &gt;&gt; Has anyone used EC2 and RIAK in production and if so what are their
&gt; experiences?
&gt; &gt;&gt;
&gt; &gt;&gt; Otherwise has anyone used RackSpace or Joyent? as these are alternatives
&gt; although the Joyent solution seems very expensive, and what are their
&gt; experiences?
&gt; &gt;&gt;
&gt; &gt;&gt; Dave
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

