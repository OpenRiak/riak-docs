---
title: "Re: Riak Java client 100% CPU"
description: ""
project: community
lastmod: 2013-02-15T05:10:44-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10136"
mailinglist_parent_id: "msg10131"
author_name: "Daniel Iwan"
project_section: "mailinglistitem"
sent_date: 2013-02-15T05:10:44-08:00
---


Hi

Thanks for that and also for building riak-client with all dependencies.
But I'm afraid S3 bucket is password protected or link expired since I'm
getting AccessDenied on that 1.1.0 jar

Daniel



On 14 February 2013 17:22, Brian Roach  wrote:

&gt; Daniel -
&gt;
&gt; Yes, sorry about that. This has been corrected in the current master
&gt; on github and version 1.1.0 of the client will be released today.
&gt; https://github.com/basho/riak-java-client/pull/212
&gt;
&gt; Thanks!
&gt; Brian Roach
&gt;
&gt; On Thu, Feb 14, 2013 at 9:31 AM, Daniel Iwan 
&gt; wrote:
&gt; &gt; I see 100% CPU very regularly on one of the Riak client (v1.0.7) threads.
&gt; &gt; I think the place where it spins is connection reaper in
&gt; RiakConnectionPool
&gt; &gt;
&gt; &gt; I looked at it briefly and it seems that when it finds first connection
&gt; &gt; using peek but that does not expired it can spin in tight while loop.
&gt; &gt; I guess second peek() should be outside if block?
&gt; &gt;
&gt; &gt; private synchronized void doStart() {
&gt; &gt; if (idleConnectionTTLNanos &gt; 0) {
&gt; &gt; idleReaper.scheduleWithFixedDelay(new Runnable() {
&gt; &gt; public void run() {
&gt; &gt; RiakConnection c = available.peek();
&gt; &gt; while (c != null) {
&gt; &gt; long connIdleStartNanos =
&gt; c.getIdleStartTimeNanos();
&gt; &gt; if (connIdleStartNanos + idleConnectionTTLNanos &lt;
&gt; &gt; System.nanoTime()) {
&gt; &gt; if (c.getIdleStartTimeNanos() ==
&gt; &gt; connIdleStartNanos) {
&gt; &gt; // still a small window, but better than
&gt; &gt; locking
&gt; &gt; // the whole pool
&gt; &gt; boolean removed = available.remove(c);
&gt; &gt; if (removed) {
&gt; &gt; c.close();
&gt; &gt; permits.release();
&gt; &gt; }
&gt; &gt; }
&gt; &gt; c = available.peek();
&gt; &gt; }
&gt; &gt; }
&gt; &gt; }
&gt; &gt; }, idleConnectionTTLNanos, idleConnectionTTLNanos,
&gt; &gt; TimeUnit.NANOSECONDS);
&gt; &gt; }
&gt; &gt;
&gt; &gt; state = State.RUNNING;
&gt; &gt; }
&gt; &gt;
&gt; &gt;
&gt; &gt; Regards
&gt; &gt; Daniel Iwan
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

