---
title: "Re: Riak Nodes Crashing"
description: ""
project: community
lastmod: 2014-12-05T11:44:34-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15326"
mailinglist_parent_id: "msg15325"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2014-12-05T11:44:34-08:00
---


Satish,

Here is a key line from /var/log/messages:

Dec 5 06:52:43 ip-10-196-72-106 kernel: [26881589.804401] beam.smp invoked 
oom-killer: gfp\_mask=0x201da, order=0, oom\_adj=0, oom\_score\_adj=0

The log entry does NOT match the timestamps of the crash.log and error.log 
below. But that is ok. The operating system killed off Riak. There would 
have be no notification in the Riak log's of the operating system's actions.

The fact that the out of memory monitor, oom-killer, killed Riak further 
supports the change to max\_open\_files. I recommend we now wait to see if the 
problem occurs again.


Matthew


On Dec 5, 2014, at 2:35 PM, ender  wrote:

&gt; Hey Matthew,
&gt; 
&gt; The crash occurred around 3:00am:
&gt; 
&gt; -rw-rw-r-- 1 riak riak 920 Dec 5 03:01 crash.log
&gt; -rw-rw-r-- 1 riak riak 617 Dec 5 03:01 error.log
&gt; 
&gt; I have attached the syslog that covers that time. I also went ahead and 
&gt; changed max\_open\_files in app.config to to 150 from 315.
&gt; 
&gt; Satish
&gt; 
&gt; 
&gt; On Fri, Dec 5, 2014 at 11:29 AM, Matthew Von-Maszewski  
&gt; wrote:
&gt; Satish,
&gt; 
&gt; The "key" system log varies by Linux platform. Yes, /var/log/messages may 
&gt; hold some key clues. Again, be sure the file covers the time of a crash.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; On Dec 5, 2014, at 1:29 PM, ender  wrote:
&gt; 
&gt;&gt; Hey Matthew,
&gt;&gt; 
&gt;&gt; I see a /var/log/messages file, but no syslog or system.log etc. Is it the 
&gt;&gt; messages file you want?
&gt;&gt; 
&gt;&gt; Satish
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Fri, Dec 5, 2014 at 10:06 AM, Matthew Von-Maszewski  
&gt;&gt; wrote:
&gt;&gt; Satish,
&gt;&gt; 
&gt;&gt; I find nothing compelling in the log or the app.config. Therefore I have 
&gt;&gt; two additional suggestions/requests:
&gt;&gt; 
&gt;&gt; - lower max\_open\_files in app.config to to 150 from 315. There was one 
&gt;&gt; other customer report regarding the limit not properly stopping out of 
&gt;&gt; memory (OOM) conditions.
&gt;&gt; 
&gt;&gt; - try to locate a /var/log/syslog\* file from a node that contains the time 
&gt;&gt; of the crash. There may be helpful information there. Please send that 
&gt;&gt; along.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Unrelated to this crash … 1.4.7 has a known bug in its active anti-entropy 
&gt;&gt; (AAE) logic. This bug is NOT known to cause a crash. The bug does cause 
&gt;&gt; AAE to be unreliable for data restoration. The proper steps for upgrading 
&gt;&gt; to the current release (1.4.12) are:
&gt;&gt; 
&gt;&gt; -- across the entire cluster
&gt;&gt; - disable anti\_entropy in app.config on all nodes: {anti\_entropy, {off, []}}
&gt;&gt; - perform a rolling restart of all nodes … AAE is now disabled in the 
&gt;&gt; cluster 
&gt;&gt; 
&gt;&gt; -- on each node
&gt;&gt; - stop the node
&gt;&gt; - remove (erase all files and directories) /vol/lib/riak/anti\_entropy
&gt;&gt; - update Riak to the new software revision
&gt;&gt; - start the node again
&gt;&gt; 
&gt;&gt; -- across the entire cluster
&gt;&gt; - enable anti\_entropy in app.config on all nodes: {anti\_entropy, {on, []}}
&gt;&gt; - perform a rolling restart of all nodes … AAE is now enabled in the cluster 
&gt;&gt; 
&gt;&gt; The nodes will start rebuilding the AAE hash data. Suggest you perform the 
&gt;&gt; last rolling restart during a low utilization time of your cluster.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Dec 5, 2014, at 11:02 AM, ender  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi Matthew,
&gt;&gt;&gt; 
&gt;&gt;&gt; Riak version: 1.4.7
&gt;&gt;&gt; 5 Nodes in cluster
&gt;&gt;&gt; RAM: 30GB
&gt;&gt;&gt; 
&gt;&gt;&gt; The leveldb logs are attached.
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Thu, Dec 4, 2014 at 1:34 PM, Matthew Von-Maszewski  
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; Satish,
&gt;&gt;&gt; 
&gt;&gt;&gt; Some questions:
&gt;&gt;&gt; 
&gt;&gt;&gt; - what version of Riak are you running? logs suggest 1.4.7
&gt;&gt;&gt; - how many nodes in your cluster?
&gt;&gt;&gt; - what is the physical memory (RAM size) of each node?
&gt;&gt;&gt; - would you send the leveldb LOG files from one of the crashed servers:
&gt;&gt;&gt; tar -czf satish\_LOG.tgz /vol/lib/riak/leveldb/\*/LOG\*
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Matthew
&gt;&gt;&gt; 
&gt;&gt;&gt; On Dec 4, 2014, at 4:02 PM, ender  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; &gt; My RIak installation has been running successfully for about a year. 
&gt;&gt;&gt; &gt; This week nodes suddenly started randomly crashing. The machines have 
&gt;&gt;&gt; &gt; plenty of memory and free disk space, and looking in the ring directory 
&gt;&gt;&gt; &gt; nothing appears to amiss:
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; [ec2-user@ip-10-196-72-247 ~]$ ls -l /vol/lib/riak/ring
&gt;&gt;&gt; &gt; total 80
&gt;&gt;&gt; &gt; -rw-rw-r-- 1 riak riak 17829 Nov 29 19:42 
&gt;&gt;&gt; &gt; riak\_core\_ring.default.20141129194225
&gt;&gt;&gt; &gt; -rw-rw-r-- 1 riak riak 17829 Dec 3 19:07 
&gt;&gt;&gt; &gt; riak\_core\_ring.default.20141203190748
&gt;&gt;&gt; &gt; -rw-rw-r-- 1 riak riak 17829 Dec 4 16:29 
&gt;&gt;&gt; &gt; riak\_core\_ring.default.20141204162956
&gt;&gt;&gt; &gt; -rw-rw-r-- 1 riak riak 17847 Dec 4 20:45 
&gt;&gt;&gt; &gt; riak\_core\_ring.default.20141204204548
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; [ec2-user@ip-10-196-72-247 ~]$ du -h /vol/lib/riak/ring
&gt;&gt;&gt; &gt; 84K /vol/lib/riak/ring
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; I have attached a tarball with the app.config file plus all the logs from 
&gt;&gt;&gt; &gt; the node at the time of the crash. Any help much appreciated!
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; Satish
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

