---
title: "Re: Link walking with a java client"
description: ""
project: community
lastmod: 2012-06-01T23:10:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07597"
mailinglist_parent_id: "msg07572"
author_name: "Deepak Balasubramanyam"
project_section: "mailinglistitem"
sent_date: 2012-06-01T23:10:07-07:00
---


Created bug 1341  to track
this.

Can you help me with the questions below ? I am trying to gauge how
expensive linking is in comparison to using a secondary index to track a
node.

Thanks
Deepak

On Wed, May 30, 2012 at 9:42 AM, Deepak Balasubramanyam &lt;
deepak.b...@gmail.com&gt; wrote:

&gt; Brian,
&gt;
&gt; Yes I read about the hack somewhere in your documentation. My
&gt; understanding is that the link walking operation will cease to work via
&gt; HTTP after links to a node grow beyond a particular number. This happens
&gt; because a HTTP header is used to send link related data and there are
&gt; limits around how much data a header can hold.
&gt;
&gt; I was interested in exploring if the PB client can overcome this
&gt; limitation. The use case I am interested in is this - If a single node
&gt; links to 10k nodes, how much time would it take a link walker to visit all
&gt; nodes via the PB client ? What sort of client would you recommend for
&gt; something like this ?
&gt;
&gt; I know that linking is only meant to be used as a lightweight feature.
&gt; Would 10k links to a node be considered lightweight ?
&gt;
&gt; Thanks
&gt; Deepak
&gt;
&gt; On Tue, May 29, 2012 at 9:33 PM, Brian Roach  wrote:
&gt;
&gt;&gt; Deepak -
&gt;&gt;
&gt;&gt; I'll take a look at it this week, but more than likely it's a bug.
&gt;&gt;
&gt;&gt; Link walking is a REST only operation as far as Riakâ€™s interfaces are
&gt;&gt; concerned. Link Walking in the protocol buffers Java client is a hack that
&gt;&gt; issues two m/r jobs to the protocol buffers interface (the first constructs
&gt;&gt; the inputs to the second by walking the links, the second returns the data).
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Brian Roach
&gt;&gt;
&gt;&gt; On May 27, 2012, at 7:19 AM, Deepak Balasubramanyam wrote:
&gt;&gt;
&gt;&gt; &gt; This looks like a bug. The code to walk links via a HTTP client works
&gt;&gt; perfectly. The same code fails when the PB client is used. The POJO
&gt;&gt; attached in this email reproduces the problem.
&gt;&gt; &gt;
&gt;&gt; &gt; I searched the email archives and existing issues and found no trace of
&gt;&gt; this problem. Please run the POJO by swapping the clients returned from the
&gt;&gt; getClient() method to reproduce the problem. I can create a bug report once
&gt;&gt; someone from the dev team confirms this really is a bug.
&gt;&gt; &gt;
&gt;&gt; &gt; Riak client pom:
&gt;&gt; &gt; 
&gt;&gt; &gt; com.basho.riak
&gt;&gt; &gt; riak-client
&gt;&gt; &gt; 1.0.5
&gt;&gt; &gt; 
&gt;&gt; &gt;
&gt;&gt; &gt; Riak server version - 1.1.2. Built from source.
&gt;&gt; &gt; 4 nodes running on 1 machine. OS - Linux mint.
&gt;&gt; &gt;
&gt;&gt; &gt; On Sun, May 27, 2012 at 10:05 AM, Deepak Balasubramanyam &lt;
&gt;&gt; deepak.b...@gmail.com&gt; wrote:
&gt;&gt; &gt; Hi,
&gt;&gt; &gt;
&gt;&gt; &gt; I have a cluster that contains 2 buckets. A bucket named 'usersMine'
&gt;&gt; contains the key 'user2', which is linked to several keys (about 10) under
&gt;&gt; a bucket named userPreferences. The relationship exists under the name
&gt;&gt; 'myPref'. A user and a preference have String values.
&gt;&gt; &gt;
&gt;&gt; &gt; I can successfully traverse the link over HTTP using the following URL -
&gt;&gt; &gt;
&gt;&gt; &gt; curl -v localhost:8091/riak/usersMine/user2/\_,myPref,1
&gt;&gt; &gt;
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt; &gt; User-Agent: curl/7.21.6 (i686-pc-linux-gnu) libcurl/7.21.6
&gt;&gt; OpenSSL/1.0.0e zlib/1.2.3.4 libidn/1.22 librtmp/2.3
&gt;&gt; &gt; &gt; Host: localhost:8091
&gt;&gt; &gt; &gt; Accept: \*/\*
&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &lt; HTTP/1.1 200 OK
&gt;&gt; &gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt;&gt; &gt; &lt; Expires: Sun, 27 May 2012 04:12:39 GMT
&gt;&gt; &gt; &lt; Date: Sun, 27 May 2012 04:02:39 GMT
&gt;&gt; &gt; &lt; Content-Type: multipart/mixed; boundary=IYGfKNqjGdco9ddfyjRP1Utzfi2
&gt;&gt; &gt; &lt; Content-Length: 3271
&gt;&gt; &gt; &lt;
&gt;&gt; &gt;
&gt;&gt; &gt; --IYGfKNqjGdco9ddfyjRP1Utzfi2
&gt;&gt; &gt; Content-Type: multipart/mixed; boundary=3YVES0x2tFnUDOdTzfn1OGS6uMt
&gt;&gt; &gt;
&gt;&gt; &gt; --3YVES0x2tFnUDOdTzfn1OGS6uMt
&gt;&gt; &gt; X-Riak-Vclock: a85hYGBgzGDKBVIcMRuuc/nvy7mSwZTImMfKUKpodpIvCwA=
&gt;&gt; &gt; Location: /riak/userPreferences/preference3004
&gt;&gt; &gt; Content-Type: text/plain; charset=UTF-8
&gt;&gt; &gt; Link: ; rel="up"
&gt;&gt; &gt; Etag: 5GucnGSk4TjQc8BO1eNLyI
&gt;&gt; &gt; Last-Modified: Sun, 27 May 2012 03:54:29 GMT
&gt;&gt; &gt;
&gt;&gt; &gt; junk
&gt;&gt; &gt;
&gt;&gt; &gt; &lt;&lt; ------------------------ Truncated ------------------------ &gt;&gt;
&gt;&gt; &gt; junk
&gt;&gt; &gt; --3YVES0x2tFnUDOdTzfn1OGS6uMt--
&gt;&gt; &gt;
&gt;&gt; &gt; --IYGfKNqjGdco9ddfyjRP1Utzfi2--
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt;
&gt;&gt; &gt; However when I use the java client to walk the link, I get a
&gt;&gt; ClassCastException.
&gt;&gt; &gt;
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt; Java code:
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt; private void getAllLinks()
&gt;&gt; &gt; {
&gt;&gt; &gt; String user="user2";
&gt;&gt; &gt; IRiakClient riakClient = null;
&gt;&gt; &gt; try
&gt;&gt; &gt; {
&gt;&gt; &gt; long past = System.currentTimeMillis();
&gt;&gt; &gt; riakClient = RiakFactory.pbcClient("localhost",8081);
&gt;&gt; &gt; Bucket userBucket =
&gt;&gt; riakClient.fetchBucket("usersMine").execute();
&gt;&gt; &gt; DefaultRiakObject user1 =(DefaultRiakObject)
&gt;&gt; userBucket.fetch(user).execute();
&gt;&gt; &gt; List links = user1.getLinks();
&gt;&gt; &gt; System.out.println(links.size());
&gt;&gt; &gt; WalkResult execute =
&gt;&gt; riakClient.walk(user1).addStep("userPreferences", "myPref",true).execute();
&gt;&gt; &gt; Iterator iterator = execute.iterator();
&gt;&gt; &gt; while(iterator.hasNext())
&gt;&gt; &gt; {
&gt;&gt; &gt; Object next = iterator.next();
&gt;&gt; &gt; System.out.println(next);
&gt;&gt; &gt; }
&gt;&gt; &gt; long now = System.currentTimeMillis();
&gt;&gt; &gt; System.out.println("Retrieval in " + (now-past) + " ms");
&gt;&gt; &gt; }
&gt;&gt; &gt; catch (Exception e)
&gt;&gt; &gt; {
&gt;&gt; &gt; e.printStackTrace();
&gt;&gt; &gt; }
&gt;&gt; &gt; finally
&gt;&gt; &gt; {
&gt;&gt; &gt; if(riakClient != null)
&gt;&gt; &gt; {
&gt;&gt; &gt; riakClient.shutdown();
&gt;&gt; &gt; }
&gt;&gt; &gt; }
&gt;&gt; &gt; }
&gt;&gt; &gt;
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt; Stack:
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt; java.lang.ClassCastException: java.lang.String cannot be cast to
&gt;&gt; java.util.List
&gt;&gt; &gt; at
&gt;&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.linkWalkSecondPhase(PBClientAdapter.java:380)
&gt;&gt; &gt; at
&gt;&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.linkWalk(PBClientAdapter.java:325)
&gt;&gt; &gt; at com.basho.riak.client.query.LinkWalk.execute(LinkWalk.java:63)
&gt;&gt; &gt; at
&gt;&gt; com.chatterbox.persistence.riak.RiakTest.getAllLinks(RiakTest.java:81)
&gt;&gt; &gt; at com.chatterbox.persistence.riak.RiakTest.main(RiakTest.java:25)
&gt;&gt; &gt; ------------------------ ------------------------
&gt;&gt; ------------------------
&gt;&gt; &gt;
&gt;&gt; &gt; At line 380 on PBClientAdapter, an enhanced for loop attempts to
&gt;&gt; iterate over a Collection&gt; while the actual value is a
&gt;&gt; List. This causes the exception. The value of the variable 'step'
&gt;&gt; at the time of the exception is [userPreferences, preference3000, myPref].
&gt;&gt; &gt;
&gt;&gt; &gt; Am i doing something wrong ? The java code retrieves links in a fashion
&gt;&gt; that is similar to the HTTP retrieval, so I am puzzled by the ClassCast.
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks
&gt;&gt; &gt; Deepak
&gt;&gt; &gt;
&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

