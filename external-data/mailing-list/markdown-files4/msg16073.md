---
title: "Re: Reindexing solr after backup restore"
description: ""
project: community
lastmod: 2015-04-24T16:03:12-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16073"
mailinglist_parent_id: "msg16072"
author_name: "Jason Campbell"
project_section: "mailinglistitem"
sent_date: 2015-04-24T16:03:12-07:00
---


Is there a way to do a restore without rebuilding these indexes though? 
Obviously this could take a long time depending on the amount of indexed data 
in the cluster. It's a fairly big gotcha to say that Yokozuna fixes a lot of 
the data access issues that Riak has, but if you restore from a backup, it 
could be useless for days or weeks.

As far as disk consistency, the nodes were stopped during the snapshot, so I'm 
assuming on-disk it would be consistent within a single node. And cluster 
wide, I would expect the overall data to fall somewhere between the first and 
last node snapshot. AAE should still repair the bits left over, but it 
shouldn't have to rebuild the entire Solr index.

So the heart of the question can I join a node to a cluster without dropping 
it's Solr index? force-replace obviously doesn't work, what is the harm in 
running reip on every node instead of just the first?

Thanks for the help,
Jason

&gt; On 25 Apr 2015, at 00:36, Zeeshan Lakhani  wrote:
&gt; 
&gt; Hey Jason,
&gt; 
&gt; Here’s a little more discussion on Yokozuna backup strategies: 
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2014-January/014514.html.
&gt; 
&gt; Nonetheless, I wouldn’t say the behavior’s expected, but we’re going to be 
&gt; adding more to the docs on how to rebuild indexes.
&gt; 
&gt; To do so, you could just remove the yz\_anti\_entropy directory, and make AAE 
&gt; more aggressive, via
&gt; 
&gt; ```
&gt; rpc:multicall([node() | nodes()], application, set\_env, [yokozuna, 
&gt; anti\_entropy\_build\_limit, {100, 1000}]).
&gt; rpc:multicall([node() | nodes()], application, set\_env, [yokozuna, 
&gt; anti\_entropy\_concurrency, 4])
&gt; ```
&gt; 
&gt; and the indexes will rebuild. You can try to initialize the building of trees 
&gt; with `yz\_entropy\_mgr:init([])` via `riak attach`, but a restart would also 
&gt; kick AAE into gear. There’s a bit more related info on this thread: 
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2015-March/016929.html.
&gt; 
&gt; Thanks.
&gt; 
&gt; Zeeshan Lakhani
&gt; programmer | 
&gt; software engineer at @basho | 
&gt; org. member/founder of @papers\_we\_love | paperswelove.org
&gt; twitter =&gt; @zeeshanlakhani
&gt; 
&gt;&gt; On Apr 24, 2015, at 1:34 AM, Jason Campbell  wrote:
&gt;&gt; 
&gt;&gt; I think I figured it out.
&gt;&gt; 
&gt;&gt; I followed this guide: 
&gt;&gt; http://docs.basho.com/riak/latest/ops/running/nodes/renaming/#Clusters-from-Backups
&gt;&gt; 
&gt;&gt; The first Riak node (changed with riak-admin reip) kept it's Solr index. 
&gt;&gt; However, the other nodes when joined via riak-admin cluster force-replace, 
&gt;&gt; dropped their Solr indexes.
&gt;&gt; 
&gt;&gt; Is this expected? If so, it should really be in the docs, and there should 
&gt;&gt; be another way to restore a cluster keeping Solr intact.
&gt;&gt; 
&gt;&gt; Also, is there a way to rebuild a Solr index?
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; Jason
&gt;&gt; 
&gt;&gt;&gt; On 24 Apr 2015, at 15:16, Jason Campbell  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; I've just done a backup and restore of our production Riak cluster, and 
&gt;&gt;&gt; Yokozuna has dropped from around 125 million records to 25million. 
&gt;&gt;&gt; Obviously the IPs have changed, and although the Riak cluster is stable, 
&gt;&gt;&gt; I'm not sure Solr handled the transition as nicely.
&gt;&gt;&gt; 
&gt;&gt;&gt; Is there a way to force Solr to rebuild the indexes, or at least get back 
&gt;&gt;&gt; to the state it was in before the backup?
&gt;&gt;&gt; 
&gt;&gt;&gt; Also, is this expected behaviour?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Jason
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

