---
title: "Re: Why is the data lost in luwak"
description: ""
project: community
lastmod: 2011-12-08T22:43:38-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05902"
mailinglist_parent_id: "msg05901"
author_name: "Kelly McLaughlin"
project_section: "mailinglistitem"
sent_date: 2011-12-08T22:43:38-08:00
---


Fisher,

Yes you will get poorer performance using the synchronous api, but the tradeoff 
is you can detect failures as they happen. Alternatively you could use the 
asynchronous api and verify the file size matches what it should be at the end 
and if not reload the file. The best choice depends on the size of files you're 
dealing with, the reliability of the network, and the needs of your 
application. However, if I understand correctly, your concern about more open 
files with the synchronous api is not warranted. You're not actually opening 
more files when you use the synchronous api versus the asynchronous api, you're 
just creating more erlang references to the luwak file objects. Hopefully I 
interpreted your concern correctly and that helps shed some light on it. Cheers.

Kelly

On Dec 8, 2011, at 11:21 PM, vuleetu wrote:

&gt; Hi, Kelly
&gt; 
&gt; Is there any efficiency problem if i use synchronous api, i.e.
&gt; 
&gt; luwak\_io:put\_range(Riak::riak(), File::luwak\_file(), Start::int(),
&gt; Data::binary()) -&gt; {ok, WrittenBlocks, NewFile}
&gt; 
&gt; Because in general the stream way is better for the continuous
&gt; write operation, it reduce the amount of open file operation.
&gt; 
&gt; 
&gt; Thanks
&gt; Fisher
&gt; 
&gt; On Fri, Dec 9, 2011 at 2:13 PM, Kelly McLaughlin  wrote:
&gt;&gt; Fisher,
&gt;&gt; 
&gt;&gt; Currently you're using the asynchronous api so you won't be able to 
&gt;&gt; determine if the send calls actually succeed or not. The synchronous api is 
&gt;&gt; probably going to be what you want to use. There are some examples in the 
&gt;&gt; luwak readme file that should help you get started with it.
&gt;&gt; 
&gt;&gt; Kelly
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Dec 8, 2011, at 9:57 PM, vuleetu wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi, Kelly
&gt;&gt;&gt; 
&gt;&gt;&gt; Actually, i did it as you said yesterday. it still return the
&gt;&gt;&gt; unexpected size. If i remove flush() call, it will work. So right now
&gt;&gt;&gt; this is a big problem now. the problem is the portion data of file is
&gt;&gt;&gt; lost. I does not happen every time.
&gt;&gt;&gt; 
&gt;&gt;&gt; Is there any way to let me know if the write to riak via luwak is
&gt;&gt;&gt; success or not? because the connection to RiakNode might be down
&gt;&gt;&gt; during the write operation using luwak\_put\_stream:send().
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; RiakNode = 'riak@127.0.0.1'.
&gt;&gt;&gt; {ok, Riak} = riak:client\_connect(RiakNode).
&gt;&gt;&gt; 
&gt;&gt;&gt; luwak\_put\_stream:send()
&gt;&gt;&gt; 
&gt;&gt;&gt; %% assume node is down at this point
&gt;&gt;&gt; 
&gt;&gt;&gt; %% continue write
&gt;&gt;&gt; luwak\_put\_stream:send()
&gt;&gt;&gt; luwak\_put\_stream:send()
&gt;&gt;&gt; 
&gt;&gt;&gt; luwak\_put\_stream:close().
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; I don't know if the write is successful or not, so it may cause the
&gt;&gt;&gt; data lost sometime, is that right?
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks
&gt;&gt;&gt; Fisher
&gt;&gt;&gt; 
&gt;&gt;&gt; On Fri, Dec 9, 2011 at 12:51 AM, Kelly McLaughlin  wrote:
&gt;&gt;&gt;&gt; Fisher,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Yeah don't use flush. Make the calls to send to put the data and then call 
&gt;&gt;&gt;&gt; close and you should get the expected behavior.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Dec 7, 2011, at 11:13 PM, vuleetu wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Thu, Dec 8, 2011 at 1:57 PM, Kelly McLaughlin  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Fisher,
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; You need to call luwak\_put\_stream:close(Ps) to force the flush. That 
&gt;&gt;&gt;&gt;&gt;&gt; should
&gt;&gt;&gt;&gt;&gt;&gt; get it for you. Cheers.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi, Kelly
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; RiakNode = 'riak@127.0.0.1'.
&gt;&gt;&gt;&gt;&gt; {ok, Riak} = riak:client\_connect(RiakNode).
&gt;&gt;&gt;&gt;&gt; {ok, RiakFile} = luwak\_file:create(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;, 
&gt;&gt;&gt;&gt;&gt; dict:new()).
&gt;&gt;&gt;&gt;&gt; Ps = luwak\_put\_stream:start(Riak, RiakFile, 0, 1000000).
&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:send(Ps, &lt;&lt;"1234"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:flush(Ps).
&gt;&gt;&gt;&gt;&gt; {ok, RiakFile2} = luwak\_file:get(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; luwak\_file:length(Riak, RiakFile2). %% Length is 4
&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:send(Ps, &lt;&lt;"56789"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:close(Ps).
&gt;&gt;&gt;&gt;&gt; {ok, RiakFile3} = luwak\_file:get(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; luwak\_file:length(Riak, RiakFile3). %% Length still 13
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; After i call close(), I still get the unexpected size(13bytes), is
&gt;&gt;&gt;&gt;&gt; this the expected behavior? Can I not call flush() manually on a
&gt;&gt;&gt;&gt;&gt; stream?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; this is the version info:
&gt;&gt;&gt;&gt;&gt; luwak-1.1.0
&gt;&gt;&gt;&gt;&gt; riak\_core-1.0.0 riak\_kv-1.0.0 riak\_pipe-1.0.0
&gt;&gt;&gt;&gt;&gt; riak\_search-1.0.0 riak\_sysmon-1.0.0 riakc-1.2.0
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Fisher
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Dec 7, 2011, at 10:05 PM, vuleetu wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:send(Ps, &lt;&lt;"56789"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;&gt; luwak\_put\_stream:flush(Ps).
&gt;&gt;&gt;&gt;&gt;&gt; {ok, RiakFile3} = luwak\_file:get(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;&gt; luwak\_file:length(Riak, RiakFile3).
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt; 
&gt;&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

