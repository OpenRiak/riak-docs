---
title: "Re: Map Reduce and long queries -"
description: ""
project: community
lastmod: 2012-10-15T08:35:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08918"
mailinglist_parent_id: "msg08916"
author_name: "Olav Frengstad"
project_section: "mailinglistitem"
sent_date: 2012-10-15T08:35:42-07:00
---


I use ``make\_local\_fun`` to send the fun's across the cluster:
https://gist.github.com/510070

In my opinion you should be able to send Erlang string fun's, and use
erl\_eval to parse them. Unfortunately this is also allows for
execution of any erlang code so security wise people might not want
it, maybe there is a way to create a sandbox or only expose certain
modules?

Olav

2012/10/15, Bryan Fink :
&gt; On Mon, Oct 15, 2012 at 4:13 AM, Olav Frengstad  wrote:
&gt;&gt; Just as a note, using the Erlang pb client you can use the key filters
&gt;&gt; for 2i queries if you include the riak\_kv\_mapred\_filters module in
&gt;&gt; your client code path.
&gt; â€¦
&gt;&gt; 2&gt; Index = {index, &lt;&lt;"test"&gt;&gt;, &lt;&lt;"$key"&gt;&gt;, &lt;&lt;0&gt;&gt;, &lt;&lt;255&gt;&gt;},
&gt;&gt; 2&gt; {ok, Filter} =
&gt;&gt; riak\_kv\_mapred\_filters:build\_filter([[&lt;&lt;"ends\_with"&gt;&gt;,"1"]]),
&gt;&gt; 2&gt; MR = [
&gt;&gt; 2&gt; { reduce
&gt;&gt; 2&gt; , {qfun, fun(X, F) -&gt; lists:filter(fun({A, B}) -&gt; F(B) end, X) end}
&gt;&gt; 2&gt; , riak\_kv\_mapred\_filters:compose(Filter)
&gt;&gt; 2&gt; , true}],
&gt;&gt; 2&gt; riakc\_pb\_socket:mapred(Pid, Index, MR).
&gt;
&gt; It's a bit unfortunate that qfun is so useful, because it's also so
&gt; fragile. If your client node is not using exactly the same module
&gt; version as every node in your Riak cluster, this will fail with
&gt; undefined function errors. Absolutely, go ahead and use qfun to learn
&gt; with, but keep an eye out for that kind of surprise. Avoid qfun in
&gt; production if you can, or your upgrade process will become more
&gt; complex and/or prone to failure.
&gt;
&gt; Yes,
&gt; http://docs.basho.com/riak/latest/references/appendices/MapReduce-Implementation/
&gt; should be improved to give this warning as well. I've added an issue
&gt; to our new docs repo to track this improvement:
&gt; https://github.com/basho/basho\_docs/issues/13
&gt;
&gt; -Bryan
&gt;


-- 
Med Vennlig Hilsen
Olav Frengstad

Systemutvikler // FWT
+47 920 42 090

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

