---
title: "Re: very slow write speed to riak-cs"
description: ""
project: community
lastmod: 2014-04-03T07:20:12-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13984"
mailinglist_parent_id: "msg13967"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2014-04-03T07:20:12-07:00
---


Hi Stanislav,

Could you configure your clients to connect directly to Riak CS instead of
through your proxy? A colleague of mine suggested that the
{error,closed}and 104 error code in s3cmd appear to be caused by the
connection between
the client and Riak CS being closed or terminated unexpectedly.

I would still recommend keeping {pb\_backlog, 256} as that will allow for
more simultaneous connections to be handled going forward.

--
Luke Bakken
CSE
lbak...@basho.com


On Tue, Apr 1, 2014 at 9:32 PM, Stanislav Vlasov wrote:

&gt; Hello!
&gt;
&gt; I have 8x cluster of riak+riak-cs on debian. Config templates attached
&gt; Versions:
&gt; ii riak 1.4.8-1
&gt; amd64 Riak is a distributed data store
&gt; ii riak-cs 1.4.5-1
&gt; amd64 Riak CS
&gt;
&gt; Every riak-cs connect to local node. Between clients and riak-cs exist
&gt; frontend (Tengine version: Tengine/1.5.1 (nginx/1.2.9)), config
&gt; attached
&gt; Clients - s3cmd + some numbers of php (read-only)
&gt;
&gt; When 1-3 clients wants write to riak-cs, write speed is near 3-4MB/sec.
&gt; If 30-40 clients wants write, write speed slow down to lower than
&gt; 100kB/sec.
&gt;
&gt; In riak-cs crash.log:
&gt;
&gt; 2014-04-02 03:52:11 =ERROR REPORT====
&gt; webmachine error:
&gt; path="/buckets/test/objects/win.img/uploads/PuqEyz0BRCCk6rDxtH7tRQ=="
&gt;
&gt; {error,{error,{badmatch,{error,closed}},[{webmachine\_request,recv\_unchunked\_body,3,[{file,"src/webmachine\_request.erl"},{line,474}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,193}]},{wrq,stream\_req\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\_cs\_wm\_object\_upload\_part,accept\_body,2,[{file,"src/riak\_cs\_wm\_object\_upload\_part.erl"},{line,235}]},{riak\_cs\_wm\_common,accept\_body,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,337}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,[{file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]}}
&gt;
&gt; [{webmachine\_request,recv\_unchunked\_body,3,[{file,"src/webmachine\_request.erl"},{line,474}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,193}]},{wrq,stream\_req\_body,2,[{file,"src/wrq.erl"},{line,121}]},{riak\_cs\_wm\_object\_upload\_part,accept\_body,2,[{file,"src/riak\_cs\_wm\_object\_upload\_part.erl"},{line,235}]},{riak\_cs\_wm\_common,accept\_body,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,337}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,[{file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]
&gt;
&gt; After this event s3cmd makes throttling to slower speed:
&gt;
&gt; $ s3cmd put win.img s3://test/
&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt; 184320 of 15728640 1% in 0s 2.16 MB/s failed
&gt; WARNING: Upload failed:
&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt; Connection reset by peer)
&gt; WARNING: Retrying on lower speed (throttle=0.00)
&gt; WARNING: Waiting 3 sec...
&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt; 13799424 of 15728640 87% in 2s 5.18 MB/s failed
&gt; WARNING: Upload failed:
&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt; Connection reset by peer)
&gt; WARNING: Retrying on lower speed (throttle=0.01)
&gt; WARNING: Waiting 6 sec...
&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt; 167936 of 15728640 1% in 0s 249.46 kB/s failed
&gt; WARNING: Upload failed:
&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt; Connection reset by peer)
&gt; WARNING: Retrying on lower speed (throttle=0.05)
&gt; WARNING: Waiting 9 sec...
&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt; 6225920 of 15728640 39% in 76s 79.51 kB/s failed
&gt; WARNING: Upload failed:
&gt; /win.img?partNumber=1&uploadId=PuqEyz0BRCCk6rDxtH7tRQ== ([Errno 104]
&gt; Connection reset by peer)
&gt; WARNING: Retrying on lower speed (throttle=0.25)
&gt; WARNING: Waiting 12 sec...
&gt; win.img -&gt; s3://test/win.img [part 1 of 1366, 15MB]
&gt; 15728640 of 15728640 100% in 962s 15.96 kB/s done
&gt;
&gt; I think, even on 1Gbit network betwen nodes, write speed should be
&gt; higher, but i don't understand where the bottleneck.
&gt;
&gt; --
&gt; Stanislav
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

