---
title: "Re: Ensembles failing to reach \"Leader ready\" state"
description: ""
project: community
lastmod: 2015-04-21T06:37:20-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16049"
mailinglist_parent_id: "msg16038"
author_name: "Andrew Stone"
project_section: "mailinglistitem"
sent_date: 2015-04-21T06:37:20-07:00
---


A couple things stand out here. If a node is left in leaving state, it's
likely that the system can't get quorum for the ensembles it's a part of.
Node's that leave wait until their peer membership is transferred via joint
consensus and they are removed from the ensembles in question so that
future operations don't stall. It's possible that the other removed nodes
never completed this membership transition which is why the ensemble states
are stuck. I don't know why the don't show up in riak-admin member-status
also though. Unfortunately, I'm not sure I have a better suggestion for you
than to migrate your data right now. It's possible there is some trickery
we could do to fix the ensembles manually, but I don't have a specific
recipe for that.

Also, just to reiterate what Alexander said, we don't explicitly test
running a Riak cluster across data centers and don't support it. Riak
clustering relies on distributed erlang which has problems when used in a
WAN scenario. We offer multi-datacenter replication (MDC) to deal with
cross datacenter replication in Riak EE.

-Andrew

On Fri, Apr 17, 2015 at 11:40 PM, Jonathan Koff 
wrote:

&gt; Hi Alexander and Andrew,
&gt;
&gt; Thanks for the follow-up!
&gt;
&gt; Although I would expect to have used `riak-admin cluster leave`, it’s been
&gt; months at this point and I can’t be sure. Perhaps I did something weird
&gt; when I was getting started…
&gt;
&gt; Given the uncertain state of the system, it may make sense for me to
&gt; migrate everything to a fresh cluster, unless a simple solution exists.
&gt; It’s small enough that this would be practical, albeit inconvenient.
&gt;
&gt; Your timing in following up is interesting—I just today attempted to
&gt; `riak-admin cluster leave` a node (104.131.130.237) and it’s still in state
&gt; “leaving" with 0.0% of ring and the logs filling up with messages like:
&gt; 2015-04-18 02:45:30.927 [warning]
&gt; &lt;0.9069.0&gt;@riak\_kv\_ensemble\_backend:handle\_down:173 Vnode for Idx:
&gt; 548063113999088594326381812268606132370974703616 crashed with reason:
&gt; normal.
&gt;
&gt; Output of `riak-admin member-status`:
&gt; ================================= Membership
&gt; ==================================
&gt; Status Ring Pending Node
&gt;
&gt; -------------------------------------------------------------------------------
&gt; leaving 0.0% -- 'riak@104.131.130.237'
&gt; valid 34.4% -- 'riak@104.131.39.61'
&gt; valid 32.8% -- 'riak@104.236.79.78'
&gt; valid 32.8% -- 'riak@162.243.5.87'
&gt;
&gt; -------------------------------------------------------------------------------
&gt; Valid:3 / Leaving:1 / Exiting:0 / Joining:0 / Down:0
&gt;
&gt; Output of `ring-admin ring-status`:
&gt; ================================== Claimant
&gt; ===================================
&gt; Claimant: 'riak@104.131.130.237'
&gt; Status: up
&gt; Ring Ready: true
&gt;
&gt; ============================== Ownership Handoff
&gt; ==============================
&gt; No pending changes.
&gt;
&gt; ============================== Unreachable Nodes
&gt; ==============================
&gt; All nodes are up and reachable
&gt;
&gt;
&gt;
&gt; With regard to staging being spread out across NA, my thinking was that
&gt; staging under extreme conditions would serve as a canary as well as help me
&gt; familiarize myself with the performance characteristics of Riak. However it
&gt; ended up working perfectly (including strong consistency), so I never ended
&gt; up moving the servers to be in the same geographical area.
&gt;
&gt; I'd be reluctant to put everything in one LAN when the key requirement
&gt; that lead us to pick Riak was high availability, and network issues at a
&gt; single datacenter seems to be our most frequent mode of failure. I
&gt; benchmarked under various network configurations and all seemed to work
&gt; flawlessly and with acceptable performance. Do you think this is reasonable?
&gt;
&gt;
&gt; Thanks again!
&gt;
&gt; \*Jonathan Koff\* B.CS.
&gt; co-founder of Projexity
&gt; www.projexity.com
&gt;
&gt; follow us on facebook at: www.facebook.com/projexity
&gt; follow us on twitter at: twitter.com/projexity
&gt;
&gt; On Apr 17, 2015, at 7:49 PM, Alexander Sicular  wrote:
&gt;
&gt; Hi Jonathan,
&gt;
&gt; "staging (3 servers across NA)"
&gt;
&gt; If this means you're spreading your cluster across North America I would
&gt; suggest you reconsider. A Riak cluster is meant to be deployed in one data
&gt; center, more specifically in one LAN. Connecting Riak nodes over a WAN
&gt; introduces network latencies. Riak's approach to multi datacenter
&gt; replication is as a cluster of clusters. That said, I don't believe strong
&gt; consistency is supported yet in an mdc environment.
&gt;
&gt; -Alexander
&gt;
&gt; @siculars
&gt; http://siculars.posthaven.com
&gt;
&gt; Sent from my iRotaryPhone
&gt;
&gt; On Apr 17, 2015, at 16:19, Andrew Stone  wrote:
&gt;
&gt; Hi Jonathan,
&gt;
&gt; Sorry for the late reply. It looks like riak\_ensemble still thinks that
&gt; those old nodes are part of the cluster. Did you remove them with
&gt; 'riak-admin cluster leave' ? If so they should have been removed from the
&gt; root ensemble also, and the machines shouldn't have actually left the
&gt; cluster until all the ensembles were reconfigured via joint consensus. Can
&gt; you paste the results from the following commands:
&gt;
&gt; riak-admin member-status
&gt; riak-admin ring-status
&gt;
&gt; Thanks,
&gt; Andrew
&gt;
&gt;
&gt; On Mon, Mar 23, 2015 at 11:25 AM, Jonathan Koff 
&gt; wrote:
&gt;
&gt;&gt; Hi all,
&gt;&gt;
&gt;&gt; I recently used Riak’s Strong Consistency functionality to get
&gt;&gt; auto-incrementing IDs for a feature of an application I’m working on, and
&gt;&gt; although this worked great in dev (5 nodes in 1 VM) and staging (3 servers
&gt;&gt; across NA) environments, I’ve run into some odd behaviour in production
&gt;&gt; (originally 3 servers, now 4) that prevents it from working.
&gt;&gt;
&gt;&gt; I initially noticed that consistent requests were immediately failing as
&gt;&gt; timeouts, and upon checking `riak-admin ensemble-status` saw that many
&gt;&gt; ensembles were at 0 / 3, from the vantage point of the box I was SSH’d
&gt;&gt; into. Interestingly, SSH-ing into different boxes showed different results.
&gt;&gt; Here’s a brief snippet of what I see now, after adding a fourth server in a
&gt;&gt; troubleshooting attempt:
&gt;&gt;
&gt;&gt; \*Machine 1\* (104.131.39.61)
&gt;&gt;
&gt;&gt; ============================== Consensus System
&gt;&gt; ===============================
&gt;&gt; Enabled: true
&gt;&gt; Active: true
&gt;&gt; Ring Ready: true
&gt;&gt; Validation: strong (trusted majority required)
&gt;&gt; Metadata: best-effort replication (asynchronous)
&gt;&gt;
&gt;&gt; ================================== Ensembles
&gt;&gt; ==================================
&gt;&gt; Ensemble Quorum Nodes Leader
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; root 0 / 6 3 / 6 --
&gt;&gt; 2 0 / 3 3 / 3 --
&gt;&gt; 3 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 4 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 5 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 6 0 / 3 3 / 3 --
&gt;&gt; 7 0 / 3 3 / 3 --
&gt;&gt; 8 0 / 3 3 / 3 --
&gt;&gt; 9 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 10 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 11 0 / 3 3 / 3 --
&gt;&gt;
&gt;&gt; \*Machine 2\* (104.236.79.78)
&gt;&gt;
&gt;&gt; ============================== Consensus System
&gt;&gt; ===============================
&gt;&gt; Enabled: true
&gt;&gt; Active: true
&gt;&gt; Ring Ready: true
&gt;&gt; Validation: strong (trusted majority required)
&gt;&gt; Metadata: best-effort replication (asynchronous)
&gt;&gt;
&gt;&gt; ================================== Ensembles
&gt;&gt; ==================================
&gt;&gt; Ensemble Quorum Nodes Leader
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; root 0 / 6 3 / 6 --
&gt;&gt; 2 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt; 3 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 4 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 5 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 6 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt; 7 0 / 3 3 / 3 --
&gt;&gt; 8 0 / 3 3 / 3 --
&gt;&gt; 9 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 10 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 11 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt;
&gt;&gt; \*Machine 3\* (104.131.130.237)
&gt;&gt;
&gt;&gt; ============================== Consensus System
&gt;&gt; ===============================
&gt;&gt; Enabled: true
&gt;&gt; Active: true
&gt;&gt; Ring Ready: true
&gt;&gt; Validation: strong (trusted majority required)
&gt;&gt; Metadata: best-effort replication (asynchronous)
&gt;&gt;
&gt;&gt; ================================== Ensembles
&gt;&gt; ==================================
&gt;&gt; Ensemble Quorum Nodes Leader
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; root 0 / 6 3 / 6 --
&gt;&gt; 2 0 / 3 3 / 3 --
&gt;&gt; 3 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 4 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 5 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 6 0 / 3 3 / 3 --
&gt;&gt; 7 0 / 3 3 / 3 --
&gt;&gt; 8 0 / 3 3 / 3 --
&gt;&gt; 9 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 10 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 11 0 / 3 3 / 3 --
&gt;&gt;
&gt;&gt; \*Machine 4\* (162.243.5.87)
&gt;&gt;
&gt;&gt; ============================== Consensus System
&gt;&gt; ===============================
&gt;&gt; Enabled: true
&gt;&gt; Active: true
&gt;&gt; Ring Ready: true
&gt;&gt; Validation: strong (trusted majority required)
&gt;&gt; Metadata: best-effort replication (asynchronous)
&gt;&gt;
&gt;&gt; ================================== Ensembles
&gt;&gt; ==================================
&gt;&gt; Ensemble Quorum Nodes Leader
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; root 0 / 6 3 / 6 --
&gt;&gt; 2 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt; 3 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 4 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 5 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 6 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt; 7 3 / 3 3 / 3 riak@162.243.5.87
&gt;&gt; 8 3 / 3 3 / 3 riak@162.243.5.87
&gt;&gt; 9 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 10 3 / 3 3 / 3 riak@104.131.130.237
&gt;&gt; 11 3 / 3 3 / 3 riak@104.236.79.78
&gt;&gt;
&gt;&gt;
&gt;&gt; Interestingly, Machine 4 has full quora for all ensembles except for
&gt;&gt; root, while Machine 3 only sees itself as a leader.
&gt;&gt;
&gt;&gt; Another interesting point is the output of `riak-admin ensemble-status
&gt;&gt; root`:
&gt;&gt;
&gt;&gt; ================================= Ensemble #1
&gt;&gt; =================================
&gt;&gt; Id: root
&gt;&gt; Leader: --
&gt;&gt; Leader ready: false
&gt;&gt;
&gt;&gt; ==================================== Peers
&gt;&gt; ====================================
&gt;&gt; Peer Status Trusted Epoch Node
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; 1 (offline) -- -- riak@104.131.45.32
&gt;&gt; 2 probe no 8 riak@104.131.130.237
&gt;&gt; 3 (offline) -- -- riak@104.131.141.237
&gt;&gt; 4 (offline) -- -- riak@104.131.199.79
&gt;&gt; 5 probe no 8 riak@104.236.79.78
&gt;&gt; 6 probe no 8 riak@162.243.5.87
&gt;&gt;
&gt;&gt; This is consistent across all 4 machines, and seems to include some old
&gt;&gt; IPs from machines that left the cluster quite a while back, almost
&gt;&gt; definitely before I’d used Riak's Strong Consistency. Note that the reason
&gt;&gt; I added the fourth machine (104.131.39.61) was to see if this output would
&gt;&gt; change, perhaps resulting in a quorum for the root ensemble.
&gt;&gt;
&gt;&gt; For reference, here’s the status of a sample ensemble that isn’t “Leader
&gt;&gt; ready”, from the perspective of Machine 2:
&gt;&gt; ================================ Ensemble #62
&gt;&gt; =================================
&gt;&gt; Id: {kv,1370157784997721485815954530671515330927436759040,3}
&gt;&gt; Leader: --
&gt;&gt; Leader ready: false
&gt;&gt;
&gt;&gt; ==================================== Peers
&gt;&gt; ====================================
&gt;&gt; Peer Status Trusted Epoch Node
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; 1 following yes 43 riak@104.131.130.237
&gt;&gt; 2 following yes 43 riak@104.236.79.78
&gt;&gt; 3 leading yes 43 riak@162.243.5.87
&gt;&gt;
&gt;&gt;
&gt;&gt; My config consists of riak.conf with:
&gt;&gt;
&gt;&gt; strong\_consistency = on
&gt;&gt;
&gt;&gt; and advanced.config with:
&gt;&gt;
&gt;&gt; [
&gt;&gt; {riak\_core,
&gt;&gt; [
&gt;&gt; {target\_n\_val, 5}
&gt;&gt; ]},
&gt;&gt; {riak\_ensemble,
&gt;&gt; [
&gt;&gt; {ensemble\_tick, 5000}
&gt;&gt; ]}
&gt;&gt; ].
&gt;&gt;
&gt;&gt; though I’ve experimented with the latter in an attempt to get this
&gt;&gt; resolved.
&gt;&gt;
&gt;&gt; I didn’t see any relevant-looking log output on any of the servers.
&gt;&gt;
&gt;&gt; Has anyone come across this before?
&gt;&gt;
&gt;&gt; Thanks!
&gt;&gt;
&gt;&gt; \*Jonathan Koff\* B.CS.
&gt;&gt; co-founder of Projexity
&gt;&gt; www.projexity.com
&gt;&gt;
&gt;&gt; follow us on facebook at: www.facebook.com/projexity
&gt;&gt; follow us on twitter at: twitter.com/projexity
&gt;&gt;
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

