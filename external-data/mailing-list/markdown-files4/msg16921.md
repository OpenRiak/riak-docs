---
title: "Re: High CPU on a single node in production"
description: ""
project: community
lastmod: 2016-01-06T06:41:38-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16921"
mailinglist_parent_id: "msg16920"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-01-06T06:41:38-08:00
---


Hi Josh,

1024 is too large of a ring size for 10 nodes. If it's possible to
rebuild your cluster using a ring size of 128 or 256 that would be
ideal 
(http://docs.basho.com/riak/latest/ops/building/planning/cluster/#Ring-Size-Number-of-Partitions).
Ring resizing is possible as well
(http://docs.basho.com/riak/latest/ops/advanced/ring-resizing/).

Have all of our recommended performance tunings been applied to every
node in this cluster?
(http://docs.basho.com/riak/latest/ops/tuning/linux/) - these can have
a dramatic effect on cluster performance.

--
Luke Bakken
Engineer
lbak...@basho.com

On Tue, Jan 5, 2016 at 10:52 AM, Josh Yudaken  wrote:
&gt; Hi,
&gt;
&gt; We're attempting to use Riak as our primary key-value and search
&gt; database for an analytics-typed solution to blocking spam/fraud.
&gt;
&gt; As we expect to eventually be handling a huge amount of data, I
&gt; started with a ring size of 1024. We currently have 10 nodes on Google
&gt; Cloud n1-standard-16 instances [ 16 cores, 60gb RAM, 720gb local ssd.
&gt; ]. Disks are at about 60% usage [ roughly 175gb leveldb, 16gb yz, 45gb
&gt; anti\_entropy, 6gb yz\_anti\_entropy ], and request wise we're at about
&gt; 20k/min get, 4k/min set. Load average is usually around 6.
&gt;
&gt; I'm assuming most of the issues we're seeing are Yokozuna related, but
&gt; we're seeing a ton of tcp timeouts during handoffs, very slow get/set
&gt; queries, and a slew of other errors.
&gt;
&gt; Right now I'm trying to debug an issue where one of the 10 nodes
&gt; pegged all the cpu cores. Mostly with the `bean` process.
&gt;
&gt; # riak-admin top
&gt; Output server crashed: connection\_lost
&gt;
&gt; With few other options (as it was causing slow queries across the
&gt; cluster) I stopped the server and saw hundreds of the following
&gt; (interesting) messages in the log::
&gt;
&gt; 2016-01-05 18:28:28.573 [info]
&gt; &lt;0.4958.0&gt;@yz\_index\_hashtree:close\_trees:557 Deliberately marking YZ
&gt; hashtree {1458647141945490998441568260777384029383167049728,3} for
&gt; full rebuild on next restart
&gt;
&gt; As well as a ton of (I think related?):
&gt; 2016-01-05 18:28:31.153 [error] &lt;0.5982.0&gt;@yz\_kv:index\_internal:237
&gt; failed to index object
&gt; {{&lt;&lt;"features"&gt;&gt;,&lt;&lt;"features"&gt;&gt;},&lt;&lt;"0NKqMtj3O6\_"&gt;&gt;} with error
&gt; {noproc,{gen\_server,call,[yz\_entropy\_mgr,{get\_tree,1120389438774178506630754486017853682060456099840},infinity]}}
&gt; because 
&gt; [{gen\_server,call,3,[{file,"gen\_server.erl"},{line,188}]},{yz\_kv,get\_and\_set\_tree,1,[{file,"src/yz\_kv.erl"},{line,452}]},{yz\_kv,update\_hashtree,4,[{file,"src/yz\_kv.erl"},{line,340}]},{yz\_kv,index,7,[{file,"src/yz\_kv.erl"},{line,295}]},{yz\_kv,index\_internal,5,[{file,"src/yz\_kv.erl"},{line,224}]},{riak\_kv\_vnode,actual\_put,6,[{file,"src/riak\_kv\_vnode.erl"},{line,1619}]},{riak\_kv\_vnode,perform\_put,3,[{file,"src/riak\_kv\_vnode.erl"},{line,1607}]},{riak\_kv\_vnode,do\_put,7,[{file,"src/riak\_kv\_vnode.erl"},{line,1398}]}]
&gt;
&gt; For reference the TCP timeout error looks like:
&gt;
&gt; 2016-01-01 01:09:50.522 [error]
&gt; &lt;0.8430.6&gt;@riak\_core\_handoff\_sender:start\_fold:272 hinted transfer of
&gt; riak\_kv\_vnode from 'riak@riak25-2.c.authbox-api.internal'
&gt; 185542200051774784537577176028434367729757061120 to
&gt; 'riak@riak27-2.c.authbox-api.internal'
&gt; 185542200051774784537577176028434367729757061120 failed because of TCP
&gt; recv timeout
&gt;
&gt; Any suggestions about where to look?
&gt;
&gt; Regards,
&gt; Josh

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

