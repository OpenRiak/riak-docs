---
title: "Re: crdt performance"
description: ""
project: community
lastmod: 2014-02-23T10:22:03-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13698"
mailinglist_parent_id: "msg13693"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2014-02-23T10:22:03-08:00
---


Small correction, thanks to Steve Vinoski: term\_to\_binary is reduction-counted 
and interruptible since R16, and so shouldn't cause scheduler issues anymore.

Sean Cribbs

&gt; On Feb 21, 2014, at 5:05 PM, Sean Cribbs  wrote:
&gt; 
&gt; Hi Alex,
&gt; 
&gt; We're not yet certain of all the performance characteristics of our datatypes 
&gt; to give general recommendations. In order to head some of this off at the 
&gt; pass we have added a bunch of metrics around them[1], including actor-count 
&gt; and merge time. Of course, the general recommendations about Riak object size 
&gt; still apply. Nevertheless, here are a few things we know could be impactful:
&gt; Sets and maps use the 'orddict' Erlang type/module for in-memory. Lookups, 
&gt; inserts, and modifications have known O(N) behavior. We are considering 
&gt; porting Elixir's hashdict/hashset for this purpose.
&gt; We previously had custom binary formats, but reverted sets and maps to t2b 
&gt; with compression on. The BIF is simply faster than even our best 
&gt; pattern-matching code, and the compression is good enough to counter any 
&gt; bloat t2b might introduce (we use the lowest level of compression). Still, 
&gt; using a BIF in the critical path may have an impact on scheduler balance. [2]
&gt; In order to eliminate non-actor-identifier garbage, sets and maps use a 
&gt; somewhat complicated two-way merge function. There are likely areas for 
&gt; improvement there.
&gt; Right now, the "context" payload which lets you safely remove items from sets 
&gt; and maps is essentially an encoded version of the original datatype. Russell 
&gt; is working on reducing the size of that (down to just a causal token, 
&gt; perhaps) but we are unsure whether that will make it into 2.0.
&gt; Both sets and maps have a constant overhead for the entire structure and a 
&gt; constant overhead per-entry. Although it is proportionally small, this can 
&gt; add up quickly. For example, I have this little script which adds 1000 
&gt; integers to a set as 32-bit binaries, and assumes an equal distribution of 
&gt; updates among 3 replicas. If S is the set and SB is the serialized/binary 
&gt; version, erlang:external\_size(S) == 40783 but erlang:byte\_size(SB) == 4867 
&gt; (4K and some change, really).
&gt; Hope that helps, sorry we don't have more general recommendations.
&gt; 
&gt; [1] 
&gt; https://github.com/basho/riak\_kv/blob/develop/src/riak\_kv\_stat.erl#L464-L474
&gt; [2] https://github.com/basho/riak\_dt/pull/77
&gt; 
&gt; Cheers,
&gt; 
&gt; 
&gt;&gt; On Fri, Feb 21, 2014 at 2:53 PM, Alexander Sicular  
&gt;&gt; wrote:
&gt;&gt; Hey Gang,
&gt;&gt; 
&gt;&gt; I'm pretty excited about the new CRDT support coming in the next release. 
&gt;&gt; Although counters are already out, I haven't seen much in the way of 
&gt;&gt; performance guidelines. Where counters are a fold/merge/sum type of deal 
&gt;&gt; with some kind of reasonably bounded size based on update frequency, sets 
&gt;&gt; and maps are potentially unbounded. Is there any guidance Basho can share in 
&gt;&gt; regards to at which size performance will drop off for set/maps. Every 
&gt;&gt; feature has some theoretical vs practical limit, ie. links, wondering what 
&gt;&gt; those are for the new set/map features. Obviously, ymmv.
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; 
&gt;&gt; -Alexander Sicular
&gt;&gt; 
&gt;&gt; @siculars
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

