---
title: "Re: Filtering not_found in reduce JS causes SyntaxError"
description: ""
project: community
lastmod: 2013-10-20T19:51:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12704"
mailinglist_parent_id: "msg12702"
author_name: "Matt Black"
project_section: "mailinglistitem"
sent_date: 2013-10-20T19:51:32-07:00
---


I side-stepped this error by adding this little block of code into the top
of my map phase (which we are using elsewhere in the same project):

if(v.values[0].metadata['X-Riak-Deleted'] !== undefined) {
 return [];
}

Unfortunately I now have a different problem, which I’ll detail in a
separate thread.

On 21 October 2013 12:15, Matt Black  wrote:

&gt; The plot thickens. Having run the same query a couple more times just now
&gt; - I see a different error! (No changes we made to the code).
&gt;
&gt; Exception: Error processing stream message: 
&gt; exit:{ucs,{bad\_utf8\_character\_code}}:[{xmerl\_ucs,
&gt; from\_utf8,
&gt; 1,
&gt; [{file,
&gt; 
&gt; "xmerl\_ucs.erl"},
&gt; {line,
&gt; 185}]},
&gt; 
&gt; {mochijson2,
&gt; 
&gt; json\_encode\_string,
&gt; 2,
&gt; [{file,
&gt; 
&gt; "src/mochijson2.erl"},
&gt; {line,
&gt; 186}]},
&gt; 
&gt; {mochijson2,
&gt; 
&gt; '-json\_encode\_proplist/2-fun-0-',
&gt; 3,
&gt; [{file,
&gt; 
&gt; "src/mochijson2.erl"},
&gt; {line,
&gt; 167}]},
&gt; {lists,
&gt; foldl,
&gt; 3,
&gt; [{file,
&gt; 
&gt; "lists.erl"},
&gt; {line,
&gt; 1197}]},
&gt; 
&gt; {mochijson2,
&gt; 
&gt; json\_encode\_proplist,
&gt; 2,
&gt; [{file,
&gt; 
&gt; "src/mochijson2.erl"},
&gt; {line,
&gt; 170}]},
&gt; 
&gt; {riak\_kv\_pb\_mapred,
&gt; 
&gt; process\_stream,
&gt; 3,
&gt; [{file,
&gt; 
&gt; "src/riak\_kv\_pb\_mapred.erl"},
&gt; {line,
&gt; 115}]},
&gt; 
&gt; {riak\_api\_pb\_server,
&gt; 
&gt; process\_stream,
&gt; 5,
&gt; [{file,
&gt; 
&gt; "src/riak\_api\_pb\_server.erl"},
&gt; {line,
&gt; 246}]},
&gt; 
&gt; {riak\_api\_pb\_server,
&gt; 
&gt; handle\_info,
&gt; 2,
&gt; [{file,
&gt; 
&gt; "src/riak\_api\_pb\_server.erl"},
&gt; {line,
&gt; 129}]}]
&gt;
&gt;
&gt; On 21 October 2013 11:58, Matt Black  wrote:
&gt;
&gt;&gt; BTW, this cluster is running 1.4.0 still. If 1.4.2 would fix this issue I
&gt;&gt; could update.
&gt;&gt;
&gt;&gt;
&gt;&gt; On 21 October 2013 10:42, Matt Black  wrote:
&gt;&gt;
&gt;&gt;&gt; Hey list,
&gt;&gt;&gt;
&gt;&gt;&gt; A script recently introduced to cleanup old data by deleting it has
&gt;&gt;&gt; caused one of our old reporting scripts to start failing with “not\_found”.
&gt;&gt;&gt; I’d encountered this once before - so I thought the simple introduction of
&gt;&gt;&gt; a reduce phase using Riak.filterNotFound would fix it.
&gt;&gt;&gt;
&gt;&gt;&gt; However, now I’m receiving this error - removing the one line addition
&gt;&gt;&gt; of query.reduce("Riak.filterNotFound") gives me my old “not\_found”
&gt;&gt;&gt; error straight back.
&gt;&gt;&gt;
&gt;&gt;&gt; Exception: 
&gt;&gt;&gt; {"phase":1,"error":"[{&lt;&lt;\"lineno\"&gt;&gt;,466},{&lt;&lt;\"message\"&gt;&gt;,&lt;&lt;\"SyntaxError: 
&gt;&gt;&gt; syntax 
&gt;&gt;&gt; error\"&gt;&gt;},{&lt;&lt;\"source\"&gt;&gt;,&lt;&lt;\"()\"&gt;&gt;}]","input":"{ok,{r\_object,&lt;&lt;\"carts\"&gt;&gt;,&lt;&lt;\"dd2bcd07fa8019b2d1fc1d4832c41c74\"&gt;&gt;,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;\"X-Riak-VTag\"&gt;&gt;,52,68,115,107,113,49,105,69,66,109,103,79,106,87,104,75,75,97,53,98,54,65]],[[&lt;&lt;\"index\"&gt;&gt;]],[[&lt;&lt;\"X-Riak-Deleted\"&gt;&gt;,116,114,117,101]],[[&lt;&lt;\"X-Riak-Last-Modified\"&gt;&gt;|{1381,978330,755498}]],[],[]}}},&lt;&lt;&gt;&gt;}],[{&lt;&lt;250,120,75,127,79,209,93,62&gt;&gt;,{6,63516323103}},{&lt;&lt;31,103,165,230,79,209,...&gt;&gt;,...},...],...},...}"}
&gt;&gt;&gt;
&gt;&gt;&gt; Any thoughts?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks y'all
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

