---
title: "Re: Riak vnodes not available"
description: ""
project: community
lastmod: 2013-03-05T08:18:50-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10321"
mailinglist_parent_id: "msg10318"
author_name: "Hector Castro"
project_section: "mailinglistitem"
sent_date: 2013-03-05T08:18:50-08:00
---


Hi,

You guys may want to give the following command a try:

 riak-admin wait-for-service riak\_kv

Credit to Dizzy for bringing it to my attention yesterday [0].

[0] https://twitter.com/dizzyd/status/308710172136710144

--
Hector


On Tue, Mar 5, 2013 at 7:57 AM, Shane McEwan  wrote:
&gt; On 05/03/13 11:36, Daniel Iwan wrote:
&gt;&gt;
&gt;&gt; What is the correct approach to make sure nodes are ready and Riak service
&gt;&gt; is fully up and running and can take request?
&gt;&gt; SInce our app depends on Riak we need to somehow make sure Riak is ready
&gt;&gt; before our services start.
&gt;
&gt;
&gt; G'day!
&gt;
&gt; We run 256 vnodes on 4 nodes. Our average Riak startup time in our
&gt; virtualised test environment is about 60-70 seconds although it sometimes
&gt; can take longer (I've seen over 300 seconds before I moved to faster disk!).
&gt;
&gt; I watch the Riak console.log files and wait for the "Wait complete for
&gt; service riak\_kv" message to appear on each node before starting our
&gt; application.
&gt;
&gt; I have a nightly cron job that updates our test Riak database from
&gt; production. The cron job probably does most of what your test framework is
&gt; doing: stops the application, stops Riak, rsyncs the production database
&gt; files, starts Riak, waits for Riak to settle, starts the application.
&gt;
&gt; I use 'dsh'[http://sourceforge.net/projects/dsh/] to ssh to the four Riak
&gt; nodes to start Riak. On each Riak node I have the following script:
&gt;
&gt; ################################################################
&gt; #!/bin/bash
&gt;
&gt; pattern=$1
&gt; file=$2
&gt;
&gt; if [[ -z $pattern || -z $file ]]; then
&gt; echo "Usage: $0  "
&gt; exit 1
&gt; fi
&gt;
&gt; # Wait for string and then exit
&gt; grep -q "$pattern" &lt;( exec tail -n 0 -f $file ); kill $!
&gt; #################################################################
&gt;
&gt; This script will wait for a string to appear in a file and then exit.
&gt;
&gt; I run it from my cron job like this:
&gt;
&gt; dsh -r ssh -c -m node1 -m node2 -m node3 -m node4 --
&gt; /usr/local/bin/waitforstring '"Wait complete for service riak\_kv"'
&gt; /var/log/riak/console.log
&gt;
&gt; Using the above command in your test framework allows you to wait for your
&gt; Riak nodes to start before starting your application. 'dsh' won't exit until
&gt; the commands on all four nodes have completed.
&gt;
&gt; Of course, there's a potential race condition if Riak starts faster than you
&gt; can ssh and run the "waitforstring" script. If the string you're waiting for
&gt; has already appeared in the log file before you start looking for it you'll
&gt; never see it and end up waiting forever. As always, YMMV.
&gt;
&gt; An alternative is to have a loop running "riak-admin ringready" and
&gt; "riak-admin transfers" and exit when they are both showing desired output.
&gt; However, watching the log file is a nice, low impact method that has been
&gt; working great for me.
&gt;
&gt; Hope this helps!
&gt;
&gt; Shane.
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

