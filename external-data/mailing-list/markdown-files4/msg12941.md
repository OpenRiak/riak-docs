---
title: "Re: max_files_limit and AAE"
description: ""
project: community
lastmod: 2013-11-11T12:20:00-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12941"
mailinglist_parent_id: "msg12938"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-11-11T12:20:00-08:00
---


hmm …128 partitions divide by 5 nodes is ~26 vnodes per server.AAE creates a parallel number of vnodes, so your servers have ~52 vnodes each.52 x 3,000 is 156,000 files … 156,000 &gt; 65,536 ulimit.  Sooner or later 65,536 will be too small.  But ...Now, the primary account method in 1.4.2 is memory size allocated based upon max\_open\_files.  So you have allocated 4Mbytes x 3,000 x 52 or 624,000Mbytes of RAM for leveldb.  If you truly have a 624Gbyte machine, sweet!  Otherwise, it might be time to scale back the max\_open\_files … and put AAE back to its default because it does not need a high max\_open\_files.The tricky part to leveldb configuration is that the max\_open\_files parameter is per vnode / partition, not for the entire server.  This per vnode setting has caused many to over allocate, and is mostly inconsistent with every other piece of software on a Linux server.  (And caused a couple of justified rants on this user list.)  A more sane approach is coming out in Riak 2.0.But until then, here is a spreadsheet that can help planning:

leveldb\_sizing\_1.4.xls
Description: Binary data
MatthewOn Nov 11, 2013, at 2:56 PM, Dave Brady  wrote:Hey Everyone,We have a five-node, 128 partition cluster running 1.4.2 on Debian.Is there a doc somewhere that explains how to size max\_open\_files as it applies to AAE?I have max\_open\_files for eLevelDB set to 3000, as we have about 1500 .sst files in one VNode's data directory, and the boxes have plenty of RAM.I set max\_open\_files in the AAE section to 3000, too, on whim after we had our first issue.  Still got these in the logs on a couple of nodes after running for less than one day:===============2013-11-09 11:37:12.438 [info] &lt;0.857.0&gt;@riak\_kv\_vnode:maybe\_create\_hashtrees:142 riak\_kv/125597796958124469533129165311555572001681702912: unable to start index\_hashtree: {error,{{badmatch,{error,{db\_open,"IO error: /var/lib/riak/anti\_entropy/125597796958124469533129165311555572001681702912/LOCK: Too many open files"}}},[{hashtree,new\_segment\_store,2,[{file,"src/hashtree.erl"},{line,499}]},{hashtree,new,2,[{file,"src/hashtree.erl"},{line,215}]},{riak\_kv\_index\_hashtree,do\_new\_tree,2,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,426}]},{lists,foldl,3,[{file,"lists.erl"},{line,1197}]},{riak\_kv\_index\_hashtree,init\_trees,2,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,366}]},{riak\_kv\_index\_hashtree,init,1,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,226}]},{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line,304}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}2013-11-09 11:37:12.441 [error] &lt;0.5209.2422&gt; gen\_server &lt;0.5209.2422&gt; terminated with reason: no match of right hand value {error,{db\_write,"IO error: /var/lib/riak/anti\_entropy/125597796958124469533129165311555572001681702912/011260.log: Too many open files"}} in hashtree:flush\_buffer/1 line 3022013-11-09 11:37:12.441 [error] &lt;0.5209.2422&gt; CRASH REPORT Process &lt;0.5209.2422&gt; with 1 neighbours exited with reason: no match of right hand value {error,{db\_write,"IO error: /var/lib/riak/anti\_entropy/125597796958124469533129165311555572001681702912/011260.log: Too many open files"}} in hashtree:flush\_buffer/1 line 302 in gen\_server:terminate/6 line 7472013-11-09 11:37:12.441 [error] &lt;0.19959.2426&gt; CRASH REPORT Process &lt;0.19959.2426&gt; with 0 neighbours exited with reason: no match of right hand value {error,{db\_open,"IO error: /var/lib/riak/anti\_entropy/125597796958124469533129165311555572001681702912/LOCK: Too many open files"}} in hashtree:new\_segment\_store/2 line 499 in gen\_server:init\_it/6 line 328===============Our init script has "ulimit -n 65536" in it, which I \*thought\* that would be high enough.  Maybe not?I also made the necessary tweaks to /etc/pam.d/common-session\*, so that /etc/security/limts.conf would be read, and that did not help.Much obliged for any suggestions!--Dave Brady\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_riak-users mailing listriak-users@lists.basho.comhttp://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

