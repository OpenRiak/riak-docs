---
title: "Re: Solr search performance"
description: ""
project: community
lastmod: 2016-09-19T14:02:06-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17655"
mailinglist_parent_id: "msg17654"
author_name: "Fred Dushin"
project_section: "mailinglistitem"
sent_date: 2016-09-19T14:02:06-07:00
---


All great questions, Sean.

A few things. First off, for result sets that are that large, you are probably 
going to want to use Solr cursor marks [1], which are supported in the current 
version of Solr we ship. Riak allows queries using cursor marks through the 
HTTP interface. At present, it does not support cursors using the protobuf 
API, due to some internal limitations of the server-side protobuf library, but 
we do hope to fix that in the future.

Secondly, we have found sorting with distributed queries to be far more 
performant using Solr 4.10.4. Currently released versions of Riak use Solr 
4.7, but as you can see on github [2], Solr 4.10.4 support has been merged into 
the develop-2.2 branch, and is in the pipeline for release. I can't say when 
the next version of Riak is that will ship with this version because of 
indeterminacy around bug triage, but it should not be too long.

I would start to look at using cursor marks and measure their relative 
performance in your scenario. My guess is that you should see some improvement 
there.

-Fred

[1] https://cwiki.apache.org/confluence/display/solr/Pagination+of+Results
[2] 
https://github.com/basho/yokozuna/commit/f64e19cef107d982082f5b95ed598da96fb419b0


&gt; On Sep 19, 2016, at 4:48 PM, sean mcevoy  wrote:
&gt; 
&gt; Hi All,
&gt; 
&gt; We have an index with ~548,000 entries, ~14,000 of which match one of our 
&gt; queries.
&gt; We read these in a paginated search and the first page (of 100 hits) returns 
&gt; quickly in ~70ms.
&gt; This response time seems to increase exponentially as we walk through the 
&gt; pages:
&gt; the 4th page takes ~200ms,
&gt; the 8th page takes ~1200ms
&gt; the 12th page takes ~2100ms
&gt; the 16th page takes ~6100ms
&gt; the 20th page takes ~24000ms
&gt; 
&gt; And by the time we're searching for the 22nd page it regularly times out at 
&gt; the default 60 seconds.
&gt; 
&gt; I have a good unsderstanding of riak KV internals but absolutely nothing of 
&gt; Lucene which I think is what's most relevant here. If anyone in the know can 
&gt; point me towards any relevant resource or can explain what's happening I'd be 
&gt; much obliged :-)
&gt; As I would also be if anyone with experience of using Riak/Lucene can tell me:
&gt; - Is 500K a crazy number of entries to put into one index?
&gt; - Is 14K a crazy number of entries to expect to be returned?
&gt; - Are there any methods we can use to make the search time more constant 
&gt; across the full search?
&gt; I read one blog post on inlining but it was a bit old & not very obvious how 
&gt; to implement using riakc\_pb\_socket calls.
&gt; 
&gt; And out of curiosity, do we not traverse the full range of hits for each 
&gt; page? I naively thought that because I'm sorting the returned values we'd 
&gt; have to get them all first and then sort, but the response times suggests 
&gt; otherwise. Does Lucene store the data sorted by each field just in case a 
&gt; query asks for it? Or what other magic is going on?
&gt; 
&gt; 
&gt; For the technical details, we use the "\_yz\_default" schema and all the fields 
&gt; stored are strings:
&gt; - entry\_id\_s: unique within the DB, the aim of the query is to gather a list 
&gt; of these
&gt; - type\_s: has one of 2 values
&gt; - sub\_category\_id\_s: in the query described above all 14K hits will match on 
&gt; this, in the DB of ~500K entries there are ~43K different values for this 
&gt; field, withe each category typically having 2-6 sub categories
&gt; - category\_id\_s: not matched in this query, in the DB of ~500K entries there 
&gt; are ~13K different values for this field
&gt; - status\_s: has one of 2 values, in the query described baove all hits will 
&gt; have the value "active"
&gt; - user\_id\_s: unique within the DB but not matched in this query
&gt; - first\_name\_s: almost unique within the DB, this query will sort by this 
&gt; field
&gt; - last\_name\_s: almost unique within the DB, this query will sort by this field
&gt; 
&gt; This search query looks like:
&gt; &lt;&lt;"sub\_category\_id\_s:test\_1 AND status\_s:active AND type\_s:sub\_category"&gt;&gt;
&gt; 
&gt; Our options parameter has the sort directive:
&gt; {sort, &lt;&lt;"first\_name\_s asc, last\_name\_s asc"&gt;&gt;}
&gt; 
&gt; The query was run on a 5-node cluster with n\_val of 3.
&gt; 
&gt; Thanks in advance fo rany pointers!
&gt; //Sean.
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

