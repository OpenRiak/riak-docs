---
title: "Re: memory consumption"
description: ""
project: community
lastmod: 2013-08-05T01:52:11-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11884"
mailinglist_parent_id: "msg11879"
author_name: "Alexander Ilyin"
project_section: "mailinglistitem"
sent_date: 2013-08-05T01:52:11-07:00
---


Evan,

News about per key overhead of 91 bytes are quite frustrating. When we were
choosing a key value storage per key metadata size was a crucial point for
us. We have a simple use case but a lot of data (hundreds of millions of
items) so we were looking for the ways to reduce memory consumption.
Hereand
hereis
stated a value of 40 bytes. 22 bytes in ram
calculatorseemed
like a mistake because the following example obviously uses a value
of 40.

Anyway, thanks for your response.

On 4 August 2013 04:39, Evan Vigil-McClanahan  wrote:

&gt; Some responses inline.
&gt;
&gt; On Fri, Aug 2, 2013 at 3:11 AM, Alexander Ilyin 
&gt; wrote:
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I have a few questions about Riak memory usage.
&gt; &gt; We're using Riak 1.3.1 on a 3 node cluster. According to bitcask capacity
&gt; &gt; calculator
&gt; &gt; (
&gt; http://docs.basho.com/riak/1.3.1/references/appendices/Bitcask-Capacity-Planning/
&gt; )
&gt; &gt; Riak should use about 30Gb of RAM for out data. Actually, it uses about
&gt; 45Gb
&gt; &gt; and I can't figure out why. I'm looking at %MEM column in top on each
&gt; node
&gt; &gt; for a beam.smp process.
&gt;
&gt; I've recently done some research on this and have filed bugs against
&gt; the calculator, it's a bit wrong and has been that way for a while:
&gt;
&gt; https://github.com/basho/basho\_docs/issues/467
&gt;
&gt; The numbers there look a bit closer to what you're seeing.
&gt;
&gt; The good news is that I am looking into reducing memory consumption
&gt; this development cycle and our next release should see some
&gt; improvements on that front. The bad news is that it may be a while.
&gt; If you want to watch the bitcask repo on github to see when these
&gt; changes go in, it's usually pretty easy to build a new bitcask and
&gt; replace the one that you're running.
&gt;
&gt; &gt; Disk usage is also about 1,5 times more than I have expected (270Gb
&gt; instead
&gt; &gt; of 180Gb). I rechecked that I have n\_val=2 (not 3), it seems alright. Why
&gt; &gt; this could happen?
&gt;
&gt; There is definitely some overhead on the stored values, especially
&gt; when you're using bitcask. How big are your values? Overheads, if I
&gt; recall correctly, run to a few hundred bytes, but I'll have to ask
&gt; some people to refresh my memory.
&gt;
&gt; &gt; Second question is about performance degradation when Riak uses almost
&gt; all
&gt; &gt; available memory on the node. We see that 95/99 put percentiles twice as
&gt; &gt; large for nodes which don't have much free RAM. How much free memory I
&gt; &gt; should have to keep performance high?
&gt;
&gt; I don't have a good answer for this; when I was working as a CSE we
&gt; generally urged people to start adding nodes when their most limited
&gt; resource (memory, disk, cpu, etc) was 70-80% utilized (as a grossly
&gt; oversimplified rule of thumb).
&gt;
&gt; &gt; And the last question about memory\_total metric. riak-admin status
&gt; returns
&gt; &gt; value which is less than actual memory consumption as seen in the top.
&gt; &gt; According to memory\_total description
&gt; &gt; (
&gt; http://docs.basho.com/riak/1.3.1/references/appendices/Inspecting-a-Node/)
&gt; &gt; they should be equal. Why they are not?
&gt;
&gt; Top factors in OS/libc overheads that memory\_total cannot see. I'll
&gt; check out the docs and get them amended if they're wrong.
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

