---
title: "Re: Running MapReduce when deleting record is causing	bad_utf8_character_code error"
description: ""
project: community
lastmod: 2014-10-30T03:49:14-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15100"
mailinglist_parent_id: "msg15091"
author_name: "Naveen Tamanam"
project_section: "mailinglistitem"
sent_date: 2014-10-30T03:49:14-07:00
---


HI Luke,

My problem got solved.
Joe Caswell  helped me that,

A Riak tombstone is an ordinary Riak object with a 0-length value (&lt;&lt;&gt;&gt;)
and X-Riak-Deleted set to true in the metadata. The docs (
http://docs.basho.com/riak/latest/dev/advanced/mapreduce/) suggest checking
for X-Riak-Deleted:true in the object metadata. At the start of your map
phase function, check if the object passed in is a tombstone, and return []
instead of processing it.





On Wed, Oct 29, 2014 at 11:36 PM, Luke Bakken  wrote:

&gt; Hi Naveen,
&gt;
&gt; What is your map reduce query?
&gt; --
&gt; Luke Bakken
&gt; Engineer / CSE
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Mon, Oct 20, 2014 at 11:59 AM, Naveen Tamanam
&gt;  wrote:
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; Running map-reduce when deleting the record causing the
&gt; &gt; bad\_utf8\_character\_code
&gt; &gt; error. I mean doing both things simultaneously causing the error
&gt; &gt;
&gt; &gt; Here is the traceback
&gt; &gt;
&gt; &gt; Error running MapReduce operation. Headers: {'content-length': '1312',
&gt; &gt; 'server': 'MochiWeb/1.1 WebMachine/1.10.0 (never breaks eye contact)',
&gt; &gt; 'connection': 'close', 'date': 'Mon, 20 Oct 2014 18:23:08 GMT',
&gt; &gt; 'content-type': 'text/html', 'http\_code': 500} Body:
&gt; '500
&gt; &gt; Internal Server ErrorInternal Server
&gt; Error
=======================

The
&gt; &gt; server encountered an error while processing this
&gt; &gt; request:  

```
{error,{exit,{ucs,{bad_utf8_character_code}},\n
&gt; &gt;  [{xmerl_ucs,from_utf8,1,[{file,"xmerl_ucs.erl"},{line,185}]},
&gt; &gt;  {mochijson2,json_encode_string,2,
&gt; &gt;  [{file,"src/mochijson2.erl"},{line,186}]},
&gt; &gt;    {mochijson2,\'-json_encode_proplist/2-fun-0-\',3,
&gt; &gt;  [{file,"src/mochijson2.erl"},{line,167}]},
&gt; &gt;    {lists,foldl,3,[{file,"lists.erl"},{line,1197}]},
&gt; &gt;  {mochijson2,json_encode_proplist,2,
&gt; &gt;   [{file,"src/mochijson2.erl"},{line,170}]},
&gt; &gt;  {riak_kv_wm_mapred,send_error,2,
&gt; &gt;    [{file,"src/riak_kv_wm_mapred.erl"},\n
&gt; &gt; {line,70}]},\n
&gt; {riak_kv_wm_mapred,pipe_mapred_nonchunked,3,\n
&gt; &gt; [{file,"src/riak_kv_wm_mapred.erl"},\n
&gt; &gt; {line,214}]},\n              {webmachine_resource,resource_call,3,\n
&gt; &gt; [{file,"src/webmachine_resource.erl"},\n
&gt; &gt;                 {line,186}]}]}}
```


---

mochiweb+webmachine
&gt; web
&gt; &gt; server

'
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; I have observed that, every time I do both things simultaneously casing
&gt; the
&gt; &gt; error. But later on after a while map-reduce query is working fine.
&gt; &gt; Is this mean, can't I run the map-reduce queries while deleting keys from
&gt; &gt; other client?
&gt; &gt;
&gt; &gt;
&gt; &gt; --
&gt; &gt; Thanks & Regards,
&gt; &gt; Naveen Tamanam
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;



-- 
Thanks & Regards,
Naveen Tamanam
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

