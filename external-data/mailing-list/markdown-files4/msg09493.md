---
title: "mi_server lookup/range failure for search queries (only in cluster	setup)"
description: ""
project: community
lastmod: 2012-12-10T00:29:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09493"
author_name: "Abhinav Singh"
project_section: "mailinglistitem"
sent_date: 2012-12-10T00:29:57-08:00
---


Hi,

We are facing 500 Internal Server Error for a search queries and amazingly it 
fails only in cluster mode (i.e. with more than one riak node running).

We have following single node setup to start with:
$ ./bin/riak-admin member-status
================================= Membership ==================================
Status Ring Pending Node
-------------------------------------------------------------------------------
valid 100.0% -- 'riak@172.17.3.82'
-------------------------------------------------------------------------------
Valid:1 / Leaving:0 / Exiting:0 / Joining:0 / Down:0

At this point following query works perfectly:
http://172.17.3.82:8098/solr/documents/select?wt=json&q=to:e30cff3f4a500fe5826a14019f268f1147fe6993
 AND tags:(conversation\_message) AND ts\_num:([1354872576 TO 1354872578])

We proceed to add another node to setup a cluster:
$ ./bin/riak-admin member-status
================================= Membership ==================================
Status Ring Pending Node
-------------------------------------------------------------------------------
valid 50.0% -- 'riak@172.17.3.63'
valid 50.0% -- 'riak@172.17.3.82'
-------------------------------------------------------------------------------
Valid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0

At this point the above query starts to fail with 500 error code.

We checked upon the logs and found following inside 172.17.3.63 error.log file:
2012-12-10 10:05:01.076 [error] &lt;0.3968.0&gt;@mi\_server:handle\_info:524 
lookup/range failure: 
{{badfun,#Fun},[{mi\_server,iterate,6,[{file,"src/mi\_server.erl"},{line,657}]},{mi\_server,lookup,8,[{file,"src/mi\_server.erl"},{line,632}]}]}
2012-12-10 10:05:01.082 [error] emulator Error in process &lt;0.4290.0&gt; on node 
'riak@172.17.3.63' with exit value: 
{{badfun,#Fun},[{mi\_server,iterate,6,[{file,"src/mi\_server.erl"},{line,657}]},{mi\_server,lookup,8,[{file,"src/mi\_server.erl"},{line,632}]}]}

looks like search merge index backend is failing with reason badfun. 
I tried looking around the mi\_server.erl module but could get much out of it.

Inside 172.17.3.82 error.log file we see following logs which gets propagated 
as query response:
2012-12-10 10:06:00.987 [error] &lt;0.4622.0&gt; webmachine error: 
path="/solr/documents/select"
{error,{error,{case\_clause,timeout},[{riak\_search\_client,search\_doc,8},{riak\_search\_utils,run\_query,7},{riak\_solr\_searcher\_wm,to\_json,2},{webmachine\_resource,resource\_call,3},{webmachine\_resource,do,3},{webmachine\_decision\_core,resource\_call,1},{webmachine\_decision\_core,decision,1},{webmachine\_decision\_core,handle\_request,2}]}}

Can we do something about this? Is this related to our configuration and 
environment setup?
Has someone experienced this before? I will be happy to share more info if 
required.
We are using riak-1.2.1 stable release.

Thanks in advance.
--
Abhinav Singh
http://abhinavsingh.com/

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

