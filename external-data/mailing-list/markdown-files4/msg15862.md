---
title: "Re: Query on Riak Search in a cluster of 3 nodes behind ELB is giving	different result everytime"
description: ""
project: community
lastmod: 2015-03-09T07:35:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15862"
mailinglist_parent_id: "msg15839"
author_name: "Zeeshan Lakhani"
project_section: "mailinglistitem"
sent_date: 2015-03-09T07:35:17-07:00
---


The second approach would most probably cut down on index creation time. 
However, you should definitely spend a little time testing it out and 
benchmarking accordingly. And, as I mentioned, please take a look at CPU load 
as indexes are created, as well as experiment with solrconfig and increasing 
jvm heap memory settings for your use-case.

Thanks.

Zeeshan Lakhani
programmer | 
software engineer at @basho | 
org. member/founder of @papers\_we\_love | paperswelove.org
twitter =&gt; @zeeshanlakhani

&gt; On Mar 9, 2015, at 10:13 AM, Baskar Srinivasan  wrote:
&gt; 
&gt; Hello Zeeshan,
&gt; 
&gt; We create a new set of buckets/indices when a new tenant is created in a 
&gt; multi-tenancy environment. Alternate approach for us is to use single set of 
&gt; index/buckets and filter by a tenant identifier. Before moving to the second 
&gt; approach we want to confirm if we expect to see significant delays (several 
&gt; minutes) with index propagation as the number of indices in the system grows.
&gt; 
&gt; Regards,
&gt; Baskar
&gt; 
&gt; On Mon, Mar 9, 2015 at 7:02 AM, Zeeshan Lakhani  &gt; wrote:
&gt; Hey Santi, Baskar,
&gt; 
&gt; Are you noticing increased CPU load as you create more and more indexes? 
&gt; Running `riak-admin top -interval 2` a few times may bring sometime to light.
&gt; 
&gt; I’d see how you could increase resources or think more critically on how 
&gt; you’re indexing data for Solr. Does the data share most fields? Can you reuse 
&gt; indexes for some of the data and filter certain queries?
&gt; 
&gt; You may also wanted to look at this thread, 
&gt; https://groups.google.com/forum/#!topic/nosql-databases/9ECQpVS0QjE 
&gt; , which 
&gt; discusses modeling Riak Search data and the issues you’ll have with the 
&gt; overhead with gossiping so much metadata and the what Solr can handle.
&gt; 
&gt; Zeeshan Lakhani
&gt; programmer | 
&gt; software engineer at @basho | 
&gt; org. member/founder of @papers\_we\_love | paperswelove.org 
&gt; 
&gt; twitter =&gt; @zeeshanlakhani
&gt; 
&gt;&gt; On Mar 9, 2015, at 8:25 AM, Santi Kumar &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; Hi Zeeshan,
&gt;&gt; 
&gt;&gt; We have typically seen this issue when we have lots of indexes created in 
&gt;&gt; that instance. On a t2.medium machine we already have around 512+ indexes 
&gt;&gt; created in data folder. In such case, if we trying to create any new indexes 
&gt;&gt; it's taking time. Association of Index to Bucket is failing even after the 
&gt;&gt; FetchIndex operation returning sucess as shown in the below code.
&gt;&gt; 
&gt;&gt; is there any limitation of the number of Indexes? Any thing related to 
&gt;&gt; FileSystem handlers causing this issue?
&gt;&gt; 
&gt;&gt; while(!isCreated){
&gt;&gt; 
&gt;&gt; FetchIndex fetchIndex = new FetchIndex.Builder(indexName).build();
&gt;&gt; 
&gt;&gt; 
&gt;&gt; RiakFuture&gt; String&gt; fetchIndexFuture = client.executeAsync(fetchIndex);
&gt;&gt; 
&gt;&gt; try{
&gt;&gt; 
&gt;&gt; fetchIndexFuture.await();
&gt;&gt; 
&gt;&gt; com.basho.riak.client.core.operations.YzFetchIndexOperation.Response 
&gt;&gt; response = fetchIndexFuture.get();
&gt;&gt; 
&gt;&gt; List indexes = response.getIndexes();
&gt;&gt; 
&gt;&gt; for(YokozunaIndex index:indexes){
&gt;&gt; 
&gt;&gt; if(indexName.equals(index.getName())){
&gt;&gt; 
&gt;&gt; isCreated=true;
&gt;&gt; 
&gt;&gt; logger.info("Index "+indexName+" created ");
&gt;&gt; 
&gt;&gt; continue;
&gt;&gt; 
&gt;&gt; }
&gt;&gt; 
&gt;&gt; }
&gt;&gt; 
&gt;&gt; }catch(Exception e){
&gt;&gt; 
&gt;&gt; logger.warn("Unable to get "+indexName+" Still trying");
&gt;&gt; 
&gt;&gt; isCreated=false;
&gt;&gt; 
&gt;&gt; }
&gt;&gt; 
&gt;&gt; }
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Fri, Mar 6, 2015 at 2:11 AM, Zeeshan Lakhani &gt; &gt; wrote:
&gt;&gt; Hello Baskar, Santi,
&gt;&gt; 
&gt;&gt; 2-15 minutes is a long while, and we’ve not seen index creation/propagation 
&gt;&gt; be so slow. I’d definitely take a closer look at how you’re creating these 
&gt;&gt; indexes dynamically on the fly, as index creation is typically a more 
&gt;&gt; straightforward admin task.
&gt;&gt; 
&gt;&gt; We’ve added defaults to solrconfig.xml to handle most typical use-cases. You 
&gt;&gt; can read more about solrconfig.xml at 
&gt;&gt; http://wiki.apache.org/solr/SolrConfigXml#mainIndex\_Section 
&gt;&gt; . You may want 
&gt;&gt; to take another look and optimize/improve your schema design to prevent such 
&gt;&gt; issues. You can read more about Solr’s performance factors here -&gt; 
&gt;&gt; http://wiki.apache.org/solr/SolrPerformanceFactors 
&gt;&gt; . 
&gt;&gt; 
&gt;&gt; Thanks.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Zeeshan Lakhani
&gt;&gt; programmer | 
&gt;&gt; software engineer at @basho | 
&gt;&gt; org. member/founder of @papers\_we\_love | paperswelove.org 
&gt;&gt; 
&gt;&gt; twitter =&gt; @zeeshanlakhani
&gt;&gt; 
&gt;&gt;&gt; On Mar 5, 2015, at 3:00 PM, Baskar Srinivasan &gt;&gt; &gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Hello Zeeshan,
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks for the pointer regarding waiting for index creation in each node in 
&gt;&gt;&gt; the cluster.
&gt;&gt;&gt; 
&gt;&gt;&gt; Presently, when the indices get created on one node, it takes a full 2-15 
&gt;&gt;&gt; minutes for it to get created on other nodes in the cluster. Following are 
&gt;&gt;&gt; the timestamps on 3 nodes for a single index:
&gt;&gt;&gt; 
&gt;&gt;&gt; #Create index request from our server via load balancer
&gt;&gt;&gt; 11:16:52.999 [http-bio-8080-exec-3] INFO c.v.s.u.RiakClientUtil - Created 
&gt;&gt;&gt; index for bsr-test-fromlocal-1-Access\_index
&gt;&gt;&gt; 
&gt;&gt;&gt; #1st node, immediate creation (12 secs) once call is issued from our server
&gt;&gt;&gt; 2015-03-05 19:17:04.135 [info] &lt;0.17388.104&gt;@yz\_index:local\_create:189 
&gt;&gt;&gt; Created index bsr-test-fromlocal-1-Access\_index with schema
&gt;&gt;&gt; 
&gt;&gt;&gt; #2nd node, takes another 4 minutes for creation request to propagate
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 2015-03-05 19:21:17.879 [info] &lt;0.20606.449&gt;@yz\_index:local\_create:189 
&gt;&gt;&gt; Created index bsr-test-fromlocal-1-Access\_index
&gt;&gt;&gt; 
&gt;&gt;&gt; #3rd node, takes 15 minutes for creation request to propagate
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 2015-03-05 19:32:32.172 [info] &lt;0.14715.94&gt;@yz\_index:local\_create:189 
&gt;&gt;&gt; Created index bsr-test-fromlocal-1-Access\_index
&gt;&gt;&gt; 
&gt;&gt;&gt; Is there a solr config we can tune to make the 2nd and 3rd node propagation 
&gt;&gt;&gt; more immediate in the order of &lt; 60 seconds?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; 
&gt;&gt;&gt; Baskar
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Thu, Mar 5, 2015 at 9:11 AM, Zeeshan Lakhani &gt;&gt; &gt; wrote:
&gt;&gt;&gt; Hello Santi, Baskar. Please keep your messages on the user group mailing 
&gt;&gt;&gt; list, btw. Thanks.
&gt;&gt;&gt; 
&gt;&gt;&gt; Here’s an example of our testing harness’s wait\_for\_index function, 
&gt;&gt;&gt; https://github.com/basho/yokozuna/blob/develop/riak\_test/yz\_rt.erl#L420 
&gt;&gt;&gt; . 
&gt;&gt;&gt; We check for the index on each of the nodes, which is an approach you can 
&gt;&gt;&gt; take. 
&gt;&gt;&gt; 
&gt;&gt;&gt; And, as I mentioned, I’m currently working on making Index creation 
&gt;&gt;&gt; synchronous to make this easier.
&gt;&gt;&gt; 
&gt;&gt;&gt; If your logs are not pointing to any errors and being that your bucket, 
&gt;&gt;&gt; index contains so few objects, I’d delete or mv the search-root/index 
&gt;&gt;&gt; directory (./data/yz/&lt;&gt;) and let AAE resync the data, which 
&gt;&gt;&gt; should then give you consistent results.
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks.
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

