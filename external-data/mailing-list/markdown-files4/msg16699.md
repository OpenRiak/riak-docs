---
title: "Re: Riak in Docker - Error folding keys - incomplete_hint"
description: ""
project: community
lastmod: 2015-10-22T17:14:11-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16699"
mailinglist_parent_id: "msg16698"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2015-10-22T17:14:11-07:00
---


Quick follow-up: As a bit of a hack, deleting all the .hint files prior to
each start-up does resolve the errors, and immediately results in a whole
lot of Bitcask merges happening.
But that doesn't strike me as a good long-term fix.

On Fri, 23 Oct 2015 at 10:52 Toby Corkindale  wrote:

&gt; Hi Hector,
&gt; You can see the Dockerfile here:
&gt; https://gist.github.com/TJC/cb3184705bc0eacde885
&gt;
&gt; It's a work in progress, but also, not that involved.
&gt;
&gt; Ubuntu 14.04 is used as both the docker host, and the docker container.
&gt; It's on the btrfs storage driver. (I've had too many issues with the other
&gt; two)
&gt; The Riak data directory is a volume, and is mounted to an external,
&gt; persistent location. (Which is also btrfs)
&gt;
&gt; I suspect there's an issue around Riak shutting down uncleanly when the
&gt; docker container is stopped.
&gt; I have already had to add this to the start-up each time:
&gt; find /var/lib/riak -name "bitcask.\*.lock" -delete
&gt;
&gt; So it's clear that Riak is getting killed rather than shutting down
&gt; cleanly; but even so, I'd hope that Riak would cope with that, rather than
&gt; getting into a permanent state of throwing errors.
&gt;
&gt; Toby
&gt;
&gt;
&gt; On Fri, 23 Oct 2015 at 00:01 Hector Castro  wrote:
&gt;
&gt;&gt; Can't say I've paid enough attention to the logs in my single-machine
&gt;&gt; Riak within Docker setups to confirm.
&gt;&gt;
&gt;&gt; Do you have the container image definitions somewhere public? That may
&gt;&gt; help someone reproduce the issue. Also, did you ensure that the Riak
&gt;&gt; data directory is setup as a Docker volume?
&gt;&gt;
&gt;&gt; Other things that come to mind:
&gt;&gt;
&gt;&gt; - What OS is the Docker host running?
&gt;&gt; - What storage driver are you using for Docker?
&gt;&gt; - What file system is the Docker data directory using?
&gt;&gt;
&gt;&gt; --
&gt;&gt; Hector
&gt;&gt;
&gt;&gt;
&gt;&gt; On Thu, Oct 22, 2015 at 2:27 AM, Toby Corkindale  wrote:
&gt;&gt; &gt; Anyone?
&gt;&gt; &gt;
&gt;&gt; &gt; I note that after 24 hours (on a very lightly loaded test cluster) I'm
&gt;&gt; still
&gt;&gt; &gt; seeing these scroll by a lot - 600 an hour per node.
&gt;&gt; &gt; Really curious to know if this is expected behaviour or if this is
&gt;&gt; resulting
&gt;&gt; &gt; from some kind of node corruption.
&gt;&gt; &gt;
&gt;&gt; &gt; Cheers
&gt;&gt; &gt; Toby
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; On Wed, 21 Oct 2015 at 12:23 Toby Corkindale  wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Hi,
&gt;&gt; &gt;&gt; I've been working on getting Riak to run inside Docker containers - in
&gt;&gt; a
&gt;&gt; &gt;&gt; multi-machine cluster. (Previous work I've seen has only run Riak as a
&gt;&gt; &gt;&gt; cluster all on the same machine.)
&gt;&gt; &gt;&gt; I thought I had it cracked, although I tripped up on the existing issue
&gt;&gt; &gt;&gt; with Riak and lockfiles[1]. But the nodes have been generating an
&gt;&gt; awful lot
&gt;&gt; &gt;&gt; of errors like the below, and I wondered if anyone here can give me an
&gt;&gt; &gt;&gt; explanation? (And, is it a problem?)
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; 2015-10-21 01:19:23.567 [error] &lt;0.24495.0&gt; Error folding keys for
&gt;&gt; &gt;&gt; "/var/lib/riak/bitcask.1h/2283596
&gt;&gt; &gt;&gt; 30832953580969325755111919221821239459840/2.bitcask.data":
&gt;&gt; &gt;&gt; {incomplete\_hint,4}
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; 1: Related issues to the lockfiles --
&gt;&gt; &gt;&gt; I note that many are closed, but the problem still exists, and is
&gt;&gt; &gt;&gt; particularly triggered by using Docker and stopping/killing Riak more
&gt;&gt; &gt;&gt; violently than it likes.
&gt;&gt; &gt;&gt; https://github.com/basho/bitcask/issues/163 (closed)
&gt;&gt; &gt;&gt; https://github.com/basho/riak/issues/535 (open)
&gt;&gt; &gt;&gt; https://github.com/basho/bitcask/issues/167 (closed)
&gt;&gt; &gt;&gt; https://github.com/basho/bitcask/issues/99 (closed)
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; &gt;
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

