---
title: "Re: haproxy issues with protocol buffers on 2.x releases"
description: ""
project: community
lastmod: 2015-06-04T23:17:46-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16214"
mailinglist_parent_id: "msg16211"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2015-06-04T23:17:46-07:00
---


Hi Kota,
Our production nodes are Riak CS 1.5 and Riak 1.4.x -- they're running
haproxy 1.4.x, and it's all been happy for some time now.

Testing the new nodes, still same haproxy versions, but Riak CS 2.0.1 and
Riak 1.0.5.
Very confused as to why the connections are being dropped when going
through haproxy. The problem persists even after restarting CS.
I tried staggering the restarts.. increasing the PB request pool.. etc..
 no change.

But it works fine if CS connects directly to the localhost riak pb.
(Which isn't a great idea.. big Riak instances sometimes take too long to
start, and CS falls over because it started too fast and couldn't connect,
if you're going to localhost)

Confusing! I'm wondering if it's because the testing machines are in
virtual machines, compared to production which is real hardware.
But.. normally haproxy still works fine on VMs.

I'll continue to play around.. Must be something that's botched on the
testing setup... but don't want to replicate that into production!


On Fri, 5 Jun 2015 at 13:59 Kota Uenishi  wrote:

&gt; Toby,
&gt;
&gt; As PB connection management haven't been changed between CS 1.5 and
&gt; 2.0, I think it should work. What's the version the load balancing
&gt; working stable? It depends of the reason why connection has been cut,
&gt; but I would recommend you restart just the CS node and recreate the
&gt; connection pool.
&gt;
&gt; On Thu, Jun 4, 2015 at 2:33 PM, Toby Corkindale  wrote:
&gt; &gt; Hi,
&gt; &gt; I've been happily using haproxy in front of Riak and Riak CS 1.x in
&gt; &gt; production for quite a while.
&gt; &gt;
&gt; &gt; I've been trying to bring up a new cluster based on riak/cs 2.0.x
&gt; recently,
&gt; &gt; as you've probably noticed from the flurry of emails to this list :)
&gt; &gt;
&gt; &gt; I'm discovering that if I have haproxy sitting between riak-cs and riak,
&gt; &gt; then I get a lot of errors about disconnections. Initially I thought this
&gt; &gt; must be related to pb backlogs or pool sizes or file handle limits -- but
&gt; &gt; I've played with all those things to no avail.
&gt; &gt;
&gt; &gt; I \*have\* noticed that if I get riak-cs to connect directly to a riak
&gt; &gt; (bypassing haproxy) then everything is fine, including with the original
&gt; &gt; default request pool and backlog sizes.
&gt; &gt;
&gt; &gt; I am essentially using the recommended haproxy.cfg, which has worked
&gt; fine in
&gt; &gt; production elsewhere.
&gt; &gt;
&gt; &gt; Any suggestions?
&gt; &gt; Error message sample follows:
&gt; &gt;
&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt; &gt; &lt;0.283.0&gt;@riak\_cs\_riak\_client:get\_user\_with\_pbc:293 Fetching user re
&gt; &gt; cord with strong option failed: disconnected
&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt; &gt; &lt;0.2095.0&gt;@riak\_cs\_pbc:check\_connection\_status:97 Connection status
&gt; &gt; of &lt;0.287.0&gt; at maybe\_create\_user: {false,[]}
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt; Toby
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

