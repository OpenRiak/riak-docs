---
title: "Re: This sure looks like a bug...?"
description: ""
project: community
lastmod: 2011-04-18T19:46:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03087"
mailinglist_parent_id: "msg03084"
author_name: "Ben Tilly"
project_section: "mailinglistitem"
sent_date: 2011-04-18T19:46:42-07:00
---


I'm not missing the point you think I am. Riak already has the
ability to store more than one value for a key/value pair. I'd like
an option - possibly named something new, that used this to store a
limited amount of history so that clients could be presented with a
common ancestor when that was required.

In the case that I gave you, if the common ancestor is:

 {
 "name": "Jane Doe",
 "occupation": "secretary"
 }

then a standard three-way merge would say that she got married and the
correct result should be:

 {
    "name": "Jane Blow",
    "husband": "Joe Blow",
    "occupation": "n/a"
 }

while if the common ancestor is:

 {
    "name": "Jane Blow",
    "husband": "Joe Blow",
    "occupation": "n/a"
 }

then a standard 3-way merge would say that she dumped the jerk and got
a job resulting in:

 {
 "name": "Jane Doe",
 "occupation": "secretary"
 }

Without the common ancestor you know what changed, but not which
direction the changes are going, and so have no sane way to resolve
the conflict.

Given the non-atomic nature of reads and writes in Riak, it is likely
that neither of the two clients that wrote that data was in any way
aware of the existence of the other write. This makes your suggestion
of escalating to the user impossible. And there is no particular
reason to believe that the third user to come along will necessarily
know anything either.

(Besides, I spent enough years maintaining batch systems to be wary of
escalating to users at the drop of a hat. The "user" may well be a
complete moron on autopilot.)

On Mon, Apr 18, 2011 at 7:01 PM, Sean Cribbs  wrote:
&gt; I think you're missing a key point here, and that is that the vector clock 
&gt; doesn't store copies of the \*values\*, only the individual "touches" of 
&gt; identified clients. I'm not sure what computing the common ancestor is going 
&gt; to give you if you don't have the value.  Vector clocks are essentially 
&gt; opaque to clients.
&gt;
&gt; That said, I think the use-case you gave is one that can clearly bubble up to 
&gt; the user, e.g. "Someone else changed this record while you were editing it. 
&gt; Can you resolve the differences?" (Give the other person's name perhaps, 
&gt; highlight the fields that are different.)
&gt;
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
&gt; On Apr 18, 2011, at 9:12 PM, Ben Tilly wrote:
&gt;
&gt;&gt; Riak's small\_vclock, big\_vclock, young\_vclock, and old\_vclock
&gt;&gt; parameters already give control over pruning behavior.  If there isn't
&gt;&gt; enough history to compute a common ancestor, then return nothing for
&gt;&gt; the common ancestor.
&gt;&gt;
&gt;&gt; The use case here really isn't an SCM.  The use case is when two
&gt;&gt; clients get simultaneous (within, say, 50 ms) requests to write to the
&gt;&gt; same object.  When a third one tries to read the data 5s later, it
&gt;&gt; would be nice to have a way to figure out what to do.  For this use
&gt;&gt; case you can limit the amount of history quite severely without loss.
&gt;&gt;
&gt;&gt; Let's take a practical example of conflicting data structures:
&gt;&gt;
&gt;&gt;  {
&gt;&gt;    "name": "Jane Doe",
&gt;&gt;    "occupation": "n/a"
&gt;&gt;  },
&gt;&gt;  {
&gt;&gt;    "name": "Jane Blow",
&gt;&gt;    "husband": "Joe Blow",
&gt;&gt;    "occupation": "secretary"
&gt;&gt;  }
&gt;&gt;
&gt;&gt; What should it be resolved to?  Perhaps Jane just got divorced and
&gt;&gt; went to work as a secretary.  Or she could have gotten married and
&gt;&gt; left her job.  If you give me the common ancestor I can tell which
&gt;&gt; scenario to believe.  Without it I can only guess badly.  I don't want
&gt;&gt; to keep a history here.  I want to resolve the discrepancy the next
&gt;&gt; time I see it (and log it somewhere important if I can't resolve it).
&gt;&gt;
&gt;&gt; On Mon, Apr 18, 2011 at 5:38 PM, Sean Cribbs  wrote:
&gt;&gt;&gt; Yes, but vector clocks are for resolution of race-conditions and network 
&gt;&gt;&gt; partitions, not to provide an SCM history.  Imagine how much space would be 
&gt;&gt;&gt; consumed by the history long enough to disambiguate an object that has been 
&gt;&gt;&gt; updated normally 1000 times, followed by one bad client that decides write 
&gt;&gt;&gt; to it without fetching the vector clock first.
&gt;&gt;&gt;
&gt;&gt;&gt; Coda Hale put it well in his talk at the recent Riak Meetup: your data 
&gt;&gt;&gt; needs to be logically monotonic so that writes (and reads) can be retried 
&gt;&gt;&gt; until resolution is reached.
&gt;&gt;&gt;
&gt;&gt;&gt; Also, we've found that assigning the client id to something that is 
&gt;&gt;&gt; relevant to your domain, e.g. real people, will help reduce surprises (and 
&gt;&gt;&gt; degenerate cases like sibling explosion) when it comes to vector-clock 
&gt;&gt;&gt; resolution.
&gt;&gt;&gt;
&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt;
&gt;&gt;&gt; On Apr 18, 2011, at 8:15 PM, Aphyr wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I actually had a question about that page.  Why is it that when there
&gt;&gt;&gt;&gt;&gt; is a conflict we can only get the conflicting versions of the data?
&gt;&gt;&gt;&gt;&gt; If I'm going to try to resolve the conflict intelligently, I really
&gt;&gt;&gt;&gt;&gt; want the common ancestor as well so that I can try to do a 3-way
&gt;&gt;&gt;&gt;&gt; merge.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Good call. If an ancestor were available it would make counting and 
&gt;&gt;&gt;&gt; merging orthogonal changes \*much\* simpler.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

