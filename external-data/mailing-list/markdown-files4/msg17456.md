---
title: "Re: How to cold (re)boot a cluster with already existing node data"
description: ""
project: community
lastmod: 2016-06-06T08:24:53-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17456"
mailinglist_parent_id: "msg17454"
author_name: "Alex Moore"
project_section: "mailinglistitem"
sent_date: 2016-06-06T08:24:53-07:00
---


Hi Jan,

When you update the Kubernates nodes, do you have to do them all at once or
can they be done in a rolling fashion (one after another)?

If you can do them rolling-wise, you should be able to:

For each node, one at a time:
1. Shut down Riak
2. Shutdown/restart/upgrade Kubernates
3. Start Riak
4. Use `riak-admin force-replace` to rename the old node name to the new
node name
5. Repeat on remaining nodes.

This is covered in "Renaming Multi-node clusters
"
doc.

As for your current predicament, have you created any new buckets/changed
bucket props in the default namespace since you restarted? Or have you only
done regular operations since?

Thanks,
Alex


On Mon, Jun 6, 2016 at 5:25 AM Jan-Philip Loos  wrote:

&gt; Hi,
&gt;
&gt; we are using riak in a kuberentes cluster (on GKE). Sometimes it's
&gt; necessary to reboot the complete cluster to update the kubernetes-nodes.
&gt; This results in a complete shutdown of the riak cluster and the riak-nodes
&gt; are rescheduled with a new IP. So how can I handle this situation? How can
&gt; I form a new riak cluster out of the old nodes with new names?
&gt;
&gt; The /var/lib/riak directory is persisted. I had to delete the
&gt; /var/lib/riak/ring folder otherwise "riak start" crashed with this message
&gt; (but saved the old ring state in a tar):
&gt;
&gt; {"Kernel pid
&gt;&gt; terminated",application\_controller,"{application\_start\_failure,riak\_core,{{shutdown,{failed\_to\_start\_child,riak\_core\_broadcast,{'EXIT',{function\_clause,[{orddict,fetch,['
&gt;&gt; riak@10.44.2.8
&gt;&gt; ',[]],[{file,\"orddict.erl\"},{line,72}]},{riak\_core\_broadcast,init\_peers,1,[{file,\"src/riak\_core\_broadcast.erl\"},{line,616}]},{riak\_core\_broadcast,start\_link,0,[{file,\"src/riak\_core\_broadcast.erl\"},{line,116}]},{supervisor,do\_start\_child,2,[{file,\"supervisor.erl\"},{line,310}]},{supervisor,start\_children,3,[{file,\"supervisor.erl\"},{line,293}]},{supervisor,init\_children,2,[{file,\"supervisor.erl\"},{line,259}]},{gen\_server,init\_it,6,[{file,\"gen\_server.erl\"},{line,304}]},{proc\_lib,init\_p\_do\_apply,3,[{file,\"proc\_lib.erl\"},{line,239}]}]}}}},{riak\_core\_app,start,[normal,[]]}}}"}
&gt;&gt; Crash dump was written to: /var/log/riak/erl\_crash.dump
&gt;&gt; Kernel pid terminated (application\_controller)
&gt;&gt; ({application\_start\_failure,riak\_core,{{shutdown,{failed\_to\_start\_child,riak\_core\_broadcast,{'EXIT',{function\_clause,[{orddict,fetch,['
&gt;&gt; riak@10.44.2.8',
&gt;
&gt;
&gt; The I formed a new cluster via join & plan & commit.
&gt;
&gt; But now, I discovered a problems with incomplete and inconsistent
&gt; partitions:
&gt;
&gt; \*$ \*curl -Ss "
&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt; | jq '.[] | length'
&gt;
&gt; 3064
&gt;
&gt; \*$\* curl -Ss "
&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt; | jq '.[] | length'
&gt;
&gt; 2987
&gt;
&gt; \*$\* curl -Ss "
&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt; | jq '.[] | length'
&gt;
&gt; 705
&gt;
&gt; \*$\* curl -Ss "
&gt; http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true"
&gt; | jq '.[] | length'
&gt; 3064
&gt;
&gt; Is there a way to fix this? I guess this is caused by the missing old
&gt; ring-state?
&gt;
&gt; Greetings
&gt;
&gt; Jan
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

