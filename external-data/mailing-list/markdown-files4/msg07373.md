---
title: "Re: Reip(ing) riak node created two copies in the cluster"
description: ""
project: community
lastmod: 2012-05-02T09:12:59-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07373"
mailinglist_parent_id: "msg07372"
author_name: "Jon Meredith"
project_section: "mailinglistitem"
sent_date: 2012-05-02T09:12:59-07:00
---


Hi Nitish, for this to work you'll have to stop all the nodes at the same
time, clear the ring on all nodes, start up all nodes, then rejoin

If you clear the rings one node at a time, when you rejoin the nodes the
ring with the old and new style names will be gossipped back to it and
you'll still have both names.

I didn't realize you had a large amount of data - originally you
said "Currently, we are hosting limited amount of data", but 200mil docs
per node seems like a fair amount. Rebuilding that size cluster may take a
long time.

Your options as I see them are
 1) If you have backups of the ring files, you could revert the node name
changes and get the cluster stable again on riak@IP. The ring files have a
timestamp associated with them, but we only keep a few of the last ring
files, so if enough gossip has happened then the pre-rename rings will have
been destroyed. You will have to stop all nodes, put the ring files back
as they were before the change and fix the names in vm.args and then
restart the nodes.

 2) you can continue on the rebuild plan. stop all nodes, set the new
names in vm.args, start the nodes again and rebuild the cluster, adding as
many nodes as you can at once so they rebalance at the same time. When new
nodes are added the claimant node works out ownership changes and will
start a sequence of transfers. If new nodes are added once a sequence is
under way the claimant will wait for that to complete, then check if there
are any new nodes and repeat until all nodes are assigned. If you add all
the nodes at once you will do less transfers over all.


If the cluster cannot be stopped, there are other things we might be able
to do, but they're a bit more complex. What are your uptime requirements?

Jon



On Wed, May 2, 2012 at 9:57 AM, Nitish Sharma wrote:

&gt; Hi Jon,
&gt; Thanks for your input. I've already started working on that lines.
&gt; I stopped all the nodes, moved ring directory from one node, brought that
&gt; one up, and issued join command to one other node (after moving the ring
&gt; directory) - node2. While they were busy re-distributing the partitions, I
&gt; started another node (node3) and issued join command (before risk\_kv was
&gt; running, since it takes some time to load existing data).
&gt; But after this, data handoffs are occurring only between node1 and node2.
&gt; "member\_status" says that node 3 owns 0% of the ring and 0% are pending.
&gt; We have a lot of data - each node serves around 200 million documents.
&gt; Riak cluster is running 1.1.2.
&gt; Any suggestions?
&gt;
&gt; Cheers
&gt; Nitish
&gt; On May 2, 2012, at 5:31 PM, Jon Meredith wrote:
&gt;
&gt; Hi Nitish,
&gt;
&gt; If you rebuild the cluster with the same ring size, the data will
&gt; eventually get back to the right place. While the rebuild is taking place
&gt; you may have notfounds for gets until the data has been handed off to the
&gt; newly assigned owner (as it will be secondary handoff, not primary
&gt; ownership handoff to get teh data back). If you don't have a lot of data
&gt; stored in the cluster it shouldn't take too long.
&gt;
&gt; The process would be to stop all nodes, move the files out of the ring
&gt; directory to a safe place, start all nodes and rejoin. If you're using
&gt; 1.1.x and you have capacity in your hardware you may want to increase
&gt; handoff\_concurrency to something like 4 to permit more transfers to happen
&gt; across the cluster.
&gt;
&gt;
&gt; Jon.
&gt;
&gt;
&gt;
&gt; On Wed, May 2, 2012 at 9:05 AM, Nitish Sharma 
&gt; wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt; We have a 12-node Riak cluster. Until now we were naming every new node
&gt;&gt; as riak@. We then decided to rename the all the nodes to
&gt;&gt; riak@, which makes troubleshooting easier.
&gt;&gt; After issuing reip command to two nodes, we noticed in the "status" that
&gt;&gt; those 2 nodes were now appearing in the cluster with the old name as well
&gt;&gt; as the new name. Other nodes were trying to handoff partitions to the "new"
&gt;&gt; nodes, but apparently they were not able to. After this the whole cluster
&gt;&gt; went down and completely stopped responding to any read/write requests.
&gt;&gt; member\_status displayed old Riak name in "legacy" mode. Since this is our
&gt;&gt; production cluster, we are desperately looking for some quick remedies.
&gt;&gt; Issuing "force-remove" to the old names, restarting all the nodes, changing
&gt;&gt; the riak names back to the old ones - none of it helped.
&gt;&gt; Currently, we are hosting limited amount of data. Whats an elegant way to
&gt;&gt; recover from this mess? Would shutting off all the nodes, deleting the ring
&gt;&gt; directory, and again forming the cluster work?
&gt;&gt;
&gt;&gt; Cheers
&gt;&gt; Nitish
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Jon Meredith
&gt; Platform Engineering Manager
&gt; Basho Technologies, Inc.
&gt; jmered...@basho.com
&gt;
&gt;
&gt;


-- 
Jon Meredith
Platform Engineering Manager
Basho Technologies, Inc.
jmered...@basho.com
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

