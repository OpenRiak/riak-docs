---
title: "Re: ListKeys or MapReduce"
description: ""
project: community
lastmod: 2013-02-13T10:36:14-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10118"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-02-13T10:36:14-08:00
---


Hi,

In addition to the $key index, there is also a $bucket index available by 
default. This contains the name of the bucket, and can be used to get all keys 
in a specific bucket.

Best regards,

Christian


On 12 Feb 2013, at 22:39, Jeremiah Peschka  wrote:

&gt; As best as I understand the magical $key index, you need to provide a range 
&gt; in order to query anything from the index. A RiakBucketKeyInput accepts a 
&gt; bucket/key pair - you can add many of these to an MR input phase if you 
&gt; already know which keys in a bucket need to be acted upon.
&gt; 
&gt; Riak's secondary indices only allow for two operatios - exact match and range 
&gt; scan (see the message description if you're interested [1]). To get a full 
&gt; range scan, you'll want to pick a range\_max value that is outside the bounds 
&gt; of your largest key. If you know you're only dealing with ASCII characters 
&gt; you can easily pick an ASCII character [2] that's outside the bounds of your 
&gt; data set. This gets trickier if you have to deal with Unicode data. 
&gt; 
&gt; [1]: 
&gt; http://docs.basho.com/riak/latest/references/apis/protocol-buffers/PBC-Index/ 
&gt; [2]: http://www.asciitable.com/
&gt; 
&gt; ---
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; MCITP: SQL Server 2008, MVP
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; On Tue, Feb 12, 2013 at 2:24 PM, Kevin Burton  
&gt; wrote:
&gt; Is there a reason why you selected a range and not just the bucket and key 
&gt; (in the example)? My concern is that I don’t want to hard-code any 
&gt; dependencies or fore-knowledge in the code if possible. Using a range assumes 
&gt; that all of the keys are in the range. As I see it if you just specify the 
&gt; bucket and key there is no “assumption”. Right?
&gt; 
&gt; 
&gt; 
&gt; From: Jeremiah Peschka [mailto:jeremiah.pesc...@gmail.com] 
&gt; Sent: Tuesday, February 12, 2013 1:52 PM
&gt; 
&gt; 
&gt; To: Kevin Burton
&gt; Cc: riak-users
&gt; Subject: Re: ListKeys or MapReduce
&gt; 
&gt; 
&gt; 
&gt; Oh, and an example can be found https://gist.github.com/peschkaj/4772825
&gt; 
&gt; 
&gt; 
&gt; ---
&gt; 
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; 
&gt; MCITP: SQL Server 2008, MVP
&gt; 
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; 
&gt; On Tue, Feb 12, 2013 at 11:44 AM, Jeremiah Peschka 
&gt;  wrote:
&gt; 
&gt; ...and fixed!
&gt; 
&gt; 
&gt; 
&gt; You can get this right now if you're adventurous and want to build 
&gt; CorrugatedIron from source by grabbing the develop branch [1]. We have 
&gt; several other issues to clean up and verify before we release CI 1.1.1 in the 
&gt; next day or so. Or you can download it from [2] if you don't want to build 
&gt; yourself and don't want to wait for NuGet. Once we put 1.1.1 to NuGet we'll 
&gt; respond to this thread or email you directly.
&gt; 
&gt; 
&gt; 
&gt; I make no guarantees that the new DLL won't eat your hard drive or turn your 
&gt; computer into a killer robot.
&gt; 
&gt; 
&gt; 
&gt; [1]: https://github.com/DistributedNonsense/CorrugatedIron/tree/develop
&gt; 
&gt; [2]: 
&gt; http://clientresources.brentozar.com.s3.amazonaws.com/CorrugatedIron-111-alpha.zip
&gt; 
&gt; 
&gt; 
&gt; ---
&gt; 
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; 
&gt; MCITP: SQL Server 2008, MVP
&gt; 
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; 
&gt; On Tue, Feb 12, 2013 at 11:13 AM, Jeremiah Peschka 
&gt;  wrote:
&gt; 
&gt; Good news! You've found a bug in CorrugatedIron. Because of index naming, we 
&gt; muck index names to have a suffix of \_bin or \_int, depending on the index 
&gt; type. This shouldn't be happening on $key, but it is. I'll create a github 
&gt; issue and get that taken care of.
&gt; 
&gt; 
&gt; 
&gt; ---
&gt; 
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; 
&gt; MCITP: SQL Server 2008, MVP
&gt; 
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; 
&gt; On Tue, Feb 12, 2013 at 7:56 AM, Kevin Burton  
&gt; wrote:
&gt; 
&gt; I forgot to mention that when I execute this code I get the error:
&gt; 
&gt; 
&gt; 
&gt; {not\_found,
&gt; 
&gt; {&lt;&lt;"products"&gt;&gt;,
&gt; 
&gt; &lt;&lt;"$keys"&gt;&gt;},
&gt; 
&gt; undefined}}}:[{mochijson2,
&gt; 
&gt; json\_encode,2,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/mochijson2.erl"},
&gt; 
&gt; {line,149}]},
&gt; 
&gt; {mochijson2,
&gt; 
&gt; 
&gt; '-json\_encode\_array/2-fun-0-',
&gt; 
&gt; 3,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/mochijson2.erl"},
&gt; 
&gt; {line,157}]},
&gt; 
&gt; {lists,foldl,3,
&gt; 
&gt; [{file,"lists.erl"},
&gt; 
&gt; {line,1197}]},
&gt; 
&gt; {mochijson2,
&gt; 
&gt; json\_encode\_array,2,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/mochijson2.erl"},
&gt; 
&gt; {line,159}]},
&gt; 
&gt; {riak\_kv\_pb\_mapred,
&gt; 
&gt; process\_stream,3,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/riak\_kv\_pb\_mapred.erl"},
&gt; 
&gt; {line,97}]},
&gt; 
&gt; {riak\_api\_pb\_server,
&gt; 
&gt; process\_stream,5,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/riak\_api\_pb\_server.erl"},
&gt; 
&gt; {line,227}]},
&gt; 
&gt; {riak\_api\_pb\_server,
&gt; 
&gt; handle\_info,2,
&gt; 
&gt; [{file,
&gt; 
&gt; 
&gt; "src/riak\_api\_pb\_server.erl"},
&gt; 
&gt; {line,158}]},
&gt; 
&gt; {gen\_server,
&gt; 
&gt; handle\_msg,5,
&gt; 
&gt; [{file,
&gt; 
&gt; "gen\_server.erl"},
&gt; 
&gt; {line,607}]}] - 
&gt; CommunicationError
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; From: riak-users [mailto:riak-users-boun...@lists.basho.com] On Behalf Of 
&gt; Kevin Burton
&gt; Sent: Tuesday, February 12, 2013 9:48 AM
&gt; To: 'Jeremiah Peschka'
&gt; Cc: 'riak-users'
&gt; Subject: RE: ListKeys or MapReduce
&gt; 
&gt; 
&gt; 
&gt; The name is “$keys”? Something like:
&gt; 
&gt; 
&gt; 
&gt; using (IRiakEndPoint cluster = 
&gt; RiakCluster.FromConfig("riakConfig"))
&gt; 
&gt; {
&gt; 
&gt; IRiakClient riakClient = cluster.CreateClient();
&gt; 
&gt; RiakBucketKeyInput bucketKeyInput = new RiakBucketKeyInput();
&gt; 
&gt; bucketKeyInput.AddBucketKey(productBucketName, "$keys");
&gt; 
&gt; RiakMapReduceQuery query = new RiakMapReduceQuery()
&gt; 
&gt; .Inputs(bucketKeyInput)
&gt; 
&gt; .MapJs(m =&gt; m.Name("Riak.mapValuesJson").Keep(true));
&gt; 
&gt; RiakResult result = 
&gt; riakClient.MapReduce(query);
&gt; 
&gt; if (result.IsSuccess)
&gt; 
&gt; {
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; From: Jeremiah Peschka [mailto:jeremiah.pesc...@gmail.com] 
&gt; Sent: Tuesday, February 12, 2013 9:18 AM
&gt; To: Kevin Burton
&gt; Cc: riak-users
&gt; Subject: Re: ListKeys or MapReduce
&gt; 
&gt; 
&gt; 
&gt; It would be queried like any other index as an MR input. I'll create an issue 
&gt; and will try to get this in some time in the next few days - no promises, 
&gt; though.
&gt; 
&gt; 
&gt; 
&gt; ---
&gt; 
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; 
&gt; MCITP: SQL Server 2008, MVP
&gt; 
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; 
&gt; On Tue, Feb 12, 2013 at 7:09 AM, Kevin Burton  
&gt; wrote:
&gt; 
&gt; I will read the other URLs that you mentioned. Thank you.
&gt; 
&gt; 
&gt; 
&gt; Would you mind giving a short example (preferably using CI) of the $keys 
&gt; index?
&gt; 
&gt; 
&gt; 
&gt; From: Jeremiah Peschka [mailto:jeremiah.pesc...@gmail.com] 
&gt; Sent: Tuesday, February 12, 2013 8:52 AM
&gt; To: Kevin Burton
&gt; Cc: riak-users
&gt; Subject: Re: ListKeys or MapReduce
&gt; 
&gt; 
&gt; 
&gt; They're both pretty crappy in terms of performance - they read all data off 
&gt; of disk. If you're using LevelDB you can use the $keys index to pull back 
&gt; just the keys that in a single bucket.
&gt; 
&gt; 
&gt; 
&gt; A better approach is to maintain a separate bucket - e.g. DocumentCount - 
&gt; that is used for counting documents. Unfortunately, you can't guarantee 
&gt; transactional consistency around counts in Riak today, so you'll want to move 
&gt; maintaining the counts out of Riak and into something else. If you search the 
&gt; list archives [1], you'll find that Redis has been mentioned as a good way to 
&gt; solve this problem - counters are stored in Redis and flushed to Riak on a 
&gt; regular schedule. Because of the lack of consistency (especially around 
&gt; MapReduce operations), Riak isn't the best choice if you require 
&gt; counters/aggregations to be stored in the database.
&gt; 
&gt; 
&gt; 
&gt; Once CRDTs [2] make it into mainstream Riak, you can make use of those data 
&gt; structures to implement distributed counters in Riak.
&gt; 
&gt; 
&gt; 
&gt; [1]: http://riak.markmail.org
&gt; 
&gt; [2]: http://vimeo.com/52414903
&gt; 
&gt; 
&gt; 
&gt; ---
&gt; 
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited
&gt; 
&gt; MCITP: SQL Server 2008, MVP
&gt; 
&gt; Cloudera Certified Developer for Apache Hadoop
&gt; 
&gt; 
&gt; 
&gt; On Mon, Feb 11, 2013 at 10:30 AM,  wrote:
&gt; 
&gt; Say I need to determine how many document there are in my database. For a 
&gt; CorrugatedIron application I can do ListKeys and get the warning that it is 
&gt; an expensive operation or I can do a MapReduce query. Which is the the least 
&gt; expensive? Is there an option that I am missing?
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

