---
title: "Re: failed get after successful put"
description: ""
project: community
lastmod: 2014-04-30T15:14:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14158"
mailinglist_parent_id: "msg14157"
author_name: "Evan Vigil-McClanahan"
project_section: "mailinglistitem"
sent_date: 2014-04-30T15:14:26-07:00
---


I suspect that, given the large heap messages, you're seeing the known
issues where when a custom bucket is created and the moving that
metadata around the ring takes increasingly long. It isn't
recommended to create a large number of custom buckets at the moment.

What the process likely looks like is this:

1. you do the set.
2. bucket metadata starts being gossip around the ring.
3. you do the put. it succeeds, but on some nodes, the metadata
hasn't been committed, so it's put into the default backend.
4. gossip finishes.
5. you do the get. it fails because now the bucket for this backend
has made 2 replicas unreachable.
6. read repair happens, repopulating the 2 missing replicas.
7. you re-get and it works.

On Wed, Apr 30, 2014 at 4:04 PM, Oleksiy Krivoshey  wrote:
&gt; The objects are really small (50 - 500 bytes).
&gt;
&gt; It doesn't happen if the bucket was already created.
&gt; It also does't happen if I don't call SetBucket at all (so using default
&gt; backend and options).
&gt; And it seems it doesn't happen if I call SetBucket but don't set `backend`
&gt; property.
&gt;
&gt;
&gt;
&gt; On 1 May 2014 00:51, Evan Vigil-McClanahan  wrote:
&gt;&gt;
&gt;&gt; Does this continue if the bucket hasn't been created recently? Does
&gt;&gt; it matter how large the object is? Is it particularly large in this
&gt;&gt; case?
&gt;&gt;
&gt;&gt; On Wed, Apr 30, 2014 at 3:47 PM, Oleksiy Krivoshey 
&gt;&gt; wrote:
&gt;&gt; &gt; Hi guys,
&gt;&gt; &gt;
&gt;&gt; &gt; can someone please suggest what can be the reason for 'get' immediately
&gt;&gt; &gt; following successful 'put' to fail?
&gt;&gt; &gt;
&gt;&gt; &gt; I'm running a fully connected, healthy, 5 node Riak 2.0-beta1 cluster.
&gt;&gt; &gt; Using
&gt;&gt; &gt; a multiple backend feature, so the order of operations is:
&gt;&gt; &gt;
&gt;&gt; &gt; 1. 'SetBucket' for a new bucket with a backend name. Wait for successful
&gt;&gt; &gt; reply
&gt;&gt; &gt; 2. 'Put' object to bucket. Wait for successful reply (return\_head: true,
&gt;&gt; &gt; so
&gt;&gt; &gt; I get clock, vtag, etc back)
&gt;&gt; &gt; 3. 'Get' object from step 2. Returns empty response (missing object)
&gt;&gt; &gt;
&gt;&gt; &gt; If I repeat 'Get' after just few moments - I will successfully retrieve
&gt;&gt; &gt; the
&gt;&gt; &gt; object.
&gt;&gt; &gt;
&gt;&gt; &gt; CAP options are all defaults (n: 3, etc). Happens with both custom
&gt;&gt; &gt; bitcask
&gt;&gt; &gt; and custom leveldb backends.
&gt;&gt; &gt;
&gt;&gt; &gt; There are no errors in riak logs, but a lot of the following:
&gt;&gt; &gt;
&gt;&gt; &gt; 2014-04-30 21:41:05.656 [info]
&gt;&gt; &gt; &lt;0.95.0&gt;@riak\_core\_sysmon\_handler:handle\_event:92 monitor large\_heap
&gt;&gt; &gt; &lt;0.10689.74&gt;
&gt;&gt; &gt;
&gt;&gt; &gt; [{initial\_call,{erlang,apply,2}},{almost\_current\_function,{eval\_bits,expr\_grp,4}},{message\_queue\_len,0}]
&gt;&gt; &gt;
&gt;&gt; &gt; [{old\_heap\_block\_size,0},{heap\_block\_size,79467343},{mbuf\_size,0},{stack\_size,394},{old\_heap\_size,0},{heap\_size,28858704}]
&gt;&gt; &gt;
&gt;&gt; &gt; --
&gt;&gt; &gt; Oleksiy
&gt;&gt; &gt;
&gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; &gt;
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Oleksiy Krivoshey

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

