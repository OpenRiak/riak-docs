---
title: "Re: Fwd: Errors when using basho_bench"
description: ""
project: community
lastmod: 2010-06-09T23:30:58-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00547"
mailinglist_parent_id: "msg00539"
author_name: "Dan Reverri"
project_section: "mailinglistitem"
sent_date: 2010-06-09T23:30:58-07:00
---


Hi Germain,

I'm not able to reproduce the errors locally but I do occasionally see the
following after a test ends:
=ERROR REPORT==== 9-Jun-2010::23:18:35 ===
webmachine error: path="/riak/test/5711"
{error,{error,{badmatch,{error,closed}},
 [{webmachine\_request,recv\_unchunked\_body,4},
 {webmachine\_request,do\_recv\_body,2},
 {webmachine\_request,call,2},
 {wrq,req\_body,1},
 {riak\_kv\_wm\_raw,accept\_doc\_body,2},
 {webmachine\_resource,resource\_call,3},
 {webmachine\_resource,do,3},
 {webmachine\_decision\_core,resource\_call,1}]}}

It looks like this is happening because the basho bench workers are killed
off in the middle of a request.




On Wed, Jun 9, 2010 at 5:07 AM, Germain Maurice &lt;
germain.maur...@linkfluence.net&gt; wrote:

&gt; The backend used is http\_raw as you can see in the benchmark config file :
&gt;
&gt; {mode, max}.
&gt; {duration, 30}.
&gt; {concurrent, 20}.
&gt; {driver, basho\_bench\_driver\_http\_raw}.
&gt; {code\_paths, ["deps/stats",
&gt; "deps/ibrowse"]}.
&gt; {http\_raw\_ips, ["10.0.0.40", "10.0.0.41"]}.
&gt; {key\_generator, {uniform\_int, 10000}}.
&gt; {value\_generator, {fixed\_bin, 800000}}.
&gt; {operations, [{get, 2}, {update, 2}]}.
&gt; {http\_raw\_params, "?r=1&w=2"}.
&gt;
&gt;
&gt; The webmachine errors occured immediately after shutting down the benchmark
&gt; with no other requests.
&gt; We repeated the benchmark and we got these errors again.
&gt;
&gt;
&gt; Le 08/06/10 19:23, Dan Reverri a écrit :
&gt;
&gt; Hi Germain,
&gt;
&gt; I've confirmed that the basho bench drivers for riakclient and riakc\_pb
&gt; do not provide a content-type when submitting key/value pairs to Riak. This
&gt; should not cause problems while running the benchmark.
&gt;
&gt; Which driver were you using when you noticed the webmachine errors? Were
&gt; you making GET requests for keys created in the benchmark against the REST
&gt; API after the benchmark?
&gt;
&gt; Thanks,
&gt; Dan
&gt;
&gt; On Tue, Jun 8, 2010 at 9:29 AM, Dan Reverri  wrote:
&gt;
&gt;&gt; Hi Germain,
&gt;&gt;
&gt;&gt; You should be able to work around this issue by specifying a full list
&gt;&gt; of default bucket properties with your change incorporated. For example, try
&gt;&gt; putting the following in your app.config:
&gt;&gt; {default\_bucket\_props, [{n\_val,2},
&gt;&gt; {allow\_mult,false},
&gt;&gt; {last\_write\_wins,false},
&gt;&gt; {precommit, []},
&gt;&gt; {postcommit, []},
&gt;&gt; {chash\_keyfun, {riak\_core\_util,
&gt;&gt; chash\_std\_keyfun}}]}
&gt;&gt;
&gt;&gt;
&gt;&gt; This is the full list of default bucket properties that can be found in
&gt;&gt; "apps/riak\_core/ebin/riak\_core.app" with the n\_val changed to "2".
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Tue, Jun 8, 2010 at 9:05 AM, Germain Maurice &lt;
&gt;&gt; germain.maur...@linkfluence.net&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; You're right, i put this line in the app.config :
&gt;&gt;&gt; ,{default\_bucket\_props, [{n\_val, 2}]}
&gt;&gt;&gt;
&gt;&gt;&gt; Maybe, i made a mistake...
&gt;&gt;&gt;
&gt;&gt;&gt; Le 08/06/10 17:55, Dan Reverri a écrit :
&gt;&gt;&gt;
&gt;&gt;&gt; Forwarding my reply to the mailing list.
&gt;&gt;&gt;
&gt;&gt;&gt; ---------- Forwarded message ----------
&gt;&gt;&gt; From: Dan Reverri 
&gt;&gt;&gt; Date: Tue, Jun 8, 2010 at 8:45 AM
&gt;&gt;&gt; Subject: Re: Errors when using basho\_bench
&gt;&gt;&gt; To: Germain Maurice 
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Germain,
&gt;&gt;&gt;
&gt;&gt;&gt; The first error "{'function not
&gt;&gt;&gt; exported',[{riak\_core\_bucket,defaults,[]}," would occur when a bucket does
&gt;&gt;&gt; not have a "chash\_keyfun" property defined. This could occur if you have
&gt;&gt;&gt; specified default bucket properties in your app.config. There is a known
&gt;&gt;&gt; issue where bucket properties defined in the app.config file are not merged
&gt;&gt;&gt; with the hard coded defaults:
&gt;&gt;&gt; http://issues.basho.com/show\_bug.cgi?id=123
&gt;&gt;&gt;
&gt;&gt;&gt; I'm not sure why this issue would only occur when increasing the
&gt;&gt;&gt; partition size. Were other changes made to app.config?
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; The second error "{case\_clause,{error,timeout}}, 
&gt;&gt;&gt; [{riak\_kv\_wm\_raw,content\_types\_provided,2}"
&gt;&gt;&gt; occurs when a key/value pair has been inserted into Riak without a
&gt;&gt;&gt; content-type and retrieved via the REST interface. This can happen when
&gt;&gt;&gt; inserting key/value pairs with the native Erlang client or the protobuffs
&gt;&gt;&gt; client. These clients don't require that a content-type be set. I assume the
&gt;&gt;&gt; values in question were inserted by the basho bench utility so I will look
&gt;&gt;&gt; into how those values are inserted by basho bench.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Dan
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Tue, Jun 8, 2010 at 7:38 AM, Germain Maurice &lt;
&gt;&gt;&gt; germain.maur...@linkfluence.net&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; After viewing the demonstration of basho\_bench during the webinar of the
&gt;&gt;&gt;&gt; last week, we led some tests.
&gt;&gt;&gt;&gt; Here are some errors we are meeting while doing a benchmark with
&gt;&gt;&gt;&gt; basho\_bench.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Big notice : when the ring partition size was 64, i never got this kind
&gt;&gt;&gt;&gt; of error (excepting a crash of a node, due to not enough memory i think,
&gt;&gt;&gt;&gt; 1,5GB RAM). But now, i have 128 partitions (see my other message on the 
&gt;&gt;&gt;&gt; riak
&gt;&gt;&gt;&gt; ML about the ring partition size) and these errors occurs.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; This error occured multiple times :
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; =ERROR REPORT==== 8-Jun-2010::16:21:06 ===
&gt;&gt;&gt;&gt; \*\* State machine &lt;0.937.0&gt; terminating
&gt;&gt;&gt;&gt; \*\* Last event in was timeout
&gt;&gt;&gt;&gt; \*\* When State == initialize
&gt;&gt;&gt;&gt; \*\* Data ==
&gt;&gt;&gt;&gt; {state,&lt;0.932.0&gt;,undefined,2,undefined,undefined,undefined,
&gt;&gt;&gt;&gt; 8594018,undefined,undefined,undefined,undefined,
&gt;&gt;&gt;&gt; undefined,undefined,60000,undefined,
&gt;&gt;&gt;&gt; {&lt;&lt;"test"&gt;&gt;,&lt;&lt;"25500"&gt;&gt;},
&gt;&gt;&gt;&gt; {chstate,'r...@10.0.0.40',
&gt;&gt;&gt;&gt; [{'r...@10.0.0.40',{64,63443225844}}],
&gt;&gt;&gt;&gt; {128,
&gt;&gt;&gt;&gt; [{0,'r...@10.0.0.40'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {11417981541647679048466287755595961091061972992,
&gt;&gt;&gt;&gt; 'r...@10.0.0.41'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {22835963083295358096932575511191922182123945984,
&gt;&gt;&gt;&gt; 'r...@10.0.0.40'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {34253944624943037145398863266787883273185918976,
&gt;&gt;&gt;&gt; 'r...@10.0.0.41'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {45671926166590716193865151022383844364247891968,
&gt;&gt;&gt;&gt; 'r...@10.0.0.40'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {57089907708238395242331438777979805455309864960,
&gt;&gt;&gt;&gt; 'r...@10.0.0.41'},
&gt;&gt;&gt;&gt; [...]
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {1415829711164312202009819681693899175291684651008,
&gt;&gt;&gt;&gt; 'r...@10.0.0.40'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {1427247692705959881058285969449495136382746624000,
&gt;&gt;&gt;&gt; 'r...@10.0.0.41'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {1438665674247607560106752257205091097473808596992,
&gt;&gt;&gt;&gt; 'r...@10.0.0.40'},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {1450083655789255239155218544960687058564870569984,
&gt;&gt;&gt;&gt; 'r...@10.0.0.41'}]},
&gt;&gt;&gt;&gt; {dict,0,16,16,8,80,48,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
&gt;&gt;&gt;&gt; []}}}},
&gt;&gt;&gt;&gt; undefined}
&gt;&gt;&gt;&gt; \*\* Reason for termination =
&gt;&gt;&gt;&gt; \*\* {'function not exported',[{riak\_core\_bucket,defaults,[]},
&gt;&gt;&gt;&gt; {riak\_core\_util,chash\_key,1},
&gt;&gt;&gt;&gt; {riak\_kv\_get\_fsm,initialize,2},
&gt;&gt;&gt;&gt; {gen\_fsm,handle\_msg,7},
&gt;&gt;&gt;&gt; {proc\_lib,init\_p\_do\_apply,3}]}
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; After shutting down the benchmark we also got this following error,
&gt;&gt;&gt;&gt; multiple times too :
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; =ERROR REPORT==== 8-Jun-2010::16:19:28 ===
&gt;&gt;&gt;&gt; webmachine error: path="/riak/test/16028"
&gt;&gt;&gt;&gt; [{webmachine\_decision\_core,'-decision/1-lc$^1/1-1-',
&gt;&gt;&gt;&gt; [{error,
&gt;&gt;&gt;&gt; {error,
&gt;&gt;&gt;&gt; {case\_clause,{error,timeout}},
&gt;&gt;&gt;&gt; [{riak\_kv\_wm\_raw,content\_types\_provided,2},
&gt;&gt;&gt;&gt; {webmachine\_resource,resource\_call,3},
&gt;&gt;&gt;&gt; {webmachine\_resource,do,3},
&gt;&gt;&gt;&gt; {webmachine\_decision\_core,resource\_call,1},
&gt;&gt;&gt;&gt; {webmachine\_decision\_core,decision,1},
&gt;&gt;&gt;&gt; {webmachine\_decision\_core,handle\_request,2},
&gt;&gt;&gt;&gt; {webmachine\_mochiweb,loop,1},
&gt;&gt;&gt;&gt; {mochiweb\_http,headers,5}]}}]},
&gt;&gt;&gt;&gt; {webmachine\_decision\_core,decision,1},
&gt;&gt;&gt;&gt; {webmachine\_decision\_core,handle\_request,2},
&gt;&gt;&gt;&gt; {webmachine\_mochiweb,loop,1},
&gt;&gt;&gt;&gt; {mochiweb\_http,headers,5},
&gt;&gt;&gt;&gt; {proc\_lib,init\_p\_do\_apply,3}]
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Any idea about these errors ?
&gt;&gt;&gt;&gt; No problem with Webmachine ?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; Germain Maurice
&gt;&gt;&gt;&gt; Administrateur Système/Réseau
&gt;&gt;&gt;&gt; Tel : +33.(0)1.42.43.54.33
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; http://www.linkfluence.net
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Germain Maurice
&gt;&gt;&gt; Administrateur Système/Réseau
&gt;&gt;&gt; Tel : +33.(0)1.42.43.54.33
&gt;&gt;&gt; http://www.linkfluence.net
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Germain Maurice
&gt; Administrateur Système/Réseau
&gt; Tel : +33.(0)1.42.43.54.33
&gt; http://www.linkfluence.net
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

