---
title: "Re: Product Advisory - Riak 2.1.0: Default Configuration For Handoff	May Cause Data Loss"
description: ""
project: community
lastmod: 2015-05-01T13:52:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16090"
mailinglist_parent_id: "msg16089"
author_name: "Tyler Hannan"
project_section: "mailinglistitem"
sent_date: 2015-05-01T13:52:19-07:00
---


UPDATE: Further investigation has shown that fallback transfers
(hinted handoff) are affected in the same way as ownership transfers.

Our engineering team is working on fixing this as high priority. We
apologize for any impact this having on our users.

Cheers,

Tyler Hannan | Director of Technical Marketing
Basho Technologies
t: @tylerhannan
c: 720-280-9216


On Fri, May 1, 2015 at 12:36 PM, Tyler Hannan  wrote:
&gt; -Description-
&gt;
&gt; In Riak 2.1.0, the default configuration for handoff.ip causes vnodes
&gt; marked for transfer during handoff to be removed without transferring
&gt; data to their new destination nodes. A mandatory change to
&gt; configuration (riak.conf) will resolve this issue. While not all users
&gt; are impacted by this issue, we recommend that all 2.1.0 users upgrade
&gt; to 2.1.1 which will be released shortly.
&gt;
&gt; NOTE: This is known to occur for ownership handoff. Investigation as
&gt; to whether hinted handoff is affected is ongoing and this advisory
&gt; will be updated when more information is available.
&gt;
&gt; -Affected Users-
&gt;
&gt; All users of 2.1.0 using riak.conf to configure their clusters are
&gt; potentially impacted. Users that are using app.config and vm.args to
&gt; configure their clusters are unaffected but should upgrade to 2.1.1
&gt; upon release.
&gt;
&gt; To verify whether you are affected, the below command must be run on
&gt; each node in your cluster:
&gt; riak config effective | grep handoff.ip
&gt;
&gt; Affected nodes will have a handoff ip of 127.0.0.1
&gt; handoff.ip = 127.0.0.1
&gt;
&gt; -Impact-
&gt;
&gt; This bug impacts vnodes that are in process of handoff. Handoff data
&gt; will be looped back to the source node during ownership handoff rather
&gt; than being transferred to the destination node. Once ownership handoff
&gt; is completed the data is removed from the source node. In the event of
&gt; significant ownership handoff, which can happen during cluster
&gt; expansion or contraction, all replicas of an object may be lost. Data
&gt; loss occurs if all replicas of an object are lost as a result of this
&gt; configuration issue. Replica loss can be triggered by cluster
&gt; membership changes or other Riak cluster activity that triggers
&gt; handoff behavior. Data loss is mitigated as long as at least one
&gt; replica still exists and the below steps are followed.
&gt;
&gt; -Mitigation-
&gt;
&gt; You can immediately mitigate the issue by setting transfer limit to
&gt; zero across the cluster by issuing the following on any node:
&gt;
&gt; riak-admin transfer-limit 0
&gt;
&gt; Then configure handoff.ip in riak.conf to an external IP address or
&gt; 0.0.0.0 on all nodes.
&gt;
&gt; Perform a rolling restart of Riak across your cluster to activate the
&gt; new setting.
&gt;
&gt; After correcting the configuration and restarting the nodes, you
&gt; should run Riak KV repair on each cluster member as documented at
&gt; http://docs.basho.com/riak/latest/ops/running/recovery/repairing-partitions/
&gt; to recreate any missing replicas from available replicas elsewhere in
&gt; the cluster. It is recommended to perform the Riak KV repair in a
&gt; round-robin fashion on each node of your cluster (node0, node1, node2,
&gt; etc). Repeat this round-robin repair “n\_val - 1” times. For example:
&gt; the default configuration for n\_val is 3, which means you would run
&gt; Riak KV repair twice across the entire cluster.
&gt;
&gt; NOTE: It is important to ensure that you execute in a round-robin
&gt; fashion: node0, node1, node2 and then repeat.
&gt;
&gt; A forthcoming 2.1.1 release will provide an updated default configuration.
&gt;
&gt; Questions?
&gt;
&gt; Please open a ticket with Basho if you have any questions about the above 
&gt; issue.
&gt;
&gt; Cheers,
&gt;
&gt; Tyler Hannan | Director of Technical Marketing
&gt; Basho Technologies
&gt; t: @tylerhannan
&gt; c: 720-280-9216

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

