---
title: "Re: Segmentation fault in eleveldb.so on Riak startup"
description: ""
project: community
lastmod: 2013-06-12T16:06:56-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11258"
mailinglist_parent_id: "msg11257"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-06-12T16:06:56-07:00
---


Vladimir,

You have one of two problems, either there is something in one of the existing 
.sst files causing compaction to crash, or there is some type of threading 
problem that crash during the hash/bloom creation. I am going to assume an 
.sst file problem for now.

The last time you crashed, only 6 vnodes were actively compacting. Their 
directory names start as follows:

 21694
 23977
 473846
 65082
 7478777
 7707137

I leave it to you to copy and paste the full directory names.

The first step is to find which directory is crashing. Use the instructions 
here

https://gist.github.com/gburd/b88aee6da7fee81dc036

BUT instead of "eleveldb:repair", use "eleveldb:open". Wait five minutes after 
each open to see if each vnode's compactions run completely without crashing.

If one crashes, that is where the problem exists. If none of them crash, then 
there is a threading / race condition … and I will have to think on how to 
diagnose.

Matthew


On Jun 12, 2013, at 6:09 PM, Vladimir Shabanov  wrote:

&gt; Unfortunately I don't see any 'Compaction error' in my logs.
&gt; 
&gt; Should I run eleveldb:repair() on all partitions? And if should how I can run 
&gt; a function for all files in directory in Erlang? Running function manually 
&gt; for all partitions is too tiresome.
&gt; 
&gt; 
&gt; 2013/6/13 Matthew Von-Maszewski 
&gt; Vladimir,
&gt; 
&gt; Also, my colleague sent this to me after my first email. This is roughly the 
&gt; plan I intend to follow … if the LOG file gives us a direct pointer to a file 
&gt; corruption:
&gt; 
&gt; https://gist.github.com/gburd/b88aee6da7fee81dc036
&gt; 
&gt; However, your crash point suggests we might have to do a bit more work to 
&gt; isolate the bad input file. But I would be happy to be wrong and the above 
&gt; work as is.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; On Jun 12, 2013, at 5:13 PM, Matthew Von-Maszewski  wrote:
&gt; 
&gt;&gt; Vladimir,
&gt;&gt; 
&gt;&gt; I asked around the Basho chat room and you have a crash that has never been 
&gt;&gt; seen. This should be interesting.
&gt;&gt; 
&gt;&gt; The crash is happening during a compaction, specifically during the creation 
&gt;&gt; of the bloom filter for a new .sst file. Maybe we can isolate the old file 
&gt;&gt; that feeding this compaction and move it out of the way for further 
&gt;&gt; debugging … and get you running while the debugging happens off-line.
&gt;&gt; 
&gt;&gt; Would you tar/zip the following files (changing the paths as appropriate for 
&gt;&gt; your system):
&gt;&gt; 
&gt;&gt; tar -czf vladimir\_LOGs.tgz /var/lib/riak/leveldb/\*/LOG\*
&gt;&gt; and your app.config file.
&gt;&gt; 
&gt;&gt; I will see if I can determine where the bad input file resides and help you 
&gt;&gt; get back running. Then we can decide how to look deeper for root cause.
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Jun 12, 2013, at 4:02 PM, Vladimir Shabanov  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hello,
&gt;&gt;&gt; 
&gt;&gt;&gt; I have a cluster of 8 Riak-1.3.1 nodes. Recently one of my nodes silently 
&gt;&gt;&gt; crashed. Nothing unusual was reported in logs.
&gt;&gt;&gt; 
&gt;&gt;&gt; When I've tried to start my node again it worked for few seconds and 
&gt;&gt;&gt; silently crashed again. I've run 'riak console' and seen "Segmentation 
&gt;&gt;&gt; fault".
&gt;&gt;&gt; 
&gt;&gt;&gt; gdb with dumped core shows:
&gt;&gt;&gt; 
&gt;&gt;&gt; Program terminated with signal 11, Segmentation fault.
&gt;&gt;&gt; #0 0x00007f162547fa30 in MurmurHash64A(void const\*, int, unsigned int) ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; 
&gt;&gt;&gt; Backtrace shows that it happens somewhere in LevelDB compaction.
&gt;&gt;&gt; 
&gt;&gt;&gt; (gdb) bt
&gt;&gt;&gt; #0 0x00007f162547fa30 in MurmurHash64A(void const\*, int, unsigned int) ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #1 0x00007f162547833c in leveldb::(anonymous 
&gt;&gt;&gt; namespace)::BloomFilterPolicy2::CreateFilter(leveldb::Slice const\*, int, 
&gt;&gt;&gt; std::string\*) const ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #2 0x00007f162548382d in leveldb::FilterBlockBuilder::GenerateFilter() ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #3 0x00007f1625483a58 in leveldb::FilterBlockBuilder::StartBlock(unsigned 
&gt;&gt;&gt; long) ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #4 0x00007f1625475175 in leveldb::TableBuilder::Flush() ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #5 0x00007f1625475395 in leveldb::TableBuilder::Add(leveldb::Slice const&, 
&gt;&gt;&gt; leveldb::Slice const&) () from 
&gt;&gt;&gt; /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #6 0x00007f162545b561 in 
&gt;&gt;&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState\*) () 
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #7 0x00007f162545bd3b in leveldb::DBImpl::BackgroundCompaction() ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #8 0x00007f162545ca5d in leveldb::DBImpl::BackgroundCall() ()
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #9 0x00007f162547bb38 in leveldb::(anonymous 
&gt;&gt;&gt; namespace)::PosixEnv::BGThreadWrapper(void\*) () from 
&gt;&gt;&gt; /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #10 0x00007f163366ab50 in start\_thread () from 
&gt;&gt;&gt; /lib/x86\_64-linux-gnu/libpthread.so.0
&gt;&gt;&gt; #11 0x00007f16331aca7d in clone () from /lib/x86\_64-linux-gnu/libc.so.6
&gt;&gt;&gt; #12 0x0000000000000000 in ?? ()
&gt;&gt;&gt; 
&gt;&gt;&gt; gdb output in gist
&gt;&gt;&gt; https://gist.github.com/vshabanov/5768546
&gt;&gt;&gt; 
&gt;&gt;&gt; Why it's happening and how to bring the node back to life?
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

