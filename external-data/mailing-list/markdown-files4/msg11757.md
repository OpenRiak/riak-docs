---
title: "Re: Corrupted Erlang binary term inside LevelDB"
description: ""
project: community
lastmod: 2013-07-25T11:04:24-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11757"
mailinglist_parent_id: "msg11738"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-07-25T11:04:24-07:00
---


Vladimir,

I can explain what happened, but not how to correct the problem. The gentleman 
that can walk you through a repair is tied up on another project, but he 
intends to respond as soon as he is able.

We recently discovered / realized that Google's leveldb code does not check the 
CRC of each block rewritten during a compaction. This means that blocks with 
bad CRCs get read without being flagged as bad, then rewritten to a new file 
with a new, valid CRC. The corruption is now hidden.

A more thorough discussion of the problem is found here:

https://github.com/basho/leveldb/wiki/mv-verify-compactions


We added code to the 1.3.2 and 1.4 Riak releases to have the block CRC checked 
during both read (Get) requests and compaction rewrites. This prevents future 
corruption hiding. Unfortunately, it does NOTHING for blocks already corrupted 
and rewritten with valid CRCs. You are encountering this latter condition. We 
have a developer advocate / client services person that has walked others 
through a fix via the Riak data replicas … 

… please hold and the doctor will be with you shortly.

Matthew


On Jul 24, 2013, at 9:39 PM, Vladimir Shabanov  wrote:

&gt; Hello,
&gt; 
&gt; Recently I've started expanding my Riak cluster and found that handoffs were 
&gt; continuously retried for one partition.
&gt; 
&gt; Here are logs from two nodes
&gt; https://gist.github.com/vshabanov/41282e622479fbe81974
&gt; 
&gt; The most interesting parts of logs are
&gt; "Handoff receiver for partition ... exited abnormally after processing 
&gt; 2860338 objects: {{badarg,[{erlang,binary\_to\_term,..."
&gt; and
&gt; "bad argument in call to erlang:binary\_to\_term(&lt;&lt;131,104,...."
&gt; 
&gt; Both nodes are running Riak 1.3.2 (old one was running 1.3.1 previously).
&gt; 
&gt; 
&gt; When I've printed corrupted binary string I found that it corresponds to one 
&gt; value.
&gt; 
&gt; When I've tried to "get" it, it was read OK but node with corrupted value 
&gt; shown the same binary\_to\_term error.
&gt; 
&gt; When I've tried to delete corrupted value I've got timeout.
&gt; 
&gt; 
&gt; I'm running machines with ECC memory and ZFS filesystem (which doesn't report 
&gt; any checksum failures) so I doubt data was silently corrupted on disk.
&gt; 
&gt; LOG from corresponding LevelDB partition doesn't show any errors. But there 
&gt; is a lost/BLOCKS.bad file in this partition (7kb, created more than a month 
&gt; ago and looks like it doesn't contain corrupted value).
&gt; 
&gt; At the moment I've stopped handoffs using "risk-admin transfer-limit 0".
&gt; 
&gt; Why the value was corrupted? It there any way to remove it or fix it?
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

