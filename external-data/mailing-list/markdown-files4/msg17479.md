---
title: "Re: bitcask merges & deletions"
description: ""
project: community
lastmod: 2016-06-15T19:12:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17479"
mailinglist_parent_id: "msg17477"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-06-15T19:12:07-07:00
---


Hi Johnny,

Since this seems to happen regularly on one node on your cluster (not
necessarily the same node), do you have a repetitive process that
performs a \*lot\* of updates or deletes on a single key that could be
correlated to these merges?
--
Luke Bakken
Engineer
lbak...@basho.com


On Wed, Jun 15, 2016 at 10:22 AM, Johnny Tan  wrote:
&gt; We're running riak-1.4.2
&gt;
&gt; Every few weeks, we have a riak node that starts to slowly fill up on disk
&gt; space for several days, and then suddenly gain that space back again.
&gt;
&gt; In looking into this more today, I think I see what's going on.
&gt;
&gt; Per the console.log on a node that it's happening to right now, there are an
&gt; unusually large amount of merges happening right now. There are 6 total
&gt; nodes in our cluster, it's only happening to this node today. (In previous
&gt; weeks, it's been other nodes, but it's always been one node at a time.)
&gt;
&gt; Normally, we get 50-70 merges per day per node (according to various nodes'
&gt; console.log, including the node in question). Yesterday and today, the node
&gt; in question has several hundred merges happening.
&gt;
&gt; When I look inside the bitcask directory, I see a lot of files with this set
&gt; of permissions:
&gt; -rwSrw-r--
&gt;
&gt; My understanding is that those are files marked for deletions after bitcask
&gt; merging.
&gt;
&gt; The number of those files is currently growing, and from a spot-check, they
&gt; indeed match up as the files that have been merged.
&gt;
&gt; So it seems the two are related: a lot of merges are happening, which then
&gt; causes a large number of files to be marked for deletion, and those marked
&gt; files are piling up and not getting deleted for some reason.
&gt;
&gt; If I don't do anything, those files eventually get deleted, and everything
&gt; is good again for another couple weeks until it happens to another node. But
&gt; the disk usage does get high enough to alert us, and obviously we don't want
&gt; it to get anywhere near 100%.
&gt;
&gt;
&gt; I'm trying to figure out why there are times when this happens. One thing I
&gt; noticed is a difference in the merge log entries.
&gt;
&gt; Here's one from a "normal" day, nearly all the entries for that day are
&gt; roughly this same length and same amount of time merging:
&gt; 2016-06-10 05:27:39.426 UTC [info] &lt;0.15230.160&gt; Merged
&gt; {["/var/lib/riak/bitcask/890602560248518965780370444936484965102833893376/84000.bitcask.data","/var/lib/riak/bitcask/890602560248518965780370444936484965102833893376/83999.bitcask.data"],[]}
&gt; in 11.902028 seconds.
&gt;
&gt; But here's one from today on the problematic node:
&gt; 2016-06-15 17:13:40.626 UTC [info] &lt;0.17903.500&gt; Merged
&gt; {["/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83633.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83632.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83631.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83630.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83629.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83628.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83627.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83626.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83625.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83624.bitcask.data","/var/lib/riak/bitcask/12331420064979493372343590776043637978346
 
93083136/83623.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83622.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83621.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83620.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83619.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83618.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83617.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83616.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83615.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83614.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83613.bitcask.data","/var/lib/riak/bitcask/123314200649794
 93372343590776043637978346930...",...],...}
&gt; in 220.186043 seconds.
&gt;
&gt; It's not just that it takes 20x longer to merge, but it seems to be doing a
&gt; lot more files at once.
&gt;
&gt; What is going on?
&gt;
&gt; I'm not sure how much of the app.config is relevant, but I'll at least paste
&gt; just the bitcask and merge sections for now:
&gt; {bitcask, [
&gt; {data\_root, "/var/lib/riak/bitcask"},
&gt; {dead\_bytes\_merge\_trigger, 268435456},
&gt; {dead\_bytes\_threshold, 67108864},
&gt; {frag\_merge\_trigger, 60},
&gt; {frag\_threshold, 40},
&gt; {io\_mode, erlang},
&gt; {max\_file\_size, 1073741824},
&gt; {small\_file\_threshold, 134217728}
&gt; ]},
&gt; {merge\_index, [
&gt; {buffer\_rollover\_size, 1048576},
&gt; {data\_root, "/var/lib/riak/merge\_index"},
&gt; {max\_compact\_segments, 20}
&gt; ]},
&gt;
&gt;
&gt; Thanks for any insight,
&gt; johnny
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

