---
title: "RE: Riak Bitcask merging"
description: ""
project: community
lastmod: 2011-08-23T01:48:40-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04416"
mailinglist_parent_id: "msg04405"
author_name: "Nathan Wilken"
project_section: "mailinglistitem"
sent_date: 2011-08-23T01:48:40-07:00
---


How about this?

#!/bin/sh
...
for i in data/expiring\_bitcask/\* ; do $ERTS\_PATH/to\_erl $PIPE\_DIR&lt;From app.config:
 {&lt;&lt;"expiring\_bitcask"&gt;&gt;, riak\_kv\_bitcask\_backend, [
 {expiry\_secs, 86400},
 {max\_file\_size, 134217728},
 {dead\_bytes\_merge\_trigger, 10485760},
 {dead\_bytes\_threshold, 10485760},
 {small\_file\_threshold, 16#80000000},
 {merge\_window, {1, 5}},
 {data\_root, "data/expiring\_bitcask"}

I use dead-byte trigger and threshold values of 0 for manual merges in order to 
force a merge, and 10mb values in the config to avoid continual merging during 
my overnight window.

Does this make sense? I'd have thought my app.config would keep the bitcasks 
small, but it seems they just grow bigger and never get cleared of much expired 
data. The manual config I use above immediately shrinks the data files 
dramatically.

Any suggestions for a cleaner approach?

-Nate



\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
From: riak-users-boun...@lists.basho.com [riak-users-boun...@lists.basho.com] 
On Behalf Of Anthony Molinaro [antho...@alumni.caltech.edu]
Sent: Monday, August 22, 2011 10:18 AM
To: Dan Reverri
Cc: raghwani sohil; riak-users@lists.basho.com
Subject: Re: Riak Bitcask merging

While I didn't ask this time, I'll explain why I think manual
merging as an option would be great.

As far as I know specifying a merge window doesn't guarantee the
merging happens, only that it might if other thresholds are met.

With our cassandra cluster we've ended up scheduling twice weekly
full compactions (the close equivalent to merging I believe), via
cron. The days and times are specificaly chosen based on traffic
patterns, and can be changed without restarting the servers.

We don't have this convenience with riak. We can set it up to only
merge during a window, but can't guarantee everything was merged
or even that any merges will occur. If I wanted to change when I
do the merging, I have to restart the servers to pick up the new
config (at least I think I would). I have no way to stagger the
merging (have different nodes merge at different times), unless
I have slightly different config on each node.

If there were a riak-admin command called merge/compact/cleanup/expire
or something which triggered a manual merge I know we would use it.

And while I'm pining for additional command line tools, any idea if
transfers will ever work without disrupting the actual transfers?
It's sort of annoying that it's listed as one of the steps for a
rolling upgrade/restart but if you actually use it, it can cause
upgrade or startup to take longer. Also, it tends to timeout on
a highly trafficked cluster.

Anyway, sorry about hijacking someone else's question, but
figured more information from users is usually welcome?

-Anthony

On Mon, Aug 22, 2011 at 09:14:06AM -0700, Dan Reverri wrote:
&gt; There is no way to manually trigger a Bticask merge. What's the use case for
&gt; needing to manually trigger the merge? Are you concerned about the size of
&gt; the data files? Are you trying to avoid merging at a particular time?
&gt;
&gt; Not sure if this will help but you can restrict Bitcask merging to a
&gt; specified window of time:
&gt; http://wiki.basho.com/Bitcask-Configuration.html#Merge-Window
&gt;
&gt; Thanks,
&gt; Dan
&gt;
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt; On Sun, Aug 21, 2011 at 11:36 PM, raghwani sohil wrote:
&gt;
&gt; &gt;
&gt; &gt; Hi All,
&gt; &gt;
&gt; &gt; Is there any way to run bitcask merging process manually ?
&gt; &gt;
&gt; &gt; thanks ,
&gt; &gt; Sohil Raghwani .
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt;

&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


--
------------------------------------------------------------------------
Anthony Molinaro 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

