---
title: "Re: [CRDT_OP-in-CommitHook]"
description: ""
project: community
lastmod: 2017-03-02T18:24:33-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18056"
mailinglist_parent_id: "msg18053"
author_name: "李明"
project_section: "mailinglistitem"
sent_date: 2017-03-02T18:24:33-08:00
---


Thanks a lot Russell,
 The problem was fixed now, i am trying to do a testing about how fast
it could be using external and internal API.

2017-03-02 18:05 GMT+08:00 :

&gt; Hi
&gt;
&gt; With regard to creating a serial actor, that is what vnodes are.
&gt;
&gt;
&gt;
&gt; For your hook, if you need the context, then keep the C:get, but for the
&gt; PUT just send the crdt\_op, almost exactly as per
&gt; https://github.com/basho/riak\_kv/blob/develop/src/riak\_kv\_pb\_crdt.erl#L162
&gt; .
&gt;
&gt;
&gt;
&gt; O = riak\_kv\_crdt:new({BType, B}, Key, Mod),
&gt;
&gt; CrdtOp = #crdt\_op{mod=Mod, op=Op, ctx=Ctx},
&gt;
&gt; Options = [{crdt\_op, CrdtOp},
&gt;
&gt; {retry\_put\_coordinator\_failure, false}],
&gt;
&gt; Resp = C:put(O, Options),
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; Where Mod is riak\_dt\_orswot, should be enough for you to imitate a CRDT
&gt; operation API call from your hook. DO NOT update the fetched CRDT, let
&gt; Riak’s vnode do that.
&gt;
&gt;
&gt;
&gt; Let Riak handle the serial actor bit. You just send the crdt\_op populated
&gt; with the operation and context.
&gt;
&gt;
&gt;
&gt; Like I said in my last email, IF folk want to use CRDTs from hooks then
&gt; there should be an internal API that enables it. If you create an issue for
&gt; that on github I’d quite enjoy writing the code and raising a PR. I no
&gt; longer work at Basho, but since Riak is open source and I’m very fond of
&gt; the CRDT feature, I’m sure they’d appreciate the contribution.
&gt;
&gt;
&gt;
&gt; Cheers
&gt;
&gt;
&gt;
&gt; Russell
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; \*From:\* riak-users [mailto:riak-users-boun...@lists.basho.com] \*On Behalf
&gt; Of \*??
&gt; \*Sent:\* 02 March 2017 09:50
&gt; \*To:\* Russell Brown
&gt; \*Cc:\* riak-users
&gt; \*Subject:\* Re: [CRDT\_OP-in-CommitHook]
&gt;
&gt;
&gt;
&gt; Thanks Russell,
&gt;
&gt; Yes, it was a big trouble using the internal api, especially with very
&gt; few knowledge about erlang.
&gt;
&gt; Have read the riak\_kv\_pb\_crdt, but it confused me a lot. How to define a 
&gt; serial
&gt; actor and is there a simple example creating an `riak\_client:put` option
&gt; object?
&gt;
&gt;
&gt;
&gt; The reason why i need to use the internal API is i believed it will bring
&gt; less performance loss than trying to create a new client which may be more 
&gt; convenient,
&gt; we are running a very heavy riak cluster and i want to keep the hook
&gt; working lightly.
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; 2017-03-02 16:32 GMT+08:00 Russell Brown :
&gt;
&gt; Hi,
&gt;
&gt; You’re using internal details of the CRDT implementation, I’m not sure
&gt; that is such a great idea. You always have your `Context` set to
&gt; `undefined` but if your ops are all adds that shouldn’t matter in this case.
&gt;
&gt; The issue is that you’re calling `riak\_kv\_crdt:update` that needs to be
&gt; called from within the vnode. The `ThisNode` value is not a serial actor,
&gt; so you may have many concurrent updates with the actor `ThisNode`, and
&gt; that’s not how to do it. It is crucial that the actor updating the CRDT
&gt; acts in serial issuing an increasing count of events. Thats why we put the
&gt; CRDT code inside Riak, inside the vnode.
&gt;
&gt; You’re doing neither one thing nor the other, in that your using a
&gt; datatype bucket but not the datatype API (it sends Ops from the client,
&gt; you’re doing read/modify/write.)
&gt;
&gt; I can see the issue here is that the API is external only, if you \_must\_
&gt; use the internal API have a look at https://github.com/basho/riak\_
&gt; kv/blob/develop/src/riak\_kv\_pb\_crdt.erl and you see that the CRDT\_OP is
&gt; all that is sent by the client.
&gt;
&gt; https://github.com/basho/riak\_kv/blob/develop/src/riak\_kv\_pb\_crdt.erl#L162
&gt;
&gt; Those put options matter too, especially for counters, less so for sets.
&gt;
&gt; I guess it would be great if riak\_client had some internal API functions
&gt; that made this easier to do from a hook. If you open an issue on
&gt; github.com/basho/riak\_kv I can look into that and make a PR.
&gt;
&gt; Hope that helps
&gt;
&gt; Russell
&gt;
&gt;
&gt; On 1 Mar 2017, at 09:30, 李明  wrote:
&gt;
&gt; &gt; Hi
&gt; &gt; I am new to erlang and riak. I started to use riak as a kv store
&gt; couple of months ago. Now i want to implement a commit hook to riak so that
&gt; riak could help me to make some statistics.
&gt; &gt; i read some docs and write a pre-hook scripts, which will fetch the
&gt; object key and store it into a set.
&gt; &gt; This hook works fine if there is only one client write to riak, but
&gt; if i increase the connection to riak writing, i found it lost some elements
&gt; in the set. Looks like the crdt\_op did not do the merge operation.And there
&gt; is no obvious error in the log files.
&gt; &gt;
&gt; &gt; Could someone help me to finger out what happened or what i has
&gt; missed.
&gt; &gt;
&gt; &gt; i am using the riak 2.1.3
&gt; &gt;
&gt; &gt; Thanks all!
&gt; &gt;
&gt; &gt;
&gt; &gt; Here is the hook scripts:
&gt; &gt;
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt; -module(myhook).
&gt; &gt; -export([pretest/1]).
&gt; &gt;
&gt; &gt; now\_to\_local\_string({MegaSecs, Secs, MicroSecs}) -&gt;
&gt; &gt; LocalTime = calendar:now\_to\_local\_time({MegaSecs, Secs, MicroSecs}),
&gt; &gt; {{Year, Month, Day}, {Hour, Minute, \_}} = LocalTime,
&gt; &gt; TimeStr = lists:flatten(io\_lib:format("~
&gt; 4..0w~2..0w~2..0w~2..0w~2..0w",
&gt; &gt; [Year, Month, Day, Hour, Minute])),
&gt; &gt; TimeStr.
&gt; &gt;
&gt; &gt; is\_deleted(Object)-&gt;
&gt; &gt; case dict:find(&lt;&lt;"X-Riak-Deleted"&gt;&gt;,riak\_object:get\_metadata(Object))
&gt; of
&gt; &gt; {ok,\_} -&gt;
&gt; &gt; true;
&gt; &gt; \_ -&gt;
&gt; &gt; false
&gt; &gt; end.
&gt; &gt;
&gt; &gt; pretest(Object) -&gt;
&gt; &gt; % timer:sleep(10000),
&gt; &gt; try
&gt; &gt; ObjBucket = riak\_object:bucket(Object),
&gt; &gt; % riak\_object:bucket(Obj).
&gt; &gt; % {&lt;&lt;"cn-archive"&gt;&gt;,&lt;&lt;"local-test"&gt;&gt;}
&gt; &gt;
&gt; &gt; Bucket = element(2, ObjBucket),
&gt; &gt; BucketType = element(1, ObjBucket),
&gt; &gt;
&gt; &gt; ObjKey = riak\_object:key(Object),
&gt; &gt; % Key = binary\_to\_list(ObjKey),
&gt; &gt; % ObjData = riak\_object:get\_value(Object),
&gt; &gt; % Msg = binary\_to\_list(ObjData),
&gt; &gt; CommitItem = iolist\_to\_binary(mochijson2:encode({struct, [{b,
&gt; Bucket}, {k, ObjKey}, {t, BucketType}]})),
&gt; &gt;
&gt; &gt; case is\_deleted(Object) of
&gt; &gt; true -&gt;
&gt; &gt; KeyPrefix = "delete";
&gt; &gt; \_ -&gt;
&gt; &gt; KeyPrefix = "update"
&gt; &gt; end,
&gt; &gt;
&gt; &gt; CurMin = now\_to\_local\_string(os:timestamp()),
&gt; &gt; IndexKey = binary:list\_to\_bin(io\_lib:format("~s-~s", [CurMin,
&gt; KeyPrefix])),
&gt; &gt;
&gt; &gt; %% Get a riak client
&gt; &gt; {ok, C} = riak:local\_client(),
&gt; &gt; % get node obj
&gt; &gt; ThisNode = atom\_to\_binary(node(), latin1),
&gt; &gt;
&gt; &gt; % get index obj and set context
&gt; &gt; BType = &lt;&lt;"archive"&gt;&gt;,
&gt; &gt; B = &lt;&lt;"local-test"&gt;&gt;,
&gt; &gt;
&gt; &gt; {SetObj, Context} = case C:get({BType, B}, IndexKey) of
&gt; &gt; {error, notfound} -&gt;
&gt; &gt; ThisSetObj = riak\_kv\_crdt:new({BType, B},
&gt; IndexKey, riak\_dt\_orswot),
&gt; &gt; {ThisSetObj, undefined};
&gt; &gt; {ok, ThisSetObj} -&gt;
&gt; &gt; % The datatype update requires the context if the
&gt; value exists
&gt; &gt; {{Ctx, \_}, \_} = riak\_kv\_crdt:value(ThisSetObj,
&gt; riak\_dt\_orswot),
&gt; &gt; {ThisSetObj, Ctx}
&gt; &gt; end,
&gt; &gt;
&gt; &gt; UpdateIndex = [{add, CommitItem}],
&gt; &gt; % UpdateOp = {crdt\_op, riak\_dt\_orswot, {update,
&gt; UpdateIndex}, Context},
&gt; &gt; UpdateOp = {crdt\_op, riak\_dt\_orswot, {update,
&gt; UpdateIndex}, undefined},
&gt; &gt; NewObj = riak\_kv\_crdt:update(SetObj, ThisNode, UpdateOp),
&gt; &gt;
&gt; &gt; error\_logger:info\_msg("Updating index for ~s,to set
&gt; ~s~n", [binary:bin\_to\_list(CommitItem), IndexKey]),
&gt; &gt;
&gt; &gt; C:put(NewObj),
&gt; &gt; Object
&gt; &gt; catch
&gt; &gt; error:Error -&gt;
&gt; &gt; {fail, lists:flatten(io\_lib:format("[
&gt; PREHOOKEXCEPTION]~p",[Error]))}
&gt; &gt; end.
&gt; &gt;
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt;
&gt; &gt; This is the set bucket props
&gt; &gt; ------------------------------------------------------------
&gt; ------------------------------------------
&gt; &gt;
&gt; &gt; active: true
&gt; &gt; allow\_mult: true
&gt; &gt; basic\_quorum: false
&gt; &gt; big\_vclock: 50
&gt; &gt; chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
&gt; &gt; claimant: 'riak@192.168.100.2'
&gt; &gt; datatype: set
&gt; &gt; dvv\_enabled: true
&gt; &gt; dw: quorum
&gt; &gt; last\_write\_wins: false
&gt; &gt; linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
&gt; &gt; n\_val: 3
&gt; &gt; notfound\_ok: true
&gt; &gt; old\_vclock: 86400
&gt; &gt; postcommit: []
&gt; &gt; pr: 0
&gt; &gt; precommit: []
&gt; &gt; pw: 0
&gt; &gt; r: quorum
&gt; &gt; rw: quorum
&gt; &gt; small\_vclock: 50
&gt; &gt; w: quorum
&gt; &gt; young\_vclock: 20
&gt; &gt;
&gt; &gt;
&gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt; This email and any files transmitted with it are confidential and contain
&gt; information which may be privileged or confidential and are intended solely
&gt; to be for the use of the individual(s) or entity to which they are
&gt; addressed. If you are not the intended recipient be aware that any
&gt; disclosure, copying, distribution or use of the contents of this
&gt; information is strictly prohibited and may be illegal. If you have received
&gt; this email in error, please notify us by telephone or email immediately and
&gt; delete it from your system. Activity and use of our email system is
&gt; monitored to secure its effective operation and for other lawful business
&gt; purposes. Communications using this system will also be monitored and may
&gt; be recorded to secure effective operation and for other lawful business
&gt; purposes. Internet emails are not necessarily secure. We do not accept
&gt; responsibility for changes made to this message after it was sent. You are
&gt; advised to scan this message for viruses and we cannot accept liability for
&gt; any loss or damage which may be caused as a result of any computer virus.
&gt;
&gt; This email is sent by a bet365 group entity. The bet365 group includes the
&gt; following entities: Hillside (Shared Services) Limited (registration no.
&gt; 3958393), Hillside (Spain New Media) Plc (registration no. 07833226),
&gt; bet365 Group Limited (registration no. 4241161), Hillside (Technology)
&gt; Limited (registration no. 8273456), Hillside (Media Services) Limited
&gt; (registration no. 9171710), Hillside (Trader Services) Limited
&gt; (registration no. 9171598) each registered in England and Wales with a
&gt; registered office address at bet365 House, Media Way, Stoke-on-Trent, ST1
&gt; 5SZ, United Kingdom; Hillside (Gibraltar) Limited (registration no. 97927),
&gt; Hillside (Sports) GP Limited (registration no. 111829) and Hillside
&gt; (Gaming) GP Limited (registered no. 111830) each registered in Gibraltar
&gt; with a registered office address at Unit 1.1, First Floor, Waterport Place,
&gt; 2 Europort Avenue, Gibraltar; Hillside (UK Sports) LP (registration no.
&gt; 117), Hillside (Sports) LP (registration no. 118), Hillside (International
&gt; Sports) LP (registration no. 119), Hillside (Gaming) LP (registration no.
&gt; 120) and Hillside (International Gaming) LP (registration no. 121) each
&gt; registered in Gibraltar with a principal place of business at Unit 1.1,
&gt; First Floor, Waterport Place, 2 Europort Avenue, Gibraltar; Hillside España
&gt; Leisure S.A (CIF no. A86340270) registered in Spain with a registered
&gt; office address at C/ Conde de Aranda nº20, 2º, 28001 Madrid, Spain;
&gt; Hillside (Australia New Media) Pty Limited (registration no. 148 920 665)
&gt; registered in Australia with a registered office address at Level 4, 90
&gt; Arthur Street, North Sydney, NSW 2060, Australia; Hillside (New Media
&gt; Malta) Limited, (registration no c.66039) registered in Malta with a
&gt; registered office address at Office 1/2373, Level G, Quantum House, 75
&gt; Abate Rigord Street, Ta’ Xbiex XBX 1120, Malta and Hillside (New Media
&gt; Cyprus) Limited, (registration no. HE 361612) registered in Cyprus with a
&gt; registered office address at Omrania Centre, 313, 28th October Avenue, 3105
&gt; Limassol, Cyprus. Hillside (Shared Services) Limited, Hillside (Spain New
&gt; Media) Plc and Hillside (New Media Malta) Limited also have places of
&gt; business at Unit 1.1, First Floor, Waterport Place, 2 Europort Avenue,
&gt; Gibraltar. For residents of Greece, this email is sent on behalf of B2B
&gt; Gaming Services (Malta) Limited (registration number C41936) organised
&gt; under the laws of Malta with a registered office at Apartment 21, Suite 41,
&gt; Charles Court, St. Luke's Road, Pietà, Malta.
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

