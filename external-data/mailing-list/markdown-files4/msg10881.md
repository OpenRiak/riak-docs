---
title: "Re: Using Riak to perform aggregate queries"
description: ""
project: community
lastmod: 2013-04-14T19:42:48-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10881"
mailinglist_parent_id: "msg10879"
author_name: "Evan Vigil-McClanahan"
project_section: "mailinglistitem"
sent_date: 2013-04-14T19:42:48-07:00
---


The most common issue with large MapReduce jobs is one of the nodes
starting to swap (typically the node the request was made on).

Streaming results and pre-reduction[0] (where applicable) can often
lower the memory overhead of running MapReduce jobs on large numbers
of objects.

That would be the first thing I would check. Also potentially
applicable: 
http://docs.basho.com/riak/latest/cookbooks/Linux-Performance-Tuning/


0: 
http://docs.basho.com/riak/1.1.4/references/appendices/MapReduce-Implementation/,
pre-reduce is down at the bottom.



On Sun, Apr 14, 2013 at 6:47 PM, Chris Corbyn  wrote:
&gt; All,
&gt;
&gt; Just copying this from my stackoverflow post, as the riak tag doesn't get
&gt; much love over there :) It's fine to just outright say that Riak is never
&gt; going to work efficiently in this case because I'm inherently depending on
&gt; MapReduce.
&gt;
&gt; Everywhere I read, people say you shouldn't use Riak's MapReduce over an
&gt; entire bucket and that there are other ways of achieving your goals. I'm not
&gt; sure how, though. I'm also not clear on why using an entire bucket is slow,
&gt; if you only have one bucket in the entire system, so either way, you need to
&gt; go over all the entries. Passing in a list of key-bucket pairs has the same
&gt; effect. Maybe the rule should be "don't use MapReduce with more than a
&gt; handful of keys". Which makes me wonder (apart from link traversal) what use
&gt; it really has in the real world.
&gt;
&gt; I have a list of 500K+ documents that represent sales data. I need to view
&gt; this data in different ways: for example, how much revenue was made in each
&gt; month the business was operating? How much revenue did each product raise?
&gt; How many of each product were sold in a given month? I always thought
&gt; MapReduce was supposed to be good at solving these types of aggregate
&gt; problems. That sounds like a myth now though, unless we're just looking at
&gt; Hadoop.
&gt;
&gt; My documents are all in a bucket named 'sales' and they are records with the
&gt; following fields (as native Erlang records, not JSON):
&gt;
&gt; {"id":1, "product\_key": "cyber-pet-toy", "price": "10.00", "tax":
&gt; "1.00", "created\_at": 1365931758}.
&gt;
&gt; Let's take the example where I need to report the total revenue for each
&gt; product in each month over the past 4 years (that's basically the entire
&gt; bucket, but that's just the requirement), how does one use Riak's MapReduce
&gt; to do that efficiently? Even just trying to use an identity map operation on
&gt; the data I get a timeout after ~30 seconds, which MySQL handles in
&gt; milliseconds.
&gt;
&gt; I'm doing this in Erlang (using the protocol buffers client), but any
&gt; language is fine for an explanation.
&gt;
&gt; The equivalent SQL (MySQL) would be:
&gt;
&gt; SELECT SUM(price) AS revenue,
&gt; FROM\_UNIXTIME(created\_at, '%Y-%m') AS month,
&gt; product\_key
&gt; FROM sales
&gt; GROUP BY month, product\_key
&gt; ORDER BY month ASC;
&gt;
&gt; Even with secondary indexes, there's still a MapReduce involved in this
&gt; query, once you have the list of keys to process.
&gt;
&gt; (Ordering not important right now).
&gt;
&gt; Cheers,
&gt;
&gt; Chris
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

