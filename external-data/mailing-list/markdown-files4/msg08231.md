---
title: "Re: Riak Search pre-commit hook"
description: ""
project: community
lastmod: 2012-08-08T14:02:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08231"
mailinglist_parent_id: "msg08229"
author_name: "Mark Volkmann"
project_section: "mailinglistitem"
sent_date: 2012-08-08T14:02:09-07:00
---


On Wed, Aug 8, 2012 at 1:56 PM, Mark Volkmann wrote:

&gt; I'm trying to learn how to configure Riak Search to automatically index
&gt; documents added to a given bucket. I have four nodes in my cluster. Here is
&gt; what I tried:
&gt;
&gt; \* modified etc/app.config for each node to set {enabled, true} in the
&gt; riak\_search section
&gt; \* stopped and restarted the cluster
&gt; \* cd'ed to the bin directory of the first node in the cluster and entered
&gt; "./search-cmd install users"
&gt; \* entered "curl http://localhost:8091/riak/users" to verify that the
&gt; pre-commit hook was added
&gt; I see this in the middle of the output:
&gt; "precommit": [
&gt; {
&gt; "mod": "riak\_search\_kv\_hook",
&gt; "fun": "precommit"
&gt; }
&gt; ],
&gt; \* added a document to the users bucket with this command:
&gt; curl -XPUT http://localhost:8091/buckets/users/keys/1234 -H
&gt; 'Content-type: application/json' -d '{name: "Joe", address: {street: "123
&gt; Some Street", zip: 12345}}'
&gt;
&gt; The output is below. Notice the "hook\_crashed" part.
&gt;
&gt; 500 Internal Server
&gt; ErrorInternal Server Error
=====================

The server
&gt; encountered an error while processing this request:  

```
{error,
&gt;     {error,badarg,
&gt;         [{erlang,iolist_to_binary,
&gt;              [{hook_crashed,
&gt;                   {riak_search_kv_hook,precommit,error,function_clause}}],
&gt;              []},
&gt;          {wrq,append_to_response_body,2,[{file,"src/wrq.erl"},{line,204}]},
&gt;          {riak_kv_wm_object,handle_common_error,3,
&gt;              [{file,"src/riak_kv_wm_object.erl"},{line,974}]},
&gt;          {webmachine_resource,resource_call,3,
&gt;              [{file,"src/webmachine_resource.erl"},{line,169}]},
&gt;          {webmachine_resource,do,3,
&gt;              [{file,"src/webmachine_resource.erl"},{line,128}]},
&gt;          {webmachine_decision_core,resource_call,1,
&gt;              [{file,"src/webmachine_decision_core.erl"},{line,48}]},
&gt;          {webmachine_decision_core,accept_helper,0,
&gt;              [{file,"src/webmachine_decision_core.erl"},{line,583}]},
&gt;          {webmachine_decision_core,decision,1,
&gt;
&gt;  
&gt; [{file,"src/webmachine_decision_core.erl"},{line,554}]}]}}
```


---

mochiweb+webmachine
&gt; web server


&gt;
&gt; What am I doing wrong?
&gt;

I have it working now. Here's what I had to do.

1) Define a schema file for my bucket.
2) Set it with "./search-cmd set-schema {bucket-name} {file-path}".
3) Learn that when referencing nested fields in JSON structures, all
ancestor names must be included and separated with underscores. I didn't
see that in any documentation, but learned it from the presentation video
at http://nosql.mypopescu.com/post/5475701359/riak-search-explained.
4) When PUTing JSON, put double-quotes around keys. It's JSON, not
JavaScript literal object syntax.

Here's the schema I created. Note the field name "address\_zip".

%% Schema for 'users'
{
 schema,
 [
 {version, "1.1"},
 {n\_val, 3},
 {default\_field, "name"},
 {analyzer\_factory, {erlang, text\_analyzers,
whitespace\_analyzer\_factory}}
 ],
 [
 %% Field named "zip" is are indexed as integer
 {field, [
 {name, "address\_zip"},
 {type, integer},
 {analyzer\_factory, {erlang, text\_analyzers, integer\_analyzer\_factory}}
 ]},

 %% Everything else is a string
 {dynamic\_field, [
 {name, "\*"},
 {type, string},
 {analyzer\_factory, {erlang, text\_analyzers,
whitespace\_analyzer\_factory}}
 ]}
 ]
}.

I hope this helps someone in the future!

-- 
R. Mark Volkmann
Object Computing, Inc.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

