---
title: "Re: Riak Map / Reduce / Map capacity limit reached at 20000 keys"
description: ""
project: community
lastmod: 2012-05-21T13:01:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07496"
mailinglist_parent_id: "msg07494"
author_name: "Matthew Tovbin"
project_section: "mailinglistitem"
sent_date: 2012-05-21T13:01:07-07:00
---


Claude,

1.
try to increase js\_vm\_counts as follows:

{riak\_kv, [
 ...
 {map\_js\_vm\_count, 24 },
 {reduce\_js\_vm\_count, 18 },
 ...]

2. optimize your js function:
query.map("""function(v) {if (v.values[0].data.search(
'"""+search\_string+"""') != -1) { return [[v.key, 1]]; } return []; }""")
query.reduce("function(v) { return [v.reduce(function(acc,value){return acc
+ value;},0]; } ")


-Matthew



On Mon, May 21, 2012 at 10:02 AM,  wrote:

&gt; Dear colleagues,
&gt;
&gt; During my pilot testing I've got an error message during a text pattern
&gt; search operation coded as a Riak Client "map" logic. This error appeared at
&gt; a volume of approximately 20.000 keys, each with an 1 KB free text data
&gt; block associated. The Map function was coded in JavaScript. Here the
&gt; source:
&gt;
&gt; query.map("""function(v) { var str = '"""+search\_string+"""'; var data =
&gt; JSON.parse(v.values[0].data); if (v.values[0].data.toString().search(str)
&gt; != -1) { return [[v.key, data]]; } return []; }""")
&gt; query.reduce("function(v) { var counteri = 0; for(var i in v) {counteri
&gt; += 1;} return [['counter\_found', counteri]]; } ")
&gt;
&gt; The error shown is the following : \*[preflist\_exhausted]\*
&gt;
&gt; zbra:/opt/python/myprojects/riak # python pilot3.py
&gt; starts at : 2012-05-21 07:35:49.070470
&gt; How many keys in the bucket: 19760
&gt; Riak client exception: Error running MapReduce operation. Status: 500 :
&gt; {"phase":0,"error":"[preflist\_exhausted]","input":"{ok,{r\_object,&lt;&lt;\"ramtest\"&gt;&gt;,&lt;&lt;\"XDHt25887344\"&gt;&gt;,[{r\_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[&lt;&lt;\"Links\"&gt;&gt;]],[],[],[],[],[],[],[],[[&lt;&lt;\"content-type\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\"X-Riak-VTag\"&gt;&gt;,53,86,72,48,120,77,53,99,114,86,111,77,77,54,109,114,79,70,54,52,49,109]],[[&lt;&lt;\"index\"&gt;&gt;]],[],[[&lt;&lt;\"X-Riak-Last-Modified\"&gt;&gt;|{1337,595548,374416}]],[],[[&lt;&lt;\"X-Riak-Meta\"&gt;&gt;]]}}},&lt;&lt;\"{\"is\_valid\":
&gt; true, \"cEDO\":
&gt; \"GQZumfdWBCfX...\"&gt;&gt;}],...},...}","type":"forward\_preflist","stack":"[]"}
&gt;
&gt; Any suggestions how to improve the pattern scan capability in the in the
&gt; RiakClient map function, or how enhance the JavaScript code for better
&gt; capacity?
&gt; Are there any servers setup tuning options to adjust?
&gt;
&gt; Thanks in advance for your support.
&gt;
&gt; Regards,
&gt; Claude
&gt; \*
&gt; Claude Falbriard
&gt; Certified IT Specialist L2 - Middleware
&gt; AMS Hortol√¢ndia / SP - Brazil
&gt; phone: +55 19 9837 0789
&gt; cell: +55 13 8117 3316
&gt; e-mail: clau...@br.ibm.com
&gt; \*
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

