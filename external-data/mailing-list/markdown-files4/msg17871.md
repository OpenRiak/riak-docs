---
title: "Re: Crash Log: yz_anti_entropy"
description: ""
project: community
lastmod: 2017-01-19T06:23:51-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17871"
mailinglist_parent_id: "msg17870"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2017-01-19T06:23:51-08:00
---


Damion,

I will explain what happened. 

ring\_size = 8: The default ring\_size is 64. It is based on the recommendation 
of five servers for a minimum cluster. You stated you are using only one 
machine. 64 divided by 5 is 12.8 vnodes per server ... and ring size needs to 
be a power of 2. So next smaller power of 2 from 12 is 8.

leveldb.limited\_developer\_mem = on: leveldb allocates certain memory buffer 
size per vnode (ring\_size). This setting reduces the size of those buffers by 
10x. 

The two settings squash the memory requirements to give you a better 
opportunity for happiness with both search and riak on a single server.

Matthew



&gt; On Jan 19, 2017, at 9:15 AM, Junk, Damion A  wrote:
&gt; 
&gt; Matthew -
&gt; 
&gt; That did it! 
&gt; 
&gt; Actually, I tried with both settings, and also with just the ring\_size 
&gt; change. 
&gt; 
&gt; Setting ring\_size to 8 got rid of crashing. I'll have to do a bit more 
&gt; reading on this setting I suppose. I have a much more memory-constrained 
&gt; virtual machine running on my local desktop running with just the default 
&gt; install settings and no crashing. 
&gt; 
&gt; Thanks!
&gt; 
&gt; Damion
&gt; 
&gt;&gt; On Jan 19, 2017, at 7:57 AM, Matthew Von-Maszewski &gt; &gt; wrote:
&gt;&gt; 
&gt;&gt; Damion,
&gt;&gt; 
&gt;&gt; Add the following settings within riak.conf:
&gt;&gt; 
&gt;&gt; leveldb.limited\_developer\_mem = on
&gt;&gt; ring\_size = 8
&gt;&gt; 
&gt;&gt; Erase all data / vnodes and start over.
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt;&gt; On Jan 19, 2017, at 8:51 AM, Junk, Damion A &gt;&gt; &gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Hi Magnus -
&gt;&gt;&gt; 
&gt;&gt;&gt; I've tried a wide range of parameters for leveldb.maximum\_memory\_percent 
&gt;&gt;&gt; ranging from 5 to 70. I also tried the leveldb.maximum\_memory setting in 
&gt;&gt;&gt; bytes, ranging from 500MB to 4GB. I get the same results in the 
&gt;&gt;&gt; crash/console log no matter what the settings. But the log messages seem to 
&gt;&gt;&gt; indicate an issue with yokozuna, and not leveldb itself from what I can 
&gt;&gt;&gt; tell.
&gt;&gt;&gt; 
&gt;&gt;&gt; I set the max (-Xmx) to 2G for SOLR as well.
&gt;&gt;&gt; 
&gt;&gt;&gt; From the log messages, it looks like it's not actually the KV leveldb 
&gt;&gt;&gt; system that's crashing, but the yokozuna system. I'm not sure how to 
&gt;&gt;&gt; control or set memory here:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {badmatch,{error,{db\_open,"IO error: lock 
&gt;&gt;&gt;&gt; /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
&gt;&gt;&gt;&gt; Cannot allocate memory"}
&gt;&gt;&gt; 
&gt;&gt;&gt; This is a development node, running as a single (nojn-clustered) riak node. 
&gt;&gt;&gt; It has 14G memory, and at the time of trying changes with Riak, 9GB were 
&gt;&gt;&gt; free. 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; To Recap:
&gt;&gt;&gt; 
&gt;&gt;&gt; There are no keys/values in the database at all. 
&gt;&gt;&gt; The only default settings I changed were:
&gt;&gt;&gt; 
&gt;&gt;&gt; storage\_backend = leveldb
&gt;&gt;&gt; search = on
&gt;&gt;&gt; 
&gt;&gt;&gt; and when that didn't work, I started changing:
&gt;&gt;&gt; 
&gt;&gt;&gt; search.solr.jvm\_options = -d64 -Xms1g -Xmx2g -XX:+UseStringCache 
&gt;&gt;&gt; -XX:+UseCompressedOops
&gt;&gt;&gt; leveldb.maximum\_memory\_percent = 5 .. 70 
&gt;&gt;&gt; 
&gt;&gt;&gt; and then when nothing seemed to change:
&gt;&gt;&gt; 
&gt;&gt;&gt; leveldb.maximum\_memory = 1000000 ... 4000000000
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks for any assistance!
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Damion
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Jan 19, 2017, at 3:33 AM, Magnus Kessler &gt;&gt;&gt; &gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Hi Damion,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Let me first state that AAE always uses leveldb, regardless of the storage 
&gt;&gt;&gt;&gt; backend chosen for Riak KV data. Could you please state how much physical 
&gt;&gt;&gt;&gt; memory your Riak nodes have, and what you have configured for 
&gt;&gt;&gt;&gt; "leveldb.maximum\_memory.percent" in "riak.conf"? Have you changed the 
&gt;&gt;&gt;&gt; settings for "search.solr.jvm\_options", in particular the memory allocated 
&gt;&gt;&gt;&gt; to Solr?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; As a general rule, leveldb should have at least 350MB of memory available 
&gt;&gt;&gt;&gt; per partition, and performance has been shown to increase with up to 2GB 
&gt;&gt;&gt;&gt; (2.5 GB when also using Search and AAE) per partition. Please check that 
&gt;&gt;&gt;&gt; you have enough memory available in your system.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Kind Regards,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Magnus
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;&gt;&gt; 
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com 
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com 
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

