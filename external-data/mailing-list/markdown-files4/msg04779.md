---
title: "Re: Precommit Hook Difficulties"
description: ""
project: community
lastmod: 2011-09-19T11:42:33-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04779"
mailinglist_parent_id: "msg04777"
author_name: "Greg Pascale"
project_section: "mailinglistitem"
sent_date: 2011-09-19T11:42:33-07:00
---


Scratch that - the issue doesn't actually manifest without the
decode/encode.

On Mon, Sep 19, 2011 at 10:47 AM, Greg Pascale  wrote:

&gt; Actually it looks like I can remove the JSON decode/encode and I still see
&gt; the same issue. Just reading and writing the value is enough, so all I'm
&gt; doing now is
&gt;
&gt; \*precommit(RiakObject) -&gt;\*
&gt; \* Value = riak\_object:get\_value(RiakObject),\*
&gt; \* riak\_object:apply\_updates(\*
&gt; \* riak\_object:update\_value(RiakObject, Value)).\*
&gt;
&gt; I'm really baffled here. The only documentation I know of for this code is
&gt; at
&gt; http://basho.github.com/riak-erlang-client/riak-erlang-client/riakc\_obj.html 
&gt; and
&gt; it really doesn't say much.
&gt;
&gt; -Greg
&gt; Clipboard
&gt;
&gt; On Sat, Sep 17, 2011 at 4:11 PM, Greg Pascale  wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; I'm trying to write a simple precommit hook to modify a JSON object by
&gt;&gt; removing certain fields. The simplest way to do this, I figure, is to decode
&gt;&gt; the object's value with mochijson2, remove the fields I don't want,
&gt;&gt; re-encode it, and update the value.
&gt;&gt;
&gt;&gt; What happens, though, is my object ends up somehow mangled. When I inspect
&gt;&gt; it via curl, it sort of looks like JSON, but characters like "{" and ":"
&gt;&gt; seem to be replaced with garbage.
&gt;&gt;
&gt;&gt; For example, what should read "hostname":"www.google.com" looks like \*
&gt;&gt; hostnamea"ja:la"mwww.google.coma"j\*
&gt;&gt;
&gt;&gt; To try to diagnose the issue, I reduced my hook to the simplest possible
&gt;&gt; case. I don't even modify the JSON, I just decode the object and re-encode
&gt;&gt; exactly the same value, but I still have the problem. The code is pasted
&gt;&gt; below
&gt;&gt;
&gt;&gt; \*precommit(RiakObject) -&gt;\*
&gt;&gt; \* Value = riak\_object:get\_value(RiakObject),\*
&gt;&gt; \* {struct, TermList} = mochijson2:decode(Value),\*
&gt;&gt; \* riak\_object:apply\_updates(\*
&gt;&gt; \* riak\_object:update\_value(RiakObject, \*
&gt;&gt; \* mochijson2:encode({struct,
&gt;&gt; TermList}))).\*
&gt;&gt;
&gt;&gt; Can anybody point out what I'm doing wrong?
&gt;&gt;
&gt;&gt; --
&gt;&gt; Greg
&gt;&gt; Clipboard  is hiring
&gt;&gt; !
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Greg
&gt; Clipboard  is hiring
&gt; !
&gt;
&gt;


-- 
Greg
Clipboard  is hiring
!
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

