---
title: "Re: Inconsistent map/reduce results"
description: ""
project: community
lastmod: 2011-03-10T17:47:59-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02606"
mailinglist_parent_id: "msg02604"
author_name: "Keith Dreibelbis"
project_section: "mailinglistitem"
sent_date: 2011-03-10T17:47:59-08:00
---


Thanks for the prompt response, Grant. I made the configuration change you
suggested, and it fixed my problem.

Some followup questions:

- is it possible to configure this dynamically on a per-bucket basis, or
just per-server like it is now?
- is this fixed in a newer version?

On Thu, Mar 10, 2011 at 2:56 PM, Grant Schofield  wrote:

&gt; There are currently some bugs in the mapreduce caching system. The best
&gt; thing to do would be to disable the feature, on 0.13 you can do this by
&gt; editing or adding the vnode\_cache\_entries to the riak\_kv section of your
&gt; app.config. The entry would look like:
&gt; {vnode\_cache\_entries, 0},
&gt;
&gt; Grant Schofield
&gt; Developer Advocate
&gt; Basho Technologies
&gt;
&gt; On Mar 10, 2011, at 4:16 PM, Keith Dreibelbis wrote:
&gt;
&gt; Hi riak-users,
&gt;
&gt; I'm trying to do a map/reduce query from java on a 0.13 server, and get
&gt; inconsistent results. What I'm doing should be pretty simple. I'm hoping
&gt; someone will notice an obvious error in here, or have some insight:
&gt;
&gt; This is an automated test. I'm doing a simple query where I'm trying to
&gt; get the keys for records with a certain field value. In SQL it would look
&gt; like "SELECT id FROM table WHERE age = '32'". In java I'm invoking it like
&gt; this:
&gt;
&gt; MapReduceResponse r = riak.mapReduceOverBucket(getBucket())
&gt; .map(JavascriptFunction.anon(func), true)
&gt; .submit();
&gt;
&gt; where riak is a RiakClient, getBucket() returns the name of the bucket, and
&gt; func is a string that looks like:
&gt;
&gt; function(value, keyData, arg) {
&gt; var data = Riak.mapValuesJson(value)[0];
&gt; if(data.age == "32")
&gt; return [value.key];
&gt; else
&gt; return [];
&gt; }
&gt;
&gt; No reduce phase. All entries in the example bucket are json and have an
&gt; age field. This initially works correctly, it gets back the matching
&gt; records as expected. It also works in curl. It's an automated test, so
&gt; each time I run this, it is using a different bucket. After about a dozen
&gt; queries, this starts to fail. It returns an empty result, when it should
&gt; have found records. It fails in curl at the same time.
&gt;
&gt; I initially suspected this might have something to do with doing map reduce
&gt; too soon after writing, and the write not being available on all nodes.
&gt; However, I changed the bucket schema entries for w,r,rw,dw from "quorum" to
&gt; "all", and this still happens (is there another bucket setting I missed?).
&gt; In addition, I only have 3 nodes (I'm using the dev123 example), and am
&gt; running curl long enough afterwards.
&gt;
&gt; Here's the strange part that makes me suspicious. If I make insignificant
&gt; changes to the query, for example change the double quotes to single quotes,
&gt; add whitespace or extra parentheses, etc, then it suddenly works again. It
&gt; will work on an existing bucket, and on subsequent tests, but again only
&gt; about a dozen times before it starts failing again. Same behavior in curl.
&gt; This makes me suspect that the server is doing some incorrect caching
&gt; around this js function, based on the function string.
&gt;
&gt; Any explanation about what's going on?
&gt;
&gt;
&gt; Keith
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

