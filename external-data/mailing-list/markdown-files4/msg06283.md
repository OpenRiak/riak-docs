---
title: "Re: documents disappear from riak search index"
description: ""
project: community
lastmod: 2012-01-14T08:58:36-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06283"
mailinglist_parent_id: "msg06272"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2012-01-14T08:58:36-08:00
---


2012/1/13 Ryan Zezeski :
&gt; Francisco,
&gt;
&gt; This is a tricky one indeed.  If I'm following your thus far you:
&gt;
&gt; 1. In November you had an incident with the cluster but re-saved all docs to
&gt; repopulate the index, things were good

Correct

&gt;
&gt; 2. Then in Dec you compared a mapred vs. search query, you didn't get
&gt; expected results, re-saved docs again to repopulate search index, reran
&gt; mapred and search queries and things were good again. Question a) what
&gt; compelled you to do this comparison in the first place?  That is, why did
&gt; you suspect a discrepancy?

Users reporting missing documents, same as in January.

&gt; 3. Now in early Jan you had a customer report that they suspected missing
&gt; results, sure enough you claim that 5% of the search indexes were missing,
&gt; you re-saved docs to repopulate search index, things are good again
&gt;
&gt; Question b) these missing docs \_have not\_ been changed between the time you
&gt; re-saved in Dec and the time the incident was reported by the user?

I'm pretty sure they didn't (especially for the user that complained),
but can't put my finger on it.

&gt;  This is
&gt; important because if the document changed then perhaps there is a corner
&gt; case in the KV hook that I can search for.  If the docs haven't been updated
&gt; then I'm a little dumbfounded because it potentially means the index is
&gt; losing data.  Given that other users of Search haven't reported any similar
&gt; issues (that I'm aware of) it seems we have more digging to do.

(I don't know how much Search has changed in 1.0.x, but keep in mind
I'm running 0.14.2 in production.)

I'd love to provide you with more information, but don't have much
time to go digging around. The workaround is, well, a workaround, but
it let us move on. I'll keep a special eye on this until it happens
again, and let's definitely keep each other posted.

Thanks,

Francisco


&gt; On Thu, Jan 12, 2012 at 1:04 PM, francisco treacy
&gt;  wrote:
&gt;&gt;
&gt;&gt; Hi Ryan,
&gt;&gt;
&gt;&gt; I had an incident when removing a replica back in November. But then I
&gt;&gt; managed to fix the state of the cluster. Then in December I passed the
&gt;&gt; script to re-save all docs so it worked (i.e. documents matched), and
&gt;&gt; now in January we were still noticing discrepancies.
&gt;&gt;
&gt;&gt; I noticed the problem only twice, perhaps it did happen more often.
&gt;&gt; Avg load is way under control, no spikes, no faulty disks. The cluster
&gt;&gt; hasn't changed at all since November.
&gt;&gt;
&gt;&gt; Francisco
&gt;&gt;
&gt;&gt; 2012/1/10 Ryan Zezeski :
&gt;&gt; &gt; Typically, something like this would be caused by replicas being lost as
&gt;&gt; &gt; Search currently has no anti-entropy.  I imagine you would have
&gt;&gt; &gt; mentioned
&gt;&gt; &gt; replica loss if that was the case, though.  You've seen this problem at
&gt;&gt; &gt; least twice, correct?  Were there other occurrences?  If so how many and
&gt;&gt; &gt; about how often do you notice them?  Did any other system events happen
&gt;&gt; &gt; that
&gt;&gt; &gt; might be correlated such as spike in load, faulty disks, node
&gt;&gt; &gt; join/leave/remove, node down/up, etc.
&gt;&gt; &gt;
&gt;&gt; &gt; On Tue, Jan 10, 2012 at 11:31 AM, francisco treacy
&gt;&gt; &gt;  wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; 2012/1/10 Ryan Zezeski :
&gt;&gt; &gt;&gt; &gt; When you say "doesn't show up on the search query results \*anymore\*"
&gt;&gt; &gt;&gt; &gt; does
&gt;&gt; &gt;&gt; &gt; that imply that at one time they did?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Absolutely. As a matter of fact that's what some of my users were
&gt;&gt; &gt;&gt; asking: "why can't I see X anymore?".
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;  I'm trying to understand if the index
&gt;&gt; &gt;&gt; &gt; entries appear to have been lost or if it was never successfully
&gt;&gt; &gt;&gt; &gt; written
&gt;&gt; &gt;&gt; &gt; in
&gt;&gt; &gt;&gt; &gt; the first place.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; They are definitely written to the index in the first place. I recall
&gt;&gt; &gt;&gt; noticing a similar situation early December, where I compared item
&gt;&gt; &gt;&gt; counts from a full-bucket map/reduce vs. a search map/reduce and they
&gt;&gt; &gt;&gt; didn't match.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Went about it by re-saving all items in the bucket as I said before.
&gt;&gt; &gt;&gt; Did a check just after, and numbers matched.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; And this morning I was back to the inequality after a user complaint,
&gt;&gt; &gt;&gt; so passed the re-save script once again. Obviously this is not
&gt;&gt; &gt;&gt; sustainable.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; The curious thing is that those documents are not even regularly
&gt;&gt; &gt;&gt; updated or deleted.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt; Any errors you see in the logs may be relevant.  Feel free to include
&gt;&gt; &gt;&gt; &gt; snippets of anything you find.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; I went through all sasl-error.log from all 3 nodes and couldn't find
&gt;&gt; &gt;&gt; anything related to search. Where else could I look? Do you have any
&gt;&gt; &gt;&gt; idea what could be causing this behaviour?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Francisco
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; On Tue, Jan 10, 2012 at 4:16 AM, francisco treacy
&gt;&gt; &gt;&gt; &gt;  wrote:
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Hi all,
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; I am running (still) 0.14.2 in production, and using Riak Search to
&gt;&gt; &gt;&gt; &gt;&gt; index certain buckets. Those buckets have the Riak Search pre-commit
&gt;&gt; &gt;&gt; &gt;&gt; hook enabled.
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Once in a while I get complaints of missing documents from my
&gt;&gt; &gt;&gt; &gt;&gt; clients,
&gt;&gt; &gt;&gt; &gt;&gt; and it just happened.
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; I checked and the document:
&gt;&gt; &gt;&gt; &gt;&gt;  - is correctly stored in Riak
&gt;&gt; &gt;&gt; &gt;&gt;  - doesn't show up on the search query results \*anymore\*
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; My workaround before was to go through every key in the bucket and
&gt;&gt; &gt;&gt; &gt;&gt; save it again, as to trigger the search hook. Of course, this is
&gt;&gt; &gt;&gt; &gt;&gt; less
&gt;&gt; &gt;&gt; &gt;&gt; than ideal.
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Should I be looking for something specific in the logs? What could
&gt;&gt; &gt;&gt; &gt;&gt; be
&gt;&gt; &gt;&gt; &gt;&gt; going on here?
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Thanks,
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; Francisco
&gt;&gt; &gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; &gt;&gt; &gt;&gt; riak-users mailing list
&gt;&gt; &gt;&gt; &gt;&gt; riak-users@lists.basho.com
&gt;&gt; &gt;&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

