---
title: "Re: Link Walking via Map Reduce"
description: ""
project: community
lastmod: 2011-06-23T09:42:33-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03809"
mailinglist_parent_id: "msg03802"
author_name: "Andrew Berman"
project_section: "mailinglistitem"
sent_date: 2011-06-23T09:42:33-07:00
---


Yes, I am able to do that, but I feel like this completely defeats the
purpose of a link by having to do two different calls. I might as
well just store the user id in the data for user\_email instead and not
use a link at all with your method. What advantage does a link offer
at that point?

On Thu, Jun 23, 2011 at 8:55 AM, Jeremiah Peschka
 wrote:
&gt; HTTP link walking will get you back the data in the way that you'd expect.
&gt; It's a two-step process using PBC. MR link phases will give you a list of
&gt; [bucket, key, tag] that you can then use to pull back the records from
&gt; Riak.
&gt; ---
&gt; Jeremiah Peschka
&gt; Founder, Brent Ozar PLF, LLC
&gt;
&gt; On Thursday, June 23, 2011 at 8:52 AM, Andrew Berman wrote:
&gt;
&gt; Ah, ok, that makes sense. One more question, when I use the HTTP link
&gt; walking, I do get the data back as expected, so is there a way to
&gt; replicate this in a Map-Reduce job or using the Erlang PBC (which I
&gt; forgot to mention is what I'm using and the reason I'm not using the
&gt; HTTP link walking method)?
&gt;
&gt; --Andrew
&gt;
&gt; On Thu, Jun 23, 2011 at 8:39 AM, Mathias Meyer  wrote:
&gt;
&gt; Andrew,
&gt;
&gt; the data looks like JSON, but it's not valid JSON. Have a look at the list
&gt; that's in the data section (which is your BERT encoded data), the first
&gt; character in that list is 131, which is not a valid UTF-8 character, and
&gt; JSON only allows valid UTF-8 characters. With a binary-encoded format,
&gt; there's always a chance for a control character like that to blow up the
&gt; JSON generated before and after the MapReduce code is executed. With JSON,
&gt; content agnosticism only goes as far as the set of legal characters allows.
&gt;
&gt; On a side note, if the data were a valid representation of a string, you
&gt; would see it as a string in the log file as well, not just as a list of
&gt; numbers.
&gt;
&gt; Mathias Meyer
&gt; Developer Advocate, Basho Technologies
&gt;
&gt;
&gt; On Donnerstag, 23. Juni 2011 at 17:31, Andrew Berman wrote:
&gt;
&gt; But isn't the value itself JSON? Meaning this part:
&gt;
&gt; {struct,
&gt;  [{&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"user"&gt;&gt;},
&gt;  {&lt;&lt;"key"&gt;&gt;,&lt;&lt;"LikiWUPJSFuxtrhCYpsPfg"&gt;&gt;},
&gt;  {&lt;&lt;"vclock"&gt;&gt;,
&gt;
&gt; &lt;&lt;"a85hYGBgzGDKBVIsLKaZdzOYEhnzWBmes6Yd58sCAA=="&gt;&gt;},
&gt;  {&lt;&lt;"values"&gt;&gt;,
&gt;  [{struct,
&gt;  [{&lt;&lt;"metadata"&gt;&gt;,
&gt;  {struct,
&gt;  [{&lt;&lt;"X-Riak-VTag"&gt;&gt;,
&gt; &lt;&lt;"1KnL9Dlma9Yg4eMhRuhwtx"&gt;&gt;},
&gt;  {&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;,
&gt; &lt;&lt;"Fri, 10 Jun 2011 03:05:11 GMT"&gt;&gt;}]}},
&gt;  {&lt;&lt;"data"&gt;&gt;,
&gt;
&gt; &lt;&lt;131,108,0,0,0,18,104,2,100,0,6,114,...&gt;&gt;}]}]}
&gt;
&gt; So the only thing that is not JSON is the data itself, but when I get
&gt; the value, shouldn't I be getting the all the info above which is JSON
&gt; encoded?
&gt;
&gt; Thank you all for your help,
&gt;
&gt; Andrew
&gt;
&gt; On Thu, Jun 23, 2011 at 8:17 AM, Sean Cribbs  (mailto:s...@basho.com)&gt; wrote:
&gt;
&gt; The object has to be JSON-encoded to be marshalled into the Javascript VM,
&gt; and also on the way out if the Accept header indicates application/json. So
&gt; you have two places where it needs to be encodable into JSON.
&gt; On Thu, Jun 23, 2011 at 11:14 AM, Andrew Berman  (mailto:rexx...@gmail.com)&gt; wrote:
&gt;
&gt; Mathias,
&gt;
&gt; I thought Riak was content agnostic when it came to the data being
&gt; stored? The map phase is not running Riak.mapValuesJson, so why is
&gt; the data itself going through the JSON parser? The JSON value
&gt; returned by v with all the info is valid and I see the struct atom in
&gt; there so mochijson2 can parse it properly, but I'm not clear why
&gt; mochijson2 would be coughing at the data part.
&gt;
&gt; --Andrew
&gt;
&gt; On Thu, Jun 23, 2011 at 5:32 AM, Mathias Meyer  (mailto:math...@basho.com)&gt; wrote:
&gt;
&gt; Andrew,
&gt;
&gt; you're indeed hitting a JSON encoding problem here. BERT is binary data,
&gt; and won't make the JSON parser happy when trying to deserialize it, before
&gt; handing it into the map phase. You have two options here, and none of them
&gt; will involve JavaScript as the MapReduce language.
&gt;
&gt; 1.) Use the Protobuff API, use Erlang functions to return the value or
&gt; object (e.g. riak\_mapreduce:map\_object\_value or
&gt; riak\_kv\_mapreduce:map\_identity), and then run MapReduce queries with the
&gt; content type 'application/x-erlang-binary'. However, you're constrained by
&gt; client libraries here, e.g. Ruby and Python don't support this content type
&gt; for MapReduce on the Protobuffs interface yet, so you'd either implement
&gt; something custom, or resort to a client that does, riak-erlang-client comes
&gt; to mind, though it was proven to be possible using the Java client too,
&gt; thanks to Russell. See [1] and [2]
&gt;
&gt; 2.) Convert the result from BERT into a JSON-parseable structure inside
&gt; an Erlang map function, before it's returned to the client.
&gt;
&gt; The second approach certainly is less restrictive in terms of API usage,
&gt; but certainly involves some overhead inside of the MapReduce request itself,
&gt; but is less prone to encoding/decoding issues with JSON.
&gt;
&gt; Mathias Meyer
&gt; Developer Advocate, Basho Technologies
&gt;
&gt; [1]
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-June/004447.html
&gt; [2]
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-June/004485.html
&gt;
&gt; On Donnerstag, 23. Juni 2011 at 07:59, Andrew Berman wrote:
&gt;
&gt; Hey Ryan,
&gt;
&gt; Here is the error from the sasl log. It looks like some sort of
&gt; encoding error. Any thoughts on how to fix this? I am storing the
&gt; data as BERT encoded binary and I set the content-type as
&gt; application/octet-stream.
&gt;
&gt; Thanks for your help!
&gt;
&gt; Andrew
&gt;
&gt; ERROR REPORT==== 9-Jun-2011::21:37:05 ===
&gt; \*\* Generic server &lt;0.5996.21&gt; terminating
&gt; \*\* Last message in was {batch\_dispatch,
&gt; {map,
&gt; {jsanon,&lt;&lt;"function(value) {return [value];}"&gt;&gt;},
&gt; [{struct,
&gt; [{&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"user"&gt;&gt;},
&gt; {&lt;&lt;"key"&gt;&gt;,&lt;&lt;"LikiWUPJSFuxtrhCYpsPfg"&gt;&gt;},
&gt; {&lt;&lt;"vclock"&gt;&gt;,
&gt;
&gt; &lt;&lt;"a85hYGBgzGDKBVIsLKaZdzOYEhnzWBmes6Yd58sCAA=="&gt;&gt;},
&gt; {&lt;&lt;"values"&gt;&gt;,
&gt; [{struct,
&gt; [{&lt;&lt;"metadata"&gt;&gt;,
&gt; {struct,
&gt; [{&lt;&lt;"X-Riak-VTag"&gt;&gt;,
&gt; &lt;&lt;"1KnL9Dlma9Yg4eMhRuhwtx"&gt;&gt;},
&gt; {&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;,
&gt; &lt;&lt;"Fri, 10 Jun 2011 03:05:11 GMT"&gt;&gt;}]}},
&gt; {&lt;&lt;"data"&gt;&gt;,
&gt;
&gt; &lt;&lt;131,108,0,0,0,18,104,2,100,0,6,114,...&gt;&gt;}]}]}]},
&gt; &lt;&lt;"user"&gt;&gt;,none]}}
&gt; \*\* When Server state ==
&gt; {state,&lt;0.143.0&gt;,riak\_kv\_js\_map,#Port&lt;0.92614&gt;,true}
&gt; \*\* Reason for termination ==
&gt; \*\* {function\_clause,[{js\_driver,eval\_js,
&gt; [#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},
&gt; {riak\_kv\_js\_vm,invoke\_js,2},
&gt; {riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},
&gt; {riak\_kv\_js\_vm,handle\_call,3},
&gt; {gen\_server,handle\_msg,5},
&gt; {proc\_lib,init\_p\_do\_apply,3}]}
&gt;
&gt; =CRASH REPORT==== 9-Jun-2011::21:37:05 ===
&gt; crasher:
&gt; initial call: riak\_kv\_js\_vm:init/1
&gt; pid: &lt;0.5996.21&gt;
&gt; registered\_name: []
&gt; exception exit:
&gt;
&gt; {function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]}
&gt; in function gen\_server:terminate/6
&gt; in call from proc\_lib:init\_p\_do\_apply/3
&gt; ancestors: [riak\_kv\_js\_sup,riak\_kv\_sup,&lt;0.128.0&gt;]
&gt; messages: []
&gt; links: [&lt;0.142.0&gt;,&lt;0.6009.21&gt;]
&gt; dictionary: []
&gt; trap\_exit: false
&gt; status: running
&gt; heap\_size: 4181
&gt; stack\_size: 24
&gt; reductions: 2586
&gt; neighbours:
&gt; neighbour:
&gt; [{pid,&lt;0.6009.21&gt;},{registered\_name,[]},{initial\_call,{riak\_kv\_mapper,init,[Argument\_\_1]}},{current\_function,{gen,do\_call,4}},{ancestors,[riak\_kv\_mapper\_sup,riak\_kv\_sup,&lt;0.128.0&gt;]},{messages,[]},{links,[&lt;0.5996.21&gt;,&lt;12337.6227.21&gt;,&lt;0.162.0&gt;]},{dictionary,[]},{trap\_exit,false},{status,waiting},{heap\_size,987},{stack\_size,53},{reductions,1043}]
&gt; =SUPERVISOR REPORT==== 9-Jun-2011::21:37:05 ===
&gt; Supervisor: {local,riak\_kv\_js\_sup}
&gt; Context: child\_terminated
&gt; Reason:
&gt;
&gt; {function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]}
&gt; Offender:
&gt;
&gt; [{pid,&lt;0.5996.21&gt;},{name,undefined},{mfargs,{riak\_kv\_js\_vm,start\_link,undefined}},{restart\_type,temporary},{shutdown,2000},{child\_type,worker}]
&gt;
&gt; On Wed, Jun 22, 2011 at 6:10 PM, Ryan Zezeski  (mailto:rzeze...@basho.com)
&gt; (mailto:rzeze...@basho.com)&gt; wrote:
&gt;
&gt; Andrew,
&gt; Maybe you could elaborate on the error? I tested this against master
&gt; (commit below) just now with success.
&gt; 2b1a474f836d962fa035f48c05452e22fc6c2193 Change dependency to allow
&gt; for R14B03 as well as R14B02
&gt; -Ryan
&gt; On Wed, Jun 22, 2011 at 7:03 PM, Andrew Berman  (mailto:rexx...@gmail.com)
&gt; (mailto:rexx...@gmail.com)&gt; wrote:
&gt;
&gt; Hello,
&gt; I'm having issues link walking using the Map Reduce link function.
&gt; I am using HEAD from Git, so it's possible that's the issue, but here is
&gt; what is happening.
&gt; I've got two buckets, user and user\_email where user\_email contains
&gt; a link to the user.
&gt; When I run this:
&gt; {
&gt; "inputs": [
&gt; [
&gt; "user\_email",
&gt; "myem...@email.com (mailto:myem...@email.com)"
&gt; ]
&gt; ],
&gt; "query": [
&gt; {
&gt; "link": {
&gt; "bucket": "user",
&gt; "tag": "user"
&gt; }
&gt; }
&gt; ]
&gt; }
&gt; I only get [["user","LikiWUPJSFuxtrhCYpsPfg","user"]] returned. The
&gt; second I add a map function, even the simplest one (function(v) { [v] } I
&gt; get a "map\_reduce error":
&gt; {
&gt; "inputs": [
&gt; [
&gt; "user\_email",
&gt; "myem...@email.com (mailto:myem...@email.com)"
&gt; ]
&gt; ],
&gt; "query": [
&gt; {
&gt; "link": {"bucket":"user", "tag":"user"}
&gt; }
&gt; ,{
&gt; "map": {
&gt; "language": "javascript",
&gt; "source": "function(v) { return[v]; }"
&gt; }
&gt; }
&gt; ]
&gt; }
&gt; Is this functionality broken? I am following what it says on the
&gt; Wiki for the MapRed version of link walking. When I use HTTP link walking,
&gt; it works correctly.
&gt; Thanks,
&gt; Andrew
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

