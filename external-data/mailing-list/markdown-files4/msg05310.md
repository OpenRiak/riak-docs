---
title: "Re: 2i query, weird null results, java pbclient"
description: ""
project: community
lastmod: 2011-10-25T11:03:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05310"
mailinglist_parent_id: "msg05300"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2011-10-25T11:03:15-07:00
---



On 25 Oct 2011, at 18:48, Alexander Robbins wrote:

&gt; That code snippet isn't working because I've got a RawClient instance and its 
&gt; mapReduce method wants a MapReduceSpec. I ran into this problem while trying 
&gt; to use search also. I ended up making a search object and then serializing it 
&gt; to json and providing it to the MapReduceSpec constructor, then passing the 
&gt; resulting MapReduceSpec into the mapReduce method on RawClient. Is there a 
&gt; better way? I considered just using String.format to put the variables into a 
&gt; handwritten json string and using that to instantiate the MapReduceSpec.
&gt; 
&gt; Thanks!
&gt; Alex
&gt; 
&gt; My gross method of making a MapReduceSpec:
&gt; final Map mapReduceObject = new HashMap();
&gt; final Map inputs = new HashMap();
&gt; final List query = new ArrayList();
&gt; final List searchTerms = new ArrayList();
&gt; searchTerms.add(bucket);
&gt; searchTerms.add(terms);
&gt; inputs.put("module", "riak\_search");
&gt; inputs.put("function", "mapred\_search");
&gt; inputs.put("arg", searchTerms);
&gt; final Map reduce = new HashMap();
&gt; reduce.put("language", "erlang");
&gt; reduce.put("module", "riak\_kv\_mapreduce");
&gt; reduce.put("function", "reduce\_identity");
&gt; final Map&gt; map1 = new 
&gt; HashMap&gt;();
&gt; map1.put("reduce", reduce);
&gt; query.add(map1);
&gt; mapReduceObject.put("inputs", inputs);
&gt; mapReduceObject.put("query", query);
&gt; final MapReduceSpec spec = new MapReduceSpec(new 
&gt; Gson().toJson(mapReduceObject));

OK. So the high-level libraries are there to help, even if you have a 
RawClient, try this:

 IndexQuery q = new BinValueQuery(BinIndex.named("docUID"), "mentions", 
"5b9d1a6250dbd3e77ff004a12d06958745ee32844ad4aa668001bbe69b5efcf8");
 MapReduce mr = new IndexMapReduce(YOUR\_RAW\_CLIENT\_INSTANCE, indexQuery);

 mr.addReducePhase(NamedErlangFunction.REDUCE\_IDENTITY, 
"{reduce\_phase\_only\_1, true}");
 MapReduceResult result = mr.execute(); 
 Collection r = result.getResult(String[].class);

You can do the same thing with the search map reduce

 MapReduce mr = new SearchMapReduce(YOUR\_RAW\_CLIENT, "bucket", "your 
search query");

And then use the MapReduce methods to add phases and execute as before.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

