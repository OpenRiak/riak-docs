---
title: "Re: Put failure: too many siblings"
description: ""
project: community
lastmod: 2017-05-24T01:23:21-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18233"
mailinglist_parent_id: "msg18232"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2017-05-24T01:23:21-07:00
---



On 24 May 2017, at 09:11, Vladyslav Zakhozhai  
wrote:

&gt; Hello,
&gt; 
&gt; My riak cluster still experiences "too many siblings". And hinted handoffs 
&gt; are not able to be finished completely. So "siblings will be resolved after 
&gt; hinted handoffs are finished" is not my case unfortunately.
&gt; 
&gt; According to basho's docs 
&gt; (http://docs.basho.com/riak/kv/2.2.3/learn/concepts/causal-context/#sibling-explosion)
&gt; I need to enable dvv conflict resolution mechanism. So here is a quesion:
&gt; 
&gt; Is it safe to enable dvv on default bucket type and how it affects existing 
&gt; data?

It might not affect existing data enough. All the existing siblings are 
“undotted” and would need a read-put cycle to resolve.

&gt; It may be a solution, is not it?

You may require further action. I remember basho support helping someone with a 
similar issue, and there was some manual intervention/scripted solution, but I 
can’t remember what it was right now. I think those objects (as logged) with 
the sibling issues need to be read and resolved. Maybe one of the ex-basho 
support people remembers? I’ll prod one in a back channel and see if they can 
help.

&gt; 
&gt; Why I talk about default bucket type? Because there is only one riak client - 
&gt; Riak CS and it does not manage bucket types of PUT'ed object (so, default 
&gt; bucket type always is used during PUT's). Is it correct?

Yes.

&gt; 
&gt; Thank you in advance.
&gt; 
&gt; On Fri, Jun 17, 2016 at 11:45 AM Vladyslav Zakhozhai 
&gt;  wrote:
&gt; Hi Russel,
&gt; 
&gt; thank you for your answer. I really appreciate your help.
&gt; 
&gt; 2.1.3 is not actually riak\_kv version. It is version of basho's riak package. 
&gt; Versions of riak subsystems you can see below.
&gt; 
&gt; Bucket properties:
&gt; # riak-admin bucket-type list
&gt; default (active)
&gt; 
&gt; # riak-admin bucket-type status default
&gt; default is active
&gt; 
&gt; allow\_mult: true
&gt; basic\_quorum: false
&gt; big\_vclock: 50
&gt; chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
&gt; dvv\_enabled: false
&gt; dw: quorum
&gt; last\_write\_wins: false
&gt; linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
&gt; n\_val: 3
&gt; notfound\_ok: true
&gt; old\_vclock: 86400
&gt; postcommit: []
&gt; pr: 0
&gt; precommit: []
&gt; pw: 0
&gt; r: quorum
&gt; rw: quorum
&gt; small\_vclock: 50
&gt; w: quorum
&gt; write\_once: false
&gt; young\_vclock: 20
&gt; 
&gt; I did not mentioned that upgrade from riak 1.5.4 have been took place couple 
&gt; months ago (about 6 months). As I understand DVV is disabled. Is it safe to 
&gt; migrate to setting DVV from Vector Clocks?
&gt; 
&gt; Package versions:
&gt; # dpkg -l | grep riak
&gt; ii riak 2.1.3-1 
&gt; amd64 Riak is a distributed data store
&gt; ii riak-cs 2.1.0-1 
&gt; amd64 Riak CS
&gt; 
&gt; Subsystems versions:
&gt; "clique\_version" : "0.3.2-0-ge332c8f",
&gt; "bitcask\_version" : "1.7.2",
&gt; "sys\_driver\_version" : "2.2",
&gt; "riak\_core\_version" : "2.1.5-0-gb02ab53",
&gt; "riak\_kv\_version" : "2.1.2-0-gf969bba",
&gt; "riak\_pipe\_version" : "2.1.1-0-gb1ac2cf",
&gt; "cluster\_info\_version" : "2.0.3-0-g76c73fc",
&gt; "riak\_auth\_mods\_version" : "2.1.0-0-g31b8b30",
&gt; "erlydtl\_version" : "0.7.0",
&gt; "os\_mon\_version" : "2.2.13",
&gt; "inets\_version" : "5.9.6",
&gt; "erlang\_js\_version" : "1.3.0-0-g07467d8",
&gt; "riak\_control\_version" : "2.1.2-0-gab3f924",
&gt; "xmerl\_version" : "1.3.4",
&gt; "protobuffs\_version" : "0.8.1p5-0-gf88fc3c",
&gt; "riak\_sysmon\_version" : "2.0.0",
&gt; "compiler\_version" : "4.9.3",
&gt; "eleveldb\_version" : "2.1.10-0-g0537ca9",
&gt; "lager\_version" : "2.1.1",
&gt; "sasl\_version" : "2.3.3",
&gt; "riak\_dt\_version" : "2.1.1-0-ga2986bc",
&gt; "runtime\_tools\_version" : "1.8.12",
&gt; "yokozuna\_version" : "2.1.2-0-g3520d11",
&gt; "riak\_search\_version" : "2.1.1-0-gffe2113",
&gt; "sys\_system\_version" : "Erlang R16B02\_basho8 (erts-5.10.3) [source] [64-bit] 
&gt; [smp:4:4] [async-threads:64] [kernel-poll:true] [frame-pointer]",
&gt; "basho\_stats\_version" : "1.0.3",
&gt; "crypto\_version" : "3.1",
&gt; "merge\_index\_version" : "2.0.1-0-g0c8f77c",
&gt; "kernel\_version" : "2.16.3",
&gt; "stdlib\_version" : "1.19.3",
&gt; "riak\_pb\_version" : "2.1.0.2-0-g620bc70",
&gt; "syntax\_tools\_version" : "1.6.11",
&gt; "goldrush\_version" : "0.1.7",
&gt; "ibrowse\_version" : "4.0.2",
&gt; "mochiweb\_version" : "2.9.0",
&gt; "exometer\_core\_version" : "1.0.0-basho2-0-gb47a5d6",
&gt; "ssl\_version" : "5.3.1",
&gt; "public\_key\_version" : "0.20",
&gt; "pbkdf2\_version" : "2.0.0-0-g7076584",
&gt; "sidejob\_version" : "2.0.0-0-gc5aabba",
&gt; "webmachine\_version" : "1.10.8-0-g7677c24",
&gt; "poolboy\_version" : "0.8.1p3-0-g8bb45fb",
&gt; "riak\_api\_version" : "2.1.2-0-gd8d510f",
&gt; "asn1\_version" : "2.0.3",
&gt; 
&gt; 
&gt; On Fri, Jun 17, 2016 at 10:45 AM Russell Brown  wrote:
&gt; What version of riak\_kv is behind this riak\_cs install, please? Is it really 
&gt; 2.1.3 as stated below? This looks and sounds like sibling explosion, which is 
&gt; fixed in riak 2.0 and above. Are you sure that you are using the DVV enabled 
&gt; setting for riak\_cs bucket properties? Can you post your bucket properties 
&gt; please?
&gt; 
&gt; On 16 Jun 2016, at 23:54, Vladyslav Zakhozhai  
&gt; wrote:
&gt; 
&gt; &gt; Hello.
&gt; &gt;
&gt; &gt; I see very interesting and confusing thing.
&gt; &gt;
&gt; &gt; From my previous letter you can see that siblings count on manifest objects 
&gt; &gt; is about 100 (actualy it is in range 100-300). Unfortunately my problem is 
&gt; &gt; that almost all PUT requests are failing with 500 Internal Server error.
&gt; &gt;
&gt; &gt; I've tried today set max\_siblings riak option to 500. And there were 
&gt; &gt; successfull PUT requests but not for long. Now I see in riak logs error 
&gt; &gt; with "max siblings", but actual count of them is 500+ (earlier it was 
&gt; &gt; 100-300 as I've mentioned).
&gt; &gt;
&gt; &gt; Period of time between max\_siblings=500 and errors in log is about 30 
&gt; &gt; minutes. And I want to point your attention that I've forbid PUT method on 
&gt; &gt; haproxy - frontend for riak cs.
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; On Mon, Jun 6, 2016 at 1:17 AM Vladyslav Zakhozhai 
&gt; &gt;  wrote:
&gt; &gt; Hi, Luke.
&gt; &gt;
&gt; &gt; Thank you for your answer. I did not understand you completely about 
&gt; &gt; transfer-limit. How does it relate to my problem. Transfer limit - is a 
&gt; &gt; limit of concurrent data transfer from different nodes. Am I wright? You 
&gt; &gt; mean that riak can handoff one partition from several nodes concurrently?
&gt; &gt;
&gt; &gt; Now I have transfer-limit 1 on all riak nodes.
&gt; &gt;
&gt; &gt; But I am not sure that my cluster will be converged ever. All nodes 
&gt; &gt; experiences low memory and are killed by OOM Killer periodically. I try to 
&gt; &gt; add new nodes to the cluster but due problem with OOM killer this process 
&gt; &gt; is very-very slow.
&gt; &gt;
&gt; &gt; In the official docs I've read:
&gt; &gt;
&gt; &gt; "Sibling explosion occurs when an object rapidly collects siblings that are 
&gt; &gt; not reconciled. This can lead to a variety of problems, including degraded 
&gt; &gt; performance, especially if many objects in a cluster suffer from siblings 
&gt; &gt; explosion. At the extreme, having an enormous object in a node can cause 
&gt; &gt; reads of that object to crash the entire node. Other issues include undue 
&gt; &gt; latency and out-of-memory errors."
&gt; &gt;
&gt; &gt; I mentioned that new nodes in the cluster do not experience such problems 
&gt; &gt; (I mean out of RAM).
&gt; &gt;
&gt; &gt; Regarding to siblings maybe your are right, this is manifest object. I can 
&gt; &gt; recognize key name but not bucket name. But more than 100 siblings on many 
&gt; &gt; keys is really confused me. Each time I try to PUT some object to Riak via 
&gt; &gt; Riak CS S3 interface I got errors with siblings.
&gt; &gt;
&gt; &gt; On Fri, Jun 3, 2016 at 6:43 PM Luke Bakken  wrote:
&gt; &gt; Hi Vladyslav,
&gt; &gt;
&gt; &gt; If you recognize the full name of the object raising the sibling
&gt; &gt; warning, it is most likely a manifest object. Sometimes, during hinted
&gt; &gt; handoff, you can see these messages. They should resolve after handoff
&gt; &gt; completes.
&gt; &gt;
&gt; &gt; Please see the documentation for the transfer-limit command as well:
&gt; &gt;
&gt; &gt; http://docs.basho.com/riak/kv/2.1.4/using/admin/riak-admin/#transfer-limit
&gt; &gt;
&gt; &gt; --
&gt; &gt; Luke Bakken
&gt; &gt; Engineer
&gt; &gt; lbak...@basho.com
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri, Jun 3, 2016 at 2:55 AM, Vladyslav Zakhozhai
&gt; &gt;  wrote:
&gt; &gt; &gt; Hi.
&gt; &gt; &gt;
&gt; &gt; &gt; I have a trouble with PUT to Riak CS cluster. During this process I
&gt; &gt; &gt; periodically see the following message in Riak error.log:
&gt; &gt; &gt;
&gt; &gt; &gt; 2016-06-03 11:15:55.201 [error]
&gt; &gt; &gt; &lt;0.15536.142&gt;@riak\_kv\_vnode:encode\_and\_put:2253 Put failure: too many
&gt; &gt; &gt; siblings for object OBJECT\_NAME (101)
&gt; &gt; &gt;
&gt; &gt; &gt; and also
&gt; &gt; &gt;
&gt; &gt; &gt; 2016-06-03 12:41:50.678 [error]
&gt; &gt; &gt; &lt;0.20448.515&gt;@riak\_api\_pb\_server:handle\_info:331 Unrecognized message
&gt; &gt; &gt; {7345880,{error,{too\_many\_siblings,101}}}
&gt; &gt; &gt;
&gt; &gt; &gt; Here OBJECT\_NAME - is the name of object in Riak which has too many
&gt; &gt; &gt; siblings.
&gt; &gt; &gt;
&gt; &gt; &gt; I definitely sure that this objects are static. Nobody deletes is, nobody
&gt; &gt; &gt; rewrites it. I have no idea why more than 100 siblings of this object
&gt; &gt; &gt; occurs.
&gt; &gt; &gt;
&gt; &gt; &gt; The following effect of this issue occurs:
&gt; &gt; &gt;
&gt; &gt; &gt; Great amount of keys are loaded to RAM. I almost out of RAM (Do each 
&gt; &gt; &gt; sibling
&gt; &gt; &gt; has it own key or key duplicate?).
&gt; &gt; &gt; Nodes are slow - adding new nodes are too slow
&gt; &gt; &gt; Presence of "too many siblings" affects ownership handoffs
&gt; &gt; &gt;
&gt; &gt; &gt; So I have several questions:
&gt; &gt; &gt;
&gt; &gt; &gt; Do hinted or ownership handoffs can affect siblings count (I mean can
&gt; &gt; &gt; siblings be created during ownership of hinted handoffs)
&gt; &gt; &gt; Is there any workaround of this issue. Do I need remove siblings manually 
&gt; &gt; &gt; or
&gt; &gt; &gt; it removes during merges, read repairs and so on
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; My configuration:
&gt; &gt; &gt;
&gt; &gt; &gt; riak from basho's packages - 2.1.3-1
&gt; &gt; &gt; riak cs from basho's packages - 2.1.0-1
&gt; &gt; &gt; 24 riak/riak-cs nodes
&gt; &gt; &gt; 32 GB RAM per node
&gt; &gt; &gt; AAE is disabled
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; I appreciate you help.
&gt; &gt; &gt;
&gt; &gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

