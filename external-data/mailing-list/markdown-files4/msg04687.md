---
title: "Re: Streaming video from Luwak to browsers not working so well"
description: ""
project: community
lastmod: 2011-09-13T13:40:38-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04687"
mailinglist_parent_id: "msg04686"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-09-13T13:40:38-07:00
---


John,

If the browser negotiated a gzip response, the results when streaming would
be incorrect (or at least incompatible) if the response were ever larger
than a single chunk. Webmachine would send each chunk through the gzip
compressor individually, whereas browsers would expect the entire response
to be a single gzip blob (with a single header/checksum). At least, that's
why the gzip thing didn't work. Not sure why Safari broke even when you
turned that off.

On Tue, Sep 13, 2011 at 4:04 PM, John Axel Eriksson  wrote:

&gt; First a little background:
&gt;
&gt; We've been putting videos in luwak without much trouble for quite a while
&gt; now, small and a little bigger (by bigger I mean around 6 or 7 megs).
&gt;
&gt; To stream these so far, we've basically done this:
&gt;
&gt; Get the web app to download the video over http from luwak and store on
&gt; local disk.
&gt; Get nginx, through an x-accel, to actually send it to the client (i.e the
&gt; browser).
&gt;
&gt; For various reasons this isn't really how we want to do it. There is one
&gt; big reason why we do this currently. We need all clients to authenticate
&gt; through
&gt; our rails-app. So we first tried to have rails send an x-accel to nginx
&gt; which would then proxy to luwak. This won't work because nginx doesn't
&gt; support
&gt; http 1.1, chunked encoding and all that jazz to backends at least (it's
&gt; 2011… why I just don't know).
&gt;
&gt; Anyway, for a while now we've thrown node.js into the mix(for other
&gt; reasons) and recently I started working on some code for node.js to
&gt; recognize
&gt; x-sendfile (similar to x-accel). I also made it do the same type of
&gt; proxying as nginx can do - but this time it does http 1.1. Unfortunately I
&gt; couldn't get it
&gt; to work. So I started investigating riak/luwak directly. Could we even
&gt; stream a video out of luwak directly? No we couldn't. So the problem goes
&gt; all the
&gt; way back to riak.
&gt;
&gt; Using Safari it won't stream more than a few seconds and then sound and
&gt; video stops (though the progress bar keeps moving).
&gt; Using Chrome and Firefox I could stream perhaps half the video before more
&gt; or less the same thing happened.
&gt;
&gt; I then cloned riak and removed one line in
&gt; deps/luwak/src/luwak\_wm\_file.erl, specifically line 363 - {"gzip",
&gt; fun(X) -&gt; zlib:gzip(X) end}]. So that the list
&gt; now only contains [{"identity", fun(X) -&gt; X end}]. (Those are the
&gt; default\_encodings). I will admit I didn't know exactly what I was doing.
&gt;
&gt; Built riak and did some more testing. The results were interesting.
&gt; Suddenly Chrome and Firefox would play the whole file through (a .webm).
&gt; Unfortunately Safari still did the same thing, i.e played 4 seconds and
&gt; then stopped video and sound (while still showing progress).
&gt;
&gt; I didn't try IE and quite frankly I'm afraid that one might just blow up my
&gt; computer…
&gt;
&gt; Anyway, I just wanted to ask the list if anyone ever tried the same thing
&gt; or if any of the good people at basho knows more than I do (which I suspect
&gt; they do :-).
&gt;
&gt;
&gt; Thanks,
&gt; John
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;



-- 
Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://www.basho.com/
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

