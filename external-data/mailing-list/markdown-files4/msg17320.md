---
title: "Re: Precommit hook function - no error log - how to debug?"
description: ""
project: community
lastmod: 2016-05-10T18:50:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17320"
mailinglist_parent_id: "msg17319"
author_name: "Sanket Agrawal"
project_section: "mailinglistitem"
sent_date: 2016-05-10T18:50:32-07:00
---


One more thing - I set up the hooks by bucket, not bucket type. The
documentation for 2.1.4 says that hooks are defined on the bucket level.
Here is how I set up precommit hook (derived from "Riak Handbook" p95):

curl -X PUT localhost:8098/types/test\_kv\_wo/buckets/uuid\_log/props -H
'Content-Type: application/json' -d '{ "props": { "precommit": [{"mod":
"precommit", "fun": "pre\_uuid"}]}}' -v

On Tue, May 10, 2016 at 9:15 PM, Sanket Agrawal 
wrote:

&gt; I just set up a precommit hook function in dev environment (KV 2.1.4)
&gt; which doesn't seem to be triggering off at all. The object is being stored
&gt; in the bucket, but the precommit logic is not kicking off. I checked couple
&gt; of things as listed below but came up with no error - so, it is a
&gt; head-scratcher why precommit hook is not triggering:
&gt;
&gt;&gt; - Verify precommit is set in bucket properties - snippet from curl query
&gt;&gt; for bucket props below:
&gt;&gt; "precommit":[{"mod":"precommit","fun":"pre\_uuid"}]
&gt;&gt;
&gt;&gt; - check there is no error in logs
&gt;&gt;
&gt;&gt; - check riak-console for commit errors:
&gt;&gt; $ ./riak1/bin/riak-admin status|grep commit
&gt;&gt; postcommit\_fail : 0
&gt;&gt; precommit\_fail : 0
&gt;&gt;
&gt;&gt; - Run the precommit function manually on Riak console itself with a riak
&gt;&gt; object (that the hook failed to trigger on), and verify it works
&gt;
&gt;
&gt;
&gt; Also, there is no sasl-error.log. "sasl = on" doesn't work in 2.1.4
&gt; because it fails with bad\_config error. So, I am assuming sasl logging is
&gt; enabled by default.
&gt;
&gt; Here is what precommit function does:
&gt; - For the object (an immutable log append of JSON), calculate the location
&gt; of a LWW bucket, and update a easily calculated key with that JSON body. It
&gt; works fine from Riak console itself. Code below - we call pre\_uuid in
&gt; precommit hook - both precommit.beam (where the function is) and
&gt; rutils.beam have been copied to the relevant location as set in riak
&gt; config, are accessible through Riak console and work fine if manually
&gt; executed on an object:
&gt;
&gt; %% Preprocess JSON, and copy to a LWW bucket type
&gt;&gt; preprocessJ(RObj,B,Choplen) -&gt;
&gt;&gt; Bn = {rutils:calcBLWWType(RObj),B}, %%this returns the location of LWW
&gt;&gt; bucket - works fine in riak console
&gt;&gt; %% We store uuid map in  key - we take out timestamp of
&gt;&gt; length 32 including "\_"
&gt;&gt; K = riak\_object:key(RObj),
&gt;&gt; Kn = binary:part(K,0,byte\_size(K) - Choplen),
&gt;&gt; NObj =
&gt;&gt; riak\_object:new(Bn,Kn,riak\_object:get\_value(RObj),riak\_object:get\_metadata(RObj)),
&gt;&gt; {ok, C} = riak:local\_client(),
&gt;&gt; case C:put(NObj) of
&gt;&gt; ok -&gt; RObj;
&gt;&gt; \_ -&gt; {fail,&lt;&lt;"Error when trying to process in precommit hook"&gt;&gt;}
&gt;&gt; end.
&gt;&gt;
&gt;&gt; pre\_uuid(RObj) -&gt; preprocessJ(RObj,&lt;&lt;"uuid\_latest"&gt;&gt;,32).
&gt;
&gt;
&gt; Below is a manual execution from riak console of precommit function -
&gt; first we execute it to confirm it is returning the original object:
&gt;
&gt;&gt; (riak1@127.0.0.1)5&gt; precommit:pre\_uuid(O1).
&gt;&gt; {r\_object,{&lt;&lt;"test\_kv\_wo"&gt;&gt;,&lt;&lt;"uuid\_log"&gt;&gt;},
&gt;&gt; &lt;&lt;"ahmed\_2016-05-10T20%3a47%3a47.346299Z"&gt;&gt;,
&gt;&gt; [{r\_content,{dict,3,16,16,8,80,48,
&gt;&gt;
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt;
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[[...]|...],[],...}}},
&gt;&gt;
&gt;&gt; &lt;&lt;"{\"uname\":\"ahmed\",\"uuid\":\"df8c10e0-381d-5f65-bf43-cb8b4cb806fc\",\"timestamp\":\"2016-05-"...&gt;&gt;}],
&gt;&gt; [{&lt;&lt;0&gt;&gt;,{1,63630132467}}],
&gt;&gt; {dict,1,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt; undefined}
&gt;
&gt;
&gt; Now, we check if the object has been written to test\_lww/uuid\_latest
&gt; bucket type:
&gt;
&gt;&gt; (riak1@127.0.0.1)6&gt;
&gt;&gt; C:get({&lt;&lt;"test\_lww"&gt;&gt;,&lt;&lt;"uuid\_latest"&gt;&gt;},&lt;&lt;"ahmed"&gt;&gt;).
&gt;
&gt; {ok,{r\_object,{&lt;&lt;"hnm\_fsm\_lww"&gt;&gt;,&lt;&lt;"uuid\_latest"&gt;&gt;},
&gt;&gt; &lt;&lt;"ahmed"&gt;&gt;,
&gt;&gt; [{r\_content,{dict,4,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt;
&gt;&gt; &lt;&lt;"{\"uname\":\"ahmed\",\"uuid\":\"df8c10e0-381d-5f65-bf43-cb8b4cb806fc\",\"timestamp\":\""...&gt;&gt;}],
&gt;&gt; [{&lt;&lt;153,190,230,200,210,126,212,127,0,0,156,65&gt;&gt;,
&gt;&gt; {1,63630148036}}],
&gt;&gt; {dict,1,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;&gt; {{[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;&gt; undefined}}
&gt;
&gt;
&gt; Will appreciate pointer on how to debug precommit hook.
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

