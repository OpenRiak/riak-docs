---
title: "Re: stream_list_keys"
description: ""
project: community
lastmod: 2013-04-16T13:47:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10902"
mailinglist_parent_id: "msg10897"
author_name: "Christian Dahlqvist"
project_section: "mailinglistitem"
sent_date: 2013-04-16T13:47:04-07:00
---


Hi Tom,

Here is an example that runs from the Riak console and dumps all keys of a 
bucket to a file and shows how stream\_list\_keys can be used:

-module(keylister).
 
-export([list\_keys\_to\_file/2]).
 
-define(TIMEOUT, 10000000).
 
%% @spec list\_keys\_to\_file(binary(), string()) -&gt;
%% ok | {error, term()}
list\_keys\_to\_file(Bucket, File) when is\_binary(Bucket) andalso is\_list(File) -&gt;
 {ok, C} = riak:local\_client(),
 case file:open(File, [write]) of 
 {ok, IoDev} -&gt;
 C:stream\_list\_keys(Bucket, ?TIMEOUT),
 write\_keys\_to\_file(IoDev);
 {error, Reason} -&gt;
 {error, Reason}
 end.
 
write\_keys\_to\_file(IoDev) -&gt;
 receive
 {\_, {keys,Keys}} -&gt;
 Output = [[K, &lt;&lt;"\n"&gt;&gt;] || K &lt;- Keys],
 file:write(IoDev, Output),
 write\_keys\_to\_file(IoDev);
 {\_, From, {keys,Keys}} -&gt;
 riak\_kv\_keys\_fsm:ack\_keys(From),
 Output = [[K, &lt;&lt;"\n"&gt;&gt;] || K &lt;- Keys],
 file:write(IoDev, Output),
 write\_keys\_to\_file(IoDev);
 {\_, done} -&gt;
 file:close(IoDev);
 M -&gt;
 {error, unexpected\_message, M}
 end.

Although there are times when this is useful to use, it is NOT recommended for 
production use as it has to traverse ALL keys stored in the cluster, see: 
http://docs.basho.com/riak/latest/references/apis/http/HTTP-List-Keys/

Best regards,

Christian




On 16 Apr 2013, at 15:49, tom kelly  wrote:

&gt; Hi List,
&gt; I'm experimenting with riak 1.3.1 and I've started a cluster with two nodes, 
&gt; connected from a dev node and wrote & read a few test keys and everything was 
&gt; looking good. I was in the process of writing a few functions we'll need in 
&gt; our system, one of which needs to cycle through all the keys at startup, 
&gt; stream\_list\_keys looked like it would do the job but I've just noticed this 
&gt; strange behavior:
&gt; 
&gt; (a...@dev1.bfast.com)41&gt; 
&gt; (a...@dev1.bfast.com)41&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,2583625}
&gt; (a...@dev1.bfast.com)42&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,98542259}
&gt; (a...@dev1.bfast.com)43&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,83513611}
&gt; (a...@dev1.bfast.com)44&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,112529022}
&gt; (a...@dev1.bfast.com)45&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,66267591}
&gt; (a...@dev1.bfast.com)46&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,90620806}
&gt; (a...@dev1.bfast.com)47&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,24108838}
&gt; (a...@dev1.bfast.com)48&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,17013899}
&gt; (a...@dev1.bfast.com)49&gt; DB:stream\_list\_keys(&lt;&lt;"test"&gt;&gt;).
&gt; {ok,48399864}
&gt; (a...@dev1.bfast.com)50&gt; flush().
&gt; Shell got {2583625,{&lt;5272.17627.0&gt;,#Ref&lt;5272.0.0.95523&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {98542259,{&lt;5272.17656.0&gt;,#Ref&lt;5272.0.0.95733&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {83513611,{&lt;5272.17670.0&gt;,#Ref&lt;5272.0.0.95901&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {112529022,{&lt;5272.17683.0&gt;,#Ref&lt;5272.0.0.96064&gt;},{keys,[]}}
&gt; Shell got {66267591,{&lt;5272.17698.0&gt;,#Ref&lt;5272.0.0.96224&gt;},{keys,[]}}
&gt; Shell got {90620806,{&lt;5272.17708.0&gt;,#Ref&lt;5272.0.0.96375&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {24108838,{&lt;5272.17717.0&gt;,#Ref&lt;5272.0.0.96482&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {17013899,{&lt;5272.17731.0&gt;,#Ref&lt;5272.0.0.96638&gt;},{keys,[&lt;&lt;1&gt;&gt;]}}
&gt; Shell got {48399864,{&lt;5272.17736.0&gt;,#Ref&lt;5272.0.0.96767&gt;},{keys,[]}}
&gt; ok
&gt; 
&gt; The key &lt;&lt;1&gt;&gt; was written over an hour ago and these successive calls to 
&gt; stream\_list\_keys are ~2 seconds apart, The key isn't always in the first keys 
&gt; message returned and there's only ever one message returned per call. From 
&gt; the comments in the source I expected all the keys to be returned followed by 
&gt; the done message.
&gt; Am I misunderstanding or misusing anything here? Any pointers welcomed.
&gt; Thanks,
&gt; //TTom.
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

