---
title: "[PATCH] Adapt to R14 changes with compat macros"
description: ""
project: community
lastmod: 2010-09-24T01:55:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01122"
author_name: "Tuncer Ayaz"
project_section: "mailinglistitem"
sent_date: 2010-09-24T01:55:42-07:00
---


# HG changeset patch
# User Tuncer Ayaz 
# Date 1285318146 -7200
# Node ID 2a512594f4eb50d69aaf9443ec58d68480d62544
# Parent 2cbd7361b5c946d6b5bb2ab0be4cbc28d7867f2a
Adapt to R14 changes with compat macros

Pull in erl\_nif\_compat.h as found in ebloom.

diff -r 2cbd7361b5c9 -r 2a512594f4eb c\_src/erl\_nif\_compat.h
--- /dev/null Thu Jan 01 00:00:00 1970 +0000
+++ b/c\_src/erl\_nif\_compat.h Fri Sep 24 10:49:06 2010 +0200
@@ -0,0 +1,48 @@
+#ifndef ERL\_NIF\_COMPAT\_H\_
+#define ERL\_NIF\_COMPAT\_H\_
+
+#ifdef \_\_cplusplus
+extern "C" {
+#endif /\* \_\_cplusplus \*/
+
+#include "erl\_nif.h"
+
+#if ERL\_NIF\_MAJOR\_VERSION == 1 && ERL\_NIF\_MINOR\_VERSION == 0
+
+#define enif\_open\_resource\_type\_compat enif\_open\_resource\_type
+#define enif\_alloc\_resource\_compat enif\_alloc\_resource
+#define enif\_release\_resource\_compat enif\_release\_resource
+#define enif\_alloc\_binary\_compat enif\_alloc\_binary
+#define enif\_alloc\_compat enif\_alloc
+#define enif\_free\_compat enif\_free
+#endif /\* R13B04 \*/
+
+#if ERL\_NIF\_MAJOR\_VERSION == 2 && ERL\_NIF\_MINOR\_VERSION == 0
+
+#define enif\_open\_resource\_type\_compat(E, N, D, F, T) \
+ enif\_open\_resource\_type(E, NULL, N, D, F, T)
+
+#define enif\_alloc\_resource\_compat(E, T, S) \
+ enif\_alloc\_resource(T, S)
+
+#define enif\_release\_resource\_compat(E, H) \
+ enif\_release\_resource(H)
+
+#define enif\_alloc\_binary\_compat(E, S, B) \
+ enif\_alloc\_binary(S, B)
+
+#define enif\_alloc\_compat(E, S) \
+ enif\_alloc(S)
+
+#define enif\_free\_compat(E, P) \
+ enif\_free(P)
+
+#endif /\* R14 \*/
+
+
+
+#ifdef \_\_cplusplus
+}
+#endif /\* \_\_cplusplus \*/
+
+#endif /\* ERL\_NIF\_COMPAT\_H\_ \*/
diff -r 2cbd7361b5c9 -r 2a512594f4eb c\_src/skerl\_nifs.c
--- a/c\_src/skerl\_nifs.c Tue Sep 21 15:46:20 2010 -0700
+++ b/c\_src/skerl\_nifs.c Fri Sep 24 10:49:06 2010 +0200
@@ -1,5 +1,6 @@
 
 #include "erl\_nif.h"
+#include "erl\_nif\_compat.h"
 #include "skein\_api.h"
 #include 
 
@@ -31,7 +32,7 @@
 
 int load(ErlNifEnv\* env, void \*\* priv\_data, ERL\_NIF\_TERM load\_info)
 {
- skein\_hashstate = enif\_open\_resource\_type(env, "hashstate", NULL, 
ERL\_NIF\_RT\_CREATE, NULL);
+ skein\_hashstate = enif\_open\_resource\_type\_compat(env, "hashstate", NULL, 
ERL\_NIF\_RT\_CREATE, NULL);
 return 0;
 }
 
@@ -42,14 +43,14 @@
 if(!enif\_get\_int(env, argv[0], &bits))
 return enif\_make\_badarg(env);
 
- hashState \*state = (hashState\*) enif\_alloc\_resource(env, skein\_hashstate, 
sizeof(hashState));
+ hashState \*state = (hashState\*) enif\_alloc\_resource\_compat(env, 
skein\_hashstate, sizeof(hashState));
 HashReturn r = Init(state, bits);
 if (r == SUCCESS) {
 hash\_state\_term = enif\_make\_resource(env, state);
- enif\_release\_resource(env, state);
+ enif\_release\_resource\_compat(env, state);
 return enif\_make\_tuple2(env, enif\_make\_atom(env, "ok"), 
hash\_state\_term);
 } else {
- enif\_release\_resource(env, state);
+ enif\_release\_resource\_compat(env, state);
 return enif\_make\_tuple2(env, enif\_make\_atom(env, "error"), 
enif\_make\_atom(env, "fail"));
 }
 }
@@ -75,7 +76,7 @@
 enif\_get\_resource(env, argv[0], skein\_hashstate, (void\*\*)&state);
 
 ErlNifBinary out;
- enif\_alloc\_binary(env, (size\_t)(state-&gt;statebits/8), &out);
+ enif\_alloc\_binary\_compat(env, (size\_t)(state-&gt;statebits/8), &out);
 
 HashReturn r = Final(state, (BitSequence \*)out.data);
 if (r == SUCCESS) {
@@ -92,7 +93,7 @@
 
 ErlNifBinary bin, out;
 enif\_inspect\_binary(env, argv[1], &bin);
- enif\_alloc\_binary(env, (size\_t)(bits/8), &out);
+ enif\_alloc\_binary\_compat(env, (size\_t)(bits/8), &out);
 
 HashReturn r = Hash(bits, (BitSequence \*)(bin.data), bin.size \* 8, 
(BitSequence \*)out.data);
 if (r == SUCCESS) {

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

