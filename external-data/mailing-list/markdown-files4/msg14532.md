---
title: "Re: Random Block Not Found Issues with Riak/Riak CS"
description: ""
project: community
lastmod: 2014-07-22T04:18:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14532"
mailinglist_parent_id: "msg14531"
author_name: "Dave Finster"
project_section: "mailinglistitem"
sent_date: 2014-07-22T04:18:42-07:00
---


Hi Charles

We have a slightly different issue to yours in the majority of our requests 
succeed and only the odd one fails - or is that what you are observing on your 
cluster?

I’ve been talking about the issue off-list with Luke and Kelly. Luke took a 
look at some of our debug logs for Riak and suspects that we had over-committed 
the resources of our cluster. I’ve modified the configuration of our cluster as 
per his recommendations:

{multi\_backend, [
 {be\_default, riak\_kv\_eleveldb\_backend, [
 {max\_open\_files, 14},
 {cache\_size, 4194304},
 {data\_root, "/var/db/riak/leveldb"}
 ]},
 {be\_blocks, riak\_kv\_bitcask\_backend, [
 {data\_root, "/var/db/riak/bitcask"}
 ]}
]},

{anti\_entropy, {off, []}},

Our environment is a 4 node cluster with 4GB of RAM each running on SmartOS 
(from Joyent). I applied these changes, but while things improved I still 
encountered the odd failure. I also de-activated n\_val\_1\_get\_requests and I 
haven’t been able to reproduce the issues that I was encountering previously. 

Thanks,
Dave

&gt; On 22 Jul 2014, at 9:01 pm, Charles Bijon  wrote:
&gt; 
&gt; Hi,
&gt; 
&gt; We have the same issue there. But we have 45 riak/riak-cs nodes in 
&gt; production. Do you have any idea to correct it ?
&gt; 
&gt; Regards,
&gt; 
&gt; Charles
&gt; 
&gt; 
&gt; Le 17/07/2014 23:21, Dave Finster a écrit :
&gt;&gt; Hi Kelly
&gt;&gt; 
&gt;&gt; 1.4.5 - Riak CS
&gt;&gt; 1.4.8 - Riak
&gt;&gt; Anti Entropy is on (all nodes)
&gt;&gt; 
&gt;&gt; Deactivating n\_val\_1\_get\_requests still allows me to cause the issue (with 
&gt;&gt; less occurrence), however a different error has cropped up now:
&gt;&gt; 
&gt;&gt; 2014-07-17 21:15:38 =ERROR REPORT====
&gt;&gt; webmachine error: path="/buckets/&gt; name&gt;/objects/bf15f98c-eaa1-4ff9-83ff-24c1e7e1380f%2F847c340cfe2f44028d6fd5606f696796%2FAttachment-1.png"
&gt;&gt; {exit,{{{{case\_clause,{error,timeout}},[{riak\_cs\_manifest\_fsm,handle\_get\_manifests,1,[{file,"src/riak\_cs\_manifest\_fsm.erl"},{line,265}]},{riak\_cs\_manifest\_fsm,waiting\_command,3,[{file,"src/riak\_cs\_manifest\_fsm.erl"},{line,201}]},{gen\_fsm,handle\_msg,7,[{file,"gen\_fsm.erl"},{line,494}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]},{gen\_fsm,sync\_send\_event,[&lt;0.1383.0&gt;,get\_manifests,infinity]}},{gen\_fsm,sync\_send\_event,[&lt;0.1382.0&gt;,get\_manifest,infinity]}},[{gen\_fsm,sync\_send\_event,3,[{file,"gen\_fsm.erl"},{line,214}]},{riak\_cs\_wm\_utils,ensure\_doc,2,[{file,"src/riak\_cs\_wm\_utils.erl"},{line,236}]},{riak\_cs\_wm\_object,authorize,2,[{file,"src/riak\_cs\_wm\_object.erl"},{line,64}]},{riak\_cs\_wm\_common,authorize,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,396}]},{riak\_cs\_wm\_common,forbidden,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,182}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,
&gt;&gt; [{ 
&gt;&gt; file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]}
&gt;&gt; [{gen\_fsm,sync\_send\_event,3,[{file,"gen\_fsm.erl"},{line,214}]},{riak\_cs\_wm\_utils,ensure\_doc,2,[{file,"src/riak\_cs\_wm\_utils.erl"},{line,236}]},{riak\_cs\_wm\_object,authorize,2,[{file,"src/riak\_cs\_wm\_object.erl"},{line,64}]},{riak\_cs\_wm\_common,authorize,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,396}]},{riak\_cs\_wm\_common,forbidden,2,[{file,"src/riak\_cs\_wm\_common.erl"},{line,182}]},{webmachine\_resource,resource\_call,3,[{file,"src/webmachine\_resource.erl"},{line,186}]},{webmachine\_resource,do,3,[{file,"src/webmachine\_resource.erl"},{line,142}]},{webmachine\_decision\_core,resource\_call,1,[{file,"src/webmachine\_decision\_core.erl"},{line,48}]}]
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; Dave
&gt;&gt; 
&gt;&gt;&gt; On 18 Jul 2014, at 2:19 am, Kelly McLaughlin  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Dave,
&gt;&gt;&gt; 
&gt;&gt;&gt; Can you tell me what versions of Riak and Riak CS you have installed? Do 
&gt;&gt;&gt; you have AAE enabled or disabled? It’s tough to come up with an explanation 
&gt;&gt;&gt; without more information, but I would try setting n\_val\_1\_get\_requests to 
&gt;&gt;&gt; false and see if you continue to experience the problem. My guess is that 
&gt;&gt;&gt; will resolve the issue, but let me know what happens. 
&gt;&gt;&gt; 
&gt;&gt;&gt; Kelly
&gt;&gt;&gt; 
&gt;&gt;&gt; On July 17, 2014 at 1:00:19 AM, Dave Finster (davefins...@icloud.com) wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Hi Everyone
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Spent a bit of time trying to debug this one and not sure were to from 
&gt;&gt;&gt;&gt; here. The use case that appears to cause this breakage is a web page that 
&gt;&gt;&gt;&gt; links to 8 x 10MB images and it attempts to fetch them simultaneously. 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Occasionally, one or two of the images will just fail to load, while other 
&gt;&gt;&gt;&gt; times they all work file. I’ve tracked it down to the crash below. It 
&gt;&gt;&gt;&gt; isn’t always the same image. To make the problem more repeatable, I forced 
&gt;&gt;&gt;&gt; our load balancer into only using a single Riak-CS node, so it will be 
&gt;&gt;&gt;&gt; getting hit with all the requests. We are using HAProxy out the front and 
&gt;&gt;&gt;&gt; are running SmartOS 64-bit images across the board.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; arekinath helped me look into it and one thought was that I was hit by the 
&gt;&gt;&gt;&gt; AAE bug prior to 1.4.8, but even clearing the AAE made no difference. The 
&gt;&gt;&gt;&gt; n-val on the buckets is 3 and its a 4-node cluster. All 4 nodes have both 
&gt;&gt;&gt;&gt; a Riak and a Riak-CS node on it. I also have pb\_backlog turned up to 256, 
&gt;&gt;&gt;&gt; n\_val\_1\_get\_requests set to true and fold\_objects\_for\_list\_keys set to 
&gt;&gt;&gt;&gt; true. ‘ring-status’ shows that the whole ring is reachable. 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Any idea on how to diagnose this one further?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 2014-07-17 06:38:54 =CRASH REPORT====
&gt;&gt;&gt;&gt; crasher:
&gt;&gt;&gt;&gt; initial call: mochiweb\_acceptor:init/3
&gt;&gt;&gt;&gt; pid: &lt;0.26119.1&gt;
&gt;&gt;&gt;&gt; registered\_name: []
&gt;&gt;&gt;&gt; exception exit: 
&gt;&gt;&gt;&gt; {{normal,{gen\_fsm,sync\_send\_event,[&lt;0.27617.1&gt;,get\_next\_chunk,infinity]}},[{gen\_fsm,sync\_send\_event,3,[{file,"gen\_fsm.erl"},{line,214}]},{riak\_cs\_wm\_utils,streaming\_get,4,[{file,"src/riak\_cs\_wm\_utils.erl"},{line,272}]},{webmachine\_decision\_core,'-make\_encoder\_stream/3-fun-0-',3,[{file,"src/webmachine\_decision\_core.erl"},{line,667}]},{webmachine\_request,send\_stream\_body\_no\_chunk,2,[{file,"src/webmachine\_request.erl"},{line,334}]},{webmachine\_request,send\_response,3,[{file,"src/webmachine\_request.erl"},{line,398}]},{webmachine\_request,call,2,[{file,"src/webmachine\_request.erl"},{line,251}]},{webmachine\_decision\_core,wrcall,1,[{file,"src/webmachine\_decision\_core.erl"},{line,42}]},{webmachine\_decision\_core,finish\_response,3,[{file,"src/webmachine\_decision\_core.erl"},{line,92}]}]}
&gt;&gt;&gt;&gt; ancestors: [object\_web\_mochiweb,riak\_cs\_sup,&lt;0.143.0&gt;]
&gt;&gt;&gt;&gt; messages: []
&gt;&gt;&gt;&gt; links: [&lt;0.298.0&gt;,#Port&lt;0.12015&gt;]
&gt;&gt;&gt;&gt; dictionary: 
&gt;&gt;&gt;&gt; [{reqstate,{wm\_reqstate,#Port&lt;0.12015&gt;,[{'content-encoding',"identity"},{'content-type',"application/octet-stream"},{resource\_module,riak\_cs\_wm\_object}],undefined,"10.4.242.1",{wm\_reqdata,'GET',http,{1,1},"10.4.242.1",undefined,[],"/buckets/&gt;&gt;&gt; bucket 
&gt;&gt;&gt;&gt; name&gt;/objects/bf15f98c-eaa1-4ff9-83ff-24c1e7e1380f%2F847c340cfe2f44028d6fd5606f696796%2FAttachment-1.png","/buckets/&gt;&gt;&gt; bucket 
&gt;&gt;&gt;&gt; name&gt;/objects/bf15f98c-eaa1-4ff9-83ff-24c1e7e1380f%2F847c340cfe2f44028d6fd5606f696796%2FAttachment-1.png?Signature=U0By3mIwaRIVBHNcYhSt6r5QgPk%3D&Expires=1405580057&AWSAccessKeyId=DGTXHHWIEDF4XUBSBYVI",[{bucket,"&gt;&gt;&gt; bucket 
&gt;&gt;&gt;&gt; name&gt;"},{object,"bf15f98c-eaa1-4ff9-83ff-24c1e7e1380f%2F847c340cfe2f44028d6fd5606f696796%2FAttachment-1.png"}],[],"../../../..",{200,undefined},1073741824,67108864,[{"\_ga","GA1.3.643660316.1404789703"}],[{"Signature","U0By3mIwaRIVBHNcYhSt6r5QgPk="},{"Expires","1405580057"},{"AWSAccessKeyId","DGTXHHWIEDF4XUBSBYVI"}],{9,{"cookie",{'Cookie',"\_ga=GA1.3.643660316.1404789703"},{"accept-language",{'Accept-Language',"en-US,en;q=0.8"},{"accept-encoding",{'Accept-Encoding',"gzip,deflate,sdch"},{"accept",{'Accept',"image/webp,\*/\*;q=0.8"},nil,nil},nil},{"connection",{'Connection',"keep-alive"},nil,nil}},{"referer",{'Referer’,”&gt;&gt;&gt; referrer&gt;"},{"host",{'Host’,”&gt;&gt;&gt; name&gt;"},nil,nil},{"user-agent",{'User-Agent',"Mozilla/5.0 (Macintosh; 
&gt;&gt;&gt;&gt; Intel Mac OS X 10\_10\_0) AppleWebKit/537.36 (KHTML, like Gecko) 
&gt;&gt;&gt;&gt; Chrome/35.0.1916.153 
&gt;&gt;&gt;&gt; Safari/537.36"},nil,{"x-rcs-rewrite-path",{"x-rcs-rewrite-path","/&gt;&gt;&gt; bucket 
&gt;&gt;&gt;&gt; name&gt;/bf15f98c-eaa1-4ff9-83ff-24c1e7e1380f/847c340cfe2f44028d6fd5606f696796/Attachment-1.png?AWSAccessKeyId=DGTXHHWIEDF4XUBSBYVI&Expires=1405580057&Signature=U0By3mIwaRIVBHNcYhSt6r5QgPk%3D"},nil,nil}}}}},not\_fetched\_yet,false,{3,{"content-type",{"Content-Type","application/octet-stream"},nil,{"etag",{"ETag","\"a3a32cf5d8f502d7e8d35fd8412a6878\""},nil,
&gt;&gt;&gt;&gt; trap\_exit: false
&gt;&gt;&gt;&gt; status: running
&gt;&gt;&gt;&gt; heap\_size: 28657
&gt;&gt;&gt;&gt; stack\_size: 24
&gt;&gt;&gt;&gt; reductions: 80773
&gt;&gt;&gt;&gt; neighbours:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt; Dave Finster
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

