---
title: "Use of binary keys within MapReduce jobs"
description: ""
project: community
lastmod: 2011-09-13T19:44:40-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04691"
author_name: "Elias Levy"
project_section: "mailinglistitem"
sent_date: 2011-09-13T19:44:40-07:00
---


I am observing an error while running a MR job that I think is related to my
attempt as using binary keys. The error results in a crash. I upgraded to
1.0.0pre2 in the hope that the better support for binary keys would resolve
the problem, but it has not.

The crash and error reports are below. The MP job in question is a simple
proof of concept. It uses a query as input, has a JS inline map function
that maps each object to 1, and uses the builtin Riak.reduceSum function to
generate a count of matching objects.

{
 "timeout": 600000,
 "inputs": {
 "module" : "riak\_search",
 "function" : "mapred\_search",
 "arg" : [ "events", "data\_fnd:foo"]
 },
 "query": [
 {
 "map":
 {
 "language": "javascript",
 "source": "function(obj) { return [1]; }"
 },
 },
 {
 "reduce":
 {
 "language": "javascript",
 "name": "Riak.reduceSum"
 }
 }
 ]
}

As you can see from the error report, the key is binary, while the data is
encoded in JSON and the char type is 8-bit US ASCII. The JSON is valid JSON.
 The error claims the problem js\_driver, eval\_js and that the problem is
bad encoding.

I am guessing that something is attempting to interpret the binary key as a
UTF8 string or some such thing, which will generate an error as the keys are
not valid in the encoding.

Is this what is happening? And if so, it there any way to use binary keys
with JS functions?


2011-09-14 00:10:58 =CRASH REPORT====
 crasher:
 initial call: riak\_pipe\_vnode\_worker:init/1
 pid: &lt;0.3821.0&gt;
 registered\_name: []
 exception exit: processing\_error
 in function gen\_fsm:terminate/7
 in call from proc\_lib:init\_p\_do\_apply/3
 ancestors:
[&lt;0.202.0&gt;,&lt;0.201.0&gt;,riak\_core\_vnode\_sup,riak\_core\_sup,&lt;0.91.0&gt;]
 messages: []
 links: [&lt;0.201.0&gt;,&lt;0.202.0&gt;]
 dictionary:
[{eunit,[{module,riak\_pipe\_vnode\_worker},{partition,68507889249886074290797726533575766546371837952},{&lt;0.201.0&gt;,&lt;0.201.0&gt;},{details,{fitting\_details,{fitting,&lt;0.3715.0&gt;,#Ref&lt;0.0.0.65882&gt;,follow,1},{xform\_map,0},riak\_kv\_mrc\_map,
{{jsanon,&lt;&lt;"function(obj) { return [1];
}"&gt;&gt;},none},{fitting,&lt;0.3714.0&gt;,#Ref&lt;0.0.0.65882&gt;,#Fun,1},[{sink,{fitting,&lt;0.110.0&gt;,#Ref&lt;0.0.0.65882&gt;,sink,undefined}},{log,sink},{trace,{set,1,16,16,8,80,48,{[],[],[],[],[]
,[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[error],[],[],[],[],[],[],[],[],[],[],[],[],[]}}}}],64}}]}]
 trap\_exit: false
 status: running
 heap\_size: 987
 stack\_size: 24
 reductions: 2002
 neighbours:
2011-09-14 00:10:58 =SUPERVISOR REPORT====
 Supervisor: {&lt;0.202.0&gt;,riak\_pipe\_vnode\_worker\_sup}
 Context: child\_terminated
 Reason: processing\_error
 Offender:
[{pid,&lt;0.3821.0&gt;},{name,undefined},{mfargs,{riak\_pipe\_vnode\_worker,start\_link,undefined}},{restart\_type,temporary},{shutdown,2000},{child\_type,worker}]

2011-09-14 00:10:58 =SUPERVISOR REPORT====
 Supervisor: {local,riak\_kv\_js\_sup}
 Context: child\_terminated
 Reason:
{function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.7099&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_ap
ply,3}]}
 Offender:
[{pid,&lt;0.3812.0&gt;},{name,undefined},{mfargs,{riak\_kv\_js\_vm,start\_link,undefined}},{restart\_type,temporary},{shutdown,2000},{child\_type,worker}]

2011-09-14 00:10:58 =ERROR REPORT====
\*\* Generic server &lt;0.3822.0&gt; terminating
\*\* Last message in was
{dispatch,{&lt;0.3822.0&gt;,#Ref&lt;0.0.0.67797&gt;},{{jsanon,&lt;&lt;"function(obj) { return
[1]; }"&gt;&gt;},[{struct,[{&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"events"&gt;&gt;},{
&lt;&lt;"key"&gt;&gt;,&lt;&lt;"ND"[132,133,109,165,135,33,59,119,71,77,148,101,73,183,107,167,50,239,3,185]&gt;&gt;}
,{
&lt;&lt;"vclock"&gt;&gt;,&lt;&lt;"a85hYGBgzmDKBVIsjMej2jOYEhnzWBnuv3xwnA8qzKwhuhwq3HnnIUyYrTmJVSR1M7JEFgA="&gt;&gt;},{&lt;&lt;"values"&gt;&gt;,[{struct,[{&lt;&lt;"metadata"&gt;&gt;,{struct,[{&lt;&lt;"X-Riak-VTag"&gt;&gt;,&lt;&lt;"1AO1uqa9gpEdppAdAqMdyA"&gt;&gt;},{
&lt;&lt;"content-type"&gt;&gt;,&lt;&lt;"application/json"&gt;&gt;},{&lt;&lt;"X-Ri
ak-Last-Modified"&gt;&gt;,&lt;&lt;"Mon, 12 Sep 2011 01:29:45 GMT"&gt;&gt;},{
&lt;&lt;"charset"&gt;&gt;,&lt;&lt;"ASCII-8BIT"&gt;&gt;
}]}},{&lt;&lt;"data"&gt;&gt;,&lt;&lt;"{"id":953,"tso":1313113221,"data":{"fnd":"foo"}}"&gt;&gt;}]}]}]},{struct,[{&lt;&lt;"data\_fnd"&gt;&gt;,&lt;&lt;"foo"&gt;&gt;},{p,[3]},{score,[1.0]}]},none]}}
\*\* When Server state == {state,&lt;0.253.0&gt;,riak\_kv\_js\_map,#Port&lt;0.7112&gt;,false}
\*\* Reason for termination ==
\*\*
{function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.7112&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]}
2011-09-14 00:10:58 =CRASH REPORT====
 crasher:
 initial call: riak\_kv\_js\_vm:init/1
 pid: &lt;0.3822.0&gt;
 registered\_name: []
 exception 
exit:{function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.7112&gt;,{error,bad\_encoding},5000]}
,{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do
\_apply,3}]}
 in function gen\_server:terminate/6
 in call from proc\_lib:init\_p\_do\_apply/3
 ancestors: [riak\_kv\_js\_sup,riak\_kv\_sup,&lt;0.172.0&gt;]
 messages: []
 links: [&lt;0.252.0&gt;]
 dictionary: []
 trap\_exit: false
 status: running
 heap\_size: 10946
 stack\_size: 24
 reductions: 8678
 neighbours:
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

