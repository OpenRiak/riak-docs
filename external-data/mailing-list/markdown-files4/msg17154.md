---
title: "Re: Using $bucket index for listing keys"
description: ""
project: community
lastmod: 2016-03-11T08:29:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17154"
mailinglist_parent_id: "msg17146"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2016-03-11T08:29:57-08:00
---


You can’t…can you? I mean, 2i requires level. It requires ordered keys. Which 
explains your problem, but you should have failed a lot earlier.

On 11 Mar 2016, at 16:26, Oleksiy Krivoshey  wrote:

&gt; Hi Magnus,
&gt; 
&gt; The bucket type has the following properties:
&gt; 
&gt; '{"props":{"backend":"fs\_chunks","allow\_mult":"false","r":1,"notfound\_ok":"false","basic\_quorum":"false"}}'
&gt; 
&gt; fs\_chunks backend is configured as part of riak\_kv\_multi\_backend:
&gt; 
&gt; {&lt;&lt;"fs\_chunks"&gt;&gt;, riak\_kv\_bitcask\_backend, [
&gt; {data\_root, "/var/lib/riak/fs\_chunks"}
&gt; ]},
&gt; 
&gt; Objects stored are chunks of binary data (ContentType=binary/octet-stream) 
&gt; with a maximum size of 256Kb. Each object also has a single key/value pair in 
&gt; user metadata (usermeta).
&gt; 
&gt; I'm not able to replicate this on my local single node setup, it only happens 
&gt; on a production 5 node cluster.
&gt; 
&gt; 
&gt; On 11 March 2016 at 15:53, Magnus Kessler  wrote:
&gt; Hi Oleksiy,
&gt; 
&gt; Could you please share the bucket or bucket-type properties for that small 
&gt; bucket? If you open an issue on github, please add the properties there, too.
&gt; 
&gt; Many Thanks,
&gt; 
&gt; On 11 March 2016 at 13:46, Oleksiy Krivoshey  wrote:
&gt; I got the recursive behavior with other, larger buckets but I had no logging 
&gt; so when I enabled debugging this was the first bucket to replicate the 
&gt; problem. I have a lot of buckets of the same type, some have many thousands 
&gt; keys some are small. My task is to iterate the keys (once only) of all 
&gt; buckets. Either with 2i or with Yokozuna. 
&gt; On Fri, Mar 11, 2016 at 15:32 Russell Brown  wrote:
&gt; Not the answer, by why pagination for 200 keys? Why the cost of doing the 
&gt; query 20 times vs once?
&gt; 
&gt; On 11 Mar 2016, at 13:28, Oleksiy Krivoshey  wrote:
&gt; 
&gt; &gt; Unfortunately there are just 200 keys in that bucket. So with larger 
&gt; &gt; max\_results I just get all the keys without continuation. I'll try to 
&gt; &gt; replicate this with a bigger bucket.
&gt; &gt; On Fri, Mar 11, 2016 at 15:21 Russell Brown  wrote:
&gt; &gt; That seems very wrong. Can you do me a favour and try with a larger 
&gt; &gt; max\_results. I remember a bug with small results set, I thought it was 
&gt; &gt; fixed, I’m looking into the past issues, but can you try “max\_results=1000” 
&gt; &gt; or something, and let me know what you see?
&gt; &gt;
&gt; &gt; On 11 Mar 2016, at 13:03, Oleksiy Krivoshey  wrote:
&gt; &gt;
&gt; &gt; &gt; Here it is without the `value` part of request:
&gt; &gt; &gt;
&gt; &gt; &gt; curl 
&gt; &gt; &gt; 'http://127.0.0.1:8098/types/fs\_chunks/buckets/0r0e5wahrhsgpolk9stbnrqmp77fjjye.chunks/index/$bucket/\_?max\_results=10&continuation=g20AAAAja1AzdzJwOXpYcVoyb0F4NDhTMVNnRUpBbGJ0ZkhVdkk6MjU='
&gt; &gt; &gt;
&gt; &gt; &gt; {"keys":["4rpG2PwRTs3YqasGGYrhACBvZqTg7mQW:0","4rpG2PwRTs3YqasGGYrhACBvZqTg7mQW:2","FSEky50kr2TLkBuo1JKv6sphINYwnJfV:1","F3KcwtjG9VAtM5u8vbwBuCjuGBrPTnfq:0","RToMNlsnVKvXcawQK6BGnCAKx58pC9xX:1","UMiHx4qDR5pHWT9OgLAu1KMlFeEKbISm:0","F3KcwtjG9VAtM5u8vbwBuCjuGBrPTnfq:2","YQlRWkJPFYiLlAwhvgqOysJC3ycmQ9OA:0","kP3w2p9zXqZ2oAx48S1SgEJAlbtfHUvI:15","kP3w2p9zXqZ2oAx48S1SgEJAlbtfHUvI:25"],"continuation":"g20AAAAja1AzdzJwOXpYcVoyb0F4NDhTMVNnRUpBbGJ0ZkhVdkk6MjU="}
&gt; &gt; &gt;
&gt; &gt; &gt; On 11 March 2016 at 14:58, Oleksiy Krivoshey  wrote:
&gt; &gt; &gt; I'm actually using PB interface, but I can replicate the problem with 
&gt; &gt; &gt; HTTP as in my previous email. Request with '&continuation=AAAA' returns 
&gt; &gt; &gt; the result set with the same continuation AAAA.
&gt; &gt; &gt;
&gt; &gt; &gt; On 11 March 2016 at 14:55, Magnus Kessler  wrote:
&gt; &gt; &gt; Hi Oleksiy,
&gt; &gt; &gt;
&gt; &gt; &gt; How are you performing your 2i-based key listing? Querying with 
&gt; &gt; &gt; pagination as shown in the documentation[0] should work.
&gt; &gt; &gt;
&gt; &gt; &gt; As an example here is the HTTP invocation:
&gt; &gt; &gt;
&gt; &gt; &gt; curl 
&gt; &gt; &gt; "https://localhost:8098/types/default/buckets/test/index/\$bucket/\_?max\_results=10&continuation=g20AAAACNTM="
&gt; &gt; &gt;
&gt; &gt; &gt; Once the end of the key list is reached, the server returns an empty keys 
&gt; &gt; &gt; list and no further continuation value.
&gt; &gt; &gt;
&gt; &gt; &gt; Please let me know if this works for you.
&gt; &gt; &gt;
&gt; &gt; &gt; Kind Regards,
&gt; &gt; &gt;
&gt; &gt; &gt; Magnus
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; [0]: http://docs.basho.com/riak/latest/dev/using/2i/#Querying
&gt; &gt; &gt;
&gt; &gt; &gt; On 11 March 2016 at 10:06, Oleksiy Krivoshey  wrote:
&gt; &gt; &gt; Anyone?
&gt; &gt; &gt;
&gt; &gt; &gt; On 4 March 2016 at 19:11, Oleksiy Krivoshey  wrote:
&gt; &gt; &gt; I have a bucket with ~200 keys in it and I wanted to iterate them with 
&gt; &gt; &gt; the help of $bucket index and 2i request, however I'm facing the 
&gt; &gt; &gt; recursive behaviour, for example I send the following 2i request:
&gt; &gt; &gt;
&gt; &gt; &gt; {
&gt; &gt; &gt; bucket: 'BUCKET\_NAME',
&gt; &gt; &gt; type: 'BUCKET\_TYPE',
&gt; &gt; &gt; index: '$bucket',
&gt; &gt; &gt; key: 'BUCKET\_NAME',
&gt; &gt; &gt; qtype: 0,
&gt; &gt; &gt; max\_results: 10,
&gt; &gt; &gt; continuation: 'AAAA'
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; I receive 10 keys and continuation 'BBBB', I then repeat the request with 
&gt; &gt; &gt; continuation 'BBBB' and at this point I can receive a reply with 
&gt; &gt; &gt; continuation 'CCCC' or 'AAAA' or even 'BBBB' and its going in never 
&gt; &gt; &gt; ending recursion.
&gt; &gt; &gt;
&gt; &gt; &gt; I'm running this on a 5 node 2.1.3 cluster.
&gt; &gt; &gt;
&gt; &gt; &gt; What I'm doing wrong? Or is this not supported at all?
&gt; &gt; &gt;
&gt; &gt; &gt; Thanks!
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; --
&gt; &gt; &gt; Magnus Kessler
&gt; &gt; &gt; Client Services Engineer
&gt; &gt; &gt; Basho Technologies Limited
&gt; &gt; &gt;
&gt; &gt; &gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg 07970431
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; 
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Magnus Kessler
&gt; Client Services Engineer
&gt; Basho Technologies Limited
&gt; 
&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg 07970431
&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

