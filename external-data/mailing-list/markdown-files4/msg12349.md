---
title: "Re: DELETE and vclocks"
description: ""
project: community
lastmod: 2013-09-23T12:16:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12349"
mailinglist_parent_id: "msg12348"
author_name: "Gints Gailītis"
project_section: "mailinglistitem"
sent_date: 2013-09-23T12:16:08-07:00
---


Oh, OK, I think I just got it - the third sibling is created because a
DELETE with the stale vclock is internally the same as a write with a stale
vclock, so sibling resolution potentially needs to take place after I
delete it for the first time, and then, when I delete it for the second
time, that second vclock is now out of date too, at that moment, since the
first delete already updated the object. If that's correct, then scratch 2)
off the list.

Then the only question left is 1) siblings in map reduce - how do I access
them?

Thanks,
Gints



On Mon, Sep 23, 2013 at 8:26 PM, Gints Gailītis wrote:

&gt; Sorry, should have mentioned that, I do set allow\_mult=true.
&gt;
&gt; Also, it seems I had a problem with my initial test - what was failing to
&gt; find the object was my map reduce query, a simple find by key worked just
&gt; fine. But now there seem to be two issues:
&gt;
&gt; 1) How does Riak handle siblings when doing a map reduce query? I assumed
&gt; that there would simply be more elements in the values array, but it seems
&gt; that this is not the case. Basically, the beginning of my javascript map
&gt; function looks something like this:
&gt; function(param) {
&gt; for ( var i=0; i &lt; param.values.length; i++ ) {
&gt; ... do stuff with param.values[i] ...
&gt;
&gt; but this does not seem to let me access all the siblings (or I might have
&gt; screwed something up elsewhere in my code, of course).
&gt;
&gt; Is this how siblings should be handled in map reduce? If not, how?
&gt;
&gt; 2) Now I'm running into another issue where even a simple find by key
&gt; seems to act weird.
&gt;
&gt; When I PUT the object for the first time, I get this vclock:
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCUy5rEyzHy95TRfFgA=
&gt;
&gt; Then I read the object, and get the same vclock back:
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCUy5rEyzHy95TRfFgA=
&gt;
&gt; Then, I modify it, PUT it again, and get a new vclock:
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCUy5bEyzHy95TRfFgA=
&gt;
&gt; Then, I do two deletes, one with each of the vlocks:
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCUy5rEyzHy95TRfFgA=
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCUy5bEyzHy95TRfFgA=
&gt;
&gt; Then, I do another read, and I get a 300 response with 3 siblings, two
&gt; marked X-Riak-Deleted and a third one whose value matches the second PUT.
&gt; The vclock I get along with the 300 response is:
&gt; a85hYGBgzGDKBVIcypz/fgZJFyllMCWy5LEyzHy95TRfFgA=
&gt;
&gt; (Full packet capture, including the setup of the bucket attached).
&gt;
&gt; Why does Riak create the third sibling? All I've basically done is created
&gt; a new object, modified it, and then deleted it, once with a stale vclock,
&gt; once with the latest vclock.
&gt;
&gt;
&gt;
&gt;
&gt; On Mon, Sep 23, 2013 at 7:19 PM, Brady Wetherington 
&gt; wrote:
&gt;
&gt;&gt; Well, I'm not sure, and I'm new to Riak too, but I \*think\* you'd need to
&gt;&gt; set allow\_multi on the bucket.
&gt;&gt;
&gt;&gt; -B.
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, Sep 23, 2013 at 4:01 AM, Gints  wrote:
&gt;&gt;
&gt;&gt;&gt; I did a PUT, and the vclock that came back was:
&gt;&gt;&gt; a85hYGBgzGDKBVIcypz/fgZJFylnMCUy5rEyNOdtOc2XBQA=
&gt;&gt;&gt;
&gt;&gt;&gt; Then I read the object back, modified it, and PUT it again, providing the
&gt;&gt;&gt; old vclock, and got a new vclock:
&gt;&gt;&gt; a85hYGBgzGDKBVIcypz/fgZJFylnMCUy5bEyNOdtOc2XBQA=
&gt;&gt;&gt;
&gt;&gt;&gt; (Notice they are slightly different: Uy5rEy -&gt; Uy5bEy)
&gt;&gt;&gt;
&gt;&gt;&gt; Then, I did a DELETE, using the first vector clock, not the second,
&gt;&gt;&gt; updated
&gt;&gt;&gt; one.
&gt;&gt;&gt;
&gt;&gt;&gt; After that the object was gone, I could not find it in the database any
&gt;&gt;&gt; more.
&gt;&gt;&gt;
&gt;&gt;&gt; Is this supposed to be like that - deleting an object providing a stale
&gt;&gt;&gt; vclock actually deletes it? Or am I probably doing something wrong?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Gints
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; View this message in context:
&gt;&gt;&gt; http://riak-users.197444.n3.nabble.com/DELETE-and-vclocks-tp4029176.html
&gt;&gt;&gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

