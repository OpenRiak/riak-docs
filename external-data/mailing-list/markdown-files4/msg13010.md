---
title: "Search Crashes"
description: ""
project: community
lastmod: 2013-11-18T16:01:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13010"
author_name: "Gabriel Littman"
project_section: "mailinglistitem"
sent_date: 2013-11-18T16:01:10-08:00
---


Hi All,

We've been working with a search enabled bucket in riak for a while now and
off and on it has been giving us trouble. In the past it has been solved
by reindexing all the data by just reading and writing the data back into
riak. But even this is failing now on some input data. Any help/insite
would be greatly appreciated.

We are on riak 1.4
We have recently switched to riak python api 2.0

smrtv@fre-prod-svr15:~$ python
Python 2.7.3 (default, Aug 1 2012, 05:14:39)
[GCC 4.6.3] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import riak
&gt;&gt;&gt; r = riak.RiakClient()
&gt;&gt;&gt; b = r.bucket('ctv\_tvdata')
&gt;&gt;&gt; o = b.get('/data/v2/search\_show/TMS.Show.9838380')
&gt;&gt;&gt; o.data
{'type': 'show', 'expires': '9999999999', 'subject\_name': 'Monsters vs.
Aliens', 'sub\_type': 'Series', 'topic':
'\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346', 'person':
'\_\_None\_\_', 'searchable\_key': 'aliens vs monstersvsaliens monsters',
'date': '2013-11-23', 'sport': '\_\_None\_\_', 'genre': 'Children', 'id':
'/data/v2/search\_show/TMS.Show.9838380'}
&gt;&gt;&gt; o.store()
Traceback (most recent call last):
 File "", line 1, in 
 File "/usr/local/lib/python2.7/dist-packages/riak/riak\_object.py", line
281, in store
 timeout=timeout)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 127, in wrapper
 return self.\_with\_retries(pool, thunk)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 69, in \_with\_retries
 return fn(transport)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 125, in thunk
 return fn(self, transport, \*args, \*\*kwargs)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
line 289, in put
 timeout=timeout)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/http/transport.py",
line 144, in put
 return self.\_parse\_body(robj, response, [200, 201, 204, 300])
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/http/codec.py",
line 64, in \_parse\_body
 self.check\_http\_code(status, expected\_statuses)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/http/transport.py",
line 446, in check\_http\_code
 (expected\_statuses, status))
Exception: Expected status [200, 201, 204, 300], received 500

Using protocol buffs gives an erlang riak\_search\_kv\_hook,precommit,error:

&gt;&gt;&gt; r = riak.RiakClent(protocol='pcb')
Traceback (most recent call last):
 File "", line 1, in 
AttributeError: 'module' object has no attribute 'RiakClent'
&gt;&gt;&gt; r = riak.RiakClient(protocol='pcb')
Traceback (most recent call last):
 File "", line 1, in 
 File "/usr/local/lib/python2.7/dist-packages/riak/client/\_\_init\_\_.py",
line 99, in \_\_init\_\_
 self.protocol = protocol or 'http'
 File "/usr/local/lib/python2.7/dist-packages/riak/client/\_\_init\_\_.py",
line 118, in \_set\_protocol
 repr(self.PROTOCOLS))
ValueError: protocol option is invalid, must be one of ['http', 'https',
'pbc']
&gt;&gt;&gt; r = riak.RiakClient(protocol='pbc')
&gt;&gt;&gt; b = r.bucket('ctv\_tvdata')
&gt;&gt;&gt; o = b.get('/data/v2/search\_show/TMS.Show.9838380')
&gt;&gt;&gt; o.store()
Traceback (most recent call last):
 File "", line 1, in 
 File "/usr/local/lib/python2.7/dist-packages/riak/riak\_object.py", line
281, in store
 timeout=timeout)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 127, in wrapper
 return self.\_with\_retries(pool, thunk)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 69, in \_with\_retries
 return fn(transport)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 125, in thunk
 return fn(self, transport, \*args, \*\*kwargs)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
line 289, in put
 timeout=timeout)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/transport.py",
line 194, in put
 MSG\_CODE\_PUT\_RESP)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
line 43, in \_request
 return self.\_recv\_msg(expect)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
line 55, in \_recv\_msg
 raise RiakError(err.errmsg)
riak.RiakError: '{precommit\_fail,\n {hook\_crashed,\n
 {riak\_search\_kv\_hook,precommit,error,\n {badmatch,\n
 [{{dict,3,16,16,8,80,48,\n
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},\n
 {{[],[],[],[],[],[],[],[],[],[],\n
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,50,90,85,77,113,86,72,111,75,121,\n
 86,89,72,118,114,103,70,70,114,55,88,52]],\n
 [[&lt;&lt;"index"&gt;&gt;]],\n [],\n
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1384,276502,759295}]],\n
 [],[]}}},\n {riak\_idx\_doc,&lt;&lt;"ctv\_tvdata"&gt;&gt;,\n
 &lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,\n
 [{&lt;&lt;"date"&gt;&gt;,&lt;&lt;"2013-11-23"&gt;&gt;,[{&lt;&lt;"2013-11-23"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"expires"&gt;&gt;,&lt;&lt;"9999999999"&gt;&gt;,\n
 [{&lt;&lt;"9999999999"&gt;&gt;,[0]}]},\n
{&lt;&lt;"genre"&gt;&gt;,&lt;&lt;"Children"&gt;&gt;,[{&lt;&lt;"Children"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"id"&gt;&gt;,&lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,\n
 [{&lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"person"&gt;&gt;,&lt;&lt;"\_\_None\_\_"&gt;&gt;,[{&lt;&lt;"\_\_None\_\_"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"searchable\_key"&gt;&gt;,\n &lt;&lt;"aliens vs
monstersvsaliens monsters"&gt;&gt;,\n
 [{&lt;&lt;"monsters"&gt;&gt;,[3]},\n {&lt;&lt;"vs"&gt;&gt;,[1]},\n
 {&lt;&lt;"aliens"&gt;&gt;,[0]},\n
{&lt;&lt;"monstersvsaliens"&gt;&gt;,[2]}]},\n
{&lt;&lt;"sport"&gt;&gt;,&lt;&lt;"\_\_None\_\_"&gt;&gt;,[{&lt;&lt;"\_\_None\_\_"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"sub\_type"&gt;&gt;,&lt;&lt;"Series"&gt;&gt;,[{&lt;&lt;"Series"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"subject\_name"&gt;&gt;,&lt;&lt;"Monsters vs. Aliens"&gt;&gt;,\n
 [{&lt;&lt;"vs."&gt;&gt;,[1]},\n {&lt;&lt;"Monsters"&gt;&gt;,[0]},\n
 {&lt;&lt;"Aliens"&gt;&gt;,[2]}]},\n
{&lt;&lt;"topic"&gt;&gt;,\n
 &lt;&lt;"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346"&gt;&gt;,\n

 [{&lt;&lt;"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346"&gt;&gt;,\n
 [0]}]},\n
{&lt;&lt;"type"&gt;&gt;,&lt;&lt;"show"&gt;&gt;,[{&lt;&lt;"show"&gt;&gt;,[0]}]}],\n [],\n
 [{&lt;&lt;"expires"&gt;&gt;,&lt;&lt;"9999999999"&gt;&gt;,[&lt;&lt;"9999999999"&gt;&gt;]},\n
 {&lt;&lt;"type"&gt;&gt;,&lt;&lt;"show"&gt;&gt;,[&lt;&lt;"show"&gt;&gt;]}],\n
 true}},\n {{dict,3,16,16,8,80,48,\n
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},\n
 {{[],[],[],[],[],[],[],[],[],[],\n
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,54,99,78,89,53,77,108,102,82,57,\n
 81,88,69,107,104,72,74,98,81,72,114,66]],\n
 [[&lt;&lt;"index"&gt;&gt;]],\n [],\n
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1384,276502,759064}]],\n
 [],[]}}},\n {riak\_idx\_doc,&lt;&lt;"ctv\_tvdata"&gt;&gt;,\n
 &lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,\n
 [{&lt;&lt;"date"&gt;&gt;,&lt;&lt;"2013-11-23"&gt;&gt;,[{&lt;&lt;"2013-11-23"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"expires"&gt;&gt;,&lt;&lt;"9999999999"&gt;&gt;,\n
 [{&lt;&lt;"9999999999"&gt;&gt;,[0]}]},\n
{&lt;&lt;"genre"&gt;&gt;,&lt;&lt;"Children"&gt;&gt;,[{&lt;&lt;"Children"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"id"&gt;&gt;,&lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,\n
 [{&lt;&lt;"/data/v2/search\_show/TMS.Show.9838380"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"person"&gt;&gt;,&lt;&lt;"\_\_None\_\_"&gt;&gt;,[{&lt;&lt;"\_\_None\_\_"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"searchable\_key"&gt;&gt;,\n &lt;&lt;"aliens vs
monstersvsaliens monsters"&gt;&gt;,\n
 [{&lt;&lt;"monsters"&gt;&gt;,[3]},\n {&lt;&lt;"vs"&gt;&gt;,[1]},\n
 {&lt;&lt;"aliens"&gt;&gt;,[0]},\n
{&lt;&lt;"monstersvsaliens"&gt;&gt;,[2]}]},\n
{&lt;&lt;"sport"&gt;&gt;,&lt;&lt;"\_\_None\_\_"&gt;&gt;,[{&lt;&lt;"\_\_None\_\_"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"sub\_type"&gt;&gt;,&lt;&lt;"Series"&gt;&gt;,[{&lt;&lt;"Series"&gt;&gt;,[0]}]},\n
 {&lt;&lt;"subject\_name"&gt;&gt;,&lt;&lt;"Monsters vs. Aliens"&gt;&gt;,\n
 [{&lt;&lt;"vs."&gt;&gt;,[1]},\n {&lt;&lt;"Monsters"&gt;&gt;,[0]},\n
 {&lt;&lt;"Aliens"&gt;&gt;,[2]}]},\n
{&lt;&lt;"topic"&gt;&gt;,\n
 &lt;&lt;"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.846692"&gt;&gt;,\n

 [{&lt;&lt;"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.846692"&gt;&gt;,\n
 [0]}]},\n
{&lt;&lt;"type"&gt;&gt;,&lt;&lt;"show"&gt;&gt;,[{&lt;&lt;"show"&gt;&gt;,[0]}]}],\n [],\n
 [{&lt;&lt;"expires"&gt;&gt;,&lt;&lt;"9999999999"&gt;&gt;,[&lt;&lt;"9999999999"&gt;&gt;]},\n
 {&lt;&lt;"type"&gt;&gt;,&lt;&lt;"show"&gt;&gt;,[&lt;&lt;"show"&gt;&gt;]}],\n
 true}}]}}}}'

Any search that would returns a resource that acts this way similarly fails:

&gt;&gt;&gt; r.fulltext\_search('ctv\_tvdata', "searchable\_key:monstersvsaliens")
XXXXXXXXXXXXXXXXXXXXXXXX q: "searchable\_key:monstersvsaliens"
index: "ctv\_tvdata"

Traceback (most recent call last):
 File "", line 1, in 
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 127, in wrapper
 return self.\_with\_retries(pool, thunk)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 69, in \_with\_retries
 return fn(transport)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
line 125, in thunk
 return fn(self, transport, \*args, \*\*kwargs)
 File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
line 410, in fulltext\_search
 return transport.search(index, query, \*\*params)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/transport.py",
line 443, in search
 MSG\_CODE\_SEARCH\_QUERY\_RESP)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
line 43, in \_request
 return self.\_recv\_msg(expect)
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
line 50, in \_recv\_msg
 self.\_recv\_pkt()
 File
"/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
line 71, in \_recv\_pkt
 % len(nmsglen))
riak.RiakError: 'Socket returned short packet length 0 - expected 4'


I also see errors like this in my crash and error logs:

2013-11-18 23:49:49.705 [error] emulator Error in process &lt;0.17776.914&gt; on
node 'riak@10.1.2.95' with exit value:
{{badmatch,[{{dict,3,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;11
bytes&gt;&gt;,52,75,67,79,55,114,90,110,69,77,50,53,121,67,112,76,85,83,113,74,115,104]],[[&lt;&lt;5
bytes&gt;&gt;]],[],[[&lt;&lt;20
bytes&gt;&gt;|{1384,346717,469237}]],[],[]}}},{riak\_idx\_doc,&lt;&lt;10 bytes&gt;&gt;,&lt;&lt;36
bytes&gt;&gt;,[{&lt;&lt;4 bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8 bytes&gt;&gt;,[0]}]},{&lt;&lt;7 bytes&gt;&gt;,&lt;&lt;10
bytes&gt;&gt;,[{&lt;&lt;10 bytes&gt;&gt;,[0]}]},{&lt;&lt;5 bytes&gt;&gt;,&lt;&lt;6 bytes&gt;&gt;,[{&lt;&lt;6
bytes&gt;&gt;,[0]}]},{&lt;&lt;2 bytes&gt;&gt;,&lt;&lt;36 bytes&gt;&gt;,[{&lt;&lt;36 bytes&gt;&gt;,[0]}]},{&lt;&lt;6
bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8 bytes&gt;&gt;,[0]}]},{&lt;&lt;14 bytes&gt;&gt;,&lt;&lt;45 bytes&gt;&gt;,[{&lt;&lt;7
bytes&gt;&gt;,[0]},{&lt;&lt;5 bytes&gt;&gt;,[1]},{&lt;&lt;9 bytes&gt;&gt;,[2]},{&lt;&lt;21 bytes&gt;&gt;,[3]}]},{&lt;&lt;5
bytes&gt;&gt;,&lt;&lt;3 bytes&gt;&gt;,[{&lt;&lt;3 bytes&gt;&gt;,[0]}]},{&lt;&lt;8 bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8
bytes&gt;&gt;,[0]}]},{&lt;&lt;12 bytes&gt;&gt;,&lt;&lt;23 bytes&gt;&gt;,[{&lt;&lt;5 bytes&gt;&gt;,[1]},{&lt;&lt;9
bytes&gt;&gt;,[2]},{&lt;&lt;7 bytes&gt;&gt;,[...


2013-11-18 23:49:49.834 [error] emulator Error in process &lt;0.18173.914&gt; on
node 'riak@10.1.2.95' with exit value:
{{badmatch,[{{dict,3,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;11
bytes&gt;&gt;,52,75,67,79,55,114,90,110,69,77,50,53,121,67,112,76,85,83,113,74,115,104]],[[&lt;&lt;5
bytes&gt;&gt;]],[],[[&lt;&lt;20
bytes&gt;&gt;|{1384,346717,469237}]],[],[]}}},{riak\_idx\_doc,&lt;&lt;10 bytes&gt;&gt;,&lt;&lt;36
bytes&gt;&gt;,[{&lt;&lt;4 bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8 bytes&gt;&gt;,[0]}]},{&lt;&lt;7 bytes&gt;&gt;,&lt;&lt;10
bytes&gt;&gt;,[{&lt;&lt;10 bytes&gt;&gt;,[0]}]},{&lt;&lt;5 bytes&gt;&gt;,&lt;&lt;6 bytes&gt;&gt;,[{&lt;&lt;6
bytes&gt;&gt;,[0]}]},{&lt;&lt;2 bytes&gt;&gt;,&lt;&lt;36 bytes&gt;&gt;,[{&lt;&lt;36 bytes&gt;&gt;,[0]}]},{&lt;&lt;6
bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8 bytes&gt;&gt;,[0]}]},{&lt;&lt;14 bytes&gt;&gt;,&lt;&lt;45 bytes&gt;&gt;,[{&lt;&lt;7
bytes&gt;&gt;,[0]},{&lt;&lt;5 bytes&gt;&gt;,[1]},{&lt;&lt;9 bytes&gt;&gt;,[2]},{&lt;&lt;21 bytes&gt;&gt;,[3]}]},{&lt;&lt;5
bytes&gt;&gt;,&lt;&lt;3 bytes&gt;&gt;,[{&lt;&lt;3 bytes&gt;&gt;,[0]}]},{&lt;&lt;8 bytes&gt;&gt;,&lt;&lt;8 bytes&gt;&gt;,[{&lt;&lt;8
bytes&gt;&gt;,[0]}]},{&lt;&lt;12 bytes&gt;&gt;,&lt;&lt;23 bytes&gt;&gt;,[{&lt;&lt;5 bytes&gt;&gt;,[1]},{&lt;&lt;9
bytes&gt;&gt;,[2]},{&lt;&lt;7 bytes&gt;&gt;,[...


My search schema currently looks like this:

%% Custom schema for our index
%% See: http://10.1.3.100:8090/display/REST/Search for some background on
how we index/search

{
 schema,
 [
 {version, "1.1"},
 {n\_val, 3},
 {default\_op, "and"},
 {default\_field, "searchable\_key"},
 {analyzer\_factory, {erlang, text\_analyzers,
whitespace\_analyzer\_factory}}
 ],
 [
 %% main field for searching
 {field, [
 {name, "searchable\_key"},
 {type, string}
 ]},

 %% In order to use filter queries to reduce the result set to
 %% specific object 'types' or with 'expires' &gt;= now, we need
 %% to make these fields "inline".

 {field, [
 {name, "type"},
 {type, string},
 {inline, true}
 ]},

 {field, [
 {name, "expires"},
 {type, string},
 {inline, true}
 ]},

 {field, [
 {name, "likes\_count"},
 {type, string},
 {padding\_size, 10}
 ]},

 {field, [
 {name, "timestamp"},
 {type, string},
 {inline, true}
 ]},

 %% Our catch all...
 {dynamic\_field, [
 {name, "\*"},
 {type, string}
 ]}

 %% Field names ending in "\_text" are indexed as full text"
 %% DAVE: just keeping this paragraph for reference
 %{dynamic\_field, [
 % {name, "\*\_text"},
 % {type, string},
 % {analyzer\_factory, {erlang, text\_analyzers,
standard\_analyzer\_factory}}
 %]},

 %% The original catch all...
 %% Everything else is a string
 %{dynamic\_field, [
 %{name, "\*"},
 %{type, string},
 %{analyzer\_factory, {erlang, text\_analyzers,
whitespace\_analyzer\_factory}}
 %]}
 ]
}.


I'm seeing this kind of thing in both my stage and production environments.
 As far as I can tell my search index is corrupted but I'm not sure how
it's gotten this way. Again any help is appreciated. What is the wrong?
 How can I fix it? What could have caused it?

Thanks,

Gabe
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

