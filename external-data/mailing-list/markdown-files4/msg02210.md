---
title: "Re: Riak Cluster Setup on EC2"
description: ""
project: community
lastmod: 2011-02-06T17:36:01-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02210"
mailinglist_parent_id: "msg02209"
author_name: "Paco NATHAN"
project_section: "mailinglistitem"
sent_date: 2011-02-06T17:36:01-08:00
---


I got my Riak cluster on EC2 set up last week, using a security group
based on what Sean described.

The lingering parts for me were:

 1. had to stop Riak, then kill "epmd", then start again

 2. initially I'd tried to use Elastic IP addr (to minimize config
if we move nodes) and that got stuck in my config causing nodes not
recognize each other -- until I used "reip" to change the ring name,
etc.

Otherwise, worked fine. FWIW, we're testing on m1.xlarge with Ubuntu


On Sun, Feb 6, 2011 at 16:20, Eamonn  wrote:
&gt; After a lot if unsuccessful fiddling around with ports I gave up and just
&gt; opened up all ports between the Riak nodes.
&gt;
&gt; I suggest you set up a security group called "Riak" with settings something
&gt; like the following:
&gt;
&gt;  Protocol | From Port | To Port | Source (IP or group)
&gt;  ---------+-----------+---------+---------------------
&gt;  tcp      | 1         | 65535   | Riak group
&gt;  udp      | 1         | 65535   | Riak group
&gt;  tcp      | 8098      | 8098    | WebServer group
&gt;
&gt; Although all the ports are open on the Riak nodes, it is still pretty secure
&gt; because they are only open to nodes in the same security group, i.e. other
&gt; Riak nodes.
&gt;
&gt; The only port open outside the Riak cluster is the default HTTP port, which
&gt; is only open to nodes in the "WebServer" security group.  Change "WebServer"
&gt;  to be the security group of whatever nodes are using Riak.  If you have
&gt; changed the default or are using protocol buffers instead of HTTP you will
&gt; have to change the port number.
&gt;
&gt; You may also want to add the SSH port to so that you can login, but I
&gt; suggest using a cloud-init script to do all the Riak installation and
&gt; initialization at node creation time, so in normal production use will not
&gt; need to SSH into the nodes.
&gt;
&gt; \_\_
&gt; Eamonn
&gt;
&gt;
&gt;
&gt; On 2/4/11 9:00 AM, riak-users-requ...@lists.basho.com wrote:
&gt;&gt;
&gt;&gt; Date: Wed, 02 Feb 2011 21:33:20 +0530 From: Abhishek Kona
&gt;&gt;  To: Sean Cribbs  Cc:
&gt;&gt; "riak-users@lists.basho.com"  Subject: Re: Riak
&gt;&gt; Cluster Setup on EC2 Message-ID: &lt;4d498048.3060...@flipkart.com&gt;
&gt;&gt; Content-Type: text/plain; charset=ISO-8859-1; format=flowed On 02/02/11 8:38
&gt;&gt; PM, Sean Cribbs wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;  Abhishek,
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;  First, make sure all of your nodes are in the same security group.
&gt;&gt;
&gt;&gt; Yes, both the machines are on the same security group ( which has only
&gt;&gt; the ports 8098, 8099, 8087).
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;      Second, check that your OS doesn't have an additional firewall
&gt;&gt;&gt; &gt; installed (iptables, for example).
&gt;&gt;
&gt;&gt; I can telnet into the Riak ports from each of the machines, so firewall
&gt;&gt; does not seem to be the issue.
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;     Third, you might consider doing what the Chef recipe for Riak does
&gt;&gt;&gt; &gt; and limit the ports that Erlang uses for distributed communication.  
&gt;&gt;&gt; &gt; Adding
&gt;&gt;&gt; &gt; a section to app.config like the below will limit the port range:
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;  {kernel, [
&gt;&gt;&gt; &gt;      {inet\_dist\_listen\_min, 6000},
&gt;&gt;&gt; &gt;      {inet\_dist\_listen\_max, 7999}
&gt;&gt;&gt; &gt;  ]}
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;  You'll need to stop Riak, kill the "epmd" process, and then start Riak
&gt;&gt;&gt; &gt; up again for this change to take effect.  Make sure those ports are also
&gt;&gt;&gt; &gt; open in your security group and any software firewall you have.
&gt;&gt;&gt; &gt;
&gt;&gt;
&gt;&gt; Tried with these changes as well, but still get the same message.
&gt;&gt; Anything else, I can try?.
&gt;&gt; Thanks for the help.
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;  Sean Cribbs
&gt;&gt;&gt; &gt;  Developer Advocate
&gt;&gt;&gt; &gt;  Basho Technologies, Inc.
&gt;&gt;&gt; &gt;  http://basho.com/
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;  On Feb 2, 2011, at 8:47 AM, Abhishek Kona wrote:
&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  Hi folks
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  I am trying to set up a Riak cluster on EC2.
&gt;&gt;&gt;&gt; &gt;&gt;  Each time I issue a command :
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  $ sudo riak-admin joinriak@10.130.149.253
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  It fails :
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  Attempting to restart script through sudo -u riak
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  Noderiak@10.130.149.253  is not reachable!
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  Netstat on both the machines says the ports are running fine.
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  netstat -na | egrep '(8087|8098|8099)'
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  tcp        0      0 0.0.0.0:8098            0.0.0.0:\*
&gt;&gt;&gt;&gt; &gt;&gt; LISTEN
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  tcp        0      0 0.0.0.0:8099            0.0.0.0:\*
&gt;&gt;&gt;&gt; &gt;&gt; LISTEN
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  tcp        0      0 0.0.0.0:8087            0.0.0.0:\*
&gt;&gt;&gt;&gt; &gt;&gt; LISTEN
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  I can telnet to all the ports from each of the machine.
&gt;&gt;&gt;&gt; &gt;&gt;  I have been pulling my hair for long but of no avail.
&gt;&gt;&gt;&gt; &gt;&gt;  Can any one look and tell me what I am doing wrong.
&gt;&gt;&gt;&gt; &gt;&gt;  Are there any debug logs where I can look at what is going wrong?
&gt;&gt;&gt;&gt; &gt;&gt;  Is there any EC2 specific trick (like using public hostnames).
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  I am attaching my app.cfg file for reference.
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  Thanks
&gt;&gt;&gt;&gt; &gt;&gt;  -Abhishek Kona
&gt;&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt;&gt; &gt;&gt;  \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; &gt;&gt;  riak-users mailing list
&gt;&gt;&gt;&gt; &gt;&gt;  riak-users@lists.basho.com
&gt;&gt;&gt;&gt; &gt;&gt;  http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

