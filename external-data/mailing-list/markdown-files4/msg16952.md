---
title: "Re: Riak-S2 javascript aws-sdk failing on multi-part uploads"
description: ""
project: community
lastmod: 2016-01-13T14:57:18-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16952"
mailinglist_parent_id: "msg16951"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-01-13T14:57:18-08:00
---


John -

The following error indicates that the connection was unexpectedly
closed by something outside of Riak while the chunk is uploading:

{badmatch,{error,closed}}

Is it possible to remove haproxy to test using the the aws-sdk?

That is my first thought as to the cause of this issue, especially
since writing to S3 works with the same code.

--
Luke Bakken
Engineer
lbak...@basho.com

On Wed, Jan 13, 2016 at 2:46 PM, John Fanjoy  wrote:
&gt; Luke,
&gt;
&gt; Yes on both parts. To confirm cyberduck was using multi-part I actually 
&gt; tailed the console.log while it was uploading the file, and it uploaded the 
&gt; file in approx. 40 parts. Afterwards the parts were reassembled as you would 
&gt; expect. The AWS-SDK for javascript has an object called ManagedUpload which 
&gt; automatically switches to multi-part when the input is larger than the 
&gt; maxpartsize (default 5mb). I have confirmed that it is splitting the files 
&gt; up, but so far Iâ€™ve only ever seen one part get successfully uploaded before 
&gt; the others failed at which point it removes the upload (DELETE call) 
&gt; automatically. I also verified that the javascript I have in place does work 
&gt; with an actual AWS S3 bucket to rule out coding issues on my end and the same 
&gt; &gt;400mb file was successfully uploaded to the bucket I created there without 
&gt; issue.
&gt;
&gt; A few things worth mentioning that I missed before. I am running riak-s2 
&gt; behind haproxy. Haproxy is handling ssl and enabling CORS for browser based 
&gt; requests. I have tested smaller files (~4-5mb) and GET requests using the 
&gt; browser client and everything works with my current haproxy configuration, 
&gt; but the larger files are failing, usually after 1 part is successfully 
&gt; uploaded. I can also list bucket contents and delete existing contents. The 
&gt; only feature that is not working appears to be the multi-part uploads. We are 
&gt; running centOS 7 (kernel version 3.10.0-327.4.4.el7.x86\_64). Please let me 
&gt; know if you have any further questions.
&gt;
&gt; --
&gt; John Fanjoy
&gt; Systems Engineer
&gt; jfan...@inetu.net

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

