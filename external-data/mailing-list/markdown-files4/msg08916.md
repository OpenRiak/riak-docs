---
title: "Re: Map Reduce and long queries -"
description: ""
project: community
lastmod: 2012-10-15T07:42:54-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08916"
mailinglist_parent_id: "msg08914"
author_name: "Bryan Fink"
project_section: "mailinglistitem"
sent_date: 2012-10-15T07:42:54-07:00
---


On Mon, Oct 15, 2012 at 4:13 AM, Olav Frengstad  wrote:
&gt; Just as a note, using the Erlang pb client you can use the key filters
&gt; for 2i queries if you include the riak\_kv\_mapred\_filters module in
&gt; your client code path.
â€¦
&gt; 2&gt; Index = {index, &lt;&lt;"test"&gt;&gt;, &lt;&lt;"$key"&gt;&gt;, &lt;&lt;0&gt;&gt;, &lt;&lt;255&gt;&gt;},
&gt; 2&gt; {ok, Filter} = 
&gt; riak\_kv\_mapred\_filters:build\_filter([[&lt;&lt;"ends\_with"&gt;&gt;,"1"]]),
&gt; 2&gt; MR = [
&gt; 2&gt; { reduce
&gt; 2&gt; , {qfun, fun(X, F) -&gt; lists:filter(fun({A, B}) -&gt; F(B) end, X) end}
&gt; 2&gt; , riak\_kv\_mapred\_filters:compose(Filter)
&gt; 2&gt; , true}],
&gt; 2&gt; riakc\_pb\_socket:mapred(Pid, Index, MR).

It's a bit unfortunate that qfun is so useful, because it's also so
fragile. If your client node is not using exactly the same module
version as every node in your Riak cluster, this will fail with
undefined function errors. Absolutely, go ahead and use qfun to learn
with, but keep an eye out for that kind of surprise. Avoid qfun in
production if you can, or your upgrade process will become more
complex and/or prone to failure.

Yes, 
http://docs.basho.com/riak/latest/references/appendices/MapReduce-Implementation/
should be improved to give this warning as well. I've added an issue
to our new docs repo to track this improvement:
https://github.com/basho/basho\_docs/issues/13

-Bryan

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

