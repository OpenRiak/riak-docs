---
title: "Re: Best practice for using erlang modules in riak?"
description: ""
project: community
lastmod: 2011-06-02T13:49:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03537"
mailinglist_parent_id: "msg03535"
author_name: "Sylvain Niles"
project_section: "mailinglistitem"
sent_date: 2011-06-02T13:49:45-07:00
---


Thanks for responding Dan, that's a great trick for getting the right
stuff from ripple to try from curl. Unfortunately I had manually
constructed the same job and tried it from curl with the same result.
If I:

1. Manually do the map only, I get the right output.
2. Take that output (in JSON format) and manually use it as input to
my erlang module from riak\_console, it works as expected (and logs).
3. Combine it all via Ripple or Curl and my module is never called (it
has catch-alls to error\_logger and they never get evaluated.)

Here's an example of the output of my map (in json) :
&gt;&gt; sugg.to\_json
=&gt; 
"[[\"10\"],[\"sylvain-interests\",\"soccer\"],[\"3\"],[\"sylvain-interests\",\"cats\"],[\"1\"],[\"sylvain-interests\",\"dogs\"]]"

And how it all chains together:

sugg = 
Riak::MapReduce.new(Ripple.client).add('sylvain-interests').map("function(v){return
[[v.values[0].data], [v.bucket, v.key]];}", :keep =&gt;
false).reduce(["get\_erl","update\_suggestion"], :arg =&gt; [], :keep =&gt;
true).run

and my erlang module (get\_erl) :
update\_suggestion([Data | \_], [Bucket, Key]) -&gt;
 error\_logger:error\_msg("I've been called!", []),
 [];
update\_suggestion(\_, \_) -&gt;
 error\_logger:error\_msg("I've been called, but did not match! ~p~n", []),
 [].


Is there any open source code out there using erlang functions via
ripple or rest that I can look at to see a fully functional flow?

Thanks,
Sylvain



On Thu, Jun 2, 2011 at 1:11 PM, Dan Reverri  wrote:
&gt; Have you tried submitting the map reduce job directly against the HTTP API
&gt; using a tool like curl?
&gt; You can get an idea of what the body should look like by outputting the JSON
&gt; representation of the Ripple MapReduce object:
&gt; puts
&gt; Riak::MapReduce.new(Ripple.client).add(a-bucket').map("function(v){return
&gt; [[v.values[0].data], [v.bucket, v.key]];}", :keep =&gt;
&gt; true).reduce(["my\_module","my\_function"], :keep =&gt; true).to\_json
&gt; Thanks,
&gt; Dan
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt; On Thu, Jun 2, 2011 at 1:00 PM, Sylvain Niles 
&gt; wrote:
&gt;&gt;
&gt;&gt; So I've had a few helpful emails, but unfortunately I'm about to write
&gt;&gt; my own erlang HTTP server to call my erlang M/R functions because even
&gt;&gt; examples from the contrib section of the wiki just don't work.
&gt;&gt;
&gt;&gt; My last plea for help before we look at writing a replacement for
&gt;&gt; Riak's REST API:
&gt;&gt;
&gt;&gt; a. Any documentation that shows how to properly deploy your erlang
&gt;&gt; code with the riak cluster (I'm currently writing a module, storing it
&gt;&gt; with riak\_core, adding it to riak\_core.app, and it's building fine,
&gt;&gt; can call it from riak console.)
&gt;&gt; b. The correct way to call an erlang function from the REST api or via
&gt;&gt; Ripple, specifically we are using the output of a Javascript Map to an
&gt;&gt; Erlang Reduce (If this is not supported, please let us know!)
&gt;&gt;
&gt;&gt;
&gt;&gt; Thanks in advance,
&gt;&gt; Sylvain Niles
&gt;&gt;
&gt;&gt;
&gt;&gt; On Fri, May 27, 2011 at 12:16 PM, Sylvain Niles 
&gt;&gt; wrote:
&gt;&gt; &gt; Still looking for advice on this, additionally I'm looking for the
&gt;&gt; &gt; correct way to call the erlang modules from Ripple. I've tried calling
&gt;&gt; &gt; it from a reduce like so:
&gt;&gt; &gt;
&gt;&gt; &gt; reduced =
&gt;&gt; &gt; Riak::MapReduce.new(Ripple.client).add(a-bucket').map("function(v){return
&gt;&gt; &gt; [[v.values[0].data], [v.bucket, v.key]];}", :keep =&gt;
&gt;&gt; &gt; true).reduce(["my\_module","my\_function"], :keep =&gt; true).run
&gt;&gt; &gt;
&gt;&gt; &gt; and I can see that it never gets called, just returns [].
&gt;&gt; &gt;
&gt;&gt; &gt; I can call the module while attached to a Riak console in the cluster
&gt;&gt; &gt; and it works exactly as expected given the exact output of the
&gt;&gt; &gt; previous map: [["value"], ["bucket", "key"]]
&gt;&gt; &gt;
&gt;&gt; &gt; Any pointers would be greatly appreciated! If there's any open source
&gt;&gt; &gt; code out there using ripple in this fashion I'd love a pointer!
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks,
&gt;&gt; &gt; -Sylvain
&gt;&gt; &gt;
&gt;&gt; &gt; On Tue, May 24, 2011 at 6:55 PM, Sylvain Niles 
&gt;&gt; &gt; wrote:
&gt;&gt; &gt;&gt; So I've seen a few well written examples of erlang map or reduce
&gt;&gt; &gt;&gt; functions in the contrib section of the wiki/github but the missing
&gt;&gt; &gt;&gt; piece of glue for me is: Where do I compile from? I've done a lot of
&gt;&gt; &gt;&gt; ejabberd development and generally I just throw it in the src
&gt;&gt; &gt;&gt; directory, add a config param to the ejabberd.conf to load my new
&gt;&gt; &gt;&gt; module at startup, make install, and I'm done. Should I be deploying
&gt;&gt; &gt;&gt; my modules to /deps/riak\_core/src/?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; The wiki has this note:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Distributing Erlang MapReduce Code
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Any modules and functions you use in your Erlang MapReduce calls must
&gt;&gt; &gt;&gt; be available on all nodes in the cluster. You can add them in Erlang
&gt;&gt; &gt;&gt; applications by specifying the -pz option in vm.args or by adding the
&gt;&gt; &gt;&gt; path to the add\_paths setting in app.config.
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; But the vm.args page does not list the valid config format/options for
&gt;&gt; &gt;&gt; the -pz option. Is the add\_paths behavior such that a valid beam in
&gt;&gt; &gt;&gt; that dir will automatically be loaded on startup and all exported
&gt;&gt; &gt;&gt; functions available? What about live code updates of internally
&gt;&gt; &gt;&gt; developed modules?
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Thanks in advance!
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; -Sylvain
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

