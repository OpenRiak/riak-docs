---
title: "Re: Connection Pool with Erlang PB Client Necessary?"
description: ""
project: community
lastmod: 2011-07-26T11:55:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04070"
mailinglist_parent_id: "msg04068"
author_name: "Bob Ippolito"
project_section: "mailinglistitem"
sent_date: 2011-07-26T11:55:28-07:00
---


In our case, we have a client id per connection but the connections
are re-used. For a given application request, a connection is checked
out, some work is done, and then it is checked back in to the pool at
the end of the request. Choosing a random client id for every request
would make bigger vector clocks, but it's a reasonable design.

Interleaving operations with the same client id is going to cause
integrity problems (e.g. the single gen\_server + connection approach),
you really want to treat a client id like a transaction id.

On Tue, Jul 26, 2011 at 11:35 AM, Andrew Berman  wrote:
&gt; Thanks for the reply Bryan.  This all makes sense.  I am fairly new to
&gt; Erlang and wasn't sure if using a gen\_server solved some of the issues
&gt; with connections.  From what I've seen a lot of people simply make
&gt; calls to Riak directly from a resource and so I thought having a
&gt; gen\_server in front of Riak would help to manage things better.
&gt; Apparently it doesn't.
&gt;
&gt; So, then, two more questions.  I have used connection pools in Java
&gt; like C3P0 and they can ramp up connections and then cull connections
&gt; when there is a period of inactivity.  The only pooler I've found that
&gt; does this is: https://github.com/seth/pooler .  Do you have any other
&gt; recommendations on connection poolers?
&gt;
&gt; Second, I'm still a little confused on client ID.  I thought client Id
&gt; represented an actual client, not a connection.  So, in my case, the
&gt; gen\_server is one client which makes multiple connections.  After
&gt; seeing what you wrote and reading a bit more on it, it seems like
&gt; client Id should just be some random string (base64 encoded) that
&gt; should be generated on creating a connection.  Is that right?
&gt;
&gt; Thanks for your help!
&gt;
&gt; Andrew
&gt;
&gt; On Tue, Jul 26, 2011 at 9:39 AM, Bryan O'Sullivan  wrote:
&gt;&gt; On Mon, Jul 25, 2011 at 4:03 PM, Andrew Berman  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; I know that this subject has been brought up before, but I'm still
&gt;&gt;&gt; wondering what the value of a connection pool is with Riak.
&gt;&gt;
&gt;&gt; It's a big deal:
&gt;&gt;
&gt;&gt; It amortises TCP and PBC connection setup overhead over a number of
&gt;&gt; requests, thereby reducing average query latency.
&gt;&gt; It greatly reduces the likelihood that very busy clients and servers will
&gt;&gt; run out of limited resources that are effectively invisible, e.g. closed TCP
&gt;&gt; connections stuck in TIME\_WAIT.
&gt;&gt;
&gt;&gt; Each of the above is a pretty big deal. Of course, connection pooling isn't
&gt;&gt; free.
&gt;&gt;
&gt;&gt; If you have many clients talking to a server sporadically, you may end up
&gt;&gt; with large numbers of open-and-idle connections on a server, which will both
&gt;&gt; consume resources and increase latency for all other clients. This is
&gt;&gt; usually only a problem with a very large number (many thousands) of clients
&gt;&gt; per server, and it usually only arises with poorly written and tuned
&gt;&gt; connection pooling libraries. But ...
&gt;&gt; ... Most connection pooling libraries are poorly written and tuned, so
&gt;&gt; they'll behave pathologically just when you need them not to.
&gt;&gt; Since you don't set up a connection per request, the requests where you \*do\*
&gt;&gt; need to set up a connection are going to be more expensive than those where
&gt;&gt; you don't, so you'll see jitter in your latency profile. About 99.9% of
&gt;&gt; users will never, ever care about this.
&gt;&gt;&gt;
&gt;&gt;&gt; Since Erlang processes are so small and fast to
&gt;&gt;&gt; create, is there really any overhead in having the gen\_server create a
&gt;&gt;&gt; new connection (with the same client id) each time it needs to access
&gt;&gt;&gt; Riak?
&gt;&gt;
&gt;&gt; Of course. The overhead of Erlang processes has nothing to do with the cost
&gt;&gt; of setting up a connection.
&gt;&gt; Also, you really don't want to be using the same client ID repeatedly across
&gt;&gt; different connections. That's an awesome way to cause bugs with vclock
&gt;&gt; resolution that end up being very very hard to diagnose.
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

