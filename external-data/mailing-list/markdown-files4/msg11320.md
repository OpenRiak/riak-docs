---
title: "Mismatched object counts"
description: ""
project: community
lastmod: 2013-06-20T22:59:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11320"
author_name: "Elias Levy"
project_section: "mailinglistitem"
sent_date: 2013-06-20T22:59:45-07:00
---


I've just inserted some data into a six node Riak 1.3.1 EE cluster. The
keys are all SHA256s. The bucket previously had somewhere in
the vicinity of 1 million objects.

A MR job using the $key 2i with a range of '0' to 'Z', which should cover
all possible SHA256s, and using
both riak\_kv\_mapreduce:: reduce\_count\_inputs and streaming the keys using
reduce\_identity and counting client side, both returned a count around
750K, but that is now somewhat suspect.

The objects I inserted overlap somewhat with the previously existing
objects, but not completely. Overlapping objects were merged. I
inserted 2,521,799 objects.

When I execute the MR count job against it reports 1,604,783 objects, using
both techniques (reduce\_count\_inputs and reduce\_identity plus client side
counting).

Given the discrepancy I queried the bucket for the 2,521,799 objects I
thought I inserted and I verified the system thinks they are there.

What gives? Why is MR returning incorrect result? Does the 2i query
somehow miss some possible keys?

This is what the job looks like in Ruby:

Riak::MapReduce.new(client).
 index(bucket\_name, "$key", '0'..'Z').
 reduce(['riak\_kv\_mapreduce', 'reduce\_count\_inputs'], :keep =&gt; true, :arg
=&gt; { "reduce\_phase\_batch\_size" =&gt; 1000, "do\_prereduce" =&gt; true } ).
 timeout(86400000).
 run

As a side question, does do\_prereduce here have any effect? I am thinking
it does not. The docs indicate do\_prereduce is a map phase argument, not a
reduce phase one. That begs the question of how to enable prereduce for a
MR job without a map phase, other than setting mapred\_always\_prereduce =
true in the config file.

Elias
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

