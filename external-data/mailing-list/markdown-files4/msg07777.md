---
title: "Re: Riak behind a Load Balancer"
description: ""
project: community
lastmod: 2012-06-25T12:01:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07777"
mailinglist_parent_id: "msg07776"
author_name: "Michael Clemmons"
project_section: "mailinglistitem"
sent_date: 2012-06-25T12:01:19-07:00
---


If your running multiple clients use an LB on each and do failover if the
local lb is down.

On Mon, Jun 25, 2012 at 11:41 AM, Swinney, Austin  wrote:

&gt; I use the Amazon Elastic Load Balancer (ELB) on my ec2 riak cluster. I
&gt; understand the concerns of LB fail, but for me, using Riak is largely about
&gt; ease of use. Easy to deploy, grow, shrink, replace, etc. Using an the ELB
&gt; allows me to do those things without consulting those who manage the
&gt; services that use cluster. And in the turbulent cloud space, if a node
&gt; goes unresponsive, it just gets kicked out without any action on my part.
&gt;
&gt; A few weeks ago, I had some episode where I replaced all the nodes in
&gt; the riak cluster. It sucked for me (because I don't know what I'm doing!),
&gt; but the service owner who actually uses the cluster came to my desk a week
&gt; later and asked, "So how is everything going with the riak cluster?" He
&gt; hadn't even noticed, nor had anyone else unless I told them about it. To
&gt; me, that is pure ops gold.
&gt;
&gt; Performance wise, I get what I need out of it. Response times through
&gt; the ELB are all pretty similar across the board. I never tested it without
&gt; the ELB, so I am not aware of any performance hit using ELB.
&gt;
&gt; My ELB health check settings:
&gt;
&gt; Ping Target:
&gt; HTTP:8098/ping
&gt; Timeout:
&gt; 5 seconds
&gt; Interval:
&gt; 30 seconds
&gt; Unhealthy Threshold:
&gt; 2
&gt; Healthy Threshold:
&gt; 10
&gt;
&gt; If I didn't have ELB, I'd look at the zookeeper route.
&gt;
&gt; On Jun 25, 2012, at 2:21 PM, Anthony Molinaro wrote:
&gt;
&gt; This is almost exactly what we do with our riak clusters (as well as
&gt; actually
&gt; all our subclusters). It's actually nice for developer because when they
&gt; need to talk to a network service they just reference 127.0.0.1 and some
&gt; port, and haproxy gets them to the right place. This also allows an
&gt; operations team to make network changes without impacting applications
&gt; (via the use of the haproxy reload).
&gt;
&gt; The only downside is that if your connections are long lived and you
&gt; restart
&gt; your riak nodes, all requests will end up on the last node. And if you
&gt; restart
&gt; haproxy they will all end up on the first node initially. I sort of wish
&gt; there was a configuration parameter to haproxy to randomize the start
&gt; point for the roundrobin so you could keep things a little more balanced
&gt; across many machines running haproxy.
&gt;
&gt; -Anthony
&gt;
&gt; On Mon, Jun 25, 2012 at 07:44:05AM -0400, Sean Cribbs wrote:
&gt;
&gt; Another typical setup is to have each client node have its own haproxy, and
&gt;
&gt; when Riak nodes are added or removed (not a common occurrence, mind you), a
&gt;
&gt; configuration management tool like Chef/Puppet/cfengine/etc can adjust the
&gt;
&gt; config and signal the process to reload it (I think it's `kill -HUP`). Then
&gt;
&gt; your client code also only ever needs to connect to localhost, and doesn't
&gt;
&gt; have to have itself reconfigured.
&gt;
&gt;
&gt; On Mon, Jun 25, 2012 at 4:40 AM, Samuel Elliott  wrote:
&gt;
&gt;
&gt; On Mon, Jun 25, 2012 at 7:36 AM, Matt Black 
&gt;
&gt; wrote:
&gt;
&gt; Dear list,
&gt;
&gt;
&gt; Does anyone have an opinion on the concept of putting a Riak cluster
&gt;
&gt; behind
&gt;
&gt; a load balancer?
&gt;
&gt;
&gt; It has been done before. there are various results when searching
&gt;
&gt; "riak haproxy" in your favourite search engine.
&gt;
&gt;
&gt;
&gt; We wish to be able to automatically add/remove nodes from the cluster,
&gt; so
&gt;
&gt; adding an extra layer at the front is desirable. We should also benefit
&gt;
&gt; for
&gt;
&gt; incoming requests behind shared across all nodes.
&gt;
&gt;
&gt; Can anyone see any drawbacks / problems with doing this?
&gt;
&gt;
&gt; If your load balancer falls over, what do you do then? Highly
&gt;
&gt; available may go down the pan. Have more than one would be the obvious
&gt;
&gt; answer.
&gt;
&gt;
&gt; What do you do when you want to transparently add more machines to
&gt;
&gt; your load balancer?
&gt;
&gt;
&gt; Maybe it might be better to have a list of riak nodes stored in a
&gt;
&gt; separate registry (I'm thinking something like zookeeper), that your
&gt;
&gt; application servers can then poll for changes (or even subscribe to
&gt;
&gt; changes) to the list of servers.
&gt;
&gt;
&gt; Sam
&gt;
&gt;
&gt;
&gt; Thanks
&gt;
&gt; Matt
&gt;
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;
&gt; riak-users mailing list
&gt;
&gt; riak-users@lists.basho.com
&gt;
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt; Samuel Elliott
&gt;
&gt; s...@lenary.co.uk
&gt;
&gt; http://lenary.co.uk/
&gt;
&gt; +44 (0)7891 993 664
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;
&gt; riak-users mailing list
&gt;
&gt; riak-users@lists.basho.com
&gt;
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt; Sean Cribbs 
&gt;
&gt; Software Engineer
&gt;
&gt; Basho Technologies, Inc.
&gt;
&gt; http://basho.com/
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;
&gt; riak-users mailing list
&gt;
&gt; riak-users@lists.basho.com
&gt;
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt; --
&gt; ------------------------------------------------------------------------
&gt; Anthony Molinaro 
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;


-- 
-Michael
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

