---
title: "Re: OutOfMemoryError in Java client"
description: ""
project: community
lastmod: 2012-02-14T14:12:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06602"
mailinglist_parent_id: "msg06601"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2012-02-14T14:12:57-08:00
---


John -

The problem is that when you create a new IRiakClient ... the previous one
doesn't shut down its threads when it goes out of scope, thus leading to
your problem.

We've already fixed this is master by adding a 'shutdown()' method to the
IRiakClient interface, but the latest release cut of the client (1.0.3)
does not include it.

Thanks,
Brian Roach

On Tue, Feb 14, 2012 at 2:53 PM, John DeTreville wrote:

&gt; I have a simple single-threaded Java client for Riak that consistently
&gt; runs out of memory creating threads.
&gt;
&gt; java.lang.OutOfMemoryError: unable to create new native thread
&gt; at java.lang.Thread.start0(Native Method)
&gt; at java.lang.Thread.start(Thread.java:658)
&gt; at
&gt; java.util.concurrent.ThreadPoolExecutor.addIfUnderCorePoolSize(ThreadPoolExecutor.java:703)
&gt; at
&gt; java.util.concurrent.ThreadPoolExecutor.prestartCoreThread(ThreadPoolExecutor.java:1381)
&gt; at
&gt; java.util.concurrent.ScheduledThreadPoolExecutor.delayedExecute(ScheduledThreadPoolExecutor.java:222)
&gt; at
&gt; java.util.concurrent.ScheduledThreadPoolExecutor.scheduleWithFixedDelay(ScheduledThreadPoolExecutor.java:443)
&gt; at
&gt; com.basho.riak.pbc.RiakConnectionPool.doStart(RiakConnectionPool.java:232)
&gt; at
&gt; com.basho.riak.pbc.RiakConnectionPool.access$100(RiakConnectionPool.java:41)
&gt; at
&gt; com.basho.riak.pbc.RiakConnectionPool$State$1.start(RiakConnectionPool.java:58)
&gt; at
&gt; com.basho.riak.pbc.RiakConnectionPool.start(RiakConnectionPool.java:227)
&gt; at com.basho.riak.pbc.RiakClient.(RiakClient.java:90)
&gt; at com.basho.riak.pbc.RiakClient.(RiakClient.java:81)
&gt; at
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.(PBClientAdapter.java:91)
&gt; at com.basho.riak.client.RiakFactory.pbcClient(RiakFactory.java:107)
&gt;
&gt; The client is a JUnit test for some data structures I'm storing in Riak.
&gt; When I run it, my Java client process starts about 2028 native threads
&gt; before it collapses.
&gt;
&gt; This JUnit test creates a moderately large number of IRiakClient objects,
&gt; but only one at a time. It does not close them, as there is no method for
&gt; doing so.
&gt;
&gt; This happens with Riak 1.0.2 and with Riak 1.1.0RC2. As I've said, the
&gt; client is single-theaded.
&gt;
&gt; Any ideas?
&gt;
&gt; Cheers,
&gt; John
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

