---
title: "Re: For Those Using Riak CS + aws-sdk"
description: ""
project: community
lastmod: 2013-05-02T19:19:51-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11002"
mailinglist_parent_id: "msg11001"
author_name: "Dave Finster"
project_section: "mailinglistitem"
sent_date: 2013-05-02T19:19:51-07:00
---


Just an update. I found that while the s3\_endpoint was being deprecated, the 
reason that it stopped working in my case wasn't due to removal, rather an 
alteration in how the configuration object is built.

The following didn't work:

AWS.config(:use\_ssl =&gt; false,
 :access\_key\_id =&gt; "X", 
 :secret\_access\_key =&gt; "Y",
 :s3\_endpoint =&gt; "mystorage.com")

but the following did

AWS::S3
AWS.config(:use\_ssl =&gt; false,
 :access\_key\_id =&gt; "X", 
 :secret\_access\_key =&gt; "Y",
 :s3\_endpoint =&gt; "mystorage.com")

This is because the attributes on the AWS.config object are dynamically built 
as more modules are accessed. Setting S3 endpoint before loading the S3 module 
must cause it to be over-written (likely due to the added reliance on region 
naming to infer endpoint address) when the s3.rb file is loaded into Ruby.

Anyway, a quick monkey patch to resolve the entire problem of AWS switching to 
regions is:

module AWS
 module Core
 class Client
 def endpoint
 if service\_ruby\_name == "s3" && 
config.send(:"#{service\_ruby\_name}\_region") == "local-s3"
 "mystorage.com"
 else
 @endpoint
 end
 end
 end
 end
end

With that monkey patch in, I can just do this:
AWS::S3 #just ensures that the S3 module is loaded - might not have to do in 
future versions
AWS.config(:use\_ssl =&gt; false,
 :access\_key\_id =&gt; "X", 
 :secret\_access\_key =&gt; "Y",
 :s3\_region =&gt; "mystorage.com")

That patch ensures that only s3 requests to your local region are affected by 
the change. I would expect any other AWS requests to the actual AWS to be okay. 
Hopefully this helps someone else out as well.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

