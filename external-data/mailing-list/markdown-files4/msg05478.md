---
title: "Re: erlang precommit hook error"
description: ""
project: community
lastmod: 2011-11-08T10:04:04-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05478"
mailinglist_parent_id: "msg05477"
author_name: "Hal Eisen"
project_section: "mailinglistitem"
sent_date: 2011-11-08T10:04:04-08:00
---


Sorry, typo in code. the mangle function is actually:

mangle(X) -&gt;
 crypto:start(),
 {\_, Tokens} = lists:partition(fun(Arg) -&gt; lists:member(Arg, 
mangle:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
 riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -&gt; 
crypto:md5(Arg) end, Tokens))),
 riak\_object:apply\_updates(X).

In other words, I fixed the module reference.

Hal

On Tue, Nov 08, 2011 at 09:59:26AM -0800, Hal Eisen wrote:
&gt; Hello again. I have given up on using the JavaScript precommit hook
&gt; because I could not find anything which did not produce timeouts under
&gt; the load for my application.
&gt; 
&gt; So, I have ported my hook to Erlang. Alas, I'm not getting very far.
&gt; I've installed my hook in /etc/riak/erl/hooks.erl. The code looks
&gt; like this:
&gt; 
&gt; -module(haleisen).
&gt; -export([stopwords/0, mangle/1]).
&gt; stopwords() -&gt;
&gt; ["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"].
&gt; mangle(X) -&gt;
&gt; crypto:start(),
&gt; {\_, Tokens} = lists:partition(fun(Arg) -&gt; lists:member(Arg, 
&gt; ask:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
&gt; riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -&gt; 
&gt; crypto:md5(Arg) end, Tokens))),
&gt; riak\_object:apply\_updates(X).
&gt; 
&gt; I originally tested the code in the Erlang repl, using a plain string
&gt; instead of riak\_object:get\_value, and it worked perfectly.
&gt; 
&gt; I installed my hook into a test bucket:
&gt; bash$ curl http://127.0.0.1:8098/riak/test-hook
&gt; {"props":{"allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"test-with","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"haleisen","fun":"mangle"}],"pw":0,"r":"quorum","rw":"quorum","small\_vclock":10,"w":"quorum","young\_vclock":20}}
&gt; 
&gt; When I try to insert a key into this bucket, I get:
&gt; Error:
&gt; {precommit\_fail,{hook\_crashed,{haleisen,mangle,error,undef}}}
&gt; 
&gt; Any help would be appreciated.
&gt; 
&gt; Thanks,
&gt; Hal

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

