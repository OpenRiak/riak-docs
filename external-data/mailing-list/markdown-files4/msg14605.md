---
title: "Re: Riak CS with hadoop over s3 protocol"
description: ""
project: community
lastmod: 2014-08-01T14:07:35-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14605"
mailinglist_parent_id: "msg14602"
author_name: "Charles Shah"
project_section: "mailinglistitem"
sent_date: 2014-08-01T14:07:35-07:00
---


Hi Kota/John/Andrew,

Thanks for your suggestions.

So this is what i've tried with unsuccessful results.

-\* jets3t.properties file\*
s3service.s3-endpoint=
s3service.s3-endpoint-http-port=8080
s3service.disable-dns-buckets=true
s3service.s3-endpoint-virtual-path=/

httpclient.proxy-autodetect=false
httpclient.proxy-host=
httpclient.proxy-port=8080

I've tried the proxy and s3 service together and each separately.
I've also tried putting the file in /opt/mapr/conf ,
/opt/mapr/hadoop/hadoop-0.20.2/ and /opt/mapr/hadoop/hadoop-0.20.2/conf

After adding the settings, when I run hadoop distcp s3n://u:p@bucket/file
/mymapr/ it still connects to s3, since I get access denied message from
aws, saying they dont recognize the key and passphrase
I've also tried using pig T = LOAD 's3n://u:p@bucket/file' using
PigStorage() as (line:chararray);


- \*/etc/hosts file\*
I know internally aws converts it to a https://.s3.amazonaws.com/
request.
So I added that to my hosts file and had my riak cs behind a haproxy
forwarding 443 to the 8080 of the riak. When I run the hadoop distcp
command as above, I get this error:

14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: I/O exception
(java.net.ConnectException) caught when processing request: Connection
refused
14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: Retrying request
14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: I/O exception
(java.net.ConnectException) caught when processing request: Connection
refused
14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: Retrying request
14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: I/O exception
(java.net.ConnectException) caught when processing request: Connection
refused
14/08/01 20:59:30 INFO httpclient.HttpMethodDirector: Retrying request
14/08/01 20:59:30 INFO metrics.MetricsUtil: getSupportedProducts {}
java.lang.RuntimeException: RPC /supportedProducts error Connection refused
 at
amazon.emr.metrics.InstanceControllerRpcClient$RpcClient.call(Unknown
Source)
 at
amazon.emr.metrics.InstanceControllerRpcClient.getSupportedProducts(Unknown
Source)
 at amazon.emr.metrics.MetricsUtil.emrClusterMapR(Unknown Source)
 at amazon.emr.metrics.MetricsSaver.(Unknown Source)
 at amazon.emr.metrics.MetricsSaver.ensureSingleton(Unknown Source)
 at amazon.emr.metrics.MetricsSaver.addInternal(Unknown Source)
 at amazon.emr.metrics.MetricsSaver.addValue(Unknown Source)
 at
org.apache.hadoop.fs.s3native.Jets3tNativeFileSystemStore.retrieveMetadata(Jets3tNativeFileSystemStore.java:166)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
 at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:606)
 at
org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:82)
 at
org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:59)
 at org.apache.hadoop.fs.s3native.$Proxy0.retrieveMetadata(Unknown
Source)
 at
org.apache.hadoop.fs.s3native.NativeS3FileSystem.getFileStatus(NativeS3FileSystem.java:748)
 at org.apache.hadoop.fs.FileSystem.exists(FileSystem.java:826)
 at org.apache.hadoop.tools.DistCp.checkSrcPath(DistCp.java:648)
 at org.apache.hadoop.tools.DistCp.copy(DistCp.java:668)
 at org.apache.hadoop.tools.DistCp.run(DistCp.java:913)
 at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:65)
 at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:79)
 at org.apache.hadoop.tools.DistCp.main(DistCp.java:947)



\*- hadoop conf\*
When i add this setting to hadoop's core-site.xml (reverting the hosts file
setting)

fs.s3n.ssl.enabled
false


fs.s3n.endpoint
riak-cluster


I get the same error as the one with the hosts file, so looks like the
setting makes it point to the riak cluster, however i am getting the rpc
connection issue.

\*- s3cmd\*

s3cmd and python boto works fine with .s3cfg and .botoconfig respectively
pointing to riak, so i know the connection works from mapr to riak, just
not with hadoop.

Any help is appreciated.

Thanks






















On Thu, Jul 31, 2014 at 5:10 PM, Kota Uenishi  wrote:

&gt; I played on Hadoop MapReduce on Riak CS, and it actually worked with
&gt; the latest 1.5 beta package. Hadoop relies S3 connectivity on jets3t,
&gt; so if MapR uses vanilla jets3t it will work. I believe so because MapR
&gt; works on EMR (which usually extracts data from S3).
&gt;
&gt; Technically, you can add several options about S3 endpoints to connect
&gt; other S3-compatible cloud storages into jets3t.properties, which are
&gt; mainly "s3service.s3-endpoint" and
&gt; "s3service.s3-endpoint-http(s)-port". I put the properties file into
&gt; hadoop conf directory and it worked. Maybe there is a config-loading
&gt; in MapR, too. [1] In this case, you should properly configure your CS
&gt; use your domain by cs\_root\_host in app.config. [2]
&gt;
&gt; If your Riak CS is not configured with your own domain, you can also
&gt; configure MapReduce to use proxy setting like this:
&gt;
&gt; httpclient.proxy-host=localhost
&gt; httpclient.proxy-port=8080
&gt;
&gt; I usually use this configuration when I play locally. Put them into
&gt; jets3t.properties.
&gt;
&gt; Note that 1.4.x CS won't work properly if the output file is on CS
&gt; again - it doesn't have copy API used in the final file copy after
&gt; reduce. We have 1.5 pre-release package internally and testing. Sooner
&gt; or later it will be released.
&gt;
&gt; [1] https://jets3t.s3.amazonaws.com/toolkit/configuration.html
&gt; [2]
&gt; http://docs.basho.com/riakcs/latest/cookbooks/configuration/Configuring-Riak-CS/
&gt;
&gt; On Fri, Aug 1, 2014 at 4:08 AM, John Daily  wrote:
&gt; &gt; This blog post on configuring S3 clients to work with CS may be useful:
&gt; &gt; http://basho.com/riak-cs-proxy-vs-direct-configuration/
&gt; &gt;
&gt; &gt; Sent from my iPhone
&gt; &gt;
&gt; &gt; On Jul 31, 2014, at 2:53 PM, Andrew Stone  wrote:
&gt; &gt;
&gt; &gt; Hi Charles,
&gt; &gt;
&gt; &gt; AFAIK we haven't ever tested Riak Cs with the MapR connector. However, if
&gt; &gt; MapR works with S3, you should just have to change the IP to point to a
&gt; load
&gt; &gt; balancer in front of your local Riak CS cluster. I'm unaware of how to
&gt; &gt; change that setting in MapR though. It seems like a question for them and
&gt; &gt; not Basho.
&gt; &gt;
&gt; &gt; -Andrew
&gt; &gt;
&gt; &gt;
&gt; &gt; On Wed, Jul 30, 2014 at 5:16 PM, Charles Shah 
&gt; &gt; wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; Hi,
&gt; &gt;&gt;
&gt; &gt;&gt; I would like to use MapR with Riak CS for hadoop map reduce jobs. My
&gt; code
&gt; &gt;&gt; is currently referring to objects using s3n:// urls.
&gt; &gt;&gt; I'd like to be able to have the hadoop code on MapR point to the Riak CS
&gt; &gt;&gt; cluster using the s3 url.
&gt; &gt;&gt; Is there a proxy or hostname setting in hadoop to be able to route the
&gt; s3
&gt; &gt;&gt; url to the riak cs cluster ?
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

