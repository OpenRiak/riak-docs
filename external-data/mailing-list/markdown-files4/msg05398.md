---
title: "Re: Indexing of intermediate nested fields in Riak search"
description: ""
project: community
lastmod: 2011-10-31T14:48:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05398"
mailinglist_parent_id: "msg05376"
author_name: "Elias Levy"
project_section: "mailinglistitem"
sent_date: 2011-10-31T14:48:05-07:00
---


Any ideas on this? Should indexing for sub-objects in an array with the
same field names in a JSON document work?



On Sun, Oct 30, 2011 at 6:56 AM, Elias Levy wrote:

&gt; On Sat, Oct 29, 2011 at 9:59 PM, Elias Levy 
&gt; wrote:
&gt;
&gt;&gt; I am wondering if Riak search can index intermediate nested fields. When
&gt;&gt; indexing json data through the KV precommit hook, the underscore is
&gt;&gt; understood in the schema as indicating nesting. Thus, foo\_bar will index
&gt;&gt; the value "bah" of field "bar" in the json document { "foo" : { "bar" :
&gt;&gt; "bah" } }.
&gt;&gt;
&gt;&gt; What I'd like to know is if it can instead index the key "bar" in the
&gt;&gt; same json document. In my current use case I want to be able to find
&gt;&gt; documents with certain values for "bar" for these types of documents.
&gt;&gt;
&gt;&gt; Can this be done by simply indexing the field "foo"? Does search know to
&gt;&gt; index all keys in "foo" if foo is a hash, or all its values if it is an
&gt;&gt; array?
&gt;&gt;
&gt;
&gt; My testing on 1.0.0 shows that this appears not to work. Looking at the
&gt; source for the search kv extractor gives the impression that a workaround
&gt; would be to instead store { "foo" : [ { "x": "bar", "y": "bah"}, { "x":
&gt; "woo", "y": "zoo" }, ... ]} and index "foo\_z" to be able to search for
&gt; "bar" and "woo". I.e. it appears the extractor will index each subdocument
&gt; in the array.
&gt;
&gt; At least that is what json\_text() function implies with the tests:
&gt;
&gt; {&lt;&lt;"
&gt; {\"menu\": {
&gt; \"id\": \"file\",
&gt; \"value\": \"File\",
&gt; \"popup\": {
&gt; \"menuitem\": [
&gt; {\"value\": \"New\", \"onclick\": \"CreateNewDoc()\"},
&gt; {\"value\": \"Open\", \"onclick\": \"OpenDoc()\"},
&gt; {\"value\": \"Close\", \"onclick\": \"CloseDoc()\"}
&gt; ]
&gt; }
&gt; }}"&gt;&gt;,
&gt; [{&lt;&lt;"menu\_id"&gt;&gt;, &lt;&lt;"file"&gt;&gt;},
&gt; {&lt;&lt;"menu\_value"&gt;&gt;, &lt;&lt;"File"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_value"&gt;&gt;, &lt;&lt;"New"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_onclick"&gt;&gt;, &lt;&lt;"CreateNewDoc()"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_value"&gt;&gt;, &lt;&lt;"Open"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_onclick"&gt;&gt;, &lt;&lt;"OpenDoc()"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_value"&gt;&gt;, &lt;&lt;"Close"&gt;&gt;},
&gt; {&lt;&lt;"menu\_popup\_menuitem\_onclick"&gt;&gt;, &lt;&lt;"CloseDoc()"&gt;&gt;}]},
&gt; %% From 
&gt; http://www.ibm.com/developerworks/library/x-atom2json.html
&gt;
&gt;
&gt;&gt; The implication of the above code is that you can search for
&gt; menu\_popup\_menuitem\_value:New or menu\_popup\_menuitem\_value:Open and find
&gt; the doc. But my testing shows this not to work. If any of the documents
&gt; in the array have the same fields, those fields will not be indexed.
&gt;
&gt; E.g. if I set my schema to index foo\_bar and insert {"foo": [ { "bar" :
&gt; "baz" }, {"xxx":"yyy"} ] }, I can search for foo\_bar:baz and receive a
&gt; match. If I instead insert '{"foo": [ { "bar" : "baz" }, {"bar":"yyy"} ]
&gt; }' and search for foo\_bar:baz I receive no match.
&gt;
&gt; Is this expected behavior or a bug?
&gt;
&gt; Elias
&gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

