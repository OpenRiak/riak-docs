---
title: "Re: Initializing a commit hook"
description: ""
project: community
lastmod: 2016-11-18T13:47:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17767"
mailinglist_parent_id: "msg17766"
author_name: "Luke Bakken"
project_section: "mailinglistitem"
sent_date: 2016-11-18T13:47:10-08:00
---


Mav -

You're not using the correct HTTP URL. You can use this command:

http://docs.basho.com/riak/kv/2.1.4/using/reference/bucket-types/#updating-a-bucket-type

Or this URL:

curl -XPUT localhost:8098/types/maps/props -H 'Content-Type:
application/json' -d
'{"props":{"precommit":[{"mod":"myhooks","fun":"precommit\_hook"}]}}'

Please ensure that the "myhooks" beam file is on all Riak servers in a
directory that will be picked up by Riak when it starts:

http://docs.basho.com/riak/kv/2.1.4/using/reference/custom-code/

--
Luke Bakken
Engineer
lbak...@basho.com

On Fri, Nov 18, 2016 at 1:36 PM, Mav erick  wrote:
&gt; Hi Luke
&gt;
&gt; I tried that and didn't work for a bucket with bucket type = maps. My erlang
&gt; code below does work for buckets without types.
&gt;
&gt; But I think its because I didn't set the hook for the typed bucket
&gt; correctly.Could you check my curl below, please ?
&gt;
&gt; I did this to set the hook
&gt; curl -X PUT localhost:8098/riak/types/maps -H 'Content-Type:
&gt; application/json' -d
&gt; '{"props":{"precommit":[{"mod":"myhooks","fun":"precommit\_hook"}]}}'
&gt;
&gt; That returns 204, but when I get the props ...
&gt; curl http://localhost:8098/types/maps/props
&gt; {
&gt; "props": {
&gt; "active": true,
&gt; "allow\_mult": true,
&gt; "basic\_quorum": false,
&gt; "big\_vclock": 50,
&gt; "chash\_keyfun": {
&gt; "fun": "chash\_std\_keyfun",
&gt; "mod": "riak\_core\_util"
&gt; },
&gt; "claimant": "riak@10.243.44.165",
&gt; "datatype": "map",
&gt; "dvv\_enabled": true,
&gt; "dw": "quorum",
&gt; "last\_write\_wins": false,
&gt; "linkfun": {
&gt; "fun": "mapreduce\_linkfun",
&gt; "mod": "riak\_kv\_wm\_link\_walker"
&gt; },
&gt; "n\_val": 3,
&gt; "notfound\_ok": true,
&gt; "old\_vclock": 86400,
&gt; "postcommit": [],
&gt; "pr": 0,
&gt; "precommit": [],
&gt; "pw": 0,
&gt; "r": "quorum",
&gt; "rw": "quorum",
&gt; "small\_vclock": 50,
&gt; "w": "quorum",
&gt; "young\_vclock": 20
&gt; }
&gt; }
&gt;
&gt; The hook code is ...
&gt;
&gt; precommit\_hook(Object) -&gt;
&gt; case riak\_object:bucket(Object) of
&gt; {BucketType, Bucket} -&gt; Bstr = binary\_to\_list(Bucket), Btstr =
&gt; binary\_to\_list(BucketType);
&gt; Bucket -&gt; Bstr = binary\_to\_list(Bucket), Btstr = &lt;&lt;""&gt;&gt;
&gt; end,
&gt; K = riak\_object:key(Object),
&gt; Kstr = binary\_to\_list(K),
&gt; lager:info("MyHook Bucket type ~s, bucket ~s, key ~s [Btstr, Bstr,
&gt; Kstr]),
&gt; Object.
&gt;
&gt;
&gt; On 18 November 2016 at 14:15, Luke Bakken  wrote:
&gt;&gt;
&gt;&gt; Mav -
&gt;&gt;
&gt;&gt; Please remember to use "Reply All" so that the riak-users list can
&gt;&gt; learn from what you find out. Thanks.
&gt;&gt;
&gt;&gt; Thebucket = riak\_object:bucket(Object),
&gt;&gt;
&gt;&gt; Can you check to see if "Thebucket" is really a two-tuple of
&gt;&gt; "{BucketType, Bucket}"? I believe that is what is returned.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; Engineer
&gt;&gt; lbak...@basho.com
&gt;&gt;
&gt;&gt; On Fri, Nov 18, 2016 at 10:54 AM, Mav erick  wrote:
&gt;&gt; &gt; I have some initializing to do - like connecting to a notification
&gt;&gt; &gt; server,
&gt;&gt; &gt; before I can use the commit hook. But I think I have figured that out
&gt;&gt; &gt; now
&gt;&gt; &gt; that I learnt about supervisors and OTP
&gt;&gt; &gt;
&gt;&gt; &gt; I have one other question though ...
&gt;&gt; &gt; How do I get the bucket type of the bucket of the key that was committed
&gt;&gt; &gt; ?
&gt;&gt; &gt;
&gt;&gt; &gt; I am using these to get the key and bucket names. But I cant seem to
&gt;&gt; &gt; find a
&gt;&gt; &gt; call to get the bucket's bucket type
&gt;&gt; &gt;
&gt;&gt; &gt; Thebucket = riak\_object:bucket(Object),
&gt;&gt; &gt; Thekey = riak\_object:key(Object),
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks !
&gt;&gt; &gt;
&gt;&gt; &gt; On 18 November 2016 at 12:14, Luke Bakken  wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Mav -
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Can you go into more detail? The subject of your message is
&gt;&gt; &gt;&gt; "initializing a commit hook".
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; --
&gt;&gt; &gt;&gt; Luke Bakken
&gt;&gt; &gt;&gt; Engineer
&gt;&gt; &gt;&gt; lbak...@basho.com
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; On Thu, Nov 17, 2016 at 9:09 AM, Mav erick  wrote:
&gt;&gt; &gt;&gt; &gt; Folks
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; Is there way RIAK can call an erlang function in a module when RIAK
&gt;&gt; &gt;&gt; &gt; starts
&gt;&gt; &gt;&gt; &gt; up ?
&gt;&gt; &gt;&gt; &gt;
&gt;&gt; &gt;&gt; &gt; Thanks
&gt;&gt; &gt;&gt; &gt; Mav
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

