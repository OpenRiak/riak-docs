---
title: "Riak Java client 100% CPU"
description: ""
project: community
lastmod: 2013-02-14T08:33:25-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10130"
author_name: "Daniel Iwan"
project_section: "mailinglistitem"
sent_date: 2013-02-14T08:33:25-08:00
---


I see 100% CPU very regularly on one of the Riak client (v1.0.7) threads.
I think the place where it spins is connection reaper in RiakConnectionPool

I looked at it briefly and it seems that when it finds first connection
using peek but that does not expired it can spin in tight while loop.
I guess second peek() should be outside if block?

 private synchronized void doStart() {
 if (idleConnectionTTLNanos &gt; 0) {
 idleReaper.scheduleWithFixedDelay(new Runnable() {
 public void run() {
 RiakConnection c = available.peek();
 while (c != null) {
 long connIdleStartNanos = c.getIdleStartTimeNanos();
 if (connIdleStartNanos + idleConnectionTTLNanos &lt;
System.nanoTime()) {
 if (c.getIdleStartTimeNanos() ==
connIdleStartNanos) {
 // still a small window, but better than
locking
 // the whole pool
 boolean removed = available.remove(c);
 if (removed) {
 c.close();
 permits.release();
 }
 }
 c = available.peek();
 }
 }
 }
 }, idleConnectionTTLNanos, idleConnectionTTLNanos,
TimeUnit.NANOSECONDS);
 }

 state = State.RUNNING;
 }


Regards
Daniel Iwan
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

