---
title: "Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys"
description: ""
project: community
lastmod: 2012-05-24T08:43:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07530"
mailinglist_parent_id: "msg07529"
author_name: "Steve Warren"
project_section: "mailinglistitem"
sent_date: 2012-05-24T08:43:22-07:00
---


Thanks Reid, that's a very clear explanation. Are there any logs created
under the cited circumstances? I'm not seeing any errors or logs that
indicate any of the below conditions are in fact happening and would like
to confirm the exact condition. I'm also not clear why doing this "PR = PW
= R = W = all" would eliminate the issue if it is about the reap failing.
Isn't reaping always independent of the success of the operation? In other
words, isn't creating a successful tombstone the definition of a successful
delete? Or does using "all" bypass the tombstone process altogether?

I will test out this workaround, it is probably worth doing to ensure the
indices are always correct rather then pepper the code to handle not found
conditions. Although it's still early in my evaluation so I may find a
reason to pepper the code anyway. :)

Finally, is there a process to create an issue that will track the eventual
resolution? If I do the workaround I'd like to take it out when it is
finally resolved (if there is a final resolution).

Regards
Steve

On Thu, May 24, 2012 at 8:27 AM, Reid Draper  wrote:

&gt; I have a pretty good idea what is causing this problem.
&gt;
&gt; Riak uses "tombstone" values to denote that an object has been deleted.
&gt; Under normal conditions, this tombstone value (really, the key/value pair)
&gt; will be deleted three (3) seconds after the delete. The delete\_mode config
&gt; lets you change the time from three seconds, or to put it at immediate or
&gt; keep.
&gt;
&gt; Regardless of the value of delete\_mode, the key will continue to show
&gt; up in list-keys and 2i $key queries as long as the tombstone is still
&gt; around. This is because those calls simply iterate through the keys,
&gt; and don't inspect the values for tombstones (this could potentially
&gt; by quite costly, depending on the backend).
&gt;
&gt; For a more detailed explanation of deletes in Riak, I highly
&gt; suggest you read Jon Meredith's ML post [1].
&gt;
&gt; Since in both of these cases, you have delete\_mode set to either
&gt; 3s or immediate, we are seeing a case where the first time the tombstone
&gt; is attempted to be reaped, it fails. The tombstone reaping isn't attempted
&gt; again until you do a GET on the object, which is why you see it no longer
&gt; appear in 2i and list-keys queries afterward. This is because a
&gt; read-repair-like
&gt; mechanism runs and sees that the tombstone needs to be reaped.
&gt;
&gt; So why is the tombstone reap failing the first time? There could be several
&gt; reasons. It's important to know, first, that the reaping process requires
&gt; all
&gt; N \_primary\_ replicas to be up and responding. Here are some potential
&gt; reasons:
&gt;
&gt; 1. One of the primaries is temporarily unreachable.
&gt; 2. The original tombstone writes didn't go to all N primaries, for any
&gt; reason
&gt; 3. The async GET after that starts the tombstone reaping times out, for
&gt; any reason
&gt;
&gt; I don't have a silver-bullet recommendation for this problem at the moment.
&gt; If you'd like to favor having deleted keys \_not\_ show up in 2i/list-keys
&gt; requests over delete-availability, you can make your delete requests
&gt; with PR = PW = R = W = all (note 'all' is equivalent to whatever your
&gt; bucket's
&gt; N value is).
&gt;
&gt; We'll also be exploring how we can fix or mitigate this situation for
&gt; an upcoming release.
&gt;
&gt; [1]:
&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html
&gt;
&gt; Thanks,
&gt; Reid Draper
&gt; Software Engineer
&gt; Basho
&gt;
&gt; On May 23, 2012, at 4:42 PM, Steve Warren wrote:
&gt;
&gt; I have a 5 node cluster and given a successful delete call, I expect to
&gt; get the latest data back given the bucket properties (as shown below)...
&gt;
&gt; Bucket properties:
&gt;
&gt;
&gt; {"props":{"name":"mybucket","allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":4,"notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":"quorum","precommit":[],"pw":"quorum","r":"quorum","rw":"quorum","small\_vclock":50,"w":"quorum","young\_vclock":20}}
&gt;
&gt; Is my understanding not correct in this (the important properties to me
&gt; are the pw/pr settings to ensure a good distribution and consistency).
&gt;
&gt; Regards
&gt; Steve
&gt;
&gt; On Wed, May 23, 2012 at 1:31 PM, Shuhao Wu  wrote:
&gt;
&gt;&gt; Riak is eventually consistent. Deleting it doesn't show up immediately.
&gt;&gt; There is an option like delete\_immediate
&gt;&gt;
&gt;&gt; Shuhao
&gt;&gt; On May 23, 2012 4:08 PM, "Steve Warren"  wrote:
&gt;&gt;
&gt;&gt;&gt; I'm seeing this pretty consistently and have no explanation for it. I
&gt;&gt;&gt; delete a large number of keys (20k to 100k), but when I then search on the
&gt;&gt;&gt; keys ($key/0/g) anywhere from 0-200 or so of the deleted keys show up in
&gt;&gt;&gt; the results. It doesn't matter how long I wait after completing the
&gt;&gt;&gt; deletion step, the keys stay in the list until I try to access the object
&gt;&gt;&gt; and then it goes away. I'm using 1.1.2 and the riak-java client, and
&gt;&gt;&gt; getting no errors on the deletion step.
&gt;&gt;&gt;
&gt;&gt;&gt; On Tue, May 22, 2012 at 9:34 AM, Steve Warren wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thank you for the reply. My observation does not quite match up with
&gt;&gt;&gt;&gt; this though so I'm still a bit confused. The deleted keys appeared to stay
&gt;&gt;&gt;&gt; long past the 3 seconds described in the post you referenced. In fact, I
&gt;&gt;&gt;&gt; don't know if they ever "went away". I'll run some more tests to see if I
&gt;&gt;&gt;&gt; can narrow down the exact behavior, for example not all key deletions
&gt;&gt;&gt;&gt; exhibited this behavior (the test I ran resulted in 118 residual keys out
&gt;&gt;&gt;&gt; of around 20K deletes). If I directly queried any of the keys it would
&gt;&gt;&gt;&gt; respond with "not found" and immediately stop showing up in the key list or
&gt;&gt;&gt;&gt; $key index query.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'm still running a bunch of tests just to learn the behavior of the
&gt;&gt;&gt;&gt; system so I'll keep plugging away at it. For example, I'm observing that
&gt;&gt;&gt;&gt; $key index queries halt inserts into the same bucket while the query is
&gt;&gt;&gt;&gt; running, I don't know yet if this halts all server activity or just the
&gt;&gt;&gt;&gt; inserts for that bucket though.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Regards
&gt;&gt;&gt;&gt; Steve
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Tue, May 22, 2012 at 8:58 AM, Kelly McLaughlin wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Hi Steve. There is no caching of key lists in riak. What you are
&gt;&gt;&gt;&gt;&gt; seeing is likely the fact that listing of keys or index queries can pick 
&gt;&gt;&gt;&gt;&gt; up
&gt;&gt;&gt;&gt;&gt; deleted keys due to the fact that riak keeps tombstone markers around for
&gt;&gt;&gt;&gt;&gt; deleted objects for some period. For a really good explanation of riak's
&gt;&gt;&gt;&gt;&gt; delete behavior check out this writeup by Jon Meredith:
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html.
&gt;&gt;&gt;&gt;&gt; You can set delete\_mode to immediate as described in that post and you 
&gt;&gt;&gt;&gt;&gt; will
&gt;&gt;&gt;&gt;&gt; most likely not see any deleted keys when you do an index query or key
&gt;&gt;&gt;&gt;&gt; list. The tradeoff is that you may get the unexpected behavior when doing
&gt;&gt;&gt;&gt;&gt; concurrent updates to the same set of keys that the delete\_mode changes
&gt;&gt;&gt;&gt;&gt; were designed to address as Jon also indicates in that post. We are
&gt;&gt;&gt;&gt;&gt; considering different options on this front, but at this time no actual
&gt;&gt;&gt;&gt;&gt; changes have been made to address this.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On May 20, 2012, at 10:13 AM, Steve Warren wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The last message I saw on this (from a year ago) says the caching of
&gt;&gt;&gt;&gt;&gt; key lists will be removed. I just ran into it while running a $key index
&gt;&gt;&gt;&gt;&gt; range search. I then ran a ?key=stream search on the bucket and the same
&gt;&gt;&gt;&gt;&gt; stale key list appeared (I had created a bunch of data and then deleted it
&gt;&gt;&gt;&gt;&gt; as a test). Did the caching removal not happen? I'm running 1.1.2
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The query:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; curl 'localhost:8098/buckets/testbucket/index/$key/0/g'
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; As others have noted, this behavior is quite disconcerting and I don't
&gt;&gt;&gt;&gt;&gt; want to pepper the application with otherwise unnecessary checks for stale
&gt;&gt;&gt;&gt;&gt; keys even on 2i range queries. Or is that unavoidable?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Regards
&gt;&gt;&gt;&gt;&gt; Steve
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

