---
title: "Re: Link Walking via Map Reduce"
description: ""
project: community
lastmod: 2011-06-23T00:46:18-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03795"
mailinglist_parent_id: "msg03794"
author_name: "Sylvain Niles"
project_section: "mailinglistitem"
sent_date: 2011-06-23T00:46:18-07:00
---


That looks just like the json of death I was experiencing. Can you try
doing a get on that key and using a json validator on it? Riak will
let you put invalid json in, but the map/reduce parser will break on
it.


On Wed, Jun 22, 2011 at 10:59 PM, Andrew Berman  wrote:
&gt; Hey Ryan,
&gt;
&gt; Here is the error from the sasl log.  It looks like some sort of
&gt; encoding error.  Any thoughts on how to fix this?  I am storing the
&gt; data as BERT encoded binary and I set the content-type as
&gt; application/octet-stream.
&gt;
&gt; Thanks for your help!
&gt;
&gt; Andrew
&gt;
&gt; ERROR REPORT==== 9-Jun-2011::21:37:05 ===
&gt; \*\* Generic server &lt;0.5996.21&gt; terminating
&gt; \*\* Last message in was {batch\_dispatch,
&gt;                         {map,
&gt;                          {jsanon,&lt;&lt;"function(value) {return [value];}"&gt;&gt;},
&gt;                          [{struct,
&gt;                            [{&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"user"&gt;&gt;},
&gt;                             {&lt;&lt;"key"&gt;&gt;,&lt;&lt;"LikiWUPJSFuxtrhCYpsPfg"&gt;&gt;},
&gt;                             {&lt;&lt;"vclock"&gt;&gt;,
&gt;
&gt; &lt;&lt;"a85hYGBgzGDKBVIsLKaZdzOYEhnzWBmes6Yd58sCAA=="&gt;&gt;},
&gt;                             {&lt;&lt;"values"&gt;&gt;,
&gt;                              [{struct,
&gt;                                [{&lt;&lt;"metadata"&gt;&gt;,
&gt;                                  {struct,
&gt;                                   [{&lt;&lt;"X-Riak-VTag"&gt;&gt;,
&gt;                                     &lt;&lt;"1KnL9Dlma9Yg4eMhRuhwtx"&gt;&gt;},
&gt;                                    {&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;,
&gt;                                     &lt;&lt;"Fri, 10 Jun 2011 03:05:11 GMT"&gt;&gt;}]}},
&gt;                                 {&lt;&lt;"data"&gt;&gt;,
&gt;
&gt; &lt;&lt;131,108,0,0,0,18,104,2,100,0,6,114,...&gt;&gt;}]}]}]},
&gt;                          &lt;&lt;"user"&gt;&gt;,none]}}
&gt; \*\* When Server state == {state,&lt;0.143.0&gt;,riak\_kv\_js\_map,#Port&lt;0.92614&gt;,true}
&gt; \*\* Reason for termination ==
&gt; \*\* {function\_clause,[{js\_driver,eval\_js,
&gt;                                [#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},
&gt;                     {riak\_kv\_js\_vm,invoke\_js,2},
&gt;                     {riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},
&gt;                     {riak\_kv\_js\_vm,handle\_call,3},
&gt;                     {gen\_server,handle\_msg,5},
&gt;                     {proc\_lib,init\_p\_do\_apply,3}]}
&gt;
&gt; =CRASH REPORT==== 9-Jun-2011::21:37:05 ===
&gt;   crasher:
&gt;     initial call: riak\_kv\_js\_vm:init/1
&gt;     pid: &lt;0.5996.21&gt;
&gt;     registered\_name: []
&gt;     exception exit:
&gt; {function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]}
&gt;       in function  gen\_server:terminate/6
&gt;       in call from proc\_lib:init\_p\_do\_apply/3
&gt;     ancestors: [riak\_kv\_js\_sup,riak\_kv\_sup,&lt;0.128.0&gt;]
&gt;     messages: []
&gt;     links: [&lt;0.142.0&gt;,&lt;0.6009.21&gt;]
&gt;     dictionary: []
&gt;     trap\_exit: false
&gt;     status: running
&gt;     heap\_size: 4181
&gt;     stack\_size: 24
&gt;     reductions: 2586
&gt;   neighbours:
&gt;     neighbour: 
&gt; [{pid,&lt;0.6009.21&gt;},{registered\_name,[]},{initial\_call,{riak\_kv\_mapper,init,[Argument\_\_1]}},{current\_function,{gen,do\_call,4}},{ancestors,[riak\_kv\_mapper\_sup,riak\_kv\_sup,&lt;0.128.0&gt;]},{messages,[]},{links,[&lt;0.5996.21&gt;,&lt;12337.6227.21&gt;,&lt;0.162.0&gt;]},{dictionary,[]},{trap\_exit,false},{status,waiting},{heap\_size,987},{stack\_size,53},{reductions,1043}]
&gt; =SUPERVISOR REPORT==== 9-Jun-2011::21:37:05 ===
&gt;      Supervisor: {local,riak\_kv\_js\_sup}
&gt;      Context:    child\_terminated
&gt;      Reason:
&gt; {function\_clause,[{js\_driver,eval\_js,[#Port&lt;0.92614&gt;,{error,bad\_encoding},5000]},{riak\_kv\_js\_vm,invoke\_js,2},{riak\_kv\_js\_vm,define\_invoke\_anon\_js,3},{riak\_kv\_js\_vm,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]}
&gt;      Offender:
&gt; [{pid,&lt;0.5996.21&gt;},{name,undefined},{mfargs,{riak\_kv\_js\_vm,start\_link,undefined}},{restart\_type,temporary},{shutdown,2000},{child\_type,worker}]
&gt;
&gt; On Wed, Jun 22, 2011 at 6:10 PM, Ryan Zezeski  wrote:
&gt;&gt;
&gt;&gt; Andrew,
&gt;&gt; Maybe you could elaborate on the error?  I tested this against master 
&gt;&gt; (commit below) just now with success.
&gt;&gt; 2b1a474f836d962fa035f48c05452e22fc6c2193 Change dependency to allow for 
&gt;&gt; R14B03 as well as R14B02
&gt;&gt; -Ryan
&gt;&gt; On Wed, Jun 22, 2011 at 7:03 PM, Andrew Berman  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hello,
&gt;&gt;&gt; I'm having issues link walking using the Map Reduce link function.  I am 
&gt;&gt;&gt; using HEAD from Git, so it's possible that's the issue, but here is what is 
&gt;&gt;&gt; happening.
&gt;&gt;&gt; I've got two buckets, user and user\_email where user\_email contains a link 
&gt;&gt;&gt; to the user.
&gt;&gt;&gt; When I run this:
&gt;&gt;&gt; {
&gt;&gt;&gt;     "inputs": [
&gt;&gt;&gt;         [
&gt;&gt;&gt;             "user\_email",
&gt;&gt;&gt;             "myem...@email.com"
&gt;&gt;&gt;         ]
&gt;&gt;&gt;     ],
&gt;&gt;&gt;     "query": [
&gt;&gt;&gt;         {
&gt;&gt;&gt;             "link": {
&gt;&gt;&gt;                 "bucket": "user",
&gt;&gt;&gt;                 "tag": "user"
&gt;&gt;&gt;             }
&gt;&gt;&gt;         }
&gt;&gt;&gt;     ]
&gt;&gt;&gt; }
&gt;&gt;&gt; I only get [["user","LikiWUPJSFuxtrhCYpsPfg","user"]] returned.  The second 
&gt;&gt;&gt; I add a map function, even the simplest one (function(v) { [v] } I get a 
&gt;&gt;&gt; "map\_reduce error":
&gt;&gt;&gt; {
&gt;&gt;&gt;     "inputs": [
&gt;&gt;&gt;         [
&gt;&gt;&gt;             "user\_email",
&gt;&gt;&gt;             "myem...@email.com"
&gt;&gt;&gt;         ]
&gt;&gt;&gt;     ],
&gt;&gt;&gt;     "query": [
&gt;&gt;&gt;         {
&gt;&gt;&gt;             "link": {"bucket":"user", "tag":"user"}
&gt;&gt;&gt;         }
&gt;&gt;&gt;        ,{
&gt;&gt;&gt;             "map": {
&gt;&gt;&gt;                 "language": "javascript",
&gt;&gt;&gt;                 "source": "function(v) { return[v]; }"
&gt;&gt;&gt;             }
&gt;&gt;&gt;         }
&gt;&gt;&gt;     ]
&gt;&gt;&gt; }
&gt;&gt;&gt; Is this functionality broken?  I am following what it says on the Wiki for 
&gt;&gt;&gt; the MapRed version of link walking.  When I use HTTP link walking, it works 
&gt;&gt;&gt; correctly.
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Andrew
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

