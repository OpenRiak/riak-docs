---
title: "Re: Mismatched object counts"
description: ""
project: community
lastmod: 2013-06-21T09:36:10-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11322"
mailinglist_parent_id: "msg11321"
author_name: "Elias Levy"
project_section: "mailinglistitem"
sent_date: 2013-06-21T09:36:10-07:00
---


Well, what do you know: 2,565,187. Apologies for the false alarm.


On Fri, Jun 21, 2013 at 7:29 AM, Joe Caswell  wrote:

&gt; Elias,
&gt;
&gt; Just for the sake of argument, if you use
&gt; index(bucket\_name,"$key",'0'..'z')
&gt; do you get the same result?
&gt;
&gt; Joe
&gt;
&gt; From: Elias Levy 
&gt; Date: Friday, June 21, 2013 1:57 AM
&gt; To: "riak-users@lists.basho.com" 
&gt; Subject: Mismatched object counts
&gt;
&gt; I've just inserted some data into a six node Riak 1.3.1 EE cluster. The
&gt; keys are all SHA256s. The bucket previously had somewhere in
&gt; the vicinity of 1 million objects.
&gt;
&gt; A MR job using the $key 2i with a range of '0' to 'Z', which should cover
&gt; all possible SHA256s, and using
&gt; both riak\_kv\_mapreduce:: reduce\_count\_inputs and streaming the keys using
&gt; reduce\_identity and counting client side, both returned a count around
&gt; 750K, but that is now somewhat suspect.
&gt;
&gt; The objects I inserted overlap somewhat with the previously existing
&gt; objects, but not completely. Overlapping objects were merged. I
&gt; inserted 2,521,799 objects.
&gt;
&gt; When I execute the MR count job against it reports 1,604,783 objects,
&gt; using both techniques (reduce\_count\_inputs and reduce\_identity plus client
&gt; side counting).
&gt;
&gt; Given the discrepancy I queried the bucket for the 2,521,799 objects I
&gt; thought I inserted and I verified the system thinks they are there.
&gt;
&gt; What gives? Why is MR returning incorrect result? Does the 2i query
&gt; somehow miss some possible keys?
&gt;
&gt; This is what the job looks like in Ruby:
&gt;
&gt; Riak::MapReduce.new(client).
&gt; index(bucket\_name, "$key", '0'..'Z').
&gt; reduce(['riak\_kv\_mapreduce', 'reduce\_count\_inputs'], :keep =&gt; true, :arg
&gt; =&gt; { "reduce\_phase\_batch\_size" =&gt; 1000, "do\_prereduce" =&gt; true } ).
&gt; timeout(86400000).
&gt; run
&gt;
&gt; As a side question, does do\_prereduce here have any effect? I am thinking
&gt; it does not. The docs indicate do\_prereduce is a map phase argument, not a
&gt; reduce phase one. That begs the question of how to enable prereduce for a
&gt; MR job without a map phase, other than setting mapred\_always\_prereduce =
&gt; true in the config file.
&gt;
&gt; Elias
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

