---
title: "Re: Riak Java client not returning deleted sibling"
description: ""
project: community
lastmod: 2013-10-07T11:42:20-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12527"
mailinglist_parent_id: "msg12515"
author_name: "Daniel Iwan"
project_section: "mailinglistitem"
sent_date: 2013-10-07T11:42:20-07:00
---


Hi Brian

Thanks for update.
I'm using 1.1.3 now and still have some issues sibling related

Two clients are updating the same key.
Updated is my custom meta field, which should be merged to contain values
from both clients (set)
I see both client are doing fetch, resolving sibling (only 1 i.e. no
siblings), apply mutation (their own values for meta field). After that
object is converted using fromDomain() in my converter using vclock provided
Both nodes use vclock
6bce61606060cc60ca05521cf385ab3e05053d2dc8604a64cc6365589678fc345f1600

So far so god.
But the next step is toDomain (which is pare of Store I think since I'm
using withBody) and looks like each node contains info only about
it own changes.
Client one sees vclock
6bce61606060cc60ca05521cf385ab3e05053d2dc8604a64ca6365589678fc345f1600
Client 2 sees
vclock 
6bce61606060ca60ca05521cf385ab3e05053d2dc8604a64ca6365589678fc341f548a4d4adb032ac508945a0e92ca0200

Both of vclocks are different than original vclock given during store,
which I assume means RIak accepted write.
Resolve is called on both machines but there is only one sibling.

I guess the fact that I'm changing only meta field should not matter here
and I should see 2 siblings?
allow\_multi is of course true and lastWriteWins is false on that bucket

Any help much appreciated


Regards
Daniel












On 4 October 2013 21:41, Brian Roach  wrote:

&gt; Hey -
&gt;
&gt; I'm releasing 1.1.3 and 1.4.2 but it'll take a while for them to get
&gt; staged at maven central so I can post an "official" release to the
&gt; mailing list.
&gt;
&gt; I've gone ahead and uploaded the jar-with-dependencies to the usual
&gt; place for you-
&gt;
&gt;
&gt; http://riak-java-client.s3.amazonaws.com/riak-client-1.1.3-jar-with-dependencies.jar
&gt;
&gt; It fixes up the DomainBucket stuff and the JSONConverter.
&gt;
&gt; Thanks,
&gt; - Roach
&gt;
&gt; On Fri, Oct 4, 2013 at 2:58 AM, Daniel Iwan  wrote:
&gt; &gt; Thanks Brian for putting fix together so quickly.
&gt; &gt;
&gt; &gt; I think I found something else though.
&gt; &gt; In JSONConverter I don't see vclock being set in toDomain() when
&gt; converting
&gt; &gt; deleted sibling?
&gt; &gt; That vclock should be used for following delete if I understood it
&gt; &gt; correctly?
&gt; &gt;
&gt; &gt; Also where can I download latest build? I tried
&gt; &gt;
&gt; http://riak-java-client.s3.amazonaws.com/riak-client-1.1.3-jar-with-dependencies.jar
&gt; &gt; but access is denied
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt; Daniel
&gt; &gt;
&gt; &gt;
&gt; &gt; On 3 October 2013 19:36, Brian Roach  wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; On Thu, Oct 3, 2013 at 10:32 AM, Daniel Iwan 
&gt; &gt;&gt; wrote:
&gt; &gt;&gt; &gt; Thanks Brian for quick response.
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; As a side question, what is the best way to delete such an object i.e.
&gt; &gt;&gt; &gt; once
&gt; &gt;&gt; &gt; I know one of the siblings has 'deleted' flag true because I fetched
&gt; it?
&gt; &gt;&gt; &gt; Should I just use DomainBucket.delete(key) without providing any
&gt; vclock?
&gt; &gt;&gt; &gt; Would it wipe it from Riak or create yet another sibling?
&gt; &gt;&gt;
&gt; &gt;&gt; You should always use vclocks when possible, which in the case it is.
&gt; &gt;&gt; There are additional issues around doing the delete without a vclock
&gt; &gt;&gt; and if there's concurrently a store operation occurring.
&gt; &gt;&gt;
&gt; &gt;&gt; Ideally you should look at why you're getting that tombstone sibling.
&gt; &gt;&gt; If it's simply a case of high write concurrency and you're using
&gt; &gt;&gt; vclocks with your writes, then there's not much you can do except
&gt; &gt;&gt; resolve it later (without changing how you're using the DB)... but
&gt; &gt;&gt; usually these things are caused by writes without a vclock.
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks,
&gt; &gt;&gt; - Roach
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; Regards
&gt; &gt;&gt; &gt; Daniel
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt; On 3 October 2013 17:20, Brian Roach  wrote:
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; Daniel -
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; Yeah, that is the case. When the ability to pass fetch/store/delete
&gt; &gt;&gt; &gt;&gt; meta was added to DomainBucket way back when it appears that was
&gt; &gt;&gt; &gt;&gt; missed.
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; I'll add it and forward-port to 1.4.x as well and cut new jars.
&gt; Should
&gt; &gt;&gt; &gt;&gt; be avail by tomorrow morning at the latest.
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; Thanks!
&gt; &gt;&gt; &gt;&gt; - Roach
&gt; &gt;&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt; On Thu, Oct 3, 2013 at 9:38 AM, Daniel Iwan 
&gt; &gt;&gt; &gt;&gt; wrote:
&gt; &gt;&gt; &gt;&gt; &gt; Hi I'm using Riak 1.3.1 and Java client 1.1.2
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Using http and curl I see 4 siblings for an object one of which has
&gt; &gt;&gt; &gt;&gt; &gt; X-Riak-Deleted: true
&gt; &gt;&gt; &gt;&gt; &gt; but when I'm using Java client with DomainBucket my Converter's
&gt; &gt;&gt; &gt;&gt; &gt; method
&gt; &gt;&gt; &gt;&gt; &gt; toDomain is called only 3 times.
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; I have set the property
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; builder.returnDeletedVClock(true);
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; on my DomainBuilder which I keep reusing for all queries and store
&gt; &gt;&gt; &gt;&gt; &gt; operations (I guess that's good practice btw.?)
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; I run that under debugger and it seems raw client sees 4 siblings
&gt; but
&gt; &gt;&gt; &gt;&gt; &gt; passes
&gt; &gt;&gt; &gt;&gt; &gt; over only 3 due to bug (I think) in DomainBucket.fetch() method
&gt; which
&gt; &gt;&gt; &gt;&gt; &gt; should
&gt; &gt;&gt; &gt;&gt; &gt; have
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; if (fetchMeta.hasReturnDeletedVClock()) {
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; so.returnDeletedVClock(fetchMeta.getReturnDeletedVClock());
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; }
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; at the end, as store() method has.
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Could you confirm or I'm I completely wrong?
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Regards
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; Daniel
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; &gt;&gt; &gt; riak-users mailing list
&gt; &gt;&gt; &gt;&gt; &gt; riak-users@lists.basho.com
&gt; &gt;&gt; &gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

