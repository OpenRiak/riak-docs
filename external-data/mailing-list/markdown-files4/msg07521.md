---
title: "Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys"
description: ""
project: community
lastmod: 2012-05-23T13:43:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07521"
mailinglist_parent_id: "msg07519"
author_name: "Steve Warren"
project_section: "mailinglistitem"
sent_date: 2012-05-23T13:43:01-07:00
---


I have a 5 node cluster and given a successful delete call, I expect to get
the latest data back given the bucket properties (as shown below)...

Bucket properties:

{"props":{"name":"mybucket","allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":4,"notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":"quorum","precommit":[],"pw":"quorum","r":"quorum","rw":"quorum","small\_vclock":50,"w":"quorum","young\_vclock":20}}

Is my understanding not correct in this (the important properties to me are
the pw/pr settings to ensure a good distribution and consistency).

Regards
Steve

On Wed, May 23, 2012 at 1:31 PM, Shuhao Wu  wrote:

&gt; Riak is eventually consistent. Deleting it doesn't show up immediately.
&gt; There is an option like delete\_immediate
&gt;
&gt; Shuhao
&gt; On May 23, 2012 4:08 PM, "Steve Warren"  wrote:
&gt;
&gt;&gt; I'm seeing this pretty consistently and have no explanation for it. I
&gt;&gt; delete a large number of keys (20k to 100k), but when I then search on the
&gt;&gt; keys ($key/0/g) anywhere from 0-200 or so of the deleted keys show up in
&gt;&gt; the results. It doesn't matter how long I wait after completing the
&gt;&gt; deletion step, the keys stay in the list until I try to access the object
&gt;&gt; and then it goes away. I'm using 1.1.2 and the riak-java client, and
&gt;&gt; getting no errors on the deletion step.
&gt;&gt;
&gt;&gt; On Tue, May 22, 2012 at 9:34 AM, Steve Warren  wrote:
&gt;&gt;
&gt;&gt;&gt; Thank you for the reply. My observation does not quite match up with
&gt;&gt;&gt; this though so I'm still a bit confused. The deleted keys appeared to stay
&gt;&gt;&gt; long past the 3 seconds described in the post you referenced. In fact, I
&gt;&gt;&gt; don't know if they ever "went away". I'll run some more tests to see if I
&gt;&gt;&gt; can narrow down the exact behavior, for example not all key deletions
&gt;&gt;&gt; exhibited this behavior (the test I ran resulted in 118 residual keys out
&gt;&gt;&gt; of around 20K deletes). If I directly queried any of the keys it would
&gt;&gt;&gt; respond with "not found" and immediately stop showing up in the key list or
&gt;&gt;&gt; $key index query.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm still running a bunch of tests just to learn the behavior of the
&gt;&gt;&gt; system so I'll keep plugging away at it. For example, I'm observing that
&gt;&gt;&gt; $key index queries halt inserts into the same bucket while the query is
&gt;&gt;&gt; running, I don't know yet if this halts all server activity or just the
&gt;&gt;&gt; inserts for that bucket though.
&gt;&gt;&gt;
&gt;&gt;&gt; Regards
&gt;&gt;&gt; Steve
&gt;&gt;&gt;
&gt;&gt;&gt; On Tue, May 22, 2012 at 8:58 AM, Kelly McLaughlin wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi Steve. There is no caching of key lists in riak. What you are seeing
&gt;&gt;&gt;&gt; is likely the fact that listing of keys or index queries can pick up
&gt;&gt;&gt;&gt; deleted keys due to the fact that riak keeps tombstone markers around for
&gt;&gt;&gt;&gt; deleted objects for some period. For a really good explanation of riak's
&gt;&gt;&gt;&gt; delete behavior check out this writeup by Jon Meredith:
&gt;&gt;&gt;&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html.
&gt;&gt;&gt;&gt; You can set delete\_mode to immediate as described in that post and you will
&gt;&gt;&gt;&gt; most likely not see any deleted keys when you do an index query or key
&gt;&gt;&gt;&gt; list. The tradeoff is that you may get the unexpected behavior when doing
&gt;&gt;&gt;&gt; concurrent updates to the same set of keys that the delete\_mode changes
&gt;&gt;&gt;&gt; were designed to address as Jon also indicates in that post. We are
&gt;&gt;&gt;&gt; considering different options on this front, but at this time no actual
&gt;&gt;&gt;&gt; changes have been made to address this.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On May 20, 2012, at 10:13 AM, Steve Warren wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The last message I saw on this (from a year ago) says the caching of
&gt;&gt;&gt;&gt; key lists will be removed. I just ran into it while running a $key index
&gt;&gt;&gt;&gt; range search. I then ran a ?key=stream search on the bucket and the same
&gt;&gt;&gt;&gt; stale key list appeared (I had created a bunch of data and then deleted it
&gt;&gt;&gt;&gt; as a test). Did the caching removal not happen? I'm running 1.1.2
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The query:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; curl 'localhost:8098/buckets/testbucket/index/$key/0/g'
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; As others have noted, this behavior is quite disconcerting and I don't
&gt;&gt;&gt;&gt; want to pepper the application with otherwise unnecessary checks for stale
&gt;&gt;&gt;&gt; keys even on 2i range queries. Or is that unavoidable?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Regards
&gt;&gt;&gt;&gt; Steve
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

