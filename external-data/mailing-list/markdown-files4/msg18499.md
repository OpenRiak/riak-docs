---
title: "Re: WARNING: Not all replicas will be on distinct nodes"
description: ""
project: community
lastmod: 2017-12-14T15:57:15-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18499"
mailinglist_parent_id: "msg18498"
author_name: "Martin Sumner"
project_section: "mailinglistitem"
sent_date: 2017-12-14T15:57:15-08:00
---


Yes, this looks like the standard tail-wrapping problem. You are right
that adding an eight node should resolve this, and if the standard code
doesn't resolve it, running plans with v3 will eventually resolve it.

As for when the warning would appear, I'm not sure I really know when the
warning would appear during the transfers - but it should have definitely
appeared at the point you issued the "cluster plan" command on the previous
transition. Perhaps I've misunderstood your question though.

On 14 December 2017 at 23:04, Daniel Miller  wrote:

&gt; Thank you, Martin! With that information plus output of `riak-admin
&gt; cluster partitions --node=...` I was able to determine which nodes have
&gt; preflist/replica problems.
&gt;
&gt; Two nodes in my cluster appear to have problems. Here are the partition
&gt; mappings prior to adding the 7th node. I think things will improve after
&gt; the 7th node (riak29) has joined the cluster (more on that below).
&gt;
&gt; Partitions owned by 'riak@riak20.internal':
&gt; +---------+-------------------------------------------------+---+
&gt; | type | index |id |
&gt; +---------+-------------------------------------------------+---+
&gt; | primary | 0 | 0 |
&gt; | primary | 68507889249886074290797726533575766546371837952 | 6 |
&gt; | primary |137015778499772148581595453067151533092743675904 |12 |
&gt; ...
&gt; | primary |1370157784997721485815954530671515330927436759040|120|
&gt; | primary |1438665674247607560106752257205091097473808596992|126|
&gt; |secondary| -- |-- |
&gt; | stopped | -- |-- |
&gt; +---------+-------------------------------------------------+---+
&gt;
&gt; Partitions owned by 'riak@riak21.internal':
&gt; +---------+-------------------------------------------------+---+
&gt; | type | index |id |
&gt; +---------+-------------------------------------------------+---+
&gt; | primary | 11417981541647679048466287755595961091061972992 | 1 |
&gt; | primary | 79925870791533753339264014289171727637433810944 | 7 |
&gt; ...
&gt; | primary |1381575766539369164864420818427111292018498732032|121|
&gt; | primary |1450083655789255239155218544960687058564870569984|127|
&gt; |secondary| -- |-- |
&gt; | stopped | -- |-- |
&gt; +---------+-------------------------------------------------+---+
&gt;
&gt; Partitions owned by 'riak@riak29.internal':
&gt; +---------+-------------------------------------------------+---+
&gt; | type | index |id |
&gt; +---------+-------------------------------------------------+---+
&gt; | primary | -- |-- |
&gt; |secondary| 22835963083295358096932575511191922182123945984 | 2 |
&gt; |secondary| 68507889249886074290797726533575766546371837952 | 6 |
&gt; ...
&gt; |secondary|765004763290394496247241279624929393101152190464 |67 |
&gt; |secondary|1438665674247607560106752257205091097473808596992|126|
&gt; | stopped | -- |-- |
&gt; +---------+-------------------------------------------------+---+
&gt;
&gt;
&gt; Here's my understanding of how the preflists work:
&gt; riak20 has vnode 126 -&gt; preflist: 126, 127, 0 -&gt; (riak20, riak21, riak20)
&gt; two distinct nodes = bad
&gt; riak21 has vnode 127 -&gt; preflist: 127, 0, 1 -&gt; (riak21, riak20, riak21)
&gt; two distinct nodes = bad
&gt;
&gt; After adding one new node I believe the problem on riak20 will go away
&gt; because riak29 will become the new primary for 126, so the new preflist
&gt; will be
&gt;
&gt; riak29: vnode 126 -&gt; preflist: 126, 127, 0 -&gt; (riak29, riak21, riak20)
&gt; three distinct nodes = good
&gt;
&gt; However, vnodes 1 and 127 will remain on riak21, so that's still a
&gt; problem. Hopefully adding another node to the cluster will resolve that
&gt; issue. If that does not do it I'll try switching to claim v3.
&gt;
&gt; If my logic is correct, then you are also correct: it appears this problem
&gt; has been present since a previous cluster transition. I reviewed the logs
&gt; from the previous transition and I did not get "WARNING: Not all replicas
&gt; will be on distinct nodes" after the final set of transfers, which
&gt; incidentally involved riak21 (although it did appear earlier in the plan).
&gt; Is it true that if that warning appears anywhere in the plan then it's a
&gt; bad plan?
&gt;
&gt; Thank you again for the quick response!
&gt; Daniel
&gt;
&gt;
&gt; On Thu, Dec 14, 2017 at 4:27 PM, Martin Sumner &lt;
&gt; martin.sum...@infinityworks.com&gt; wrote:
&gt;
&gt;&gt; Daniel,
&gt;&gt;
&gt;&gt; See this post (http://lists.basho.com/pipermail/riak-users\_lists.basho.
&gt;&gt; com/2017-August/019488.html) and the links in it for some more details
&gt;&gt; on issues with the core claim algorithm. The fix is in the pending release
&gt;&gt; 2.2.5 which Russell is adding the finishing touches to at the moment.
&gt;&gt;
&gt;&gt; However, the fix may not immediately resolve your problem - the fix is
&gt;&gt; about preventing this situation, not necessarily about resolving it once it
&gt;&gt; has been created. Also the issue we saw that would lead to this, would not
&gt;&gt; (I think) be triggered by adding a single node - unless the cluster already
&gt;&gt; had the problem. So it is possible, although you are seeing the warning
&gt;&gt; now, you had the issue when your originally created the cluster, and the
&gt;&gt; change is just persisting the issue. For instance going from nothing
&gt;&gt; straight to a 6-node with a ring-size of 128 would create this problem.
&gt;&gt;
&gt;&gt; As a workaround there is the core claim v3 algorithm which can be turned
&gt;&gt; on, and you can see if this offers a better cluster plan without
&gt;&gt; violations. I can't right now remember how to trigger v3 claim algorithm
&gt;&gt; though - google letting me down.
&gt;&gt;
&gt;&gt; Ultimately, this may not be such a crisis. The error is through whenever
&gt;&gt; the cluster cannot guarantee a "target\_n\_val" of 4. So if you have an
&gt;&gt; n\_val of 3 - you're not necessarily at risk of data loss. To know you
&gt;&gt; will have to look at your ring via riak attach (see bullet point 2 in
&gt;&gt; http://docs.basho.com/riak/kv/2.2.3/using/running-a-clust
&gt;&gt; er/#add-a-second-node-to-your-cluster).
&gt;&gt;
&gt;&gt; If you can figure out the violations from your ring, you may be able to
&gt;&gt; resolve by leaving the node that has the violations, and then re-adding it.
&gt;&gt;
&gt;&gt; Sorry, I'm a bit rushed - but I hope this helps get you started.
&gt;&gt;
&gt;&gt; Martin
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On 14 December 2017 at 19:49, Daniel Miller  wrote:
&gt;&gt;
&gt;&gt;&gt; I have a 6 node cluster (now 7) with ring size 128. On adding the most
&gt;&gt;&gt; recent node I got the WARNING: Not all replicas will be on distinct nodes.
&gt;&gt;&gt; After the initial plan I ran the following sequence many times, but always
&gt;&gt;&gt; got the same plan output:
&gt;&gt;&gt;
&gt;&gt;&gt; sudo riak-admin cluster clear && \
&gt;&gt;&gt; sleep 10 && \
&gt;&gt;&gt; sudo service riak start && \
&gt;&gt;&gt; sudo riak-admin wait-for-service riak\_kv && \
&gt;&gt;&gt; sudo riak-admin cluster join riak@hqriak20.internal && \
&gt;&gt;&gt; sudo riak-admin cluster plan
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; The plan looked the same every time, and I eventually committed it
&gt;&gt;&gt; because the cluster capacity is running low:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Success: staged join request for 'riak@riak29.internal' to
&gt;&gt;&gt; 'riak@riak20.internal'
&gt;&gt;&gt; =============================== Staged Changes
&gt;&gt;&gt; ================================
&gt;&gt;&gt; Action Details(s)
&gt;&gt;&gt; ------------------------------------------------------------
&gt;&gt;&gt; -------------------
&gt;&gt;&gt; join 'riak@riak29.internal'
&gt;&gt;&gt; ------------------------------------------------------------
&gt;&gt;&gt; -------------------
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; NOTE: Applying these changes will result in 1 cluster transition
&gt;&gt;&gt;
&gt;&gt;&gt; ############################################################
&gt;&gt;&gt; ###################
&gt;&gt;&gt; After cluster transition 1/1
&gt;&gt;&gt; ############################################################
&gt;&gt;&gt; ###################
&gt;&gt;&gt;
&gt;&gt;&gt; ================================= Membership
&gt;&gt;&gt; ==================================
&gt;&gt;&gt; Status Ring Pending Node
&gt;&gt;&gt; ------------------------------------------------------------
&gt;&gt;&gt; -------------------
&gt;&gt;&gt; valid 17.2% 14.1% 'riak@riak20.internal'
&gt;&gt;&gt; valid 17.2% 14.8% 'riak@riak21.internal'
&gt;&gt;&gt; valid 16.4% 14.1% 'riak@riak22.internal'
&gt;&gt;&gt; valid 16.4% 14.1% 'riak@riak23.internal'
&gt;&gt;&gt; valid 16.4% 14.1% 'riak@riak24.internal'
&gt;&gt;&gt; valid 16.4% 14.8% 'riak@riak28.internal'
&gt;&gt;&gt; valid 0.0% 14.1% 'riak@riak29.internal'
&gt;&gt;&gt; ------------------------------------------------------------
&gt;&gt;&gt; -------------------
&gt;&gt;&gt; Valid:7 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt;&gt;&gt;
&gt;&gt;&gt; WARNING: Not all replicas will be on distinct nodes
&gt;&gt;&gt;
&gt;&gt;&gt; Transfers resulting from cluster changes: 18
&gt;&gt;&gt; 2 transfers from 'riak@riak28.internal' to 'riak@riak29.internal'
&gt;&gt;&gt; 3 transfers from 'riak@riak21.internal' to 'riak@riak29.internal'
&gt;&gt;&gt; 3 transfers from 'riak@riak23.internal' to 'riak@riak29.internal'
&gt;&gt;&gt; 3 transfers from 'riak@riak24.internal' to 'riak@riak29.internal'
&gt;&gt;&gt; 4 transfers from 'riak@riak20.internal' to 'riak@riak29.internal'
&gt;&gt;&gt; 3 transfers from 'riak@riak22.internal' to 'riak@riak29.internal'
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; My understanding is that if some replicas are not on distinct nodes then
&gt;&gt;&gt; I may have permanent data loss if a single physical node is lost (please
&gt;&gt;&gt; let me know if that is not correct). Questions:
&gt;&gt;&gt;
&gt;&gt;&gt; How do I diagnose which node(s) have duplicate replicas?
&gt;&gt;&gt; What can I do to fix this situation?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks!
&gt;&gt;&gt; Daniel
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; P.S. I am unable to get anything useful out of `riak-admin diag`. It
&gt;&gt;&gt; appears to be broken on the version of Riak I'm using (2.2.1). Here's the
&gt;&gt;&gt; output I get:
&gt;&gt;&gt;
&gt;&gt;&gt; $ sudo riak-admin diag
&gt;&gt;&gt; RPC to 'riak@hqriak20.internal' failed: {'EXIT',
&gt;&gt;&gt; {undef,
&gt;&gt;&gt; [{lager,
&gt;&gt;&gt;
&gt;&gt;&gt; get\_loglevels,
&gt;&gt;&gt; [],[]},
&gt;&gt;&gt;
&gt;&gt;&gt; {riaknostic,run,
&gt;&gt;&gt; 1,
&gt;&gt;&gt; [{file,
&gt;&gt;&gt;
&gt;&gt;&gt; "src/riaknostic.erl"},
&gt;&gt;&gt;
&gt;&gt;&gt; {line,118}]},
&gt;&gt;&gt; {rpc,
&gt;&gt;&gt;
&gt;&gt;&gt; '-handle\_call\_call/6-fun-0-',
&gt;&gt;&gt; 5,
&gt;&gt;&gt; [{file,
&gt;&gt;&gt;
&gt;&gt;&gt; "rpc.erl"},
&gt;&gt;&gt;
&gt;&gt;&gt; {line,205}]}]}}
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; \*\*\*\*\* Email confidentiality notice \*\*\*\*\*
&gt;&gt; This message is private and confidential. If you have received this
&gt;&gt; message in error, please let us know and remove it from your system.
&gt;&gt;
&gt;
&gt;

-- 
\*\*\*\*\* Email confidentiality notice \*\*\*\*\*
This message is private and confidential. If you have received this 
message in error, please let us know and remove it from your system.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

