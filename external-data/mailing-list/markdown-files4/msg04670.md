---
title: "Re: riaksearch 0.14.2 via solr: sort desc"
description: ""
project: community
lastmod: 2011-09-12T08:57:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04670"
mailinglist_parent_id: "msg04669"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-09-12T08:57:08-07:00
---


Sorry, there's a minor error in my JSON - the "arg" key in the last phase
should be quoted.

2011/9/12 Sean Cribbs 

&gt; Pagination can be non-trivial, but this feels like a good fit for secondary
&gt; indexes rather than Search. Note that secondary indexes are only available
&gt; in 1.0 (you can get a prerelease package from downloads.basho.com).
&gt;
&gt; I'd start off with a reduce phase that handles the pagination (since you
&gt; know it's by key, it's easy to do up front), then you can add a map to fetch
&gt; the documents and a final reduce/sort to make sure they are in the original
&gt; order. This isn't exact because I don't know your document structure, but
&gt; here's how you might do that:
&gt;
&gt; {
&gt; "inputs": {
&gt; "bucket": "order",
&gt; "index": "contact\_email\_bin",
&gt; "key": "firstname.lastn...@company.com"
&gt; },
&gt; "query":[
&gt;
&gt; {"reduce":{"language":"erlang","module":"riak\_kv\_mapreduce","function":"reduce\_identity"}},
&gt; {"reduce":{"language":"javascript", "name":"paginateOrders", "arg":
&gt; 1}},
&gt; {"map":{"language":"javascript", "name":"Riak.mapValuesJson"}},
&gt; {"reduce":{"language":"javascript", "name":"Riak.reduceSort",
&gt; "keep":true, arg:"function(a,b){ return a.Order.OrderNumber &gt;
&gt; b.Order.OrderNumber; }"}}
&gt; ]
&gt; }
&gt;
&gt; The first reduce makes sure the keys emitted can be passed to the
&gt; pagination function in Javascript. If you are using Erlang for the function,
&gt; you might not need this. Your paginateOrders function (assuming stored as a
&gt; built-in) would look like this:
&gt;
&gt; function(values, page){
&gt; // Set the page size here, or possibly set as an argument
&gt; var pageSize = 30;
&gt; // Sort on the key, descending.
&gt; values = values.sort(function(a,b){ return parseInt(a[1]) &lt;
&gt; parseInt(b[1]); });
&gt; return values.slice((page - 1) \* pageSize, page \* pageSize);
&gt; }
&gt;
&gt; Note the Riak.reduceSort function can take a comparator function as a
&gt; string arg and will evaluate it and pass it to the Array.sort function.
&gt;
&gt; 2011/9/12 Fredrik Lindström 
&gt;
&gt;&gt; Hi Sean,
&gt;&gt; thank you for the clarification. In our scenario a user might have many
&gt;&gt; orders so it would be nice to be able to page through the result set in
&gt;&gt; descending order.
&gt;&gt; Since our OrderNumbers are guaranteed to be unique we are currently using
&gt;&gt; them as the keys in Riak. They numbers are also created sequentially, hence
&gt;&gt; the desire to page through them in descending order giving the user a
&gt;&gt; chronological perspective of placed orders.
&gt;&gt;
&gt;&gt; We're still quite early in the process of evaluating Riak for our project
&gt;&gt; so we have plenty of time to try other approaches.
&gt;&gt;
&gt;&gt; /F
&gt;&gt; ------------------------------
&gt;&gt; \*From:\* Sean Cribbs [s...@basho.com]
&gt;&gt; \*Sent:\* Monday, September 12, 2011 3:53 PM
&gt;&gt; \*To:\* Fredrik Lindström
&gt;&gt; \*Cc:\* riak-users@lists.basho.com
&gt;&gt; \*Subject:\* Re: riaksearch 0.14.2 via solr: sort desc
&gt;&gt;
&gt;&gt; Fredrik,
&gt;&gt;
&gt;&gt; Unfortunately, because of limitations in Riak Search 0.14.x, it can only
&gt;&gt; (pre-)sort reliably on the document ID. However, it seems like OrderNumber
&gt;&gt; might be a natural ID for this document? If so, you could do something like
&gt;&gt; the following:
&gt;&gt;
&gt;&gt; http://riak/solr/order/select?rows=1&presort=key&q=
&gt;&gt; Order\_Contact\_Email:firstname.lastn...@company.com
&gt;&gt;
&gt;&gt; However, this query will also return in ascending order. If you just want
&gt;&gt; the highest order number, then feeding this query to MapReduce and
&gt;&gt; processing it there would seem appropriate.
&gt;&gt;
&gt;&gt; 2011/9/12 Fredrik Lindström 
&gt;&gt;
&gt;&gt;&gt; Hi everyone,
&gt;&gt;&gt; does the "sort=myfieldname desc" parameter in riaksearch 0.14.2 (via
&gt;&gt;&gt; solr) only sort within the current result set dictated by rows=x and start
&gt;&gt;&gt; =y?
&gt;&gt;&gt;
&gt;&gt;&gt; I can get my search results in the correct ASC order regardless of the
&gt;&gt;&gt; rows and start parameters.
&gt;&gt;&gt; Sorting in DESC with rows=1 and start=0 I get one (obviously) result but
&gt;&gt;&gt; the result actually appears to be in ASC order. The doc returned in the
&gt;&gt;&gt; search result is the one with the lowest integer value in the field used for
&gt;&gt;&gt; sorting.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm quite new to Riak and Riak Search and therefore I assume that the
&gt;&gt;&gt; error is on my part.
&gt;&gt;&gt;
&gt;&gt;&gt; Some technical details:
&gt;&gt;&gt;
&gt;&gt;&gt; Total objects in "order" bucket: 187
&gt;&gt;&gt;
&gt;&gt;&gt; Query with DESC sort:
&gt;&gt;&gt;
&gt;&gt;&gt; http://riak/solr/order/select?rows=1&start=0&sort=Order\_OrderNumber%20desc&q=Order\_Contact\_Email:firstname.lastn...@company.com
&gt;&gt;&gt; Result: 1 doc with Order\_OrderNumber = 362982 (Expected result in my
&gt;&gt;&gt; world of fantasy would be 621738 which is currently the highest value)
&gt;&gt;&gt;
&gt;&gt;&gt; Query with ASC sort:
&gt;&gt;&gt;
&gt;&gt;&gt; http://riak/solr/order/select?rows=1&start=0&sort=Order\_OrderNumber%20asc&q=Order\_Contact\_Email:firstname.lastn...@company.com
&gt;&gt;&gt; Result: 1 doc with Order\_OrderNumber = 362982
&gt;&gt;&gt;
&gt;&gt;&gt; I have a custom schema where I have defined the field I want to sort by
&gt;&gt;&gt; in the following way:
&gt;&gt;&gt; {field, [
&gt;&gt;&gt; {name, "Order\_OrderNumber"},
&gt;&gt;&gt; {type, integer},
&gt;&gt;&gt; {analyzer\_factory, {erlang, text\_analyzers,
&gt;&gt;&gt; integer\_analyzer\_factory}}
&gt;&gt;&gt; ]},
&gt;&gt;&gt;
&gt;&gt;&gt; If I run the DESC query with rows=187 the results are ordered in the
&gt;&gt;&gt; correct descending order.
&gt;&gt;&gt;
&gt;&gt;&gt; /F
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Sean Cribbs 
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://www.basho.com/
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt;


-- 
Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://www.basho.com/
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

