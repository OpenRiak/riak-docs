---
title: "Re: Riak performance problems when LevelDB database grows beyond 16GB"
description: ""
project: community
lastmod: 2012-10-22T09:20:31-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09003"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2012-10-22T09:20:31-07:00
---


Jan,

I apologize for the delayed response.

1. Did you realize that the "log\_jan.txt" file from #1 below documented a hard 
disk failure? You mentioned a failed drive once. I am not sure if this is the 
same drive.


2. The "sse4\_2" tells me that your Intel cpu supports hardware CRC32c 
calculation. This feature is not useful to you at this moment (unless you want 
to pull the mv-hardware-crc branch from basho/leveldb). It will bring some 
performance improvements to you in the next release IF we do not decide that 
your problems are hard disk performance limited.


3. This just confirmed for me that the app.config is not accidentally blowing 
your physical memory. The app.config file you posted suggested this was not 
the case, but I wanted to verify.

You also discuss a basho\_bench failure. Is this the same test run as the 
log\_jan.txt file? The hard drives had their first failure at:

2012/10/18-02:08:44.136238 7f8297fff700 Compaction error: Corruption: corrupted 
compressed block contents

And things go really bad at:

2012/10/18-06:10:37.657072 7f829effd700 Moving corrupted block to 
lost/BLOCKS.bad (size 1647)


4. I was looking to see if your data was compressing well. The answer it that 
it is. You are achieving 2 to 2.6x compression ratio. Since you are concerned 
about throughput, I was verifying that the time leveldb spends on block 
compression is worthwhile for you (it is).


The next question from me is whether the drive / disk array problems are your 
only problem at this point. The data in log\_jan.txt looks ok until the 
failures start. I am willing to work more, but I need to better understand 
your next level of problems.

Matthew


On Oct 19, 2012, at 7:49 AM, 
 wrote:

&gt; Hi Matthew,
&gt; 
&gt; big thanks for responding. I see that you are the main committer to Basho's 
&gt; leveldb code. :-)
&gt; 
&gt;&gt; 1. Execute the following on one of the servers:
&gt;&gt; sort /home/riak/leveldb/\*/LOG\* &gt;log\_jan.txt
&gt; 
&gt; See the attached file log\_jan.txt.gz. It is from the stalled Riak node.
&gt; 
&gt;&gt; 2. Execute the following on one of the servers:
&gt;&gt; grep -i flags /proc/cpuinfo
&gt; 
&gt; flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov 
&gt; pat 
&gt; pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx rdtscp lm 
&gt; constant\_tsc arch\_perfmon pebs bts rep\_good nopl xtopology nonstop\_tsc 
&gt; aperfmperf pni pclmulqdq dtes64 monitor ds\_cpl vmx est tm2 ssse3 cx16 xtpr 
&gt; pdcm pcid sse4\_1 sse4\_2 popcnt tsc\_deadline\_timer xsave avx lahf\_lm arat epb 
&gt; xsaveopt pln pts dtherm tpr\_shadow vnmi flexpriority ept vpid
&gt; 
&gt;&gt; 3. On a running server that is processing data, execute:
&gt;&gt; grep -i swap /proc/meminfo
&gt; 
&gt; I will restart the test and report back when it stalls again. In the meantime,
&gt; am sending you yesterday's zabbix graph showing memory usage on the node 
&gt; (attached file ZabbixMemory.png). The time when the node stopped responding is
&gt; logged as:
&gt; 
&gt; 2012-10-18 08:28:47.537 [error] \*\* Node 'riak@172.16.0.6' not responding \*\*
&gt; 
&gt; I am also attaching the corresponding Basho bench output of the test. The test
&gt; was started on Oct 17 16:38 with an empty database, and it was run on a plain
&gt; ext4 partition (no RAID).
&gt; 
&gt;&gt; 4. Pick a server, then one directory in /home/riak/leveldb. Select 3 of 
&gt; the largest \*.sst files. Tar/gzip those and email back.
&gt; 
&gt; I will send them in the next mail. I can also put the entire database 
&gt; somewhere for you for download, if you need it.
&gt; 
&gt; Thanks, Jan&lt;4Riak\_2K\_2.1RC2\_noraid.png&gt;


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

