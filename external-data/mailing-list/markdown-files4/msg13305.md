---
title: "Re: riak performance"
description: ""
project: community
lastmod: 2013-12-20T02:10:42-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13305"
mailinglist_parent_id: "msg13304"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2013-12-20T02:10:42-08:00
---


Thanks Georgio,

I just noticed that we went off list so I’m copying riak-users back in. I 
always forget to reply-all.

Also realised I never asked, what version of Riak are you running (looks 
1.4.something?)

On 20 Dec 2013, at 10:01, Georgio Pandarez  wrote:

&gt; Hi Russell,
&gt; 
&gt; &gt; What about the drives? Actually, with a single Key you’re probably not 
&gt; &gt; touching the drives at all.
&gt; 
&gt; Just a single SATA disk. I've only got two keys and am testing a single key 
&gt; at a time. 
&gt; 
&gt; &gt; So is there a single HTTP connection? Many? How many? Does it use a pool of 
&gt; &gt; connections that are kept alive, establishing an HTTP connection is pricey. 
&gt; &gt; Is all the load going to one node? Spread across all 5?
&gt; 
&gt; I am using haproxy to load balance requests against the 5 servers. I am using 
&gt; keepalive connections and have tested from 5 connections to 200 connections. 
&gt; After a certain point increasing the connections only increases latency.
&gt; 

That makes sense, there is usually a sweetspot for number of connections. All 
your clients are contending for the same key.

&gt; Looking at the servers, riak is using most of the CPU, I'm not sure what it 
&gt; is doing.
&gt; 
&gt; running riak-admin top from one of the servers shows the below, I've tried 
&gt; disabling riak\_kv\_stat but it still hangs around:

You can’t disable stats in riak 1.4.x which is looks like your using (from the 
inclusion of side job in the etop output)

&gt; 
&gt; Load: cpu 114 Memory: total 90204 binary 
&gt; 672
&gt; procs 670 processes 8103 code 
&gt; 10535
&gt; runq 1 atom 493 ets 
&gt; 30233
&gt; 
&gt; Pid Name or Initial Func Time Reds Memory 
&gt; MsgQ Current Function
&gt; -------------------------------------------------------------------------------------------------------------------------------
&gt; &lt;6210.577.0&gt; proc\_lib:init\_p/5 '-' 7415450 34688 
&gt; 0 gen\_fsm:loop/7 
&gt; &lt;6210.2977.0&gt; proc\_lib:init\_p/5 '-' 761452 2880 
&gt; 1 prim\_file:drv\_get\_response/1 
&gt; &lt;6210.304.0&gt; riak\_kv\_stat\_sj\_1 '-' 371484 3856 
&gt; 0 gen\_server:loop/6 
&gt; &lt;6210.305.0&gt; riak\_kv\_stat\_sj\_2 '-' 363239 3856 
&gt; 0 gen\_server:loop/6 
&gt; &lt;6210.1054.19&gt; proc\_lib:init\_p/5 '-' 125656 34328 
&gt; 0 mochiweb\_http:request/3 
&gt; &lt;6210.753.19&gt; proc\_lib:init\_p/5 '-' 125588 34328 
&gt; 0 mochiweb\_http:request/3 
&gt; &lt;6210.1041.19&gt; proc\_lib:init\_p/5 '-' 125588 34328 
&gt; 0 mochiweb\_http:request/3 
&gt; &lt;6210.1052.19&gt; proc\_lib:init\_p/5 '-' 125588 34328 
&gt; 0 mochiweb\_http:request/3 
&gt; &lt;6210.664.19&gt; proc\_lib:init\_p/5 '-' 124041 21552 
&gt; 0 riak\_client:wait\_for\_reqid/3 
&gt; &lt;6210.694.19&gt; proc\_lib:init\_p/5 '-' 124041 21552 
&gt; 0 riak\_client:wait\_for\_reqid/3 

It doesn’t look like Riak is doing a whole lot at this point. I’ll speak with 
my colleagues when they get online for some more guidance, as I’m not sure what 
numbers you should expect for a single key. Are you going to try with 100s, 
1000s, millions of keys (which is far more common usage)? What is the use case 
that requires you get the same key thousands of times a second?

Cheers

Russell

&gt; 
&gt; 
&gt; 
&gt; On Fri, Dec 20, 2013 at 8:51 PM, Russell Brown  wrote:
&gt; Hi Georgio,
&gt; 
&gt; Thanks for getting back to me.
&gt; 
&gt; On 20 Dec 2013, at 09:23, Georgio Pandarez  wrote:
&gt; 
&gt; &gt; Hi Russell,
&gt; &gt;
&gt; &gt; Thanks for your reply.
&gt; &gt;
&gt; &gt; &gt; Are you getting 2400 reqs a second against a single key?
&gt; &gt;
&gt; &gt; Yes.
&gt; 
&gt; Ah, OK. Well that is OKish for a single key, though I’ve seen better.
&gt; 
&gt; &gt;
&gt; &gt; &gt; What backend are you using?
&gt; &gt;
&gt; &gt; bitcask
&gt; &gt;
&gt; &gt; &gt; What is the spec of the machines?
&gt; &gt;
&gt; &gt; dual core, 4gig, physical, 100mbit between the machines
&gt; 
&gt; What about the drives? Actually, with a single Key you’re probably not 
&gt; touching the drives at all.
&gt; 
&gt; &gt;
&gt; &gt; &gt; Is this perf figure against cs or riak?
&gt; &gt;
&gt; &gt; This perf figure is against riak. I was originally trying riak-cs and 
&gt; &gt; wasn't getting satisfactory performance, so I decided to try directly 
&gt; &gt; against riak.
&gt; &gt;
&gt; &gt; &gt; Have you tried the PB driver?
&gt; &gt;
&gt; &gt; No
&gt; 
&gt; Please do. It should be faster.
&gt; 
&gt; &gt;
&gt; &gt; &gt; What is the ring size?
&gt; &gt;
&gt; &gt; 64
&gt; &gt;
&gt; &gt; &gt; What “requests” are you doing? Are they serial in a loop using CURL or 
&gt; &gt; &gt; parallel using basho\_bench?
&gt; &gt;
&gt; &gt; GET requests using a http performance testing tool like httpress
&gt; 
&gt; So is there a single HTTP connection? Many? How many? Does it use a pool of 
&gt; connections that are kept alive, establishing an HTPP connection is pricey. 
&gt; Is all the load going to one node? Spread across all 5?
&gt; 
&gt; &gt;
&gt; &gt; &gt; Something is wrong, because on my local 3 desktop cluster I can get well 
&gt; &gt; &gt; over 5000ops/sec.
&gt; &gt;
&gt; &gt; Yes, it seems that way. I've been reading docs and watching video's for the 
&gt; &gt; past two weeks, so performance definitely isn't up to expectations.
&gt; 
&gt; Well, usually you spread you’re load over many keys, so get greater 
&gt; performance from parallelism, you also often have many clients, again, better 
&gt; performance from parallelism.
&gt; 
&gt; Let me know some more about the HTTP element as I’ve asked above, please.
&gt; 
&gt; Cheers
&gt; 
&gt; Russell
&gt; 
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri, Dec 20, 2013 at 7:44 PM, Russell Brown  wrote:
&gt; &gt; Hi Georgio,
&gt; &gt;
&gt; &gt; With data that small I doubt there is a difference in perf.
&gt; &gt;
&gt; &gt; Can I get some more info, please?
&gt; &gt;
&gt; &gt; Are you getting 2400 reqs a second against a single key? What backend are 
&gt; &gt; you using? What is the spec of the machines? Are they real or on some 
&gt; &gt; cloud? Network?
&gt; &gt;
&gt; &gt; Is this perf figure against cs or riak? Have you tried the PB driver? What 
&gt; &gt; is the ring size? What “requests” are you doing? Are they serial in a loop 
&gt; &gt; using CURL or parallel using basho\_bench?
&gt; &gt;
&gt; &gt; Something is wrong, because on my local 3 desktop cluster I can get well 
&gt; &gt; over 5000ops/sec.
&gt; &gt;
&gt; &gt; If you can provide more info then we can probably help you get performance 
&gt; &gt; closer to your expectations.
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt;
&gt; &gt; Russell
&gt; &gt;
&gt; &gt;
&gt; &gt; On 20 Dec 2013, at 08:33, Georgio Pandarez  
&gt; &gt; wrote:
&gt; &gt;
&gt; &gt; &gt; Hi Guys,
&gt; &gt; &gt;
&gt; &gt; &gt; I'm still evaluating riak & riak-cs.
&gt; &gt; &gt;
&gt; &gt; &gt; On my five node cluster, with riak only, I am only able to do 2400 
&gt; &gt; &gt; requests per second. I have two keys, one a one byte key, and another a 
&gt; &gt; &gt; 4kb key, the performance doesn't change against either.
&gt; &gt; &gt;
&gt; &gt; &gt; Is this the best that I can expect to get from this, I don't consider 
&gt; &gt; &gt; 2400 rps to be significantly high for 5 machines. I'm testing using the 
&gt; &gt; &gt; http interface.
&gt; &gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt;
&gt; 
&gt; 



signature.asc
Description: Message signed with OpenPGP using GPGMail
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

