---
title: "Re: Deletion followed by re-addition leads to siblings when it	shouldn't"
description: ""
project: community
lastmod: 2012-08-07T11:26:48-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08192"
mailinglist_parent_id: "msg08173"
author_name: "Kaspar Thommen"
project_section: "mailinglistitem"
sent_date: 2012-08-07T11:26:48-07:00
---


Sean,

Thanks for the explanation. I'm still confused, however, because when I
insert a Thread.sleep(5000) before the second call to testBucket.store(...)
then I don't run into the UnresolvedConflictException - looks like the
deletion of the object somehow got 'propagated' through the cluster and is
really gone after those 5 seconds. Is this the case? Why?

Also, how can I check if a sibling that I'm getting back is dead (marked
with a tombstone)?

Thanks,
Kaspar



2012/8/3 Sean Cribbs 

&gt; Kaspar,
&gt;
&gt; Your code creates siblings because:
&gt;
&gt; 1) When a key is deleted, Riak creates a tombstone (with a vector clock)
&gt; that is not reaped from storage immediately.
&gt; 2) When store a new value without correlating it to an old value, it is
&gt; treated as having the "empty" vector clock and creates a sibling.
&gt;
&gt; So in the siblings returned, one should be "deleted" and the other should
&gt; be your new value. You should be able to linearize this sequence by keeping
&gt; around the IRiakObject you fetched in the second step, and issuing the
&gt; delete and second store passing that object or its vector clock. I'm not
&gt; sure how that applies to the Java client, but that is the general strategy
&gt; in these cases.
&gt;
&gt; On Fri, Aug 3, 2012 at 2:48 AM, Kaspar Thommen 
&gt; wrote:
&gt;
&gt;&gt; Anyone please?
&gt;&gt; On Jul 28, 2012 6:59 PM, "Kaspar Thommen" 
&gt;&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; I ran the following Java snippet that creates a bucket, stores a
&gt;&gt;&gt; key/value pair in it, deletes the key, and adds a new value for that same
&gt;&gt;&gt; key. The n-value is 3 and all r- and w-values are also set to 3 to ensure
&gt;&gt;&gt; full consistency (for testing only). Here's the code:
&gt;&gt;&gt;
&gt;&gt;&gt; public static void main(String[] args) throws Exception {
&gt;&gt;&gt; IRiakClient riak = RiakFactory.pbcClient();
&gt;&gt;&gt; try {
&gt;&gt;&gt; // store an object in a new bucket
&gt;&gt;&gt; Bucket testBucket =
&gt;&gt;&gt; riak.createBucket("testBucket").nVal(3).allowSiblings(true).execute();
&gt;&gt;&gt; testBucket.store("key", "value1").w(3).execute();
&gt;&gt;&gt;
&gt;&gt;&gt; System.out.println(testBucket.fetch("key").r(3).execute().getValueAsString());
&gt;&gt;&gt; // prints 'value1'
&gt;&gt;&gt;
&gt;&gt;&gt; // now delete it and store another object with the same key
&gt;&gt;&gt; testBucket.delete("key").r(3).w(3).execute();
&gt;&gt;&gt; testBucket.store("key", "value2").w(3).execute();
&gt;&gt;&gt;
&gt;&gt;&gt; System.out.println(testBucket.fetch("key").r(3).execute().getValueAsString());
&gt;&gt;&gt; // throws 'UnresolvedConflictException: Siblings found'
&gt;&gt;&gt;
&gt;&gt;&gt; } finally {
&gt;&gt;&gt; riak.shutdown();
&gt;&gt;&gt; }
&gt;&gt;&gt; }
&gt;&gt;&gt;
&gt;&gt;&gt; As you can see by the comment I have added to the code fetching the key
&gt;&gt;&gt; a second time should, in my opinion, return the new value, but it fails
&gt;&gt;&gt; because there are siblings. Maybe I didn't fully understand how sibling
&gt;&gt;&gt; handling works, but I don't see how there can possibly be any siblings
&gt;&gt;&gt; given that r and w are 3. Any pointers? I tried the LevelDB and memory
&gt;&gt;&gt; backends, same result.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Kaspar
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

