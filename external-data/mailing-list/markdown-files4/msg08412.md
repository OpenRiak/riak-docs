---
title: "Re: Bad MapReduce job brings the Riak to a screeching halt?"
description: ""
project: community
lastmod: 2012-08-30T15:16:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08412"
mailinglist_parent_id: "msg08397"
author_name: "Kelly McLaughlin"
project_section: "mailinglistitem"
sent_date: 2012-08-30T15:16:28-07:00
---



On Aug 29, 2012, at 9:07 PM, Brad Heller  wrote:
&gt; 
&gt; So my question is: Why did this completely kill Riak? This makes me pretty 
&gt; nervous--a bug in our app has the potential to bring down the ring! Is there 
&gt; anything we can do to protect against this?
&gt; 

Riak 1.2 had a lot of changes to leveldb and one of those was a change to using 
flock() instead of fcntl(SET\_FL) to try and make the locking a bit saner. 
Previously, using fcntl, multiple processes in the erlang VM could get a lock 
to the same leveldb instance and this could obviously lead to some conflicts. 
However, a result of the change to using flock is that when the vnode crashes 
the resources can still be locked by the previous process and this results in 
this message:

 2012-08-29 19:45:41.785 [error] &lt;0.23924.70&gt;@riak\_kv\_vnode:init:265 
Failed to start riak\_kv\_multi\_backend Reason: 
[{riak\_kv\_eleveldb\_backend,{db\_open,"IO error: lock 
../../tmp/riak/instance1/leveldb/0/LOCK: Resource temporarily unavailable"}}]

Currently we do not attempt to wait or retry the vnode restart and this can 
cause the node to crash. I can understand you being a little nervous, but we 
are aware of this and are taking steps on two fronts to address it. First, as 
Bryan mentioned previously, we're looking at fixing these error conditions that 
cause the vnode to crash that really should not do so. Second, we're looking at 
a way to add some retry logic when the vnode does crash and the resources are 
locked. Thanks for the report!

Kelly
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

