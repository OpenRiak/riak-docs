---
title: "Re: Java Client update vs store"
description: ""
project: community
lastmod: 2015-02-27T13:27:49-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15806"
mailinglist_parent_id: "msg15805"
author_name: "Cosmin Marginean"
project_section: "mailinglistitem"
sent_date: 2015-02-27T13:27:49-08:00
---


Thanks Brian, looking forward to the new client.
Thanks for the workaround too!

Cheers
Cos



On Friday, 27 February 2015 at 18:45, Brian Roach wrote:

&gt; This was due to the UpdateValueFuture not checking for the exception
&gt; when the get() methods were called. Just fixed this, it'll be in the
&gt; very-soon-to-be-cut 2.0.1 release.
&gt; 
&gt; https://github.com/basho/riak-java-client/pull/503
&gt; 
&gt; Sync calls are just a wrapper around the async call that calls get() -
&gt; You can currently work around this by calling UpdateValue async:
&gt; 
&gt; RiakFuture future =
&gt; Riakclient.executeAsync(updateOp);
&gt; 
&gt; future.await();
&gt; if (future.isSuccess()) {
&gt; ...
&gt; } else {
&gt; ...
&gt; }
&gt; 
&gt; Thanks,
&gt; - Roach
&gt; 
&gt; On Tue, Feb 3, 2015 at 3:39 PM, Cosmin Marginean  (mailto:cosmin...@gmail.com)&gt; wrote:
&gt; &gt; I have an edge case where consistency is favoured over availability so I’m
&gt; &gt; using a "consistent": true bucket type for a very specific operation.
&gt; &gt; I worked in testing my setup so ended up faking an entire failure by
&gt; &gt; deliberately using an incorrect vClock.
&gt; &gt; 
&gt; &gt; Using StoreValue, the (second) write fails as expected
&gt; &gt; 
&gt; &gt; FetchValue fetchOp = new FetchValue.Builder(location(id)).build();
&gt; &gt; VClock vClock = client.execute(fetchOp).getVectorClock();
&gt; &gt; //fiddle with vClock or allow the first write to finish before the next
&gt; &gt; step
&gt; &gt; StoreValue storeOp = new StoreValue.Builder(value)
&gt; &gt; .withVectorClock(vClock)
&gt; &gt; .withLocation(location(id)).build();
&gt; &gt; StoreValue.Response response = client.execute(storeOp);
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Caused by: com.basho.riak.client.core.netty.RiakResponseException: failed
&gt; &gt; at
&gt; &gt; com.basho.riak.client.core.netty.RiakResponseHandler.channelRead(RiakResponseHandler.java:52)
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.invokeChannelRead(DefaultChannelHandlerContext.java:340)
&gt; &gt; at
&gt; &gt; io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:326)
&gt; &gt; 
&gt; &gt; 
&gt; &gt; I managed to override the UpdateValue class to simulate a similar failure
&gt; &gt; scenario (so I don’t have to do the fetch + store myself). I was expecting a
&gt; &gt; similar result, however, after some analysis I realised that an exception is
&gt; &gt; being swallowed somewhere.
&gt; &gt; I believe the trouble might be around this area:
&gt; &gt; https://github.com/basho/riak-java-client/blob/develop/src/main/java/com/basho/riak/client/api/commands/kv/UpdateValue.java#L581
&gt; &gt; 
&gt; &gt; The exception is not allowed to bubble up to the client code. Additionally,
&gt; &gt; another net effect of this seems to be that a null response is returned here
&gt; &gt; 
&gt; &gt; UpdateValue.Response res = client.execute(updateOp);
&gt; &gt; 
&gt; &gt; So a call to res.wasUpdated() will produce a NPE!
&gt; &gt; 
&gt; &gt; The way I see it, this code needs to either
&gt; &gt; 1) return not-null res and res.wasUpdated() as false
&gt; &gt; or
&gt; &gt; 2) allow the exception to bubble up
&gt; &gt; 
&gt; &gt; Please let me know your thoughts
&gt; &gt; 
&gt; &gt; Thank you
&gt; &gt; Cos
&gt; &gt; 
&gt; &gt; 
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt; 
&gt; 
&gt; 
&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

