---
title: "Re: Deleted keys come back"
description: ""
project: community
lastmod: 2015-10-07T06:21:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16617"
mailinglist_parent_id: "msg16612"
author_name: "Dmitri Zagidulin"
project_section: "mailinglistitem"
sent_date: 2015-10-07T06:21:00-07:00
---


Hello,

There are two things going on here: the W quorum value of the write and
delete operations, and possibly the delete\_mode setting.

Let's walk through the scenario.
You're writing to a 2 node cluster, two copies of each object (n\_val=2),
with your write quorum of 1 (W=1).

So that's possibility #1 -- there's no guarantee that your writes succeed
with both replicas. (It could've just written one, and the other one is
missing).

Then you're doing a List Keys (to delete the objects), which runs with an
implicit quorum of R=1. (Meaning, it only contacts half of the replicas,
and lists them.) So (if possibility #1 happened, above) the list keys could
have not returned some keys, the first time around. (Because it may have
contacted the partitions that had missing replicas). Then you deleted, ran
another List Keys, and that one could have returned the keys that it missed
the first time.

Possibility #2 -- your deletes are using W=1, meaning, they're only waiting
for the delete operation from 1 replica to respond, before returning
success. So, it's possible that a delete operation removed just one
replica, but the second one still exists. And the second List Keys can now
pick up the not-deleted replica.

Possibility #3 -- by default, the delete\_mode is set to keep deleted
objects for 3 seconds. So, if you ran your deletes, and then re-ran a List
Keys before the 3 seconds expired, you could pick up some keys.

The upshot of all this is:
- Use W=2 when writing and deleting. (That is, your W value should be the
same as your N value).

- If that doesn't work, set delete\_mode to 'immediate' in the config.
Specifically, delete\_mode is set in the advanced.config file (
http://docs.basho.com/riak/latest/ops/advanced/configs/configuration-files/#Advanced-Configuration
). So, my advanced.config file looks like this:

[
 {riak\_kv,
 [
 {delete\_mode, immediate}
 ]}
 }
].

Also, if you're deleting things for unit tests, there's an easier way.
Instead of deleting the bucket object-by-object, you can just stop the
node, and clear the bitcask (or leveldb) data directory. (That's going to
get rid of all the data in the cluster, which is what you want to do for
unit tests anyways.)

You can learn more about these topics on the following pages:
\* http://docs.basho.com/riak/latest/ops/advanced/deletion/
\*
http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2011-October/006048.html
(mailing list post introducing delete\_mode)
\* http://basho.com/posts/technical/riaks-config-behaviors-part-3/ (the
Tombstones section)

Dmitri




On Wed, Oct 7, 2015 at 1:35 PM, mtakahashi-ivi 
wrote:

&gt; Hello,
&gt;
&gt; I'm using riak KV in 2 nodes cluster.
&gt; I inserted hundreds of key/value pair and deleted all keys in a bucket.
&gt; After above process, I can get some keys if I get list of keys in the
&gt; bucket.
&gt; Why those keys remain? How do I delete keys reliably?
&gt; If I increase number of nodes to 5 , I can delete all keys in the bucket as
&gt; same way as I did.
&gt; My bucket property is the following.
&gt;
&gt; ----------------------
&gt; {
&gt; "props": {
&gt; "name": "BUCKET\_A",
&gt; "active": true,
&gt; "allow\_mult": false,
&gt; "basic\_quorum": false,
&gt; "big\_vclock": 50,
&gt; "chash\_keyfun": {
&gt; "mod": "riak\_core\_util",
&gt; "fun": "chash\_std\_keyfun"
&gt; },
&gt; "claimant": "riak@172.17.0.171",
&gt; "dvv\_enabled": true,
&gt; "dw": "quorum",
&gt; "last\_write\_wins": false,
&gt; "linkfun": {
&gt; "mod": "riak\_kv\_wm\_link\_walker",
&gt; "fun": "mapreduce\_linkfun"
&gt; },
&gt; "n\_val": 2,
&gt; "notfound\_ok": false,
&gt; "old\_vclock": 86400,
&gt; "postcommit": [],
&gt; "pr": 0,
&gt; "precommit": [],
&gt; "pw": 0,
&gt; "r": 1,
&gt; "rw": "quorum",
&gt; "search\_index": "BUCKET\_A\_INDEX",
&gt; "small\_vclock": 50,
&gt; "w": 1,
&gt; "young\_vclock": 20
&gt; }
&gt; }
&gt;
&gt;
&gt; Masanori Takahashi
&gt;
&gt;
&gt;
&gt; --
&gt; View this message in context:
&gt; http://riak-users.197444.n3.nabble.com/Deleted-keys-come-back-tp4033536.html
&gt; Sent from the Riak Users mailing list archive at Nabble.com.
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

