---
title: "Re: Simultaneous handoff and merge"
description: ""
project: community
lastmod: 2013-04-18T14:16:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg10939"
mailinglist_parent_id: "msg10935"
author_name: "Joe Caswell"
project_section: "mailinglistitem"
sent_date: 2013-04-18T14:16:41-07:00
---


Yuri,

 Bitcask merging is normal, but combined with incoming handoff, it may be
overloading the node.
Two things you might try:
-reduce handoff\_concurrency to 1 on all nodes to reduce the impact of
handoff (http://docs.basho.com/riak/latest/references/Configuration-Files/)
-restrict when Bitcask is allowed to merge by setting the merge\_window on
the node that is being overloaded
(http://docs.basho.com/riak/latest/tutorials/choosing-a-backend/Bitcask/#Con
figuring-Bitcask)

Joe Caswell

From: Yuri Lukyanov 
Date: Thursday, April 18, 2013 5:07 AM
To: "riak-users@lists.basho.com" 
Subject: Simultaneous handoff and merge

Hi,

I have a cluster of 17 riak (1.2.1) nodes with bitcask as a backend.

Recetly one of the node was down for a while. After the node had been
started the cluster started doing handoffs as expected. But then a merge
process also began on the same node. I know this from the log messages like
this:

2013-04-18 08:14:09.061 [info] &lt;0.22952.79&gt; Merged
["/var/lib/riak/bitcask/496682197061674038608283517368424307461195825152"


And then something went wrong (the logs on the same node):


2013-04-18 08:39:22.217 [error] &lt;0.31842.70&gt; Supervisor riak\_core\_vnode\_sup
had child undefined started with {riak\_core\_vnode,start\_link,undefined} at
&lt;0.4000.80&gt; exit with reason
{timeout,{gen\_server,call,[riak\_core\_handoff\_manager,{add\_outbound,riak\_kv\_v
node,208378163135070142634509751539626289911881007104,riak@nsto2r5,&lt;0.4000.8
0&gt;}]}} in context child\_terminated

2013-04-18 08:42:46.067 [error] &lt;0.5154.80&gt; gen\_server &lt;0.5154.80&gt;
terminated with reason:
{timeout,{gen\_server,call,[riak\_core\_handoff\_manager,{add\_inbound,[]}]}}
2013-04-18 08:42:52.790 [error] &lt;0.5154.80&gt; CRASH REPORT Process
riak\_core\_handoff\_listener with 1 neighbours exited with reason:
{timeout,{gen\_server,call,[riak\_core\_handoff\_manager,{add\_inbound,[]}]}} in
gen\_server:terminate/6 line 747
2013-04-18 08:42:53.450 [error] &lt;0.31847.70&gt; Supervisor
riak\_core\_handoff\_listener\_sup had child riak\_core\_handoff\_listener started
with riak\_core\_handoff\_listener:start\_link() at &lt;0.5154.80&gt; exit with reason
{timeout,{gen\_server,call,[riak\_core\_handoff\_manager,{add\_inbound,[]}]}} in
context child\_terminated


The node itself was disappearing from time to time:

# riak-admin ring-status
Node is not running!

The beam process was still running though.

Maybe it's not releated to handoffs & merge. It was just a guess.


Any information and advice on this would be greatly appriciated. It's still
happening right now and I could gather more details if someone wanted me to.

Thanks in advance.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

