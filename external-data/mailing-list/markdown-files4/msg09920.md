---
title: "Differences between riak_client and riak_kv_mrc_pipe MapReduce when	one node is down."
description: ""
project: community
lastmod: 2013-01-30T05:07:15-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09920"
author_name: "gunin"
project_section: "mailinglistitem"
sent_date: 2013-01-30T05:07:15-08:00
---


We have 6 node riak cluster.I simple custom erlang application for custom 
MapReduce job.

We start MapReduce job using riak\_kv\_mrc\_pipe pipe module,for example - 

Query = [{map, {modfun,Mod,MapFun},[do\_prereduce,{from,1}], false},{reduce, 
{modfun,Mod,ReduceFun},[{reduce\_phase\_batch\_size, 1000}], true}],
riak\_kv\_mrc\_pipe:mapred({index,Bucket,Field,From,To},Query,Timeout).

But if one of the node down for along time. Response is unpredictable sometimes 
it's return {ok,GoodResultList}, but sometimes {ok,[]}(empty list).
We trace riak\_kv and riak\_pipe and found too problem:
1. In riak\_kv\_pipe\_index or in riak\_kv\_pipe\_liskeys created fitting\_spec this 
nval always is 1.
2. Actual error is occurred in riak\_pipe\_vnode:remaining\_preflist that retun 
empty PrefList for some Hash(#fitting\_spec.nval is 1). It use 
riak\_core\_apl:get\_primary\_apl function.

But if we use old style map reduce,for example:
 {ok,C} = riak:local\_client(),
 Me = self(),
 Query = [{map, {modfun,Mod,MapFun},[do\_prereduce,{from,1}], 
false},{reduce, {modfun,Mod,ReduceFun},[{reduce\_phase\_batch\_size, 1000}], 
true}],
 {ok, {ReqId,FlowPid}} = C:mapred\_stream(Query,Me,Timeout),
 
{ok,\_}=riak\_kv\_index\_fsm\_sup:start\_index\_fsm(zont\_riak\_connection:riak\_node(), 
[{raw, ReqId,FlowPid}, [Bucket, none,{range,Field,From,To},Timeout,mapred]]),
 luke\_flow:collect\_output(ReqId, Timeout).

Query executed well. But problem is that do\_prereduce and 
{reduce\_phase\_batch\_size, 1000} is ignored,that why execution is slow.


Can you make some recommendation? May be riak\_pipe\_vnode:remaining\_preflist we 
need use riak\_core\_apl:get\_apl\_ann or set #fitting\_spec.nval to nval from out 
Bucket props?

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

