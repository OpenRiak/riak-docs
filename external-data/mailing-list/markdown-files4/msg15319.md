---
title: "Re: Java MR"
description: ""
project: community
lastmod: 2014-12-04T00:28:30-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15319"
mailinglist_parent_id: "msg15299"
author_name: "niedomnie"
project_section: "mailinglistitem"
sent_date: 2014-12-04T00:28:30-08:00
---


I have got no clue why in Groove it does not work.
But in meantime (in Java)
I've got another problem - when running 

I want to achieve HTTP equivalent 
curl -s -X POST -H "Content-Type: application/json"
http://localhost:8098/mapred -d
'{"inputs":{"bucket":["bucket\_type","bucket"],"index":"$key",
"start":"2013",end":"2015"}, "query":[{"map":{"language":"javascript",
"name":"Riak.mapValues"}} ]}'
or 
curl -s -X POST -H "Content-Type: application/json"
http://localhost:8098/mapred -d
'{"inputs":{"bucket":["bucket\_type","bucket"],"index":"\*$key\*",
"key\_filters":[["starts\_with", "2014"]]},
"query":[{"map":{"language":"javascript", "name":"Riak.mapValues"}} ]}'
because both are working (\*second one even if $key is replaced by \$key - I
do not know which one is appropriate?\*) but I think that second one was
achieved by me in java with BucketMapReduce

 MapReduce mr = new IndexMapReduce.Builder()
 .withNamespace(ns)
 .withIndex("$key")
 .withRange(BinaryValue.unsafeCreate(from.getBytes()),
BinaryValue.unsafeCreate(to.getBytes()))
 .withMapPhase(Function.newNamedJsFunction("Riak.mapValues"),
true)
 .build();

I am receiving 

Exception in thread "main" java.util.concurrent.ExecutionException:
java.nio.channels.ClosedChannelException
 at 
com.basho.riak.client.core.FutureOperation.get(FutureOperation.java:260)
 at
com.basho.riak.client.api.commands.CoreFutureAdapter.get(CoreFutureAdapter.java:52)
 at com.basho.riak.client.api.RiakCommand.execute(RiakCommand.java:89)
 at com.basho.riak.client.api.RiakClient.execute(RiakClient.java:293)
 at Riak\_MR\_3M.main(Riak\_MR\_3M.java:57)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at
sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
 at
sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:606)
 at com.intellij.rt.execution.application.AppMain.main(AppMain.java:134)
Caused by: java.nio.channels.ClosedChannelException

or 

Exception in thread "main" java.util.concurrent.ExecutionException:
com.basho.riak.client.core.netty.RiakResponseException: Error processing
incoming message: error:function\_clause:[{riak\_index,
 parse\_binary,
 [{struct,
 [{&lt;&lt;"value"&gt;&gt;,
 
&lt;&lt;"MjAxMzExMDRfMDkwNTIwLjU3Ni4w"&gt;&gt;}]}],
 [{file,
 
"src/riak\_index.erl"},
 {line,543}]},
 {riak\_index,
 parse\_field,3,
 [{file,
 
"src/riak\_index.erl"},
 {line,192}]},
 {riak\_index,
 
'-parse\_fields/1-fun-0-',
 3,
 [{file,
 
"src/riak\_index.erl"},
 {line,158}]},
 {lists,foldl,3,
 
[{file,"lists.erl"},
 {line,1248}]},
 {riak\_index,
 parse\_fields,1,
 [{file,
 
"src/riak\_index.erl"},
 {line,167}]},
 
{riak\_kv\_mapred\_json,
 
parse\_index\_input,
 1,
 [{file,
 
"src/riak\_kv\_mapred\_json.erl"},
 {line,238}]},
 
{riak\_kv\_mapred\_json,
 parse\_request,1,
 [{file,
 
"src/riak\_kv\_mapred\_json.erl"},
 {line,55}]},
 
{riak\_kv\_pb\_mapred,
 decode,2,
 [{file,
 
"src/riak\_kv\_pb\_mapred.erl"},
 {line,70}]}]

but this is working fine

MapReduce mr = new BucketMapReduce.Builder()
 .withNamespace(ns)
 .withKeyFilter(new BetweenFilter(from, to))
 
.withRange(BinaryValue.unsafeCreate(from.getBytes()),
BinaryValue.unsafeCreate(to.getBytes()))
 
.withMapPhase(Function.newNamedJsFunction("Riak.mapValues"), true)
 .build();
 
so maybe this is not proper index (for main primary key I have used $key)
so I've change it to index (index\_name) - it is only my quest what kind of
index it is (I do not want to use solr/search - I only wanted to use
secondary\_index - 2i, and the most I want to use primary index which is
named $key)

 MapReduce mr = new IndexMapReduce.Builder()
 .withNamespace(ns)
 .withIndex("index\_name")
 .withRange(BinaryValue.unsafeCreate(from.getBytes()),
BinaryValue.unsafeCreate(to.getBytes()))
 .withMapPhase(Function.newNamedJsFunction("Riak.mapValues"),
true)
 .build();

and bucket has got search\_index defined
{
 "props": {
 .....
 "search\_index": "index\_name",
 ....
 }
}

and entries were added with 
// 
riakObject.getIndexes().getIndex(LongIntIndex.named("index\_name")).add(System.currentTimeMillis());
StoreValue store = new StoreValue.Builder(ro).withLocation(new Location(ns,
key)).build();
StoreValue.Response response = client.execute(store);

I am receiving 

Exception in thread "main" java.util.concurrent.ExecutionException:
com.basho.riak.client.core.netty.RiakResponseException:
{inputs,[{unknown\_field\_type,&lt;&lt;"index\_name"&gt;&gt;}]}
 at 
com.basho.riak.client.core.FutureOperation.get(FutureOperation.java:260)
 at
com.basho.riak.client.api.commands.CoreFutureAdapter.get(CoreFutureAdapter.java:52)
 at com.basho.riak.client.api.RiakCommand.execute(RiakCommand.java:89)
 at com.basho.riak.client.api.RiakClient.execute(RiakClient.java:293)

what am I doing wrong?



--
View this message in context: 
http://riak-users.197444.n3.nabble.com/Java-MR-tp4032117p4032227.html
Sent from the Riak Users mailing list archive at Nabble.com.

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

