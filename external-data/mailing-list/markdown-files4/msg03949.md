---
title: "Re: Map/Red Function Cache Corruption?"
description: ""
project: community
lastmod: 2011-07-06T18:25:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03949"
mailinglist_parent_id: "msg03925"
author_name: "Eric Stevens"
project_section: "mailinglistitem"
sent_date: 2011-07-06T18:25:22-07:00
---


Yep, our sysadmin admitted he's behind on upgrades, we'll get it upgraded
and see if that solves the problem. Thanks Mathias!

On Tue, Jul 5, 2011 at 3:05 AM, Mathias Meyer  wrote:

&gt; Eric,
&gt;
&gt; are you by any chance still running Riak 0.14.1? There was a bug showing
&gt; the same symptoms you're describing, which was fixed in the recent 0.14.2
&gt; release.
&gt;
&gt; Mathias Meyer
&gt; Developer Advocate, Basho Technologies
&gt;
&gt;
&gt; On Samstag, 2. Juli 2011 at 14:40, Eric Stevens wrote:
&gt;
&gt; &gt; I've been struggling with this for a few days now. I have a pair of
&gt; related Map/Reduce queries. Executed individually they produce the expected
&gt; results, but when executed in parallel (simultaneous XHR calls from the
&gt; browser), their results tend to get mixed up with each other; I see values
&gt; from both mixed together in a single result.
&gt; &gt;
&gt; &gt; Once that corruption happens, even the calls executed individually can
&gt; end up with cross-pollinated results. It seems to be related to the caching
&gt; of the anonymous javascript functions used, as adding a space to the
&gt; function declaration clears the issue up. Taking that space back out causes
&gt; the problem again.
&gt; &gt;
&gt; &gt; I can confirm that the corruption can become persistent by using a line
&gt; such as (PHP client):
&gt; &gt; ejsLog('/tmp/mapred/reduce\_" . join('.', explode('\\', get\_class($this)))
&gt; . ".log', JSON.stringify(values));
&gt; &gt;
&gt; &gt; After the corruption happens, if I clear the log path, execute just the
&gt; one map/red operation, I will see log entries appear for both classes (the
&gt; class name being encoded as part of the function declaration). The problem
&gt; seems to happen for both map and reduce operations, though I have not
&gt; specifically noticed cross-contamination between map and reduce functions,
&gt; just map-for-map and reduce-for-reduce.
&gt; &gt;
&gt; &gt; Adding this as the first line of the function declaration seems to solve
&gt; the problem, but this is obviously something intended to defeat caching, so
&gt; I'm sure there's a performance cost to this (note, just get\_class($this) is
&gt; not sufficient, cross-contamination can still happen, each call needs to be
&gt; unique call-to-call, thus the mt\_rand()).
&gt; &gt; "//".get\_class($this).' '.mt\_rand()."
&gt; &gt;
&gt; &gt;
&gt; &gt; I noticed Francisco Treacy had this same problem back in September:
&gt; http://riak-users.197444.n3.nabble.com/reduce-headaches-td1524860.html but
&gt; I didn't see any resolution there. Is there a potential longer term cost to
&gt; my cachebusting, such as memory exhaustion (i.e. is there any garbage
&gt; collection on the function cache)?
&gt; &gt;
&gt; &gt; Any help would be sincerely appreciated!
&gt; &gt;
&gt; &gt; -Eric
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

