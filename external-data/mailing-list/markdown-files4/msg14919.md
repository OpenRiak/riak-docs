---
title: "Re: Brokenness specific to nginx and jets3t with Riak CS"
description: ""
project: community
lastmod: 2014-09-25T00:43:46-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14919"
mailinglist_parent_id: "msg14918"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2014-09-25T00:43:46-07:00
---


Following up further again, with a solution.

Turns out that Nginx canonicalises the URLs when proxying them, if and
only if, the proxy\_pass parameter includes a path component, including
a plain slash.
Meanwhile, Jets3t URL-encodes the object path so that slashes become
%2F, but Nginx converts them to actual slashes before forwarding to
Riak CS.

Fix was to change
proxy\_pass http://upstreamservers/;
to
proxy\_pass http://upstreamservers;

-Toby

On 25 September 2014 16:24, Toby Corkindale  wrote:
&gt; Quite update to mention that by removing some extra (unneeded) custom
&gt; headers from the proxy configuration and fiddling with some other
&gt; nginx options, I'm at a point where Riak CS throws an actual error
&gt; back rather than disconnecting prematurely.
&gt; The error now returned is below. I'm wondering if something else nginx
&gt; is doing is causing the request to get mangled enough that it doesn't
&gt; work.. but hard to tell what, or why :/
&gt;
&gt; ResponseCode: 403, ResponseStatus: Forbidden, XML Error Message: xml
 version=\"1.0\"
&gt; encoding=\"UTF-8\"?&gt;`AccessDenied`Access
&gt; Denied/upload-service/da417126-8651-4be5-b552-6d125bb7b27c/coreos\_production\_ami\_hvm.txt
&gt;
&gt;
&gt; On 25 September 2014 15:59, Toby Corkindale  wrote:
&gt;&gt; Hi,
&gt;&gt; I've hit an issue that only seems to occur when using the Jets3t
&gt;&gt; client library and Nginx as a load balancer in front of Riak CS.
&gt;&gt; The issue is NOT present when using other S3 libraries, nor is it
&gt;&gt; present if I switch out Nginx for haproxy.
&gt;&gt;
&gt;&gt; Unfortunately, in this instance it is desirable to use both, unless it
&gt;&gt; turns out to be \*really\* troublesome.
&gt;&gt; I wondered if anyone here can offer advice?
&gt;&gt;
&gt;&gt; The problem is that reads and writes to objects results in Riak CS,
&gt;&gt; apparently, disconnecting the client prematurely.
&gt;&gt; Nginx reports "connection reset by peer" and retries upstream Riak CS
&gt;&gt; servers several times before giving up.
&gt;&gt; The Riak CS access logs indicate what look like valid URLs, with a 403
&gt;&gt; status indicated.
&gt;&gt;
&gt;&gt;
&gt;&gt; Accessing the same buckets with the same auth and transferring the
&gt;&gt; same files is fine when done with s3cmd, and we have other apps that
&gt;&gt; have been running through nginx for a while using other S3 client
&gt;&gt; libraries.
&gt;&gt;
&gt;&gt; A simple "check if bucket exists" command through jets3t seems to work OK.
&gt;&gt;
&gt;&gt; Any thoughts on what could be going on, or is this all just a bit too vague?
&gt;&gt;
&gt;&gt; Toby
&gt;
&gt;
&gt;
&gt; --
&gt; Turning and turning in the widening gyre
&gt; The falcon cannot hear the falconer
&gt; Things fall apart; the center cannot hold
&gt; Mere anarchy is loosed upon the world



-- 
Turning and turning in the widening gyre
The falcon cannot hear the falconer
Things fall apart; the center cannot hold
Mere anarchy is loosed upon the world

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

