---
title: "Re: Runaway \"Failed to compact\" errors"
description: ""
project: community
lastmod: 2013-11-24T15:04:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13083"
mailinglist_parent_id: "msg13082"
author_name: "Justin Long"
project_section: "mailinglistitem"
sent_date: 2013-11-24T15:04:23-08:00
---


Interesting, as I mentioned previously any objects in the “collector” buckets 
all share the same structure. It is trying to index a field that is actually 
inside a String. “data\_followers” is a key inside the “data” map and the value 
for that key is escaped JSON (it goes into offline processing FYI later). And 
as you can see there isn’t any indexing set for that field.


On Nov 24, 2013, at 2:56 PM, Joe Caswell  wrote:

&gt; Justin,
&gt; 
&gt; The binary in the log entry below equates to:
&gt; {&lt;&lt;"collector-collect-twitter"&gt;&gt;,&lt;&lt;"data\_followers"&gt;&gt;,&lt;&lt;32897-byte string&gt;&gt;}
&gt; 
&gt; Hope this helps.
&gt; 
&gt; Joe
&gt; From: Justin Long 
&gt; Date: Sunday, November 24, 2013 5:17 PM
&gt; To: Joe Caswell 
&gt; Cc: Richard Shaw , riak-users 
&gt; Subject: Re: Runaway "Failed to compact" errors
&gt; 
&gt; Thanks Joe. I would agree that would probably be the problem. I am concerned 
&gt; since none of the fields of objects I am storing in Riak would produce a key 
&gt; larger than 32kb. Here’s a sample Scala (Java-based) POJO that represents an 
&gt; object in the problem bucket using the Riak-Java-Client:
&gt; 
&gt; case class InstagramCache(
&gt; @(JsonProperty@field)("identityId")
&gt; @(RiakKey@field)
&gt; val identityId: String, // ID of user on social network
&gt; 
&gt; @(JsonProperty@field)("userId")
&gt; @(RiakIndex@field)(name = "userId")
&gt; val userId: String, // associated user ID on platform
&gt; 
&gt; @(JsonProperty@field)("data")
&gt; val data: Map[String, Option[String]],
&gt; 
&gt; @(JsonProperty@field)("updated")
&gt; var updated: Date
&gt; 
&gt; )
&gt; 
&gt; The fields identityId and userId would rarely exceed 30 characters. Is Riak 
&gt; trying to index the whole object?
&gt; 
&gt; Thanks
&gt; 
&gt; 
&gt; 
&gt; On Nov 24, 2013, at 2:11 PM, Joe Caswell  wrote:
&gt; 
&gt;&gt; Justin,
&gt;&gt; 
&gt;&gt; The terms being stored in merge index are too large. The maximum size for an 
&gt;&gt; {Index, Field, Term} key is 32k bytes.
&gt;&gt; The binary blob in your log entry represents a tuple that was 32952 bytes. 
&gt;&gt; Since merge index uses a 15-bit integer to store term size, if the 
&gt;&gt; term\_to\_binary of the given key is larger than 32767, high bits are lost, 
&gt;&gt; effectively storing ( mod 32767) bytes.
&gt;&gt; When this data is read back, binary\_to\_term is unable to reconstruct the key 
&gt;&gt; due the missing bytes, and throws a badarg exception.
&gt;&gt; 
&gt;&gt; Search index repair is document here: 
&gt;&gt; http://docs.basho.com/riak/1.4.0/cookbooks/Repairing-Search-Indexes/ 
&gt;&gt; However, you would need to first modify your extractor to not produce 
&gt;&gt; search keys larger than 32k or the corruption issues will recur.
&gt;&gt; 
&gt;&gt; Joe Caswell
&gt;&gt; 
&gt;&gt; 
&gt;&gt; From: Richard Shaw 
&gt;&gt; Date: Sunday, November 24, 2013 4:25 PM
&gt;&gt; To: Justin Long 
&gt;&gt; Cc: riak-users 
&gt;&gt; Subject: Re: Runaway "Failed to compact" errors

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

