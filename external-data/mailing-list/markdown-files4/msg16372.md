---
title: "Re: Monitoring protobuffs and CPU usage on a Riak KV cluster"
description: ""
project: community
lastmod: 2015-08-06T07:42:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16372"
mailinglist_parent_id: "msg16369"
author_name: "Sean Kelly"
project_section: "mailinglistitem"
sent_date: 2015-08-06T07:42:07-07:00
---


Because it's important to note, the version of Riak is 2.0.5.

AAE was actually the first thing I checked - it was on, but turning it off
had no impact.

Interestingly enough, I was able to pinpoint the source of the higher than
expected CPU to a service that was frequently polling a set of map and set
CRDTs from Riak once every second (which does not really seem all that
frequent) to keep up with any changes that may have occurred since the last
time it cached the information in process.

I'm trying to get some time to look more into if we're doing something dumb
in our service (always possible) or if there are settings for these CRDTs
that we're not making proper use of in Riak itself.

For now, I've tuned down the polling frequency for the test environment
(which for some reason was higher than the production environment), and the
problem appears to have gone away. We didn't seem to see any noticeable
rise or fall in the CPU utilization of the service itself, just in Riak

If anyone has any insights into poor performance with the map / set CRDT
types (maps and sets, and maps containing sets), any input would be welcome
to help hunt down why that seemed to be such a issue.

On Thu, Aug 6, 2015 at 8:19 AM, Matthew Von-Maszewski 
wrote:

&gt; Two ideas about lots of cpu with nothing happening:
&gt;
&gt; - is Riak entropy setting "active". Weekly it will rebuild hash trees
&gt;
&gt; - does this activity occur after a handoff? Sometimes leveldb needs time
&gt; to catch up afterward in current releases (fix coming soon).
&gt;
&gt; Matthew
&gt;
&gt; Sent from my iPad
&gt;
&gt; &gt; On Aug 5, 2015, at 7:16 PM, Matthew Brender  wrote:
&gt; &gt;
&gt; &gt; Hey all, I'm practicing what I preach and asking a question to others
&gt; &gt; here. A community member pinged me with a couple questions:
&gt; &gt;
&gt; &gt; "I'm looking into an issue with Riak on our test environment (we
&gt; &gt; basically let devs spin up a copy of our prod stack on a giant box in
&gt; &gt; ec2).
&gt; &gt;
&gt; &gt; We've gotten some complaints that riak seems to be using a lot of CPU,
&gt; &gt; even when "nothing" is happening (something is always happening with
&gt; &gt; the # of apps and services on the box, even when no one is poking it).
&gt; &gt;
&gt; &gt; Is there a way to turn on an "access" log, so I could see what
&gt; &gt; requests are being made against riak, to try and correlate with? It
&gt; &gt; would have to be able to tell me about pbuffs usage, not just http."
&gt; &gt;
&gt; &gt; Could anyone help with these questions. I see a couple separate ones:
&gt; &gt;
&gt; &gt; 1. How to monitor what is causing higher CPU usage on a Riak cluster
&gt; &gt; 2. How to view an access log of protobuff and http requests, or just
&gt; &gt; the \*most helpful\* counters for them
&gt; &gt;
&gt; &gt; I know a ton of statistics are visible [1] through riak-admin, but I'd
&gt; &gt; like to hear what others recommend in particular.
&gt; &gt;
&gt; &gt; [1] http://docs.basho.com/riak/latest/ops/running/stats-and-monitoring/
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; Matt Brender | Developer Advocacy Lead
&gt; &gt; Basho Technologies
&gt; &gt; t: @mjbrender
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

