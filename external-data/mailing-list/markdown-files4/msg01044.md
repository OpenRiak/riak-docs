---
title: "Using Erlang funs for map reduce via the REST API and protocol	buffers client"
description: ""
project: community
lastmod: 2010-09-06T20:57:20-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01044"
author_name: "Seth Falcon"
project_section: "mailinglistitem"
sent_date: 2010-09-06T20:57:20-07:00
---


Hi all,

I think it would be convenient to be able to specify map and reduce
query phase operations as Erlang funs when using the Erlang protocol
buffer client and when interacting with Riak via its REST API. Such a
feature would be useful during development and for exploratory queries
when the data in Riak is stored using Erlang's native serialization
format (term\_to\_binary). The advantage over {M, F, A} is that you
don't have to get (new) code loaded into each node in your cluster to
execute an Erlang-based query.

Serializing funs for execution on remote nodes in Erlang is fraught
with subtlety -- certainly not all funs can be used in this fashion.
An alternative is to specify the source for a fun as a string and
evaluate it on a remote node to obtain a fun -- just as is done for
Javascript functions specified in the REST API.

As an experiment, I put together a patch for riak\_kv that adds a new
FunTerm type for a Query:

%%- {strfun, Fun} : Fun is a string (list or binary)
%% containing the definition of an anonymous
%% Erlang function.


With these changes (code link below), you can do the following using
the pb client:

Mapper = "fun(G, \_X, \_Y) -&gt;
 O = riak\_object:get\_value(G),
 [proplists:get\_value(blah, O)]
 end.".

riakc\_pb\_socket:mapred(Pid, Input, [{map, {strfun, Mapper}, unset, true}]).

Along similar lines, the changes allow Erlang funs to be specified in
the REST API:

{"reduce":{"language":"erlang",
 "source":"
fun(ValueList, \_Arg) -&gt;
 [lists:foldl(fun erlang:'+'/2, 0, ValueList)]
end.",
"keep":true}}


If there is interest, I'd be willing to cleanup/enhance the patch for
inclusion. I wanted to get some feedback before spending any more
time on it -- perhaps there are other issues with this approach that
I'm not aware of or a more elegant solution...

BTW, the inspiration for the approach came from this post by the
Erjang developer:
http://www.javalimit.com/2010/05/passing-funs-to-other-erlang-nodes.html

The code is here: http://github.com/seth/riak\_kv


+ seth

-- 
Seth Falcon | @sfalcon | http://userprimary.net/

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

