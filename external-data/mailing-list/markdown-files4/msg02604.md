---
title: "Re: Inconsistent map/reduce results"
description: ""
project: community
lastmod: 2011-03-10T14:57:09-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02604"
mailinglist_parent_id: "msg02603"
author_name: "Grant Schofield"
project_section: "mailinglistitem"
sent_date: 2011-03-10T14:57:09-08:00
---


There are currently some bugs in the mapreduce caching system. The best thing 
to do would be to disable the feature, on 0.13 you can do this by editing or 
adding the vnode\_cache\_entries to the riak\_kv section of your app.config. The 
entry would look like:
{vnode\_cache\_entries, 0},

Grant Schofield
Developer Advocate 
Basho Technologies

On Mar 10, 2011, at 4:16 PM, Keith Dreibelbis wrote:

&gt; Hi riak-users,
&gt; 
&gt; I'm trying to do a map/reduce query from java on a 0.13 server, and get 
&gt; inconsistent results. What I'm doing should be pretty simple. I'm hoping 
&gt; someone will notice an obvious error in here, or have some insight:
&gt; 
&gt; This is an automated test. I'm doing a simple query where I'm trying to get 
&gt; the keys for records with a certain field value. In SQL it would look like 
&gt; "SELECT id FROM table WHERE age = '32'". In java I'm invoking it like this:
&gt; 
&gt; MapReduceResponse r = riak.mapReduceOverBucket(getBucket())
&gt; .map(JavascriptFunction.anon(func), true)
&gt; .submit();
&gt; 
&gt; where riak is a RiakClient, getBucket() returns the name of the bucket, and 
&gt; func is a string that looks like:
&gt; 
&gt; function(value, keyData, arg) {
&gt; var data = Riak.mapValuesJson(value)[0];
&gt; if(data.age == "32")
&gt; return [value.key];
&gt; else
&gt; return [];
&gt; }
&gt; 
&gt; No reduce phase. All entries in the example bucket are json and have an age 
&gt; field. This initially works correctly, it gets back the matching records as 
&gt; expected. It also works in curl. It's an automated test, so each time I run 
&gt; this, it is using a different bucket. After about a dozen queries, this 
&gt; starts to fail. It returns an empty result, when it should have found 
&gt; records. It fails in curl at the same time.
&gt; 
&gt; I initially suspected this might have something to do with doing map reduce 
&gt; too soon after writing, and the write not being available on all nodes. 
&gt; However, I changed the bucket schema entries for w,r,rw,dw from "quorum" to 
&gt; "all", and this still happens (is there another bucket setting I missed?). In 
&gt; addition, I only have 3 nodes (I'm using the dev123 example), and am running 
&gt; curl long enough afterwards.
&gt; 
&gt; Here's the strange part that makes me suspicious. If I make insignificant 
&gt; changes to the query, for example change the double quotes to single quotes, 
&gt; add whitespace or extra parentheses, etc, then it suddenly works again. It 
&gt; will work on an existing bucket, and on subsequent tests, but again only 
&gt; about a dozen times before it starts failing again. Same behavior in curl. 
&gt; This makes me suspect that the server is doing some incorrect caching around 
&gt; this js function, based on the function string.
&gt; 
&gt; Any explanation about what's going on?
&gt; 
&gt; 
&gt; Keith
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

