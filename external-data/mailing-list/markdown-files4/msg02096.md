---
title: "Re: riak_kv_multi_backend + custom backend"
description: ""
project: community
lastmod: 2011-01-24T11:15:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02096"
mailinglist_parent_id: "msg02094"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-01-24T11:15:57-08:00
---


Anthony,

Default bucket properties are defined in riak\_core, not riak\_kv, so you can't 
really set the hash function as a result of setting something else. 
Furthermore, you really only have to set these once, so you could configure 
your application to check the bucket props on startup and set them 
appropriately.

"backend" is a property only used by the multi\_backend (which isn't used that 
frequently), so it seems a little presumptuous to special-case that property 
(turning it into an atom). There are a few other technical reasons that you 
don't want to arbitrarily turn binaries into atoms. I agree that it's not 
especially intuitive but I think it's a small point of pain, especially if we 
fix the documentation.

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On Jan 24, 2011, at 2:01 PM, Anthony Molinaro wrote:

&gt; Sean,
&gt; 
&gt; I'll fork and submit a pull request sometime soon. Will things continue
&gt; to be configured with binaries, or will it switch to atoms at some point?
&gt; 
&gt; Also, Is there a way to configure specific buckets in the config, or to
&gt; specify default bucket properties for a particular bucket type in the config?
&gt; I see there is default\_bucket\_props, and you can have bucket specific
&gt; properties, but what I would want is some way to have a custom bucket type
&gt; which would require the hash function be different. This doesn't seem like
&gt; bucket specific config (ie, config passed to start/2), but instead feels like
&gt; per bucket type default config. I think I can work around it by specifyng
&gt; it at the same time I specify the custom backend. Like
&gt; 
&gt; curl -X PUT -H "content-type: application/json" -d 
&gt; '{"props":{"backend":"my\_backend"},"chash\_keyfun":{"mod":"my\_backend","fun":"my\_hash"}}'
&gt; http://127.0.0.1:8098/riak/mybucket
&gt; 
&gt; but this feels risky, as it would be easy for someone to miss.
&gt; 
&gt; I'd prefer being able to set that in default bucket props for a particular
&gt; backend. That seems cleaner, and less error-prone.
&gt; 
&gt; Anyway, if it doesn't work in this way, any reason it couldn't?
&gt; 
&gt; -Anthony
&gt; 
&gt; On Mon, Jan 24, 2011 at 08:57:26AM -0500, Sean Cribbs wrote:
&gt;&gt; Anthony,
&gt;&gt; 
&gt;&gt; Thanks for noticing that documentation error. If you would, please file an 
&gt;&gt; issue on the wiki's issue tracker: https://github.com/basho/riak\_wiki/issues 
&gt;&gt; and we'll get it corrected. If you're feeling enterprising, you can also 
&gt;&gt; fork, fix and send a pull-request for the page.
&gt;&gt; 
&gt;&gt; Sean Cribbs 
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://basho.com/
&gt;&gt; 
&gt;&gt; On Jan 24, 2011, at 2:43 AM, Anthony Molinaro wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi Sean,
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks, that seems to work. Should the wiki be changed? Currently
&gt;&gt;&gt; this page
&gt;&gt;&gt; 
&gt;&gt;&gt; http://wiki.basho.com/Configuration-Files.html
&gt;&gt;&gt; 
&gt;&gt;&gt; has
&gt;&gt;&gt; 
&gt;&gt;&gt; multi\_backend: list of backends to provide
&gt;&gt;&gt; Format of each backend specification is {BackendName, BackendModule,
&gt;&gt;&gt; BackendConfig}, where BackendName is any atom, BackendModule is the name of
&gt;&gt;&gt; the Erlang module implementing the backend (the same values you would
&gt;&gt;&gt; provide as "storage\_backend" settings), and BackendConfig is
&gt;&gt;&gt; a parameter that will be passed to the "start/2" function of the backend
&gt;&gt;&gt; module.
&gt;&gt;&gt; 
&gt;&gt;&gt; and it sounds like BackendName has to be a binary.
&gt;&gt;&gt; 
&gt;&gt;&gt; Also, it has
&gt;&gt;&gt; 
&gt;&gt;&gt; Specify the backend to use for a bucket with
&gt;&gt;&gt; riak\_client:set\_bucket(BucketName,[{backend, BackendName}] in Erlang 
&gt;&gt;&gt; 
&gt;&gt;&gt; but I'm a little unclear how you would invoke this call, do you attach
&gt;&gt;&gt; with riak attach, then run the command there? Because when I try that
&gt;&gt;&gt; I get
&gt;&gt;&gt; 
&gt;&gt;&gt; \*\* exception error: undefined function riak\_client:set\_bucket/2
&gt;&gt;&gt; 
&gt;&gt;&gt; Seems there might be a riak\_client:set\_bucket/3, so that documentation may
&gt;&gt;&gt; be out of date as well.
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; 
&gt;&gt;&gt; -Anthony
&gt;&gt;&gt; 
&gt;&gt;&gt; On Sun, Jan 23, 2011 at 02:50:32PM -0500, Sean Cribbs wrote:
&gt;&gt;&gt;&gt; Anthony,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; This is something I discovered a while back - define your backend names as 
&gt;&gt;&gt;&gt; binaries and you'll be able to set them properly from the REST interface. 
&gt;&gt;&gt;&gt; Example:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {storage\_backend, riak\_kv\_multi\_backend},
&gt;&gt;&gt;&gt; {multi\_backend\_default, &lt;&lt;"bitcask"&gt;&gt;},
&gt;&gt;&gt;&gt; {multi\_backend,
&gt;&gt;&gt;&gt; [ {&lt;&lt;"bitcask"&gt;&gt;, riak\_kv\_bitcask\_backend,
&gt;&gt;&gt;&gt; [{data\_root, "/var/lib/riak/bitcask"}]},
&gt;&gt;&gt;&gt; {&lt;&lt;"dets"&gt;&gt;, riak\_kv\_dets\_backend,
&gt;&gt;&gt;&gt; [{riak\_kv\_dets\_backend\_root, "/var/lib/riak/dets"}]},
&gt;&gt;&gt;&gt; {&lt;&lt;"ets"&gt;&gt;, riak\_kv\_ets\_backend, []},
&gt;&gt;&gt;&gt; {&lt;&lt;"fs"&gt;&gt;, riak\_kv\_fs\_backend,
&gt;&gt;&gt;&gt; [{riak\_kv\_fs\_backend\_root, "/var/lib/riak/fs"}]},
&gt;&gt;&gt;&gt; {&lt;&lt;"cache"&gt;&gt;, riak\_kv\_cache\_backend,
&gt;&gt;&gt;&gt; [ {riak\_kv\_cache\_backend\_memory, 100},
&gt;&gt;&gt;&gt; {riak\_kv\_cache\_backend\_ttl, 600},
&gt;&gt;&gt;&gt; {riak\_kv\_cache\_backend\_max\_ttl, 3600}
&gt;&gt;&gt;&gt; ]},
&gt;&gt;&gt;&gt; {&lt;&lt;"my\_backend"&gt;&gt;, my\_backend, []}
&gt;&gt;&gt;&gt; ]},
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Then you can set it like so
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; curl -X PUT -H "content-type: application/json" -d 
&gt;&gt;&gt;&gt; '{"props":{"backend":"my\_backend"}}' http://127.0.0.1:8098/riak/mybucket
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Also note that only allow\_mult and n\_val are supported bucket properties 
&gt;&gt;&gt;&gt; from the PB interface (something we'll be fixing soon).
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Jan 23, 2011, at 12:37 PM, Anthony Molinaro wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; So I wanted to play around with creating a custom backend, and using
&gt;&gt;&gt;&gt;&gt; the multi backend, but I am having problems getting anything to work.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Here's what I tried so far
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; in app.config
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; {storage\_backend, riak\_kv\_multi\_backend},
&gt;&gt;&gt;&gt;&gt; {multi\_backend\_default, bitcask},
&gt;&gt;&gt;&gt;&gt; {multi\_backend,
&gt;&gt;&gt;&gt;&gt; [ {bitcask, riak\_kv\_bitcask\_backend,
&gt;&gt;&gt;&gt;&gt; [{data\_root, "/var/lib/riak/bitcask"}]},
&gt;&gt;&gt;&gt;&gt; {dets, riak\_kv\_dets\_backend,
&gt;&gt;&gt;&gt;&gt; [{riak\_kv\_dets\_backend\_root, "/var/lib/riak/dets"}]},
&gt;&gt;&gt;&gt;&gt; {ets, riak\_kv\_ets\_backend, []},
&gt;&gt;&gt;&gt;&gt; {fs, riak\_kv\_fs\_backend,
&gt;&gt;&gt;&gt;&gt; [{riak\_kv\_fs\_backend\_root, "/var/lib/riak/fs"}]},
&gt;&gt;&gt;&gt;&gt; {cache, riak\_kv\_cache\_backend,
&gt;&gt;&gt;&gt;&gt; [ {riak\_kv\_cache\_backend\_memory, 100},
&gt;&gt;&gt;&gt;&gt; {riak\_kv\_cache\_backend\_ttl, 600},
&gt;&gt;&gt;&gt;&gt; {riak\_kv\_cache\_backend\_max\_ttl, 3600}
&gt;&gt;&gt;&gt;&gt; ]},
&gt;&gt;&gt;&gt;&gt; {my\_backend, my\_backend, []}
&gt;&gt;&gt;&gt;&gt; ]},
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Then I restart, open a shell and do the following
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 1&gt; {ok, Pid} = riakc\_pb\_socket:start\_link("127.0.0.1", 8087).
&gt;&gt;&gt;&gt;&gt; {ok,&lt;0.68.0&gt;}
&gt;&gt;&gt;&gt;&gt; 2&gt; riakc\_pb\_socket:set\_bucket(Pid, &lt;&lt;"b"&gt;&gt;, [{backend, my\_backend}]).
&gt;&gt;&gt;&gt;&gt; ok
&gt;&gt;&gt;&gt;&gt; 3&gt; riakc\_pb\_socket:get\_bucket(Pid,&lt;&lt;"b"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; {ok,[{n\_val,3},{allow\_mult,false}]}
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; So I didn't see my backend there, thus tried the REST API
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; curl 'http://127.0.0.1:8098/riak/b' ; echo 
&gt;&gt;&gt;&gt;&gt; {"props":{"name":"b","n\_val":3,"allow\_mult":false,"last\_write\_wins":false,"precommit":[],"postcommit":[],"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"old\_vclock":86400,"young\_vclock":20,"big\_vclock":50,"small\_vclock":10,"r":"quorum","w":"quorum","dw":"quorum","rw":"quorum"}}
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; It's not there either. So I try to set it with REST
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; curl -X PUT -H "Content-Type: application/json" -d 
&gt;&gt;&gt;&gt;&gt;&gt; '{"props":{"backend":"my\_backend"}}' http://127.0.0.1:8098/riak/b
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Which works, in that now I have
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; curl 'http://127.0.0.1:8098/riak/b' ; 
&gt;&gt;&gt;&gt;&gt;&gt; echo{"props":{"backend":"my\_backend","name":"b","n\_val":3,"allow\_mult":false,"last\_write\_wins":false,"precommit":[],"postcommit":[],"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"old\_vclock":86400,"young\_vclock":20,"big\_vclock":50,"small\_vclock":10,"r":"quorum","w":"quorum","dw":"quorum","rw":"quorum"}}
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; However, in the shell I still get
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 4&gt; riakc\_pb\_socket:get\_bucket(Pid,&lt;&lt;"b"&gt;&gt;).
&gt;&gt;&gt;&gt;&gt; {ok,[{n\_val,3},{allow\_mult,false}]}
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Also, if I attempt to put something I get
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 5&gt; riakc\_pb\_socket:put(Pid, riakc\_obj:new (&lt;&lt;"b"&gt;&gt;, &lt;&lt;"c"&gt;&gt;, &lt;&lt;"d"&gt;&gt;)).
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; =ERROR REPORT==== 19-Jan-2011::02:21:04 ===
&gt;&gt;&gt;&gt;&gt; \*\* Generic server &lt;0.68.0&gt; terminating 
&gt;&gt;&gt;&gt;&gt; \*\* Last message in was {req\_timeout,#Ref&lt;0.0.0.186&gt;}
&gt;&gt;&gt;&gt;&gt; \*\* When Server state == {state,"127.0.0.1",8087,false,false,undefined,
&gt;&gt;&gt;&gt;&gt; undefined,
&gt;&gt;&gt;&gt;&gt; {[],[]},
&gt;&gt;&gt;&gt;&gt; 1,[],infinity,100}
&gt;&gt;&gt;&gt;&gt; \*\* Reason for termination == 
&gt;&gt;&gt;&gt;&gt; \*\* disconnected
&gt;&gt;&gt;&gt;&gt; \*\* exception exit: disconnected
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; =CRASH REPORT==== 19-Jan-2011::02:21:04 ===
&gt;&gt;&gt;&gt;&gt; crasher:
&gt;&gt;&gt;&gt;&gt; initial call: riakc\_pb\_socket:init/1
&gt;&gt;&gt;&gt;&gt; pid: &lt;0.68.0&gt;
&gt;&gt;&gt;&gt;&gt; registered\_name: []
&gt;&gt;&gt;&gt;&gt; exception exit: disconnected
&gt;&gt;&gt;&gt;&gt; in function gen\_server:terminate/6
&gt;&gt;&gt;&gt;&gt; ancestors: [&lt;0.65.0&gt;]
&gt;&gt;&gt;&gt;&gt; messages: [{tcp,#Port&lt;0.816&gt;,
&gt;&gt;&gt;&gt;&gt; [0|&lt;&lt;10,7,116,105,109,101,111,117,116,16,1&gt;&gt;]}]
&gt;&gt;&gt;&gt;&gt; links: [&lt;0.65.0&gt;]
&gt;&gt;&gt;&gt;&gt; dictionary: []
&gt;&gt;&gt;&gt;&gt; trap\_exit: false
&gt;&gt;&gt;&gt;&gt; status: running
&gt;&gt;&gt;&gt;&gt; heap\_size: 987
&gt;&gt;&gt;&gt;&gt; stack\_size: 24
&gt;&gt;&gt;&gt;&gt; reductions: 1541
&gt;&gt;&gt;&gt;&gt; neighbours:
&gt;&gt;&gt;&gt;&gt; neighbour: [{pid,&lt;0.65.0&gt;},
&gt;&gt;&gt;&gt;&gt; {registered\_name,[]},
&gt;&gt;&gt;&gt;&gt; {initial\_call,{erlang,apply,2}},
&gt;&gt;&gt;&gt;&gt; {current\_function,{gen,do\_call,4}},
&gt;&gt;&gt;&gt;&gt; {ancestors,[]},
&gt;&gt;&gt;&gt;&gt; {messages,[{#Ref&lt;0.0.0.185&gt;,{error,timeout}}]},
&gt;&gt;&gt;&gt;&gt; {links,[&lt;0.25.0&gt;,&lt;0.68.0&gt;]},
&gt;&gt;&gt;&gt;&gt; {dictionary,[]},
&gt;&gt;&gt;&gt;&gt; {trap\_exit,false},
&gt;&gt;&gt;&gt;&gt; {status,runnable},
&gt;&gt;&gt;&gt;&gt; {heap\_size,1597},
&gt;&gt;&gt;&gt;&gt; {stack\_size,38},
&gt;&gt;&gt;&gt;&gt; {reductions,17388}]
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; And the attached sasl log which has many errors. So I'm trying to figure 
&gt;&gt;&gt;&gt;&gt; out
&gt;&gt;&gt;&gt;&gt; whether the problem is configuration, or a bug or what, and wondering if 
&gt;&gt;&gt;&gt;&gt; any
&gt;&gt;&gt;&gt;&gt; one else has gotten a custom backend, or multi backend to work?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I'm using 0.14 on Centos 5, using the basho RPM.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; -Anthony
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt;&gt; ------------------------------------------------------------------------
&gt;&gt;&gt;&gt;&gt; Anthony Molinaro 
&gt;&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; -- 
&gt;&gt;&gt; ------------------------------------------------------------------------
&gt;&gt;&gt; Anthony Molinaro 
&gt;&gt; 
&gt; 
&gt; -- 
&gt; ------------------------------------------------------------------------
&gt; Anthony Molinaro 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

