---
title: "Re: Deleting data from LevelDB backend"
description: ""
project: community
lastmod: 2013-09-26T14:11:39-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12418"
mailinglist_parent_id: "msg12415"
author_name: "Simon Effenberg"
project_section: "mailinglistitem"
sent_date: 2013-09-26T14:11:39-07:00
---


Thanks Matthew..

but to clarify..

1. remove big .sst files
2. trigger repair through
 https://gist.github.com/gburd/b88aee6da7fee81dc036
3. wait for AAE or do a repair by hand with
 http://docs.basho.com/riak/1.3.1/cookbooks/Repairing-KV-Indexes/ to
get all missing (because deleted) keys?

Is this true what I'm saying?

Cheers
Simon

On Thu, 26 Sep 2013 15:06:10 +0200
Matthew Von-Maszewski  wrote:

&gt; Simon,
&gt; 
&gt; I queried Basho's Client Services group. They use the following as the 
&gt; guideline for leveldb vnode (database) repair:
&gt; 
&gt; https://gist.github.com/gburd/b88aee6da7fee81dc036
&gt; 
&gt; This repair sequence is different than the one you are quoting.
&gt; 
&gt; 
&gt; You do not need to manually delete the MANIFEST file. The repair sequence 
&gt; will do that anyway.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; On Sep 26, 2013, at 7:04 AM, Simon Effenberg  
&gt; wrote:
&gt; 
&gt; &gt; Are we talking about
&gt; &gt; http://docs.basho.com/riak/1.3.1/cookbooks/Repairing-KV-Indexes/ ?
&gt; &gt; 
&gt; &gt; and if yes.. is this also doing a repair if data is missing? So after
&gt; &gt; executing the "repair" on one node.. will it have afterwards:
&gt; &gt; 
&gt; &gt; \* all keys it should have (like if AAE is fixing stuff through Read
&gt; &gt; Repair)
&gt; &gt; \* all 2i indices it should have (like the documentation suggest)
&gt; &gt; 
&gt; &gt; So does it mean a "compaction" is triggered by doing:
&gt; &gt; 
&gt; &gt; \* remove big sst files
&gt; &gt; \* trigger this REPAIR type "Repairing-KV-Indexes"?
&gt; &gt; 
&gt; &gt; will this automatically fix the MANIFESTS file?
&gt; &gt; 
&gt; &gt; Cheers
&gt; &gt; Simon
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Thu, 26 Sep 2013 12:53:40 +0200
&gt; &gt; Simon Effenberg  wrote:
&gt; &gt; 
&gt; &gt;&gt; Thanks Matthew,
&gt; &gt;&gt; 
&gt; &gt;&gt; but one thing I didn't get. If I delete a sst file.. should I delete
&gt; &gt;&gt; (by hand) the MANIFEST file to trigger a repair or is it done
&gt; &gt;&gt; automatically within Riak if it detects that a sst file which is
&gt; &gt;&gt; referenced in the MANIFEST is missing?
&gt; &gt;&gt; 
&gt; &gt;&gt; Cheers
&gt; &gt;&gt; Simon
&gt; &gt;&gt; 
&gt; &gt;&gt; On Wed, 25 Sep 2013 09:58:51 -0400
&gt; &gt;&gt; Matthew Von-Maszewski  wrote:
&gt; &gt;&gt; 
&gt; &gt;&gt;&gt; Simon,
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; I want to point out again that I do not like my answer … but currently 
&gt; &gt;&gt;&gt; lack a better one. The manual delete of .sst files should be treated as 
&gt; &gt;&gt;&gt; a last resort. Only do it if you really, really cannot wait for normal 
&gt; &gt;&gt;&gt; compactions to purge the old data.
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; To your question:
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; leveldb keeps a list of .sst table files in its MANIFEST file. If the 
&gt; &gt;&gt;&gt; .sst table files are deleted manually, the MANIFEST is no longer 
&gt; &gt;&gt;&gt; accurate. An inaccurate MANIFEST file leads to leveldb internal errors 
&gt; &gt;&gt;&gt; and sometimes infinite loops.
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; The repair process erases the current MANIFEST file and builds a new one 
&gt; &gt;&gt;&gt; based upon the files actually found on disk.
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; WARNING: repair takes a really, really long time in Riak 1.2.0 … it gets 
&gt; &gt;&gt;&gt; better in 1.2.1 … and improves to something quite reasonable by 1.3 and 
&gt; &gt;&gt;&gt; 1.4.
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; A discussion about repair can be found here:
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; https://github.com/basho/leveldb/wiki/repair-notes
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; Matthew
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; On Sep 25, 2013, at 9:38 AM, Simon Effenberg  
&gt; &gt;&gt;&gt; wrote:
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; On Wed, 25 Sep 2013 09:15:33 -0400
&gt; &gt;&gt;&gt;&gt; Matthew Von-Maszewski  wrote:
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt;&gt; - run Riak repair on the vnode so that leveldb can create a MANIFEST 
&gt; &gt;&gt;&gt;&gt;&gt; that matches the files remaining.
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; what do you mean with this? Wait for AAE? Request each key to trigger
&gt; &gt;&gt;&gt;&gt; read repair or do I miss something?
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; We are in a similar situation.. only sst\_4 exists in our situation but
&gt; &gt;&gt;&gt;&gt; we also delete old stuff regularly..
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; Cheers
&gt; &gt;&gt;&gt;&gt; Simon 
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt; 
&gt; &gt;&gt; 
&gt; &gt;&gt; -- 
&gt; &gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; &gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt; &gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt; &gt;&gt; 
&gt; &gt;&gt; Mail: seffenb...@team.mobile.de
&gt; &gt;&gt; Web: www.mobile.de
&gt; &gt;&gt; 
&gt; &gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; &gt;&gt; 
&gt; &gt;&gt; 
&gt; &gt;&gt; Geschäftsführer: Malte Krüger
&gt; &gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; &gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; &gt;&gt; 
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt; 
&gt; &gt; 
&gt; &gt; -- 
&gt; &gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; &gt; Fon: + 49-(0)30-8109 - 7173
&gt; &gt; Fax: + 49-(0)30-8109 - 7131
&gt; &gt; 
&gt; &gt; Mail: seffenb...@team.mobile.de
&gt; &gt; Web: www.mobile.de
&gt; &gt; 
&gt; &gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Geschäftsführer: Malte Krüger
&gt; &gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; &gt; Sitz der Gesellschaft: Kleinmachnow 
&gt; &gt; 
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 


-- 
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon: + 49-(0)30-8109 - 7173
Fax: + 49-(0)30-8109 - 7131

Mail: seffenb...@team.mobile.de
Web: www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

