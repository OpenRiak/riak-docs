---
title: "Re: Strange MapReduce behavior"
description: ""
project: community
lastmod: 2011-10-26T13:18:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05325"
mailinglist_parent_id: "msg05323"
author_name: "Bryan Fink"
project_section: "mailinglistitem"
sent_date: 2011-10-26T13:18:32-07:00
---


On Wed, Oct 26, 2011 at 2:53 PM, Elias Levy  wrote:
&gt; For instance:
&gt;
&gt; mr = Riak::MapReduce.new(riak)
&gt; mr.add('bucket', 'key')
&gt; mr.reduce("function(v) { return [] }", :keep =&gt; true))
&gt; This returns:
&gt; {"bucket"=&gt;"key"}

I believe this one is explainable by a known Riak 1.0 MapReduce bug:

https://issues.basho.com/show\_bug.cgi?id=1185

If you check your Riak log, I bet you'll see an error message, and if
the final run of a reduce fails, then in Riak 1.0.[0,1] the reduce
phase sends on its [possibly unreduced] inputs, instead of failing. I
hope to fix this soon.

&gt; Doing instead:
&gt; mr = Riak::MapReduce.new(riak)
&gt; mr.add('bucket', 'key')
&gt; mr.reduce("riak\_kv\_mapreduce:reduce\_identity", :language =&gt; "erlang")
&gt; mr.reduce("function(v) { return [] }", :keep =&gt; true))
&gt; results in the same output.

This, I'm unable to explain, unless the syntax for calling
riak\_kv\_mapreduce:reduce\_identity is incorrect in your example (I'm
unfamiliar with Ripple's API). If I submit what I think is the
equivalent query directly over HTTP or the Erlang console, I see the
result come back as []. If the given syntax is incorrect, then it's
likely generating another error that is causing the same behavior as
described in Bugzilla issue 1185.

&gt; Can't a reduce phase appear before a map phase?

A reduce phase \*can\* appear before a map phase, but not if the reduce
phase is implemented in Javascript and the inputs are bucket-key
pairs. Unfortunately, bucket-key pairs are represented as tuples that
are not correctly converted to JSON, so evaluation of the phase fails.
 The typical workaround is as you attempted in your second example:
using riak\_kv\_mapreduce:reduce\_identity to alter the representation of
bucket-key pairs (or implementing the reduce phase in Erlang instead).

-Bryan

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

