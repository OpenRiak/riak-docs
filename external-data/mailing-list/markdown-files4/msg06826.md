---
title: "Re: basho_metrics re-entrant?"
description: ""
project: community
lastmod: 2012-03-01T11:52:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06826"
mailinglist_parent_id: "msg06790"
author_name: "Joel Meyer"
project_section: "mailinglistitem"
sent_date: 2012-03-01T11:52:23-08:00
---


On Wed, Feb 29, 2012 at 2:58 PM, Bob Ippolito  wrote:

&gt; I don't believe that you'll be able to store these NIF instances in
&gt; mochiglobal. You can only store things that can be represented as BEAM code.
&gt;

Ah, you're right. I tested putting and getting, but I didn't test calling
the nif with the result of getting, which fails with a bad argument
exception.

Eshell V5.8.4 (abort with ^G)
1&gt; {ok, Stat} = basho\_metrics\_nifs:histogram\_new().
{ok,&lt;&lt;&gt;&gt;}
2&gt; mochiglobal:put(stat,Stat).
ok
3&gt; MGStat = mochiglobal:get(stat).
&lt;&lt;&gt;&gt;
4&gt; basho\_metrics\_nifs:histogram\_stats(MGStat).
\*\* exception error: bad argument
 in function basho\_metrics\_nifs:histogram\_stats/1
 called as basho\_metrics\_nifs:histogram\_stats(&lt;&lt;&gt;&gt;)
5&gt;

It looks like storing the refs in an ets table works, so I'll try that.

Thanks,
Joel


&gt;
&gt; On Wed, Feb 29, 2012 at 2:46 PM, Joel Meyer  wrote:
&gt;
&gt;&gt; Hello,
&gt;&gt;
&gt;&gt; I'd like to capture statistics on all calls to my riak\_core service and
&gt;&gt; the execution time of vnode commands. I looked at folsom\_metrics, but for a
&gt;&gt; service that does 10-30k QPS I'm concerned about the overhead introduced of
&gt;&gt; doing ets calls. Given that, my current plan was to create several
&gt;&gt; basho\_metrics on startup and store the opaque refs using mochiglobal. Then
&gt;&gt; my service will make module calls to update the metrics. Will using
&gt;&gt; basho\_metrics in that matter cause problems?
&gt;&gt;
&gt;&gt; Here's what I'm thinking:
&gt;&gt;
&gt;&gt; -module(freqserver\_stats).
&gt;&gt;
&gt;&gt; -export([ init/0,
&gt;&gt; vnode\_count/1,
&gt;&gt; ... ]).
&gt;&gt;
&gt;&gt; -define( VNODE\_COUNT, freqserver\_stats\_vnode\_count ).
&gt;&gt;
&gt;&gt;
&gt;&gt; ...
&gt;&gt;
&gt;&gt; -define( METRICS,
&gt;&gt; [ { ?VNODE\_COUNT, histogram },
&gt;&gt; ... ] ).
&gt;&gt;
&gt;&gt; -define( STAT(Name), mochiglobal:get(Name) ).
&gt;&gt;
&gt;&gt; init() -&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; F = fun( { S, Type } , \_ ) -&gt;
&gt;&gt; Ref = case Type of
&gt;&gt; histogram -&gt; basho\_metrics\_nifs:histogram\_new();
&gt;&gt; meter -&gt; basho\_metrics\_nifs:meter\_new()
&gt;&gt; end,
&gt;&gt; ok = mochiglobal:put( S, Ref )
&gt;&gt; end,
&gt;&gt; lists:foldl( F, [], ?METRICS ).
&gt;&gt;
&gt;&gt; vnode\_count( Micros ) -&gt;
&gt;&gt; basho\_metrics\_nifs:histogram\_update( ?STAT( ?VNODE\_COUNT ), Micros ).
&gt;&gt;
&gt;&gt; I'm also open to better ideas, if people have them. I'm concerned about
&gt;&gt; back pressure and/or overflowing the message queue if I dedicate a process
&gt;&gt; to handling these statistics. Let me know if I'm needlessly concerned about
&gt;&gt; that.
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Joel
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

