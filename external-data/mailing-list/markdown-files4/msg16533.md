---
title: "Re: How to fix an stale index situation after a bitcask data restore"
description: ""
project: community
lastmod: 2015-09-16T02:24:07-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16533"
mailinglist_parent_id: "msg16385"
author_name: "Magnus Kessler"
project_section: "mailinglistitem"
sent_date: 2015-09-16T02:24:07-07:00
---


On 7 August 2015 at 18:47, Hao  wrote:

&gt; Single node with search=on, I previously indexed 2 map objects. Then I did
&gt; a restore of my previous bitcask folder. I can see newly created bucket
&gt; type still there. And when I search by index, the index data are also
&gt; there. So I removed the index folder (under
&gt; /var/lib/riak/yz/todoriak\_main\_movie\_idx/data ) , riak should start to
&gt; index anew. But it turned out, no.The index folder was re-created by Riak
&gt; though.
&gt;
&gt; When I search by index, I still see the old 2 map objects. And when I add
&gt; new objects, they are not indexed at all. Always the old 2 map objects only.
&gt;
&gt; I thought AAE will fix index. No? Is the AAE only for cluster?
&gt; What can I do now? Delete index and re-create? What's the business of
&gt; re-attach?
&gt;
&gt; Thank you
&gt; -Hao
&gt;

Hi Hao,

Riak's search AAE should eventually re-index your data. However, by default
AAE trees are rebuilt only once a week, and then only one tree is rebuilt
per hour on each node. It is possible to speed this up, though.

On one node, run 'riak attach'. Then, at the Erlang console run

riak\_core\_util:rpc\_every\_member\_ann(application, set\_env, [riak\_kv,
anti\_entropy\_build\_limit, {4, 3600000}], 60).
riak\_core\_util:rpc\_every\_member\_ann(application, set\_env, [riak\_kv,
anti\_entropy\_concurrency, 4], 60).
riak\_core\_util:rpc\_every\_member\_ann(application, set\_env, [yokozuna,
anti\_entropy\_build\_limit, {4, 3600000}], 60).
riak\_core\_util:rpc\_every\_member\_ann(application, set\_env, [yokozuna,
anti\_entropy\_concurrency, 4], 60).

The above will allow concurrent rebuilding of up to 4 trees per node per
hour. Be careful not to increase this too much on production systems. To
force expiration of the search AAE trees you can then run in the Erlang
console

riak\_core\_util:rpc\_every\_member\_ann(yz\_entropy\_mgr, expire\_trees, [], 60).

Hope this helps.

Regards,

Magnus


-- 
Magnus Kessler
Client Services Engineer @ Basho

Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

