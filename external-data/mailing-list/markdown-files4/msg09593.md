---
title: "Re: \"Bad message code\" error from Java ProtoBuf client?"
description: ""
project: community
lastmod: 2012-12-14T19:51:11-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09593"
mailinglist_parent_id: "msg09592"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2012-12-14T19:51:11-08:00
---


Tim,

Right - I understood the call that was failing was a "get" (Sorry - I
sent a second email because when I answered originally I transposed
the messages).

The underlying reason for it is that somewhere, you're doing a list
keys operation but not iterating through them all. This isn't your
fault; it's a bug. That shouldn't be a problem.

I was able to reproduce the issue and just pushed a branch / created a
pull request:

https://github.com/basho/riak-java-client/pull/186

It is intermittent because of the specific set of conditions that have
to be met for it to occur. For the time being if you find where you're
not iterating through all the returned keys and do so, the error
should stop occurring. I've been working through testing some
branches and merging things, I hope to release this new 1.0.7 version
of the client next week.

Thanks,
Brian Roach

On Fri, Dec 14, 2012 at 8:08 PM, Tim W  wrote:
&gt; Brian!
&gt;
&gt; In this particular case, the failing call is requesting a single key. And
&gt; it didn't just happen once -- rather, for quite a while, every single one of
&gt; these calls (login) would fail in this manner, repeatedly. Then, the next
&gt; day... \*poof\*... working again.
&gt;
&gt; Rather odd...
&gt;
&gt; - Tim
&gt;
&gt;
&gt; On 12/14/12 3:43 PM, Brian Roach wrote:
&gt;&gt;
&gt;&gt; Sorry - dyslexia acting up:
&gt;&gt;
&gt;&gt; That should read that you received a "list keys" response when
&gt;&gt; expecting a "get" response.
&gt;&gt;
&gt;&gt; - Roach
&gt;&gt;
&gt;&gt; On Fri, Dec 14, 2012 at 3:40 PM, Brian Roach  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Tim -
&gt;&gt;&gt;
&gt;&gt;&gt; That error is generated when the original, underlying protocol buffers
&gt;&gt;&gt; Riak client gets the wrong protobuf message from the socket - as in,
&gt;&gt;&gt; not the one it's expecting.
&gt;&gt;&gt;
&gt;&gt;&gt; The codes are here:
&gt;&gt;&gt; http://docs.basho.com/riak/latest/references/apis/protocol-buffers/
&gt;&gt;&gt;
&gt;&gt;&gt; The code numbers you list basically say that you got a "get" response
&gt;&gt;&gt; message when expecting a "list keys" response method.
&gt;&gt;&gt;
&gt;&gt;&gt; I'm digging into this to see how that would happen (I have an idea)
&gt;&gt;&gt; but by any chance are you listing keys and then not iterating through
&gt;&gt;&gt; the entire set?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Brian Roach
&gt;&gt;&gt;
&gt;&gt;&gt; On Fri, Dec 14, 2012 at 2:55 PM, Tim W  wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'm seeing the following message emitted from a query to Riak:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; com.basho.riak.client.RiakRetryFailedException: java.io.IOException: bad
&gt;&gt;&gt;&gt; message code. Expected: 10 actual: 18
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.client.cap.DefaultRetrier.attempt(DefaultRetrier.java:79)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.client.cap.DefaultRetrier.attempt(DefaultRetrier.java:81)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.client.cap.DefaultRetrier.attempt(DefaultRetrier.java:81)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.client.cap.DefaultRetrier.attempt(DefaultRetrier.java:81)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'm also seeing this a bit further down in the log:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Caused by: java.io.IOException: bad message code. Expected: 10 actual:
&gt;&gt;&gt;&gt; 18
&gt;&gt;&gt;&gt; at com.basho.riak.pbc.RiakConnection.receive(RiakConnection.java:126)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.pbc.RiakClient.processFetchReply(RiakClient.java:278)
&gt;&gt;&gt;&gt; at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:252)
&gt;&gt;&gt;&gt; at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:241)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.fetch(PBClientAdapter.java:156)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; com.basho.riak.client.operations.FetchObject$1.call(FetchObject.java:102)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; com.basho.riak.client.operations.FetchObject$1.call(FetchObject.java:100)
&gt;&gt;&gt;&gt; at
&gt;&gt;&gt;&gt; com.basho.riak.client.cap.DefaultRetrier.attempt(DefaultRetrier.java:72)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; This crops up periodically, during different operations, and disappears
&gt;&gt;&gt;&gt; just
&gt;&gt;&gt;&gt; as mysteriously.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Any hint as to what this really means? (For example, is there somewhere
&gt;&gt;&gt;&gt; I
&gt;&gt;&gt;&gt; can look up these error codes?)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; For the record, I'm running Riak 1.1.4 with Java client 1.0.5.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Thanks in advance!
&gt;&gt;&gt;&gt; - Tim
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

