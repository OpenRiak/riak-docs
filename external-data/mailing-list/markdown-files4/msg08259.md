---
title: "Re: multi-get (yet again)"
description: ""
project: community
lastmod: 2012-08-10T07:31:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08259"
mailinglist_parent_id: "msg08258"
author_name: "Parnell Springmeyer"
project_section: "mailinglistitem"
sent_date: 2012-08-10T07:31:34-07:00
---


I'm interested in this, I'll fork the repo and see what I can get added in 
there.

On Aug 10, 2012, at 7:52 AM, Bryan Fink wrote:

&gt; On Thu, Aug 9, 2012 at 5:11 AM, Kresten Krab Thorup  wrote:
&gt;&gt; The only issue with this approach is AFAIK that M/R effectively runs with 
&gt;&gt; R=1, i.e. it doesn't ensure that a value is consistent across replicas.
&gt;&gt; 
&gt;&gt; IMHO riak\_kv\_mapreduce should have a map\_get\_object\_value, which does a 
&gt;&gt; proper RiakClient:get, i.e. something like this: [will be slower, but will 
&gt;&gt; honour the bucket's default R value].
&gt; 
&gt; I recently realized that this would be a fairly small and easy thing
&gt; to do since MR has been ported to Riak Pipe. I'm frying other fish at
&gt; the moment, but if any of your are interested, read on.
&gt; 
&gt; In Riak Pipe, an MR "map" phase is broken into two steps: "get" and
&gt; "transform". The "get" phase is what reads the value from Riak. It is
&gt; currently implemented in riak\_kv\_pipe\_get, in the riak\_kv application.
&gt; 
&gt; If you read riak\_kv\_pipe\_get.erl, you'll see that all of the fetching
&gt; logic is in the process/3 function. Modifying this code to do a
&gt; regular riak\_client:get instead of talking directly to a single vnode
&gt; should be easy.
&gt; 
&gt; We would like to keep the existing implementation as the default, at
&gt; least for now. So, my suggestion would be to add the new behavior as
&gt; an option, with flags to control it. This could be accomplished either
&gt; by modifying riak\_kv\_pipe\_get to look for a flag in its argument, or
&gt; by modifying riak\_kv\_mrc\_pipe to use a new fitting instead of
&gt; riak\_kv\_pipe\_get.
&gt; 
&gt; With either modification, you'll want to also change riak\_kv\_mrc\_pipe
&gt; to pass the map arguments through to the "get" fitting. These
&gt; arguments are the only place available to external clients to specify
&gt; any of the R-value tuning parameters. Yes, that means a map function
&gt; implementation will have to ignore them, but hopefully that's not
&gt; insurmountable. See the reduce\_batch\_size and reduce\_phase\_only\_1
&gt; optional "reduce" phase arguments for examples on how to do this.
&gt; 
&gt; There are probably other ways to fit this kind of fetching behavior in
&gt; as well. While Kresten's map-function implementation is good, I think
&gt; this behavior is useful in more cases than resolving a
&gt; notfound. Hopefully what I've written above is enough to get one or
&gt; more of you started down a path.
&gt; 
&gt; Cheers,
&gt; Bryan
&gt; 
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com



signature.asc
Description: Message signed with OpenPGP using GPGMail
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

