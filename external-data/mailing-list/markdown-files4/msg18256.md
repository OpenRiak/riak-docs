---
title: "Re: Put failure: too many siblings"
description: ""
project: community
lastmod: 2017-06-01T05:27:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18256"
mailinglist_parent_id: "msg18232"
author_name: "Vladyslav Zakhozhai"
project_section: "mailinglistitem"
sent_date: 2017-06-01T05:27:08-07:00
---


Hi Russell,

I am reading about "retry\_put\_coordinator\_failure" option and I do not
understand it completely.

http://docs.basho.com/riak/kv/2.2.3/configuring/reference/#miscellaneous

I understand the following thing.

\*Statement 1.\* If we have N=3, W=3 then PUT operation (write) will be
successful if at least one PUT was successful (i.е. 2 vnodes failed due
high load). If none of the vnodes were able to write data PUT request is
failed.

\*Statement 2.\* In the case of this "successful" PUT we have only one copy
of data and it will be fixed during read repairs or aae (if latter is
enabled).

This is how I understand "the risk of potentially increasing the likelihood
of write failure" from the link above:
"Setting it to off will speed response times on PUT requests in general,
but at the risk of potentially increasing the likelihood of write failure."

Russell or anybody on the list, are my statements are correct or not?

Thank you in advance.

On Wed, May 24, 2017 at 11:36 AM Russell Brown 
wrote:

&gt; Also, this issue https://github.com/basho/riak\_kv/issues/1188 suggests
&gt; that adding the property `riak\_kv.retry\_put\_coordinator\_failure=false` may
&gt; help in future. But won’t help with your keys with too many siblings.
&gt;
&gt; On 24 May 2017, at 09:22, Russell Brown  wrote:
&gt;
&gt; &gt;
&gt; &gt; On 24 May 2017, at 09:11, Vladyslav Zakhozhai &lt;
&gt; v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt; &gt;
&gt; &gt;&gt; Hello,
&gt; &gt;&gt;
&gt; &gt;&gt; My riak cluster still experiences "too many siblings". And hinted
&gt; handoffs are not able to be finished completely. So "siblings will be
&gt; resolved after hinted handoffs are finished" is not my case unfortunately.
&gt; &gt;&gt;
&gt; &gt;&gt; According to basho's docs (
&gt; http://docs.basho.com/riak/kv/2.2.3/learn/concepts/causal-context/#sibling-explosion)
&gt; I need to enable dvv conflict resolution mechanism. So here is a quesion:
&gt; &gt;&gt;
&gt; &gt;&gt; Is it safe to enable dvv on default bucket type and how it affects
&gt; existing data?
&gt; &gt;
&gt; &gt; It might not affect existing data enough. All the existing siblings are
&gt; “undotted” and would need a read-put cycle to resolve.
&gt; &gt;
&gt; &gt;&gt; It may be a solution, is not it?
&gt; &gt;
&gt; &gt; You may require further action. I remember basho support helping someone
&gt; with a similar issue, and there was some manual intervention/scripted
&gt; solution, but I can’t remember what it was right now. I think those objects
&gt; (as logged) with the sibling issues need to be read and resolved. Maybe one
&gt; of the ex-basho support people remembers? I’ll prod one in a back channel
&gt; and see if they can help.
&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Why I talk about default bucket type? Because there is only one riak
&gt; client - Riak CS and it does not manage bucket types of PUT'ed object (so,
&gt; default bucket type always is used during PUT's). Is it correct?
&gt; &gt;
&gt; &gt; Yes.
&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Thank you in advance.
&gt; &gt;&gt;
&gt; &gt;&gt; On Fri, Jun 17, 2016 at 11:45 AM Vladyslav Zakhozhai &lt;
&gt; v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt; &gt;&gt; Hi Russel,
&gt; &gt;&gt;
&gt; &gt;&gt; thank you for your answer. I really appreciate your help.
&gt; &gt;&gt;
&gt; &gt;&gt; 2.1.3 is not actually riak\_kv version. It is version of basho's riak
&gt; package. Versions of riak subsystems you can see below.
&gt; &gt;&gt;
&gt; &gt;&gt; Bucket properties:
&gt; &gt;&gt; # riak-admin bucket-type list
&gt; &gt;&gt; default (active)
&gt; &gt;&gt;
&gt; &gt;&gt; # riak-admin bucket-type status default
&gt; &gt;&gt; default is active
&gt; &gt;&gt;
&gt; &gt;&gt; allow\_mult: true
&gt; &gt;&gt; basic\_quorum: false
&gt; &gt;&gt; big\_vclock: 50
&gt; &gt;&gt; chash\_keyfun: {riak\_core\_util,chash\_std\_keyfun}
&gt; &gt;&gt; dvv\_enabled: false
&gt; &gt;&gt; dw: quorum
&gt; &gt;&gt; last\_write\_wins: false
&gt; &gt;&gt; linkfun: {modfun,riak\_kv\_wm\_link\_walker,mapreduce\_linkfun}
&gt; &gt;&gt; n\_val: 3
&gt; &gt;&gt; notfound\_ok: true
&gt; &gt;&gt; old\_vclock: 86400
&gt; &gt;&gt; postcommit: []
&gt; &gt;&gt; pr: 0
&gt; &gt;&gt; precommit: []
&gt; &gt;&gt; pw: 0
&gt; &gt;&gt; r: quorum
&gt; &gt;&gt; rw: quorum
&gt; &gt;&gt; small\_vclock: 50
&gt; &gt;&gt; w: quorum
&gt; &gt;&gt; write\_once: false
&gt; &gt;&gt; young\_vclock: 20
&gt; &gt;&gt;
&gt; &gt;&gt; I did not mentioned that upgrade from riak 1.5.4 have been took place
&gt; couple months ago (about 6 months). As I understand DVV is disabled. Is it
&gt; safe to migrate to setting DVV from Vector Clocks?
&gt; &gt;&gt;
&gt; &gt;&gt; Package versions:
&gt; &gt;&gt; # dpkg -l | grep riak
&gt; &gt;&gt; ii riak 2.1.3-1
&gt; amd64 Riak is a distributed data store
&gt; &gt;&gt; ii riak-cs 2.1.0-1
&gt; amd64 Riak CS
&gt; &gt;&gt;
&gt; &gt;&gt; Subsystems versions:
&gt; &gt;&gt; "clique\_version" : "0.3.2-0-ge332c8f",
&gt; &gt;&gt; "bitcask\_version" : "1.7.2",
&gt; &gt;&gt; "sys\_driver\_version" : "2.2",
&gt; &gt;&gt; "riak\_core\_version" : "2.1.5-0-gb02ab53",
&gt; &gt;&gt; "riak\_kv\_version" : "2.1.2-0-gf969bba",
&gt; &gt;&gt; "riak\_pipe\_version" : "2.1.1-0-gb1ac2cf",
&gt; &gt;&gt; "cluster\_info\_version" : "2.0.3-0-g76c73fc",
&gt; &gt;&gt; "riak\_auth\_mods\_version" : "2.1.0-0-g31b8b30",
&gt; &gt;&gt; "erlydtl\_version" : "0.7.0",
&gt; &gt;&gt; "os\_mon\_version" : "2.2.13",
&gt; &gt;&gt; "inets\_version" : "5.9.6",
&gt; &gt;&gt; "erlang\_js\_version" : "1.3.0-0-g07467d8",
&gt; &gt;&gt; "riak\_control\_version" : "2.1.2-0-gab3f924",
&gt; &gt;&gt; "xmerl\_version" : "1.3.4",
&gt; &gt;&gt; "protobuffs\_version" : "0.8.1p5-0-gf88fc3c",
&gt; &gt;&gt; "riak\_sysmon\_version" : "2.0.0",
&gt; &gt;&gt; "compiler\_version" : "4.9.3",
&gt; &gt;&gt; "eleveldb\_version" : "2.1.10-0-g0537ca9",
&gt; &gt;&gt; "lager\_version" : "2.1.1",
&gt; &gt;&gt; "sasl\_version" : "2.3.3",
&gt; &gt;&gt; "riak\_dt\_version" : "2.1.1-0-ga2986bc",
&gt; &gt;&gt; "runtime\_tools\_version" : "1.8.12",
&gt; &gt;&gt; "yokozuna\_version" : "2.1.2-0-g3520d11",
&gt; &gt;&gt; "riak\_search\_version" : "2.1.1-0-gffe2113",
&gt; &gt;&gt; "sys\_system\_version" : "Erlang R16B02\_basho8 (erts-5.10.3) [source]
&gt; [64-bit] [smp:4:4] [async-threads:64] [kernel-poll:true] [frame-pointer]",
&gt; &gt;&gt; "basho\_stats\_version" : "1.0.3",
&gt; &gt;&gt; "crypto\_version" : "3.1",
&gt; &gt;&gt; "merge\_index\_version" : "2.0.1-0-g0c8f77c",
&gt; &gt;&gt; "kernel\_version" : "2.16.3",
&gt; &gt;&gt; "stdlib\_version" : "1.19.3",
&gt; &gt;&gt; "riak\_pb\_version" : "2.1.0.2-0-g620bc70",
&gt; &gt;&gt; "syntax\_tools\_version" : "1.6.11",
&gt; &gt;&gt; "goldrush\_version" : "0.1.7",
&gt; &gt;&gt; "ibrowse\_version" : "4.0.2",
&gt; &gt;&gt; "mochiweb\_version" : "2.9.0",
&gt; &gt;&gt; "exometer\_core\_version" : "1.0.0-basho2-0-gb47a5d6",
&gt; &gt;&gt; "ssl\_version" : "5.3.1",
&gt; &gt;&gt; "public\_key\_version" : "0.20",
&gt; &gt;&gt; "pbkdf2\_version" : "2.0.0-0-g7076584",
&gt; &gt;&gt; "sidejob\_version" : "2.0.0-0-gc5aabba",
&gt; &gt;&gt; "webmachine\_version" : "1.10.8-0-g7677c24",
&gt; &gt;&gt; "poolboy\_version" : "0.8.1p3-0-g8bb45fb",
&gt; &gt;&gt; "riak\_api\_version" : "2.1.2-0-gd8d510f",
&gt; &gt;&gt; "asn1\_version" : "2.0.3",
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; On Fri, Jun 17, 2016 at 10:45 AM Russell Brown 
&gt; wrote:
&gt; &gt;&gt; What version of riak\_kv is behind this riak\_cs install, please? Is it
&gt; really 2.1.3 as stated below? This looks and sounds like sibling explosion,
&gt; which is fixed in riak 2.0 and above. Are you sure that you are using the
&gt; DVV enabled setting for riak\_cs bucket properties? Can you post your bucket
&gt; properties please?
&gt; &gt;&gt;
&gt; &gt;&gt; On 16 Jun 2016, at 23:54, Vladyslav Zakhozhai &lt;
&gt; v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt; &gt;&gt;
&gt; &gt;&gt;&gt; Hello.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I see very interesting and confusing thing.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; From my previous letter you can see that siblings count on manifest
&gt; objects is about 100 (actualy it is in range 100-300). Unfortunately my
&gt; problem is that almost all PUT requests are failing with 500 Internal
&gt; Server error.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I've tried today set max\_siblings riak option to 500. And there were
&gt; successfull PUT requests but not for long. Now I see in riak logs error
&gt; with "max siblings", but actual count of them is 500+ (earlier it was
&gt; 100-300 as I've mentioned).
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Period of time between max\_siblings=500 and errors in log is about 30
&gt; minutes. And I want to point your attention that I've forbid PUT method on
&gt; haproxy - frontend for riak cs.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; On Mon, Jun 6, 2016 at 1:17 AM Vladyslav Zakhozhai &lt;
&gt; v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt; &gt;&gt;&gt; Hi, Luke.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thank you for your answer. I did not understand you completely about
&gt; transfer-limit. How does it relate to my problem. Transfer limit - is a
&gt; limit of concurrent data transfer from different nodes. Am I wright? You
&gt; mean that riak can handoff one partition from several nodes concurrently?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Now I have transfer-limit 1 on all riak nodes.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; But I am not sure that my cluster will be converged ever. All nodes
&gt; experiences low memory and are killed by OOM Killer periodically. I try to
&gt; add new nodes to the cluster but due problem with OOM killer this process
&gt; is very-very slow.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; In the official docs I've read:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; "Sibling explosion occurs when an object rapidly collects siblings
&gt; that are not reconciled. This can lead to a variety of problems, including
&gt; degraded performance, especially if many objects in a cluster suffer from
&gt; siblings explosion. At the extreme, having an enormous object in a node can
&gt; cause reads of that object to crash the entire node. Other issues include
&gt; undue latency and out-of-memory errors."
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I mentioned that new nodes in the cluster do not experience such
&gt; problems (I mean out of RAM).
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Regarding to siblings maybe your are right, this is manifest object. I
&gt; can recognize key name but not bucket name. But more than 100 siblings on
&gt; many keys is really confused me. Each time I try to PUT some object to Riak
&gt; via Riak CS S3 interface I got errors with siblings.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; On Fri, Jun 3, 2016 at 6:43 PM Luke Bakken  wrote:
&gt; &gt;&gt;&gt; Hi Vladyslav,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; If you recognize the full name of the object raising the sibling
&gt; &gt;&gt;&gt; warning, it is most likely a manifest object. Sometimes, during hinted
&gt; &gt;&gt;&gt; handoff, you can see these messages. They should resolve after handoff
&gt; &gt;&gt;&gt; completes.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Please see the documentation for the transfer-limit command as well:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; http://docs.basho.com/riak/kv/2.1.4/using/admin/riak-admin/#transfer-limit
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; --
&gt; &gt;&gt;&gt; Luke Bakken
&gt; &gt;&gt;&gt; Engineer
&gt; &gt;&gt;&gt; lbak...@basho.com
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; On Fri, Jun 3, 2016 at 2:55 AM, Vladyslav Zakhozhai
&gt; &gt;&gt;&gt;  wrote:
&gt; &gt;&gt;&gt;&gt; Hi.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; I have a trouble with PUT to Riak CS cluster. During this process I
&gt; &gt;&gt;&gt;&gt; periodically see the following message in Riak error.log:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; 2016-06-03 11:15:55.201 [error]
&gt; &gt;&gt;&gt;&gt; &lt;0.15536.142&gt;@riak\_kv\_vnode:encode\_and\_put:2253 Put failure: too many
&gt; &gt;&gt;&gt;&gt; siblings for object OBJECT\_NAME (101)
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; and also
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; 2016-06-03 12:41:50.678 [error]
&gt; &gt;&gt;&gt;&gt; &lt;0.20448.515&gt;@riak\_api\_pb\_server:handle\_info:331 Unrecognized message
&gt; &gt;&gt;&gt;&gt; {7345880,{error,{too\_many\_siblings,101}}}
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Here OBJECT\_NAME - is the name of object in Riak which has too many
&gt; &gt;&gt;&gt;&gt; siblings.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; I definitely sure that this objects are static. Nobody deletes is,
&gt; nobody
&gt; &gt;&gt;&gt;&gt; rewrites it. I have no idea why more than 100 siblings of this object
&gt; &gt;&gt;&gt;&gt; occurs.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; The following effect of this issue occurs:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Great amount of keys are loaded to RAM. I almost out of RAM (Do each
&gt; sibling
&gt; &gt;&gt;&gt;&gt; has it own key or key duplicate?).
&gt; &gt;&gt;&gt;&gt; Nodes are slow - adding new nodes are too slow
&gt; &gt;&gt;&gt;&gt; Presence of "too many siblings" affects ownership handoffs
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; So I have several questions:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Do hinted or ownership handoffs can affect siblings count (I mean can
&gt; &gt;&gt;&gt;&gt; siblings be created during ownership of hinted handoffs)
&gt; &gt;&gt;&gt;&gt; Is there any workaround of this issue. Do I need remove siblings
&gt; manually or
&gt; &gt;&gt;&gt;&gt; it removes during merges, read repairs and so on
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; My configuration:
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; riak from basho's packages - 2.1.3-1
&gt; &gt;&gt;&gt;&gt; riak cs from basho's packages - 2.1.0-1
&gt; &gt;&gt;&gt;&gt; 24 riak/riak-cs nodes
&gt; &gt;&gt;&gt;&gt; 32 GB RAM per node
&gt; &gt;&gt;&gt;&gt; AAE is disabled
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; I appreciate you help.
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

