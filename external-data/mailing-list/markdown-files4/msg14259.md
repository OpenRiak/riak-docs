---
title: "Secondary index (2i) range search and deleted keys in results"
description: ""
project: community
lastmod: 2014-05-22T12:06:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14259"
author_name: "Andrew Grieser"
project_section: "mailinglistitem"
sent_date: 2014-05-22T12:06:01-07:00
---


I have a cron job that prunes old records using a secondary index range
search on created\_at (milliseconds since epoch). The code looks like this:

Riak::SecondaryIndex.new(bucket, "created\_at\_bin", start..finish, {
max\_results: per\_page })

then it iterates through the keys and calls bucket.delete on each key.

The problem I'm having is that previously deleted results are showing up
when re-running the script, but attempts to fetch the objects fails because
they have been deleted. This is happening several hours after they were
originally deleted, so I don't think it is a transient replication issue.

My suspicion is that the secondary indexes are somehow out of
sync/disassociated with the object. Is there a way to repair these? Or am I
attempting something that just isn't going to work with riak?

Other details:
riak version: 1.4.8
ring\_size: 256
cluster nodes: 6
client: https://github.com/basho/riak-ruby-client (1.4.4.1)
connection type: protocol buffers
bucket delete\_mode: 3000
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

