---
title: "Re: riakc_pb_socket client & poolboy"
description: ""
project: community
lastmod: 2012-09-25T23:52:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08699"
mailinglist_parent_id: "msg08660"
author_name: "Anthony Molinaro"
project_section: "mailinglistitem"
sent_date: 2012-09-25T23:52:19-07:00
---


We've also got our own pool implementation at OpenX

https://github.com/openx/gen\_server\_pool

The nice thing is it wraps gen\_server such that you don't actually
have to know there is a pool there at all. Its not well documented
and currently uses mondemand to send stats (but I'll be trying to
remove that as a hard dependency). We use it to pool riak connections
and thrift connections and it works great.

An example of it's use for riakc would be

-module (my\_riak\_client).

start\_link () -&gt;
 gen\_server\_pool:start\_link (
 {local, my\_pool}, % identifier of pool
 riakc\_pb\_socket, % gen\_server to start
 ["localhost",8087,[{auto\_reconnect, true}]], % options for init/1
 [], % I don't recall
 [ { prog\_id, my\_riak\_client}, % mondemand identifier
 { min\_pool\_size, 1 }, % minimum 1 connection
 { max\_pool\_size, 10 }, % maximum 10 connections
 { idle\_timeout, 60 }, % after 60 seconds of idle kill connections
 { pool\_id, my\_pool } ] % same identifier as first argument
 ).

% then when you use it

riak\_get (Bucket, Key) -&gt;
 riakc\_pb\_socket:get (my\_pool, % pool identifier
 Bucket,
 Key).

Behind the scenes its doing checkin/checkout and whatnot. It does look
cheat a bit by using calling the embedded gen\_server functions directly
which actually caused us some consternation recently as we did account for
gen\_server:reply/2 which riakc\_pb\_socket uses. However, we patched it and
now it works for those cases as well.

-Anthony

On Mon, Sep 24, 2012 at 01:20:33PM +0400, Dmitry Demeshchuk wrote:
&gt; My main concern about poolboy is the fact that it wraps another gen\_server
&gt; process around the actual worker process. This makes you send an extra
&gt; message every time you query the database, which is quite an overhead when
&gt; you have a lot of concurrent users. Since you guys are fighting for
&gt; performance, that could be an issue for you.
&gt; 
&gt; At Mochi, we have a client of our own, which is somewhat close to gen\_pool
&gt; behaviour I implemented and open-sourced. This client incomplete in many
&gt; ways, and uses parametrized modules, which a lot of people tend to dislike,
&gt; but it is very fast, stable and production-proven.
&gt; 
&gt; Nevertheless, I would really like to hear about Basho's opinion on poolboy
&gt; too. Not only they included it into Riak distribution, but they also spent
&gt; a handful of effort to test it through and fix a number of quite serious
&gt; errors.
&gt; 
&gt; On Mon, Sep 24, 2012 at 12:56 PM, Yuri Lukyanov  wrote:
&gt; 
&gt; &gt; Hi Dmitry, ;)
&gt; &gt;
&gt; &gt; Yes, thank you. I'm also thinking about this approach. I just wanted
&gt; &gt; to know how people use poolboy for that (It seems they do).
&gt; &gt; But even considering your case, imagine that you have quite a big
&gt; &gt; cluster and quite a big amount of rps.
&gt; &gt; In this case you may want to have more than one load balancer to
&gt; &gt; spread the load and be more tolerant to LB failures.
&gt; &gt; Exactly the same situation arises.
&gt; &gt; It's not a problem to implement a pooler in this case on my own. I'm
&gt; &gt; just asking about using poolboy for that.
&gt; &gt;
&gt; &gt; On Mon, Sep 24, 2012 at 12:08 PM, Dmitry Demeshchuk
&gt; &gt;  wrote:
&gt; &gt; &gt; Why not use load balancer on top of Riak cluster, independently from
&gt; &gt; &gt; clients? If load balancing is sophisticated enough, it can even do a
&gt; &gt; greater
&gt; &gt; &gt; job than just uniformly spreading requests between machines.
&gt; &gt; &gt;
&gt; &gt; &gt; Consider the following situation. You happen to send several requests
&gt; &gt; for a
&gt; &gt; &gt; huge piece of data (each can be just a simple get, or even a complicated
&gt; &gt; &gt; map-reduce query), but the rest of the nodes, or just some of them,
&gt; &gt; receive
&gt; &gt; &gt; much smaller queries.
&gt; &gt; &gt;
&gt; &gt; &gt; What an external load balancer can do is gathering some basic stats from
&gt; &gt; &gt; each machine (like load average, memory and IO consumption, number of
&gt; &gt; rps to
&gt; &gt; &gt; Riak and so on) and balancing the requests according to this data.
&gt; &gt; Another
&gt; &gt; &gt; benefit from this approach is that you can easily add any other Riak
&gt; &gt; client
&gt; &gt; &gt; (Python, Ruby, whatever else) on top of it, and load will be still nicely
&gt; &gt; &gt; distributed between the machines.
&gt; &gt; &gt;
&gt; &gt; &gt; On Mon, Sep 24, 2012 at 11:38 AM, Yuri Lukyanov 
&gt; &gt; wrote:
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; Hi,
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; I'm trying to use poolboy to organize a pool of connections to riak
&gt; &gt; &gt;&gt; nodes with protobuf client.
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; This has come from the suggestion here:
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt;
&gt; &gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2012-September/009346.html
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; The quote:
&gt; &gt; &gt;&gt; "Using Poolboy is convenient because it comes as a dependency of
&gt; &gt; &gt;&gt; riak\_core.
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; If you use Poolboy, you'll have to modify riakc\_pb\_socket slightly to
&gt; &gt; &gt;&gt; account for the way poolboy initializes connections (add a
&gt; &gt; start\_link/1),
&gt; &gt; &gt;&gt; or create a simple module to pass the initialization from poolboy to
&gt; &gt; &gt;&gt; riakc\_pb\_socket."
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; What I'm pondering about is what would be a convenient way to start
&gt; &gt; &gt;&gt; riakc\_pb\_socket clients in a pool.
&gt; &gt; &gt;&gt; For example, if I have 10 riak nodes in a cluster and want to open a
&gt; &gt; &gt;&gt; single connection to each of them (using riakc\_pb\_socket), I need one
&gt; &gt; &gt;&gt; poolboy worker per one riakc\_pb\_socket instance. In this case, I need
&gt; &gt; &gt;&gt; a host/port of a single riak node for each
&gt; &gt; &gt;&gt; riakc\_pb\_socket:start\_link(). So I use WorkerArgs in
&gt; &gt; &gt;&gt; poolboy:start\_link/3 to pass a list of riak nodes. And here comes a
&gt; &gt; &gt;&gt; confusion. poolboy passes WorkerArgs to each of its workers, so each
&gt; &gt; &gt;&gt; worker gets the list of riak nodes. Now I need to somehow choose a
&gt; &gt; &gt;&gt; node, maybe like proposed here:
&gt; &gt; &gt;&gt; https://github.com/basho/riak-erlang-client/pull/45/files
&gt; &gt; &gt;&gt; But I don't think it's a good solution.
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; Maybe my idea of using riakc\_pb\_socket together with poolboy is not
&gt; &gt; &gt;&gt; convenient? Maybe I should start a pool per each riak node? Maybe
&gt; &gt; &gt;&gt; poolboy is not that convenient in this case as it seems?
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; Would you share your experiences and thoughts on the subject?
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; Thank you.
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; &gt;&gt; riak-users mailing list
&gt; &gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; --
&gt; &gt; &gt; Best regards,
&gt; &gt; &gt; Dmitry Demeshchuk
&gt; &gt;
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Best regards,
&gt; Dmitry Demeshchuk

&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


-- 
------------------------------------------------------------------------
Anthony Molinaro 

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

