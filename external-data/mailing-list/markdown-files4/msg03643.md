---
title: "Re: Waiting for 'backend' bucket property to take effect"
description: ""
project: community
lastmod: 2011-06-10T11:49:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03643"
mailinglist_parent_id: "msg03640"
author_name: "Greg Nelson"
project_section: "mailinglistitem"
sent_date: 2011-06-10T11:49:45-07:00
---


Ok, cool. Makes sense, thanks for the confirmation.

I'm toying with an idea of patching Riak to hard-code the backend for certain 
buckets. (A custom patch just for our needs, not general-purpose.) Along the 
lines of, "If the bucket name starts with foo\_, use backend foo". Then those 
buckets don't have properties that accumulate in the ring state, and we avoid 
the gossip lag problem altogether.

What do you think?

-Greg

On Friday, June 10, 2011 at 6:50 AM, Sean Cribbs wrote:

&gt; Greg,
&gt; 
&gt; Yes, it is most likely gossip lag causing that. For your test cluster you 
&gt; could decrease the gossip\_interval setting in riak\_core from its default of 
&gt; 60000 ms to something smaller.
&gt; 
&gt; There has long been talk of moving the bucket properties out of the ring into 
&gt; something like a "system bucket" or "catalog", which could be gossiped on 
&gt; demand or at a different interval than the ring. I don't recall the exact 
&gt; issue number in our Bugzilla, but it's &lt; 100.
&gt; 
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt; 
&gt; On Jun 10, 2011, at 2:17 AM, Greg Nelson wrote:
&gt; 
&gt; &gt; Hello,
&gt; &gt; 
&gt; &gt; I have been debugging something I've seen popping up intermittently when 
&gt; &gt; running my application's functional tests against Riak (local 5 node devrel 
&gt; &gt; cluster). The behavior is basically that sometimes an object which was PUT 
&gt; &gt; will seemingly disappear. Any future GETs will 404. Even if waiting seconds 
&gt; &gt; or minutes between PUT and GET.
&gt; &gt; 
&gt; &gt; After staring at this and pulling out some hair I finally figured out what 
&gt; &gt; was happening (I think). I noticed it was always the first few objects 
&gt; &gt; written that were lost, and only on a certain bucket. My application uses 
&gt; &gt; multi-backend with two bitcask backends. That bucket is the only one which 
&gt; &gt; uses the non-default backend.
&gt; &gt; 
&gt; &gt; What's happening is the application first gets the bucket properties and 
&gt; &gt; then sets the "backend" prop if it's not set. You can probably guess the 
&gt; &gt; rest. (PUTs come into nodes which don't have the property in their ring 
&gt; &gt; state yet and store the objects in the default backend)
&gt; &gt; 
&gt; &gt; I don't think this is necessarily a "bug". It's expected behavior when you 
&gt; &gt; think about it, as long as you know how bucket properties are propagated. 
&gt; &gt; But even knowing that, this is pretty subtle.
&gt; &gt; 
&gt; &gt; Is there a good way for a client to know when the property has been 
&gt; &gt; gossiped to all the nodes? Seems like the only approach is to wait a bit 
&gt; &gt; after setting a property before doing a PUT...
&gt; &gt; 
&gt; &gt; Also, does this sound right? It's very possible I'm wrong about what's 
&gt; &gt; causing this behavior.
&gt; &gt; 
&gt; &gt; -Greg
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

