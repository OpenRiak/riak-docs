---
title: "Re: Java client: byte arrays as keys?"
description: ""
project: community
lastmod: 2012-07-17T09:14:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07974"
mailinglist_parent_id: "msg07973"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2012-07-17T09:14:27-07:00
---


Kaspar -

Unfortunately it's worse than that. The reason it's doing that is because 
that's how the underlying, original Protobuf client is handling things - it 
uses ByteString.copyFromUtf8() on Strings that are passed to store(), fetch(), 
etc as the key.

Basically, above com.basho.riak.pbc.RiakClient there's simply not a way to use 
a non-UTF8 encoded String currently.

The problem with what you propose is that it requires modifying the higher 
level interfaces which will of course break code built on top of them (we have 
users who have built things on top of these interfaces). This is not something 
we want to do in a minor point release. 

That being said, there's a few things we'd like to change in the client but 
haven't for this same reason. Along with the Riak 1.2 release we'll be cutting 
the 1.0.6 release of the Java client. After that, I'd be willing to look into 
what it would take to sanely allow for arbitrary byte arrays to be used as keys 
for a 1.1 client release that would include other interface breaking changes.

Thanks,
Brian Roach


On Jul 17, 2012, at 4:32 AM, Kaspar Thommen wrote:

&gt; Brian,
&gt; 
&gt; I just identified a potential issue. In my application code all keys are 
&gt; byte[] arrays (or corresponding 64 bit integers), and in order to make sure I 
&gt; can generate a valid Riak key String from that byte array I convert using 
&gt; ISO-8859-1. However, when looking at PBClientAdapter.store() I see that it 
&gt; calls ConversionUtil.convert(), which in turn calls 
&gt; ConversionUtil.nullSafeToByteString() which uses UTF-8 encoding. Hence, my 
&gt; original byte array will likely be different in Riak.
&gt; 
&gt; This could could lead to tricky problems like the application code logging a 
&gt; byte array key that cannot be found in Riak. Do you think it would make sense 
&gt; to allow the user to specify a custom String/byte[] converter?
&gt; 
&gt; Thanks,
&gt; Kaspar
&gt; Am 16.07.2012 15:51 schrieb "Brian Roach" :
&gt; Kaspar -
&gt; 
&gt; Russell and I got together and discussed this a little more this morning.
&gt; 
&gt; The reason it's not exposed at the IRiakClient and RawClient interfaces is 
&gt; because the underlying original HTTP client API doesn't support a byte array 
&gt; as a key; it only uses String. Because of this, our IRiakObject default 
&gt; implementation only takes a String for a key, and our annotation processing 
&gt; only works with a String as well. It was all designed around being protocol 
&gt; neutral to sit on top of both of the old clients.
&gt; 
&gt; That being said, what does work perfectly fine is creating a new String from 
&gt; the byte array. Java does the right thing and this works regardless of 
&gt; whether you are using the PB or HTTP client:
&gt; 
&gt; IRiakClient client = RiakFactory.pbcClient(); // or .httpClient()
&gt; Bucket b = client.fetchBucket("this").execute();
&gt; 
&gt; byte[] foo = { 0, 5, 120, 1 };
&gt; String key = new String(foo);
&gt; 
&gt; b.store(key, "this is my value").execute();
&gt; IRiakObject o = b.fetch(key).execute();
&gt; System.out.println(o.getValueAsString());
&gt; 
&gt; client.shutdown();
&gt; 
&gt; Thanks!
&gt; Brian Roach
&gt; 
&gt; On Jul 16, 2012, at 1:01 AM, Russell Brown wrote:
&gt; 
&gt; &gt; Hi Kaspar,
&gt; &gt;
&gt; &gt; Sorry for the slow reply.
&gt; &gt;
&gt; &gt; On 16 Jul 2012, at 07:49, Kaspar Thommen wrote:
&gt; &gt;
&gt; &gt;&gt; Anyone please?
&gt; &gt;&gt;
&gt; &gt;&gt; On Jun 26, 2012 8:57 PM, "Kaspar Thommen"  wrote:
&gt; &gt;&gt; Hi,
&gt; &gt;&gt;
&gt; &gt;&gt; The high-level API in the Java client library (IRiakClient) does not allow 
&gt; &gt;&gt; one to use byte[] arrays as keys, only Strings, whereas the underlying PBC 
&gt; &gt;&gt; and http APIs (e.g. com.basho.riak.pbc.RiakClient) do, via the 
&gt; &gt;&gt; fetch(ByteString, ...) methods. Any reason for this?
&gt; &gt;
&gt; &gt; Oversight or oversimplifying by me.
&gt; &gt;
&gt; &gt;
&gt; &gt;&gt; Is it planned to add byte array keys to IRiakClient as well at some point?
&gt; &gt;
&gt; &gt; We should. Please will you raise an issue for it on the RJC github repo[1] 
&gt; &gt; to ensure we get to it?
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt;
&gt; &gt; Russell
&gt; &gt;
&gt; &gt; [1] Java client issues - 
&gt; &gt; https://github.com/basho/riak-java-client/issues?direction=desc&sort=created&state=open
&gt; &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Thanks,
&gt; &gt;&gt; Kaspar
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; 


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

