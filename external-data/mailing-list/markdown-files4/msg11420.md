---
title: "Re: load balance problem among riakc_pb_socket processes when get	objects?"
description: ""
project: community
lastmod: 2013-07-08T19:06:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11420"
author_name: "Wu Ray"
project_section: "mailinglistitem"
sent_date: 2013-07-08T19:06:41-07:00
---


Hi, guys,
I found that the problem only appeared in some special computers. For
example the problem can only be reproduced in my old MacBook(2007, MacOSX
Lion) and Intel Atom computer(Intel(R) Atom(TM) CPU N2800 @ 1.86GHz,
Ubuntu 12.04). I cannot reproduce it on a Desktop PC, which is Intel(R)
Core(TM)2 Duo CPU E7500 @ 2.93GHz, Ubuntu 13.04.


my test code:
test\_parallel\_put() -&gt;
 folsom:start(),
 folsom\_metrics:new\_histogram(put\_metric),

 B = &lt;&lt;"bigdata"&gt;&gt;,
 F = "/tmp/sss.mp4", %% a 384MB size file
 [spawn\_put\_worker(B, F, S) || S &lt;- lists:seq(1, 10)].

spawn\_put\_worker(B, F, S) -&gt;
 spawn(fun() -&gt;
 {ok, Pid} = riakc\_pb\_socket:start\_link("127.0.0.1", 10017),
 {ok, IoDevice} = file:open(F, [read, binary]),
 [do\_one\_put(IoDevice, Pid, B, S, I) || I &lt;- lists:seq(1, 100)]
 end).

 do\_one\_put(IoDevice, Pid, B, S, I) -&gt;
 K = list\_to\_binary(integer\_to\_list(S \* 100 + I)),
 {ok, BinData} = file:pread(IoDevice, S\*100 + I, 2097152),
 O = riakc\_obj:new(B, K, BinData),
 {Elapse,Res} = timer:tc(folsom\_metrics,
 histogram\_timed\_update,
 [put\_metric, riakc\_pb\_socket, put, [Pid, O]]),
 io:format("Pid: ~p, sz: ~p, time put: ~p, OK~n", [Pid, size(BinData),
Elapse/1000.0]).


--------------------------------------


test\_parallel\_get() -&gt;
 folsom:start(),
 folsom\_metrics:new\_histogram(get\_metric),

 B = &lt;&lt;"bigdata"&gt;&gt;,
 [spawn\_get\_worker(B, S) || S &lt;- lists:seq(1, 10)].

spawn\_get\_worker(B, S) -&gt;
 spawn(fun() -&gt;
 {ok, Pid} = riakc\_pb\_socket:start\_link("127.0.0.1", 10017),
 io:format("riakc: ~p~n", [Pid]),
 [do\_one\_get(Pid, B, S, I) || I &lt;- lists:seq(1, 100)]
 end).

 do\_one\_get(Pid, B, S, I) -&gt;
 K = list\_to\_binary(integer\_to\_list(S \* 100 + I)),
 {Elapse,Res} = timer:tc(folsom\_metrics,
 histogram\_timed\_update,
 [get\_metric, riakc\_pb\_socket, get, [Pid, B,
K]]),
 case Res of
 {ok, O} -&gt;
 BinData = riakc\_obj:get\_value(O),
 io:format("~p) Pid: ~p, sz: ~p, time get: ~p, OK~n",
 [I, Pid, size(BinData), Elapse/1000.0]);
 {error, Reason} -&gt;
 io:format("~p) Pid: ~p(is alive: ~p), time get: ~p, Error Rason
-----&gt; ~p~n",
 [I, Pid, is\_process\_alive(Pid), Elapse/1000.0, Reason])
 end.


the tests show that parallel-put always work well, in any case. However,
parallel-get has some problem in some platform.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

