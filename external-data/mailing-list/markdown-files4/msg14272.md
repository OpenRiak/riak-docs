---
title: "Consistent Riak (riak_ensemble) without Anti-entropy?"
description: ""
project: community
lastmod: 2014-05-28T03:26:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14272"
author_name: "Sargun Dhillon"
project_section: "mailinglistitem"
sent_date: 2014-05-28T03:26:32-07:00
---


So, I noticed that if I don't have anti-entropy on, and I enable
strongly consistent Riak, it doesn't work. Specifically, what happens
is that riak\_kv\_ensembles sets up the ensembles, but the
riak\_ensemble\_peer never gets past to all\_sync state. It appears that
this is because the riak\_kv\_ensemble\_backend relies on anti-entropy to
perform an exchange before it comes up. See here, from
riak\_kv/develop:


sync(Replies, State=#state{ensemble=\_Ensemble, id=Id}) -&gt;
 Peers0 = [{Idx, PeerId} || {PeerId={{kv,\_PL,\_N,Idx},\_Node},\_Reply}
&lt;- Replies],
 Peers = orddict:from\_list(Peers0),
 {{kv, PL, N, Idx}, \_} = Id,
 IndexN = {PL,N},
 %% Sort to remove duplicates when changing ownership / forwarded response
 Siblings0 = lists:usort([I || {{{kv,\_PL,\_N,I},\_Node},\_Reply} &lt;- Replies]),
 %% Just in case, remove self from list
 Siblings = Siblings0 -- [Idx],

 case local\_partition(Idx) of
 true -&gt;
 T0 = erlang:now(),
 Pid = self(),
 spawn\_link(fun() -&gt;
 wait\_for\_sync(Idx, IndexN, Pid, T0,
Siblings, Peers)
 end),
 {async, State};
 false -&gt;
 {ok, State}
 end.

wait\_for\_sync(Idx, IndexN, Pid, T0, Siblings, Peers) -&gt;
 Exchanges = riak\_kv\_entropy\_info:exchanges(Idx, IndexN),
 Recent = [OtherIdx || {OtherIdx, T1, \_} &lt;- Exchanges,
 T1 &gt; T0],
 lager:info("~p/~p: Exchanges: ~p~nT0: ~p~nRecent: ~p~nSibs: ~p",
 [Idx, IndexN, Exchanges, T0, Recent, Siblings]),
 Need = length(Siblings),
 Finished = length(Recent),
 Local = local\_partition(Idx),
 Complete = ((Siblings -- Recent) =:= []),
 if not Local -&gt;
 lager:info("Partition ownership changed. No need to sync."),
 riak\_ensemble\_backend:sync\_complete(Pid, []);
 Complete -&gt;
 lager:info("Complete ~b/~b :: ~p -&gt; ~p~n", [Finished,
Need, Idx, Pid]),
 SyncPeers = [orddict:fetch(PeerIdx, Peers) || PeerIdx &lt;- Siblings],
 riak\_ensemble\_backend:sync\_complete(Pid, SyncPeers);
 true -&gt;
 lager:info("Not yet ~b/~b :: ~p", [Finished, Need, Idx]),
 timer:sleep(10000),
 wait\_for\_sync(Idx, IndexN, Pid, T0, Siblings, Peers)
 end.


(I uncommented the debugging). If riak\_kv\_entropy\_manager is not
enabled, then riak\_kv\_entropy\_info:exchanges will always be empty. Can
we either (1) manually trigger AAE exchange upon noticing that strong
consistency is enabled (I imagine you can do this by setting the mode
to manual, and then queueing up the AAE jobs), (2) throw a warning to
the user saying that they should enable AAE.

-Sargun

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

