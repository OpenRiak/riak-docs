---
title: "Re: Truncated bit-cask files"
description: ""
project: community
lastmod: 2017-02-14T06:47:30-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17978"
mailinglist_parent_id: "msg17975"
author_name: "Arun Rajagopalan"
project_section: "mailinglistitem"
sent_date: 2017-02-14T06:47:30-08:00
---


Hi Magnus

RIAK crashes on startup when I have trucated bitcask file

It also crashes when the AAE files are bad too I think. Example below

2017-02-13 21:18:30 =CRASH REPORT====

 crasher:

 initial call: riak\_kv\_index\_hashtree:init/1

 pid: &lt;0.6037.0&gt;

 registered\_name: []

 exception exit: {{{badmatch,{error,{db\_open,"Corruption: truncated
record at end of file"}}},[{hashtree,new\_segment\_

store,2,[{file,"src/hashtree.erl"},{line,675}]},{hashtree,new,2,[{file,"src/hashtree.erl"},{line,246}]},{riak\_kv\_index\_h

ashtree,do\_new\_tree,3,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,610}]},{lists,foldl,3,[{file,"lists.erl"},{line,124

8}]},{riak\_kv\_index\_hashtree,init\_trees,3,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,474}]},{riak\_kv\_index\_hashtree,

init,1,[{file,"src/riak\_kv\_index\_hashtree.erl"},{line,268}]},{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line,304}]}

,{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,239}]}]},[{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line

,328}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,239}]}]}

 ancestors: [&lt;0.715.0&gt;,riak\_core\_vnode\_sup,riak\_core\_sup,&lt;0.160.0&gt;]

 messages: []

 links: []

 dictionary: []

 trap\_exit: false

 status: running

 heap\_size: 1598

 stack\_size: 27

 reductions: 889

 neighbours:



Regards
Arun


On Tue, Feb 14, 2017 at 4:48 AM, Magnus Kessler  wrote:

&gt; On 13 February 2017 at 19:56, Arun Rajagopalan &lt;
&gt; arun.v.rajagopa...@gmail.com&gt; wrote:
&gt;
&gt;&gt; Hello Riak Users
&gt;&gt;
&gt;&gt; We have situations where we dont or cant gracefully stop riak. When that
&gt;&gt; happens we occasionally get a truncated last-record in bitcask files
&gt;&gt;
&gt;&gt; If I delete those bitcask dir and the anti\_entropy directory, Riak
&gt;&gt; rebuilds those bitcask files correctly
&gt;&gt;
&gt;&gt; Is there a way to rectify those borken bitcask files ?
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt; Arun
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt; Hi Arun,
&gt;
&gt; There should be no need to remove truncated bitcask files. Any objects up
&gt; to the point of truncation should still be available to Riak. However, it
&gt; may take longer for the affected partition to start up, as the
&gt; corresponding hint file will not match the data file, and Riak will scan
&gt; the latter to populate the key set it keeps in memory.
&gt;
&gt; By removing anti\_entropy files you are forcing the AAE trees to be
&gt; rebuilt. Once this has completed, AAE will fill back any objects missing
&gt; due to the truncated bitcask files. You can also force a full partition
&gt; repair by following the instructions from the documentation [0].
&gt;
&gt; Can you let me know why you cannot shut down the node gracefully? Unclean
&gt; shutdowns should be a last resort and not part of normal operating
&gt; procedures.
&gt;
&gt; Kind Regards,
&gt;
&gt; Magnus
&gt;
&gt;
&gt; [0]: http://docs.basho.com/riak/kv/2.2.0/using/repair-recovery/
&gt; repairs/#repairing-partitions.
&gt;
&gt; --
&gt; Magnus Kessler
&gt; Client Services Engineer
&gt; Basho Technologies Limited
&gt;
&gt; Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

