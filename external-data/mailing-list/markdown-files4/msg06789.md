---
title: "basho_metrics re-entrant?"
description: ""
project: community
lastmod: 2012-02-29T14:46:13-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06789"
author_name: "Joel Meyer"
project_section: "mailinglistitem"
sent_date: 2012-02-29T14:46:13-08:00
---


Hello,

I'd like to capture statistics on all calls to my riak\_core service and the
execution time of vnode commands. I looked at folsom\_metrics, but for a
service that does 10-30k QPS I'm concerned about the overhead introduced of
doing ets calls. Given that, my current plan was to create several
basho\_metrics on startup and store the opaque refs using mochiglobal. Then
my service will make module calls to update the metrics. Will using
basho\_metrics in that matter cause problems?

Here's what I'm thinking:

-module(freqserver\_stats).

-export([ init/0,
 vnode\_count/1,
 ... ]).

-define( VNODE\_COUNT, freqserver\_stats\_vnode\_count ).


...

-define( METRICS,
 [ { ?VNODE\_COUNT, histogram },
 ... ] ).

 -define( STAT(Name), mochiglobal:get(Name) ).

init() -&gt;


 F = fun( { S, Type } , \_ ) -&gt;
 Ref = case Type of
 histogram -&gt; basho\_metrics\_nifs:histogram\_new();
 meter -&gt; basho\_metrics\_nifs:meter\_new()
 end,
 ok = mochiglobal:put( S, Ref )
 end,
 lists:foldl( F, [], ?METRICS ).

 vnode\_count( Micros ) -&gt;
 basho\_metrics\_nifs:histogram\_update( ?STAT( ?VNODE\_COUNT ), Micros ).

I'm also open to better ideas, if people have them. I'm concerned about
back pressure and/or overflowing the message queue if I dedicate a process
to handling these statistics. Let me know if I'm needlessly concerned about
that.

Thanks,
Joel
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

