---
title: "Re: Reg:Continuous Periodic crashes after long operation"
description: ""
project: community
lastmod: 2017-01-31T12:23:28-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17904"
mailinglist_parent_id: "msg17882"
author_name: "Steven Joseph"
project_section: "mailinglistitem"
sent_date: 2017-01-31T12:23:28-08:00
---


Hi Shaun,

Im having this issue again, this time I have captured the system limits,
while riak is still crashing.

Please note lsof and prlimit outputs at bottom.


steven@hawk5:log/riak:» tail error.log 
 
 [0] 07:17:05

2017-01-31 19:21:37.391 [error] emulator Error in process &lt;0.7964.15&gt; on node 
'r...@hawk5.streethawk.com' with exit value: 
{{badmatch,{error,system\_limit}},[{cpu\_sup,get\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}]},{cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}

2017-01-31 19:21:40.868 [error] &lt;0.25635.14&gt; gen\_server yz\_cover terminated 
with reason: no match of right hand value error in mochiglobal:compile/2 line 51
2017-01-31 19:21:40.868 [error] &lt;0.25635.14&gt; CRASH REPORT Process yz\_cover with 
0 neighbours exited with reason: no match of right hand value error in 
mochiglobal:compile/2 line 51 in gen\_server:terminate/6 line 744
2017-01-31 19:21:40.868 [error] &lt;0.1215.0&gt; Supervisor yz\_general\_sup had child 
yz\_cover started with yz\_cover:start\_link() at &lt;0.25635.14&gt; exit with reason no 
match of right hand value error in mochiglobal:compile/2 line 51 in context 
child\_terminated
2017-01-31 19:21:41.811 [error] emulator Error in process &lt;0.18111.15&gt; on node 
'r...@hawk5.streethawk.com' with exit value: 
{{badmatch,{error,system\_limit}},[{cpu\_sup,get\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}]},{cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}

2017-01-31 19:21:47.363 [error] emulator Error in process &lt;0.2866.15&gt; on node 
'r...@hawk5.streethawk.com' with exit value: 
{{badmatch,{error,system\_limit}},[{cpu\_sup,get\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}]},{cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}

steven@hawk5:log/riak:» sudo lsof -a -p `riak getpid` |wc -l 
 
 [0] 07:17:10
48446
steven@hawk5:log/riak:» sudo prlimit -n --noheadings -o soft -p `riak getpid` 
 
 [0] 07:17:27
20000500
steven@hawk5:log/riak:» sudo prlimit -n --noheadings -o hard -p `riak getpid` 
 
 [0] 07:17:32
20000500
steven@hawk5:log/riak:»


Python trace:

2017-01-31T20:20:52.004Z hawk4| return 
self.\_client.fulltext\_search(search\_index, query, \*\*params)
2017-01-31T20:20:52.004Z hawk4| \*\*skwargs
2017-01-31T20:20:52.004Z hawk4| return self.\_with\_retries(pool, thunk)
2017-01-31T20:20:52.004Z hawk4| \*\*kwargs
2017-01-31T20:20:52.004Z hawk4| File 
"/usr/local/lib/python2.7/dist-packages/riak/client/transport.py", line 179, in 
wrapper
2017-01-31T20:20:52.004Z hawk4| File 
"/usr/local/lib/python2.7/dist-packages/riak/bucket.py", line 476, in search
2017-01-31T20:20:52.004Z hawk4| File 
"/usr/local/lib/python2.7/dist-packages/riak/client/transport.py", line 134, in 
\_with\_retries
2017-01-31T20:20:52.004Z hawk4| File 
"/opt/streethawk/cloud/core/riakdb/models.py", line 528, in search
2017-01-31T20:20:52.005Z hawk4| RiakError: 'recv\_into returned zero bytes 
unexpectedly'
2017-01-31T20:20:52.005Z hawk4| raise e.args[0]



Regards

Steven


Shaun McVey  writes:

&gt; Hi Steven,
&gt;
&gt; Based on that log output, it looks like you're running into issues with
&gt; system limits, probably open file limits. You can check the value that
&gt; Riak has available by connecting to one of the nodes with riak attach, then
&gt; executing:
&gt;
&gt; ```
&gt; os:cmd("ulimit -n").
&gt; ```
&gt;
&gt; (After, disconnect with ctrl+g, then q, then Enter).
&gt;
&gt; It should be at least 65,536 ideally, although the bigger the better.
&gt;
&gt; If you find it's lower, then follow this doc to increase it.
&gt;
&gt; http://docs.basho.com/riak/kv/2.0.2/using/performance/open-files-limit/
&gt;
&gt; Have a check and let us know what the output was.
&gt;
&gt; Kind Regards,
&gt; Shaun
&gt;
&gt; On Thu, Jan 26, 2017 at 10:34 AM, Steven Joseph 
&gt; wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; We have a cluster of 5 nodes, which are continuously being queried for
&gt;&gt; new data through solr. We have been having some issues with riak/solr
&gt;&gt; which seems to be happening after longer periods of operation. It starts
&gt;&gt; off with one node and it seems to be happening on all node after a
&gt;&gt; while.
&gt;&gt;
&gt;&gt; We tried upgrading to the latest version of riak hoping that it would
&gt;&gt; solve the issue, but no luck.
&gt;&gt;
&gt;&gt; Only thing that stops the crashes is a full cluster staggered restart.
&gt;&gt;
&gt;&gt; Please find the logs below. Any help would be much appreciated.
&gt;&gt;
&gt;&gt; Riak Logs:
&gt;&gt;
&gt;&gt; 2017-01-26T07:53:03.262Z hawk5| \*\* Last message in was tick
&gt;&gt; 2017-01-26T07:53:10.197Z hawk5|
&gt;&gt; 2017-01-26T07:53:10.197Z hawk5| 2017-01-26 07:53:08.183 [error] emulator
&gt;&gt; Error in process &lt;0.22701.73&gt; on node 'r...@hawk5.streethawk.com' with
&gt;&gt; exit value: {{badmatch,{error,system\_limit}},[{cpu\_sup,g
&gt;&gt; et\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}
&gt;&gt; ]},{cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:10.263Z hawk5| Error in process &lt;0.22701.73&gt; on node '
&gt;&gt; r...@hawk5.streethawk.com' with exit value: {{badmatch,{error,system\_
&gt;&gt; limit}},[{cpu\_sup,get\_uint32\_measurement,2,[{file,"cpu\_sup.e
&gt;&gt; rl"},{line,223}]},{cpu\_sup,measurement\_server\_loop,1,[{
&gt;&gt; file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:10.263Z hawk5| 2017-01-26 07:53:08 =ERROR REPORT====
&gt;&gt; 2017-01-26T07:53:17.198Z hawk5|
&gt;&gt; 2017-01-26T07:53:17.208Z hawk5| 2017-01-26 07:53:13.472 [error] emulator
&gt;&gt; Error in process &lt;0.12549.73&gt; on node 'r...@hawk5.streethawk.com' with
&gt;&gt; exit value: {{badmatch,{error,system\_limit}},[{cpu\_sup,g
&gt;&gt; et\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}
&gt;&gt; ]},{cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:17.263Z hawk5| Error in process &lt;0.12549.73&gt; on node '
&gt;&gt; r...@hawk5.streethawk.com' with exit value: {{badmatch,{error,system\_
&gt;&gt; limit}},[{cpu\_sup,get\_uint32\_measurement,2,[{file,"cpu\_sup.e
&gt;&gt; rl"},{line,223}]},{cpu\_sup,measurement\_server\_loop,1,[{
&gt;&gt; file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:17.263Z hawk5| 2017-01-26 07:53:13 =ERROR REPORT====
&gt;&gt; 2017-01-26T07:53:18.198Z hawk5| 2017-01-26 07:53:17.861 [error] emulator
&gt;&gt; Error in process &lt;0.2254.73&gt; on node 'r...@hawk5.streethawk.com' with
&gt;&gt; exit value: {{badmatch,{error,system\_limit}},[{cpu\_sup,g$
&gt;&gt; t\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}]},{
&gt;&gt; cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:18.208Z hawk5|
&gt;&gt; 2017-01-26T07:53:18.208Z hawk5| 2017-01-26 07:53:17.861 [error] emulator
&gt;&gt; Error in process &lt;0.2254.73&gt; on node 'r...@hawk5.streethawk.com' with
&gt;&gt; exit value: {{badmatch,{error,system\_limit}},[{cpu\_sup,g$
&gt;&gt; t\_uint32\_measurement,2,[{file,"cpu\_sup.erl"},{line,223}]},{
&gt;&gt; cpu\_sup,measurement\_server\_loop,1,[{file,"cpu\_sup.erl"},{line,585}]}]}
&gt;&gt; 2017-01-26T07:53:18.264Z hawk5|
&gt;&gt;
&gt;&gt;
&gt;&gt; Python client traces:
&gt;&gt;
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| File "/usr/local/lib/python2.7/
&gt;&gt; dist-packages/riak/client/transport.py", line 179, in wrapper
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| return 
&gt;&gt; self.\_client.fulltext\_search(search\_index,
&gt;&gt; query, \*\*params)
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| File 
&gt;&gt; "/usr/local/lib/python2.7/dist-packages/riak/bucket.py",
&gt;&gt; line 476, in search
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| raise e.args[0]
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| File "/usr/local/lib/python2.7/
&gt;&gt; dist-packages/riak/client/transport.py", line 134, in \_with\_retries
&gt;&gt; 2017-01-26T10:20:44.517Z hawk5| return self.\_with\_retries(pool, thunk)
&gt;&gt; 2017-01-26T10:20:44.543Z hawk5| RiakError: 'recv\_into returned zero bytes
&gt;&gt; unexpectedly'
&gt;&gt;
&gt;&gt;
&gt;&gt; Regards
&gt;&gt;
&gt;&gt; Steven Joseph
&gt;&gt;
&gt;&gt; CTO, StreetHawk Pty Ltd
&gt;&gt;
&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;&gt;
&gt;&gt;

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

