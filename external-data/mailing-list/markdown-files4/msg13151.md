---
title: "Re: Make bucket really \"Public\""
description: ""
project: community
lastmod: 2013-12-04T09:49:58-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13151"
mailinglist_parent_id: "msg13146"
author_name: "Neil Soman"
project_section: "mailinglistitem"
sent_date: 2013-12-04T09:49:58-08:00
---


Hi there,

I don't think s3cmd lets you set public-read-write on buckets. Probably for
a good reason, it is generally not a good idea :)

I have attached a quick patch against the latest s3cmd HEAD that should let
you do this. I tested it quickly, so use at your own risk :)

If you set the acl back to --acl-private, it will remove anonymous read as
well as write.

Hope that helps.
neil


On Wed, Dec 4, 2013 at 2:31 AM, Gavin Huang  wrote:

&gt; Hi, all
&gt; I'm wondering is there any way to make a bucket in Riak-CS "public-write"?
&gt; i tried to call s3cmd:
&gt; s3cmd setacl --acl-public s3://test-bucket/
&gt;
&gt; but it only make bucket's read public:
&gt; s3cmd info s3://test-bucket
&gt;
&gt; Location: any
&gt; ACL: foobar: FULL\_CONTROL
&gt; ACL: \*anon\*: READ
&gt; URL: http://test-bucket.s3.amazonaws.com/
&gt;
&gt;
&gt; Thanks.
&gt; Gavin
&gt;
&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt;
&gt;
diff --git a/S3/ACL.py b/S3/ACL.py
index 2408d06..8c03321 100644
--- a/S3/ACL.py
+++ b/S3/ACL.py
@@ -34,6 +34,9 @@ class Grantee(object):
 def isAnonRead(self):
 return self.isAllUsers() and (self.permission == "READ" or self.permission == "FULL\_CONTROL")
 
+ def isAnonWrite(self):
+ return self.isAllUsers() and (self.permission == "WRITE" or self.permission == "FULL\_CONTROL")
+
 def getElement(self):
 el = ET.Element("Grant")
 grantee = ET.SubElement(el, "Grantee", {
@@ -54,6 +57,14 @@ class GranteeAnonRead(Grantee):
 self.name = Grantee.ALL\_USERS\_URI
 self.permission = "READ"
 
+class GranteeAnonWrite(Grantee):
+ def \_\_init\_\_(self):
+ Grantee.\_\_init\_\_(self)
+ self.xsi\_type = "Group"
+ self.tag = "URI"
+ self.name = Grantee.ALL\_USERS\_URI
+ self.permission = "WRITE"
+
 class GranteeLogDelivery(Grantee):
 def \_\_init\_\_(self, permission):
 """
@@ -119,13 +130,26 @@ class ACL(object):
 return True
 return False
 
+ def isAnonWrite(self):
+ for grantee in self.grantees:
+ if grantee.isAnonWrite():
+ return True
+ return False
+
 def grantAnonRead(self):
 if not self.isAnonRead():
 self.appendGrantee(GranteeAnonRead())
 
+ def grantAnonWrite(self):
+ if not self.isAnonWrite():
+ self.appendGrantee(GranteeAnonWrite())
+
 def revokeAnonRead(self):
 self.grantees = [g for g in self.grantees if not g.isAnonRead()]
 
+ def revokeAnonWrite(self):
+ self.grantees = [g for g in self.grantees if not g.isAnonWrite()]
+
 def appendGrantee(self, grantee):
 self.grantees.append(grantee)
 
diff --git a/S3/Config.py b/S3/Config.py
index c8dc99a..f9b3732 100644
--- a/S3/Config.py
+++ b/S3/Config.py
@@ -44,6 +44,7 @@ class Config(object):
 skip\_existing = False
 recursive = False
 acl\_public = None
+ acl\_public\_read\_write = None
 acl\_grants = []
 acl\_revokes = []
 proxy\_host = ""
diff --git a/S3/S3.py b/S3/S3.py
index 74e359e..b93443e 100644
--- a/S3/S3.py
+++ b/S3/S3.py
@@ -287,6 +287,8 @@ class S3(object):
 check\_bucket\_name(bucket, dns\_strict = False)
 if self.config.acl\_public:
 headers["x-amz-acl"] = "public-read"
+ if self.config.acl\_public\_read\_write:
+ headers["x-amz-acl"] = "public-read-write"
 request = self.create\_request("BUCKET\_CREATE", bucket = bucket, headers = headers)
 response = self.send\_request(request, body)
 return response
@@ -427,6 +429,8 @@ class S3(object):
 ## Other Amazon S3 attributes
 if self.config.acl\_public:
 headers["x-amz-acl"] = "public-read"
+ if self.config.acl\_public\_read\_write:
+ headers["x-amz-acl"] = "public-read-write"
 if self.config.reduced\_redundancy:
 headers["x-amz-storage-class"] = "REDUCED\_REDUNDANCY"
 
@@ -499,6 +503,8 @@ class S3(object):
 headers['x-amz-metadata-directive'] = "COPY"
 if self.config.acl\_public:
 headers["x-amz-acl"] = "public-read"
+ if self.config.acl\_public\_read\_write:
+ headers["x-amz-acl"] = "public-read-write"
 if self.config.reduced\_redundancy:
 headers["x-amz-storage-class"] = "REDUCED\_REDUNDANCY"
 # if extra\_headers:
diff --git a/s3cmd b/s3cmd
index 2e58604..26609c5 100755
--- a/s3cmd
+++ b/s3cmd
@@ -345,7 +345,7 @@ def cmd\_object\_put(args):
 output(u"File '%s' stored as '%s' (%d bytes in %0.1f seconds, %0.2f %sB/s) %s" %
 (unicodise(full\_name\_orig), uri\_final, response["size"], response["elapsed"],
 speed\_fmt[0], speed\_fmt[1], seq\_label))
- if Config().acl\_public:
+ if Config().acl\_public or Config().acl\_public\_read\_write:
 output(u"Public URL of the object is: %s" %
 (uri\_final.public\_url()))
 if Config().encrypt and full\_name != full\_name\_orig:
@@ -588,7 +588,7 @@ def subcmd\_cp\_mv(args, process\_fce, action\_str, message):
 try:
 response = process\_fce(src\_uri, dst\_uri, extra\_headers)
 output(message % { "src" : src\_uri, "dst" : dst\_uri })
- if Config().acl\_public:
+ if Config().acl\_public or Config().acl\_public\_read\_write:
 info(u"Public URL is: %s" % dst\_uri.public\_url())
 except S3Error, e:
 if cfg.ignore\_failed\_copy and e.code == "NoSuchKey":
@@ -1810,7 +1810,24 @@ def update\_acl(s3, uri, seq\_label=""):
 else:
 acl.revokeAnonRead()
 something\_changed = True
+ if not acl.isAnonWrite():
+ info(u"%s: already Private, skipping %s" % (uri, seq\_label))
+ else:
+ acl.revokeAnonWrite()
+ something\_changed = True
 
+ elif cfg.acl\_public\_read\_write == True:
+ if acl.isAnonRead():
+ info(u"%s: already Public Read, skipping %s" % (uri, seq\_label))
+ else:
+ acl.grantAnonRead()
+ something\_changed = True
+ if acl.isAnonWrite():
+ info(u"%s: already Public Write, skipping %s" % (uri, seq\_label))
+ else:
+ acl.grantAnonWrite()
+ something\_changed = True
+ 
 # update acl with arguments
 # grant first and revoke later, because revoke has priority
 if cfg.acl\_grants:
@@ -1915,6 +1932,7 @@ def main():
 optparser.add\_option( "--no-check-md5", dest="check\_md5", action="store\_false", help="Do not check MD5 sums when comparing files for [sync]. Only size will be compared. May significantly speed up transfer but may also miss some changed files.")
 optparser.add\_option("-P", "--acl-public", dest="acl\_public", action="store\_true", help="Store objects with ACL allowing read for anyone.")
 optparser.add\_option( "--acl-private", dest="acl\_public", action="store\_false", help="Store objects with default ACL allowing access for you only.")
+ optparser.add\_option( "--acl-public-read-write", dest="acl\_public\_read\_write", action="store\_true", help="Store objects with ACL allowing read/write for anyone.")
 optparser.add\_option( "--acl-grant", dest="acl\_grants", type="s3acl", action="append", metavar="PERMISSION:EMAIL or USER\_CANONICAL\_ID", help="Grant stated permission to a given amazon user. Permission is one of: read, write, read\_acp, write\_acp, full\_control, all")
 optparser.add\_option( "--acl-revoke", dest="acl\_revokes", type="s3acl", action="append", metavar="PERMISSION:USER\_CANONICAL\_ID", help="Revoke stated permission for a given amazon user. Permission is one of: read, write, read\_acp, wr ite\_acp, full\_control, all")
 
@@ -2098,6 +2116,7 @@ def main():
 ## Special handling for tri-state options (True, False, None)
 cfg.update\_option("enable", options.enable)
 cfg.update\_option("acl\_public", options.acl\_public)
+ cfg.update\_option("acl\_public\_read\_write", options.acl\_public\_read\_write)
 
 ## Check multipart chunk constraints
 if cfg.multipart\_chunk\_size\_mb &lt; MultiPartUpload.MIN\_CHUNK\_SIZE\_MB:
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

