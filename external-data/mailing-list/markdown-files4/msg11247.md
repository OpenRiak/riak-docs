---
title: "Riak 1.2.1 Crash During Rolling Upgrade to 1.3.1"
description: ""
project: community
lastmod: 2013-06-11T01:35:47-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11247"
author_name: "Shane McEwan"
project_section: "mailinglistitem"
sent_date: 2013-06-11T01:35:47-07:00
---



G'day!

I upgraded our production 4-node Riak cluster from 1.2.1 to 1.3.1 on the 
weekend. It didn't go as smoothly as expected.


After starting Riak on the first upgraded node, node01, I started 
getting error messages on two as yet unupgraded nodes, node02 and node03:


2013-06-08 21:22:50.596 [error] &lt;0.149.0&gt; gen\_server 
riak\_core\_handoff\_manager terminated with reason: no match of right hand 
value 
{error,{'EXIT',{undef,[{riak\_core\_handoff\_receiver,start\_link,[[]],[]},{supervisor,do\_start\_child\_i,3,[{file,"supervisor.erl"},{line,319}]},{supervisor,handle\_call,3,[{file,"supervisor.erl"},{line,344}]},{gen\_server,handle\_msg,5,[{file,"gen\_server.erl"},{line,588}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}} 
in riak\_core\_handoff\_manager:receive\_handoff/1 line 492
2013-06-08 21:22:50.604 [error] &lt;0.149.0&gt; CRASH REPORT Process 
riak\_core\_handoff\_manager with 0 neighbours exited with reason: no match 
of right hand value 
{error,{'EXIT',{undef,[{riak\_core\_handoff\_receiver,start\_link,[[]],[]},{supervisor,do\_start\_child\_i,3,[{file,"supervisor.erl"},{line,319}]},{supervisor,handle\_call,3,[{file,"supervisor.erl"},{line,344}]},{gen\_server,handle\_msg,5,[{file,"gen\_server.erl"},{line,588}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}} 
in riak\_core\_handoff\_manager:receive\_handoff/1 line 492 in 
gen\_server:terminate/6 line 747
2013-06-08 21:22:50.605 [error] &lt;0.143.0&gt; Supervisor 
riak\_core\_handoff\_sup had child riak\_core\_handoff\_manager started with 
riak\_core\_handoff\_manager:start\_link() at &lt;0.149.0&gt; exit with reason no 
match of right hand value 
{error,{'EXIT',{undef,[{riak\_core\_handoff\_receiver,start\_link,[[]],[]},{supervisor,do\_start\_child\_i,3,[{file,"supervisor.erl"},{line,319}]},{supervisor,handle\_call,3,[{file,"supervisor.erl"},{line,344}]},{gen\_server,handle\_msg,5,[{file,"gen\_server.erl"},{line,588}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}} 
in riak\_core\_handoff\_manager:receive\_handoff/1 line 492 in context 
child\_terminated
2013-06-08 21:22:50.606 [error] &lt;0.147.0&gt; gen\_server &lt;0.147.0&gt; 
terminated with reason: 
{{{badmatch,{error,{'EXIT',{undef,[{riak\_core\_handoff\_receiver,start\_link,[[]],[]},{supervisor,do\_start\_child\_i,3,[{file,"supervisor.erl"},{line,319}]},{supervisor,handle\_call,3,[{file,"supervisor.erl"},{line,344}]},{gen\_server,handle\_msg,5,[{file,"gen\_server.erl"},{line,588}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}}},[{riak\_core\_handoff\_manager,receive\_handoff,1,[{file,"src/riak\_core\_handoff\_manager.erl"},{line,492}]},{riak\_core\_handoff\_manager,handle\_call,3,[{...},...]},...]},...}
2013-06-08 21:22:50.608 [error] &lt;0.147.0&gt; CRASH REPORT Process 
riak\_core\_handoff\_listener with 1 neighbours exited with reason: 
{{{badmatch,{error,{'EXIT',{undef,[{riak\_core\_handoff\_receiver,start\_link,[[]],[]},{supervisor,do\_start\_child\_i,3,[{file,"supervisor.erl"},{line,319}]},{supervisor,handle\_call,3,[{file,"supervisor.erl"},{line,344}]},{gen\_server,handle\_msg,5,[{file,"gen\_server.erl"},{line,588}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}}},[{riak\_core\_handoff\_manager,receive\_handoff,1,[{file,"src/riak\_core\_handoff\_manager.erl"},{line,492}]},{riak\_core\_handoff\_manager,handle\_call,3,[{...},...]},...]},...} 
in gen\_server:terminate/6 line 747


Eventually, after 5 minutes, Riak on node02 and node03 crashed 
completely with:


2013-06-08 21:27:47.029 [error] &lt;0.17586.989&gt; Supervisor 
riak\_core\_handoff\_listener\_sup had child riak\_core\_handoff\_listener 
started with riak\_core\_handoff\_listener:start\_link() at undefined exit 
with reason bad return value: {error,eaddrinuse} in context start\_error
2013-06-08 21:27:47.030 [error] &lt;0.17583.989&gt; Supervisor 
riak\_core\_handoff\_sup had child riak\_core\_handoff\_listener\_sup started 
with riak\_core\_handoff\_listener\_sup:start\_link() at undefined exit with 
reason shutdown in context start\_error
2013-06-08 21:27:47.031 [error] &lt;0.139.0&gt; Supervisor riak\_core\_sup had 
child riak\_core\_handoff\_sup started with 
riak\_core\_handoff\_sup:start\_link() at {restarting,&lt;0.17470.989&gt;} exit 
with reason shutdown in context start\_error
2013-06-08 21:27:47.032 [error] &lt;0.17594.989&gt; CRASH REPORT Process 
riak\_core\_handoff\_listener with 1 neighbours exited with reason: bad 
return value: {error,eaddrinuse} in gen\_server:init\_it/6 line 332
2013-06-08 21:27:47.033 [error] &lt;0.17593.989&gt; Supervisor 
riak\_core\_handoff\_listener\_sup had child riak\_core\_handoff\_listener 
started with riak\_core\_handoff\_listener:start\_link() at undefined exit 
with reason bad return value: {error,eaddrinuse} in context start\_error
2013-06-08 21:27:47.034 [error] &lt;0.17590.989&gt; Supervisor 
riak\_core\_handoff\_sup had child riak\_core\_handoff\_listener\_sup started 
with riak\_core\_handoff\_listener\_sup:start\_link() at undefined exit with 
reason shutdown in context start\_error
2013-06-08 21:27:47.034 [error] &lt;0.139.0&gt; Supervisor riak\_core\_sup had 
child riak\_core\_handoff\_sup started with 
riak\_core\_handoff\_sup:start\_link() at {restarting,&lt;0.17470.989&gt;} exit 
with reason shutdown in context start\_error
2013-06-08 21:27:47.035 [error] &lt;0.139.0&gt; Supervisor riak\_core\_sup had 
child riak\_core\_handoff\_sup started with 
riak\_core\_handoff\_sup:start\_link() at {restarting,&lt;0.17470.989&gt;} exit 
with reason reached\_max\_restart\_intensity in context shutdown


And on node01 I finally got some messages indicating something was wrong:

2013-06-08 21:27:43.849 [error] 
&lt;0.9407.0&gt;@riak\_core\_handoff\_sender:start\_fold:226 hinted\_handoff 
transfer of riak\_kv\_vnode from 'riaknode01@10.1.1.13' 
685078892498860742907977265335757665463718379520 to 
'riaknode02@10.1.1.10' 685078892498860742907977265335757665463718379520 
failed because of 
exit:{noproc,{riak\_core\_gen\_server,call,[{riak\_kv\_handoff\_listener,'riaknode02@10.1.1.10'},handoff\_port,infinity]}} 
[{riak\_core\_gen\_server,call,3,[{file,"src/riak\_core\_gen\_server.erl"},{line,214}]},{riak\_core\_handoff\_sender,start\_fold,5,[{file,"src/riak\_core\_handoff\_sender.erl"},{line,84}]}]


The fourth node, node04, kept running fine. I assume this is because it 
doesn't have any of node01's vnode replicas on it so wasn't involved in 
any handoffs.


Anyway, I continued with the upgrades without any further incident, 
upgrading the crashed nodes next and, finally, node04.


Everything seems to be running fine. Thankfully we were in a maintenance 
window and I wasn't relying on the rolling upgrade capability to ensure 
service continuity. But should I be worried that something might be 
messed up because of the crash? Or that something is messed up that 
caused the crash?


I have crash dumps if they're of any use.

Thanks!

Shane.

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

