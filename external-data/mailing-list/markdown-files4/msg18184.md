---
title: "Re: Object not found after successful PUT on S3 API"
description: ""
project: community
lastmod: 2017-04-28T09:29:48-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18184"
author_name: "Magnus Kessler"
project_section: "mailinglistitem"
sent_date: 2017-04-28T09:29:48-07:00
---


On 28 April 2017 at 15:15, Matthew Von-Maszewski  wrote:

&gt; Daniel,
&gt;
&gt; Something is wrong. All instances of leveldb within a node share the
&gt; total memory configuration. The memory is equally divided between all
&gt; active vnodes. It is possible to create an OOM situation if total RAM is
&gt; low and vnodes count per node is high relative to RAM size.
&gt;
&gt; The best next step would be for you to execute the riak-debug program on
&gt; one of the nodes known to experience OOM. Send the resulting .tar.gz file
&gt; directly to me (no need to share that with the mailing list). I will
&gt; review the memory situation and suggest options.
&gt;
&gt; Matthew
&gt;
&gt; On Apr 28, 2017, at 8:22 AM, Daniel Miller  wrote:
&gt;
&gt; Hi Luke,
&gt;
&gt; I'm reviving this thread from March where we discussed a new backend
&gt; configuration for our riak cluster. We have had a chance to test out the
&gt; new recommended configuration, and so far we have not been successful in
&gt; limiting the RAM usage of leveldb with multi\_backend. We have tried various
&gt; configurations to limit memory usage without success.
&gt;
&gt; First try (default config).
&gt; riak.conf: leveldb.maximum\_memory.percent = 70
&gt;
&gt; Second try.
&gt; riak.conf: leveldb.maximum\_memory.percent = 40
&gt;
&gt; Third try
&gt; riak.conf: #leveldb.maximum\_memory.percent = 40 (commented out)
&gt; advanced.config: [{eleveldb, [{total\_leveldb\_mem\_percent, 30}]}, ...
&gt;
&gt; In all cases (under load) riak consumes all available RAM and eventually
&gt; becomes unresponsive, presumably due to OOM conditions. Is there a way to
&gt; limit the amount of RAM consumed by riak with the new multi\_backend
&gt; configuration? For example, do we need to consider ring size or other
&gt; configuration parameters when calculating the value of
&gt; total\_leveldb\_mem\_percent?
&gt;
&gt; Notably, the old (storage\_backend = leveldb in riak.conf, empty
&gt; advanced.config) clusters have had very good RAM and disk usage
&gt; characteristics. Is there any way we can make riak or riak cs avoid the
&gt; rare occasions where it overwrites the manifest file while using this
&gt; (non-multi) backend?
&gt;
&gt; Thank you,
&gt; Daniel Miller
&gt;
&gt;
&gt; On Tue, Mar 7, 2017 at 3:58 PM, Luke Bakken  wrote:
&gt;
&gt;&gt; Hi Daniel,
&gt;&gt;
&gt;&gt; Thanks for providing all of that information.
&gt;&gt;
&gt;&gt; You are missing important configuration for riak\_kv that can only be
&gt;&gt; provided in an /etc/riak/advanced.config file. Please see the following
&gt;&gt; document, especially the section to which I link here:
&gt;&gt;
&gt;&gt; http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/
&gt;&gt; riak-for-cs/#setting-up-the-proper-riak-backend
&gt;&gt;
&gt;&gt; [
&gt;&gt; {riak\_kv, [
&gt;&gt; \*% NOTE: double-check this path for your environment:\*
&gt;&gt; {add\_paths, ["/usr/lib/riak-cs/lib/riak\_cs-2.1.1/ebin"]},
&gt;&gt; {storage\_backend, riak\_cs\_kv\_multi\_backend},
&gt;&gt; {multi\_backend\_prefix\_list, [{&lt;&lt;"0b:"&gt;&gt;, be\_blocks}]},
&gt;&gt; {multi\_backend\_default, be\_default},
&gt;&gt; {multi\_backend, [
&gt;&gt; {be\_default, riak\_kv\_eleveldb\_backend, [
&gt;&gt; {data\_root, "/opt/data/ecryptfs/riak"}
&gt;&gt; ]},
&gt;&gt; {be\_blocks, riak\_kv\_eleveldb\_backend, [
&gt;&gt; {data\_root, "/opt/data/ecryptfs/riak\_blocks"}
&gt;&gt; ]}
&gt;&gt; ]}
&gt;&gt; ]}
&gt;&gt; ].
&gt;&gt;
&gt;&gt; Your configuration will look like the above. The contents of this file
&gt;&gt; are merged with the contents of /etc/riak/riak.conf to produce the
&gt;&gt; configuration that Riak uses.
&gt;&gt;
&gt;&gt; Notice that I chose riak\_kv\_eleveldb\_backend twice because of the
&gt;&gt; discussion you had previously about RAM usage and bitcask (
&gt;&gt; http://lists.basho.com/pipermail/riak-users\_lists.basho.com
&gt;&gt; /2016-November/018801.html)
&gt;&gt;
&gt;&gt; In your current configuration, you are not using the expected prefix for
&gt;&gt; the block data. My guess is that on very rare occasions your data happens
&gt;&gt; to overwrite the manifest for a file. You may also have corrupted files at
&gt;&gt; this point without noticing it at all.
&gt;&gt;
&gt;&gt; \*IMPORTANT:\* you can't switch from your current configuration to this
&gt;&gt; new one without re-saving all of your data.
&gt;&gt;
&gt;
&gt;
Hi Daniel,

In a typical CS setup, both the bitcask and leveldb backends are in use.
Bitcasks memory use depends directly on the amount of keys stored in this
backend. Can you please let me know how many files and how much total data
is stored in the CS cluster?

Kind Regards,

Magnus


-- 
Magnus Kessler
Client Services Engineer
Basho Technologies Limited

Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

