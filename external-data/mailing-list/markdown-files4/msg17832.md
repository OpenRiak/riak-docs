---
title: "Re: I2 queries fail when few nodes are down"
description: ""
project: community
lastmod: 2017-01-05T03:23:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17832"
mailinglist_parent_id: "msg17831"
author_name: "Magnus Kessler"
project_section: "mailinglistitem"
sent_date: 2017-01-05T03:23:57-08:00
---


On 4 January 2017 at 23:22, Tomi Takussaari 
wrote:

&gt; Hello Riak-users
&gt;
&gt; We have 9 node Riak-cluster, that we use to store user accounts.
&gt;
&gt; Some of the crucial data fields of user account are indexed using I2, so
&gt; that we can do secondary index queries based on them.
&gt;
&gt; Today, we tested how our cluster performs when few nodes go down, and
&gt; results were not very good.
&gt;
&gt; If more than 2 nodes go down, all I2 queries will start failing, returning
&gt; HTTP 500, with "insufficient vnodes available" error. After nodes are up
&gt; again, things start working again.
&gt; Normal object CRUD operations worked fine.
&gt;
&gt; Is this to be expected behaviour ?
&gt;
&gt; Funny thing is, that we have other cluster, with same configuration but
&gt; with 6 nodes, for other environment, and that also experiences same
&gt; problems when more than 2 nodes go down, so it does not seem to have
&gt; anything to do with percentage of nodes being down..
&gt;
&gt; Our ring size is 256, and current Riak version is 2.2.
&gt;
&gt; Both clusters were first created years ago, with Riak 1.4, if memory
&gt; serves, and I believe we tested this same thing back then, and I2 queries
&gt; did not stop working this easily then..
&gt;
&gt; Any help would be appreciated!
&gt;
&gt;
Hi Tomi,

For a cluster that uses the default replication factor (`n\_val`) of 3, the
behaviour you observed is expected. Secondary index queries work on a
covering set of VNodes, that include 1 replica for each KV object. With
`n\_val=3` the covering set can only be guaranteed if no more than 2 nodes
are offline at any given time. This behaviour has not changed since the 1.4
release.

As our documentation [0] states:

"Riak stores 3 replicas of all objects by default, although this can be
changed using bucket types, which manage buckets’ replication properties.
The system is capable of generating a full set of results from one third of
the system’s partitions as long as it chooses the right set of partitions.
The query is sent to each partition, the index data is read, and a list of
keys is generated and then sent back to the requesting node."

Other operations working fine is due to Riak's ability to spin up fallback
partitions (VNodes on one of the remaining nodes), that will accept and
temporarily store data while the Node that should own the data is down.

Kind Regards,

Magnus

[0]:
http://docs.basho.com/riak/kv/2.2.0/using/reference/secondary-indexes/#how-it-works

-- 
Magnus Kessler
Client Services Engineer
Basho Technologies Limited

Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg 07970431
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

