---
title: "Debugging mapreduce"
description: ""
project: community
lastmod: 2013-09-23T23:30:29-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12355"
author_name: "Charl Matthee"
project_section: "mailinglistitem"
sent_date: 2013-09-23T23:30:29-07:00
---


Hi,

I am trying to run the following mapreduce query across my cluster:

# curl -XPOST http://10.179.229.209:8098/mapred -H "Content-Type:
application/json" -d '{"inputs":"tweets",
"query":[{"map":{"language":"javascript", "source":"function(value,
keyData, arg) {t = JSON.parse(value.values[0].data)[0]; if ((new Date
- new Date(t.created\_at)) / 1000 &gt; 2592000) return [t.id]; else return
[]}", "keep":true}}]}'
{"lineno":466,"message":"SyntaxError: syntax error","source":"()"}

The riak logs only have the following to report:

==&gt; /var/log/riak/crash.log &lt;==
2013-09-24 05:42:51 =ERROR REPORT====
webmachine error: path="/mapred"
"Internal Server Error"

==&gt; /var/log/riak/console.log &lt;==
2013-09-24 05:42:51.272 [error] &lt;0.20367.1441&gt; Webmachine error at
path "/mapred" : "Internal Server Error"

==&gt; /var/log/riak/error.log &lt;==
2013-09-24 05:42:51.272 [error] &lt;0.20367.1441&gt; Webmachine error at
path "/mapred" : "Internal Server Error"

Is there any way to get some more info on this to debug it further?

I have tried using ejsLog() (from
http://docs.basho.com/riak/1.3.2/references/appendices/MapReduce-Implementation/#Debugging-Javascript-Map-Reduce-Phases)
to inspect the data in the function body but that simply gives me:

# curl -XPOST http://10.179.229.209:8098/mapred -H "Content-Type:
application/json" -d '{"inputs":"tweets",
"query":[{"map":{"language":"javascript", "source":"function(value,
keyData, arg) {t = JSON.parse(value.values[0].data)[0];
ejsLog('/tmp/map\_reduce.log', JSON.stringify(t)); if ((new Date - new
Date(t.created\_at)) / 1000 &gt; 2592000) return [t.id]; else return []}",
"keep":true}}]}'
{"lineno":1,"message":"SyntaxError: invalid flag after regular
expression","source":"JSON.stringify(function(value, keyData, arg) {t
= JSON.parse(value.values[0].data)[0]; ejsLog(/tmp/map\_reduce.log,
JSON.stringify(t)); if ((new Date - new Date(t.created\_at)) / 1000 &gt;
2592000) return [t.id]; else return
[]}({\"bucket\":\"tweets\",\"key\":\"37456"}

I have also tried checking for already deleted documents in case that
was what tripping things up but adding a check in for the
X-Riak-Deleted header also results in an error:

# curl -XPOST http://10.179.229.209:8098/mapred -H "Content-Type:
application/json" -d '{"inputs":"tweets",
"query":[{"map":{"language":"javascript", "source":"function(value,
keyData, arg) {if (value.values[0].metadata['X-Riak-Deleted'] ==
'true') return []; t = JSON.parse(value.values[0].data)[0]; if ((new
Date - new Date(t.created\_at)) / 1000 &gt; 2592000) return [t.id]; else
return []}", "keep":true}}]}'
{"lineno":1,"message":"ReferenceError: X is not defined","source":"unknown"}


-- 
Ciao

Charl

"I will either find a way, or make one." -- Hannibal

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

