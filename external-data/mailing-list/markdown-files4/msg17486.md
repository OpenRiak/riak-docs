---
title: "Re: bitcask merges & deletions"
description: ""
project: community
lastmod: 2016-06-16T17:09:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17486"
mailinglist_parent_id: "msg17479"
author_name: "Johnny Tan"
project_section: "mailinglistitem"
sent_date: 2016-06-16T17:09:55-07:00
---


Hm, definitely not a cronjob. I'll look at our app and see if there's
anything that does something like that there.

On Wed, Jun 15, 2016 at 9:10 PM, Luke Bakken  wrote:

&gt; Hi Johnny,
&gt;
&gt; Since this seems to happen regularly on one node on your cluster (not
&gt; necessarily the same node), do you have a repetitive process that
&gt; performs a \*lot\* of updates or deletes on a single key that could be
&gt; correlated to these merges?
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Wed, Jun 15, 2016 at 10:22 AM, Johnny Tan  wrote:
&gt; &gt; We're running riak-1.4.2
&gt; &gt;
&gt; &gt; Every few weeks, we have a riak node that starts to slowly fill up on
&gt; disk
&gt; &gt; space for several days, and then suddenly gain that space back again.
&gt; &gt;
&gt; &gt; In looking into this more today, I think I see what's going on.
&gt; &gt;
&gt; &gt; Per the console.log on a node that it's happening to right now, there
&gt; are an
&gt; &gt; unusually large amount of merges happening right now. There are 6 total
&gt; &gt; nodes in our cluster, it's only happening to this node today. (In
&gt; previous
&gt; &gt; weeks, it's been other nodes, but it's always been one node at a time.)
&gt; &gt;
&gt; &gt; Normally, we get 50-70 merges per day per node (according to various
&gt; nodes'
&gt; &gt; console.log, including the node in question). Yesterday and today, the
&gt; node
&gt; &gt; in question has several hundred merges happening.
&gt; &gt;
&gt; &gt; When I look inside the bitcask directory, I see a lot of files with this
&gt; set
&gt; &gt; of permissions:
&gt; &gt; -rwSrw-r--
&gt; &gt;
&gt; &gt; My understanding is that those are files marked for deletions after
&gt; bitcask
&gt; &gt; merging.
&gt; &gt;
&gt; &gt; The number of those files is currently growing, and from a spot-check,
&gt; they
&gt; &gt; indeed match up as the files that have been merged.
&gt; &gt;
&gt; &gt; So it seems the two are related: a lot of merges are happening, which
&gt; then
&gt; &gt; causes a large number of files to be marked for deletion, and those
&gt; marked
&gt; &gt; files are piling up and not getting deleted for some reason.
&gt; &gt;
&gt; &gt; If I don't do anything, those files eventually get deleted, and
&gt; everything
&gt; &gt; is good again for another couple weeks until it happens to another node.
&gt; But
&gt; &gt; the disk usage does get high enough to alert us, and obviously we don't
&gt; want
&gt; &gt; it to get anywhere near 100%.
&gt; &gt;
&gt; &gt;
&gt; &gt; I'm trying to figure out why there are times when this happens. One
&gt; thing I
&gt; &gt; noticed is a difference in the merge log entries.
&gt; &gt;
&gt; &gt; Here's one from a "normal" day, nearly all the entries for that day are
&gt; &gt; roughly this same length and same amount of time merging:
&gt; &gt; 2016-06-10 05:27:39.426 UTC [info] &lt;0.15230.160&gt; Merged
&gt; &gt;
&gt; {["/var/lib/riak/bitcask/890602560248518965780370444936484965102833893376/84000.bitcask.data","/var/lib/riak/bitcask/890602560248518965780370444936484965102833893376/83999.bitcask.data"],[]}
&gt; &gt; in 11.902028 seconds.
&gt; &gt;
&gt; &gt; But here's one from today on the problematic node:
&gt; &gt; 2016-06-15 17:13:40.626 UTC [info] &lt;0.17903.500&gt; Merged
&gt; &gt;
&gt; {["/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83633.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83632.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83631.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83630.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83629.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83628.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83627.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83626.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83625.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83624.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83623.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83622.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83621.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83620.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83619.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83618.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83617.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83616.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83615.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83614.bitcask.data","/var/lib/riak/bitcask/1233142006497949337234359077604363797834693083136/83613.bitcask.data","/var/lib/riak/bitcask/12331420064979493372343590776043637978346930...",...],...}
&gt; &gt; in 220.186043 seconds.
&gt; &gt;
&gt; &gt; It's not just that it takes 20x longer to merge, but it seems to be
&gt; doing a
&gt; &gt; lot more files at once.
&gt; &gt;
&gt; &gt; What is going on?
&gt; &gt;
&gt; &gt; I'm not sure how much of the app.config is relevant, but I'll at least
&gt; paste
&gt; &gt; just the bitcask and merge sections for now:
&gt; &gt; {bitcask, [
&gt; &gt; {data\_root, "/var/lib/riak/bitcask"},
&gt; &gt; {dead\_bytes\_merge\_trigger, 268435456},
&gt; &gt; {dead\_bytes\_threshold, 67108864},
&gt; &gt; {frag\_merge\_trigger, 60},
&gt; &gt; {frag\_threshold, 40},
&gt; &gt; {io\_mode, erlang},
&gt; &gt; {max\_file\_size, 1073741824},
&gt; &gt; {small\_file\_threshold, 134217728}
&gt; &gt; ]},
&gt; &gt; {merge\_index, [
&gt; &gt; {buffer\_rollover\_size, 1048576},
&gt; &gt; {data\_root, "/var/lib/riak/merge\_index"},
&gt; &gt; {max\_compact\_segments, 20}
&gt; &gt; ]},
&gt; &gt;
&gt; &gt;
&gt; &gt; Thanks for any insight,
&gt; &gt; johnny
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

