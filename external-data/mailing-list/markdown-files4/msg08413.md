---
title: "Re: Bad MapReduce job brings the Riak to a screeching halt?"
description: ""
project: community
lastmod: 2012-08-30T15:57:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08413"
mailinglist_parent_id: "msg08412"
author_name: "Brad Heller"
project_section: "mailinglistitem"
sent_date: 2012-08-30T15:57:55-07:00
---


Hey Kelly, Bryan,

Thanks for the replies. Good to hear this is being worked on! And sorry I 
didn't elaborate on "crashed." In this instance crashed meant "stopped taking 
connections on the HTTP interface." I didn't check to see if the Beam processes 
died (I think they did as load decreased).

I bumped my ulimit -n based on previous suggestions and that seemed to help. 
If/when I run in to this again I will indeed post more details!

Thanks,
Brad

On Aug 30, 2012, at 3:16 PM, Kelly McLaughlin  wrote:

&gt; 
&gt; On Aug 29, 2012, at 9:07 PM, Brad Heller  wrote:
&gt;&gt; 
&gt;&gt; So my question is: Why did this completely kill Riak? This makes me pretty 
&gt;&gt; nervous--a bug in our app has the potential to bring down the ring! Is there 
&gt;&gt; anything we can do to protect against this?
&gt;&gt; 
&gt; 
&gt; Riak 1.2 had a lot of changes to leveldb and one of those was a change to 
&gt; using flock() instead of fcntl(SET\_FL) to try and make the locking a bit 
&gt; saner. Previously, using fcntl, multiple processes in the erlang VM could get 
&gt; a lock to the same leveldb instance and this could obviously lead to some 
&gt; conflicts. However, a result of the change to using flock is that when the 
&gt; vnode crashes the resources can still be locked by the previous process and 
&gt; this results in this message:
&gt; 
&gt; 2012-08-29 19:45:41.785 [error] &lt;0.23924.70&gt;@riak\_kv\_vnode:init:265 
&gt; Failed to start riak\_kv\_multi\_backend Reason: 
&gt; [{riak\_kv\_eleveldb\_backend,{db\_open,"IO error: lock 
&gt; ../../tmp/riak/instance1/leveldb/0/LOCK: Resource temporarily unavailable"}}]
&gt; 
&gt; Currently we do not attempt to wait or retry the vnode restart and this can 
&gt; cause the node to crash. I can understand you being a little nervous, but we 
&gt; are aware of this and are taking steps on two fronts to address it. First, as 
&gt; Bryan mentioned previously, we're looking at fixing these error conditions 
&gt; that cause the vnode to crash that really should not do so. Second, we're 
&gt; looking at a way to add some retry logic when the vnode does crash and the 
&gt; resources are locked. Thanks for the report!
&gt; 
&gt; Kelly


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

