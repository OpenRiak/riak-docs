---
title: "Re: Question regarding recent riak_core_vnode_master changes"
description: ""
project: community
lastmod: 2012-01-10T08:29:41-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06207"
mailinglist_parent_id: "msg06079"
author_name: "Jeff Thompson"
project_section: "mailinglistitem"
sent_date: 2012-01-10T08:29:41-08:00
---


Hi Joseph,

Thanks for getting back with me, and my apologies that it's taken me so
long to respond. Thank you for the explanation! You also came up with the
right diagnosis of my problem. I fixed it sometime just before Christmas
and everything has been working fine with riak\_core since.

Once I get things together in a way that I like I'll be posting a public
repo as another example of using riak\_core for an application, and would
certainly welcome any and all feedback.

Cheers!

Jeff



On Tue, Dec 27, 2011 at 3:15 PM, Joseph Blomstedt  wrote:

&gt; Jeff,
&gt;
&gt; There have been several changes to how vnodes are managed leading up
&gt; to the next release of Riak. One of those changes is the addition of
&gt; vnode proxy processes.
&gt;
&gt; As before, vnodes are still started on demand. However, there are now
&gt; a set of vnode proxy processes that are always running. Unlike vnodes,
&gt; the proxy processes for all partition indices are started when a node
&gt; comes online, and the proxy processes are supervised and automatically
&gt; restarted if they crash. Each proxy process has a unique locally
&gt; registered name. To send an event to a vnode, you send it directly to
&gt; the proxy process for that vnode. If the proxy already has a pid for
&gt; the vnode, it forwards the message to the vnode. If it doesn't have a
&gt; cached pid, it will contact the 'riak\_core\_vnode\_manager' to get a
&gt; vnode pid. If the vnode is currently running, the manager returns the
&gt; pid; otherwise it starts up the vnode and returns the newly spawned
&gt; pid. The same lazy / on-demand process as before.
&gt;
&gt; The 'badarg' issue you are seeing is related to the relevant proxy
&gt; processes not being spawned for your vnodes before you try to send the
&gt; event, and therefore the constructed atom doesn't refer to a known
&gt; registered name. I am not sure how that is occurring, as vnode proxy
&gt; processes are automatically started the moment you register your vnode
&gt; module with riak\_core. Of course, there has also been some changes to
&gt; have vnode are registered with riak\_core as well. Make sure you are
&gt; registering your vnode with Riak using 'riak\_core:register'. As an
&gt; example, here's how 'riak\_kv' registers with riak\_core (see in
&gt; riak\_kv\_app.erl):
&gt; =====
&gt; riak\_core:register(riak\_kv, [
&gt; {vnode\_module, riak\_kv\_vnode},
&gt; {bucket\_validator, riak\_kv\_bucket}
&gt; ]),
&gt; =====
&gt;
&gt; You don't need a bucket\_validator if your app isn't using one, but you
&gt; must always register your vnode\_module. That call should trigger
&gt; 'register\_mod' in riak\_core.erl that should trigger a call to
&gt; riak\_core\_vnode\_proxy\_sup:start\_proxies.
&gt;
&gt; -Joe
&gt;
&gt; On Mon, Dec 19, 2011 at 10:52 AM, Jeff Thompson 
&gt; wrote:
&gt; &gt; As a project to better learn riak\_core and to think more about
&gt; distributed
&gt; &gt; problems, I've been writing a little mud app using riak\_core.
&gt; &gt;
&gt; &gt; I just updated to the latest riak\_core version and am running into a
&gt; problem
&gt; &gt; when riak\_core\_vnode\_master gets a handle\_cast.
&gt; &gt;
&gt; &gt; In the previous version handle\_cast would:
&gt; &gt;
&gt; &gt; handle\_cast(Req=?VNODE\_REQ{index=Idx}, State) -&gt;
&gt; &gt; Pid = get\_vnode(Idx, State),
&gt; &gt; gen\_fsm:send\_event(Pid, Req),
&gt; &gt; {noreply, State};
&gt; &gt;
&gt; &gt; get\_vnode:
&gt; &gt;
&gt; &gt; get\_vnode(Idx, State=#state{vnode\_mod=Mod}) -&gt;
&gt; &gt; case idx2vnode(Idx, State) of
&gt; &gt; no\_match -&gt;
&gt; &gt; {ok, Pid} = riak\_core\_vnode\_sup:start\_vnode(Mod, Idx),
&gt; &gt; MonRef = erlang:monitor(process, Pid),
&gt; &gt; add\_vnode\_rec(#idxrec{idx=Idx,pid=Pid,monref=MonRef}, State),
&gt; &gt; Pid;
&gt; &gt; X -&gt; X
&gt; &gt; end.
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; I would see the get\_vnode code successfully start my vnode and the
&gt; &gt; subsequent gen\_fsm:send\_event/2 call would succeed.
&gt; &gt;
&gt; &gt; However, the new version of get\_vnode looks like:
&gt; &gt;
&gt; &gt; handle\_cast(Req=?VNODE\_REQ{index=Idx}, State=#state{vnode\_mod=Mod}) -&gt;
&gt; &gt; Proxy = riak\_core\_vnode\_proxy:reg\_name(Mod, Idx),
&gt; &gt; gen\_fsm:send\_event(Proxy, Req),
&gt; &gt; {noreply, State};
&gt; &gt;
&gt; &gt;
&gt; &gt; and riak\_core\_vnode\_proxy:reg\_name/2 just returns an atom:
&gt; &gt;
&gt; &gt; reg\_name(Mod, Index) -&gt;
&gt; &gt; ModBin = atom\_to\_binary(Mod, latin1),
&gt; &gt; IdxBin = list\_to\_binary(integer\_to\_list(Index)),
&gt; &gt; AllBin = &lt;&lt;$p,$r,$o,$x,$y,$\_, ModBin/binary, $\_, IdxBin/binary&gt;&gt;,
&gt; &gt; binary\_to\_atom(AllBin, latin1).
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; This is resulting in a:
&gt; &gt;
&gt; &gt; {badarg,[{gen\_fsm,send\_event,2},
&gt; &gt; {riak\_core\_vnode\_master,handle\_cast,2},
&gt; &gt; {gen\_server,handle\_msg,5},
&gt; &gt; {proc\_lib,init\_p\_do\_apply,3}]}
&gt; &gt;
&gt; &gt; Based on the above, there doesn't seem to be an 'on demand' starting of
&gt; &gt; vnodes anymore?
&gt; &gt;
&gt; &gt; I'm happy to dig into this more (which I will anyway to learn whats going
&gt; &gt; on), but if there are any quick pointers that can be given as to how the
&gt; &gt; recent changes impact the writing of riak\_core vnodes and what I'm seeing
&gt; &gt; above, I would certainly appreciate it.
&gt; &gt;
&gt; &gt; Thanks!
&gt; &gt;
&gt; &gt; Jeff
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

