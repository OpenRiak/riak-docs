---
title: "Re: Riak-CS Node.js client"
description: ""
project: community
lastmod: 2015-03-09T03:07:49-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15858"
mailinglist_parent_id: "msg15799"
author_name: "Patrick F. Marques"
project_section: "mailinglistitem"
sent_date: 2015-03-09T03:07:49-07:00
---


Thanks! I'll stay tuned ;)
till there I will patch my code an pray not to introduce any issues here..
The patch is bellow for anyone to try (just send the decoded string to be
signed)

&gt;From a439f6126317a2b66fc08baf31b24b47e8ec4ed9 Mon Sep 17 00:00:00 2001
From: "Patrick F. Marques" 
Date: Thu, 26 Feb 2015 14:59:14 +0000
Subject: [PATCH] [fix]

---
 lib/signers/s3.js | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lib/signers/s3.js b/lib/signers/s3.js
index 2f49fff..604e8a0 100644
--- a/lib/signers/s3.js
+++ b/lib/signers/s3.js
@@ -73,7 +73,7 @@ AWS.Signers.S3 = inherit(AWS.Signers.RequestSigner, {

 var headers = this.canonicalizedAmzHeaders();
 if (headers) parts.push(headers);
- parts.push(this.canonicalizedResource());
+ parts.push(decodeURIComponent(this.canonicalizedResource()));

 return parts.join('\n');

On Thu, Feb 26, 2015 at 2:13 PM, Kota Uenishi  wrote:

&gt; &gt; The s3 signer uses the signs the "canonicalizedResource" and that have
&gt; the query parameters already encoded, so I tried to replace the "%3D" by
&gt; the "=" and it already works.
&gt;
&gt; Yey! The culprit is here. Most client mistakenly encodes Multipart
&gt; uploadId although it is already supposed to be url-encoded. This is
&gt; the case for #1063, too. Maybe Riak CS can be aligned to how S3
&gt; behaves to save most S3 clients - stay tuned to that issue, please.
&gt; Anyway, thank you for reporting!
&gt;
&gt;
&gt;
&gt; On Thu, Feb 26, 2015 at 9:54 PM, Patrick F. Marques
&gt;  wrote:
&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; thanks for your help Uenishi.
&gt; &gt;
&gt; &gt; I'm using Riak 1.5.2, and AWS Node.js SDK 2.1.14 and the example code I'm
&gt; &gt; running is bellow.
&gt; &gt; I have beed trying with and without forcing a singing version. With some
&gt; &gt; debug I found that the default is the use the s3 signer.... If I force
&gt; v2 I
&gt; &gt; have another error, "Cannot set property 'Timestamp' of undefined" that
&gt; is
&gt; &gt; throe by v2.js signer code, I made a simple fix but then every request
&gt; &gt; returns "Access Denied".
&gt; &gt;
&gt; &gt; The s3 signer uses the signs the "canonicalizedResource" and that have
&gt; the
&gt; &gt; query parameters already encoded, so I tried to replace the "%3D" by the
&gt; "="
&gt; &gt; and it already works.
&gt; &gt;
&gt; &gt;
&gt; &gt; // ----------------------------------
&gt; &gt;
&gt; &gt; 'use strict';
&gt; &gt;
&gt; &gt; var fs = require('fs');
&gt; &gt; var path = require('path');
&gt; &gt; var zlib = require('zlib');
&gt; &gt;
&gt; &gt; var config = {
&gt; &gt; accessKeyId: 'WDH-HCBBZONGEY2PADRC',
&gt; &gt; secretAccessKey: '9nJpf\_C3hoaGrMBbvWH\_pJ7qQT5ijrQKrN2XVg==',
&gt; &gt; // region: 'eu'
&gt; &gt;
&gt; &gt; httpOptions: {
&gt; &gt; proxy: 'http://192.168.56.100:8080'
&gt; &gt; },
&gt; &gt;
&gt; &gt; signatureVersion: 'v2'
&gt; &gt; };
&gt; &gt;
&gt; &gt; var bigfile = path.join('./', 'bigfile');
&gt; &gt; var body = fs.createReadStream(bigfile).pipe(zlib.createGzip());
&gt; &gt;
&gt; &gt; var AWS = require('aws-sdk');
&gt; &gt; var s3 = new AWS.S3(new AWS.Config(config));
&gt; &gt;
&gt; &gt; var params = {
&gt; &gt; Bucket: 'test',
&gt; &gt; Key: 'myKey',
&gt; &gt; Body: body
&gt; &gt; };
&gt; &gt;
&gt; &gt; s3.upload(params).
&gt; &gt; on('httpUploadProgress', function(evt) { console.log(evt); }).
&gt; &gt; send(function(err, data) {
&gt; &gt; console.log(err, data);
&gt; &gt; });
&gt; &gt;
&gt; &gt; // ----------------------------------
&gt; &gt;
&gt; &gt; Bets Regards,
&gt; &gt; Patrick Marques
&gt; &gt;
&gt; &gt;
&gt; &gt; On Thu, Feb 26, 2015 at 6:47 AM, Kota Uenishi  wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; Hi,
&gt; &gt;&gt;
&gt; &gt;&gt; My 6th sense says you're hitting this problem:
&gt; &gt;&gt; https://github.com/basho/riak\_cs/issues/1063
&gt; &gt;&gt;
&gt; &gt;&gt; Could you give me an example of code or debug print of Node.js client
&gt; that
&gt; &gt;&gt; includes the source string before being signed by a secret key?
&gt; &gt;&gt;
&gt; &gt;&gt; Otherwise maybe that client is just using v4 authentication which we
&gt; &gt;&gt; haven't yet supported. To avoid it, please try v2 authentication.
&gt; &gt;&gt;
&gt; &gt;&gt; 2015/02/26 9:06 "Patrick F. Marques" :
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Hi everyone,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I'm trying to use AWS SDK as a S3 client for Riack CS to upload large
&gt; &gt;&gt;&gt; objects that I usually don't know the its size, for that propose I'm
&gt; trying
&gt; &gt;&gt;&gt; to use the multipart upload like in the SDK example
&gt; &gt;&gt;&gt;
&gt; https://github.com/aws/aws-sdk-js/blob/master/doc-src/guide/node-examples.md#amazon-s3-uploading-an-arbitrarily-sized-stream-upload
&gt; .
&gt; &gt;&gt;&gt; The problem is that I'm always getting Access Denied.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I've been trying some other clients but also without success.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Best regards,
&gt; &gt;&gt;&gt; Patrick Marques
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
&gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
&gt; &gt;&gt;&gt;
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt;
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

