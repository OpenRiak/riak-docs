---
title: "High Swap Utilization of Riak"
description: ""
project: community
lastmod: 2012-03-16T11:38:47-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06984"
author_name: "Ken Perkins"
project_section: "mailinglistitem"
sent_date: 2012-03-16T11:38:47-07:00

---


Hello, 

I'm trying to diagnose why we're using so much swap memory for Riak+Search, and 
derive what settings should be changed such that we can lower our memory 
utilization. Obviously we can scale up our riak boxes, but I'd like to have 
better insight into the settings before we just upgrade the machines.

We have a 512 partition 5 node ring with LevelDb Backend, Search enabled.

Currently we're seeing 100% of all available physical ram consumed by riak 
(1.7gb) and a large swap use as well: ~3.6gb:

riak 2677 1.7 85.1 3665736 1745696 pts/0 Ssl+ Mar12 109:16 
/usr/lib/riak/erts-5.8.4/bin/beam.smp -K true -A 64 -W w --

My my computations according to http://wiki.basho.com/LevelDB.html we should be 
at around ~850mb of ram for the levelDb cache. I calculate another ~128 for JS 
VMs, but I have no way to figure out where the rest is used.

How do we figure out where the rest of the memory is being consumed, and how 
can we tune it to use less memory?

Excerpt from config:

%% Riak KV config
 {riak\_kv, [
 {storage\_backend, riak\_kv\_eleveldb\_backend},
 {pb\_ip, "<%= bindRiakAddress %>" },
 {pb\_port, 8087 },
...
 {map\_js\_vm\_count, 8 },
 {reduce\_js\_vm\_count, 6 },
 {hook\_js\_vm\_count, 2 },
 {js\_max\_vm\_mem, 8},
 {js\_thread\_stack, 16},
 %{js\_source\_dir, "/tmp/js\_source"},
 {http\_url\_encoding, on},
 {riak\_kv\_stat, true},
 {legacy\_stats, true},
 {vnode\_vclocks, true},
 {legacy\_keylisting, false},
 ...
 ]},

 %% Riak Search Config
 {riak\_search, [
 {enabled, true}
 ]},

 %% Merge Index Config
 {merge\_index, [
 {data\_root, "/var/lib/riak/merge\_index"},
 {data\_root\_2i, "/var/lib/riak/merge\_index\_2i"},
 {buffer\_rollover\_size, 1048576},
 {max\_compact\_segments, 20}
 ]},

 %% Bitcask Config
 {bitcask, [
 {data\_root, "/var/lib/riak/bitcask"}
 ]},

 %% eLevelDB Config
 {eleveldb, [
 {data\_root, "/var/lib/riak/leveldb"}
 ]},


--Ken
clipboard, inc. 
we're hiring!: www.clipboard.com/jobs

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

