---
title: "riak-search corruption causing multiple nodes to crash"
description: ""
project: community
lastmod: 2012-08-29T08:03:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08392"
author_name: "Robby Grossman"
project_section: "mailinglistitem"
sent_date: 2012-08-29T08:03:17-07:00

---


We have a riak cluster on EC2 (large instances, ephemeral storage, ~5 nodes 
though currently 7 after some shuffling) that's seen multiple nodes go down 
over the last week due to corrupted merge\_indexes. Certain boxes go down more 
frequently than others, but it's not predictable and it seems like any 
arbitrary box can be affected. The errors look similar to what I read about in 
this thread:

http://lists.basho.com/pipermail/riak-users\_lists.basho.com/2012-July/008933.html

except that it's occurring on multiple nodes, which prevents us from doing 
repairs from adjacent nodes.

I've tried a few things:

- Stop riak on single box, clear out merge\_index/, restart riak. This works for 
several hours to about a day, but it eventually becomes corrupt again.
- Stopping all nodes, clearing out all merge\_index folders, restarting all 
nodes. Like above, this works for several hours but eventually we see corrupted 
merge indexes again. And obviously, this loses all past index data, so even if 
it worked it wouldn't be a suitable solution. I just needed to stop the nodes 
from going down.
- Using Ryan Zezeski's script to detect bad MI files - there are too many for 
this to be a sustainable ongoing effort, though. https://gist.github.com/3250870

I spoke to Tom Santero who hypothesized that there could be something 
underlying in the EC2 infrastructure that's causing some corruption problems. 
We don't have a ticket off of EC2 right now, but what I am doing (as I write 
this) is widening the cluster to span three availability zones (all in 
US-East). My thinking is that if we continue to see problems but they' re all 
in a specific zone, that would confirm Tom's hypothesis (though the alternative 
would not disprove it).

Below is some sample error.log/crash.log output. I'd be appreciative if anybody 
has thoughts as to what is causing these problems, or further tests I can run 
to diagnose/troubleshoot.

Thanks in advance,
Robby

error.log:
2012-08-29 04:50:01.829 [error] <0.1909.0> CRASH REPORT Process <0.1909.0> with 
0 neighbours exited with reason: bad argument in call to 
erlang:binary\_to\_term(<<131,108,0,0,0,4,104,4,
104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,...>>) in 
mi\_buffer:read\_value/2 line 162 in gen\_server:init\_it/6 line 328
2012-08-29 04:50:01.833 [error] <0.1908.0> CRASH REPORT Process <0.1908.0> with 
0 neighbours exited with reason: no match of right hand value 
{error,{badarg,[{erlang,binary\_to\_term,[<
<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,2,115,111,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98
,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,39,106,104,4,104,3,109,0,0,0,5,108,105,110,107,
115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,16,83,116,97,121,45,...>>],...},...]}}
 in merge\_index\_backend:start/2 line 47 in gen\_fsm:init\_it/6 line 379
2012-08-29 04:50:01.836 [error] <0.154.0> Supervisor riak\_core\_vnode\_sup had 
child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
<0.1908.0> exit with reason no matc
h of right hand value 
{error,{badarg,[{erlang,binary\_to\_term,[<<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0
,0,2,115,111,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,
0,1,112,107,0,1,39,106,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,16,83,116,97,121,45,...>>],...},...]}}
 in merge\_index\_
backend:start/2 line 47 in context child\_terminated
2012-08-29 04:50:01.839 [error] <0.1906.0> gen\_server riak\_core\_vnode\_manager 
terminated with reason: no match of right hand value 
{error,{{badmatch,{error,{badarg,[{erlang,binary\_to\_
term,[<<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,2,115,111,109,0,0,0,32,55,100,51,97,55,48,50,54,56,10
1,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,39,106,104,4,104,3,109,0,0,0,5,108,105,1
10,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,...>>],...},...]}}},...}}
 in riak\_core\_vnode\_manager:get\_vnode/3 line 489
2012-08-29 04:50:01.858 [error] <0.1906.0> CRASH REPORT Process 
riak\_core\_vnode\_manager with 0 neighbours exited with reason: no match of right 
hand value {error,{{badmatch,{error,{ba
darg,[{erlang,binary\_to\_term,[<<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,2,115,111,109,0,0,0,32,55,100
,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,39,106,104,4,104
,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,...>>],...},...]}}},...}}
 in riak\_core\_vnode\_manager:get\_vnode/3 line 489 in gen\_serve
r:terminate/6 line 747
2012-08-29 04:50:01.881 [error] <0.152.0> Supervisor riak\_core\_sup had child 
riak\_core\_vnode\_manager started with riak\_core\_vnode\_manager:start\_link() at 
<0.1906.0> exit with reason n
o match of right hand value 
{error,{{badmatch,{error,{badarg,[{erlang,binary\_to\_term,[<<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110
,111,116,101,115,109,0,0,0,2,115,111,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,
4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,39,106,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,...>>],...},...]}}},...}}
 in r
iak\_core\_vnode\_manager:get\_vnode/3 line 489 in context child\_terminated


crash.log:
2012-08-29 04:48:19 =CRASH REPORT====
 crasher:
 initial call: riak\_core\_vnode\_manager:init/1
 pid: <0.3501.0>
 registered\_name: riak\_core\_vnode\_manager
 exception exit: 
{{{badmatch,{error,{{badmatch,{error,{badarg,[{erlang,binary\_to\_term,[<<131,108,0,0,0,4,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95
,110,111,116,101,115,109,0,0,0,2,115,111,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,
200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,39,106,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,10,108,105,110,107,95,110,111,116,101,115,109,0,0,0,16,83,116,97,121,45,97,116
,45,72,111,109,101,45,77,111,109,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,10
8,0,0,0,1,104,2,100,0,1,112,107,0,1,31,106,104,4,104,3,109,0,0,0,5,108,105,110,107,115,109,0,0,0,2,104,49,109,0,0,0,3,99,111,109,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,
100,99,98,101,55,102,100,102,52,54,51,54,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,1,0,106,104,4,104,3,109,0,0,0,5,108,105,110,107,115,1
09,0,0,0,9,116,105,109,101,115,116,97,109,112,109,0,0,0,10,49,51,52,54,50,48,52,51,53,52,109,0,0,0,32,55,100,51,97,55,48,50,54,56,101,56,98,52,100,99,98,101,55,102,100,102,52,54,51,54
,98,50,50,102,49,56,97,110,7,1,238,11,38,162,93,200,4,108,0,0,0,1,104,2,100,0,1,112,107,0,0,0,1,43>>],[]},{mi\_buffer,read\_value,2,[{file,"src/mi\_buffer.erl"},{line,162}]},{mi\_buffer,o
pen\_inner,3,[{file,"src/mi\_buffer.erl"},{line,70}]},{mi\_buffer,new,1,[{file,"src/mi\_buffer.erl"},{line,62}]},{mi\_server,read\_buffers,4,[{file,"src/mi\_server.erl"},{line,613}]},{mi\_ser
ver,read\_buf\_and\_seg,1,[{file,"src/mi\_server.erl"},{line,585}]},{mi\_server,init,1,[{file,"src/mi\_server.erl"},{line,143}]},{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line,304}]}]
}}},[{merge\_index\_backend,start,2,[{file,"src/merge\_index\_backend.erl"},{line,47}]},{riak\_search\_vnode,init,1,[{file,"src/riak\_search\_vnode.erl"},{line,135}]},{riak\_core\_vnode,init,1,
[{file,"src/riak\_core\_vnode.erl"},{line,123}]},{gen\_fsm,init\_it,6,[{file,"gen\_fsm.erl"},{line,361}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}}},[{riak\_core\_vn
ode\_manager,get\_vnode,3,[{file,"src/riak\_core\_vnode\_manager.erl"},{line,489}]},{riak\_core\_vnode\_manager,maybe\_trigger\_handoff,3,[{file,"src/riak\_core\_vnode\_manager.erl"},{line,613}]},
{riak\_core\_vnode\_manager,'-trigger\_ownership\_handoff/3-lc$^2/1-2-',2,[{file,"src/riak\_core\_vnode\_manager.erl"},{line,448}]},{riak\_core\_vnode\_manager,trigger\_ownership\_handoff,3,[{file
,"src/riak\_core\_vnode\_manager.erl"},{line,448}]},{riak\_core\_vnode\_manager,handle\_cast,2,[{file,"src/riak\_core\_vnode\_manager.erl"},{line,378}]},{gen\_server,handle\_msg,5,[{file,"gen\_ser
ver.erl"},{line,607}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]},[{gen\_server,terminate,6,[{file,"gen\_server.erl"},{line,747}]},{proc\_lib,init\_p\_do\_apply,3,[{f
ile,"proc\_lib.erl"},{line,227}]}]}
 ancestors: [riak\_core\_sup,<0.150.0>]
 messages: []
 links: [<0.151.0>]
 dictionary: []
 trap\_exit: false



-- 
Robby Grossman
@freerobby (http://twitter.com/freerobby)
http://rob.by (http://rob.by/)


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

