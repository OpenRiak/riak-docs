---
title: "Re: Search Crashes"
description: ""
project: community
lastmod: 2013-11-20T10:16:59-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg13036"
mailinglist_parent_id: "msg13010"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2013-11-20T10:16:59-08:00
---


Hi Gabriel,

First, let me verify a few things.

1. You are on Riak 1.4? Which patch version? 1.4.2?

2. You recently upgraded you client? Did you have any of these failures
before upgrading the client?

3. Have you made any other changes between the time your system was working
and the time it started exhibiting these failures? For example, set
allow\_mult=true?

Given that you are having 'badmatch' hook crashes during insert I have the
suspicion that allow\_mult was recently changed to true as the Riak Search
hook cannot deal with siblings. What does the following curl show:

curl 'http://host:port/buckets/ctv\_tvdata/props'

If that has 'allow\_mult: true' then that is your issue.

As for your search operations. I'm not sure why they are failing. If you
want you could tar.gz all the logs for each node and email that to me.

-Z


On Mon, Nov 18, 2013 at 7:00 PM, Gabriel Littman  wrote:

> Hi All,
>
> We've been working with a search enabled bucket in riak for a while now
> and off and on it has been giving us trouble. In the past it has been
> solved by reindexing all the data by just reading and writing the data back
> into riak. But even this is failing now on some input data. Any
> help/insite would be greatly appreciated.
>
> We are on riak 1.4
> We have recently switched to riak python api 2.0
>
> smrtv@fre-prod-svr15:~$ python
> Python 2.7.3 (default, Aug 1 2012, 05:14:39)
> [GCC 4.6.3] on linux2
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import riak
> >>> r = riak.RiakClient()
> >>> b = r.bucket('ctv\_tvdata')
> >>> o = b.get('/data/v2/search\_show/TMS.Show.9838380')
> >>> o.data
> {'type': 'show', 'expires': '9999999999', 'subject\_name': 'Monsters vs.
> Aliens', 'sub\_type': 'Series', 'topic':
> '\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346', 'person':
> '\_\_None\_\_', 'searchable\_key': 'aliens vs monstersvsaliens monsters',
> 'date': '2013-11-23', 'sport': '\_\_None\_\_', 'genre': 'Children', 'id':
> '/data/v2/search\_show/TMS.Show.9838380'}
> >>> o.store()
> Traceback (most recent call last):
> File "", line 1, in 
> File "/usr/local/lib/python2.7/dist-packages/riak/riak\_object.py", line
> 281, in store
> timeout=timeout)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 127, in wrapper
> return self.\_with\_retries(pool, thunk)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 69, in \_with\_retries
> return fn(transport)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 125, in thunk
> return fn(self, transport, \*args, \*\*kwargs)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
> line 289, in put
> timeout=timeout)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/http/transport.py",
> line 144, in put
> return self.\_parse\_body(robj, response, [200, 201, 204, 300])
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/http/codec.py",
> line 64, in \_parse\_body
> self.check\_http\_code(status, expected\_statuses)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/http/transport.py",
> line 446, in check\_http\_code
> (expected\_statuses, status))
> Exception: Expected status [200, 201, 204, 300], received 500
>
> Using protocol buffs gives an erlang riak\_search\_kv\_hook,precommit,error:
>
> >>> r = riak.RiakClent(protocol='pcb')
> Traceback (most recent call last):
> File "", line 1, in 
> AttributeError: 'module' object has no attribute 'RiakClent'
> >>> r = riak.RiakClient(protocol='pcb')
> Traceback (most recent call last):
> File "", line 1, in 
> File "/usr/local/lib/python2.7/dist-packages/riak/client/\_\_init\_\_.py",
> line 99, in \_\_init\_\_
> self.protocol = protocol or 'http'
> File "/usr/local/lib/python2.7/dist-packages/riak/client/\_\_init\_\_.py",
> line 118, in \_set\_protocol
> repr(self.PROTOCOLS))
> ValueError: protocol option is invalid, must be one of ['http', 'https',
> 'pbc']
> >>> r = riak.RiakClient(protocol='pbc')
> >>> b = r.bucket('ctv\_tvdata')
> >>> o = b.get('/data/v2/search\_show/TMS.Show.9838380')
> >>> o.store()
> Traceback (most recent call last):
> File "", line 1, in 
> File "/usr/local/lib/python2.7/dist-packages/riak/riak\_object.py", line
> 281, in store
> timeout=timeout)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 127, in wrapper
> return self.\_with\_retries(pool, thunk)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 69, in \_with\_retries
> return fn(transport)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 125, in thunk
> return fn(self, transport, \*args, \*\*kwargs)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
> line 289, in put
> timeout=timeout)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/transport.py",
> line 194, in put
> MSG\_CODE\_PUT\_RESP)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
> line 43, in \_request
> return self.\_recv\_msg(expect)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
> line 55, in \_recv\_msg
> raise RiakError(err.errmsg)
> riak.RiakError: '{precommit\_fail,\n {hook\_crashed,\n
> {riak\_search\_kv\_hook,precommit,error,\n {badmatch,\n
> [{{dict,3,16,16,8,80,48,\n
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},\n
> {{[],[],[],[],[],[],[],[],[],[],\n
> [[<<"X-Riak-VTag">>,50,90,85,77,113,86,72,111,75,121,\n
> 86,89,72,118,114,103,70,70,114,55,88,52]],\n
> [[<<"index">>]],\n [],\n
> [[<<"X-Riak-Last-Modified">>|{1384,276502,759295}]],\n
> [],[]}}},\n {riak\_idx\_doc,<<"ctv\_tvdata">>,\n
> <<"/data/v2/search\_show/TMS.Show.9838380">>,\n
> [{<<"date">>,<<"2013-11-23">>,[{<<"2013-11-23">>,[0]}]},\n
> {<<"expires">>,<<"9999999999">>,\n
> [{<<"9999999999">>,[0]}]},\n
> {<<"genre">>,<<"Children">>,[{<<"Children">>,[0]}]},\n
> {<<"id">>,<<"/data/v2/search\_show/TMS.Show.9838380">>,\n
> [{<<"/data/v2/search\_show/TMS.Show.9838380">>,[0]}]},\n
> {<<"person">>,<<"\_\_None\_\_">>,[{<<"\_\_None\_\_">>,[0]}]},\n
> {<<"searchable\_key">>,\n <<"aliens vs
> monstersvsaliens monsters">>,\n
> [{<<"monsters">>,[3]},\n {<<"vs">>,[1]},\n
> {<<"aliens">>,[0]},\n
> {<<"monstersvsaliens">>,[2]}]},\n
> {<<"sport">>,<<"\_\_None\_\_">>,[{<<"\_\_None\_\_">>,[0]}]},\n
> {<<"sub\_type">>,<<"Series">>,[{<<"Series">>,[0]}]},\n
> {<<"subject\_name">>,<<"Monsters vs. Aliens">>,\n
> [{<<"vs.">>,[1]},\n {<<"Monsters">>,[0]},\n
> {<<"Aliens">>,[2]}]},\n
> {<<"topic">>,\n
> <<"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346">>,\n
>
> [{<<"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.854346">>,\n
> [0]}]},\n
> {<<"type">>,<<"show">>,[{<<"show">>,[0]}]}],\n [],\n
> [{<<"expires">>,<<"9999999999">>,[<<"9999999999">>]},\n
> {<<"type">>,<<"show">>,[<<"show">>]}],\n
> true}},\n {{dict,3,16,16,8,80,48,\n
> {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},\n
> {{[],[],[],[],[],[],[],[],[],[],\n
> [[<<"X-Riak-VTag">>,54,99,78,89,53,77,108,102,82,57,\n
> 81,88,69,107,104,72,74,98,81,72,114,66]],\n
> [[<<"index">>]],\n [],\n
> [[<<"X-Riak-Last-Modified">>|{1384,276502,759064}]],\n
> [],[]}}},\n {riak\_idx\_doc,<<"ctv\_tvdata">>,\n
> <<"/data/v2/search\_show/TMS.Show.9838380">>,\n
> [{<<"date">>,<<"2013-11-23">>,[{<<"2013-11-23">>,[0]}]},\n
> {<<"expires">>,<<"9999999999">>,\n
> [{<<"9999999999">>,[0]}]},\n
> {<<"genre">>,<<"Children">>,[{<<"Children">>,[0]}]},\n
> {<<"id">>,<<"/data/v2/search\_show/TMS.Show.9838380">>,\n
> [{<<"/data/v2/search\_show/TMS.Show.9838380">>,[0]}]},\n
> {<<"person">>,<<"\_\_None\_\_">>,[{<<"\_\_None\_\_">>,[0]}]},\n
> {<<"searchable\_key">>,\n <<"aliens vs
> monstersvsaliens monsters">>,\n
> [{<<"monsters">>,[3]},\n {<<"vs">>,[1]},\n
> {<<"aliens">>,[0]},\n
> {<<"monstersvsaliens">>,[2]}]},\n
> {<<"sport">>,<<"\_\_None\_\_">>,[{<<"\_\_None\_\_">>,[0]}]},\n
> {<<"sub\_type">>,<<"Series">>,[{<<"Series">>,[0]}]},\n
> {<<"subject\_name">>,<<"Monsters vs. Aliens">>,\n
> [{<<"vs.">>,[1]},\n {<<"Monsters">>,[0]},\n
> {<<"Aliens">>,[2]}]},\n
> {<<"topic">>,\n
> <<"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.846692">>,\n
>
> [{<<"\_\_ref--/data/v2/topic/TMS.Show.9838380:r1384276501.846692">>,\n
> [0]}]},\n
> {<<"type">>,<<"show">>,[{<<"show">>,[0]}]}],\n [],\n
> [{<<"expires">>,<<"9999999999">>,[<<"9999999999">>]},\n
> {<<"type">>,<<"show">>,[<<"show">>]}],\n
> true}}]}}}}'
>
> Any search that would returns a resource that acts this way similarly
> fails:
>
> >>> r.fulltext\_search('ctv\_tvdata', "searchable\_key:monstersvsaliens")
> XXXXXXXXXXXXXXXXXXXXXXXX q: "searchable\_key:monstersvsaliens"
> index: "ctv\_tvdata"
>
> Traceback (most recent call last):
> File "", line 1, in 
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 127, in wrapper
> return self.\_with\_retries(pool, thunk)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 69, in \_with\_retries
> return fn(transport)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/transport.py",
> line 125, in thunk
> return fn(self, transport, \*args, \*\*kwargs)
> File "/usr/local/lib/python2.7/dist-packages/riak/client/operations.py",
> line 410, in fulltext\_search
> return transport.search(index, query, \*\*params)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/transport.py",
> line 443, in search
> MSG\_CODE\_SEARCH\_QUERY\_RESP)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
> line 43, in \_request
> return self.\_recv\_msg(expect)
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
> line 50, in \_recv\_msg
> self.\_recv\_pkt()
> File
> "/usr/local/lib/python2.7/dist-packages/riak/transports/pbc/connection.py",
> line 71, in \_recv\_pkt
> % len(nmsglen))
> riak.RiakError: 'Socket returned short packet length 0 - expected 4'
>
>
> I also see errors like this in my crash and error logs:
>
> 2013-11-18 23:49:49.705 [error] emulator Error in process <0.17776.914> on
> node 'riak@10.1.2.95' with exit value:
> {{badmatch,[{{dict,3,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[<<11
> bytes>>,52,75,67,79,55,114,90,110,69,77,50,53,121,67,112,76,85,83,113,74,115,104]],[[<<5
> bytes>>]],[],[[<<20
> bytes>>|{1384,346717,469237}]],[],[]}}},{riak\_idx\_doc,<<10 bytes>>,<<36
> bytes>>,[{<<4 bytes>>,<<8 bytes>>,[{<<8 bytes>>,[0]}]},{<<7 bytes>>,<<10
> bytes>>,[{<<10 bytes>>,[0]}]},{<<5 bytes>>,<<6 bytes>>,[{<<6
> bytes>>,[0]}]},{<<2 bytes>>,<<36 bytes>>,[{<<36 bytes>>,[0]}]},{<<6
> bytes>>,<<8 bytes>>,[{<<8 bytes>>,[0]}]},{<<14 bytes>>,<<45 bytes>>,[{<<7
> bytes>>,[0]},{<<5 bytes>>,[1]},{<<9 bytes>>,[2]},{<<21 bytes>>,[3]}]},{<<5
> bytes>>,<<3 bytes>>,[{<<3 bytes>>,[0]}]},{<<8 bytes>>,<<8 bytes>>,[{<<8
> bytes>>,[0]}]},{<<12 bytes>>,<<23 bytes>>,[{<<5 bytes>>,[1]},{<<9
> bytes>>,[2]},{<<7 bytes>>,[...
>
>
> 2013-11-18 23:49:49.834 [error] emulator Error in process <0.18173.914> on
> node 'riak@10.1.2.95' with exit value:
> {{badmatch,[{{dict,3,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[<<11
> bytes>>,52,75,67,79,55,114,90,110,69,77,50,53,121,67,112,76,85,83,113,74,115,104]],[[<<5
> bytes>>]],[],[[<<20
> bytes>>|{1384,346717,469237}]],[],[]}}},{riak\_idx\_doc,<<10 bytes>>,<<36
> bytes>>,[{<<4 bytes>>,<<8 bytes>>,[{<<8 bytes>>,[0]}]},{<<7 bytes>>,<<10
> bytes>>,[{<<10 bytes>>,[0]}]},{<<5 bytes>>,<<6 bytes>>,[{<<6
> bytes>>,[0]}]},{<<2 bytes>>,<<36 bytes>>,[{<<36 bytes>>,[0]}]},{<<6
> bytes>>,<<8 bytes>>,[{<<8 bytes>>,[0]}]},{<<14 bytes>>,<<45 bytes>>,[{<<7
> bytes>>,[0]},{<<5 bytes>>,[1]},{<<9 bytes>>,[2]},{<<21 bytes>>,[3]}]},{<<5
> bytes>>,<<3 bytes>>,[{<<3 bytes>>,[0]}]},{<<8 bytes>>,<<8 bytes>>,[{<<8
> bytes>>,[0]}]},{<<12 bytes>>,<<23 bytes>>,[{<<5 bytes>>,[1]},{<<9
> bytes>>,[2]},{<<7 bytes>>,[...
>
>
> My search schema currently looks like this:
>
> %% Custom schema for our index
> %% See: http://10.1.3.100:8090/display/REST/Search for some background on
> how we index/search
>
> {
> schema,
> [
> {version, "1.1"},
> {n\_val, 3},
> {default\_op, "and"},
> {default\_field, "searchable\_key"},
> {analyzer\_factory, {erlang, text\_analyzers,
> whitespace\_analyzer\_factory}}
> ],
> [
> %% main field for searching
> {field, [
> {name, "searchable\_key"},
> {type, string}
> ]},
>
> %% In order to use filter queries to reduce the result set to
> %% specific object 'types' or with 'expires' >= now, we need
> %% to make these fields "inline".
>
> {field, [
> {name, "type"},
> {type, string},
> {inline, true}
> ]},
>
> {field, [
> {name, "expires"},
> {type, string},
> {inline, true}
> ]},
>
> {field, [
> {name, "likes\_count"},
> {type, string},
> {padding\_size, 10}
> ]},
>
> {field, [
> {name, "timestamp"},
> {type, string},
> {inline, true}
> ]},
>
> %% Our catch all...
> {dynamic\_field, [
> {name, "\*"},
> {type, string}
> ]}
>
> %% Field names ending in "\_text" are indexed as full text"
> %% DAVE: just keeping this paragraph for reference
> %{dynamic\_field, [
> % {name, "\*\_text"},
> % {type, string},
> % {analyzer\_factory, {erlang, text\_analyzers,
> standard\_analyzer\_factory}}
> %]},
>
> %% The original catch all...
> %% Everything else is a string
> %{dynamic\_field, [
> %{name, "\*"},
> %{type, string},
> %{analyzer\_factory, {erlang, text\_analyzers,
> whitespace\_analyzer\_factory}}
> %]}
> ]
> }.
>
>
> I'm seeing this kind of thing in both my stage and production
> environments. As far as I can tell my search index is corrupted but I'm
> not sure how it's gotten this way. Again any help is appreciated. What
> is the wrong? How can I fix it? What could have caused it?
>
> Thanks,
>
> Gabe
>
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>
>
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

