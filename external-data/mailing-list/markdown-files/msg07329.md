---
title: "Intermittent MapReduce crashes (reserve_vm)"
description: ""
project: community
lastmod: 2012-04-25T22:36:40-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07329"
author_name: "Brian Conway"
project_section: "mailinglistitem"
sent_date: 2012-04-25T22:36:40-07:00

---


I have a test cluster of 3 nodes running locally (virtualized), with
default configuration + eleveldb. The nodes have plenty of ram and
never hit swap. I've already bumped up the JS VM count (8 -> 24) after
getting preflist\_exhausted errors, and I now get the follow
intermittently when posting to /mapred:

$ curl -X POST http://10.236.174.131:8098/mapred -H "Content-Type:
application/json" -d @volume.js
{"phase":3,"error":"{noproc,{gen\_server,call,[riak\_kv\_js\_map,{reserve\_vm,<11534.1650.0>},infinity]}}","input":"{ok,{r\_object,<<\"vol\">>,<<\"6724\_2012-01-21\_18\">>,[{r\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[<<\"content-type\">>,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[<<\"X-Riak-VTag\">>,52,68,111,85,117,98,80,99,106,114,79,106,71,115,107,118,85,67,88,117,68,107]],[[<<\"index\">>]],[],[[<<\"X-Riak-Last-Modified\">>|{1335,385687,399828}]],[],[]}}},<<\"{\"dlid\":
\"1\", \"rate\": \"0.08\", \"cnid\":
\"...\">>}],...},...}","type":"exit","stack":"[{gen\_server,call,3},{riak\_kv\_js\_manager,blocking\_dispatch,4},{riak\_kv\_mrc\_map,map\_js,3},{riak\_kv\_mrc\_map,process,3},{riak\_pipe\_vnode\_worker,process\_input,3},{riak\_pipe\_vnode\_worker,wait\_for\_input,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]"}

This only seems to happen every two or three attempts, the rest
complete successfully. Doing the same with Python and protocol buffers
also gives inconsistent results. Those attempts sometimes work and
sometimes throws off errors that are either the same as above, or like
these (may be unrelated):

...
 File 
"/home/bconway/scratch/riakenv/lib/python2.6/site-packages/riak/transports/pbc.py",
line 535, in recv\_pkt
 % len(nmsglen))
riak.RiakError: 'Socket returned short packet length 3 - expected 4'

...
 File 
"/home/bconway/scratch/riakenv/lib/python2.6/site-packages/riak/transports/pbc.py",
line 535, in recv\_pkt
 % len(nmsglen))
riak.RiakError: 'Socket returned short packet length 1 - expected 4'

The MapReduce itself is wide but fairly simple: 10 user bucket-key
pairs, a few layers of links, and dump the final data:

$ cat volume.js
{"inputs":[["user","1672\_2012-01"],["user","2672\_2012-01"],["user","3672\_2012-01"],["user","4672\_2012-01"],["user","5672\_2012-01"],["user","6672\_2012-01"],["user","672\_2012-01"],["user","6723\_2012-01"],["user","6724\_2012-01"],["user","6725\_2012-01"]],
 "query":[{"link":{"tag":"day"}},
 {"link":{"tag":"usage"}},
 {"link":{"tag":"contact"}},
 {"map":{
 "language":"javascript",
 "name":"Riak.mapValuesJson"
 }}
 ]
}

The logs are fairly chatty, let me know what else I should add:

\*\* Reason for termination ==
\*\* 
{{{badmatch,[]},[{riak\_kv\_js\_manager,needs\_reload,2},{riak\_kv\_js\_manager,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]},{gen\_server,call,[riak\_kv\_js\_map,{mark\_idle,<0.1756.0>},infinity]}}
2012-04-26 00:18:18 =CRASH REPORT====
 crasher:
 initial call: riak\_kv\_js\_vm:init/1
 pid: <0.1756.0>
 registered\_name: []
 exception exit:
{{{badmatch,[]},[{riak\_kv\_js\_manager,needs\_reload,2},{riak\_kv\_js\_manager,handle\_call,3},{gen\_server,handle\_msg,5},{proc\_lib,init\_p\_do\_apply,3}]},{gen\_server,call,[riak\_kv\_js\_map,{mark\_idle,<0.1756.0>},infinity]}}
 in function gen\_server:terminate/6
 in call from proc\_lib:init\_p\_do\_apply/3
 ancestors: [riak\_kv\_js\_sup,riak\_kv\_sup,<0.256.0>]
 messages: 
[{'DOWN',#Ref<0.0.0.149247>,process,<0.1753.0>,{timeout,{gen\_server,call,[<0.1764.0>,{checkout\_to,<0.2736.0>},1000]}}}]
 links: [<0.275.0>]
 dictionary: []
 trap\_exit: false
 status: running
 heap\_size: 1597
 stack\_size: 24
 reductions: 627539
 neighbours:

Thanks for any help.

Brian Conway

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

