---
title: "Re: Javascript MapReduce fails Erlang succeeds"
description: ""
project: community
lastmod: 2013-08-15T15:34:55-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12055"
mailinglist_parent_id: "msg12049"
author_name: "Chris Meiklejohn"
project_section: "mailinglistitem"
sent_date: 2013-08-15T15:34:55-07:00
---


Hi Doug,

I've configured a Riak 1.2 cluster, and run the aforementioned map-reduce
job in Erlang and I can't trigger the crash. I'm getting the expected
results of the map/reduce job. How did you send me the object that you
provided off-list?

- Chris


On Thu, Aug 15, 2013 at 12:36 PM, Chris Meiklejohn wrote:

> Hi Doug,
>
> Can you provide a sample of the JSON that you're storing in these objects?
> It appears that mochijson2's tokenizer is crashing because it thinks the
> JSON is not valid, where the Spidermonkey parsing is succeeding.
>
> - Chris
>
>
> On Wed, Aug 14, 2013 at 10:58 AM, Doug Read  wrote:
>
>> The following MapReduce job fails using javascript but succeeds when
>> using erlang.
>>
>> Riak 1.2.0 2012-0806 Debian x86\_64
>> 3 nodes, n\_val=3
>>
>> Riak diag gives large list of
>> [warning] The following preflists do not satisfy the n\_val:
>> Not really sure what this means but thought i would share.
>>
>> JAVASCRIPT:
>> curl -XPOST http://localhost:8098/mapred -H 'Content-Type:
>> application/json' -d '{"inputs":[ [ "aaaaaaaa-4536-9048-87ef2e48ddda",
>> "key\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71" ] ], "query":[ { "map": {
>> "name": "Riak.mapValuesJson", "language": "javascript" } }, { "reduce": {
>> "name": "Riak.filterNotFound", "language": "javascript" } } ] }'
>>
>> JAVASCRIPT RESULT:
>>
>> {"phase":0,"error":"{{{badmatch,any},[{js\_mochijson2,tokenize,2,[{file,\"src/js\_mochijson2.erl\"},{line,507}]},{js\_mochijson2,decode1,2,[{file,\"src/js\_mochijson2.erl\"},{line,277}]},{js\_mochijson2,json\_decode,2,[{file,\"src/js\_mochijson2.erl\"},{line,272}]},{js\_driver,eval\_js,3,[{file,\"src/js\_driver.erl\"},{line,150}]},{riak\_kv\_js\_vm,invoke\_js,3,[{file,\"src/riak\_kv\_js\_vm.erl\"},{line,275}]},{riak\_kv\_js\_vm,handle\_call,3,[{file,\"src/riak\_kv\_js\_vm.erl\"},{line,144}]},{gen\_server,handle\_msg,5,[{file,\"gen\_server.erl\"},{line,...}]},...]},...}","input":"{ok,{r\_object,<<\"aaaaaaaa-50d7-4536-9048-87ef2e48ddda\">>,<<\"key\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71\">>,[{r\_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[<<\"Links\">>]],[],[],[],[],[],[],[],[[<<\"content-type\">>,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[<<\"X-Riak-VTag\">>,54,69,114,82,65,97,76,65,65,73,82,102,48,73,102,104,114,102,102,112,103,109]],[[<<\"index\">>]],[],[[<<\"X-Riak-Last-Modified\">>|{1375,51580,339577}]],[],[[<<...>>]]}}},...}],...},...}","type":"exit","stack":"[{gen\_server,call,3,[{file,\"gen\_server.erl\"},{line,188}]},{riak\_kv\_mrc\_map,map\_js,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,192}]},{riak\_kv\_mrc\_map,process,3,[{file,\"src/riak\_kv\_mrc\_map.erl\"},{line,140}]},{riak\_pipe\_vnode\_worker,process\_input,3,[{file,\"src/riak\_pipe\_vnode\_worker.erl\"},{line,445}]},{riak\_pipe\_vnode\_worker,wait\_for\_input,2,[{file,\"src/riak\_pipe\_vnode\_worker.erl\"},{line,377}]},{gen\_fsm,handle\_msg,7,[{file,\"gen\_fsm.erl\"},{line,494}]},{proc\_lib,init\_p\_do\_apply,3,[{file,\"proc\_lib...\"},...]}]"}
>>
>>
>> ERLANG:
>> curl -XPOST http://localhost:8098/mapred -H 'Content-Type:
>> application/json' -d '{"inputs":[ [ "aaaaaaaa-50d7-4536-9048-87ef2e48ddda",
>> "key\_5ad26d0d-4d28-40ca-afcb-1c9895cc5c71" ] ],
>> "query":[{"map":{"language":"erlang","module":"riak\_kv\_mapreduce","function":"map\_object\_value"}}
>> ] }'
>>
>> ERLANG RESULT:
>> [{"key":"value"}]
>>
>> Any ideas?
>>
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>>
>>
>
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

