---
title: "Request queue issue with riakc_pb_socket"
description: ""
project: community
lastmod: 2012-07-24T17:48:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08053"
author_name: "Julian"
project_section: "mailinglistitem"
sent_date: 2012-07-24T17:48:05-07:00

---


Hi,

I'm using riakc\_pb\_socket to queue up several requests and rely on the
built-in queueing, which should hopefully eventually service all requests.
However I have a scenario in which a couple processes that queue a request
are never terminating the call on the socket...even though a request issued
subsequently gets through.

I have one process which quickly spawns 7 processes, each of which will
call riakc\_pb\_socket:search. 6 of these requests should return 0 results
quickly. 1 returns 85000 results. What I see happen frequently (but not
always) is that 4 of the requests with 0 results will complete. Then the
long request with all the results eventually completes ( I set a high
enough timeout value). After this, the 2 other requests never seem to get
executed.

-record(state, {riak\_conn,
 ...}).

handle\_info({add\_platform, PlatformBin}, State) ->
...
 erlang:spawn(?MODULE, populate\_instance, [PlatformBin, State]),
...

populate\_instance(InstanceBin, State) ->
 error\_logger:info\_msg(binary\_to\_list(InstanceBin) ++ " about to wait"),
 MapredResult = riakc\_pb\_socket:search(State#state.riak\_conn,
 InstanceBin,
 "type:account",
 [{map, {jsanon, <<"
function(v, keyData, arg) {
 var o = JSON.parse(v.values[0].data);
 var p = {...}; // I'm transforming the object
 return [JSON.stringify(p)]
}">> }, none, true }],
 90000), % timeout
 error\_logger:info\_msg(binary\_to\_list(InstanceBin) ++ " done waiting"),

 .... process MapredResult ...


In the log I get 7 lines from populate\_instance like this:
1c837b206ff37939892740206c8eb4f0f897b282 about to wait

Then I get 4 lines like this:
1c837b206ff37939892740206c8eb4f0f897b282 done waiting

Then it gets to the 5th one with a lot of results. Eventually:
a65796222ea26bb7b355bf140dbd5b72e81efee1 done waiting

Then no more. The remaining 2 processes in riakc\_pb\_socket:search never
seem to print "... done waiting".

Suppose I sneak in a request to add a platform:
list\_to\_pid("<0.120.0>") ! {add\_platform, <<"aaa">>}.

I see in the log that it goes through:
aaa about to wait
aaa done waiting

...so it seems like my 2 processes will never finish.

Any ideas? It seems like it should be fine to pass State to different
processes, since the connection is just a pid. The queue is sitting in the
socket process and should be fine.
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

