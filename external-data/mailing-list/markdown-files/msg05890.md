---
title: "Re: Why is the data lost in luwak"
description: ""
project: community
lastmod: 2011-12-07T21:05:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05890"
mailinglist_parent_id: "msg05881"
author_name: "vuleetu"
project_section: "mailinglistitem"
sent_date: 2011-12-07T21:05:57-08:00
---


On Wed, Dec 7, 2011 at 11:56 PM, Kelly McLaughlin  wrote:
>
> Fisher,
>
> In the cases where you see file size discrepancies, are you able to retrieve 
> those files intact from riak? Having a node in the cluster with an unstable 
> network connection should not cause data loss because replicas should be 
> saved to other nodes in your cluster, but it may cause some issues with being 
> able to properly access those files via luwak. The chances of data being lost 
> when a riak node goes down is dependent on what you mean by the node going 
> down. In most cases, the replicas will take care of it, but in the case that 
> multiple machines in your cluster fail, you should be familiar with the sync 
> strategies for the backend you are using. For example, you can read about the 
> bitcask sync strategies here: http://wiki.basho.com/Bitcask.html.
>
> Kelly



Kelly,

We are only able to retrieve the data in Riak that it reports it has
(from luwak\_file:length()), but it does not match what we attempted to
put into Riak.  I brought up the network questions only as a theory,
otherwise I don't know any reason why we are having this problem.  It
is affecting about 0.0012% of the files we are putting into Riak (via
luwak), and without any way of determining if a write operation was
successful we don't know how to resolve this problem.

We tried calling luwak\_put\_stream:flush() before to "guarantee" that
our data would write because in the docs for luwak\_put\_stream:send()
it's a little misleading about what it does, but on buffer block sizes
< 1000000 the flush() does not do what we expected at all:

RiakNode = 'riak@127.0.0.1'.
{ok, Riak} = riak:client\_connect(RiakNode).
{ok, RiakFile} = luwak\_file:create(Riak, <<"testabc22yeah3">>, dict:new()).
Ps = luwak\_put\_stream:start(Riak, RiakFile, 0, 1000000).
luwak\_put\_stream:send(Ps, <<"1234">>).
luwak\_put\_stream:flush(Ps).
{ok, RiakFile2} = luwak\_file:get(Riak, <<"testabc22yeah3">>).
luwak\_file:length(Riak, RiakFile2).      %% Length is 4
luwak\_put\_stream:send(Ps, <<"56789">>).
luwak\_put\_stream:flush(Ps).
{ok, RiakFile3} = luwak\_file:get(Riak, <<"testabc22yeah3">>).
luwak\_file:length(Riak, RiakFile3).  %% Length is 13, but we would
have expected 9
luwak\_io:get\_range(Riak, RiakFile3, 0, 13). %% [<<"1234">>,<<"123456789">>]

>From the documentation though it says: "If you want guarantees that
your write is actually written then you need to call flush/1 on the
put stream."

So besides that, is there any way to actually tell if the node
received the write request?

Thanks,

Fisher




>
>
>
> On Dec 5, 2011, at 12:56 AM, vuleetu wrote:
>
> Hi, all
>
>      I am working on a storage system which receives data from the client and 
> stores it to luwak. The server also records the file size of that file which 
> is uploaded successfully to the database, but i found it is not the same size 
> as the data in luwak even after several days, so that is not a consistency 
> problem.
>
>    The following is the main process:
>
>    1) check if file exists already
>       luwak\_file:exists()
>
>    2) if it doesn't exist, will use luwak\_file:create to create one, or else 
> will use luwak\_file:get to get that file handle,
>
>    3) use the last offset which is recorded in database, and the create put 
> stream
>       luwak\_put\_stream:start(Riak, RiakFile, Offset, ?STREAM\_PUT\_TTL)
>
>    4) receive data from client, and write to put stream created above
>       gen\_tcp: recv()
>       luwak\_put\_stream:send(PutStream, Binary)
>
>    Is there any possibility that data is lost because one of the riak node's 
> network is not stable? Because i found when i call luwak\_put\_stream:put(), it 
> just send message contain the data to one process, so i dont know if data is 
> lost or sent successfully. Even if I call flush, it is still a request 
> message to that process. Is there any function to tell me if the write was 
> successful or not? What about if that riak node goes down in the middle of 
> writing data to luwak, what would happen, will it cause the data to be lost?
>
>
> Thanks,
> Fisher
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
>
>

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

