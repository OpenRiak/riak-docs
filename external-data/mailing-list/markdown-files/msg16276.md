---
title: "Product Advisory - Riak 2.0.0 - 2.1.1: Incompatibility between Dotted	Version Vectors and Last Write Wins"
description: ""
project: community
lastmod: 2015-07-06T16:26:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16276"
author_name: "Tyler Hannan"
project_section: "mailinglistitem"
sent_date: 2015-07-06T16:26:22-07:00

---


-Description-

In Riak 2.0.0 through Riak 2.1.1, enabling dotted version vectors and
`last\_write\_wins` at the same time has been found to cause unexpected
behavior on object updates (PUT or POST with causal context), including
both passive and active anti-entropy.

-Affected Users-

This issue will affect you if:

You are using the default bucket type, and have explicitly set both
dvv\_enabled and last\_write\_wins to true. The default value for dvv\_enabled
is false for the default bucket type.
 OR
You are using a custom bucket type, and have explicitly set last\_write\_wins
to true. The default value for dvv\_enabled is true on custom bucket types.
 AND
You are doing \_updates\_ to keys. That is GET-mutate-PUT passing the vclock
back to Riak. PUTs without a causal context are safe.

-Impact-

The issue manifests itself as failure to read a key or keys that are
affected. The issue may only show in logs. The issue may be short-lived if
the affected keys are overwritten.

-Mitigation-

In all bucket types where last\_write\_wins is being used, this issue can be
avoided by setting dvv\_enabled to false. Setting `dvv\_enabled=false` will
enable AAE or read repair to fix those affected keys. In order to make this
process as easy as possible, we have provided a pre-compiled Erlang module
called dvv\_lww\_buckets.beam that can be used to scan for and fix affected
buckets. This is available at
http://docs.basho.com/riak/latest/community/product-advisories/dvv-lastwritewins/

Place the beam file in your basho\_patches directory
(»riak\_install\_dir>/lib/basho\_patches« ) and execute the following commands
from the bin directory of your Riak installation. Note that this only needs
to be done on one node per Riak cluster, as the beam file provides a
utility to fix buckets across the cluster:

 cd /bin
 ./riak attach
 l(dvv\_lww\_buckets).
 dvv\_lww\_buckets:fix\_buckets().

If you see any output of the form:

 !! Fixing <<"foo">>: - resetting dvv\_enabled=false

Then you have one or more affected buckets. The fix\_buckets function will
automatically fix the bucket properties for both untyped buckets with
properties different from default properties, and also any bucket types
that have these settings. If you have set these properties for your default
bucket in an advanced.config setting, it will warn you that your default
bucket is configured incorrectly, so you will have to edit your
advanced.config and make sure that you set “dvv\_enabled” to false.

DO NOT set `last\_write\_wins=false` as AAE or Read Repair may remove all
conflicting values for affected keys.

When AAE is enabled, the next AAE run will repair any keys with the issue.
Also, once the bucket properties are fixed, issuing a GET (for example,
your application reading the key) will result in both a successful read and
will repair that particular object.

If AAE is disabled in your cluster, infrequently accessed data affected by
this issue, will be in a damaged state until the next request. More
information about AAE, and the risks associated with disabling it, is
available at https://docs.basho.com/riak/2.1.1/theory/concepts/aae/

In a future release we will ensure that dotted version vectors and
`last\_write\_wins` cannot be enabled simultaneously.

Questions?

Please open a ticket with Basho if you have any questions about the above
issue.

Cheers,

Tyler Hannan | Director of Technical Marketing
Basho Technologies
t: @tylerhannan
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

