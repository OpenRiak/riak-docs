---
title: "Multi-backend, eLevelDB, & Too many open files"
description: ""
project: community
lastmod: 2013-09-08T21:17:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12209"
author_name: "Matt Black"
project_section: "mailinglistitem"
sent_date: 2013-09-08T21:17:36-07:00

---


Hey list,

We're migrating from our currently operational cluster to a new one in a
different EC2 region. As part of this migration, we'd like to move from
Bitcask to eLevelDB - mostly for the benefits provided by secondary indexes.

We also use Multi-backend configuration, in order to split our various
client's data into entirely separate spaces on disk (this is useful for
legal reasons). I made the simple change from "riak\_kv\_bitcask\_backend" to
"riak\_kv\_eleveldb\_backend" in our config, and did some calculations for
"max\_open\_files", and then started a new node.

It fails with the following error in short order:

> cat error.log
2013-09-09 03:49:51.391 [error] <0.715.0>@riak\_kv\_vnode:init:375 Failed to
start riak\_kv\_multi\_backend Reason: [{riak\_kv\_eleveldb\_backend,{db\_open,"IO
error:
/mnt/riak/eleveldb/client1/365375409332725729550921208179070754913983135744/000015.dbtmp:
Too many open files"}}]
2013-09-09 03:49:51.392 [error] <0.940.0>@riak\_kv\_vnode:init:375 Failed to
start riak\_kv\_multi\_backend Reason: [{riak\_kv\_eleveldb\_backend,{db\_open,"IO
error:
/mnt/riak/eleveldb/client2/570899077082383952423314387779798054553098649600/CURRENT:
Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
/mnt/riak/eleveldb/client3/570899077082383952423314387779798054553098649600/CURRENT:
Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
/mnt/riak/eleveldb/client4/570899077082383952423314387779798054553098649600/CURRENT:
Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
/mnt/riak/eleveldb/client5/570899077082383952423314387779798054553098649600/CURRENT:
Too many open files"}},{riak\_kv\_eleveldb\_backend,{db\_open,"IO error:
/mnt/riak/eleveldb/client6/570899077082383952423314387779798054553098649600/CURRENT:
Too many open files"}}]

And some relevant app.config:

 {multi\_backend\_default, <<"default">>},
 {multi\_backend, [
 %% Default fallback: this is unused
 {<<"default">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/default"}
 ]},
 {<<"eleveldb\_client1">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client1"}
 ]},
 {<<"eleveldb\_client2">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client2"}
 ]},
 {<<"eleveldb\_client3">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client3"}
 ]},
 {<<"eleveldb\_client4">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client4"}
 ]},
 {<<"eleveldb\_client5">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client5"}
 ]},
 {<<"eleveldb\_client6">>, riak\_kv\_eleveldb\_backend, [
 {data\_root, "/mnt/riak/eleveldb/client6"}
 ]}
 ]},

 .. snip ..

 %% Default cache size of 8MB
 {cache\_size, 8388608},
 %% Maximum number of files open at once per partition
 {max\_open\_files, 50}

I've set the "riak soft/hard nofile 65536" in /etc/security/limits.conf, so
presumably this "Too many open files" error is referring to the
"max\_open\_files" option as part of eLevelDB config. The RAM in each machine
is 3.5GB free, so I calculated on a 5 node cluster this 50 max\_open\_files
limit.

- Is there something about Multi-backend I haven't taken into account?
- Do I need a larger max\_open\_files? (And thus more RAM? :)

Cheers!
Matt
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

