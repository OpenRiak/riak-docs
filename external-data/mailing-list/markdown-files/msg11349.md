---
title: "Riak database fails after a short period"
description: ""
project: community
lastmod: 2013-06-27T09:38:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11349"
author_name: "Kirill K."
project_section: "mailinglistitem"
sent_date: 2013-06-27T09:38:26-07:00

---


Hi,

I created a simple erlang application which periodically collects required
data and puts it in a riak database.

As I start my application it runs smoothly.. but after a period of time it
stucks as PUT requests to riak database becomes too slow.. It is logs from
my app:

2013-06-26 12:44:09.090 [info] <0.60.0> data processed in [16476 ms]
2013-06-26 12:45:51.472 [info] <0.60.0> data processed in [18793 ms]
...
2013-06-26 12:57:28.138 [info] <0.60.0> data processed in [15135 ms]
2013-06-26 13:07:01.484 [info] <0.60.0> data processed in [488420 ms]
2013-06-26 14:03:11.561 [info] <0.60.0> data processed in [3370075 ms]

In riak crash logs I can see a lot of messages like

2013-06-26 17:06:20 =CRASH REPORT====
crasher:
initial call: riak\_kv\_index\_hashtree:init/1
pid: <0.13660.7>
registered\_name: []
exception exit: {{{badmatch,{error,{db\_open,"IO error: ./data/anti\_entropy/
 433883298582611803841718934712646521460354973696/MANIFEST-000004:
 Cannot allocate memory"}}}, [{hashtree,new\_segment\_store,2,
 [{file,"src/hashtree.erl"},{line,499}]},
 {hashtree,new,2,[{file,"src/hashtree.erl"},{line,215}]},
 {riak\_kv\_index\_hashtree,do\_new\_tree,2,
 [{file,"src/riak\_kv\_index\_hashtree.erl"},
 {line,426}]},{lists,foldl,3,[{file,"lists.erl"},
 {line,1197}]},{riak\_kv\_index\_hashtree,
 init\_trees,2,[{file,"src/riak\_kv\_index\_hashtree.erl"},
 {line,368}]},{riak\_kv\_index\_hashtree,init,1,
 [{file,"src/riak\_kv\_index\_hashtree.erl"},
 {line,225}]},{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line,304}]},
 {proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]},
 [{gen\_server,init\_it,6,[{file,"gen\_server.erl"},{line,328}]},
 {proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}
ancestors: [<0.955.0>,riak\_core\_vnode\_sup,riak\_core\_sup,<0.129.0>]
messages: []
links: []
dictionary: []
trap\_exit: false
status: running
heap\_size: 1597
stack\_size: 24
reductions: 593
neighbours:

I can see the same behavior on Amazon AWS and local virtual machine. my
VM's are quite small 512-1024 mb.. AWS is Micro, so it has the same amount
of memory.

There are no cluster currently. Just single node with riak and my app
running on it.

I've checked riak documentation and basic things they recommend to do is to
increase ulimit and to update sysctl. So, my server ulimit shows: ulimit -n
65536 AND sysctl updated as recommended.

I've tried bitcask and eleveldb, but result is the same.

Currently, I can't figure out what is broken and why riak Cannot allocate
memory..

Thanks.


Kirill
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

