---
title: "Re: haproxy and protobuffers working example?"
description: ""
project: community
lastmod: 2011-05-30T16:56:08-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03498"
mailinglist_parent_id: "msg03497"
author_name: "Bob Feldbauer"
project_section: "mailinglistitem"
sent_date: 2011-05-30T16:56:08-07:00
---


Your haproxy.cfg looks fine, but since you asked, here's the my 
haproxy.cfg for Riak use:


global
 user haproxy
 group haproxy
 daemon
 maxconn 100000

defaults
 log global
 mode tcp
 option tcplog
 option dontlognull
 balance leastconn
 clitimeout 60000
 srvtimeout 60000
 contimeout 5000
 retries 3
 option redispatch
 option contstats
 stats enable

listen riak 192.168.1.1:8087
 server riak1 riak1:8087 weight 1 maxconn 1000
 server riak2 riak2:8087 weight 1 maxconn 1000
 server riak3 riak3:8087 weight 1 maxconn 1000


Good luck!

- Bob Feldbauer

On 5/30/2011 7:11 PM, Scott M. Likens wrote:

Hey,

So I thought I had a working haproxy configuration with protobuffers (It worked 
once upon a time, but no longer) so I was wondering if anyone had any working 
examples?


irb(main):001:0> client = Riak::Client.new(:protocol => "pbc")
=> #
irb(main):002:0> client.ping
Riak::ProtobuffsFailedRequest: Expected success from Riak but received 
server\_error. Unexpected EOF on PBC socket


irb(main):008:0> client2=Riak::Client.new(:protocol => "pbc", :host => 
"10.170.121.116")
=> #
irb(main):009:0> client2.ping
=> true


If I remove all the servers except for 1 connects but still doesn't really 
work, below is my haproxy configuration I hope it helps.

 listen riak\_pbc :8087
 mode tcp
 server app-0 ip-10-170-121-116.us-west-1.compute.internal:8087 check inter 
5000 fastinter 1000 fall 1 weight 50
 server app-1 ip-10-171-43-226.us-west-1.compute.internal:8087 check inter 
5000 fastinter 1000 fall 1 weight 50
 server app-2 ip-10-170-142-202.us-west-1.compute.internal:8087 check inter 
5000 fastinter 1000 fall 1 weight 50

Actual full haproxy erb chef template can be found here 
https://github.com/damm/ey-riak/blob/master/templates/default/haproxy.cfg.erb 
(if you see anything I should turn off for http please let me know and be 
gentle)


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

