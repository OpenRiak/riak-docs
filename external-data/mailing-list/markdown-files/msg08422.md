---
title: "Riak performance issue with many connected objects (11 million +)"
description: ""
project: community
lastmod: 2012-08-31T08:54:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08422"
author_name: "Lei Gu"
project_section: "mailinglistitem"
sent_date: 2012-08-31T08:54:36-07:00

---


I started performance testing Riak by loading 11 million connected objects in 
Riak. Loading has not been an issue, although it did take a long time.
Now when I tried to access an object, Riak never returns and was using 100% of 
CPU and 74% of memory.

 PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND
 8952 riak 20 0 23.4g 11g 1708 S 100.6 74.1 1520:49 beam.smp

This raises major concern on our side. I am using LevelDB for secondary index 
support and I haven't turn on free text search yet. I am running Centos6, with 
16 G memory and Intel i7 8 core.
Any help is highly appreciated.
Thanks.
-- Lei


Riak status:
[root@lgu-linux performance]# cat riak-status.txt
Attempting to restart script through sudo -u riak
1-minute stats for 'riak@127.0.0.1'
-------------------------------------------
vnode gets : 13728
vnode\_puts : 9153
vnode\_index\_reads : 0
vnode\_index\_writes : 9153
vnode\_index\_writes\_postings : 4575
vnode\_index\_deletes : 234
vnode\_index\_deletes\_postings : 0
read\_repairs : 0
vnode\_gets\_total : 17412882
vnode\_puts\_total : 11608449
vnode\_index\_reads\_total : 0
vnode\_index\_writes\_total : 11608449
vnode\_index\_writes\_postings\_total : 5798670
vnode\_index\_deletes\_total : 234
vnode\_index\_deletes\_postings\_total : 402
node\_gets : 0
node\_gets\_total : 5804294
node\_get\_fsm\_time\_mean : 0
node\_get\_fsm\_time\_median : 0
node\_get\_fsm\_time\_95 : 0
node\_get\_fsm\_time\_99 : 0
node\_get\_fsm\_time\_100 : 0
node\_puts : 0
node\_puts\_total : 3869483
node\_put\_fsm\_time\_mean : 0
node\_put\_fsm\_time\_median : 0
node\_put\_fsm\_time\_95 : 0
node\_put\_fsm\_time\_99 : 0
node\_put\_fsm\_time\_100 : 0
node\_get\_fsm\_siblings\_mean : 0
node\_get\_fsm\_siblings\_median : 0
node\_get\_fsm\_siblings\_95 : 0
node\_get\_fsm\_siblings\_99 : 0
node\_get\_fsm\_siblings\_100 : 0
node\_get\_fsm\_objsize\_mean : 0
node\_get\_fsm\_objsize\_median : 0
node\_get\_fsm\_objsize\_95 : 0
node\_get\_fsm\_objsize\_99 : 0
node\_get\_fsm\_objsize\_100 : 0
read\_repairs\_total : 0
coord\_redirs\_total : 0
precommit\_fail : 0
postcommit\_fail : 0
cpu\_nprocs : 655
cpu\_avg1 : 8
cpu\_avg5 : 3
cpu\_avg15 : 5
mem\_total : 16699068416
mem\_allocated : 5336322048
disk : [{"/",51606140,18},
 {"/dev/shm",8153840,1},
 {"/boot",495844,9},
 {"/home",891064276,1}]
nodename : 'riak@127.0.0.1'
connected\_nodes : []
sys\_driver\_version : <<"1.5">>
sys\_global\_heaps\_size : 0
sys\_heap\_type : private
sys\_logical\_processors : 8
sys\_otp\_release : <<"R14B04">>
sys\_process\_count : 1559
sys\_smp\_support : true
sys\_system\_version : <<"Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] 
[rq:8] [async-threads:64] [hipe] [kernel-poll:true]">>
sys\_system\_architecture : <<"x86\_64-unknown-linux-gnu">>
sys\_threads\_enabled : true
sys\_thread\_pool\_size : 64
sys\_wordsize : 8
ring\_members : ['riak@127.0.0.1']
ring\_num\_partitions : 64
ring\_ownership : <<"[{'riak@127.0.0.1',64}]">>
ring\_creation\_size : 64
storage\_backend : riak\_kv\_eleveldb\_backend
pbc\_connects\_total : 10
pbc\_connects : 1
pbc\_active : 0
ssl\_version : <<"4.1.6">>
public\_key\_version : <<"0.13">>
runtime\_tools\_version : <<"1.8.6">>
basho\_stats\_version : <<"1.0.2">>
riak\_search\_version : <<"1.1.2">>
riak\_kv\_version : <<"1.1.4">>
bitcask\_version : <<"1.5.1">>
luke\_version : <<"0.2.5">>
erlang\_js\_version : <<"1.0.2">>
mochiweb\_version : <<"1.5.1">>
inets\_version : <<"5.7.1">>
riak\_pipe\_version : <<"1.1.2">>
merge\_index\_version : <<"1.1.0">>
cluster\_info\_version : <<"1.2.1">>
basho\_metrics\_version : <<"1.0.0">>
riak\_control\_version : <<"0.1.0">>
riak\_core\_version : <<"1.1.2">>
lager\_version : <<"1.0.0">>
riak\_sysmon\_version : <<"1.1.2">>
webmachine\_version : <<"1.9.1">>
crypto\_version : <<"2.0.4">>
os\_mon\_version : <<"2.2.7">>
sasl\_version : <<"2.1.10">>
stdlib\_version : <<"1.17.5">>
kernel\_version : <<"2.14.5">>
executing\_mappers : 0
memory\_total : 29539192
memory\_processes : 9988968
memory\_processes\_used : 9958144
memory\_system : 19550224
memory\_atom : 1050169
memory\_atom\_used : 1036476
memory\_binary : 421104
memory\_code : 9330790
memory\_ets : 4598912


Riak config file:

%% -\*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -\*-
%% ex: ft=erlang ts=4 sw=4 et
[
 %% Riak Core config
 {riak\_core, [
 %% Default location of ringstate
 {ring\_state\_dir, "/var/lib/riak/ring"},

 %% http is a list of IP addresses and TCP ports that the Riak
 %% HTTP interface will bind.
 {http, [ {"0.0.0.0", 8098 } ]},

 %% https is a list of IP addresses and TCP ports that the Riak
 %% HTTPS interface will bind.
 %{https, [{ "127.0.0.1", 8098 }]},

 %% Default cert and key locations for https can be overridden
 %% with the ssl config variable, for example:
 %{ssl, [
 % {certfile, "/etc/riak/cert.pem"},
 % {keyfile, "/etc/riak/key.pem"}
 % ]},

 %% riak\_handoff\_port is the TCP port that Riak uses for
 %% intra-cluster data handoff.
 {handoff\_port, 8099 },

 %% To encrypt riak\_core intra-cluster data handoff traffic,
 %% uncomment the following line and edit its path to an
 %% appropriate certfile and keyfile. (This example uses a
 %% single file with both items concatenated together.)
 %{handoff\_ssl\_options, [{certfile, "/tmp/erlserver.pem"}]},

 %% Disable legacy vnode routing for 1.1.x and above clusters
 %% (use vnode proxies). Only set true on mixed clusters.
 {legacy\_vnode\_routing, false},

 %% Platform-specific installation paths (substituted by rebar)
 {platform\_bin\_dir, "/usr/sbin"},
 {platform\_data\_dir, "/var/lib/riak"},
 {platform\_etc\_dir, "/etc/riak"},
 {platform\_lib\_dir, "/usr/lib64/riak"},
 {platform\_log\_dir, "/var/log/riak"}
 ]},

 %% Riak KV config
 {riak\_kv, [
 %% Storage\_backend specifies the Erlang module defining the storage
 %% mechanism that will be used on this node.
 {storage\_backend, riak\_kv\_eleveldb\_backend},

 %% pb\_ip is the IP address that the Riak Protocol Buffers interface
 %% will bind to. If this is undefined, the interface will not run.
 {pb\_ip, "0.0.0.0" },

 %% pb\_port is the TCP port that the Riak Protocol Buffers interface
 %% will bind to
 {pb\_port, 8087 },

 %% pb\_backlog is the maximum length to which the queue of pending
 %% connections may grow. If set, it must be an integer >= 0.
 %% By default the value is 5. If you anticipate a huge number of
 %% connections being initialised \*simultaneously\*, set this number
 %% higher.
 %% {pb\_backlog, 64},

 %% raw\_name is the first part of all URLS used by the Riak raw HTTP
 %% interface. See riak\_web.erl and raw\_http\_resource.erl for
 %% details.
 %{raw\_name, "riak"},

 %% mapred\_name is URL used to submit map/reduce requests to Riak.
 {mapred\_name, "mapred"},

 %% mapred\_system indicates which version of the MapReduce
 %% system should be used: 'pipe' means riak\_pipe will
 %% power MapReduce queries, while 'legacy' means that luke
 %% will be used
 {mapred\_system, pipe},

 %% mapred\_2i\_pipe indicates whether secondary-index
 %% MapReduce inputs are queued in parallel via their own
 %% pipe ('true'), or serially via a helper process
 %% ('false' or undefined). Set to 'false' or leave
 %% undefined during a rolling upgrade from 1.0.
 {mapred\_2i\_pipe, true},

 %% directory used to store a transient queue for pending
 %% map tasks
 %% Only valid when mapred\_system == legacy
 %% {mapred\_queue\_dir, "/var/lib/riak/mr\_queue" },

 %% Each of the following entries control how many Javascript
 %% virtual machines are available for executing map, reduce,
 %% pre- and post-commit hook functions.
 {map\_js\_vm\_count, 8 },
 {reduce\_js\_vm\_count, 6 },
 {hook\_js\_vm\_count, 2 },

 %% Number of items the mapper will fetch in one request.
 %% Larger values can impact read/write performance for
 %% non-MapReduce requests.
 %% Only valid when mapred\_system == legacy
 %% {mapper\_batch\_size, 5},

 %% js\_max\_vm\_mem is the maximum amount of memory, in megabytes,
 %% allocated to the Javascript VMs. If unset, the default is
 %% 8MB.
 {js\_max\_vm\_mem, 8},

 %% js\_thread\_stack is the maximum amount of thread stack, in 
megabyes,
 %% allocate to the Javascript VMs. If unset, the default is 16MB.
 %% NOTE: This is not the same as the C thread stack.
 {js\_thread\_stack, 16},

 %% Number of objects held in the MapReduce cache. These will be
 %% ejected when the cache runs out of room or the bucket/key
 %% pair for that entry changes
 %% Only valid when mapred\_system == legacy
 %% {map\_cache\_size, 10000},

 %% js\_source\_dir should point to a directory containing Javascript
 %% source files which will be loaded by Riak when it initializes
 %% Javascript VMs.
 %{js\_source\_dir, "/tmp/js\_source"},

 %% http\_url\_encoding determines how Riak treats URL encoded
 %% buckets, keys, and links over the REST API. When set to 'on'
 %% Riak always decodes encoded values sent as URLs and Headers.
 %% Otherwise, Riak defaults to compatibility mode where links
 %% are decoded, but buckets and keys are not. The compatibility
 %% mode will be removed in a future release.
 {http\_url\_encoding, on},

 %% riak\_stat enables the use of the "riak-admin status" command to
 %% retrieve information the Riak node for performance and debugging 
needs
 {riak\_kv\_stat, true},

 %% When using riak\_kv\_stat, use the legacy routines for tracking
 {legacy\_stats, true},

 %% Switch to vnode-based vclocks rather than client ids. This
 %% significantly reduces the number of vclock entries.
 %% Only set true if \*all\* nodes in the cluster are upgraded to 1.0
 {vnode\_vclocks, true},

 %% This option enables compatability of bucket and key listing
 %% with 0.14 and earlier versions. Once a rolling upgrade to
 %% a version > 0.14 is completed for a cluster, this should be
 %% set to false for improved performance for bucket and key
 %% listing operations.
 {legacy\_keylisting, false},

 %% This option toggles compatibility of keylisting with 1.0
 %% and earlier versions. Once a rolling upgrade to a version
 %% > 1.0 is completed for a cluster, this should be set to
 %% true for better control of memory usage during key listing
 %% operations
 {listkeys\_backpressure, true}
 ]},

 %% Riak Search Config
 {riak\_search, [
 %% To enable Search functionality set this 'true'.
 {enabled, true}
 ]},

 %% Merge Index Config
 {merge\_index, [
 %% The root dir to store search merge\_index data
 {data\_root, "/var/lib/riak/merge\_index"},

 %% The root dir to store secondary index merge\_index data
 {data\_root\_2i, "/var/lib/riak/merge\_index\_2i"},

 %% Size, in bytes, of the in-memory buffer. When this
 %% threshold has been reached the data is transformed
 %% into a segment file which resides on disk.
 {buffer\_rollover\_size, 1048576},

 %% Overtime the segment files need to be compacted.
 %% This is the maximum number of segments that will be
 %% compacted at once. A lower value will lead to
 %% quicker but more frequent compactions.
 {max\_compact\_segments, 20}
 ]},

 %% Bitcask Config
 {bitcask, [
 {data\_root, "/var/lib/riak/bitcask"}
 ]},

 %% eLevelDB Config
 {eleveldb, [
 {data\_root, "/var/lib/riak/leveldb"}
 ]},

 %% Lager Config
 {lager, [
 %% What handlers to install with what arguments
 %% The defaults for the logfiles are to rotate the files when
 %% they reach 10Mb or at midnight, whichever comes first, and keep
 %% the last 5 rotations. See the lager README for a description of
 %% the time rotation format:
 %% https://github.com/basho/lager/blob/master/README.org
 %%
 %% If you wish to disable rotation, you can either set the size to 0
 %% and the rotation time to "", or instead specify a 2-tuple that 
only
 %% consists of {Logfile, Level}.
 {handlers, [
 {lager\_console\_backend, info},
 {lager\_file\_backend, [
 {"/var/log/riak/error.log", error, 10485760, "$D0", 5},
 {"/var/log/riak/console.log", info, 10485760, "$D0", 5}
 ]}
 ]},

 %% Whether to write a crash log, and where.
 %% Commented/omitted/undefined means no crash logger.
 {crash\_log, "/var/log/riak/crash.log"},

 %% Maximum size in bytes of events in the crash log - defaults to 
65536
 {crash\_log\_msg\_size, 65536},

 %% Maximum size of the crash log in bytes, before its rotated, set
 %% to 0 to disable rotation - default is 0
 {crash\_log\_size, 10485760},

 %% What time to rotate the crash log - default is no time
 %% rotation. See the lager README for a description of this format:
 %% https://github.com/basho/lager/blob/master/README.org
 {crash\_log\_date, "$D0"},

 %% Number of rotated crash logs to keep, 0 means keep only the
 %% current one - default is 0
 {crash\_log\_count, 5},

 %% Whether to redirect error\_logger messages into lager - defaults 
to true
 {error\_logger\_redirect, true}
 ]},

 %% riak\_sysmon config
 {riak\_sysmon, [
 %% To disable forwarding events of a particular type, use a
 %% limit of 0.
 {process\_limit, 30},
 {port\_limit, 2},

 %% Finding reasonable limits for a given workload is a matter
 %% of experimentation.
 {gc\_ms\_limit, 100},
 {heap\_word\_limit, 40111000},

 %% Configure the following items to 'false' to disable logging
 %% of that event type.
 {busy\_port, true},
 {busy\_dist\_port, true}
 ]},

 %% SASL config
 {sasl, [
 {sasl\_error\_logger, false}
 ]},

 %% riak\_control config
 {riak\_control, [
 %% Set to false to disable the admin panel.
 {enabled, false},

 %% Authentication style used for access to the admin
 %% panel. Valid styles are 'userlist' .
 {auth, userlist},

 %% If auth is set to 'userlist' then this is the
 %% list of usernames and passwords for access to the
 %% admin panel.
 {userlist, [{"user", "pass"}
 ]},

 %% The admin panel is broken up into multiple
 %% components, each of which is enabled or disabled
 %% by one of these settings.
 {admin, true}
 ]}
].


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
The information contained in this electronic mail transmission is intended only 
for the use of the individual or entity named in this transmission. If you are 
not the intended recipient of this transmission, you are hereby notified that 
any disclosure, copying or distribution of the contents of this transmission is 
strictly prohibited and that you should delete the contents of this 
transmission from your system immediately. Any comments or statements contained 
in this transmission do not necessarily reflect the views or position of GSI 
Commerce, Inc. or its subsidiaries and/or affiliates.

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

