---
title: "Re: erlang precommit hook error"
description: ""
project: community
lastmod: 2011-11-08T12:05:38-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05481"
mailinglist_parent_id: "msg05478"
author_name: "Hal Eisen"
project_section: "mailinglistitem"
sent_date: 2011-11-08T12:05:38-08:00
---


I've made some progress. Looks like I was not compiling my module,
nor did I have the add\_paths set in app.config.

However, now I'm getting a new failure:
 error:function\_clause

When I look in my erlang.log file, I see this:
[{string,'tokens1',[<<"my actual data that I am trying to store before being 
processed by the precommit hook">>," 
",[]]},{haleisen,mangle,1},{riak\_kv\_put\_fsm,invoke\_hook,4},{riak\_kv\_put\_fsm,precommit,2},{gen\_fsm,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]


I've updated my mangle/1 function:
mangle(X) ->
 crypto:start(),
 {\_, Tokens} = lists:partition(fun(Arg) -> lists:member(Arg, 
haleisen:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
 riak\_object:update\_value(X, list\_to\_binary(lists:flatten(lists:map(fun(Arg) 
-> crypto:md5(Arg) end, Tokens)))),
 riak\_object:apply\_updates(X).

Am I manipulating the riak\_object correctly?

Is there a recommended way to emit debug message from within Erlang hooks?

Thanks,
Hal

On Tue, Nov 08, 2011 at 10:01:26AM -0800, Hal Eisen wrote:
> Sorry, typo in code. the mangle function is actually:
> 
> mangle(X) ->
> crypto:start(),
> {\_, Tokens} = lists:partition(fun(Arg) -> lists:member(Arg, 
> mangle:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
> riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -> 
> crypto:md5(Arg) end, Tokens))),
> riak\_object:apply\_updates(X).
> 
> In other words, I fixed the module reference.
> 
> Hal
> 
> On Tue, Nov 08, 2011 at 09:59:26AM -0800, Hal Eisen wrote:
> > Hello again. I have given up on using the JavaScript precommit hook
> > because I could not find anything which did not produce timeouts under
> > the load for my application.
> > 
> > So, I have ported my hook to Erlang. Alas, I'm not getting very far.
> > I've installed my hook in /etc/riak/erl/hooks.erl. The code looks
> > like this:
> > 
> > -module(haleisen).
> > -export([stopwords/0, mangle/1]).
> > stopwords() ->
> > ["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"].
> > mangle(X) ->
> > crypto:start(),
> > {\_, Tokens} = lists:partition(fun(Arg) -> lists:member(Arg, 
> > ask:stopwords()) end, string:tokens(riak\_object:get\_value(X), " ")),
> > riak\_object:update\_value(X, lists:flatten(lists:map(fun(Arg) -> 
> > crypto:md5(Arg) end, Tokens))),
> > riak\_object:apply\_updates(X).
> > 
> > I originally tested the code in the Erlang repl, using a plain string
> > instead of riak\_object:get\_value, and it worked perfectly.
> > 
> > I installed my hook into a test bucket:
> > bash$ curl http://127.0.0.1:8098/riak/test-hook
> > {"props":{"allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"test-with","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"haleisen","fun":"mangle"}],"pw":0,"r":"quorum","rw":"quorum","small\_vclock":10,"w":"quorum","young\_vclock":20}}
> > 
> > When I try to insert a key into this bucket, I get:
> > Error:
> > {precommit\_fail,{hook\_crashed,{haleisen,mangle,error,undef}}}
> > 
> > Any help would be appreciated.
> > 
> > Thanks,
> > Hal

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

