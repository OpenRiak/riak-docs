---
title: "Re: Bad MapReduce job brings the Riak to a screeching halt?"
description: ""
project: community
lastmod: 2012-08-29T20:43:43-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08398"
mailinglist_parent_id: "msg08397"
author_name: "Alexander Sicular"
project_section: "mailinglistitem"
sent_date: 2012-08-29T20:43:43-07:00
---


What's your "ulimit -n" ?

I think you ran out of fd's. I cite the "io error: lock" mumbo jumbo. 

-Alexander

@siculars
http://siculars.posterous.com

Sent from my iRotaryPhone

On Aug 29, 2012, at 23:07, Brad Heller  wrote:

> Hello Riak world,
> 
> I've been experimenting with migrating some of our OLAP data in to Riak 
> recently. I'm still learning about the…particulars…of Riak, so apologies is 
> the solution to this is obvious or this is an overt n00b question.
> 
> I'm developing on a three-ring Riak cluster on my machine (OSX 10.8.1). I'm 
> primarily using Ruby + Ripple but I've done a lot exploration with Curl too. 
> I'm also using Rekon as a way to peek in to data I'm storing.
> 
> The issue I'm facing: I tried to run an improperly-formatted MapReduce job 
> against a bucket with about 45k keys in it and it seemed to crash Riak. 
> Here's the job itself:
> 
> 1.9.3p194 :065 > puts job.to\_json
> {"inputs":{"bucket":"raw\_statistics","key\_filters":[["starts\_with","some\_string"],["and",[[["tokenize",":",4]],[["between",1345197700,1345697700,true]]]]]},"query":[{"map":{"language":"javascript","keep":true,"name":"Riak.mapValuesJson"}}]}
> 
> I would expect about 2.5k matches to the map. Here's the output from one of 
> the vnodes' error.log
> 
> 2012-08-29 19:27:52.908 [error] <0.420.0>@riak\_pipe\_vnode:new\_worker:766 Pipe 
> worker startup failed:fitting was gone before startup
> 2012-08-29 19:45:41.739 [error] <0.959.0> gen\_fsm <0.959.0> in state active 
> terminated with reason: no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 
> 2012-08-29 19:45:41.773 [error] <0.594.0> gen\_fsm <0.594.0> in state active 
> terminated with reason: no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 
> 2012-08-29 19:45:41.778 [error] <0.594.0> CRASH REPORT Process <0.594.0> with 
> 1 neighbours exited with reason: no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 in 
> gen\_fsm:terminate/7 line 611 
> 2012-08-29 19:45:41.785 [error] <0.23924.70>@riak\_kv\_vnode:init:265 Failed to 
> start riak\_kv\_multi\_backend Reason: [{riak\_kv\_eleveldb\_backend,{db\_open,"IO 
> error: lock ../../tmp/riak/instance1/leveldb/0/LOCK: Resource temporarily 
> unavailable"}}]
> 2012-08-29 19:45:41.814 [error] <0.141.0> Supervisor riak\_core\_vnode\_sup had 
> child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
> <0.594.0> exit with reason no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 in context 
> child\_terminated
> 2012-08-29 19:45:41.818 [error] <0.959.0> CRASH REPORT Process <0.959.0> with 
> 1 neighbours exited with reason: no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 in 
> gen\_fsm:terminate/7 line 611 
> 2012-08-29 19:45:41.822 [error] <0.141.0> Supervisor riak\_core\_vnode\_sup had 
> child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
> <0.959.0> exit with reason no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 in context 
> child\_terminated
> 2012-08-29 19:45:41.943 [error] <0.962.0> gen\_fsm <0.962.0> in state ready 
> terminated with reason: no match of right hand value 
> {error,{bad\_filter,[<<"tokenize">>,<<":">>,4]}} in 
> riak\_kv\_mapred\_filters:'-logical\_and/1-fun-0-'/1 line 176 
> 
> For what it's worth the format of my key is as follows (if anyone has any 
> suggestions on a smarter way to format these, I'm all ears).
> 
> ::: seconds>
> 
> So my question is: Why did this completely kill Riak? This makes me pretty 
> nervous--a bug in our app has the potential to bring down the ring! Is there 
> anything we can do to protect against this?
> 
> And a bonus question: What is a reasonable way to query this? I can't 
> maintain links as there will potentially be hundreds of thousands of these 
> objects to query over (each one is pretty small). Is this a good candidate 
> for a compound secondary index?
> 
> Thanks for any help.
> 
> Cheers,
> 
> Brad Heller | Engineering Lead | Cloudability.com | 541-231-1514 | Skype: 
> brad.heller | @bradhe | @cloudability
> 
> We're hiring! http://cloudability.com/jobs
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

