<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Limit on number of buckets</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#01091" id="c">
<link rel="index" href="maillist.html#01091" id="i">
<link rel="prev" href="msg01085.html" id="p">
<link rel="next" href="msg01083.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg01091.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Limit+on+number+of+buckets%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Limit on number of buckets</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alexander+Sicular%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alexander Sicular</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20100916" rel="nofollow">Thu, 16 Sep 2010 21:02:34 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Scott,

Until Riak gains the ability to constrain list traversals by bucket this will 
continue to be a point of friction. This issue has been broached before and 
there are tickets open on the issues tracking site. As I understand it, one 
solution would potentially modify bitcask to open a 'cask' per bucket. However, 
nothing comes for free and this would come at the expense of file descriptors 
at the os level thereby introducing a constraint on the number of buckets in a 
cluster. This is similar to how the inno backend currently operates, as Sean 
pointed out.</pre><pre>

Recognizing this constraint and how you can mitigate it really depends on your 
use case. I hate to sound like a broken record, but recent improvements to key 
traversal notwithstanding, I have been using redis as an intermediary key list 
manager. Augmenting that further I will pull key lists out of redis and write 
them to riak either by cron or explicitly by user action. Admittedly my volume 
is not at a level where this is a considerable problem at the moment. Then 
again, I don't think it ever will be (for my use case). I'm not trying to crawl 
the world or build the next twitter or facebook. That said, what I do is pull 
this key list out of redis (or riak), generate an appropriate inputs array and 
feed that to the mapreduce function. I should note at the moment I do this in 
javascript for ease of development. Other big wins in my book on using redis 
instead of riak for list management is that redis understands certain data 
primitives whereas riak is data agnostic. What this means practically is that 
you can push/pull/pop/slice data in redis (among other things). You just can 
not do that in riak. Data must be written atomically as in if you have a meg 
you write a meg. There are no diff updates in riak. 

Performance wise, the first thing you are going to want to look at if and when 
optimization becomes a concern is moving from the http interface to the 
protobuf interface. After that I would look into rewriting your mapreduce in 
erlang. Marshaling complex data between the native erlang internals and the 
javascript interpreter has a non zero cost associated with it. Forgoing this 
step is a big win. Again, I view all this as a growth path within the riak 
environment and &quot;a good thing&quot; (tm). 

Assuming your most populous zip codes may have on the order of ~200k 
subscribers you could encode your user keys in radix 62 and be able to fit 
those keys in a 3 character space. Move up to 4 characters for way more leg 
room. At 3 characters (standard 8 bit encoding) your ~200k key list is under 1 
MB (something to consider based on how riak allocates ram for this portion of 
the mapreduce in erlang and/or js). Also, I'm a big fan of fixed length keys 
for unrolled loops. Either way, feeding keys explicitly to a mapreduce will 
only get better as your input list shrinks in relation to the total keys in 
your system. Data modeling wise, I would have a user bucket a zip codes bucket 
and a zip_users bucket and the converse, users_zip bucket. The later two having 
the keys of the former as members. I'm also a big fan of explicitly derived 
keys/paths. I would not recommend links here simply because of the unbounded, 
potentially large nature of your problem.

Do keep us posted,

Alexander


On Sep 16, 2010, at 2:49 PM, Scott wrote:

&gt; Thanks for the quick replies Sean and Alexander.  One of our current products 
&gt; allows users to sign up for weather alerts based on their zip code.  When we 
&gt; receive a weather alert for a set of locations, we need to quickly find all 
&gt; users in the zip codes effected. We currently do this with a simple sql query 
&gt; against a relational db.  Being new at this key/value store thing, we are not 
&gt; sure the best way to tackle this with Riak.
&gt; 
&gt; Some zip codes have over 20,000 users, so storing the users in a json array 
&gt; with the zip code as the key would get ugly fast.  One thought was to store 
&gt; the user profiles in one bucket, and then add an key per user in the correct 
&gt; zip code bucket, perhaps with a link back to the users record in the profile 
&gt; bucket.  We could then fetch the keys for the effected zip codes using map 
&gt; reduce.  I am open to all suggestions on how to best model this type of data 
&gt; in Riak.
&gt; 
&gt; Thanks,
&gt; Scott
&gt; 
&gt; 
&gt; Sean Cribbs wrote:
&gt;&gt; Scott,
&gt;&gt; 
&gt;&gt; There is no limit on the number of buckets unless you are changing the 
&gt;&gt; bucket properties, like the replication factor, allow_mult, or the pre- and 
&gt;&gt; post-commit hooks.  Buckets that have properties other than the defaults 
&gt;&gt; consume space in the ring state.  Other than that, they are essentially free 
&gt;&gt; unless you're using a backend that segregates data by bucket - the only one 
&gt;&gt; that does at this time is innostore.
&gt;&gt; 
&gt;&gt; Is there a reason you need so many buckets? 
&gt;&gt; 
&gt;&gt; Sean Cribbs &lt;s...@basho.com&gt;
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; <a  rel="nofollow" href="http://basho.com/">http://basho.com/</a>
&gt;&gt; 
&gt;&gt; On Sep 16, 2010, at 2:17 PM, SKester wrote:
&gt;&gt; 
&gt;&gt;&gt; Is there a practical (or hard) limit to the number of buckets a riak 
&gt;&gt;&gt; cluster can handle?  One possible data model we could use for one 
&gt;&gt;&gt; application could result in ~80,000 buckets.  Is that a reasonable number?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Scott
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg01085.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#01091">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#01091">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg01083.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg01081.html">Limit on number of buckets</a></span> <span class="sender italic">SKester</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01082.html">Re: Limit on number of buckets</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01084.html">Re: Limit on number of buckets</a></span> <span class="sender italic">Scott</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01085.html">Re: Limit on number of buckets</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Limit on number of buckets</span> <span class="sender italic">Alexander Sicular</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg01083.html">Re: Limit on number of buckets</a></span> <span class="sender italic">Alexander Sicular</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Limit on number of buckets">
<input type="hidden" name="msgid" value="96DEF5AA-A965-4032-95BA-F759AC7380B0@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg01091.html">
<input type="submit" value=" Alexander Sicular ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Limit+on+number+of+buckets%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg01085.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg01083.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">96DEF5AA-A965-4032-95BA-F759AC7380B0@gmail.com</li>
</ul>
</div>
</body>
</html>
