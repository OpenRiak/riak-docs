<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Two question in re pre/post commit hooks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03981" id="c">
<link rel="index" href="maillist.html#03981" id="i">
<link rel="prev" href="msg03962.html" id="p">
<link rel="next" href="msg03963.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03981.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Two+question+in+re+pre%5C%2Fpost+commit+hooks%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Two question in re pre/post commit hooks</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Mathias+Meyer%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Mathias Meyer</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110711" rel="nofollow">Mon, 11 Jul 2011 04:40:24 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Jeffrey,

1.) a given key/value data pair is owned by multiple nodes, depending on your 
replication level. Operations on a particular key/value pair happen on all 
nodes that are primary replicas, but requests leading to these operations can 
be coordinated by any node in the cluster. So when you write a piece of data, N 
nodes will be involved in the process. But your commit hooks will only be run 
on the coordinating node, the one you sent the request to. Ownership can change 
at any time when nodes go down or the cluster changes due to new nodes entering 
oder old nodes leaving.</pre><pre>

2.) The key/value pair is not locked. As per above, this would require a 
distributed lock across all replicas of the key/value pair, which is not how 
Riak works. While the update itself is coordinated by a single process on the 
coordinating, at any time, a different client could come along and update the 
same piece of data through a different path, so e.g. through a different or 
even the same node.

The original updater doesn't have any knowledge of that, if it's a conflicting 
update, it will simply create a sibling (given you enabled sibling creations on 
that particular buckets). You may want to look into Statebox [1] as an 
alternative way, or try to serialize writes through a messaging system like 
RabbitMQ to ensure atomicity to a certain extent.

[1] <a  rel="nofollow" href="https://github.com/mochi/statebox">https://github.com/mochi/statebox</a>

Mathias Meyer
Developer Advocate, Basho Technologies


On Freitag, 8. Juli 2011 at 19:14, Jeffrey Kesselman wrote:

&gt; (1) AIUI a given key/value data pair is &quot;owned&quot; by a given node at one time 
&gt; and operations on it happen on that node and are then replicated out. Is this 
&gt; correct?
&gt; 
&gt; (2) Is the key/value pair &quot;locked&quot; between pre update and post update? 
&gt; 
&gt; The motivation for this question is this.
&gt; 
&gt; I need to do the following operations on update:
&gt; 
&gt; (1) In the pre-update hook, get the existing value (lets call it A) 
&gt; (2) Compare some data in the update (lets call it A') with A
&gt; (3) Validate or reject the update based on that comparison
&gt; (4) If validated, write A' out as the new value of A, if not, return a 
&gt; validation error.
&gt; 
&gt; I need 1-4 to happen in a consistent fashion, If someone else can come in and 
&gt; update A after (1) but before (4), the scheme wont work.
&gt; 
&gt; I *could* do my own locking in (1) and then add an unlock step in (5) 
&gt; assuming that all updates will take place on the same node, but I dislike 
&gt; injecting locking into a system that has unknown other expectations of the 
&gt; operation.
&gt;  -- 
&gt; It's always darkest just before you are eaten by a grue.
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03962.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03981">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03981">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03963.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03962.html">Two question in re pre/post commit hooks</a></span> <span class="sender italic">Jeffrey Kesselman</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Two question in re pre/post commit hooks</span> <span class="sender italic">Mathias Meyer</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Two question in re pre/post commit hooks">
<input type="hidden" name="msgid" value="18A86CD6982D43A99E9D7A1F67B4C13C@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03981.html">
<input type="submit" value=" Mathias Meyer ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Two+question+in+re+pre%5C%2Fpost+commit+hooks%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03962.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03963.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">18A86CD6982D43A99E9D7A1F67B4C13C@basho.com</li>
</ul>
</div>
</body>
</html>
