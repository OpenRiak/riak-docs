<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: luwak questions</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02417" id="c">
<link rel="index" href="maillist.html#02417" id="i">
<link rel="prev" href="msg02406.html" id="p">
<link rel="next" href="msg02420.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02417.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+luwak+questions%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: luwak questions</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Bryan+Fink%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bryan Fink</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110223" rel="nofollow">Wed, 23 Feb 2011 06:57:25 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>On Tue, Feb 22, 2011 at 12:17 PM, francisco treacy
&lt;francisco.tre...@gmail.com&gt; wrote:
&gt;&gt; db.add({ bucket: 'luwak_tld', key_filters: [['starts_with', 
&gt;&gt; 'e276814e96e0616eb7c07d3bb744d333']]}).map(function(v) { return [1] }).run()
&gt; POST /mapred
&gt;&gt; { message: 'HTTP error 500: {&quot;error&quot;:&quot;bad_json&quot;}'
&gt; , stack: [Getter/Setter]
&gt; , statusCode: 500
&gt; , notFound: false
&gt; }
&gt;
&gt; but I get &quot;bad_json&quot; errors... Any other bucket works just fine. Why
&gt; won't this work like a regular bucket?</pre><pre>

The data stored in the luwak_tld Riak objects is an Erlang term that
is not directly convertible to JSON.  Riak is trying to convert that
object to JSON in order to hand it to the Javascript map function you
specified.

I recommend using riak_kv_mapreduce:reduce_identity/2 in a reduce
phase, instead of that Javascript map phase to assemble your keylist.
That will avoid the JSON conversion in two ways: it's Erlang native
(so it doesn't need the conversion), and reduce phases don't both with
reading the object from storage anyway.  If you really do need to look
at the object before deciding whether or not its key qualifies, you'll
need to code your logic in an Erlang function instead of Javascript.

If you need something closer to the Javascript function in your
example (which could be used to produce a count of the filtered keys,
instead of the keys themselves), I have a 'reduce_count_inputs'
function waiting in a pull request:
<a  rel="nofollow" href="https://github.com/basho/riak_kv/pull/32">https://github.com/basho/riak_kv/pull/32</a>

-Bryan

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02406.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02417">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02417">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02420.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02406.html">luwak questions</a></span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: luwak questions</span> <span class="sender italic">Bryan Fink</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02420.html">Re: luwak questions</a></span> <span class="sender italic">francisco treacy</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: luwak questions">
<input type="hidden" name="msgid" value="AANLkTinFMEC_1roXRNeK=oAFRpPPhRFhUrnX42ZykVa6@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02417.html">
<input type="submit" value=" Bryan Fink ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+luwak+questions%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02406.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02420.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTinFMEC_1roXRNeK=oAFRpPPhRFhUrnX42ZykVa6@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
