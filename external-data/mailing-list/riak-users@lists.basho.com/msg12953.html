<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: max_files_limit and AAE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd7.html#12953" id="c">
<link rel="index" href="mail7.html#12953" id="i">
<link rel="prev" href="msg12948.html" id="p">
<link rel="next" href="msg12954.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12953.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+max_files_limit+and+AAE%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: max_files_limit and AAE</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Dave+Brady%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Dave Brady</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131112" rel="nofollow">Tue, 12 Nov 2013 08:11:47 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I looked at the spreadsheet, Matthew, thanks!  It's much more comprehensive 
than what's on the website.</pre><pre>

We never had any RAM issues, howver, during the incidents.  All of the machines 
had 35 GB or more free RAM, with no pages swapped out.

I still just don't understand what could have caused these errors.

One of the bad nodes (from yesterday's outage) has 42,000 total .sst files 
across its 25 VNodes (about 1,700 .sst files/VNode).

How could 65,536 filehandles got exhausted?  Would not Riak have had to open 
every single .sst file, *and* do &lt;lots of other stuff&gt;, to hit that limit?

Is there command I can use in the CLI that gives the number of open files?

And now for something only slightly different...

We have surmised that part of how the out-of-files problem appears to manifest 
itself caused our three recent cluster-wide outages.

We are using haproxy with the recommended config, so haproxy is set for 
leastconn.  What seems to have happened is that Riak continued to respond 
positively (at least a good part of the time) to haproxy's default aliveness 
check.  This caused haproxy to send all new connection requests to the bad 
nodes, once existing connections on the bad nodes completed.  Our cluster, in 
very short order, was for most intents and purposes dead.

We saw in all of our apps' logs multitudes of connection (re)attempts, which we 
didn't at first attribute to Riak/HAProxy. I had to get the cluster back up 
very quickly, so I simply did a rolling restart.

This last time (yesterday), I had a little more time to investigate.  All our 
apps returned to normal immediately after the second of the two identified bad 
nodes was restarted.

--
Dave Brady

----- Original Message -----
From: &quot;Evan Vigil-McClanahan&quot; &lt;emcclana...@basho.com&gt;
To: &quot;Alexander Sicular&quot; &lt;sicul...@gmail.com&gt;
Cc: &quot;Dave Brady&quot; &lt;dbr...@weborama.com&gt;, &quot;riak-users&quot; 
&lt;riak-users@lists.basho.com&gt;
Sent: Lundi 11 Novembre 2013 22:48:17
Subject: Re: max_files_limit and AAE

AAE in 2.0 will have IO rate limiting to keep it from overwhelming disks.

On Mon, Nov 11, 2013 at 1:33 PM, Alexander Sicular &lt;sicul...@gmail.com&gt; wrote:
&gt; I'm interested to see how 2.0 fixes this. I too have been bit by the AAE 
&gt; killing servers problem and have had to turn it off (which is thankfully the 
&gt; easiest of the AAE config options). It's kind of antithesis to the easy ops 
&gt; proposition of Riak when a feature that is difficult to configure can kill 
&gt; your entire cluster. Like not just make it slow but like make it unresponsive.
&gt;
&gt;
&gt; @siculars
&gt; <a  rel="nofollow" href="http://siculars.posthaven.com">http://siculars.posthaven.com</a>
&gt;
&gt; Sent from my iRotaryPhone
&gt;
&gt;&gt; On Nov 11, 2013, at 12:59, Dave Brady &lt;dbr...@weborama.com&gt; wrote:
&gt;&gt;
&gt;&gt; I have turned off AAE for the time being.
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12948.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd7.html#12953">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail7.html#12953">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12954.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12938.html">max_files_limit and AAE</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12939.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12942.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Dave Brady</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg12941.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12943.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12945.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12947.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12948.html">Re: max_files_limit and AAE</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: max_files_limit and AA...</span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12954.html">Re: max_files_limit an...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg12956.html">Re: max_files_limit an...</a></span> <span class="sender italic">Dave Brady</span></li>
<li class="icons-email"><span class="subject"><a href="msg12955.html">Re: max_files_limit an...</a></span> <span class="sender italic">Shane McEwan</span></li>
<li class="icons-email"><span class="subject"><a href="msg12957.html">Re: max_files_limit an...</a></span> <span class="sender italic">Dave Brady</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: max_files_limit and AAE">
<input type="hidden" name="msgid" value="180316475.5659688.1384272537260.JavaMail.root@weborama.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12953.html">
<input type="submit" value=" Dave Brady ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+max_files_limit+and+AAE%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12948.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12954.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">180316475.5659688.1384272537260.JavaMail.root@weborama.com</li>
</ul>
</div>
</body>
</html>
