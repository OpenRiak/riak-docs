<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Map Reduce and long queries -</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08912" id="c">
<link rel="index" href="maillist.html#08912" id="i">
<link rel="prev" href="msg08910.html" id="p">
<link rel="next" href="msg08914.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08912.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Map+Reduce+and+long+queries+%5C-%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Map Reduce and long queries -</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Adam+Lindsay%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Adam Lindsay</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121014" rel="nofollow">Sun, 14 Oct 2012 14:03:01 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi David,  

The word everywhere is to avoid key filters. It effectively does a whole-bucket 
key-listing, and that starts to get seriously slow out past 100k items. Since 
you say test queries work I'll presume you've debugged your map and reduce on 
some queries where you manually add a set of keys. (Right?)   </pre><pre>

Since you're on LevelDB, it means you can use secondary indices (&quot;2i&quot;) to drive 
these queries.

I don't have access to your filter_map, so I don't have access to how you 
construct your keys, but if you have 2i turned on, then you get the first 
key-field &quot;for free&quot; from 2i.

Let's say, hypothetically, that your keys are constructed as:
 keyprefix:&lt;date&gt;:&lt;country&gt;:&lt;campaign_id&gt;

Well, you can then rewrite the query input as:

def main():
    client = riak.RiakClient(host=riak_host,
        port=8087,transport_class=riak.transports.pbc.RiakPbcTransport)
    query = client.index(
                    bucket,  
                    '$key',  
                    'keyprefix:201210',  
                    'keyprefix:201210~')
    query.map('''function(value, keyData, arg) { ... }''')
    â€¦



That's fine as far as it goes, but it doesn't solve the problem of querying 
country or campaign id, right?

As a temporary measure, I'd suggest trying your key filters, cranking up the 
timeout to something on the order of hours (I gave 5 minutes conservatively and 
arbitrarily), and going ahead and running it for however long it takes.


If those queries do give good results, I'd suggest going ahead and re-indexing 
your existing entries with 'country_bin' and 'campaign_bin'. It's up to 
personal style whether you treat dates as int or bin.

There are lots of tricks and further discussion on how best to get at every 
corner of your data, but how does this strike you so far?
--  
Adam Lindsay


On Sunday, 14 October 2012 at 12:57, David Montgomery wrote:

&gt; Hi,
&gt;  
&gt; Below is my code for running a map reduce in python. I have a six
&gt; node cluster, 2 cores each with 4 gigs for ram. I am no load and
&gt; about 3 Mill keys and using leveldb with riak 1.2. Doing the below
&gt; is taking a terribly long time. Never finished and I dont even know
&gt; how I can check if it is even running other than the python script has
&gt; not timed out. I look at the number of executed mappers in stats and
&gt; it is flat lined when looking at Graphite. On test queries the below
&gt; works.
&gt;  
&gt; So..how do I debug what is going on?
&gt;  
&gt;  
&gt; def main():
&gt; client = 
&gt; riak.RiakClient(host=riak_host,port=8087,transport_class=riak.transports.pbc.RiakPbcTransport)
&gt; query = client.add(bucket)
&gt; filters = key_filter.tokenize(&quot;:&quot;, filter_map['date']) +
&gt; (key_filter.starts_with('201210'))
&gt; #&amp; key_filter.tokenize(&quot;:&quot;, filter_map['country']).eq(&quot;US&quot;) \
&gt; #&amp; key_filter.tokenize(&quot;:&quot;, filter_map['campaign_id']).eq(&quot;t1&quot;) \
&gt; query.add_key_filters(filters)
&gt;  
&gt; query.map('''
&gt; function(value, keyData, arg) {
&gt; var data = Riak.mapValuesJson(value)[0];
&gt;  
&gt; if(data['adx']=='gdn'){
&gt; var alt_key = data['hw'];
&gt; var obj = {};
&gt; obj[alt_key] = 1;
&gt; return [ obj ];
&gt; }else{
&gt; return [];
&gt; }
&gt;  
&gt;  
&gt; }''')
&gt;  
&gt;  
&gt; query.reduce('''
&gt; function(values, arg){
&gt; return [ values.reduce( function(acc, item) {
&gt; for (var state in item) {
&gt; if (acc[state])
&gt; acc[state] += item[state];
&gt; else
&gt; acc[state] = item[state];
&gt; }
&gt; return acc;
&gt; })];
&gt; }
&gt; ''')
&gt;  
&gt; for result in query.run(timeout=300000):
&gt; print result
&gt;  
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;  
&gt;  


</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08910.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08912">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08912">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08914.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08910.html">Map Reduce and long queries -</a></span> <span class="sender italic">David Montgomery</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Map Reduce and long queries -</span> <span class="sender italic">Adam Lindsay</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08914.html">Re: Map Reduce and long queries -</a></span> <span class="sender italic">Olav Frengstad</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08916.html">Re: Map Reduce and long queries -</a></span> <span class="sender italic">Bryan Fink</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08918.html">Re: Map Reduce and long queries -</a></span> <span class="sender italic">Olav Frengstad</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Map Reduce and long queries -">
<input type="hidden" name="msgid" value="39ADF8A2ADE34EA29A03D2543ADABB22@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08912.html">
<input type="submit" value=" Adam Lindsay ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Map+Reduce+and+long+queries+%5C-%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08910.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08914.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">39ADF8A2ADE34EA29A03D2543ADABB22@gmail.com</li>
</ul>
</div>
</body>
</html>
