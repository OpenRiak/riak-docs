<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: mysterious Riak problems</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09244" id="c">
<link rel="index" href="maillist.html#09244" id="i">
<link rel="prev" href="msg09242.html" id="p">
<link rel="next" href="msg09246.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09244.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+mysterious+Riak+problems%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: mysterious Riak problems</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22David+Lowell%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">David Lowell</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121107" rel="nofollow">Wed, 07 Nov 2012 15:56:56 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>After further thought, I want to add more color to this issue. I hypothesize 
the symptoms I described here were continued fallout of an earlier crash. So 
I've waded further back into to the logs to try to shed light on how the Riak 
process was doing prior to this time. It was unhappy. It appears to have failed 
and stopped several times in the 1/2 day prior. The pattern revealed in the 
logs looks something like this:</pre><pre>

- Following  a clean startup, the service runs for a while

- Usually the first log entry of any kind near the beginning of a long block of 
error logs is &quot;alarm_handler: {set,{system_memory_high_watermark,[]}}&quot;  
        ( Is this indicating excessive memory use? )

- Within a few minutes we see several log messages warning about &quot;long_gc&quot;, 
which I assume is an indication that garbage collection took longer than some 
threshold

- Within the next minute or two, we start to see the legions of errors, 
&quot;riak_kv_vnode worker pool crashed&quot;, and &quot;gen_fsm&quot; having some sort of timeout 
when trying to communicate with the eleveldb backend

- Eventually we see a log record indicating &quot;Failed to start riak_kv_eleveldb&quot; 
because of a leveldb LOCK file being temporarily unavailable

- Then Riak starts to exit:  riak:stop:46 &quot;backend module failed to start.&quot; 


So, not really knowing the Riak internals, it's a little difficult to piece 
together the story here. Could be we're running low on memory. Hard to know why 
riak_kv_workers are failing, or why this leveldb LOCK file is unavailable. To 
those more learned, do these log records tell a story?

For the record, we're using the default 8 MB of leveldb cache per vnode, so 
that ought to cap cache for our 512 vnodes at 4 GB. Our host has 32 GB of 
physical memory. Are there other pieces of Riak that can use a lot of memory 
that we need to look out for?

I'll include a few of the actual log records for reference, below.

Dave

--
Dave Lowell
d...@connectv.com

Representative logs, many similar ones deleted for brevity:

2012-11-07 01:41:02.395 [info] &lt;0.51.0&gt; alarm_handler: 
{set,{system_memory_high_watermark,[]}}
2012-11-07 01:55:50.517 [info] 
&lt;0.73.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor long_gc &lt;0.18585.32&gt; 
[{initial_call,{riak_core_coverage_fsm,init,1}},{almost_current_function,{riak_core_coverage_plan,'-next_vnode/2-fun-0-',2}},{message_queue_len,0}]
 
[{timeout,219},{old_heap_block_size,0},{heap_block_size,28657},{mbuf_size,0},{stack_size,48},{old_heap_size,0},{heap_size,11430}]
2012-11-07 01:56:20.303 [error] &lt;0.9231.0&gt;@riak_core_vnode:handle_info:510 
1258832464966656615093408225054454710289582522368 riak_kv_vnode worker pool 
crashed 
{timeout,{gen_fsm,sync_send_event,[&lt;0.9234.0&gt;,{checkout,false,5000},5000]}}
2012-11-07 01:56:22.382 [error] &lt;0.10002.0&gt; gen_fsm &lt;0.10002.0&gt; in state ready 
terminated with reason: 
{timeout,{gen_server,call,[&lt;0.10005.0&gt;,{work,&lt;0.10003.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{40916762,{1398702738851840683437120250060505233655091691520,'riak@10.0.3.11'}},&lt;0.18429.32&gt;}}]}}
2012-11-07 01:57:11.833 [error] &lt;0.19755.32&gt;@riak_kv_vnode:init:265 Failed to 
start riak_kv_eleveldb_backend Reason: {db_open,&quot;IO error: lock 
/var/data/ctv/riak/leveldb/1258832464966656615093408225054454710289582522368/LOCK:
 Resource temporarily unavailable&quot;}
2012-11-07 01:57:27.425 [info] 
&lt;0.73.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor long_gc &lt;0.19181.32&gt; 
[{initial_call,{riak_core_coverage_fsm,init,1}},{almost_current_function,{gen_fsm,loop,7}},{message_queue_len,0}]
 
[{timeout,109},{old_heap_block_size,0},{heap_block_size,28657},{mbuf_size,0},{stack_size,47},{old_heap_size,0},{heap_size,9171}]
2012-11-07 01:57:51.109 [error] &lt;0.10002.0&gt; CRASH REPORT Process &lt;0.10002.0&gt; 
with 0 neighbours exited with reason: 
{timeout,{gen_server,call,[&lt;0.10005.0&gt;,{work,&lt;0.10003.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{40916762,{1398702738851840683437120250060505233655091691520,'riak@10.0.3.11'}},&lt;0.18429.32&gt;}}]}}
 in gen_fsm:terminate/7 line 


On Nov 7, 2012, at 11:34 AM, David Lowell wrote:

&gt; Hello Riak Folks,
&gt; 
&gt; The last three days, we've been having a string of problems with Riak. An 
&gt; otherwise healthy server running our full application stack will suddenly 
&gt; start throwing a bunch of errors in the logs. Although the Riak processes 
&gt; stay up, most or all requests to Riak fail during these periods.
&gt; 
&gt; The errors in the logs are predominantly describing &quot;riak_kv_vnode worker 
&gt; pool crashed&quot; and timeout conditions. This morning, we had this crashy 
&gt; behavior start immediately after a clean Riak startup, and making a single 
&gt; call to our API, so the logs are quite free of other noise. I've summarized 
&gt; those logs below for curious parties, and can attach the full set of logs if 
&gt; needed.
&gt; 
&gt; I forgot to check this morning, but during a similar outage on Monday, the 
&gt; Riak server was refusing connections to new clients.
&gt; 
&gt; Interestingly, after giving Riak a while with no traffic at all today (like 
&gt; 15-30 minutes), it appears to have recovered without a restart. We've had 
&gt; similar recoveries during other &quot;outages&quot; of this type since Sunday evening. 
&gt; Facilitating this sort of recovery does seem to require shutting down all 
&gt; application KV requests for a while.
&gt; 
&gt; We're suspicious of some kind of corruption in the eleveldb on-disk files, 
&gt; because in past outages of this type, we've observed that the condition 
&gt; persists over reboots. But we don't have much more evidence than that. Is 
&gt; there a command we can run that will check over eleveldb files for corruption 
&gt; or inconsistency?
&gt; 
&gt; Other than that, what can cause &quot;worker pool crashed&quot; events? What do you 
&gt; know about the &quot;timeouts&quot; that are in these logs?
&gt; 
&gt; For the record, we're running Riak 1.2.0 on Ubuntu 10.04,  eleveldb backend 
&gt; with 512 partitions. We're running predominantly in a single-node 
&gt; configuration on a bunch of isolated dev boxes at the moment, on our way to 
&gt; spreading out our 512 vnodes onto 5 hosts in production.
&gt; 
&gt; Thanks for your help,
&gt; 
&gt; Dave
&gt; 
&gt; --
&gt; Dave Lowell
&gt; d...@connectv.com
&gt; 
&gt; 
&gt; 2012-11-07 18:11:03.398 [info] &lt;0.7.0&gt; Application lager started on node 
&gt; 'riak@10.0.3.11'
&gt; 
&gt; ... normal startup messages ...
&gt; 
&gt; 2012-11-07 18:11:50.109 [info] &lt;0.10582.0&gt;@riak_core:wait_for_application:419 
&gt; Wait complete for application riak_search (0 seconds)
&gt; 2012-11-07 18:22:18.509 [error] &lt;0.2897.0&gt;@riak_core_vnode:handle_info:510 
&gt; 105616329260241031198313161739262640092323250176 riak_kv_vnode worker pool 
&gt; crashed 
&gt; {timeout,{gen_server,call,[&lt;0.2902.0&gt;,{work,&lt;0.2900.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{96247562,{105616329260241031198313161739262640092323250176,'riak@10.0.3.11'}},&lt;0.15324.0&gt;}}]}}
&gt; 2012-11-07 18:22:18.509 [error] &lt;0.2899.0&gt; gen_fsm &lt;0.2899.0&gt; in state ready 
&gt; terminated with reason: 
&gt; {timeout,{gen_server,call,[&lt;0.2902.0&gt;,{work,&lt;0.2900.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{96247562,{105616329260241031198313161739262640092323250176,'riak@10.0.3.11'}},&lt;0.15324.0&gt;}}]}}
&gt; 
&gt; ... 13 more &quot;riak_kv_vnode worker pool crashed&quot; messages...
&gt; 
&gt; 2012-11-07 18:22:21.245 [error] &lt;0.2899.0&gt; CRASH REPORT Process &lt;0.2899.0&gt; 
&gt; with 0 neighbours exited with reason: 
&gt; {timeout,{gen_server,call,[&lt;0.2902.0&gt;,{work,&lt;0.2900.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{96247562,{105616329260241031198313161739262640092323250176,'riak@10.0.3.11'}},&lt;0.15324.0&gt;}}]}}
&gt;  in gen_fsm:terminate/7 line 611
&gt; 2012-11-07 18:22:21.844 [error] &lt;0.2944.0&gt; gen_fsm &lt;0.2944.0&gt; in state ready 
&gt; terminated with reason: 
&gt; {timeout,{gen_server,call,[&lt;0.2947.0&gt;,{work,&lt;0.2945.0&gt;,{fold,#Fun&lt;riak_kv_eleveldb_backend.3.97398576&gt;,#Fun&lt;riak_kv_vnode.14.47983300&gt;},{fsm,{96247562,{114179815416476790484662877555959610910619729920,'riak@10.0.3.11'}},&lt;0.15324.0&gt;}}]}}
&gt; 
&gt; ... 13 more &quot;CRASH REPORT Process &lt;X&gt; with 0 neighbours exited with reason&quot; 
&gt; and &quot;gen_fsm &lt;0.2989.0&gt; in state ready terminated with reason&quot; message pairs
&gt; 
&gt; 2012-11-07 18:23:21.427 [error] &lt;0.15322.0&gt; gen_server &lt;0.15322.0&gt; terminated 
&gt; with reason: 
&gt; {error,{case_clause,{error,timeout,[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[&lt;&lt;&quot;1352256943.4983411&quot;&gt;&gt;],[],[],[],...]}},...}
&gt; 2012-11-07 18:23:21.495 [error] &lt;0.15322.0&gt; CRASH REPORT Process &lt;0.15322.0&gt; 
&gt; with 0 neighbours exited with reason: 
&gt; {error,{case_clause,{error,timeout,[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[&lt;&lt;&quot;1352256943.4983411&quot;&gt;&gt;],[],[],[],...]}},...}
&gt;  in gen_server:terminate/6 line 747
&gt; 2012-11-07 18:23:21.525 [error] &lt;0.10590.0&gt; Supervisor riak_api_pb_sup had 
&gt; child undefined started with {riak_api_pb_server,start_link,undefined} at 
&gt; &lt;0.15322.0&gt; exit with reason 
&gt; {error,{case_clause,{error,timeout,[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[&lt;&lt;&quot;1352256943.4983411&quot;&gt;&gt;],[],[],[],...]}},...}
&gt;  in context child_terminated

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09242.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09244">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09244">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09246.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09242.html">mysterious Riak problems</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: mysterious Riak problems</span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09246.html">Re: mysterious Riak problems</a></span> <span class="sender italic">Mark Phillips</span></li>
<li class="icons-email"><span class="subject"><a href="msg09320.html">Re: mysterious Riak problems</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09323.html">Re: mysterious Riak problems</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09324.html">Re: mysterious Riak problems</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09326.html">Re: mysterious Riak problems</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09327.html">Re: mysterious Riak proble...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09328.html">Re: mysterious Riak pr...</a></span> <span class="sender italic">David Lowell</span></li>
<li class="icons-email"><span class="subject"><a href="msg09329.html">Re: mysterious Riak pr...</a></span> <span class="sender italic">David Lowell</span></li>
<li class="icons-email"><span class="subject"><a href="msg09331.html">Re: mysterious Riak pr...</a></span> <span class="sender italic">David Lowell</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg09319.html">Re: mysterious Riak problems</a></span> <span class="sender italic">Alexander Nilsson</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: mysterious Riak problems">
<input type="hidden" name="msgid" value="C10D2EDD-5B3B-4739-A467-394906E21A79@go2ctv.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09244.html">
<input type="submit" value=" David Lowell ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+mysterious+Riak+problems%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09242.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09246.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">C10D2EDD-5B3B-4739-A467-394906E21A79@go2ctv.com</li>
</ul>
</div>
</body>
</html>
