<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Backing up riak</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07321" id="c">
<link rel="index" href="maillist.html#07321" id="i">
<link rel="prev" href="msg07319.html" id="p">
<link rel="next" href="msg07306.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07321.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Backing+up+riak%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Backing up riak</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Swinney%2C+Austin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Swinney, Austin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120425" rel="nofollow">Wed, 25 Apr 2012 11:21:39 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I'd like to preface my comments by saying we love your product!  We've really 
got high hopes for Riak at Vimeo!</pre><pre>

Also, my interest in backups has mainly to do with data corruption/loss from 
developers doing something bad.  Hence, a node loss is one scenario, but having 
to restore all data from backup being another scenario.



On Apr 25, 2012, at 1:31 PM, Mark Phillips wrote:

2) is it a consistent backup or is consistency old fashioned thinking?

The backup will be complete up to the point at which it was taken. You'll get a 
dump of all the keys in the order in which they were listed. Updates that 
happened during the backup may or may not be captured. (I would have to verify 
exactly how you would know which made it and which didn't.)


It would be nice to know for the record what the case is, so follow up is 
always appreciated..

With riak-admin backup, would it be possible to add a --stdout option so that 
the output could be pipped to gzip/bzip2?  The resulting backup file from 
multiple nodes could easily be larger than any one node's storage…  We have 
1.8GB on five nodes that ended up being 15GB in the dump file.  It compressed 
down very well.  We are just using a small dataset project now, but there is 
talk of moving 2T of compressed mysql data over.

[root@ip-10-0-0-231 mnt]# time riak-admin backup 
riak@10.0.0.231&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.231">mailto:riak@10.0.0.231</a>&gt; riak /mnt/backup/test.dump all
Attempting to restart script through sudo -u riak
Backing up (all nodes) to '/mnt/backup/test.dump'.
...from 
['riak@10.0.0.231&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.231">mailto:riak@10.0.0.231</a>&gt;','riak@10.0.0.232&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.232">mailto:riak@10.0.0.232</a>&gt;','riak@10.0.0.233&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.233">mailto:riak@10.0.0.233</a>&gt;',
         
'riak@10.0.0.234&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.234">mailto:riak@10.0.0.234</a>&gt;','riak@10.0.0.235&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.235">mailto:riak@10.0.0.235</a>&gt;']
Backup of 'riak@10.0.0.231&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.231">mailto:riak@10.0.0.231</a>&gt;' complete
Backup of 'riak@10.0.0.232&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.232">mailto:riak@10.0.0.232</a>&gt;' complete
Backup of 'riak@10.0.0.233&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.233">mailto:riak@10.0.0.233</a>&gt;' complete
Backup of 'riak@10.0.0.234&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.234">mailto:riak@10.0.0.234</a>&gt;' complete
Backup of 'riak@10.0.0.235&lt;<a  rel="nofollow" href="mailto:riak@10.0.0.235">mailto:riak@10.0.0.235</a>&gt;' complete
syncing and closing log

real    19m40.045s
user    6m19.976s
sys     4m12.192s

-rw-r--r-- 1 riak riak  15G Apr 24 15:56 test.dump
-rw-r--r-- 1 root root 1.9G Apr 24 16:13 test.dump.tgz




3) if you use the tar'ing up of leveldb + ring files per node, you lose one 
node, then you restore it from this tar file that is hours or days old, how 
does riak deal with bringing its data up to date?



After you restored the node, it would gradually sync its replicas with those on 
the other nodes via read/repair. That said, doing a complete restore of the 
node would probably not be needed. When the node disappears, Riak will 
compensate for it by sending its writes/reads to fallback nodes. When it comes 
back online, hinted handoff and read repair will make sure it gets all the 
replicas it was supposed to have and that those replicas were up to date. (You 
will have to force Read Repar on the replicas on that node which can be done 
via a list keys or using an existing snippet of code [1] for doing this but be 
warned that it'll put some load on that node. We're working on making the Read 
Repair process less reactive in future releases, but this is the best way to do 
it right now.) To be clear, I'm in no way advocating not backing-up your data. 
You just might not need to use them in this situation.


Understood.   It is also worth noting that the `riak-admin backup [all]` 
absorbed the meager CPU resources of my ec2 m1.large really well,  I loved the 
way it scaled across all 2 cores. ( <a  rel="nofollow" href="http://cl.ly/2Q1i2l0n2X2o2W1J0X27">http://cl.ly/2Q1i2l0n2X2o2W1J0X27</a>  ;-)  I 
didn't expect that from a mysql background.  I'm so used to single threaded 
processes.



Another thing worth noting - the 'riak-admin backup' command is not known to be 
the speediest. If you have any non-trivial amount of data that needs backing 
up, you're probably best to do a FS snapshot of Level on each node. 
Unfortunately doing a live snapshot of Level is less than bulletproof at the 
moment, so you're advised to stop the node, snapshot level, and restart. You'll 
have to take the node offline for this but with five Riak nodes, your cluster 
should Just Keep Cranking™.



Is snapshotting known to be bullet-proof with other storage engines besides 
Level?  I was thinking lvm snapshots would be a decent solution when it grows 
larger.

That does help, thanks!

Austin

Hope that helps.

Mark

[1] Fair warning: I'm not sure the last time this was tested - 
<a  rel="nofollow" href="http://contrib.basho.com/bucket_inspector.html">http://contrib.basho.com/bucket_inspector.html</a>

Thanks Riakers!

Austin

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07319.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07321">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07321">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07306.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07305.html">Backing up riak</a></span> <span class="sender italic">Swinney, Austin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07319.html">Re: Backing up riak</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Backing up riak</span> <span class="sender italic">Swinney, Austin</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Backing up riak">
<input type="hidden" name="msgid" value="2A1D5F30-BED1-4950-8287-1EA597E8C836@vimeo.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07321.html">
<input type="submit" value=" Swinney, Austin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Backing+up+riak%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07319.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07306.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">2A1D5F30-BED1-4950-8287-1EA597E8C836@vimeo.com</li>
</ul>
</div>
</body>
</html>
