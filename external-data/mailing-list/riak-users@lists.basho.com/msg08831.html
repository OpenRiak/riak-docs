<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak exiting when number partitions > 128</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08831" id="c">
<link rel="index" href="maillist.html#08831" id="i">
<link rel="prev" href="msg08830.html" id="p">
<link rel="next" href="msg08832.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08831.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+exiting+when+number+partitions+%3E+128%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak exiting when number partitions > 128</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jeremiah+Peschka%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jeremiah Peschka</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121008" rel="nofollow">Mon, 08 Oct 2012 19:15:23 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>The behavior of su and sudo are at best entertaining and at worst entirely
maddening. Now that you've worked your way through this, hopefully I'll
remember it at some point in the future.</pre><pre>

---
Jeremiah Peschka
Managing Director, Brent Ozar PLF, LLC


On Mon, Oct 8, 2012 at 7:12 PM, David Lowell &lt;d...@go2ctv.com&gt; wrote:

&gt; I just spotted the doc:
&gt;
&gt; <a  rel="nofollow" href="http://wiki.basho.com/Open-Files-Limit.html">http://wiki.basho.com/Open-Files-Limit.html</a>
&gt;
&gt; which has a suggested a better approach for configuring the file limit
&gt; than setting it in /etc/security/limits.d. I've created the
&gt; /etc/default/riak file containing the revised file limit, and that works
&gt; well with the stock 'su' behavior.
&gt;
&gt; Thanks everyone for puzzling this through with me.
&gt;
&gt; Dave
&gt;
&gt; --
&gt; Dave Lowell
&gt; d...@connectv.com
&gt;
&gt; On Oct 8, 2012, at 7:02 PM, David Lowell wrote:
&gt;
&gt; Thanks guys. I had raised the max open files limit at the system level for
&gt; the 'riak' user to 100k, and confirmed that had taken affect with &quot;sudo -u
&gt; riak bash -c 'ulimit -a'&quot;. However, it appears that you are correct that
&gt; this system setting is not affecting the actual startup of riak when I run
&gt; riak's /etc/init.d/riak init script.
&gt;
&gt; Digging further, reveals that 'su' seems not to be helping. Witness:
&gt;
&gt; $ sudo -u riak bash -c 'ulimit -n'
&gt; 100000
&gt; $ sudo su - riak -c 'ulimit -n'
&gt; 1024
&gt;
&gt; I've seen weirdness like this with su in the past, and have been phasing
&gt; it out of my vocabulary.
&gt;
&gt; So, to confirm this was the issue I tweaked riak's init script, replacing
&gt;
&gt;    su - riak -c &quot;$DAEMON $DAEMON_ARGS&quot; || return 2
&gt;
&gt; with
&gt;
&gt;   sudo -u riak $DAEMON $DAEMON_ARGS || return 2
&gt;
&gt; And now riak starts up properly with 512 partitions.
&gt;
&gt; So now the question becomes: is there some way to get &quot;su&quot; to behave more
&gt; like &quot;sudo&quot; in this case? Or do we just need to use a custom init script
&gt; until the stock init script evolves past su?
&gt;
&gt; Dave
&gt;
&gt; --
&gt; Dave Lowell
&gt; d...@connectv.com
&gt;
&gt; On Oct 8, 2012, at 6:21 PM, Jeremiah Peschka wrote:
&gt;
&gt; Like Alex, I state ulimit -n directly in my start Riak start up scripts.
&gt; For my local dev instance it looks like this:
&gt;
&gt; ### Generic Riak dev version setup
&gt; function riak_dev_start() {
&gt;   local CURRENT=`pwd`;
&gt;
&gt;   ulimit -n 1024;
&gt;
&gt;   cd ~/Projects/riak/dev
&gt;   echo &quot;Starting riak node 1 on 127.0.0.1&quot;
&gt;   dev1/bin/riak start
&gt;   echo &quot;Starting riak node 2 on 127.0.0.1&quot;
&gt;   dev2/bin/riak start
&gt;   echo &quot;Starting riak node 3 on 127.0.0.1&quot;
&gt;   dev3/bin/riak start
&gt;   echo &quot;Starting riak node 4 on 127.0.0.1&quot;
&gt;   dev4/bin/riak start
&gt;
&gt;   cd $CURRENT
&gt; }
&gt;
&gt; I'd definitely try bumping ulimit in your riak startup scripts themselves
&gt; and see if that eliminates the issues that you're running into.
&gt; ---
&gt; Jeremiah Peschka
&gt; Managing Director, Brent Ozar PLF, LLC
&gt;
&gt;
&gt; On Mon, Oct 8, 2012 at 6:11 PM, Alexander Sicular &lt;sicul...@gmail.com&gt;wrote:
&gt;
&gt;&gt; I don't think you're setting it correctly. I usually set it in the
&gt;&gt; terminal before calling riak start. Or set it system wide, different ways
&gt;&gt; to do it depending on your os.
&gt;&gt;
&gt;&gt;
&gt;&gt; @siculars
&gt;&gt; <a  rel="nofollow" href="http://siculars.posterous.com">http://siculars.posterous.com</a>
&gt;&gt;
&gt;&gt; Sent from my iRotaryPhone
&gt;&gt;
&gt;&gt; On Oct 8, 2012, at 21:00, David Lowell &lt;d...@go2ctv.com&gt; wrote:
&gt;&gt;
&gt;&gt; I'm starting to want to move past the default Riak configs, for example,
&gt;&gt; by running with a larger number of partitions than the default 64. However,
&gt;&gt; today when bumping up the &quot;ring_creation_size&quot; config param to 256 or
&gt;&gt; higher Riak started failing soon after startup with messages about &quot;Too
&gt;&gt; many open files&quot;. For the record, I'm using the ELevelDB back-end.
&gt;&gt;
&gt;&gt; I've seen the documentation about the need for ring_creation_size *
&gt;&gt; max_open_files file descriptors with levelDB. I've upped the system open
&gt;&gt; files limit for the riak user to 100k, so I don't think I'm hitting that
&gt;&gt; system limit. So it feels like I'm hitting a limit configured within the
&gt;&gt; application somewhere.
&gt;&gt;
&gt;&gt; It doesn't feel like changing levelDB's 'max_open_files' configuration is
&gt;&gt; the issue here, as I'm using the default/minimum value of 20 for that
&gt;&gt; parameter. Any other setting would increase open files.
&gt;&gt;
&gt;&gt; So I could use a pointer here from folks who have been here. I suspect
&gt;&gt; there is something very simple required here.
&gt;&gt;
&gt;&gt; Thanks folks!
&gt;&gt;
&gt;&gt; Dave
&gt;&gt;
&gt;&gt; ps. For the record, my data set is empty on this host, and for
&gt;&gt; completeness I'm blowing away the ring state when I fiddle with the
&gt;&gt; ring_creation_size parameter.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Dave Lowell
&gt;&gt; d...@connectv.com
&gt;&gt;
&gt;&gt;
&gt;&gt; 2012-10-09 00:50:17.430 [info] &lt;0.7.0&gt; Application riak_kv started on
&gt;&gt; node 'riak@10.0.3.81'
&gt;&gt; 2012-10-09 00:50:17.456 [info] &lt;0.7.0&gt; Application merge_index started on
&gt;&gt; node 'riak@10.0.3.81'
&gt;&gt; 2012-10-09 00:50:17.459 [info] &lt;0.1316.0&gt;@riak_core:wait_for_service:445
&gt;&gt; Waiting for service riak_kv to start (0 seconds)
&gt;&gt; 2012-10-09 00:50:17.525 [info]
&gt;&gt; &lt;0.1303.0&gt;@riak_core:wait_for_application:419 Wait complete for application
&gt;&gt; riak_kv (0 seconds)
&gt;&gt; 2012-10-09 00:50:37.366 [error] &lt;0.5081.0&gt;@riak_kv_vnode:init:265 Failed
&gt;&gt; to start riak_kv_eleveldb_backend Reason: {db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;}
&gt;&gt; 2012-10-09 00:50:37.423 [notice] &lt;0.5081.0&gt;@riak:stop:46 &quot;backend module
&gt;&gt; failed to start.&quot;
&gt;&gt; 2012-10-09 00:50:37.424 [error] &lt;0.5081.0&gt; CRASH REPORT Process
&gt;&gt; &lt;0.5081.0&gt; with 0 neighbours exited with reason: {db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;} in gen_fsm:init_it/6 line 371
&gt;&gt; 2012-10-09 00:50:37.429 [info] &lt;0.494.0&gt;@riak_kv_js_vm:terminate:240
&gt;&gt; Spidermonkey VM (pool: riak_kv_js_hook) host stopping (&lt;0.494.0&gt;)
&gt;&gt; 2012-10-09 00:50:37.673 [error] &lt;0.138.0&gt; Supervisor riak_core_vnode_sup
&gt;&gt; had child undefined started with {riak_core_vnode,start_link,undefined} at
&gt;&gt; &lt;0.5081.0&gt; exit with reason {db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;} in context child_terminated
&gt;&gt; 2012-10-09 00:50:37.736 [error] &lt;0.153.0&gt; gen_server
&gt;&gt; riak_core_vnode_manager terminated with reason: no match of right hand
&gt;&gt; value {error,{db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;}} in riak_core_vnode_manager:get_vnode/3 line 489
&gt;&gt; 2012-10-09 00:50:37.799 [error] &lt;0.153.0&gt; CRASH REPORT Process
&gt;&gt; riak_core_vnode_manager with 0 neighbours exited with reason: no match of
&gt;&gt; right hand value {error,{db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;}} in riak_core_vnode_manager:get_vnode/3 line 489 in
&gt;&gt; gen_server:terminate/6 line 747
&gt;&gt; 2012-10-09 00:50:37.844 [error] &lt;0.136.0&gt; Supervisor riak_core_sup had
&gt;&gt; child riak_core_vnode_manager started with
&gt;&gt; riak_core_vnode_manager:start_link() at &lt;0.153.0&gt; exit with reason no match
&gt;&gt; of right hand value {error,{db_open,&quot;IO error:
&gt;&gt; /var/data/ctv/riak/leveldb/1427247692705959881058285969449495136382746624000/LOCK:
&gt;&gt; Too many open files&quot;}} in riak_core_vnode_manager:get_vnode/3 line 489 in
&gt;&gt; context child_terminated
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08830.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08831">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08831">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08832.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08826.html">riak exiting when number partitions &gt; 128</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08827.html">Re: riak exiting when number partitions &gt; 128</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08828.html">Re: riak exiting when number partitions &gt; 12...</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08829.html">Re: riak exiting when number partitions &gt...</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08830.html">Re: riak exiting when number partitions...</a></span> <span class="sender italic">David Lowell</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak exiting when number parti...</span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak exiting when number partitions &gt; 128">
<input type="hidden" name="msgid" value="CACJEN2ohOnpFskYJ=tFidUtWDT6S=cOA9pL_VuoKfJRZOOAQfw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08831.html">
<input type="submit" value=" Jeremiah Peschka ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+exiting+when+number+partitions+%3E+128%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08830.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08832.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACJEN2ohOnpFskYJ=tFidUtWDT6S=cOA9pL_VuoKfJRZOOAQfw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
