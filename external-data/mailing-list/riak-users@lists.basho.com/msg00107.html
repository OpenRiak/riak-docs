<!DOCTYPE html>
<html lang="en">
<head>
<title>Help with protobuf (again)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#00107" id="c">
<link rel="index" href="maillist.html#00107" id="i">
<link rel="prev" href="msg00100.html" id="p">
<link rel="next" href="msg00108.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg00107.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Help+with+protobuf+%5C%28again%5C%29%22&amp;o=newest" rel="nofollow"><span itemprop="name">Help with protobuf (again)</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Pflueger%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Pflueger</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20100421" rel="nofollow">Wed, 21 Apr 2010 10:56:06 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I'm having a small issue setting the client id and getting the client
id using the protobuf interface.  I'm new to using protobufs so I'm
probably doing something stupid.  Below is my code, everything works
up until the last assert.  For some reason, the client ids retrieved
from the message are gibberish (at least to me)...  Any help would be
appreciated!</pre><pre>

    public static void test(String host, int port) {
        InetSocketAddress address = new InetSocketAddress(host, port);

        Socket socket = new Socket();
        socket.setSoTimeout(1000);
        socket.connect(address, 2000);


        CodedOutputStream out =
CodedOutputStream.newInstance(socket.getOutputStream());
        CodedInputStream in =
CodedInputStream.newInstance(socket.getInputStream());

        //ping
        out.writeRawBytes(new byte[] {0, 0, 0, 1, 1});
        out.flush();

        //pong {0, 0, 0, 1, 2}
        int size = parseToInt32(in.readRawBytes(4))-1;
        byte msgCode = in.readRawByte();
        assert msgCode == 2 : &quot;Error pinging server: &quot; +
getErrorMessage(in, msgCode, size);
        System.out.println(&quot;Successfully pinged server&quot;);

        //get server info
        out.writeRawBytes(new byte[] {0, 0, 0, 1, 7});
        out.flush();

        size = parseToInt32(in.readRawBytes(4))-1;
        msgCode = in.readRawByte();
        assert msgCode == 8 : &quot;Error getting server info: &quot; +
getErrorMessage(in, msgCode, size);
        byte[] bytes = in.readRawBytes(size);
        RpbGetServerInfoResp serverInfoResp =
RpbGetServerInfoResp.parseFrom(bytes);
        System.out.println(&quot;Connected to: &quot;
                + serverInfoResp.getNode().toStringUtf8()
                + &quot;, version &quot;
                + serverInfoResp.getServerVersion().toStringUtf8());


        //get client id
        out.writeRawBytes(new byte[] {0, 0, 0, 1, 3});
        out.flush();

        size = parseToInt32(in.readRawBytes(4))-1;
        msgCode = in.readRawByte();
        assert msgCode == 4 : &quot;Error getting client id: &quot; +
getErrorMessage(in, msgCode, size);
        bytes = in.readRawBytes(size);
        System.out.println(&quot;Client id is: &quot; +
RpbGetClientIdResp.parseFrom(bytes).getClientId().toStringUtf8());


        String clientId = &quot;client&quot; + hashCode();

        RpbSetClientIdReq.Builder reqBuilder = RpbSetClientIdReq.newBuilder();
        reqBuilder.setClientId(ByteString.copyFromUtf8(clientId));
        assert reqBuilder.isInitialized() : &quot;Set client id request not
fully initialized&quot;;
        RpbSetClientIdReq req = reqBuilder.build();
        size = req.getSerializedSize()+1;
        out.writeRawBytes(parseFromInt32(size));
        out.writeRawByte(5);
        bytes = req.toByteArray();
        assert bytes.length == size-1;
        out.writeRawBytes(bytes);
        out.flush();

        size = parseToInt32(in.readRawBytes(4));
        msgCode = in.readRawByte();
        assert msgCode == 6 : &quot;Error setting client id: &quot; +
getErrorMessage(in, msgCode, size);

        //get client id
        out.writeRawBytes(new byte[] {0, 0, 0, 1, 3});
        out.flush();

        size = parseToInt32(in.readRawBytes(4))-1;
        msgCode = in.readRawByte();
        assert msgCode == 4 : &quot;Error getting client id: &quot; +
getErrorMessage(in, msgCode, size);
        bytes = in.readRawBytes(size);
        RpbGetClientIdResp clientIdResp = RpbGetClientIdResp.parseFrom(bytes);
        String serverClientId =
clientIdResp.getClientId().toString(&quot;ASCII&quot;);//Utf8();
        assert clientId.equals(serverClientId)
                : &quot;Requested client id &quot; + clientId + &quot; does not match
server's &quot; + serverClientId;
        System.out.println(&quot;Set client id to: &quot; + clientId);
    }


    //support methods - in case you were wondering...
    public static int parseToInt32(byte[] bytes) {
        return (bytes[0] &lt;&lt; 24) + (bytes[1] &lt;&lt; 16) + (bytes[2] &lt;&lt; 8) + bytes[3];
    }

    public static byte[] parseFromInt32(int value) {
        byte[] bytes = new byte[4];
        bytes[0] = (byte)(value &amp; 0xFF000000);
        bytes[1] = (byte)(value &amp; 0x00FF0000);
        bytes[2] = (byte)(value &amp; 0x0000FF00);
        bytes[3] = (byte)(value &amp; 0x000000FF);
        return bytes;
    }


--Matthew

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg00100.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#00107">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#00107">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg00108.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Help with protobuf (again)</span> <span class="sender italic">Matthew Pflueger</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg00108.html">Re: Help with protobuf (again)</a></span> <span class="sender italic">Jon Meredith</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Help with protobuf (again)">
<input type="hidden" name="msgid" value="o2g7037df271004211055nc4a535ffla6dc6b2d551dc35d@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg00107.html">
<input type="submit" value=" Matthew Pflueger ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Help+with+protobuf+%5C%28again%5C%29%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg00100.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg00108.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">o2g7037df271004211055nc4a535ffla6dc6b2d551dc35d@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
