<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Severe problems when adding a new node</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#05344" id="c">
<link rel="index" href="maillist.html#05344" id="i">
<link rel="prev" href="msg05343.html" id="p">
<link rel="next" href="msg05345.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05344.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Severe+problems+when+adding+a+new+node%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Severe problems when adding a new node</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Aphyr%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Aphyr</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111028" rel="nofollow">Fri, 28 Oct 2011 08:31:58 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<tt>I was waiting for Basho to write an official notice about this, but it's 
</tt><tt>been three days and I really don't want anyone else to go through this 
</tt><tt>shitshow.
</tt><pre style="margin: 0em;">

</pre><tt>1.0.1 contains a race condition which can cause vnodes to crash during 
</tt><tt>partition drop. This crash will kill the entire riak process. On our 
</tt><tt>six-node, 1024 partition cluster, during riak-admin leave, we 
</tt><tt>experienced roughly one crash per minute for over an hour. Basho's 
</tt><tt>herculean support efforts got us a patch which forces vnode drop to be 
</tt><tt>synchronous; leave-join is quite stable with this change.
</tt><pre style="margin: 0em;"></pre><pre>

<a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=1263">https://issues.basho.com/show_bug.cgi?id=1263</a>

</pre><tt>I strongly encourage 1.0.1 users to avoid using riak-admin join and 
</tt><tt>riak-admin leave until this patch is available.
</tt><pre style="margin: 0em;">

--Kyle

On 10/28/2011 08:14 AM, John Axel Eriksson wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Last night we did two things. First we upgraded our entire cluster from 
riak-search 0.14.2 to 1.0.1. This process went
pretty well and the cluster was responding correctly after this was completed.

In our cluster we have around 40 000 files stored in Luwak (we also have about 
the same amount of keys, or more, in riak which is mostly
the metadata for the files in Luwak). The files are in sizes ranging from 
around 50K to  around 400MB, most of the files are pretty small though. I
think we're up to a total of around 30GB now.

Anyway, upon adding a new node to the now 1.0.1 cluster I saw the beam.smp 
processes on all the servers, including the new one, taking
up almost all available cpu. It stayed in this state for around an hour and the 
cluster was slow to respond and occasionally timed out. During the
process Riak crashed on random nodes from time to time and I had to restart it. 
After about an hour things settled down. I added this
new node to our load-balancer so it too could serve requests. When testing our 
apps against the cluster we still got lots of timeouts and something
seemed very very wrong.

After a while I did a &quot;riak-admin leave&quot; on the node that was added (kind of a 
panic move I guess). Around 20 minutes after I did this, the cluster started
responding correctly again. All was not well though - files seemed to be 
corrupted(not sure what percentage but could be 1 % or more). I have no idea how
that could happen but files that we had accessed before now contained garbage. 
I haven't thoroughly researched exactly WHAT garbage they contain but
they're not in a usable state anymore. Is this something that could happen 
under any circumstances in Riak?

I'm afraid of adding a node at all now since it resulted in downtime and 
corruption when I tried it. I checked and rechecked the configuration files and 
really - they're
the same on all the nodes (except for vm.args where they have different names 
of course). Has anyone ever seen anything like this? Could it somehow be 
related to
the fact that I did an upgrade from 0.14.2 to 1.0.1 and maybe an hour later 
added a new 1.0.1 node?

Thanks for any input!

John
_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05343.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#05344">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05344">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05345.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg05343.html">Severe problems when adding a new node</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Severe problems when adding a new node</span> <span class="sender italic">Aphyr</span></li>
<li class="icons-email"><span class="subject"><a href="msg05345.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05353.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05355.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">David Smith</span></li>
<li class="icons-email"><span class="subject"><a href="msg05470.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05498.html">Re: Severe problems when adding a new ...</a></span> <span class="sender italic">John Axel Eriksson</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Severe problems when adding a new node">
<input type="hidden" name="msgid" value="4EAACADF.5000809@aphyr.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05344.html">
<input type="submit" value=" Aphyr ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Severe+problems+when+adding+a+new+node%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05343.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05345.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">4EAACADF.5000809@aphyr.com</li>
</ul>
</div>
</body>
</html>
