<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: vclock, vtag, entity tag</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09711" id="c">
<link rel="index" href="maillist.html#09711" id="i">
<link rel="prev" href="msg09692.html" id="p">
<link rel="next" href="msg09712.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09711.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+vclock%2C+vtag%2C+entity+tag%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: vclock, vtag, entity tag</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shuhao%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shuhao</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121230" rel="nofollow">Sun, 30 Dec 2012 14:29:24 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<tt>Does each sibling have an individual vclock or just vclock? I see that 
</tt><tt>riak only returns 1 vclock per get response in PBC.
</tt><pre style="margin: 0em;">

Thanks,</pre><pre>

Shuhao

On 12-12-28 08:33 AM, Sean Cribbs wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Let me clarify a bit:

1) There is only one vclock in a response, but at one time prior to
you requesting the key, the vclock of individual replicas were
divergent, which results in the siblings.
2) The ETag is related to the &quot;vtag&quot; but is not exactly the same.
Reading the riak_kv source gives us this function:

generate_etag(RD, Ctx) -&gt;
     case select_doc(Ctx) of
         {MD, _} -&gt;
             {dict:fetch(?MD_VTAG, MD), RD, Ctx};
         multiple_choices -&gt;
             {ok, Doc} = Ctx#ctx.doc,
             &lt;&lt;ETag:128/integer&gt;&gt; =
crypto:md5(term_to_binary(riak_object:vclock(Doc))),
             {riak_core_util:integer_to_list(ETag, 62), RD, Ctx}
     end.

Also at 
<a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/master/src/riak_kv_wm_object.erl#L861">https://github.com/basho/riak_kv/blob/master/src/riak_kv_wm_object.erl#L861</a>

What that means is, when there is a single item (either when you have
selected the vtag from a list, or when there are no siblings), the
internal &quot;MD_VTAG&quot; metadata is given as the ETag, i.e. the first
clause of the case statement. When there are multiple choices, i.e.
all siblings are listed by vtag or presented in full, then the ETag is
an MD5 hash of the vclock, i.e. the second clause of the case
statement.

Over Protocol Buffers, the same applies, the 'vtag' field is extracted
from the metadata from each sibling. However, there is no top-level
ETag per se, but the encoded vector clock is used for conditional
requests.

On Thu, Dec 27, 2012 at 9:15 PM, Shuhao Wu &lt;shu...@shuhaowu.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Then what exactly is etag/vtag.

Shuhao

On Dec 27, 2012 7:16 PM, &quot;Pavan Venkatesh&quot; &lt;pvenkat...@basho.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

With 2 siblings, you'll still have 1 vector clock (no matter if its
through http or protobuf).
Each sibling will have the same vector clock.

Pavan

From: Shuhao Wu &lt;shu...@shuhaowu.com&gt;
Date: Thursday, December 27, 2012 2:22 PM
To: Pavan Venkatesh &lt;pvenkat...@basho.com&gt;
Cc: &lt;riak-users@lists.basho.com&gt;
Subject: Re: vclock, vtag, entity tag

Wait. So with 2 siblings, I should get 2 different vclock and 2 etags from
http.

But the specification from pbc tells me it will only return 1 vclock and 2
vtags

Shuhao
Sent from my phone.

On 2012-12-27 5:19 PM, &quot;Pavan Venkatesh&quot; &lt;pvenkat...@basho.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Hi Shuhao,

Lets say, two clients update the same object at the same time (through
http or protobuf),then a sibling is created, but with the same vector
clock.They merge into single object with one vector clock, but these
siblings live in the same object.
User intervention is required and one can pick the correct value and
issue
a put request with that vector clock in order to resolve the conflict.
Hope this helps.

Pavan

On 12/25/12 10:08 PM, &quot;Shuhao&quot; &lt;shu...@shuhaowu.com&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi,

I'm just browsing through the API documentations for Riak and I just
noticed a couple of things that's pretty confusing:

It's my understanding that with the HTTP fetch request, each
object/sibling returned will have its own vclock in the form of the HTTP
header `X-Riak-Vclock` and an entity tag under the header `ETag`. There
is also a vtag url parameter specified by the HTTP fetch request which I
assume fetches specific sibling with that entity tag. [1]

[1]:
</pre></blockquote><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/references/apis/http/HTTP-Fetch-Object/">http://docs.basho.com/riak/latest/references/apis/http/HTTP-Fetch-Object/</a>
</pre></blockquote><pre style="margin: 0em;">

However, the protobuf client will return a list of siblings but only
with 1 vclock with `optional bytes vclock = 2;` for all the siblings
returned under `content`. For each sibling, there will be a `vtag`
attribute, which I assume is the entity tag as specified in the HTTP
document. [2]

[2]:
</pre></blockquote><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/references/apis/protocol-buffers/PBC-Fet">http://docs.basho.com/riak/latest/references/apis/protocol-buffers/PBC-Fet</a>
</pre></blockquote><pre style="margin: 0em;">
ch
-Object/

So the confusion is that why is it that in the HTTP request, each
sibling has its own vclock and entity tag/vtag while in the PBC request,
the entire response only has 1 vclock and each object has its own
vtag/entity tag. I'm not too sure if my understanding is complete.

Thanks,

Shuhao

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">



</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09692.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09711">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09711">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09712.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09675.html">vclock, vtag, entity tag</a></span> <span class="sender italic">Shuhao</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09683.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Pavan Venkatesh</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09684.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Shuhao Wu</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg09685.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Pavan Venkatesh</span></li>
<li class="icons-email"><span class="subject"><a href="msg09687.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Pavan Venkatesh</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09688.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09692.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: vclock, vtag, entity tag</span> <span class="sender italic">Shuhao</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09712.html">Re: vclock, vtag, entity tag</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: vclock, vtag, entity tag">
<input type="hidden" name="msgid" value="50E0C03E.7060102@shuhaowu.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09711.html">
<input type="submit" value=" Shuhao ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+vclock%2C+vtag%2C+entity+tag%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09692.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09712.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">50E0C03E.7060102@shuhaowu.com</li>
</ul>
</div>
</body>
</html>
