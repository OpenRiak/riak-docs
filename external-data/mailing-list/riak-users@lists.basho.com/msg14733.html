<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14733" id="c">
<link rel="index" href="maillist.html#14733" id="i">
<link rel="prev" href="msg14726.html" id="p">
<link rel="next" href="msg14735.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14733.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Fwd%5C%3A+RiakCS+504+Timeout+on+s3cmd+for+certain+keys%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alex+Millar%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Millar</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140819" rel="nofollow">Tue, 19 Aug 2014 06:33:46 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey Kota,

We’re currently using the following versions;</pre><pre>

# Download RiakCS 
# Version: 1.4.5
# OS: Ubuntu 12.04 (Precise) AMD 64
curl -O 
<a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb</a>

# Download Riak
# Version: 1.4.8
# OS: Ubuntu 12.04 (Precise) AMD 64
curl -O 
<a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb</a>

I checked our RiakCS app.config and fold_objects_for_list_keys is set to false. 
What impact would it have my cluster if I flip that to true? Would I simply 
update the app.config and restart RiakCS?

As for the consideration on garbage collection, the slow performance is 
happening consistently over the span of a week (since we noticed it as we don’t 
often list buckets). I suspect its not the case regarding large amounts of 
objects being deleted as generally all data going into that bucket is 
write-once (we process PDFs pages to .JPG and PUT them in that bucket, the only 
time overwrites occur is if we manually re-trigger the processing script to run 
on a specific document) 

Adding ke...@basho.com as we have another thread going on about this same 
topic, I figured we could merge the discussion to reduce duplicate effort here. 

                 Alex Millar, CTO  
Office: 1-800-354-8010 ext. 704  
Mobile: 519-729-2539  
GoBonfire.com

From: Kota Uenishi &lt;k...@basho.com&gt;
Reply: Kota Uenishi &lt;k...@basho.com&gt;&gt;
Date: August 18, 2014 at 10:03:40 PM
To: Alex Millar &lt;a...@gobonfire.com&gt;&gt;
Cc: Charlie Voiselle &lt;cvoise...@basho.com&gt;&gt;, Tad Bickford 
&lt;tbickf...@basho.com&gt;&gt;, Riak-Users &lt;riak-users@lists.basho.com&gt;&gt;, Brandon Noad 
&lt;bran...@gobonfire.com&gt;&gt;
Subject:  Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys  

Alex,

Riak CS 1.4.5 and 1.5.0 had a lot of improvement after those articles you put 
the URL, not it is not using Riak's bucket listing but using Riak's internal 
API for more efficient listing. What version of Riak CS are you using? I want 
you to make sure you're using those versions and a line 
`{fold_objects_for_list_keys, true},` at riak_cs section of app.config 
(assuming all other Riak part correctly configured). 

&gt; Based on this I’m thinking that cost of this type of query is only going to 
&gt;get worse over time as we add more keys to this bucket (unless secondary 
&gt;indexes can be added). Or am I totally out to lunch here and there’s some 
&gt;other underlying problem?

The strange part is s3cmd. Riak CS has incremental bucket listing API that 
requires clients to iterate on every 1000 objects (common prefixes), but s3cmd 
iterates all the specified bucket before printing them all. You can observe how 
s3cmd and Riak CS interacts if you specify '-d' option like this:

```
s3cmd -d -c yours.s3cfg ls -r s3://yourbucket/yourdir/
```

I would expect Riak CS's listing API is not much slow  as to need 5 seconds 
(or, say, &gt;10 seconds) because, on each request it just returns 1000 objects. 

There might be another possibility on slow query - if you had many (say, more 
than 10 thousands) deleted objects on the same bucket it might affect each 1000 
listing. This will eventually be solved as Riak CS's garbage collection removes 
deleted manifests, which is just marked as deleted (and to be ignored 
correctly).

[1] 
<a  rel="nofollow" href="http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why">http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why</a>

On Thu, Aug 14, 2014 at 6:05 AM, Alex Millar &lt;a...@gobonfire.com&gt; wrote:
Good afternoon Charlie,

So the issue we’re having is only with bucket listing.

alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls 
s3://bonfirehub-resources-can-east-doc-conversion
                       DIR   
s3://bonfirehub-resources-can-east-doc-conversion/organizations/

real 2m0.747s
user 0m0.076s
sys 0m0.030s

where as…

alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls 
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals
                       DIR   
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals/

real 0m10.262s
user 0m0.075s
sys 0m0.028s

The contents of this bucket contains a lot of very small files (basically for 
each PDF we receive I split it to .JPG foreach page and store them here. Based 
on the my latest counts it looks like we have around 170,000 .JPG files in that 
bucket.

Here’s a snippet from the HAProxy log for the 504 timeouts…

Aug 12 16:01:34 localhost.localdomain haproxy[4718]: 192.0.223.236:48457 
[12/Aug/2014:16:01:24.454] riak_cs~ riak_cs_backend/riak3 161/0/0/-1/10162 504 
194 - - sH-- 0/0/0/0/0 0/0 
{bonfirehub-resources-can-east-doc-conversion.bf-riakcs.com} &quot;GET /?delimiter=/ 
HTTP/1.1&quot;

I’ve put together a video showing off the top results of each of the 5 riak 
nodes while performing $ time s3cmd -c .s3cfg-riakcs-admin ls 
s3://bonfirehub-resources-can-east-doc-conversion

<a  rel="nofollow" href="https://dl.dropboxusercontent.com/u/5723659/RiakCS%20ls%20monitoring%20results.mov">https://dl.dropboxusercontent.com/u/5723659/RiakCS%20ls%20monitoring%20results.mov</a>

Now I’ve had a hunch this is just a fundamentally expensive operation which 
exceeds the 5000ms response time threshold set in our HAProxy config (which I 
raised during the video to illustrate what’s going on). After reading 
<a  rel="nofollow" href="http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why">http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why</a>
 and <a  rel="nofollow" href="http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html I’m">http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html I’m</a> 
feeling like this is just a fundamental issue with the data structure in Riak. 

Based on this I’m thinking that cost of this type of query is only going to get 
worse over time as we add more keys to this bucket (unless secondary indexes 
can be added). Or am I totally out to lunch here and there’s some other 
underlying problem?

I’ve cc’d the mailing list on this as suggested.

        Alex Millar, CTO
Office: 1-800-354-8010 ext. 704
Mobile: 519-729-2539  
GoBonfire.com

From: Charlie Voiselle &lt;cvoise...@basho.com&gt;
Reply: Charlie Voiselle &lt;cvoise...@basho.com&gt;&gt;
Date: August 13, 2014 at 10:36:51 AM
To: Alex Millar &lt;a...@gobonfire.com&gt;&gt;
Cc: Tad Bickford &lt;tbickf...@basho.com&gt;&gt;
Subject:  Fwd: RiakCS 504 Timeout on s3cmd for certain keys



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>




--
Kota UENISHI / @kuenishi
Basho Japan KK</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14726.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14733">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14733">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14735.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14711.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</a></span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14726.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain key...</a></span> <span class="sender italic">Kota Uenishi</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain...</span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14735.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for cer...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys">
<input type="hidden" name="msgid" value="etPan.53f351eb.7545e146.151b@alxndrmlr-mbp.local">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14733.html">
<input type="submit" value=" Alex Millar ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Fwd%5C%3A+RiakCS+504+Timeout+on+s3cmd+for+certain+keys%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14726.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14735.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">etPan.53f351eb.7545e146.151b@alxndrmlr-mbp.local</li>
</ul>
</div>
</body>
</html>
