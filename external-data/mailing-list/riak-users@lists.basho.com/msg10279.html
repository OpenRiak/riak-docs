<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Understanding read_repairs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10279" id="c">
<link rel="index" href="maillist.html#10279" id="i">
<link rel="prev" href="msg10277.html" id="p">
<link rel="next" href="msg10280.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10279.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Understanding+read_repairs%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Understanding read_repairs</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jared+Morrow%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jared Morrow</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130227" rel="nofollow">Wed, 27 Feb 2013 13:23:20 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Belai,

Active Anti-Entropy is doing work building trees and checking data, so it
will slow down gets/puts slightly.  If you can't accept the slight
performance hit, disabling it is the right choice.  In our testing, if you
use eLevelDB, 1.3.0 with AAE enabled is faster than 1.2.1 without AAE in
most cases due to the other speedups added to eLevelDB in 1.3.0.  Since
Bitcask runs about the limit of what a filesystem can handle, AAE
definitely shows a slight performance hit since it is accessing the
filesystem as well.</pre><pre>

Glad to hear the patch solved your other issues.

-Jared



On Wed, Feb 27, 2013 at 1:13 PM, Belai Beshah &lt;belai.bes...@nwgeo.com&gt;wrote:

&gt;  Patch worked good on 1.3, no more continuous read repairs. However, we
&gt; started seeing problems with Set/Get of about 0.1% which was not there in
&gt; the 1.2 release. Since this happens even without the patch on a clean 1.3
&gt;  install we narrowed it down to being Active Anti-Entropy since it looks
&gt; like it is always actively fixing data, may it is our write and read
&gt; immediately pattern or the fact that we have only a single 4TB disk
&gt; behind each node and they can't keep up. With Active Anti-Entropy turned
&gt; off all our tests passed and performance returned to 1.2 levels without
&gt; any read repairs. For now we are happy to continue our tests with Active
&gt; Anti-Entropy turned off but it will be great if we can get some pointer
&gt; from the experts that could explain the behavior we saw. Thanks you guys
&gt; for the help.
&gt;
&gt;  ------------------------------
&gt; *From:* Jared Morrow [ja...@basho.com]
&gt; *Sent:* Friday, February 22, 2013 11:56 AM
&gt; *To:* Belai Beshah
&gt; *Cc:* Russell Brown; riak-users@lists.basho.com
&gt; *Subject:* Re: Understanding read_repairs
&gt;
&gt;   Belai,
&gt;
&gt; One other option is to use our &quot;basho-patches&quot; functionality. We use it to
&gt; run new code on current installations where sending a new .beam file is
&gt; easier than remaking the packages or compiling from source. On your ubuntu
&gt; system using our packages, the folder should be in
&gt; /usr/lib/riak/lib/basho-patches.
&gt;
&gt; To do this you just need the one file changed in the PR pointed to by
&gt; Russell.
&gt;
&gt; Here are the steps to make that happen:
&gt;
&gt;    - Install Erlang R15B01:
&gt;    <a  rel="nofollow" href="http://docs.basho.com/riak/latest/tutorials/installation/Installing-Erlang/">http://docs.basho.com/riak/latest/tutorials/installation/Installing-Erlang/</a>
&gt;    - Get riak_kv: git clone git://github.com/basho/riak_kv.git
&gt;    - compile riak_kv with just 'make'
&gt;    - copy the resulting .beam file in the ebin folder to the machines you
&gt;    need the new file: scp ebin/riak_kv_vnode.beam user@myriaknode
&gt;    :/usr/lib/riak/lib/basho-patches
&gt;    - stop each node and restart them one at a time
&gt;    - If you want to convince yourself you are using the new code, you can
&gt;    do a 'riak attach' to attach to the node and run
&gt;    code:which('riak_kv_vnode'). (Don't forget the '.' at the end)
&gt;
&gt; For example on my dev install here is the command before the file is in
&gt; basho-patches:
&gt;
&gt; (dev2@127.0.0.1)1&gt; code:which('riak_kv_vnode').
&gt; &quot;.../lib/riak_kv-1.3.0/ebin/riak_kv_vnode.beam&quot;
&gt;
&gt; Here is the command after I put the .beam in the basho-patches directory:
&gt;
&gt; (dev2@127.0.0.1)1&gt; code:which('riak_kv_vnode').
&gt; &quot;.../lib/basho-patches/riak_kv_vnode.beam&quot;
&gt;
&gt; Notice the path of the code changed from .../riak_kv-1.3.0/... to
&gt; .../basho-patches/...
&gt;
&gt; That might seem like a lot of work, but it is a really handy and useful
&gt; trick/skill that you might use quite a bit down the road.
&gt;
&gt; Hope that helps,
&gt; Jared
&gt;
&gt;
&gt; On Fri, Feb 22, 2013 at 10:25 AM, Belai Beshah &lt;belai.bes...@nwgeo.com&gt;wrote:
&gt;
&gt;&gt; Thanks Russel, that looks like exactly the problem we saw. I have never
&gt;&gt; built riak from source before but I will give it a try it this weekend.
&gt;&gt;
&gt;&gt; ________________________________________
&gt;&gt; From: Russell Brown [russell.br...@me.com]
&gt;&gt; Sent: Friday, February 22, 2013 1:24 AM
&gt;&gt; To: Belai Beshah
&gt;&gt; Cc: riak-users@lists.basho.com
&gt;&gt; Subject: Re: Understanding read_repairs
&gt;&gt;
&gt;&gt; Hi,
&gt;&gt; Thanks for trying Riak.
&gt;&gt;
&gt;&gt; On 21 Feb 2013, at 23:48, Belai Beshah &lt;belai.bes...@nwgeo.com&gt; wrote:
&gt;&gt;
&gt;&gt; &gt; Hi All,
&gt;&gt; &gt;
&gt;&gt; &gt; We are evaluating Riak to see if it can be used to cache large blobs of
&gt;&gt; data. Here is our test cluster setup:
&gt;&gt; &gt;
&gt;&gt; &gt;       • six Ubuntu LTS 12.04 dedicated nodes with 8 core 2.6 Ghz CPU,
&gt;&gt; 32 GB RAM, 3.6T disk
&gt;&gt; &gt;       • {pb_backlog, 64},
&gt;&gt; &gt;       • {ring_creation_size, 256},
&gt;&gt; &gt;       • {default_bucket_props, [{n_val, 2},
&gt;&gt; {allow_mult,false},{last_write_wins,true}]},
&gt;&gt; &gt;       • using bitcask as the backend
&gt;&gt; &gt;
&gt;&gt; &gt; Everything else default except the above. There is an HAProxy load
&gt;&gt; balancer infront of the nodes that the clients talk too configured
&gt;&gt; according to the basho wiki. Due to the nature of the application we are
&gt;&gt; integrating we do about 1200/s writes of approximately 40-50KB each and
&gt;&gt; read them back almost immediately. We noticed a lot of read repairs and
&gt;&gt; since that was one of the things that could indicate performance problem we
&gt;&gt; go worried. So we wrote a simple java client application that simulates our
&gt;&gt; use case. The test program is dead simple:
&gt;&gt; &gt;       • generate keys using random UUID and value using Apache commons
&gt;&gt; RandomStringUtils
&gt;&gt; &gt;       • create a thread pool of 5 and store key/value using
&gt;&gt; “bucket.store()”
&gt;&gt; &gt;       • read the values back using “bucket.fetch()” multiple times
&gt;&gt; &gt; I could provide the spike code if needed. What we noticed is that we
&gt;&gt; get a lot of read repairs all over the place. We even made it use a single
&gt;&gt; thread to read/write, played with the write/read quorum and even put a
&gt;&gt; delay of 5 minutes between the writes before the reads start to give the
&gt;&gt; cluster time to be eventually consistent. Nothing helps, we always see a
&gt;&gt; lot of read repairs, sometime as many as the number of inserts.
&gt;&gt;
&gt;&gt;
&gt;&gt; It sounds like you are experiencing this bug
&gt;&gt; <a  rel="nofollow" href="https://github.com/basho/riak_kv/pull/334">https://github.com/basho/riak_kv/pull/334</a>
&gt;&gt;
&gt;&gt; It is fixed in master, but it doesn't look like it made it into 1.3.0. If
&gt;&gt; you're ok with building from source, I tried it and a patch from
&gt;&gt; 8895d2877576af2441bee755028df1a6cf2174c7 goes cleanly onto 1.3.0.
&gt;&gt;
&gt;&gt; Cheers
&gt;&gt;
&gt;&gt; Russell
&gt;&gt;
&gt;&gt;
&gt;&gt; &gt; The good thing is that in all of these tests we have not seen any read
&gt;&gt; failures. Performance is also not bad, a few maxs here and there we don't
&gt;&gt; like but 90% looks good. Even when we killed a node, the reads are still
&gt;&gt; successful.
&gt;&gt; &gt;
&gt;&gt; &gt; We are wondering what the expected ratio of read repairs is and what is
&gt;&gt; a reasonable time for the cluster not to restore to read_repair to fulfill
&gt;&gt; a read request or is there something we are missing in our setup.
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks
&gt;&gt; &gt; Belai
&gt;&gt; &gt; _______________________________________________
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10277.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10279">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10279">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10280.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10187.html">Understanding read_repairs</a></span> <span class="sender italic">Belai Beshah</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10199.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10210.html">RE: Understanding read_repairs</a></span> <span class="sender italic">Belai Beshah</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10211.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10212.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Andrew Thompson</span></li>
<li class="icons-email"><span class="subject"><a href="msg10238.html">RE: Understanding read_repairs</a></span> <span class="sender italic">Belai Beshah</span></li>
<li class="icons-email"><span class="subject"><a href="msg10277.html">RE: Understanding read_repairs</a></span> <span class="sender italic">Belai Beshah</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Understanding read_repairs</span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10280.html">RE: Understanding read_repai...</a></span> <span class="sender italic">Belai Beshah</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10298.html">Re: Understanding read_r...</a></span> <span class="sender italic">Kresten Krab Thorup</span></li>
<li class="icons-email"><span class="subject"><a href="msg10301.html">RE: Understanding read_r...</a></span> <span class="sender italic">Belai Beshah</span></li>
<li class="icons-email"><span class="subject"><a href="msg10302.html">Re: Understanding read_r...</a></span> <span class="sender italic">Russell Brown</span></li>
<li class="icons-email"><span class="subject"><a href="msg10303.html">RE: Understanding read_r...</a></span> <span class="sender italic">Belai Beshah</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10287.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Sebastian Cohnen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10293.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10297.html">Re: Understanding read_repai...</a></span> <span class="sender italic">Sebastian Cohnen</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10230.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Sebastian Cohnen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10231.html">Re: Understanding read_repairs</a></span> <span class="sender italic">Russell Brown</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Understanding read_repairs">
<input type="hidden" name="msgid" value="CACUSOvdS95QPqj-VrANDz5BJbFpVDM5JGDzktZoQAK-70JXC3w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10279.html">
<input type="submit" value=" Jared Morrow ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Understanding+read_repairs%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10277.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10280.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACUSOvdS95QPqj-VrANDz5BJbFpVDM5JGDzktZoQAK-70JXC3w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
