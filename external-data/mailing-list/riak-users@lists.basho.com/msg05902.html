<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Why is the data lost in luwak</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#05902" id="c">
<link rel="index" href="maillist.html#05902" id="i">
<link rel="prev" href="msg05901.html" id="p">
<link rel="next" href="msg05855.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05902.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Why+is+the+data+lost+in+luwak%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Why is the data lost in luwak</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kelly+McLaughlin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kelly McLaughlin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111208" rel="nofollow">Thu, 08 Dec 2011 22:43:38 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Fisher,

Yes you will get poorer performance using the synchronous api, but the tradeoff 
is you can detect failures as they happen. Alternatively you could use the 
asynchronous api and verify the file size matches what it should be at the end 
and if not reload the file. The best choice depends on the size of files you're 
dealing with, the reliability of the network, and the needs of your 
application. However, if I understand correctly, your concern about more open 
files with the synchronous api is not warranted. You're not actually opening 
more files when you use the synchronous api versus the asynchronous api, you're 
just creating more erlang references to the luwak file objects. Hopefully I 
interpreted your concern correctly and that helps shed some light on it. Cheers.</pre><pre>

Kelly

On Dec 8, 2011, at 11:21 PM, vuleetu wrote:

&gt; Hi, Kelly
&gt; 
&gt;   Is there any efficiency problem if i use synchronous api,  i.e.
&gt; 
&gt;   luwak_io:put_range(Riak::riak(), File::luwak_file(), Start::int(),
&gt; Data::binary()) -&gt; {ok, WrittenBlocks, NewFile}
&gt; 
&gt;   Because in general the stream way is better for the continuous
&gt; write operation, it reduce the amount of open file operation.
&gt; 
&gt; 
&gt;  Thanks
&gt;  Fisher
&gt; 
&gt; On Fri, Dec 9, 2011 at 2:13 PM, Kelly McLaughlin &lt;ke...@basho.com&gt; wrote:
&gt;&gt; Fisher,
&gt;&gt; 
&gt;&gt; Currently you're using the asynchronous api so you won't be able to 
&gt;&gt; determine if the send calls actually succeed or not. The synchronous api is 
&gt;&gt; probably going to be what you want to use. There are some examples in the 
&gt;&gt; luwak readme file that should help you get started with it.
&gt;&gt; 
&gt;&gt; Kelly
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Dec 8, 2011, at 9:57 PM, vuleetu wrote:
&gt;&gt; 
&gt;&gt;&gt; Hi, Kelly
&gt;&gt;&gt; 
&gt;&gt;&gt;   Actually, i did it as you said yesterday. it still return the
&gt;&gt;&gt; unexpected size.  If i remove flush() call, it will work. So right now
&gt;&gt;&gt; this is a big problem now. the problem is the portion data of file is
&gt;&gt;&gt; lost. I does not happen every time.
&gt;&gt;&gt; 
&gt;&gt;&gt; Is there any way to let me know if the write to riak via luwak is
&gt;&gt;&gt; success or not? because the connection to RiakNode might be down
&gt;&gt;&gt; during the write operation using luwak_put_stream:send().
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; RiakNode = 'riak@127.0.0.1'.
&gt;&gt;&gt; {ok, Riak} = riak:client_connect(RiakNode).
&gt;&gt;&gt; 
&gt;&gt;&gt; luwak_put_stream:send()
&gt;&gt;&gt; 
&gt;&gt;&gt; %% assume node is down  at this point
&gt;&gt;&gt; 
&gt;&gt;&gt; %% continue write
&gt;&gt;&gt; luwak_put_stream:send()
&gt;&gt;&gt; luwak_put_stream:send()
&gt;&gt;&gt; 
&gt;&gt;&gt; luwak_put_stream:close().
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; I don't know if the write is successful or not, so it may cause the
&gt;&gt;&gt; data lost sometime, is that right?
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks
&gt;&gt;&gt; Fisher
&gt;&gt;&gt; 
&gt;&gt;&gt; On Fri, Dec 9, 2011 at 12:51 AM, Kelly McLaughlin &lt;ke...@basho.com&gt; wrote:
&gt;&gt;&gt;&gt; Fisher,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Yeah don't use flush. Make the calls to send to put the data and then call 
&gt;&gt;&gt;&gt; close and you should get the expected behavior.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Dec 7, 2011, at 11:13 PM, vuleetu wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Thu, Dec 8, 2011 at 1:57 PM, Kelly McLaughlin &lt;ke...@basho.com&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Fisher,
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; You need to call luwak_put_stream:close(Ps) to force the flush. That 
&gt;&gt;&gt;&gt;&gt;&gt; should
&gt;&gt;&gt;&gt;&gt;&gt; get it for you. Cheers.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Kelly
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi, Kelly
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;  RiakNode = 'riak@127.0.0.1'.
&gt;&gt;&gt;&gt;&gt;  {ok, Riak} = riak:client_connect(RiakNode).
&gt;&gt;&gt;&gt;&gt;  {ok, RiakFile} = luwak_file:create(Riak, &lt;&lt;&quot;testabc22yeah3&quot;&gt;&gt;, 
&gt;&gt;&gt;&gt;&gt; dict:new()).
&gt;&gt;&gt;&gt;&gt;  Ps = luwak_put_stream:start(Riak, RiakFile, 0, 1000000).
&gt;&gt;&gt;&gt;&gt;  luwak_put_stream:send(Ps, &lt;&lt;&quot;1234&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;  luwak_put_stream:flush(Ps).
&gt;&gt;&gt;&gt;&gt;  {ok, RiakFile2} = luwak_file:get(Riak, &lt;&lt;&quot;testabc22yeah3&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;  luwak_file:length(Riak, RiakFile2).      %% Length is 4
&gt;&gt;&gt;&gt;&gt;  luwak_put_stream:send(Ps, &lt;&lt;&quot;56789&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;  luwak_put_stream:close(Ps).
&gt;&gt;&gt;&gt;&gt;  {ok, RiakFile3} = luwak_file:get(Riak, &lt;&lt;&quot;testabc22yeah3&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;  luwak_file:length(Riak, RiakFile3).  %% Length still 13
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;   After i call close(), I still get the unexpected size(13bytes), is
&gt;&gt;&gt;&gt;&gt; this the expected behavior?  Can I not call flush() manually on a
&gt;&gt;&gt;&gt;&gt; stream?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;  this is the version info:
&gt;&gt;&gt;&gt;&gt;  luwak-1.1.0
&gt;&gt;&gt;&gt;&gt;  riak_core-1.0.0          riak_kv-1.0.0            riak_pipe-1.0.0
&gt;&gt;&gt;&gt;&gt;  riak_search-1.0.0        riak_sysmon-1.0.0        riakc-1.2.0
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Fisher
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Dec 7, 2011, at 10:05 PM, vuleetu wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; luwak_put_stream:send(Ps, &lt;&lt;&quot;56789&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;&gt; luwak_put_stream:flush(Ps).
&gt;&gt;&gt;&gt;&gt;&gt; {ok, RiakFile3} = luwak_file:get(Riak, &lt;&lt;&quot;testabc22yeah3&quot;&gt;&gt;).
&gt;&gt;&gt;&gt;&gt;&gt; luwak_file:length(Riak, RiakFile3).
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt; 
&gt;&gt; 


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05901.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#05902">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05902">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05855.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg05854.html">Why is the data lost in luwak</a></span> <span class="sender italic">vuleetu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05881.html">Re: Why is the data lost in luwak</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05890.html">Re: Why is the data lost in luwak</a></span> <span class="sender italic">vuleetu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05891.html">Re: Why is the data lost in luwak</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05892.html">Re: Why is the data lost in luwak</a></span> <span class="sender italic">vuleetu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05895.html">Re: Why is the data lost in luwak</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05901.html">Re: Why is the data lost in luw...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Why is the data lost in...</span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Why is the data lost in luwak">
<input type="hidden" name="msgid" value="A1CD57FB-ED50-420C-83C0-08E488A5935E@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05902.html">
<input type="submit" value=" Kelly McLaughlin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Why+is+the+data+lost+in+luwak%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05901.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05855.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">A1CD57FB-ED50-420C-83C0-08E488A5935E@basho.com</li>
</ul>
</div>
</body>
</html>
