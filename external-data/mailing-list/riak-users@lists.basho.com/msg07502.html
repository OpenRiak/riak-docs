<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Map / Reduce / Map capacity limit reached at 20000 keys /	Doubt about reduce step</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07502" id="c">
<link rel="index" href="maillist.html#07502" id="i">
<link rel="prev" href="msg07496.html" id="p">
<link rel="next" href="msg07510.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07502.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Map+%5C%2F+Reduce+%5C%2F+Map+capacity+limit+reached+at+20000+keys+%5C%2F%09Doubt+about+reduce+step%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Map / Reduce / Map capacity limit reached at 20000 keys /	Doubt about reduce step</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22claudef%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">claudef</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120522" rel="nofollow">Tue, 22 May 2012 09:10:48 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Dear Matthew, 

The capacity adjustment at the Java script engines worked fine. I was able 
to run a clean-up on the database. I also decided o double the JS memory 
space to 16 MB, as RAM is not the issue on our server,  There is still a 
doubt about the Map &amp; Reduce syntax which is not giving a matching result: 
 </pre><pre>

My simple JavaScript, pattern scan &amp; count works OK and delivers a counter 
for a pattern search : 

query.map(&quot;&quot;&quot;function(v) { var str = '&quot;&quot;&quot;+search_string+&quot;&quot;&quot;'; var data = 
JSON.parse(v.values[0].data); if 
(v.values[0].data.toString().toUpperCase().search(str) != -1) { return 
[[v.key, data]]; } return []; }&quot;&quot;&quot;)
query.reduce(&quot;function(v) { var counteri = 0;  for(var i in v) {counteri 
+= 1;} return [['counter_found', counteri]]; } &quot;) 
 
The map function as you sent below returns a list of  keys and 1 like this 
 

query.map(&quot;&quot;&quot;function(v) {if 
(v.values[0].data.search('&quot;&quot;&quot;+search_string+&quot;&quot;&quot;') != -1) { return [[v.key, 
1]]; } return []; }&quot;&quot;&quot;)

How many keys in the bucket: 1000
agFa82470070 - 1
sDko48992336 - 1
eFxO66269553 - 1
Sovt26572593 - 1
.. 

This looks good. By using the JavaScript reduce function I get a zero 
result 

Source:  query.reduce(&quot;function(v) { return 
[v.reduce(function(acc,value){return acc + value;},0)]}&quot;)

Output:   0 - 0 

Thanks in advance for clarification. 

Regards, 
Claude

Claude Falbriard 
Certified IT Specialist L2 - Middleware
AMS Hortolândia / SP - Brazil
phone:    +55 19 9837 0789
cell:         +55 13 8117 3316
e-mail:    clau...@br.ibm.com
blog:        <a  rel="nofollow" href="https://w3.tap.ibm.com/weblogs/inovarMF/">https://w3.tap.ibm.com/weblogs/inovarMF/</a>

Project CallOwn Blue 



From:   Matthew Tovbin &lt;matt...@tovbin.com&gt;
To:     clau...@br.ibm.com
Cc:     riak-users@lists.basho.com
Date:   21/05/2012 17:01
Subject:        Re: Riak Map / Reduce / Map capacity limit reached at 
20000 keys
Sent by:        tovb...@gmail.com



Claude,

1.
try to increase js_vm_counts as follows:

{riak_kv, [
             ...
            {map_js_vm_count, 24 },
            {reduce_js_vm_count, 18 },
            ...]

2. optimize your js function:
query.map(&quot;&quot;&quot;function(v) {if 
(v.values[0].data.search('&quot;&quot;&quot;+search_string+&quot;&quot;&quot;') != -1) { return [[v.key, 
1]]; } return []; }&quot;&quot;&quot;)
query.reduce(&quot;function(v) { return [v.reduce(function(acc,value){return 
acc + value;},0]; } &quot;) 


-Matthew



On Mon, May 21, 2012 at 10:02 AM, &lt;clau...@br.ibm.com&gt; wrote:
Dear colleagues, 

 During my pilot testing I've got an error message during a text pattern 
search operation coded as a Riak Client &quot;map&quot; logic. This error appeared 
at a volume of approximately 20.000 keys, each with an 1 KB free text data 
block associated. The Map function was coded in JavaScript. Here the 
source: 

query.map(&quot;&quot;&quot;function(v) { var str = '&quot;&quot;&quot;+search_string+&quot;&quot;&quot;'; var data = 
JSON.parse(v.values[0].data); if (v.values[0].data.toString().search(str) 
!= -1) { return [[v.key, data]]; } return []; }&quot;&quot;&quot;) 
query.reduce(&quot;function(v) { var counteri = 0;  for(var i in v) {counteri 
+= 1;} return [['counter_found', counteri]]; } &quot;) 

The error shown is the following : [preflist_exhausted] 

zbra:/opt/python/myprojects/riak # python pilot3.py 
starts at : 2012-05-21 07:35:49.070470 
How many keys in the bucket: 19760 
Riak client exception: Error running MapReduce operation. Status: 500 : 
{&quot;phase&quot;:0,&quot;error&quot;:&quot;[preflist_exhausted]&quot;,&quot;input&quot;:&quot;{ok,{r_object,&lt;&lt;\&quot;ramtest\&quot;&gt;&gt;,&lt;&lt;\&quot;XDHt25887344\&quot;&gt;&gt;,[{r_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[&lt;&lt;\&quot;Links\&quot;&gt;&gt;]],[],[],[],[],[],[],[],[[&lt;&lt;\&quot;content-type\&quot;&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\&quot;X-Riak-VTag\&quot;&gt;&gt;,53,86,72,48,120,77,53,99,114,86,111,77,77,54,109,114,79,70,54,52,49,109]],[[&lt;&lt;\&quot;index\&quot;&gt;&gt;]],[],[[&lt;&lt;\&quot;X-Riak-Last-Modified\&quot;&gt;&gt;|{1337,595548,374416}]],[],[[&lt;&lt;\&quot;X-Riak-Meta\&quot;&gt;&gt;]]}}},&lt;&lt;\&quot;{\&quot;is_valid\&quot;:
 
true, \&quot;cEDO\&quot;: 
\&quot;GQZumfdWBCfX...\&quot;&gt;&gt;}],...},...}&quot;,&quot;type&quot;:&quot;forward_preflist&quot;,&quot;stack&quot;:&quot;[]&quot;} 


Any suggestions how to improve the pattern scan capability in the in the 
RiakClient  map function, or how enhance the JavaScript code for better 
capacity? 
Are there any servers setup tuning options to adjust? 

Thanks in advance for your support. 

Regards, 
Claude

Claude Falbriard 
Certified IT Specialist L2 - Middleware
AMS Hortolândia / SP - Brazil
phone:    +55 19 9837 0789
cell:         +55 13 8117 3316
e-mail:    clau...@br.ibm.com

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


</pre><p><tt>&lt;&lt;image/jpeg&gt;&gt;</tt></p><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07496.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07502">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07502">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07510.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07494.html">Riak Map / Reduce / Map capacity limit reached at 20000 key...</a></span> <span class="sender italic">claudef</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07496.html">Re: Riak Map / Reduce / Map capacity limit reached at ...</a></span> <span class="sender italic">Matthew Tovbin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Map / Reduce / Map capacity limit reached...</span> <span class="sender italic">claudef</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07510.html">Re: Riak Map / Reduce / Map capacity limit rea...</a></span> <span class="sender italic">Matthew Tovbin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Map / Reduce / Map capacity limit reached at 20000 keys /	Doubt about reduce step">
<input type="hidden" name="msgid" value="OF4DD9187C.BC3832F7-ON83257A06.00557FEA-03257A06.0058D9FB@br.ibm.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07502.html">
<input type="submit" value=" claudef ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Map+%5C%2F+Reduce+%5C%2F+Map+capacity+limit+reached+at+20000+keys+%5C%2F%09Doubt+about+reduce+step%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07496.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07510.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">OF4DD9187C.BC3832F7-ON83257A06.00557FEA-03257A06.0058D9FB@br.ibm.com</li>
</ul>
</div>
</body>
</html>
