<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Erlang API vs Erlang PBC</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02044" id="c">
<link rel="index" href="maillist.html#02044" id="i">
<link rel="prev" href="msg02039.html" id="p">
<link rel="next" href="msg02129.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02044.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Erlang+API+vs+Erlang+PBC%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Erlang API vs Erlang PBC</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Anthony+Molinaro%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Anthony Molinaro</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110121" rel="nofollow">Fri, 21 Jan 2011 14:38:24 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Just thought I'm chime is as I also just recently wrote a client pool, which
works in a very different way from these two.</pre><pre>

The problem that I see with both solutions presented, is that in order
to get a client you have to route through a gen_server call, so you are
bottlenecking yourself if you ever have very high traffic.

My solution uses a simple one for one supervisor to manage the
riakc_socket_pb gen_servers and a pg2 for the pooling.  pg2 is
actually a distributed process pool, but has a very nice call
called get_closest_pid/1 which will return a random pid from your
pool (and prefer to the local pids [ie, those on the local node]),
but without the overhead of a gen_server call.

Instead it uses ETS to manage the pids which are part of a pool,
then just queries ETS (which can happen in the process itself).
If randomly selecting members of the pool isn't what you want, you
can check out this article

<a  rel="nofollow" href="http://lethain.com/entry/2009/sep/12/load-balancing-across-erlang-process-groups/">http://lethain.com/entry/2009/sep/12/load-balancing-across-erlang-process-groups/</a>

for a strategy which uses message queue length to determine where to
route a message.  The fact is that each process already has a built
in queue in its mailbox, so assuming you are provisioning the right
number of processes, there's no need to queue elsewhere, and using
this to route to the least loaded connection should work and be doable
in each process without the bottle neck of a single gen_server queue.

I stuck the code here <a  rel="nofollow" href="https://gist.github.com/790556">https://gist.github.com/790556</a> although I edited
it down and did some renaming so it might not compile if you want to
play with it.  But basic usage is

1&gt; pool_sup:start_link ([]).
2&gt; Pid = pool_manager:get_connection().
3&gt; riakc_socket_pb:get(Pid,....).

Let me know if there's any comments or questions about it.

-Anthony

On Fri, Jan 21, 2011 at 07:40:15AM -0500, Ryan Zezeski wrote:
&gt; I was hesitant to mention it at first, but since you broke the ice...I also
&gt; wrote my own pool.  However, I took a different approach.  My pool only
&gt; cares about doling out connections and making sure they are alive.  One or
&gt; more processes could use the same conn at a given time (side question: is
&gt; that a problem?).  My pool relies on the fact that each conn has N-1 other
&gt; conns after it before it gets reused, where N = the size of the pool.
&gt; 
&gt; That said, I hacked mine together in 15 minutes for something I needed at
&gt; work.  It seemed to handle a reasonable load (100+ concurrent connections)
&gt; just fine, so I'm using it, but I don't know if I'd suggest anyone else
&gt; using it.  I'm mainly putting it up here as contrast to your (David's) pool
&gt; and I was curious to get feedback if I'm doing anything insanely stupid?
&gt; 
&gt; <a  rel="nofollow" href="https://gist.github.com/789616">https://gist.github.com/789616</a>
&gt; 
&gt; -Ryan
&gt; 
&gt; On Fri, Jan 21, 2011 at 7:12 AM, David Dawson &lt;david.daw...@gmail.com&gt;wrote:
&gt; 
&gt; &gt; I am not sure if this is any help but I have uploaded a protocol buffer
&gt; &gt; pool client for riak which requires you to pass a client_id for each
&gt; &gt; operation.
&gt; &gt;
&gt; &gt; <a  rel="nofollow" href="https://github.com/DangerDawson/riakc_pb_pool">https://github.com/DangerDawson/riakc_pb_pool</a>
&gt; &gt;
&gt; &gt; It is very very basic, but does most of the useful things:
&gt; &gt;
&gt; &gt;        - put / get / delete
&gt; &gt;        - riak disconnects,
&gt; &gt;        - Clients that die after leasing a riak connection ( connection is
&gt; &gt; returned to the pool )
&gt; &gt;        - Dynamically increasing the size of the connection pool
&gt; &gt;        - Queueing requests if there are no connections available
&gt; &gt;        - Useful Statistics
&gt; &gt;
&gt; &gt; Of course the documentation is very sparse and needs improving, which I
&gt; &gt; will get round to.
&gt; &gt;
&gt; &gt; Dave
&gt; &gt;
&gt; &gt;
&gt; &gt; On 21 Jan 2011, at 00:43, Bob Ippolito wrote:
&gt; &gt;
&gt; &gt; &gt; Another issue we've run into is that the Erlang native client allows
&gt; &gt; &gt; you to store non-binary values, which can not be accessed from the
&gt; &gt; &gt; PBC.... so if you're not careful or don't know better, you'll be in
&gt; &gt; &gt; for some migration if you're trying to use other clients.
&gt; &gt; &gt;
&gt; &gt; &gt; The only real problem is that the PBC needs some additional software
&gt; &gt; &gt; around it to pool connections, where the Erlang native client got that
&gt; &gt; &gt; for free because it was leveraging Erlang distribution.
&gt; &gt; &gt;
&gt; &gt; &gt; On Fri, Jan 21, 2011 at 3:57 AM, Ryan Maclear &lt;r...@lambdasphere.com&gt;
&gt; &gt; wrote:
&gt; &gt; &gt;&gt; Agreed. So it therefore makes sense to start using the PBC from the
&gt; &gt; outset, allowing for future moving of the client app off any cluster node(s)
&gt; &gt; it might be residing on, as well as not being affecting by any subtle
&gt; &gt; changes to the internals of the riak_kv code base (specifically the non-PB
&gt; &gt; modules).
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; On 20 Jan 2011, at 9:37 PM, Mojito Sorbet wrote:
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt;&gt; To me the major concern is that if you use the native (non-PB)
&gt; &gt; &gt;&gt;&gt; interface, your application cluster and the Riak cluster become merged
&gt; &gt; &gt;&gt;&gt; into one big Erlang cluster.   The number of TCP connections can start
&gt; &gt; &gt;&gt;&gt; getting out of hand, and the work put on the cluster manager starts to
&gt; &gt; &gt;&gt;&gt; become significant.
&gt; &gt; &gt;&gt;&gt;
&gt; &gt; &gt;&gt;&gt;
&gt; &gt; &gt;&gt;&gt; _______________________________________________
&gt; &gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; _______________________________________________
&gt; &gt; &gt;&gt; riak-users mailing list
&gt; &gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt; &gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;
&gt; &gt; &gt; _______________________________________________
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt;
&gt; &gt;
&gt; &gt; _______________________________________________
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt;

&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


-- 
------------------------------------------------------------------------
Anthony Molinaro                           &lt;antho...@alumni.caltech.edu&gt;

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02039.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02044">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02044">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02129.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02025.html">Erlang API vs Erlang PBC</a></span> <span class="sender italic">Ryan Maclear</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02026.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02027.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Ryan Maclear</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02028.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Bob Ippolito</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02033.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Mojito Sorbet</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02034.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Ryan Maclear</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02036.html">Re: Erlang API vs Erlang PBC</a></span> <span class="sender italic">Bob Ippolito</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02037.html">Re: Erlang API vs Erlang PB...</a></span> <span class="sender italic">David Dawson</span></li>
<li class="icons-email"><span class="subject"><a href="msg02039.html">Re: Erlang API vs Erlang PB...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Erlang API vs Erlang PB...</span> <span class="sender italic">Anthony Molinaro</span></li>
<li class="icons-email"><span class="subject"><a href="msg02129.html">Re: Erlang API vs Erlang PB...</a></span> <span class="sender italic">Seth Falcon</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Erlang API vs Erlang PBC">
<input type="hidden" name="msgid" value="20110121223755.GB96874@alumni.caltech.edu">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02044.html">
<input type="submit" value=" Anthony Molinaro ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Erlang+API+vs+Erlang+PBC%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02039.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02129.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">20110121223755.GB96874@alumni.caltech.edu</li>
</ul>
</div>
</body>
</html>
