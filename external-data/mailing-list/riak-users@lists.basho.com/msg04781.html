<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Precommit Hook Difficulties</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#04781" id="c">
<link rel="index" href="maillist.html#04781" id="i">
<link rel="prev" href="msg04780.html" id="p">
<link rel="next" href="msg04783.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg04781.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Precommit+Hook+Difficulties%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Precommit Hook Difficulties</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Greg+Pascale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Greg Pascale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110919" rel="nofollow">Mon, 19 Sep 2011 12:44:35 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Thanks,

I was able to work around the issue by using regexes to do string replacement, 
thereby avoiding decoding and encoding JSON, but it would be nice to know what 
was going wrong here.</pre><pre>

-Greg
Clipboard



On Sep 19, 2011, at 11:44 AM, Sean Cribbs wrote:

&gt; Greg,
&gt; 
&gt; Your general approach looks good, and jives with my reading of the 
&gt; riak_object module. Let us know if you still have problems with mochijson2.
&gt; 
&gt; Sean
&gt; 
&gt; On Mon, Sep 19, 2011 at 1:42 PM, Greg Pascale &lt;g...@clipboard.com&gt; wrote:
&gt; Scratch that - the issue doesn't actually manifest without the decode/encode.
&gt; 
&gt; 
&gt; On Mon, Sep 19, 2011 at 10:47 AM, Greg Pascale &lt;g...@clipboard.com&gt; wrote:
&gt; Actually it looks like I can remove the JSON decode/encode and I still see 
&gt; the same issue. Just reading and writing the value is enough, so all I'm 
&gt; doing now is
&gt; 
&gt; precommit(RiakObject) -&gt;
&gt;         Value = riak_object:get_value(RiakObject),
&gt;         riak_object:apply_updates(
&gt;           riak_object:update_value(RiakObject, Value)).
&gt; 
&gt; I'm really baffled here. The only documentation I know of for this code is at 
&gt; <a  rel="nofollow" href="http://basho.github.com/riak-erlang-client/riak-erlang-client/riakc_obj.html">http://basho.github.com/riak-erlang-client/riak-erlang-client/riakc_obj.html</a> 
&gt; and it really doesn't say much.
&gt; 
&gt; -Greg
&gt; Clipboard
&gt; 
&gt; On Sat, Sep 17, 2011 at 4:11 PM, Greg Pascale &lt;g...@clipboard.com&gt; wrote:
&gt; Hi,
&gt; 
&gt; I'm trying to write a simple precommit hook to modify a JSON object by 
&gt; removing certain fields. The simplest way to do this, I figure, is to decode 
&gt; the object's value with mochijson2, remove the fields I don't want, re-encode 
&gt; it, and update the value.
&gt; 
&gt; What happens, though, is my object ends up somehow mangled. When I inspect it 
&gt; via curl, it sort of looks like JSON, but characters like &quot;{&quot; and &quot;:&quot; seem to 
&gt; be replaced with garbage.
&gt; 
&gt; For example, what should read &quot;hostname&quot;:&quot;www.google.com&quot; looks like 
&gt; hostnamea&quot;ja:la&quot;mwww.google.coma&quot;j
&gt; 
&gt; To try to diagnose the issue, I reduced my hook to the simplest possible 
&gt; case. I don't even modify the JSON, I just decode the object and re-encode 
&gt; exactly the same value, but I still have the problem. The code is pasted below
&gt; 
&gt; precommit(RiakObject) -&gt;
&gt;         Value = riak_object:get_value(RiakObject),
&gt;         {struct, TermList} = mochijson2:decode(Value),
&gt;         riak_object:apply_updates(
&gt;           riak_object:update_value(RiakObject, 
&gt;                                    mochijson2:encode({struct, TermList}))).
&gt; 
&gt; Can anybody point out what I'm doing wrong?
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg04780.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#04781">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#04781">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04783.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04764.html">Precommit Hook Difficulties</a></span> <span class="sender italic">Greg Pascale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04777.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">Greg Pascale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04779.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">Greg Pascale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04780.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Precommit Hook Difficulties</span> <span class="sender italic">Greg Pascale</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg04783.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">David Smith</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04784.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">Jon Meredith</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04786.html">Re: Precommit Hook Difficulties</a></span> <span class="sender italic">Greg Pascale</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Precommit Hook Difficulties">
<input type="hidden" name="msgid" value="4BBEFF7D-2024-4453-A2A4-3E5F268E7CD9@clipboard.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg04781.html">
<input type="submit" value=" Greg Pascale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Precommit+Hook+Difficulties%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg04780.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04783.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">4BBEFF7D-2024-4453-A2A4-3E5F268E7CD9@clipboard.com</li>
</ul>
</div>
</body>
</html>
