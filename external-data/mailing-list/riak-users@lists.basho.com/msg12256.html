<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak/LevelDB Memory Usage</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd10.html#12256" id="c">
<link rel="index" href="mail10.html#12256" id="i">
<link rel="prev" href="msg12203.html" id="p">
<link rel="next" href="msg12205.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12256.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C%2FLevelDB+Memory+Usage%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak/LevelDB Memory Usage</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shane+McEwan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shane McEwan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130913" rel="nofollow">Fri, 13 Sep 2013 02:37:58 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Thanks Matthew.

</pre><tt>We've reduced the cache_size to 8388603 and max_open_files to 200 so 
</tt><tt>we'll see how that goes. We'll know in a month or two whether the memory 
</tt><tt>usage levels out where we expect. We are running AAE so I'm sure that 
</tt><tt>was having an effect on memory as well.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>You cache changes in Riak 2.0 sound really good. Much easier to control 
</tt><tt>memory usage.
</tt><pre style="margin: 0em;">

Thanks again!

On 06/09/13 18:46, Matthew Von-Maszewski wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Shane,

Several points for your consideration:

- &quot;cache_size&quot; is broken in 1.3.x, fixed in 1.4.x.  Any cache_size above the 
default 8M can ruin performance because some idiot (me) put a linear walk in the cache 
code.  Reverted for 1.4 and cache_size tested to 2G.

- do you have AAE (active anti-entropy) running?  AAE creates a parallel set of 
vnodes/databases to track hash trees of the primary vnodes.  This will add to 
your memory load.

- max_open_files in 1.3 puts a limit on the count of open files, but NOT on the 
amount of memory that is used by each file.  The larger .sst files create 
larger bloom filters which take up a greater amount of memory for same 
max_open_files setting.  Poor accounting.  1.4.x has a correction that changes 
file cache accounting from file count to amount of memory used per file (limit 
is 4Mbyte * max_open_files).  I am aware of one other 1.3.x site that had to 
reduce their max_open_files from 300 or more, to around 70 to stabilize memory.

That said, I have attached a spreadsheet that simplifies the math discussed on our web 
site.  I have plugged in your numbers and see a &quot;balance&quot; around 
cache_size=8388603 and max_open_files=200.


I am currently writing a dynamic cache size model for Riak 2.0.  All the smoke and 
mirrors for memory sizing will then go away.  The code will automatically change caches 
as vnodes migrate to and from a given node (no need to &quot;reserve 50%&quot;) â€¦ you 
just say total memory you want to allocate to Riak and walk away.

Matthew





On Sep 6, 2013, at 12:10 PM, Shane McEwan &lt;sh...@mcewan.id.au&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
G'day!

Our Riak nodes have 48GB of RAM in them. When we installed Riak 1.2.0 on them 
we tuned the LevelDB settings as per the Parameter Planning section in 
<a  rel="nofollow" href="http://docs.basho.com/riak/1.2.0/tutorials/choosing-a-backend/LevelDB/">http://docs.basho.com/riak/1.2.0/tutorials/choosing-a-backend/LevelDB/</a>

{eleveldb, [
             {write_buffer_size_min, 31457280},
             {write_buffer_size_max, 62914560},
             {cache_size, 300000000},
             {max_open_files, 300}
            ]},

With 64 vnodes per node, an average SST size of 2MB, key size of 150B and 
average value size of 1024B we were expecting our Riak memory usage to peak at 
around 24GB . . . the recommended 50% of system memory.

Currently the Riak process on each of our nodes is using 32GB of RAM and still 
rising.

I've noticed that since we moved to Riak 1.3.1 new SST files are no longer 2MB 
but are now 100MB. Recalculating memory usage based on that gives me an 
expected usage of 32GB. So maybe that explains the higher memory usage than 
expected.

So, 2 questions:

Can we expect the memory usage to plateau soon?

The cache_size of 300MB should allow for one of our nodes to go down and we'll 
still be under the 50% threshold when the 64 down vnodes are shared amongst the 
remaining three nodes . . . except we're already using more than the 24GB 
threshold (or the new 32GB threshold with 100MB SSTs) with all four nodes still 
up. How can this be?

I'd appreciate if someone could do the math for me and come up with suggested 
tuning parameters because I'm losing faith in the documentation:

Riak: 1.3.1
Nodes: 4
Total RAM per node: 48GB
Desired RAM allocated to Riak: 24GB
ring_creation_size: 256
Partitions per node: 64

Thanks!

Shane.


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12203.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd10.html#12256">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail10.html#12256">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12205.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12201.html">Riak/LevelDB Memory Usage</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12203.html">Re: Riak/LevelDB Memory Usage</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak/LevelDB Memory Usage</span> <span class="sender italic">Shane McEwan</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak/LevelDB Memory Usage">
<input type="hidden" name="msgid" value="5232DC8B.90409@mcewan.id.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12256.html">
<input type="submit" value=" Shane McEwan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C%2FLevelDB+Memory+Usage%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12203.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12205.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5232DC8B.90409@mcewan.id.au</li>
</ul>
</div>
</body>
</html>
