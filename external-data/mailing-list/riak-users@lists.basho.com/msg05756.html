<!DOCTYPE html>
<html lang="en">
<head>
<title>[lager] RFC on refactorings for a Graylog2 backend</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#05756" id="c">
<link rel="index" href="maillist.html#05756" id="i">
<link rel="prev" href="msg05754.html" id="p">
<link rel="next" href="msg05757.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05756.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22%5C%5Blager%5C%5D+RFC+on+refactorings+for+a+Graylog2+backend%22&amp;o=newest" rel="nofollow"><span itemprop="name">[lager] RFC on refactorings for a Graylog2 backend</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jason+Wagner%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jason Wagner</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111128" rel="nofollow">Mon, 28 Nov 2011 09:47:29 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>This is a very developer oriented question about Lager that I'm posting
here because I didn't find a dedicated list.</pre><pre>

I'm working on a Graylog2 backend for Lager.  I'm sitting on a very basic
plugin that does little more than post log messages to a graylog2 system
that I'll push to github after I do some integration testing tonight.

However, there's a next step with the Graylog2 integration that would
really leverage the power of both tools-- pushing Lager's trace attributes
into Graylog2 user fields to really leverage the analytics that the newest
versions of Graylog2 provide.  This would allow both pre-log trace
filtering and after the fact trace analysis through Graylog2.

This would be a major change to the Lager internals and I wanted to solicit
opinions on the changes.

*Proposed changes
**Pass through all trace attributes*
The backends need to receive all trace attributes, including default
attributes such as line, file, function, pid, etc.  This would allow proper
population of the graylog2 fields.

I would change this by removing the lager_transform:transform_statement's
call of lager_util:check_traces so that all Traces got passed through.  I
don't believe this would impact any backends except via sending them more
payload in the event, but please correct me if I'm wrong.

*Refactor message formatting*
The formatting needs to be extracted and externalized from lager:log and
lager:log_dest.  This is probably desirable, anyway, since it would be a
very small step from this to have completely orthogonal format/sink
separation, allowing for a user compromise between speed and flexibility in
their log file formats.

I would create a behavior lager_message_formatter with one function that
takes the trace attributes, the message, and returns an iolist for output.
The current one would simply be:

format(Config,Trace,Format,Args) -&gt;
      Pid=proplists:get_value(pid,Trace),
     % etc for Module, Function, Line, Level
      [[&quot;[&quot;, atom_to_list(Level), &quot;] &quot;],
           io_lib:format(&quot;~p@~p:~p:~p &quot;, [Pid, Module, Function, Line]),
           safe_format_chop(Format, Args, 4096)].

The backends would make this call rather than the lager:log or
lager:log_dest.  This would allow for a configuration parameter on the
backends to set which formatter they use, with a reasonable default, and
different formats for each backend configuration.

*Concerns*
One drawback is that it significantly increases the size of the events,
especially if there is concern about run-away tuples being sent.  I'm not
sure how this would impact the performance in the long haul.

The formatting change also pushes some of the workload from the user
process to the logging process.  This can be an advantage if the workloads
aren't taxing the backend, but could penalize even simple logging
statements if the backend gets swamped and can't format/process fast
enough.  The potentially large messages have impact this as well.

There are a couple ways to mitigate this-- additional checks on the log
statement, separate format processes from write processes and pool the
formatters, and other ideas that I wouldn't propose until I actually see
the bottleneck.

*Request For Comments*
Are these changes desirable in the direction of lager?

I've seen performance based changes in the recent history.  Is performance
paramount over flexibility?  How do you currently measure performance?  Are
any scripts,scenarios,etc available?

Any historical lessons that I might be unaware in the vicinity of things
I'd be changing?

-- 
Jason Wagner
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05754.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#05756">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05756">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05757.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">[lager] RFC on refactorings for a Graylog2 backend</span> <span class="sender italic">Jason Wagner</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05757.html">Re: [lager] RFC on refactorings for a Graylog2 backen...</a></span> <span class="sender italic">Andrew Thompson</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="[lager] RFC on refactorings for a Graylog2 backend">
<input type="hidden" name="msgid" value="CAMS92aU6mh9CYgViYTZRH6O_ZhS5RnrSUFc4QQpAA3GN2wDpvA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05756.html">
<input type="submit" value=" Jason Wagner ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22%5C%5Blager%5C%5D+RFC+on+refactorings+for+a+Graylog2+backend%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05754.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05757.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAMS92aU6mh9CYgViYTZRH6O_ZhS5RnrSUFc4QQpAA3GN2wDpvA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
