<!DOCTYPE html>
<html lang="en">
<head>
<title>Using Riak to perform aggregate queries</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd11.html#10879" id="c">
<link rel="index" href="mail11.html#10879" id="i">
<link rel="prev" href="msg10870.html" id="p">
<link rel="next" href="msg10881.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10879.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Using+Riak+to+perform+aggregate+queries%22&amp;o=newest" rel="nofollow"><span itemprop="name">Using Riak to perform aggregate queries</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Chris+Corbyn%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Chris Corbyn</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130414" rel="nofollow">Sun, 14 Apr 2013 16:49:05 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>All,

Just copying this from my stackoverflow post, as the riak tag doesn't get much 
love over there :) It's fine to just outright say that Riak is never going to 
work efficiently in this case because I'm inherently depending on MapReduce.</pre><pre>

Everywhere I read, people say you shouldn't use Riak's MapReduce over an entire 
bucket and that there are other ways of achieving your goals. I'm not sure how, 
though. I'm also not clear on why using an entire bucket is slow, if you only 
have one bucket in the entire system, so either way, you need to go over all 
the entries. Passing in a list of key-bucket pairs has the same effect. Maybe 
the rule should be &quot;don't use MapReduce with more than a handful of keys&quot;. 
Which makes me wonder (apart from link traversal) what use it really has in the 
real world.

I have a list of 500K+ documents that represent sales data. I need to view this 
data in different ways: for example, how much revenue was made in each month 
the business was operating? How much revenue did each product raise? How many 
of each product were sold in a given month? I always thought MapReduce was 
supposed to be good at solving these types of aggregate problems. That sounds 
like a myth now though, unless we're just looking at Hadoop.

My documents are all in a bucket named 'sales' and they are records with the 
following fields (as native Erlang records, not JSON):

    {&quot;id&quot;:1, &quot;product_key&quot;: &quot;cyber-pet-toy&quot;, &quot;price&quot;: &quot;10.00&quot;, &quot;tax&quot;: &quot;1.00&quot;, 
&quot;created_at&quot;: 1365931758}.

Let's take the example where I need to report the total revenue for each 
product in each month over the past 4 years (that's basically the entire 
bucket, but that's just the requirement), how does one use Riak's MapReduce to 
do that efficiently? Even just trying to use an identity map operation on the 
data I get a timeout after ~30 seconds, which MySQL handles in milliseconds.

I'm doing this in Erlang (using the protocol buffers client), but any language 
is fine for an explanation.

The equivalent SQL (MySQL) would be:

  SELECT SUM(price)                         AS revenue,
         FROM_UNIXTIME(created_at, '%Y-%m') AS month,
         product_key
    FROM sales
GROUP BY month, product_key
ORDER BY month ASC;

Even with secondary indexes, there's still a MapReduce involved in this query, 
once you have the list of keys to process.

(Ordering not important right now).

Cheers,

Chris</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10870.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd11.html#10879">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail11.html#10879">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10881.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Using Riak to perform aggregate queries</span> <span class="sender italic">Chris Corbyn</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10881.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10882.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">Chris Corbyn</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10883.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10884.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">Chris Corbyn</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10885.html">Re: Using Riak to perform aggregate que...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10887.html">Re: Using Riak to perform aggregate...</a></span> <span class="sender italic">Paul Barry</span></li>
<li class="icons-email"><span class="subject"><a href="msg10890.html">Re: Using Riak to perform aggregate...</a></span> <span class="sender italic">Paul Barry</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13055.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">NC</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13066.html">Re: Using Riak to perform aggregate queries</a></span> <span class="sender italic">Hector Castro</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13074.html">Re: Using Riak to perform aggregate que...</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Using Riak to perform aggregate queries">
<input type="hidden" name="msgid" value="95129D1D-DB78-4B91-BBB6-D2C611369C5D@w3style.co.uk">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10879.html">
<input type="submit" value=" Chris Corbyn ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Using+Riak+to+perform+aggregate+queries%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10870.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10881.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">95129D1D-DB78-4B91-BBB6-D2C611369C5D@w3style.co.uk</li>
</ul>
</div>
</body>
</html>
