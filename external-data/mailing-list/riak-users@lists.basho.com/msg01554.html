<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: map-reduce Problem ?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#01554" id="c">
<link rel="index" href="maillist.html#01554" id="i">
<link rel="prev" href="msg01551.html" id="p">
<link rel="next" href="msg01555.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg01554.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+map%5C-reduce+Problem+%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: map-reduce Problem ?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alexander+Sicular%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alexander Sicular</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20101115" rel="nofollow">Mon, 15 Nov 2010 15:50:49 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Thanks Dan and Kevin,

How about a custom hint file (iirc is the file that is read into mem with all 
keys) which stems by bucket. And by stem I mean order... with offsets. Redis 
does all kinds of stuff like this in memory and persists to disk via an append 
only file. So riak can just grab only specific keys in one go skipping the 
bucket union scan. This kind of method could be extended to keys eventually.</pre><pre>

Thanks, Alexander


On Nov 15, 2010, at 5:51 PM, Kevin Smith wrote:

&gt; In general, Riak backends combine the bucket name and key into a single value 
&gt; used as the primary key. For the Basho-written backends the combined value is 
&gt; an Erlang tuple of the form {BucketName, Key}.
&gt; 
&gt; When you list all the keys in a bucket, the backends execute a fold over all 
&gt; their data. The function executed within the fold examines each tuple and 
&gt; keeps tuples which include the desired bucket name. This arrangement means 
&gt; listing keys is still not as scalable as it could be. Consider the case of a 
&gt; Riak cluster storing two buckets, A and B. Bucket A has 5000 keys while 
&gt; bucket B has 250000 keys. Listing the keys for bucket A means examining 
&gt; 255000 (bucket A + bucket B) to find the 5000 you really want.
&gt; 
&gt; The first round of listing keys improvements focused on reducing the memory 
&gt; footprint of folding over the keys in each backend and aggregating their 
&gt; results. Before the improvements we would manifest the aggregated list in 
&gt; memory which didn't scale for large datasets.
&gt; 
&gt; The next thing to improve, IMHO, is adding &quot;bucket awareness&quot; to each backend 
&gt; and the vnode API such that Riak no longer has to examine each datum in order 
&gt; to find the ones belonging to a specific bucket. This is what my patch to 
&gt; Innostore does. Innostore is already &quot;bucket aware&quot; internally so I was able 
&gt; to leverage this fact and constrain the scope of key access to only the 
&gt; desired bucket.
&gt; 
&gt; --Kevin
&gt; On Nov 15, 2010, at 5:11 PM, Alexander Sicular wrote:
&gt; 
&gt;&gt; So I get that riak is not bucket aware. When you pass a bucket as an
&gt;&gt; input in an m/r, as riak sifts through all the keys, how does riak
&gt;&gt; isolate bucket specific keys? Are keys stored as /bucket/key internaly
&gt;&gt; and there is a string comparison on split(key,'/') ? Or is there
&gt;&gt; something else going on.
&gt;&gt; 
&gt;&gt; Thank you.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 2010-11-15, Kevin Smith &lt;ksm...@basho.com&gt; wrote:
&gt;&gt;&gt; We are giving some thought on how to do that. The main issues wrt to
&gt;&gt;&gt; bitcask's key listing performance is that bitcask is not bucket aware and
&gt;&gt;&gt; lacks the notion of secondary indices. Not being bucket aware means bitcask
&gt;&gt;&gt; has to examine all bucket/key pairs to find the ones related to a given
&gt;&gt;&gt; bucket. This isn't to say we won't address the problem but merely to point
&gt;&gt;&gt; out there's some engineering work required to solve the problem correctly.
&gt;&gt;&gt; 
&gt;&gt;&gt; innostore is moderately bucket-aware right now so I've forked it
&gt;&gt;&gt; (<a  rel="nofollow" href="http://github.com/kevsmith/innostore">http://github.com/kevsmith/innostore</a>) and added bucket-aware key listing.
&gt;&gt;&gt; Based on some very basic testing I'm seeing 2.5x speed up in overall key
&gt;&gt;&gt; listing performance compared to the official version. I'm hoping the patch,
&gt;&gt;&gt; or a modified form of it, will make the next release. If you can handle inno
&gt;&gt;&gt; being a bit slower than bitcask and slightly more difficult to set up and
&gt;&gt;&gt; tune then this might be an option for you.
&gt;&gt;&gt; 
&gt;&gt;&gt; I've done some basic vetting of the code but I want to emphasize this is a
&gt;&gt;&gt; prototype only and hasn't received anything even close to the normal amount
&gt;&gt;&gt; of testing we put into a release. Please keep this in mind if you decide to
&gt;&gt;&gt; use my forked repo.
&gt;&gt;&gt; 
&gt;&gt;&gt; --Kevin
&gt;&gt;&gt; On Nov 15, 2010, at 11:57 AM, Greg Steffensen wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Along these lines, are there any ideas floating around about how to speed
&gt;&gt;&gt;&gt; up the listing of keys in a bucket?  For the bitcask backend, it seems
&gt;&gt;&gt;&gt; like an index of keys-by-bucket ought to be the kind of thing that could
&gt;&gt;&gt;&gt; be stored in the hints files to speed this up without affecting
&gt;&gt;&gt;&gt; performance for live reads and writes.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Greg
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Mon, Nov 15, 2010 at 11:46 AM, Sean Cribbs &lt;s...@basho.com&gt; wrote:
&gt;&gt;&gt;&gt; This is possible with Riak's MapReduce but you will likely have increasing
&gt;&gt;&gt;&gt; difficulty as your dataset grows, because of the impact of needing to list
&gt;&gt;&gt;&gt; keys in a bucket and then eliminate data points you aren't interested in.
&gt;&gt;&gt;&gt; In the longer term, there will be improvements to MapReduce such that if
&gt;&gt;&gt;&gt; your keys are meaningful, you will be able to filter them more easily
&gt;&gt;&gt;&gt; (without examining the data first).  You might find Kevin Smith's overview
&gt;&gt;&gt;&gt; enlightening: <a  rel="nofollow" href="http://www.slideshare.net/hemulen/riak-mapred-preso">http://www.slideshare.net/hemulen/riak-mapred-preso</a>
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Sean Cribbs &lt;s...@basho.com&gt;
&gt;&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://basho.com/">http://basho.com/</a>
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Nov 15, 2010, at 11:34 AM, Prometheus WillSurvive wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi ,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; We have a huge database (around 4 billion record - 30 TB) storing the
&gt;&gt;&gt;&gt;&gt; video watch infromation ie view count , comment , favorited etc. I want
&gt;&gt;&gt;&gt;&gt; to produce daily report for all videos view counts. It means I need to
&gt;&gt;&gt;&gt;&gt; look 2 day , today and yesterday so subtract yesterdey view count from
&gt;&gt;&gt;&gt;&gt; today view count so I can find the daliy impression. Our Fat DB team
&gt;&gt;&gt;&gt;&gt; doing this a few complex queries. I would like to ask you is this
&gt;&gt;&gt;&gt;&gt; possible with Riak map-reduce way .  I want to make a demonstration to
&gt;&gt;&gt;&gt;&gt; the team to show this ..
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; This is the scenario. We have similar data models for other thins. This
&gt;&gt;&gt;&gt;&gt; could be a start.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; We have 30xHP DL380  x32 Gig Ram  Farm  to test this scenario.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Any riak map-reduce experienced member can show some idea on this..  I
&gt;&gt;&gt;&gt;&gt; guess.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Regards
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Prometheus
&gt;&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Sent from my mobile device
&gt; 


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg01551.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#01554">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#01554">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg01555.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg01539.html">map-reduce Problem ?</a></span> <span class="sender italic">Prometheus WillSurvive</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01540.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01542.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Greg Steffensen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01545.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Kevin Smith</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01549.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01550.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Dan Reverri</span></li>
<li class="icons-email"><span class="subject"><a href="msg01551.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Kevin Smith</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: map-reduce Problem ?</span> <span class="sender italic">Alexander Sicular</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg01555.html">Re: map-reduce Problem ?</a></span> <span class="sender italic">Germain Maurice</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: map-reduce Problem ?">
<input type="hidden" name="msgid" value="4E8DCF2B-1B89-43CE-ACC6-EEAE46568C62@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg01554.html">
<input type="submit" value=" Alexander Sicular ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+map%5C-reduce+Problem+%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg01551.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg01555.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">4E8DCF2B-1B89-43CE-ACC6-EEAE46568C62@gmail.com</li>
</ul>
</div>
</body>
</html>
