<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: High CPU on a single node in production</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16924" id="c">
<link rel="index" href="maillist.html#16924" id="i">
<link rel="prev" href="msg16922.html" id="p">
<link rel="next" href="msg16925.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16924.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+High+CPU+on+a+single+node+in+production%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: High CPU on a single node in production</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Fred+Dushin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Fred Dushin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160106" rel="nofollow">Wed, 06 Jan 2016 13:06:18 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>
Hi Josh,

Sorry for not getting back sooner.</pre><pre>

I am not entirely sure what is going on with your handoffs.  It could be that 
you have overloaded Solr with handoff activity, and that is causing vnodes to 
become unresponsive.  We are actively working on a fix for this, which allows 
vnodes to continue their work, even if Solr is taking its time with ingest.  
This also includes batching, with aggregates insertion (and deletion) 
operations into Solr, to smooth out some of the bumps, while at the same time 
being a better Solr citizen.

The hundreds of entries you see on close trees seem to be due to the fact that 
your YZ AAE trees are in need of being rebuilt.  Can it be that you have hit 
the magic 7 day grace period on AAE tree expiry?  The index failures you see in 
the logs seem to be because the yz_entropy_mgr has been shut down.  You are 
seeing this during a riak stop, correct?  Is the system under high indexing 
load, at the time?  That could account for the log messages, as index 
operations may be coming in while yokozuna is being shut down.

Regarding ring resize, please have a look at 
<a  rel="nofollow" href="https://github.com/basho/yokozuna/issues/279">https://github.com/basho/yokozuna/issues/279</a> 
&lt;<a  rel="nofollow" href="https://github.com/basho/yokozuna/issues/279">https://github.com/basho/yokozuna/issues/279</a>&gt;.  I do not believe these issues 
have been rectified, so the official line is what you see in the documentation. 
 You can, of course, reindex your data after a ring resize, but that is not 
acceptable in a production scenario, if you have an SLA around search 
availability.

Hope that helps, and let us know if you have any more information about what 
might be consuming CPU on your nodes.  I would keep a close eye on the vnode 
queue lengths in the Riak stats (riak_kv_vnodeq_(min|max|avg|mean|etc)).  If 
your vnode queues start getting deep, then vnodes are likely being blocked by 
Solr.

-Fred

&gt; On Jan 6, 2016, at 1:03 PM, Josh Yudaken &lt;j...@smyte.com&gt; wrote:
&gt; 
&gt; Hi Luke,
&gt; 
&gt; We're planning on having a rather large cluster rather soon, which was
&gt; the reason for the large ring size. Your documentation indicates ring
&gt; resize is *not* possible with search 2.0 [1], although an issue I
&gt; found on github indicated it might be now? [2]
&gt; 
&gt; If the situation is resolved we might be open to resizing our ring
&gt; now, but given the trouble we're seeing with normal handoffs that
&gt; seems like a bad idea. Is the 4x ring size expected to completely
&gt; break Riak like we're seeing in production, or just a bit of extra
&gt; strain/latency?
&gt; 
&gt; I've been through the tuning list multiple times, and haven't seen any
&gt; changes. I migrated the machine seeing issues to a new host, and now
&gt; the new host is seeing similar problems. Heres a screenshot of `htop`
&gt; just before I stopped the node in order to bring our site back up [3].
&gt; 
&gt; Regards,
&gt; Josh
&gt; 
&gt; [1] 
&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/ring-resizing/#Feature-Incompatibility">http://docs.basho.com/riak/latest/ops/advanced/ring-resizing/#Feature-Incompatibility</a>
&gt; [2] <a  rel="nofollow" href="https://github.com/basho/basho_docs/issues/1742">https://github.com/basho/basho_docs/issues/1742</a>
&gt; [3] <a  rel="nofollow" href="https://slack-files.com/T031MU137-F0HRU4E94-c3ab1e776e">https://slack-files.com/T031MU137-F0HRU4E94-c3ab1e776e</a>
&gt; 
&gt; On Wed, Jan 6, 2016 at 6:39 AM, Luke Bakken &lt;lbak...@basho.com&gt; wrote:
&gt;&gt; Hi Josh,
&gt;&gt; 
&gt;&gt; 1024 is too large of a ring size for 10 nodes. If it's possible to
&gt;&gt; rebuild your cluster using a ring size of 128 or 256 that would be
&gt;&gt; ideal 
&gt;&gt; (<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/building/planning/cluster/#Ring-Size-Number-of-Partitions">http://docs.basho.com/riak/latest/ops/building/planning/cluster/#Ring-Size-Number-of-Partitions</a>).
&gt;&gt; Ring resizing is possible as well
&gt;&gt; (<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/ring-resizing/">http://docs.basho.com/riak/latest/ops/advanced/ring-resizing/</a>).
&gt;&gt; 
&gt;&gt; Have all of our recommended performance tunings been applied to every
&gt;&gt; node in this cluster?
&gt;&gt; (<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/tuning/linux/">http://docs.basho.com/riak/latest/ops/tuning/linux/</a>) - these can have
&gt;&gt; a dramatic effect on cluster performance.
&gt;&gt; 
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; Engineer
&gt;&gt; lbak...@basho.com
&gt;&gt; 
&gt;&gt; On Tue, Jan 5, 2016 at 10:52 AM, Josh Yudaken &lt;j...@smyte.com&gt; wrote:
&gt;&gt;&gt; Hi,
&gt;&gt;&gt; 
&gt;&gt;&gt; We're attempting to use Riak as our primary key-value and search
&gt;&gt;&gt; database for an analytics-typed solution to blocking spam/fraud.
&gt;&gt;&gt; 
&gt;&gt;&gt; As we expect to eventually be handling a huge amount of data, I
&gt;&gt;&gt; started with a ring size of 1024. We currently have 10 nodes on Google
&gt;&gt;&gt; Cloud n1-standard-16 instances [ 16 cores, 60gb RAM, 720gb local ssd.
&gt;&gt;&gt; ]. Disks are at about 60% usage [ roughly 175gb leveldb, 16gb yz, 45gb
&gt;&gt;&gt; anti_entropy, 6gb yz_anti_entropy ], and request wise we're at about
&gt;&gt;&gt; 20k/min get, 4k/min set. Load average is usually around 6.
&gt;&gt;&gt; 
&gt;&gt;&gt; I'm assuming most of the issues we're seeing are Yokozuna related, but
&gt;&gt;&gt; we're seeing a ton of tcp timeouts during handoffs, very slow get/set
&gt;&gt;&gt; queries, and a slew of other errors.
&gt;&gt;&gt; 
&gt;&gt;&gt; Right now I'm trying to debug an issue where one of the 10 nodes
&gt;&gt;&gt; pegged all the cpu cores. Mostly with the `bean` process.
&gt;&gt;&gt; 
&gt;&gt;&gt; # riak-admin top
&gt;&gt;&gt; Output server crashed: connection_lost
&gt;&gt;&gt; 
&gt;&gt;&gt; With few other options (as it was causing slow queries across the
&gt;&gt;&gt; cluster) I stopped the server and saw hundreds of the following
&gt;&gt;&gt; (interesting) messages in the log::
&gt;&gt;&gt; 
&gt;&gt;&gt; 2016-01-05 18:28:28.573 [info]
&gt;&gt;&gt; &lt;0.4958.0&gt;@yz_index_hashtree:close_trees:557 Deliberately marking YZ
&gt;&gt;&gt; hashtree {1458647141945490998441568260777384029383167049728,3} for
&gt;&gt;&gt; full rebuild on next restart
&gt;&gt;&gt; 
&gt;&gt;&gt; As well as a ton of (I think related?):
&gt;&gt;&gt; 2016-01-05 18:28:31.153 [error] &lt;0.5982.0&gt;@yz_kv:index_internal:237
&gt;&gt;&gt; failed to index object
&gt;&gt;&gt; {{&lt;&lt;&quot;features&quot;&gt;&gt;,&lt;&lt;&quot;features&quot;&gt;&gt;},&lt;&lt;&quot;0NKqMtj3O6_&quot;&gt;&gt;} with error
&gt;&gt;&gt; {noproc,{gen_server,call,[yz_entropy_mgr,{get_tree,1120389438774178506630754486017853682060456099840},infinity]}}
&gt;&gt;&gt; because 
&gt;&gt;&gt; [{gen_server,call,3,[{file,&quot;gen_server.erl&quot;},{line,188}]},{yz_kv,get_and_set_tree,1,[{file,&quot;src/yz_kv.erl&quot;},{line,452}]},{yz_kv,update_hashtree,4,[{file,&quot;src/yz_kv.erl&quot;},{line,340}]},{yz_kv,index,7,[{file,&quot;src/yz_kv.erl&quot;},{line,295}]},{yz_kv,index_internal,5,[{file,&quot;src/yz_kv.erl&quot;},{line,224}]},{riak_kv_vnode,actual_put,6,[{file,&quot;src/riak_kv_vnode.erl&quot;},{line,1619}]},{riak_kv_vnode,perform_put,3,[{file,&quot;src/riak_kv_vnode.erl&quot;},{line,1607}]},{riak_kv_vnode,do_put,7,[{file,&quot;src/riak_kv_vnode.erl&quot;},{line,1398}]}]
&gt;&gt;&gt; 
&gt;&gt;&gt; For reference the TCP timeout error looks like:
&gt;&gt;&gt; 
&gt;&gt;&gt; 2016-01-01 01:09:50.522 [error]
&gt;&gt;&gt; &lt;0.8430.6&gt;@riak_core_handoff_sender:start_fold:272 hinted transfer of
&gt;&gt;&gt; riak_kv_vnode from 'riak@riak25-2.c.authbox-api.internal'
&gt;&gt;&gt; 185542200051774784537577176028434367729757061120 to
&gt;&gt;&gt; 'riak@riak27-2.c.authbox-api.internal'
&gt;&gt;&gt; 185542200051774784537577176028434367729757061120 failed because of TCP
&gt;&gt;&gt; recv timeout
&gt;&gt;&gt; 
&gt;&gt;&gt; Any suggestions about where to look?
&gt;&gt;&gt; 
&gt;&gt;&gt; Regards,
&gt;&gt;&gt; Josh
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16922.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16924">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16924">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16925.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16920.html">High CPU on a single node in production</a></span> <span class="sender italic">Josh Yudaken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16921.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16922.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Josh Yudaken</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: High CPU on a single node in production</span> <span class="sender italic">Fred Dushin</span></li>
<li class="icons-email"><span class="subject"><a href="msg16925.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16930.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Josh Yudaken</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: High CPU on a single node in production">
<input type="hidden" name="msgid" value="C6EE08A5-9B01-43D6-B154-052E7703E0E6@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16924.html">
<input type="submit" value=" Fred Dushin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+High+CPU+on+a+single+node+in+production%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16922.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16925.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">C6EE08A5-9B01-43D6-B154-052E7703E0E6@basho.com</li>
</ul>
</div>
</body>
</html>
