<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Multi-backend, eLevelDB, & Too many open files</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd10.html#12214" id="c">
<link rel="index" href="mail10.html#12214" id="i">
<link rel="prev" href="msg12209.html" id="p">
<link rel="next" href="msg12219.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12214.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multi%5C-backend%2C+eLevelDB%2C+%5C%26+Too+many+open+files%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Multi-backend, eLevelDB, & Too many open files</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Luke+Bakken%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Luke Bakken</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130909" rel="nofollow">Mon, 09 Sep 2013 14:22:52 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Matt -

Can you attach to a node in your cluster with &quot;riak attach&quot; and run
this erlang snippet (before the node errors out)?</pre><pre>

os:cmd(&quot;ulimit -n&quot;).

This will show the actual value for ulimit for that running riak node.
I suspect that this value hasn't been updated for the running process,
even though you've modified limits.conf.

Depending on your OS there may be more configuration necessary for the
open files limit to &quot;stick&quot;:
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/tuning/open-files-limit/#Linux">http://docs.basho.com/riak/latest/ops/tuning/open-files-limit/#Linux</a>

On Sun, Sep 8, 2013 at 9:15 PM, Matt Black &lt;matt.bl...@jbadigital.com&gt; wrote:
&gt; Hey list,
&gt;
&gt; We're migrating from our currently operational cluster to a new one in a
&gt; different EC2 region. As part of this migration, we'd like to move from
&gt; Bitcask to eLevelDB - mostly for the benefits provided by secondary indexes.
&gt;
&gt; We also use Multi-backend configuration, in order to split our various
&gt; client's data into entirely separate spaces on disk (this is useful for
&gt; legal reasons). I made the simple change from &quot;riak_kv_bitcask_backend&quot; to
&gt; &quot;riak_kv_eleveldb_backend&quot; in our config, and did some calculations for
&gt; &quot;max_open_files&quot;, and then started a new node.
&gt;
&gt; It fails with the following error in short order:
&gt;
&gt;&gt; cat error.log
&gt; 2013-09-09 03:49:51.391 [error] &lt;0.715.0&gt;@riak_kv_vnode:init:375 Failed to
&gt; start riak_kv_multi_backend Reason: [{riak_kv_eleveldb_backend,{db_open,&quot;IO
&gt; error:
&gt; /mnt/riak/eleveldb/client1/365375409332725729550921208179070754913983135744/000015.dbtmp:
&gt; Too many open files&quot;}}]
&gt; 2013-09-09 03:49:51.392 [error] &lt;0.940.0&gt;@riak_kv_vnode:init:375 Failed to
&gt; start riak_kv_multi_backend Reason: [{riak_kv_eleveldb_backend,{db_open,&quot;IO
&gt; error:
&gt; /mnt/riak/eleveldb/client2/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files&quot;}},{riak_kv_eleveldb_backend,{db_open,&quot;IO error:
&gt; /mnt/riak/eleveldb/client3/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files&quot;}},{riak_kv_eleveldb_backend,{db_open,&quot;IO error:
&gt; /mnt/riak/eleveldb/client4/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files&quot;}},{riak_kv_eleveldb_backend,{db_open,&quot;IO error:
&gt; /mnt/riak/eleveldb/client5/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files&quot;}},{riak_kv_eleveldb_backend,{db_open,&quot;IO error:
&gt; /mnt/riak/eleveldb/client6/570899077082383952423314387779798054553098649600/CURRENT:
&gt; Too many open files&quot;}}]
&gt;
&gt; And some relevant app.config:
&gt;
&gt;             {multi_backend_default, &lt;&lt;&quot;default&quot;&gt;&gt;},
&gt;             {multi_backend, [
&gt;                 %% Default fallback: this is unused
&gt;                 {&lt;&lt;&quot;default&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/default&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client1&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client1&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client2&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client2&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client3&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client3&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client4&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client4&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client5&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client5&quot;}
&gt;                 ]},
&gt;                 {&lt;&lt;&quot;eleveldb_client6&quot;&gt;&gt;, riak_kv_eleveldb_backend, [
&gt;                     {data_root, &quot;/mnt/riak/eleveldb/client6&quot;}
&gt;                 ]}
&gt;             ]},
&gt;
&gt;             .. snip ..
&gt;
&gt;              %% Default cache size of 8MB
&gt;              {cache_size, 8388608},
&gt;              %% Maximum number of files open at once per partition
&gt;              {max_open_files, 50}
&gt;
&gt; I've set the &quot;riak soft/hard nofile 65536&quot; in /etc/security/limits.conf, so
&gt; presumably this &quot;Too many open files&quot; error is referring to the
&gt; &quot;max_open_files&quot; option as part of eLevelDB config. The RAM in each machine
&gt; is 3.5GB free, so I calculated on a 5 node cluster this 50 max_open_files
&gt; limit.
&gt;
&gt; - Is there something about Multi-backend I haven't taken into account?
&gt; - Do I need a larger max_open_files? (And thus more RAM? :)
&gt;
&gt; Cheers!
&gt; Matt
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;



-- 
Luke Bakken
CSE
lbak...@basho.com

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12209.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd10.html#12214">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail10.html#12214">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12219.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12209.html">Multi-backend, eLevelDB, &amp; Too many open files</a></span> <span class="sender italic">Matt Black</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Multi-backend, eLevelDB, &amp; Too many open files</span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12219.html">Re: Multi-backend, eLevelDB, &amp; Too many open file...</a></span> <span class="sender italic">Matt Black</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Multi-backend, eLevelDB, &amp; Too many open files">
<input type="hidden" name="msgid" value="CAJJ0J9Obk_Wfn0GLxcSNy+GvoWP=7b-AXNZX9M7eMYBngu8yAw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12214.html">
<input type="submit" value=" Luke Bakken ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multi%5C-backend%2C+eLevelDB%2C+%5C%26+Too+many+open+files%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12209.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12219.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAJJ0J9Obk_Wfn0GLxcSNy+GvoWP=7b-AXNZX9M7eMYBngu8yAw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
