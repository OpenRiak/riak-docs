<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Join is Screwed Up</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07379" id="c">
<link rel="index" href="maillist.html#07379" id="i">
<link rel="prev" href="msg07378.html" id="p">
<link rel="next" href="msg07380.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07379.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Join+is+Screwed+Up%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Join is Screwed Up</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joseph+Blomstedt%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joseph Blomstedt</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120503" rel="nofollow">Thu, 03 May 2012 04:42:10 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Yes, 'riak-admin join' is designed to join a node to a cluster, not a
cluster to another cluster. This behavior was different before Riak
1.0 (last September), but was changed as part of several changes to
make Riak's clustering layer more deterministic.</pre><pre>

The short answer to the &quot;why is this the case&quot; is related to the fact
that Riak is a network-partition tolerant distributed database without
central coordination. If you have two separate clusters, both which
are receiving incoming client requests, and you try to join the two
clusters together during a network partition, there are very few
guarantees on deterministic behavior.

If clients can talk to all nodes in both clusters, but only some
subset of nodes in each cluster can talk to each other, you then end
up having clients talking to different nodes that have different
beliefs on what the cluster membership/topology is. This is even worse
if you have three clusters, and you concurrently issue a join between
1 and 2 and 2 and 3 during a similar partition scenario.

The more specific answer is that Riak provides certain guarantees by
ensuring that cluster changes logically appear to be totally ordered
events. The history of two completely independent clusters are
disjoint and cannot always be merged. This is solved for the single
node case by relaxing the constraint on total ordering. The cluster
you are joining still maintains a logically monotonic history. While
the node joining the cluster simply gives up it's history.
Specifically, the joining node asks the larger cluster for its cluster
information, and then atomically overwrites it's own view with that of
the cluster.

Regards,
Joe


On Thu, May 3, 2012 at 12:05 AM, Rebecca Meritz
&lt;rebecca.mer...@klarna.com&gt; wrote:
&gt; I figured out a way to fix the problem. But I don't understand why the
&gt; solution works.
&gt;
&gt; Before A sent a join request to B and then B to C and the second request
&gt; failed.
&gt;
&gt; Now A sends a join request to B and then C to B and the second
&gt; request succeeds.
&gt;
&gt; Must a node that is the only member of its cluster always ask to join the
&gt; larger cluster for the request to succeed? Why is this?
&gt;
&gt; Thanks,
&gt; Rebecca
&gt;
&gt; On Thu, May 3, 2012 at 8:41 AM, Rebecca Meritz &lt;rebecca.mer...@klarna.com&gt;
&gt; wrote:
&gt;&gt;
&gt;&gt; I'm testing a script that joins my riak ring on all machines. There is no
&gt;&gt; data in the database yet but I have repeated joined the ring an separated it
&gt;&gt; while working on the script that sets up the environment on my machines. The
&gt;&gt; ring is now in a bizarre state:
&gt;&gt;
&gt;&gt; [rebecca]$ riak-admin member_status
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; ================================= Membership
&gt;&gt; ==================================
&gt;&gt; Status     Ring    Pending    Node
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; valid      50.0%      --      'r...@xx.xxx.xx.10'
&gt;&gt; valid      50.0%      --      'r...@xx.xxx.xx.12'
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; Valid:2 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt;&gt; [pay@payment-testing-gw2 ~]$ riak-admin join r...@xx.xxx.xx.14
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; Failed: This node is already a member of a cluster
&gt;&gt; [pay@payment-testing-gw2 ~]$ riak-admin force-remove r...@xx.xxx.xx.14
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; Failed: &quot;r...@xx.xxx.xx.14&quot; is not a member of the cluster.
&gt;&gt;
&gt;&gt; I cannot join a new member nor can I remove it.
&gt;&gt;
&gt;&gt; I've tried stop them all get them to leave, if they wouldn't leave I
&gt;&gt; forced their removal. I stopped them all. I even deleted the whole old ring
&gt;&gt; file before restarting.
&gt;&gt;
&gt;&gt; How can I fix this situations. What causes the above error?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Rebecca
&gt;
&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;



-- 
Joseph Blomstedt &lt;j...@basho.com&gt;
Software Engineer
Basho Technologies, Inc.
<a  rel="nofollow" href="http://www.basho.com/">http://www.basho.com/</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07378.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07379">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07379">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07380.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07377.html">Riak Join is Screwed Up</a></span> <span class="sender italic">Rebecca Meritz</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07378.html">Re: Riak Join is Screwed Up</a></span> <span class="sender italic">Rebecca Meritz</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Join is Screwed Up</span> <span class="sender italic">Joseph Blomstedt</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Join is Screwed Up">
<input type="hidden" name="msgid" value="CANvk2KT2hjzn3a0SZFPzvWdKRhhVJZfcU14tY690f03QvuLvEw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07379.html">
<input type="submit" value=" Joseph Blomstedt ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Join+is+Screwed+Up%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07378.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07380.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CANvk2KT2hjzn3a0SZFPzvWdKRhhVJZfcU14tY690f03QvuLvEw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
