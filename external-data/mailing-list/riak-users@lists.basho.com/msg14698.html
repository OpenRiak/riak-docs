<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Slow s3cmd ls queries + HAProxy 504 timeouts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14698" id="c">
<link rel="index" href="maillist.html#14698" id="i">
<link rel="prev" href="msg14676.html" id="p">
<link rel="next" href="msg14700.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14698.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Slow+s3cmd+ls+queries+%5C%2B+HAProxy+504+timeouts%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Slow s3cmd ls queries + HAProxy 504 timeouts</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alex+Millar%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Millar</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140818" rel="nofollow">Mon, 18 Aug 2014 10:24:18 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey Kelly,

Thanks for reaching out! We’re using the following versions for RiakCS &amp; Riak</pre><pre>

# Download RiakCS 
# Version: 1.4.5
# OS: Ubuntu 12.04 (Precise) AMD 64
curl -O 
<a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb</a>

# Download Riak
# Version: 1.4.8
# OS: Ubuntu 12.04 (Precise) AMD 64
curl -O 
<a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb</a>

The intent of being able to have performant ls operations was to that we could 
connection via Transmit to view and navigate the contents of the bucket, 
similar to how you can access the contents of your S3 buckets in their webUI. 
That being said our keys are akin to a folder structure, for example...

/organizations/OrganizationID-[OrganizationID]/documents/proposals/ProposalID-[ProposalID]/DocumentSlotID-[DocumentSlotID]

S3 must be doing some sort of secondary indexing to allow for fast lookups 
here, because the bucket in question that has the performance issues only has 2 
“folders” under s3://bonfirehub-resources-can-east-doc-conversion yet it takes 
the longest to s3cmd ls since Riak is clearly traversing all the keys to 
fulfill this request.

Short story, this is not a requirement for us in order to use RiakCS however, 
going forward it would be desirable if RiakCS could maintain this form of 
secondary indices (and potentially have a WebUI) to better match some use cases 
that exist for clients who are used to using S3.

                 Alex Millar, CTO  
Office: 1-800-354-8010 ext. 704  
Mobile: 519-729-2539  
GoBonfire.com

From: Kelly McLaughlin &lt;ke...@basho.com&gt;
Reply: Kelly McLaughlin &lt;ke...@basho.com&gt;&gt;
Date: August 15, 2014 at 7:03:47 PM
To: Alex Millar &lt;a...@gobonfire.com&gt;&gt;, riak-users@lists.basho.com 
&lt;riak-users@lists.basho.com&gt;&gt;
Subject:  Re: Slow s3cmd ls queries + HAProxy 504 timeouts  

Hello Alex. Would you mind sharing what version of Riak and Riak CS you are 
using? Also if you can post the the contents of your Riak CS app.config file
it might help give a better idea of what might be going on.

Generally listing the contents of a bucket is more expensive than a normal 
download or upload request, but there have been performance improvements in 
recent
versions of Riak CS and there are settings that can be adjusted depending on 
the version you are using. The time required to list the contents of the entire 
bucket
is definitely related to the number of objects in that bucket so the time will 
continue to increase as the number of objects increases, but we do continue to 
work to
make the process as efficient as possible.

Depending on why you need to list the contents of the bucket the max-keys query 
parameter available with the bucket listing operation may be useful. By default 
this
limit is 1000 keys, but s3cmd does not expose this that I'm aware of and 
instead buffers all the results until the end of the contents is reached. But 
if you need
to list the contents for the purpose of some processing step, it may work 
better for you to break up this process into smaller chunks using max-keys.

Kelly

On 08/15/2014 06:39 AM, Alex Millar wrote:
So the issue we’re having is only with bucket listing.

alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls 
s3://bonfirehub-resources-can-east-doc-conversion
                       DIR   
s3://bonfirehub-resources-can-east-doc-conversion/organizations/

real 2m0.747s
user 0m0.076s
sys 0m0.030s

where as…

alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls 
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals
                       DIR   
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals/

real 0m10.262s
user 0m0.075s
sys 0m0.028s

The contents of this bucket contains a lot of very small files (basically for 
each PDF we receive I split it to .JPG foreach page and store them here. Based 
on the my latest counts it looks like we have around 170,000 .JPG files in that 
bucket.

Now I’ve had a hunch this is just a fundamentally expensive operation which 
exceeds the 5000ms response time threshold set in our HAProxy config (which I 
raised during the video to illustrate what’s going on). After reading 
<a  rel="nofollow" href="http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why">http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why</a>
 and <a  rel="nofollow" href="http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html I’m">http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html I’m</a> 
feeling like this is just a fundamental issue with the data structure in Riak. 

Based on this I’m thinking that cost of this type of query is only going to get 
worse over time as we add more keys to this bucket (unless secondary indexes 
can be added). Or am I totally out to lunch here and there’s some other 
underlying problem?

        Alex Millar, CTO
Office: 1-800-354-8010 ext. 704
Mobile: 519-729-2539  
GoBonfire.com

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14676.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14698">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14698">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14700.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14658.html">Slow s3cmd ls queries + HAProxy 504 timeouts</a></span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14676.html">Re: Slow s3cmd ls queries + HAProxy 504 timeouts</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Slow s3cmd ls queries + HAProxy 504 timeouts</span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14700.html">Re: Slow s3cmd ls queries + HAProxy 504 time...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Slow s3cmd ls queries + HAProxy 504 timeouts">
<input type="hidden" name="msgid" value="etPan.53f23670.74b0dc51.16207@alxndrmlr-mbp.local">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14698.html">
<input type="submit" value=" Alex Millar ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Slow+s3cmd+ls+queries+%5C%2B+HAProxy+504+timeouts%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14676.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14700.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">etPan.53f23670.74b0dc51.16207@alxndrmlr-mbp.local</li>
</ul>
</div>
</body>
</html>
