<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Search and Yokozuna Backup Strategy</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd4.html#13464" id="c">
<link rel="index" href="mail4.html#13464" id="i">
<link rel="prev" href="msg13463.html" id="p">
<link rel="next" href="msg13468.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg13464.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Search+and+Yokozuna+Backup+Strategy%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Search and Yokozuna Backup Strategy</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joe+Caswell%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joe Caswell</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140123" rel="nofollow">Thu, 23 Jan 2014 10:45:34 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Apologies, clicked send in the middle of an incomplete thought.  It should
have read:</pre><pre>

Backing up the LevelDB data files while the node is stopped would remove the
necessity of using the LevelDB repair process upon restoring to make the
vnode self-consistent.

From:  Joe Caswell &lt;jcasw...@basho.com&gt;
Date:  Thursday, January 23, 2014 1:25 PM
To:  Sean McKibben &lt;grap...@graphex.com&gt;, Elias Levy
&lt;fearsome.lucid...@gmail.com&gt;
Cc:  &quot;riak-users@lists.basho.com&quot; &lt;riak-users@lists.basho.com&gt;
Subject:  Re: Riak Search and Yokozuna Backup Strategy

Backing up LevelDB data files can be accomplished while the node is running
if the sst_x directories are backed up in numerical order.  The undesirable
side effects of that could be duplicated data, inconsistent manifest, or
incomplete writes, which necessitates running the leveldb repair process
upon restoration for any vnode backed up while the node was running.  Since
the data is initially written to the recovery log before being appended to
level 0, and any compaction operation fully writes the data to its new
location before removing it from its old location, if any of these
operations are interrupted, the data can be completely recovered by leveldb
repair.  

The only incomplete write that won't be recovered by the LevelDB repair
process is the initial write to the recovery log, limiting exposure  to the
key being actively written at the time of the snapshot/backup.  As long as 2
vnodes in the same preflist are not backed up while simultaneously writing
the same key to the recovery log (i.e. rolling backups are good), this key
will be recovered by AAE/read repair after restoration.

Backing up the LevelDB data files while the node is stopped would remove the
necessity of repairing the

Backing up Riak Search data, on the other hand, is a dicey proposition.
There are 3 bits to riak search data: the document you store, the output of
the extractor, and the merge index.

When you put a document in &lt;&lt;&quot;key&quot;&gt;&gt; in a &lt;&lt;&quot;bucket&quot;&gt;&gt; with search enabled,
Riak uses the pre-defined extractor to parse the document into terms,
possibly flattening the structure, and stores the result in
&lt;&lt;&quot;_rsid_bucket&quot;&gt;&gt;/&lt;&lt;&quot;key&quot;&gt;&gt;, which is used during update operations to
remove stale entries before adding new ones, and would most likely be stored
in a different vnode, possibly on a different node entirely.  The document
id/link is inserted into the merge index entry for each term identified by
the extractor, any or all of which may reside on different nodes.  Since the
document, its index document, and the term indexes could not be guaranteed
to be captured in any single backup operation, it is a very real probability
that these would be out of sync in the event that a restore is required.

If restore is only required for a single node, consistency could be restored
by running a repair operation for each riak_kv vnode and riak_search vnode
stored on the node, which would repair the data from other nodes in the
cluster.  If more than one node is restored, it is quite likely that they
both stored replicas of the same data, for some subset of the full data set.
The only way to ensure consistency is fully restored in the latter case is
to reindex the data set.  This can be accomplished by reading and  rewriting
all of the data, or by reindexing via MapReduce as suggested in this earlier
mailing list post: 
<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2012-October/009">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2012-October/009</a>
861.html

In either restore case, having a backup of the merge_index data files is not
helpful, so there does not appear to be any point in backing them up.

Joe Caswell
From:  Sean McKibben &lt;grap...@graphex.com&gt;
Date:  Tuesday, January 21, 2014 1:04 PM
To:  Elias Levy &lt;fearsome.lucid...@gmail.com&gt;
Cc:  &quot;riak-users@lists.basho.com&quot; &lt;riak-users@lists.basho.com&gt;
Subject:  Re: Riak Search and Yokozuna Backup Strategy

+1 LevelDB backup information is important to us


On Jan 20, 2014, at 4:38 PM, Elias Levy &lt;fearsome.lucid...@gmail.com&gt; wrote:

&gt; Anyone from Basho care to comment?
&gt; 
&gt; 
&gt; On Thu, Jan 16, 2014 at 10:19 AM, Elias Levy &lt;fearsome.lucid...@gmail.com&gt;
&gt; wrote:
&gt;&gt; 
&gt;&gt; Also, while LevelDB appears to be largely an append only format, the
&gt;&gt; documentation currently does not recommend live backups, presumably because
&gt;&gt; there are some issues that can crop up if restoring a DB that was not cleanly
&gt;&gt; shutdown.  
&gt;&gt; 
&gt;&gt; I am guessing those issues are the ones documented as edge cases here:
&gt;&gt; <a  rel="nofollow" href="https://github.com/basho/leveldb/wiki/repair-notes">https://github.com/basho/leveldb/wiki/repair-notes</a>
&gt;&gt; 
&gt;&gt; That said, it looks like as of 1.4 those are largely cleared up, at least
&gt;&gt; from what I gather from that page, and that one must only ensure that data is
&gt;&gt; copied in a certain order and that you run the LevelDB repair algorithm when
&gt;&gt; retiring the files.
&gt;&gt; 
&gt;&gt; So is the backup documentation on LevelDB still correct?  Will Basho will
&gt;&gt; enable hot backups on LevelDB backends any time soon?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Thu, Jan 16, 2014 at 10:05 AM, Elias Levy &lt;fearsome.lucid...@gmail.com&gt;
&gt;&gt; wrote:
&gt;&gt;&gt; How well does Riak Search play with backups?  Can you backup the Riak Search
&gt;&gt;&gt; data without bringing the node down?
&gt;&gt;&gt; 
&gt;&gt;&gt; The Riak documentation backup page is completely silent on Riak Search and
&gt;&gt;&gt; its merge_index backend.
&gt;&gt;&gt; 
&gt;&gt;&gt; And looking forward, what is the backup strategy for Yokozuna?  Will it make
&gt;&gt;&gt; use of Solr's Replication Handler, or something more lower level?  Will the
&gt;&gt;&gt; node need to be offline to backup it up?
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________ riak-users mailing list
riak-users@lists.basho.com<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users">http://lists.basho.com/mailman/listinfo/riak-users</a>
_lists.basho.com


</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg13463.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd4.html#13464">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail4.html#13464">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13468.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg13393.html">Riak Search and Yokozuna Backup Strategy</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13394.html">Re: Riak Search and Yokozuna Backup Strategy</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13419.html">Re: Riak Search and Yokozuna Backup Strateg...</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13432.html">Re: Riak Search and Yokozuna Backup Str...</a></span> <span class="sender italic">Sean McKibben</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13439.html">Re: Riak Search and Yokozuna Backup...</a></span> <span class="sender italic">Daniel Iwan</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13463.html">Re: Riak Search and Yokozuna Backup Strategy</a></span> <span class="sender italic">Joe Caswell</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Search and Yokozuna Backup Strateg...</span> <span class="sender italic">Joe Caswell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13468.html">Re: Riak Search and Yokozuna Backup Str...</a></span> <span class="sender italic">Dave Martorana</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13470.html">Re: Riak Search and Yokozuna Backup...</a></span> <span class="sender italic">Sargun Dhillon</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13493.html">Re: Riak Search and Yokozuna Backup Strateg...</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13494.html">Re: Riak Search and Yokozuna Backup Str...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13495.html">Re: Riak Search and Yokozuna Backup...</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13496.html">Re: Riak Search and Yokozuna B...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13497.html">Re: Riak Search and Yokozuna Backup Str...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13498.html">Re: Riak Search and Yokozuna Backup...</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13499.html">Re: Riak Search and Yokozuna B...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Search and Yokozuna Backup Strategy">
<input type="hidden" name="msgid" value="CF06CA25.2AAE2%jcaswell@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg13464.html">
<input type="submit" value=" Joe Caswell ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Search+and+Yokozuna+Backup+Strategy%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg13463.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13468.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CF06CA25.2AAE2%jcaswell@basho.com</li>
</ul>
</div>
</body>
</html>
