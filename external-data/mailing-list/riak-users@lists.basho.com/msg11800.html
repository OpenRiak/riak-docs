<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak 1.4 test on Azure - Webmachine error at path ...</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd13.html#11800" id="c">
<link rel="index" href="mail12.html#11800" id="i">
<link rel="prev" href="msg11799.html" id="p">
<link rel="next" href="msg11810.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11800.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.4+test+on+Azure+%5C-+Webmachine+error+at+path+...%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak 1.4 test on Azure - Webmachine error at path ...</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Von%5C-Maszewski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Von-Maszewski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130728" rel="nofollow">Sun, 28 Jul 2013 13:09:50 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Christian,

leveldb has two independent caches:  file cache and data block cache.  You have 
raised the data block cache from its default 8M to 256M per your earlier note.  
I would recommend the follow:</pre><pre>

{max_open_files, 50},          %% 50 * 4Mbytes allocation for file cache
{cache_size, 104857600},  %% 100Mbytes for data block cache

The max_open_files default is 20 (which is internally reduced by 10).  You are 
likely thrashing file opens.  The file cache is far more important to 
performance than the data block cache.  

Find the LOG file within one of your database &quot;vnode&quot; directories.  Look for a 
line like this ' compacted to: files[ 0 9 25 14 2 0 0 ]'.  You would like to be 
covering that total count of files (plus 10) with your max_open_files setting.  
Take the cache_size down to as low as 8Mbytes to achieve the coverage.  Once 
you are down to 8Mbytes of cache_size, you should go no lower and give up on 
full max_open_files coverage.

Summary:  total memory per vnode in 1.4 is (max_open_files - 10) * 4Mbytes + 
cache_size;



Matthew

On Jul 28, 2013, at 3:53 PM, Christian Rosnes &lt;christian.ros...@gmail.com&gt; 
wrote:

&gt; 
&gt; 
&gt; 
&gt; On Thu, Jul 25, 2013 at 2:16 PM, Christian Rosnes 
&gt; &lt;christian.ros...@gmail.com&gt; wrote:
&gt;  
&gt; During a test I just performed on a small Riak 1.4 cluster setup on Azure,
&gt; I started seeing the Riak errors messages listed below after about 10 
&gt; minutes. 
&gt; 
&gt; The simple test was performed using lastest Jmeter running on two Azure 
&gt; instances, 
&gt; which also each runs haproxy and loadbalances the http/rest requests between 
&gt; the 4 Riak nodes.
&gt; 
&gt; 
&gt; An Update:
&gt; 
&gt; Increased some sysctl.conf network parameters on the Riak instances.
&gt; I have now been running 3 consecutive 1-hour JMeter tests with no errors:
&gt; 
&gt; &gt;&gt; 600 JMeter threads - 3600 seconds
&gt; [FINAL RESULTS] 
&gt; total count: 5526844, overall avg: 386 (ms), 
&gt; overall tps: 1536.6 (p/sec), recent tps: 1932.1 (p/sec), errors: 0
&gt; 
&gt; &gt;&gt; 400 JMeter threads - 3600 seconds
&gt; [FINAL RESULTS] 
&gt; total count: 6350600, overall avg: 224 (ms), 
&gt; overall tps: 1765.7 (p/sec), recent tps: 1849.1 (p/sec), errors: 0
&gt; 
&gt; &gt;&gt; 300 JMeter threads - 3600 seconds
&gt; [FINAL RESULTS]
&gt; total count: 5997689, overall avg: 178 (ms), 
&gt; overall tps: 1666.5 (p/sec), recent tps: 1744.7 (p/sec), errors: 0
&gt; 
&gt; A drop in performance compared to previous Azure results 
&gt; (from around 2000 req/s for 1-hour tests), but it may be caused
&gt; by the move of Riak data directory from ephemeral 
&gt; /mnt/resource partitions to persistent XFS partitions; 
&gt; 'iostat' reports that the new partitions are near 100% 
&gt; io utilization during the tests.
&gt; 
&gt; Will run a few more tests, then on to testing on some larger 
&gt; (and a few more) Azure instances and compare result with 
&gt; similar instances on AWS.
&gt; 
&gt; Christian
&gt; @NorSoulx
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11799.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd13.html#11800">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail12.html#11800">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11810.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11742.html">Riak 1.4 test on Azure - Webmachine error at path .....</a></span> <span class="sender italic">Christian Rosnes</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11799.html">Re: Riak 1.4 test on Azure - Webmachine error a...</a></span> <span class="sender italic">Christian Rosnes</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak 1.4 test on Azure - Webmachine err...</span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11810.html">Re: Riak 1.4 test on Azure - Webmachine...</a></span> <span class="sender italic">Christian Rosnes</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11811.html">Re: Riak 1.4 test on Azure - Webmac...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak 1.4 test on Azure - Webmachine error at path ...">
<input type="hidden" name="msgid" value="8173AB84-3536-48FD-A216-8EFF8D126E1C@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11800.html">
<input type="submit" value=" Matthew Von-Maszewski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.4+test+on+Azure+%5C-+Webmachine+error+at+path+...%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11799.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11810.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">8173AB84-3536-48FD-A216-8EFF8D126E1C@basho.com</li>
</ul>
</div>
</body>
</html>
