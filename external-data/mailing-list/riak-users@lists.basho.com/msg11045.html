<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak 1.3.1 and w=1 performance change</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#11045" id="c">
<link rel="index" href="maillist.html#11045" id="i">
<link rel="prev" href="msg11043.html" id="p">
<link rel="next" href="msg11046.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11045.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.3.1+and+w%3D1+performance+change%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak 1.3.1 and w=1 performance change</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alexander+Sicular%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alexander Sicular</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130508" rel="nofollow">Wed, 08 May 2013 20:13:15 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Thanks for the breakdown. Is this true in cases where the coordinating node 
servicing the request is itself not part of the covering set of nodes that will 
own the key in question? Assume a 5 node cluster. Node 1 receives the request 
but the key ultimately belongs to nodes 2,3,4. Will node 1 write the key to its 
disk and return to client (w/dw=1)?</pre><pre>

Thank you,
Alexander

@siculars
<a  rel="nofollow" href="http://siculars.posterous.com">http://siculars.posterous.com</a>

Sent from my iRotaryPhone

On May 8, 2013, at 18:29, John Daily &lt;jda...@basho.com&gt; wrote:

&gt; As you may have noticed, this week on the blog I've been tackling the deeper 
&gt; meanings of various behavioral configuration parameters, ranging from ye olde 
&gt; r/w parameters to the much more obscure basic_quorum.
&gt; 
&gt; After posting today's missive, the esteemed Andrew Thompson noticed that 
&gt; something I documented was no longer true in v1.3.1, and after some 
&gt; discussions we realized that this change had implications that needed to be 
&gt; shared with the community.
&gt; 
&gt; For those unfamiliar: dw is short for durable write, so setting dw values for 
&gt; a bucket or request indicates how many nodes should have the data saved to 
&gt; the backend (typically bitcask or leveldb) before the client is sent a 
&gt; response.
&gt; 
&gt; 
&gt; tl;dr
&gt; ==
&gt; If you set w=1 for performance reasons, make sure you also set dw=1.
&gt; 
&gt; 
&gt; Slightly longer version
&gt; ==
&gt; Until 1.3.1, dw (durable write) would be implicitly demoted to have the same 
&gt; value as w when w was smaller. This is a reasonable optimization for the w=1 
&gt; case (dw defaults to quorum, despite what you may have read on 
&gt; docs.basho.com) but a very unreasonable behavior when someone explicitly 
&gt; asked for dw=3 without also asking for w=3.
&gt; 
&gt; Now in 1.3.1 dw will be 1 (at a minimum), 2 (by default), and 3 (if 
&gt; requested) no matter what value is set for w.
&gt; 
&gt; 
&gt; Cross-referenced version
&gt; ==
&gt; Read <a  rel="nofollow" href="http://basho.com/understanding-riaks-configurable-behaviors-part-1/">http://basho.com/understanding-riaks-configurable-behaviors-part-1/</a> and 
&gt; <a  rel="nofollow" href="http://basho.com/riaks-config-behaviors-part-2/">http://basho.com/riaks-config-behaviors-part-2/</a>; the latter should be updated 
&gt; today to reflect the 1.3.1 behavior.
&gt; 
&gt; Also check back on the blog (<a  rel="nofollow" href="http://basho.com/blog">http://basho.com/blog</a>) later this week for 2 
&gt; more posts in the series. I think you'll enjoy them.
&gt; 
&gt; 
&gt; The really long version
&gt; ==
&gt; (Actually, this is somewhat tangential to the original point and shorter than 
&gt; my blog posts, so it's really the longish pedantic version.)
&gt; 
&gt; This explanation assumes default behaviors, such as vnode_vclocks=true and 
&gt; n_val=3. Vnode-based vector clocks are the defining behavioral characteristic 
&gt; that makes this flow what it is.
&gt; 
&gt; 
&gt; When a write request arrives at the coordinating node, contrary to what one 
&gt; might expect it is not immediately sent to the other 2 nodes with 
&gt; responsibility over the key.
&gt; 
&gt; Instead, the request is handed to the local vnode mapped to that key, and 
&gt; until the vnode replies back with a new vector clock, nothing else happens.
&gt; 
&gt; So, the approximate sequence of events:
&gt; 
&gt; 1  Coordinating node receives request
&gt; 2  Request is forwarded to local vnode
&gt; 3  Local vnode replies with &quot;w&quot; message to the coordinating node indicating 
&gt; it has received the request
&gt; 4  Local vnode creates a new vector clock based on the vclock received with 
&gt; the request, if any, and possibly impacted by any existing object with the 
&gt; same key
&gt; 5  Local vnode sends the new object to the backend
&gt; 6  Local vnode replies with &quot;dw&quot; message and new object to the coordinating 
&gt; node
&gt; 7  If w=1 and dw=1, /now/ the coordinating node replies to the client, with 
&gt; the new vclock if requested by the client
&gt; 8  The coordinating node sends the new object with new vclock to the remote 
&gt; vnodes that also own the key
&gt; 9  Each vnode will reply with a &quot;w&quot; message upon receipt
&gt; 10 Each vnode will reply with a &quot;dw&quot; message upon sending the object to its 
&gt; backend
&gt; 11 If w&gt;1 or dw&gt;1, the coordinating node replies to the client once it has 
&gt; received enough successful replies from the remote vnodes to meet those values
&gt; 
&gt; (This is why it's not meaningful, with vnode_vclocks=true, to set dw=0. It 
&gt; has a minimum effective value of 1, regardless of what the client or operator 
&gt; wishes, because the first vnode must construct a new vector clock and store 
&gt; the object to disk before the client can ever receive a response.)
&gt; 
&gt; And as you can see, all activity before the reply to the client is local to 
&gt; the coordinating node when w=1 and dw=1, and the response can be sent back to 
&gt; the client before the request is forwarded to other nodes.
&gt; 
&gt; Prior to 1.3.1, dw would be effectively 1 if w was set to 1. Now, with 1.3.1, 
&gt; both w and dw must be set to 1 before that optimal response time can be 
&gt; achieved.
&gt; 
&gt; -John
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11043.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#11045">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#11045">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11046.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11043.html">Riak 1.3.1 and w=1 performance change</a></span> <span class="sender italic">John Daily</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak 1.3.1 and w=1 performance change</span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11046.html">Re: Riak 1.3.1 and w=1 performance change</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak 1.3.1 and w=1 performance change">
<input type="hidden" name="msgid" value="86D8EA42-54CE-4AD1-9B2A-0E379C8FEE7A@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11045.html">
<input type="submit" value=" Alexander Sicular ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.3.1+and+w%3D1+performance+change%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11043.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11046.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">86D8EA42-54CE-4AD1-9B2A-0E379C8FEE7A@gmail.com</li>
</ul>
</div>
</body>
</html>
