<!DOCTYPE html>
<html lang="en">
<head>
<title>Unable to force remove a node that got stuck while leaving the cluster</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08028" id="c">
<link rel="index" href="mail2.html#08028" id="i">
<link rel="prev" href="msg08026.html" id="p">
<link rel="next" href="msg08035.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08028.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Unable+to+force+remove+a+node+that+got+stuck+while+leaving+the+cluster%22&amp;o=newest" rel="nofollow"><span itemprop="name">Unable to force remove a node that got stuck while leaving the cluster</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Erik+Hoogeveen%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Erik Hoogeveen</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120723" rel="nofollow">Mon, 23 Jul 2012 03:09:26 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Since about a week we run a 16 node Riak cluster. We use Riak 1.1.2 with 
Bitcask 1.5.1 as storage backend. We run this on Debian 6.0.5 Linux 
2.6.38-bpo.2-amd64 and Erland R14B04. </pre><pre>

When we started using this setup we hit the jackpot right away. The disk in one 
of the nodes started causing problems quite soon. So we told that machine to 
leave the riak cluster.

Unfortunately the handoff had still not completed 12 hours later.  In the logs 
we saw:

2012-07-13 00:05:34.526 [info] 
&lt;0.29522.7&gt;@riak_core_handoff_sender:start_fold:83 Starting handoff of 
partition riak_kv_vnode 348248437020254210978221776545676813277390176256 from 
'riak@10.53.1.20' to 'riak@10.53.1.15'
2012-07-13 00:06:11.272 [error] 
&lt;0.29522.7&gt;@riak_core_handoff_sender:start_fold:119 Handoff of partition 
riak_kv_vnode 348248437020254210978221776545676813277390176256 from 
'riak@10.53.1.20' to 'riak@10.53.1.15' failed  because &lt;0.29523.7&gt; died with 
reason 
{{badmatch,{error,{bad_crc,&lt;&lt;&gt;&gt;,435787301}}},[{riak_core_handoff_sender,'-start_fold/5-fun-1-',9}]}
2012-07-13 00:06:11.272 [error] emulator Error in process &lt;0.29523.7&gt; on node 
'riak@10.53.1.20' with exit value: {{badmatch,{error,{bad_crc,&lt;&lt;0 
bytes&gt;&gt;,435787301}}},[{riak_core_handoff_sender,'-start_fold/5-fun-1-',9}]}

Over and over and over again. This is understandable since the disk had a bad 
sector. But once stuck in this situation it's quite hard to get Riak unstuck..

We tried to stop the broken node, it wouldn't want to stop nicely so we killed 
it with brute force.
Then we tried to run &quot;riak-admin force-remove&quot; from one of the other nodes to 
let everybody else know the broken node wouldn't be coming back anytime soon.

Unfortunately it just told us:

Failed: &quot;riak10&quot; is not a member of the cluster.

And the cluster status showed that the broken node was still in state leaving.

Eventually the only way we got it to leave completely was by wiping all the 
data on the broken node, letting it rejoin and then issue a force-remove, which 
was only possible after it had received all it's data again.
I would say that the force-remove should remove a node from the cluster 
regardless the state it's in and it would have far less impact on the other 
nodes than to go through the whole rejoin process first.

Anyhow we're back in business. But I thought maybe this can be improved so I 
thought it would be good to let you know.

Kind regards,
Erik Hoogeveen




_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08026.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08028">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#08028">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08035.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">

</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Unable to force remove a node that got stuck while leaving the cluster">
<input type="hidden" name="msgid" value="FA0DC884-2A15-46FD-91A5-47B0E0916476@nimbuzz.nl">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08028.html">
<input type="submit" value=" Erik Hoogeveen ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Unable+to+force+remove+a+node+that+got+stuck+while+leaving+the+cluster%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08026.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08035.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">FA0DC884-2A15-46FD-91A5-47B0E0916476@nimbuzz.nl</li>
</ul>
</div>
</body>
</html>
