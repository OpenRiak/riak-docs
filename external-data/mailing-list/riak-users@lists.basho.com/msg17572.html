<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak TS max concurrent queries + overload error</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17572" id="c">
<link rel="index" href="maillist.html#17572" id="i">
<link rel="prev" href="msg17571.html" id="p">
<link rel="next" href="#" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17572.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+TS+max+concurrent+queries+%5C%2B+overload+error%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak TS max concurrent queries + overload error</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Cian+Synnott%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Cian Synnott</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160728" rel="nofollow">Thu, 28 Jul 2016 03:16:31 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>On Thu, Jul 28, 2016 at 6:10 AM,  &lt;chris.john...@vaisala.com&gt; wrote:
&gt; Thank you! I should've mentioned in my initial email that I thought we were 
&gt; experiencing the same bug you called out (in fact the 2nd comment on that 
&gt; github issue is actually from me).
&gt;
Aha, cool. :o)</pre><pre>

&gt; So, what I'm really curious about is whether or not the original &quot;overload&quot; 
&gt; error is happening because we're hitting the limit on TS max concurrent 
&gt; queries or if riak is actually &quot;overloaded&quot; and we shouldn't increase the 
&gt; configuration value for max concurrent queries.
&gt;
I looked into this when examining the bug, and it *is* stimulated by
hitting the max concurrent queries, which as you've noted is set
nervous-alpha-software low by default. Plain `overload` is a little
unhelpful in that it is used deeper within Riak KV too, but in this
case I'm confident you're hitting the one in Riak TS's query path.

&gt; I'd like to know whether or not I should expect a certain value for max 
&gt; concurrent queries to be stable and performant for some given hardware specs. 
&gt; This is an experiment that we will probably run in house to determine a good 
&gt; value, but it would be great to know what range is expected to perform well.
&gt;
I don't think there is a range expected to perform well, yet. The PBC
server just dying on overload suggests it hasn't really been
loadtested much at Basho, so sharing whatever you come up with on the
list would be good. :o)

&gt; Also, I have no idea if the max concurrent queries setting includes 
&gt; subqueries over multiple quanta. For instance, if I have 4 TS queries hitting 
&gt; a riak node configured for 12 max queries and each query spans 3 - 4 quanta, 
&gt; should i expect an &quot;overload&quot; error?
&gt;
No, max concurrent queries does not include this.

Digging around in the code, the max subqueries configuration is used
in the query compiler, and the error message in that case is
`too_many_subqueries`
  
<a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/2.1.3-ts/src/riak_kv_qry_compiler.erl#L533">https://github.com/basho/riak_kv/blob/2.1.3-ts/src/riak_kv_qry_compiler.erl#L533</a>

which I'm not sure is plumbed properly back through the PBC server's
error responses, and the code is a little more twisty than I have time
to check right now.

If I understand the code correctly, overload due to max concurrent
queries is hit when there are more than 3 queries waiting to be served
by the query FSMs, which are started around here:
  <a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/2.1.3-ts/src/riak_kv_qry_sup.erl#L61">https://github.com/basho/riak_kv/blob/2.1.3-ts/src/riak_kv_qry_sup.erl#L61</a>

So, `timeseries_max_concurrent_queries` gives us the number of query
FSMs per node. There's a short, static overflow queue of queries, and
if the FSMs can't keep up, you get the overload message.

I don't know why the default number of query FSMs running per node is
so low. Perhaps early customers were using it purely interactively, at
a command prompt? In any case, try setting it lots higher and see how
you get on.

Cian

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17571.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17572">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17572">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright buttondisabled" accesskey="n" href="#">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg17568.html">riak TS max concurrent queries + overload error</a></span> <span class="sender italic">Chris.Johnson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17570.html">Re: riak TS max concurrent queries + overload error</a></span> <span class="sender italic">Cian Synnott</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17571.html">Re: riak TS max concurrent queries + overload error</a></span> <span class="sender italic">Chris.Johnson</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak TS max concurrent queries + overload e...</span> <span class="sender italic">Cian Synnott</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak TS max concurrent queries + overload error">
<input type="hidden" name="msgid" value="CAFS-AQ3cAhB0UMgDVEEXQx_QCaDXvdAFtCaCMe6wLwrv5w3b1w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17572.html">
<input type="submit" value=" Cian Synnott ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+TS+max+concurrent+queries+%5C%2B+overload+error%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17571.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="#" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAFS-AQ3cAhB0UMgDVEEXQx_QCaDXvdAFtCaCMe6wLwrv5w3b1w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
