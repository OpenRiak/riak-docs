<!DOCTYPE html>
<html lang="en">
<head>
<title>Some questions about failures during a PUT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06094" id="c">
<link rel="index" href="maillist.html#06094" id="i">
<link rel="prev" href="msg06093.html" id="p">
<link rel="next" href="msg06096.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06094.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Some+questions+about+failures+during+a+PUT%22&amp;o=newest" rel="nofollow"><span itemprop="name">Some questions about failures during a PUT</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jakob+Sievers%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jakob Sievers</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111230" rel="nofollow">Fri, 30 Dec 2011 05:37:36 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,
I've started to look through the Riak sources, and I've been wondering how
the system behaves in certain failure scenarios.
In particular, it seems to me that it's quite easy to get into a state where the
client thinks a PUT request failed, but the object was in fact written to 
storage
and will be replicated to n_val nodes eventually.</pre><pre>

For example, assume I have a cluster with three nodes, A, B, C.
I use r=pr=w=pw=dw=quorum=2 and an n_val of 3.
All nodes have a copy of object O with key K and vector clock V.

A client reads O, modifies it locally, then attempts to write its modified copy 
O'.
Let's say the client talks to node A. riak_client:put/2 will cause a 
riak_kv_put_fsm
to be started. In execute_local/1, we tell the local vnode to coordinate this 
PUT,
which will cause it to eventually call riak_kv_vnode:prepare_put/2, which 
increments
the object's vector clock to V', and perform_put/3, which writes O' to disk 
with vector clock
V'. The vnode replies {dw, ...} to the FSM which has been idling in 
waiting_local_node/2.
If A now crashes, the client will get an {error, timeout}.
If A then recovers and the client does a new GET for key K it may see either O 
or O'
(if the vnode on A is one of the first two vnodes to return a repsonse, its 
version of the object
will be used as the result since V descends from V').

Is this actually possible? Also, how would read-repair work in this scenario? 
If all three
nodes are up, I guess Riak could detect the incosistency, but if e.g. C was 
down at the
time, would K' be replicated to B and then later to C as well?

cheers,
-jakob


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06093.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06094">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06094">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06096.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">

</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Some questions about failures during a PUT">
<input type="hidden" name="msgid" value="F1CE0867-9EC2-4500-ACF2-A9CB94997236@klarna.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06094.html">
<input type="submit" value=" Jakob Sievers ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Some+questions+about+failures+during+a+PUT%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06093.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06096.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">F1CE0867-9EC2-4500-ACF2-A9CB94997236@klarna.com</li>
</ul>
</div>
</body>
</html>
