<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Re: Riak performance problems when LevelDB database grows beyond 16GB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08893" id="c">
<link rel="index" href="maillist.html#08893" id="i">
<link rel="prev" href="msg08887.html" id="p">
<link rel="next" href="msg08894.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08893.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Re: Riak performance problems when LevelDB database grows beyond 16GB</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jan.Evangelista%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jan.Evangelista</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121012" rel="nofollow">Fri, 12 Oct 2012 05:02:45 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>&gt; Can you attach the eleveldb portion of your app.config file?
&gt; Configuration problems, especially max_open_files being too low, can
&gt; often cause issues like this.
&gt;
&gt; If it isn't sensitive, the whole app.config and vm.args files are also
&gt; often helpful.</pre><pre>

Hello Evan,

thanks for responding.

I originally had default LevelDB settings. When the node stalled, I changed it
 to

 {eleveldb, [
             {data_root, &quot;/home/riak/leveldb&quot;},
             {max_open_files, 132},
             {cache_size, 377487360}
            ]},

on all nodes and I restarted them all. The application started to run with 
about 1000 requests/second, after about 1 minute it dropped to &lt;500 
requests/second, and the node stalled again after 41 minutes. BTW according to
 lsof(1) it had 267 open LevelDB files which is more than the 132 files limit 
(??).

Here is the configuration (with comments removed to work around 40 KB message 
limit on the Riak users list).

/etc/riak/vm.args:

-name riak@172.16.0.2
-setcookie riak_0627f0bc6c9
+K true
+A 64
+W w
-env ERL_MAX_PORTS 4096
-env ERL_FULLSWEEP_AFTER 0
-env ERL_CRASH_DUMP /var/log/riak/erl_crash.dump
-env ERL_MAX_ETS_TABLES 8192

/etc/riak/app.config:

[
 {riak_api, [
            {pb_ip,   &quot;172.16.0.2&quot; },
            {pb_port, 8087 }
            ]},
 {riak_core, [
              {ring_state_dir, &quot;/var/lib/riak/ring&quot;},
              %{ring_creation_size, 64},
              {http, [ {&quot;127.0.0.1&quot;, 8098 } ]},
              %{https, [{ &quot;127.0.0.1&quot;, 8098 }]},
              %{ssl, [
              %       {certfile, &quot;/etc/riak/cert.pem&quot;},
              %       {keyfile, &quot;/etc/riak/key.pem&quot;}
              %      ]},
              {handoff_port, 8099 },
              %{handoff_ssl_options, [{certfile, &quot;/tmp/erlserver.pem&quot;}]},
              {dtrace_support, false},
              {platform_bin_dir, &quot;/usr/sbin&quot;},
              {platform_data_dir, &quot;/var/lib/riak&quot;},
              {platform_etc_dir, &quot;/etc/riak&quot;},
              {platform_lib_dir, &quot;/usr/lib/riak/lib&quot;},
              {platform_log_dir, &quot;/var/log/riak&quot;}
             ]},
 {riak_kv, [
            {add_paths, 
[&quot;/usr/local/share/riak-mapred/riak-1.2.0/deps/greylisting/ebin/&quot;]},
            {storage_backend, riak_kv_eleveldb_backend},
            %{raw_name, &quot;riak&quot;},
            {mapred_name, &quot;mapred&quot;},
            {mapred_system, pipe},
            {mapred_2i_pipe, true},
            {map_js_vm_count, 8 },
            {reduce_js_vm_count, 6 },
            {hook_js_vm_count, 2 },
            {js_max_vm_mem, 8},
            {js_thread_stack, 16},
            %{js_source_dir, &quot;/tmp/js_source&quot;},
            {http_url_encoding, on},
            {vnode_vclocks, true},
            {legacy_keylisting, false},
            {listkeys_backpressure, true}
           ]},
 {riak_search, [
                {enabled, false}
               ]},
 {merge_index, [
                {data_root, &quot;/var/lib/riak/merge_index&quot;},
                {buffer_rollover_size, 1048576},
                {max_compact_segments, 20}
               ]},
 {bitcask, [
             {data_root, &quot;/var/lib/riak/bitcask&quot;}
           ]},
 {eleveldb, [
             {data_root, &quot;/home/riak/leveldb&quot;},
             {max_open_files, 132},
             {cache_size, 377487360}
            ]},
 {lager, [
            {handlers, [
                {lager_console_backend, info},
                {lager_file_backend, [
                    {&quot;/var/log/riak/error.log&quot;, error, 10485760, &quot;$D0&quot;, 5},
                    {&quot;/var/log/riak/console.log&quot;, info, 10485760, &quot;$D0&quot;, 5}
                ]}
            ]},
            {crash_log, &quot;/var/log/riak/crash.log&quot;},
            {crash_log_msg_size, 65536},
            {crash_log_size, 10485760},
            {crash_log_date, &quot;$D0&quot;},
            {crash_log_count, 5},
            {error_logger_redirect, true}
        ]},
 {riak_sysmon, [
         {process_limit, 30},
         {port_limit, 2},
         {gc_ms_limit, 100},
         {heap_word_limit, 40111000},
         {busy_port, true},
         {busy_dist_port, true}
        ]},
 {sasl, [
         {sasl_error_logger, false}
        ]},
 {riak_control, [
                {enabled, false},
                {auth, userlist},
                {userlist, [{&quot;user&quot;, &quot;pass&quot;}
                           ]},
                {admin, true}
                ]}
].

Thanks.
--
Jan

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08887.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08893">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08893">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08894.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08881.html">Riak performance problems when LevelDB database grow...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08887.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Re: Riak performance problems when Leve...</span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08894.html">Re: Re: Riak performance problems when ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08924.html">Re: Re: Re: Riak performance proble...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08927.html">Re: Riak performance problems ...</a></span> <span class="sender italic">Eli Janssen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08930.html">Re: Re: Riak performance p...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08948.html">Re: Riak performance problems when ...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08969.html">Re: Riak performance problems ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08959.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08970.html">Re: Riak performance problems when LevelDB ...</a></span> <span class="sender italic">István</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg09003.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09017.html">Re: Riak performance problems when LevelDB ...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Re: Riak performance problems when LevelDB database grows beyond 16GB">
<input type="hidden" name="msgid" value="e}X.2jUNH.7oxhGq15R7J.1GU0RS@seznam.cz">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08893.html">
<input type="submit" value=" Jan.Evangelista ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08887.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08894.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">e}X.2jUNH.7oxhGq15R7J.1GU0RS@seznam.cz</li>
</ul>
</div>
</body>
</html>
