<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak 1.0 pre2 legacy_keylisting crash</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#05094" id="c">
<link rel="index" href="maillist.html#05094" id="i">
<link rel="prev" href="msg05091.html" id="p">
<link rel="next" href="msg05109.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05094.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.0+pre2+legacy_keylisting+crash%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak 1.0 pre2 legacy_keylisting crash</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Bryan+Fink%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bryan Fink</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111007" rel="nofollow">Fri, 07 Oct 2011 06:06:26 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>On Fri, Oct 7, 2011 at 1:50 AM, Fyodor Yarochkin &lt;fyodo...@armorize.com&gt; wrote:
&gt; Here's one of the queries that consistently generates series of
&gt; 'fitting_died' log messages:
&gt;
&gt; {
&gt;   &quot;inputs&quot;:{
&gt;       &quot;bucket&quot;:&quot;test&quot;,
&gt;       &quot;index&quot;:&quot;integer_int&quot;,
…
&gt;   },
&gt;   &quot;query&quot;:[
&gt;    {&quot;map&quot;:{&quot;language&quot;:&quot;javascript&quot;,
…
&gt;    },
&gt;    {&quot;reduce&quot;:{&quot;language&quot;:&quot;javascript&quot;,
…
&gt;  {&quot;reduce&quot;:{&quot;language&quot;:&quot;javascript&quot;,
…
&gt;    ],&quot;timeout&quot;: 9000
&gt; }
&gt;
&gt; produces over hundred of &quot; &quot;Supervisor riak_pipe_vnode_worker_sup had
&gt; child at module undefined at &lt;0.28835.0&gt; exit with reason fitting_died
&gt; in context child_terminated&quot; entries in log file and returns 'timeout'</pre><pre>

My interpretation of your report is that 9 seconds is not long enough
to finish your MapReduce query.  I'll explain how I arrived at this
interpretation:

The log message you're seeing says that many processes that
riak_pipe_vnode_worker_sup was monitor exited abnormally.  That
supervisor only monitors Riak Pipe worker processes, the processes
that do the work for Riak 1.0's MapReduce phases.

The reason those workers gave for exiting abnormally was
'fitting_died'.  This means that the pipeline they were working for
closed before they were finished with their work.

The result your received was 'timeout'.  The way timeouts work in
Riak-Pipe-based MapReduce is that a timer triggers a message at the
given time, causing a monitoring process to cease waiting for results,
tear down the pipe, and return a timeout message to your client.

The &quot;tear down the pipe&quot; step in the timeout process is what causes
all of those 'fitting_died' message you see.  They're normal, and are
intended to aid in analysis like the above.

With that behind us, though, the question remains: why isn't 9 seconds
long enough to finish this query?  To figure that out, I'd start from
the beginning:

1. Is 9 seconds long enough to just finish the index query (using the
index API outside of MapReduce)?  If not, then the next people to jump
in with help here will want to know more about the types, sizes, and
counts of data you have indexed.

2. Assuming the bare index query finishes fast enough, is 9 seconds
long enough to get through just the index and map phase (no reduce
phases)?  If not, it's likely that either it takes longer than 9
seconds to pull every object matching your index query out of KV, or
that contention for Javascript VMs prohibits the throughput needed.

2a. Try switching to an Erlang map phase.
{&quot;language&quot;:&quot;erlang&quot;,&quot;module&quot;:&quot;riak_kv_mapreduce&quot;,&quot;function&quot;:&quot;map_object_value&quot;,&quot;arg&quot;:&quot;filter_notfound&quot;}
should do exactly what your Javascript function does, without
contending for a JS VM.

2b. Try increasing the number of JS VMs available for map phases.  In
your app.config, find the 'map_js_vm_count' setting, and increase it.

3. Assuming just the map phase also makes it through, is 9 seconds
long enough to get through just the index, map, and first reduce phase
(leave off the second)?  Your first reduce phase looks like it doesn't
do anything … is it needed?  Try removing it.

4. If you get all the way to the final phase before hitting the 9
second timeout, then it's may be that the re-reduce behavior of Riak
KV's MapReduce causes your function to be too expensive.  This will be
especially true if you expect that phase to receive thousands of
inputs.  A sort function such as yours probably doesn't benefit from
re-reduce, so I would recommend disabling it by adding
&quot;arg&quot;:{&quot;reduce_phase_only_1&quot;:true} to that reduce phase's
specification.  With that in place, your function should be evaluated
only once, with all the inputs it will receive.  This may still fail
because of the time it can take to encode/decode a large set of
inputs/outputs to/from JSON, but doing it only once may be enough to
get you finished.

Hope that helps,
Bryan

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05091.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#05094">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05094">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05109.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04651.html">Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Ryan Caught</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04652.html">Re: Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04653.html">Re: Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Ryan Caught</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04654.html">Re: Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Daniel Reverri</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04657.html">Re: Riak 1.0 pre2 legacy_keylisting cras...</a></span> <span class="sender italic">Ryan Caught</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04664.html">Re: Riak 1.0 pre2 legacy_keylisting...</a></span> <span class="sender italic">Bryan Fink</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04788.html">Re: Riak 1.0 pre2 legacy_keylis...</a></span> <span class="sender italic">Ryan Caught</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg05091.html">Re: Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Fyodor Yarochkin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak 1.0 pre2 legacy_keylisting crash</span> <span class="sender italic">Bryan Fink</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05109.html">Re: Riak 1.0 pre2 legacy_keylisting crash</a></span> <span class="sender italic">Jim Adler</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05146.html">Re: Riak 1.0 pre2 legacy_keylisting cras...</a></span> <span class="sender italic">Fyodor Yarochkin</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak 1.0 pre2 legacy_keylisting crash">
<input type="hidden" name="msgid" value="CAOLR_oY+rpEpyemdT9Go0mxN7B0AGEYU0p0syb6q2b_cHYEHqQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05094.html">
<input type="submit" value=" Bryan Fink ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+1.0+pre2+legacy_keylisting+crash%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05091.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05109.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAOLR_oY+rpEpyemdT9Go0mxN7B0AGEYU0p0syb6q2b_cHYEHqQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
