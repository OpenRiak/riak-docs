<!DOCTYPE html>
<html lang="en">
<head>
<title>Basho Product Alert Update re DataTypes Disk Format Incompatibility</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#15565" id="c">
<link rel="index" href="maillist.html#15565" id="i">
<link rel="prev" href="msg15563.html" id="p">
<link rel="next" href="msg15573.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg15565.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Basho+Product+Alert+Update+re+DataTypes+Disk+Format+Incompatibility%22&amp;o=newest" rel="nofollow"><span itemprop="name">Basho Product Alert Update re DataTypes Disk Format Incompatibility</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Seema+Jethani%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Seema Jethani</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150121" rel="nofollow">Wed, 21 Jan 2015 15:21:14 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>This update adds some more details on the data types incompatibility issue
posted to the user list and alerted by Russell Brown earlier today</pre><pre>

On January 20th 2015, a user reported issues [1] with CRDTs on upgrading
from Riak 2.0.2 to 2.0.4.

Keys that store maps inside maps, or sets inside maps created by Riak 2.0.0
to 2.0.2 are unreadable after upgrading to 2.0.4.  Keys that just contain a
set or contain a single level map are unaffected.

The root cause is a change to the on disk format as part of a performance
improvement to the Map and Set DataTypes introduced in 2.0.4.

[1]
<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2015-January/016568.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2015-January/016568.html</a>
*Description*

*Applicability*: Riak 2.0.4

*Symptoms:* Request timeouts, inability to access data in maps with nested
maps or sets created in a previous version of Riak 2.0.

*Cause:* Change in the on-disk format of CRDTs

*Identification:* The Riak log can be used to assess impact and will
contain this entry for each failed get:

2015-01-21 13:01:00.441 [error]
&lt;0.1033.0&gt;@riak_core_vnode:vnode_command:348 riak_kv_vnode command
failed 
{{badrecord,dict},[{dict,filter_dict,2,[{file,&quot;dict.erl&quot;},{line,464}]},{riak_dt_map,'-filter_unique/4-fun-1-',4,[{file,&quot;src/riak_dt_map.erl&quot;},{line,466}]},{sets,fold_bucket,3,[{file,&quot;sets.erl&quot;},{line,313}]},{sets,fold_seg,4,[{file,&quot;sets.erl&quot;},{line,309}]},{sets,fold_segs,4,[{file,&quot;sets.erl&quot;},{line,305}]},{riak_dt_map,merge,2,[{file,&quot;src/riak_dt_map.erl&quot;},{line,454}]},{riak_kv_crdt,'-merge_value/2-fun-0-',5,[{file,&quot;src/riak_kv_crdt.erl&quot;},{line,204}]},{orddict,update,4,[{file,&quot;orddict.erl&quot;},{line,170}]}]}

Additionally, the client making the request will experience a timeout.
Affected Users

Users will be affected if they:

   1.

   Use Riak DataTypes to store Sets inside Maps or Maps inside Maps.

AND

   1.

   Have already upgraded to Riak 2.0.4.

If you do not use Riak DataTypes (aka CRDTs) you are not affected and may
upgrade to 2.0.4 as normal.
Mitigation Strategy

If you use (or would like to use) Riak DataTypes and you have not upgraded
to 2.0.4, use versions 2.0.0 to 2.0.2.

If you use Riak DataTypes and have upgraded to 2.0.4, you will be unable to
read data written before 2.0.4.  There are two choices:

   1.

   Downgrade to 2.0.2 to access your old data. Data written by 2.0.4 will
   be unreadable until 2.0.5 is available (or patches for 2.0.4).
   2.

   Stay at 2.0.4 and only access newly written data. Data written by
   2.0.0-2.0.2 will be readable once 2.0.5 is available (or patches for 2.0.4).

In both cases it is possible to delete the unreadable data and then
recreate it.
Moving Forward

Basho has prepared a fix [2] for the issue to enable reading of nested data
in the old and new formats and is reviewing and testing it for the 2.0.5
release. Once testing is complete we will provide a set of patch files that
can be added to the lib/basho-patches directory in the event this advisory
is discovered after upgrade. We have also downgraded the version of Riak
available in repositories served by packagecloud.io (apt/yum) back to
2.0.2, in order to prevent unattended upgrades being affected by this issue.

[2] <a  rel="nofollow" href="https://github.com/basho/riak_dt/pull/111/files">https://github.com/basho/riak_dt/pull/111/files</a>

-- 
Seema Jethani
Director of Product Management, Basho &lt;<a  rel="nofollow" href="http://basho.com">http://basho.com</a>&gt;
4083455739 | @seemaj &lt;<a  rel="nofollow" href="http://twitter.com/seemaj">http://twitter.com/seemaj</a>&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg15563.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#15565">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#15565">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg15573.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Basho Product Alert Update re DataTypes Disk Format Incompat...</span> <span class="sender italic">Seema Jethani</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg15573.html">Basho Product Alert Update re DataTypes Disk Format Inc...</a></span> <span class="sender italic">Seema Jethani</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Basho Product Alert Update re DataTypes Disk Format Incompatibility">
<input type="hidden" name="msgid" value="CAJSrNH3ix9Dbd0Knfpit6Wa7rKt6rhiymn7VcL_uhNxRSzj4GA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg15565.html">
<input type="submit" value=" Seema Jethani ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Basho+Product+Alert+Update+re+DataTypes+Disk+Format+Incompatibility%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg15563.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg15573.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAJSrNH3ix9Dbd0Knfpit6Wa7rKt6rhiymn7VcL_uhNxRSzj4GA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
