<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: memory consumption</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd12.html#11885" id="c">
<link rel="index" href="mail12.html#11885" id="i">
<link rel="prev" href="msg11884.html" id="p">
<link rel="next" href="msg11911.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11885.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+memory+consumption%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: memory consumption</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Evan+Vigil%5C-McClanahan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Evan Vigil-McClanahan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130805" rel="nofollow">Mon, 05 Aug 2013 05:46:02 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Before I'd done the research, I too thought that the overheads were a
much lower, near to what the calculator said, but not too far off.</pre><pre>

There are a few things that I plan on addressing this release cycle:
  - 16b per-allocation overhead from using enif_alloc.  This allows us
a lot of flexibility about which allocator to use, but I suspect that
since allocation speed isn't a big bitcask bottleneck, this overhead
simply isn't worth it.
  - 13b per value overhead from naive serialization of the bucket/key
value.  I have a branch that reduced this by 11 bytes.
  - 4b per value overhead from a single bit flag that is stored in an
int. No patch for this thus far.

Additionally, I've found that running with tcmalloc using LD_PRELOAD
reduces the cost for bitcask's many allocations, but a) I've never
done so in production and b) they say that it never releases memory,
which is worrying, although the paging system theoretically should
take care of it fairly easily as long as their page usages isn't
insane.

My original notes looked like this:

1)   ~32 bytes for the OS/malloc + khash overhead @ 50M keys
(amortized, so bigger for fewer keys, smaller for more keys).
2) + 16 bytes of erlang allocator overhead
3) + 22 bytes for the NIF C structure
4) +  8 bytes for the entry pointer stored in the khash
5) + 13 bytes of kv overhead

tcmalloc does what it can for line 1.
My patches do what I can for lines 2, 3, and 5.

4 isn't amenable to anything other than a change in the way the keydir
is stored, which could also potentially help with 1 (fewer
allocations, etc).  That, unfortunately, is not very likely to happen
soon.

So things will get better relatively soon, but there are some
architectural limits that will be harder to address.

On Mon, Aug 5, 2013 at 1:49 AM, Alexander Ilyin &lt;alexan...@rutarget.ru&gt; wrote:
&gt; Evan,
&gt;
&gt; News about per key overhead of 91 bytes are quite frustrating. When we were
&gt; choosing a key value storage per key metadata size was a crucial point for
&gt; us. We have a simple use case but a lot of data (hundreds of millions of
&gt; items) so we were looking for the ways to reduce memory consumption.
&gt; Here and here is stated a value of 40 bytes. 22 bytes in ram calculator
&gt; seemed like a mistake because the following example obviously uses a value
&gt; of 40.
&gt;
&gt; Anyway, thanks for your response.
&gt;
&gt;
&gt; On 4 August 2013 04:39, Evan Vigil-McClanahan &lt;emcclana...@basho.com&gt; wrote:
&gt;&gt;
&gt;&gt; Some responses inline.
&gt;&gt;
&gt;&gt; On Fri, Aug 2, 2013 at 3:11 AM, Alexander Ilyin &lt;alexan...@rutarget.ru&gt;
&gt;&gt; wrote:
&gt;&gt; &gt; Hi,
&gt;&gt; &gt;
&gt;&gt; &gt; I have a few questions about Riak memory usage.
&gt;&gt; &gt; We're using Riak 1.3.1 on a 3 node cluster. According to bitcask
&gt;&gt; &gt; capacity
&gt;&gt; &gt; calculator
&gt;&gt; &gt;
&gt;&gt; &gt; (<a  rel="nofollow" href="http://docs.basho.com/riak/1.3.1/references/appendices/Bitcask-Capacity-Planning/">http://docs.basho.com/riak/1.3.1/references/appendices/Bitcask-Capacity-Planning/</a>)
&gt;&gt; &gt; Riak should use about 30Gb of RAM for out data. Actually, it uses about
&gt;&gt; &gt; 45Gb
&gt;&gt; &gt; and I can't figure out why. I'm looking at %MEM column in top on each
&gt;&gt; &gt; node
&gt;&gt; &gt; for a beam.smp process.
&gt;&gt;
&gt;&gt; I've recently done some research on this and have filed bugs against
&gt;&gt; the calculator, it's a bit wrong and has been that way for a while:
&gt;&gt;
&gt;&gt; <a  rel="nofollow" href="https://github.com/basho/basho_docs/issues/467">https://github.com/basho/basho_docs/issues/467</a>
&gt;&gt;
&gt;&gt; The numbers there look a bit closer to what you're seeing.
&gt;&gt;
&gt;&gt; The good news is that I am looking into reducing memory consumption
&gt;&gt; this development cycle and our next release should see some
&gt;&gt; improvements on that front.  The bad news is that it may be a while.
&gt;&gt; If you want to watch the bitcask repo on github to see when these
&gt;&gt; changes go in, it's usually pretty easy to build a new bitcask and
&gt;&gt; replace the one that you're running.
&gt;&gt;
&gt;&gt; &gt; Disk usage is also about 1,5 times more than I have expected (270Gb
&gt;&gt; &gt; instead
&gt;&gt; &gt; of 180Gb). I rechecked that I have n_val=2 (not 3), it seems alright.
&gt;&gt; &gt; Why
&gt;&gt; &gt; this could happen?
&gt;&gt;
&gt;&gt; There is definitely some overhead on the stored values, especially
&gt;&gt; when you're using bitcask. How big are your values?  Overheads, if I
&gt;&gt; recall correctly, run to a few hundred bytes, but I'll have to ask
&gt;&gt; some people to refresh my memory.
&gt;&gt;
&gt;&gt; &gt; Second question is about performance degradation when Riak uses almost
&gt;&gt; &gt; all
&gt;&gt; &gt; available memory on the node. We see that 95/99 put percentiles twice as
&gt;&gt; &gt; large for nodes which don't have much free RAM. How much free memory I
&gt;&gt; &gt; should have to keep performance high?
&gt;&gt;
&gt;&gt; I don't have a good answer for this; when I was working as a CSE we
&gt;&gt; generally urged people to start adding nodes when their most limited
&gt;&gt; resource (memory, disk, cpu, etc) was 70-80% utilized (as a grossly
&gt;&gt; oversimplified rule of thumb).
&gt;&gt;
&gt;&gt; &gt; And the last question about memory_total metric. riak-admin status
&gt;&gt; &gt; returns
&gt;&gt; &gt; value which is less than actual memory consumption as seen in the top.
&gt;&gt; &gt; According to memory_total description
&gt;&gt; &gt;
&gt;&gt; &gt; (<a  rel="nofollow" href="http://docs.basho.com/riak/1.3.1/references/appendices/Inspecting-a-Node/">http://docs.basho.com/riak/1.3.1/references/appendices/Inspecting-a-Node/</a>)
&gt;&gt; &gt; they should be equal. Why they are not?
&gt;&gt;
&gt;&gt; Top factors in OS/libc overheads that memory_total cannot see.  I'll
&gt;&gt; check out the docs and get them amended if they're wrong.
&gt;
&gt;

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11884.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd12.html#11885">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail12.html#11885">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11911.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11867.html">memory consumption</a></span> <span class="sender italic">Alexander Ilyin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11879.html">Re: memory consumption</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11884.html">Re: memory consumption</a></span> <span class="sender italic">Alexander Ilyin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: memory consumption</span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11911.html">Re: memory consumption</a></span> <span class="sender italic">Alexander Ilyin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11913.html">Re: memory consumption</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11932.html">Re: memory consumption</a></span> <span class="sender italic">Alexander Ilyin</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: memory consumption">
<input type="hidden" name="msgid" value="CAN9Z=zgpZ+4iQzQkhXmAbR-kd1d6TPq+ZOyn89GpoFPdHKfgmQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11885.html">
<input type="submit" value=" Evan Vigil-McClanahan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+memory+consumption%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11884.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11911.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAN9Z=zgpZ+4iQzQkhXmAbR-kd1d6TPq+ZOyn89GpoFPdHKfgmQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
