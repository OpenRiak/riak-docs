<!DOCTYPE html>
<html lang="en">
<head>
<title>RE: riak java pb client does not let go of bad sockets</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07089" id="c">
<link rel="index" href="maillist.html#07089" id="i">
<link rel="prev" href="msg07087.html" id="p">
<link rel="next" href="msg07074.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07089.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+riak+java+pb+client+does+not+let+go+of+bad+sockets%22&amp;o=newest" rel="nofollow"><span itemprop="name">RE: riak java pb client does not let go of bad sockets</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Will+Gage%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Will Gage</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120330" rel="nofollow">Fri, 30 Mar 2012 10:11:16 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Awesome, thanks for the quick turnaround Brian!  We'll test it out and let you 
know how it goes.  </pre><pre>

Cheers,
Will
________________________________________
From: riak-users-boun...@lists.basho.com [riak-users-boun...@lists.basho.com] 
on behalf of Brian Roach [ro...@basho.com]
Sent: Thursday, March 29, 2012 2:42 PM
To: Riak-Users
Subject: Re: riak java pb client does not let go of bad sockets

Thanks (and Sorry!) for reporting this Will.

This was a bug in the underlying Protocol Buffers RiakClient where Socket 
objects were not being closed when IOExceptions were received from their 
streams. This is now fixed in the 1.0.5 release, available today.

Thanks again,
Brian Roach


On Mar 28, 2012, at 12:09 PM, Will Gage wrote:

&gt; Hello,
&gt;
&gt;
&gt; I have run into a production issue that I think stems from either a defect in 
&gt; the com.basho.riak:riak-client:jar:1.0.4 library, or a misunderstanding in my 
&gt; use of it.  I'm actively trying to fix the issue, but I thought I'd put a 
&gt; feeler out to this list to see if others have encountered the issue, or 
&gt; whether there's a clear problem in our use of the library.
&gt;
&gt; Environment:
&gt; ---------------------
&gt; * Java web application running in Tomcat:
&gt; ** JDK: jdk1.6.0_24-jce6
&gt; ** Tomcat: apache-tomcat-7.0.23
&gt; ** Basho Riak Client version: com.basho.riak:riak-client:jar:1.0.4
&gt; * 6 node Riak cluster running Riak 1.0.1
&gt;
&gt; Error sequence:
&gt; -----------------------
&gt; The production issue has happened a few times, and it follows this sequence:
&gt;
&gt; 1. We get a rash of SocketException: Connection Reset errors
&gt;
&gt; java.net.SocketException: Connection reset
&gt;    at java.net.SocketInputStream.read(SocketInputStream.java:168)
&gt;    at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)
&gt;    at java.io.BufferedInputStream.read(BufferedInputStream.java:237)
&gt;    at java.io.DataInputStream.readInt(DataInputStream.java:370)
&gt;    at com.basho.riak.pbc.RiakConnection.receive(RiakConnection.java:92)
&gt;    at com.basho.riak.pbc.RiakClient.processFetchReply(RiakClient.java:278)
&gt;    at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:252)
&gt;    at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:241)
&gt;    at 
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.fetch(PBClientAdapter.java:156)
&gt;    at 
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.fetch(PBClientAdapter.java:139)
&gt;    at com.basho.riak.client.raw.ClusterClient.fetch(ClusterClient.java:107)
&gt;
&gt; 2. Followed 50 milliseconds later by a steady stream of SocketException: 
&gt; Broken pipe messages, until we restart the Tomcat container.
&gt;
&gt; java.net.SocketException: Broken pipe
&gt;    at java.net.SocketOutputStream.socketWrite0(Native Method)
&gt;    at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)
&gt;    at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
&gt;    at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
&gt;    at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)
&gt;    at java.io.DataOutputStream.flush(DataOutputStream.java:106)
&gt;    at com.basho.riak.pbc.RiakConnection.send(RiakConnection.java:82)
&gt;    at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:251)
&gt;    at com.basho.riak.pbc.RiakClient.fetch(RiakClient.java:241)
&gt;    at 
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.fetch(PBClientAdapter.java:156)
&gt;    at 
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.fetch(PBClientAdapter.java:139)
&gt;    at com.basho.riak.client.raw.ClusterClient.fetch(ClusterClient.java:107)
&gt;
&gt; 3. Within our 6-node Riak cluster, almost exactly 1 minute after the initial 
&gt; connection reset errors, one node emits a crash log:
&gt;
&gt; 2012-03-27 14:56:51 =ERROR REPORT====
&gt; ** Generic server &lt;0.289.0&gt; terminating
&gt; ** Last message in was {inet_async,#Port&lt;0.3319&gt;,41462,{ok,#Port&lt;0.73913715&gt;}}
&gt; ** When Server state == {state,riak_kv_pb_listener,#Port&lt;0.3319&gt;,{state,8087}}
&gt; ** Reason for termination ==
&gt; ** 
&gt; {timeout,{'gen_server2',call,[&lt;0.1838.1574&gt;,{set_socket,#Port&lt;0.73913715&gt;}]}}
&gt; 2012-03-27 14:57:08 =CRASH REPORT====
&gt;  crasher:
&gt;    initial call: gen_nb_server:init/1
&gt;    pid: &lt;0.289.0&gt;
&gt;    registered_name: []
&gt;    exception exit: 
&gt; {timeout,{'gen_server2',call,[&lt;0.1838.1574&gt;,{set_socket,#Port&lt;0.73913715&gt;}]}}
&gt;      in function  gen_server:terminate/6
&gt;      in call from proc_lib:init_p_do_apply/3
&gt;    ancestors: [riak_kv_sup,&lt;0.194.0&gt;]
&gt;    messages: [{#Ref&lt;0.0.704.111074&gt;,ok}]
&gt;    links: [&lt;0.200.0&gt;]
&gt;    dictionary: []
&gt;    trap_exit: false
&gt;    status: running
&gt;    heap_size: 377
&gt;    stack_size: 24
&gt;    reductions: 117962
&gt;  neighbours:
&gt; 2012-03-27 14:57:09 =SUPERVISOR REPORT====
&gt;     Supervisor: {local,riak_kv_sup}
&gt;     Context:    child_terminated
&gt;     Reason:     
&gt; {timeout,{'gen_server2',call,[&lt;0.1838.1574&gt;,{set_socket,#Port&lt;0.73913715&gt;}]}}
&gt;     Offender:   
&gt; [{pid,&lt;0.289.0&gt;},{name,riak_kv_pb_listener},{mfargs,{riak_kv_pb_listener,start_link,[]}},{restart_type,permanent},{shutdown,5000},{child_type,worker}]
&gt;
&gt;
&gt; The Riak cluster seems to bounce back to health (all nodes connected and 
&gt; responding) by the time we see the errors and check it, but the clients (the 
&gt; Tomcat application) never recover until we restart them.  It seems pretty 
&gt; clear that a process within the Riak cluster is dying and taking its sockets 
&gt; with it, after which the clients are not recovering.
&gt;
&gt;
&gt; Theory
&gt; ----------
&gt; The working theory is that the client library is never flushing out bad 
&gt; connections.  You can see here that connections are always returned to the 
&gt; pool.  I have not yet seen any evidence that connections are ever tested for 
&gt; health once allocated.
&gt;
&gt; From com.basho.riak.pbc.RiakClient, line 224-237:
&gt;
&gt;       public RiakObject[] fetch(ByteString bucket, ByteString key, int 
&gt; readQuorum)
&gt;                       throws IOException {
&gt;               RpbGetReq req = RPB.RpbGetReq.newBuilder().setBucket(bucket)
&gt;                               .setKey(key).setR(readQuorum).build();
&gt;
&gt;               RiakConnection c = getConnection();
&gt;               try {
&gt;                       c.send(MSG_GetReq, req);
&gt;                       return processFetchReply(c, bucket, key).getObjects();
&gt;               } finally {
&gt;                       release(c);
&gt;               }
&gt;
&gt;       }
&gt;
&gt; And this is how our reference to the client is created, using client-side 
&gt; cluster configs:
&gt;
&gt;            // set up a PBClientConfig per host
&gt;            for(String host : hosts) {
&gt;
&gt;                PBClientConfig pbcConfig = new PBClientConfig.Builder()
&gt;                        .withInitialPoolSize(config.getInitialPoolSize())
&gt;                        .withPort(config.getRiakPort())
&gt;                        .withHost(host.trim())
&gt;                        
&gt; .withConnectionTimeoutMillis(config.getConnectionWaitTimeoutMillis())
&gt;                        
&gt; .withIdleConnectionTTLMillis(config.getIdleConnectionTTLMillis())
&gt;                        .withSocketBufferSizeKb(config.getBufferSizeKb())
&gt;                        .withPoolSize(config.getMaximunPoolSize())
&gt;                        .build();
&gt;
&gt;                clusterConfig.addClient(pbcConfig);
&gt;
&gt;            }
&gt;
&gt;            // Connection pooling is done internally in the PBClusterClient 
&gt; created by the factory
&gt;            RawClient rawClient = 
&gt; PBClusterClientFactory.getInstance().newClient(clusterConfig);
&gt;
&gt;            this.client = rawClient;
&gt;
&gt; Is the expectation within the client library that our own application code 
&gt; would detect bad connections and recreate the pool / client once we've 
&gt; detected them?
&gt;
&gt;
&gt; Thanks,
&gt; Will
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07087.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07089">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07089">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07074.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07071.html">riak java pb client does not let go of bad sockets</a></span> <span class="sender italic">Will Gage</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07087.html">Re: riak java pb client does not let go of bad sockets</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">RE: riak java pb client does not let go of bad socket...</span> <span class="sender italic">Will Gage</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="RE: riak java pb client does not let go of bad sockets">
<input type="hidden" name="msgid" value="9CE1842A3184B64CBA22D3F7495AD18932276EB0@SZHQMSXNODE1A.shopzilla.corp">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07089.html">
<input type="submit" value=" Will Gage ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+riak+java+pb+client+does+not+let+go+of+bad+sockets%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07087.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07074.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">9CE1842A3184B64CBA22D3F7495AD18932276EB0@SZHQMSXNODE1A.shopzilla.corp</li>
</ul>
</div>
</body>
</html>
