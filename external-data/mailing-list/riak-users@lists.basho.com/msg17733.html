<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak CS: avoiding RAM overflow and OOM killer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17733" id="c">
<link rel="index" href="maillist.html#17733" id="i">
<link rel="prev" href="msg17729.html" id="p">
<link rel="next" href="msg17775.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17733.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+CS%5C%3A+avoiding+RAM+overflow+and+OOM+killer%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak CS: avoiding RAM overflow and OOM killer</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Daniel+Miller%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Daniel Miller</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20161105" rel="nofollow">Sat, 05 Nov 2016 07:48:20 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

I have a Riak CS cluster up and running, and am anticipating exponential
growth in the number of key/value pairs over the next few years. From
reading the documentation and experience, I've concluded that the default
configuration of CS (with riak_cs_kv_multi_backend) keeps all keys in RAM.
The OOM killer strikes when Riak uses too much RAM, which is not good for
my sanity or sleep. Because of the amount of growth I am anticipating, it
seems unlikely that I can allocate enough RAM to keep up with the load.
Disk, on the other hand, is less constrained.</pre><pre>

A little background on the data set: I have a sparsely accessed key set. By
that I mean after a key is written, the more time passes with that key not
being accessed, the less likely it is to be accessed any time soon. At any
given time, most keys will be dormant. However, any given key *_could*_ be
accessed at any time, so should be possible to retrieve it.

I am currently running a smaller cluster (with smaller nodes: less RAM,
smaller disks) than I expect to use eventually. I am starting to hit some
growth-related issues that are prompting me to explore more options before
it becomes a dire situation.

My question: Are there ways to tune Riak (CS) to support this scenario
gracefully? That is, are there ways to make Riak not load all keys into
RAM? It looks like leveldb is just what I want, but I'm a little nervous
switching over to only leveldb when the default/recommended config uses the
multi backend.

As a stop-gap measure, I enabled swap (with swappiness = 0), which I
anticipated would kill performance, but was pleasantly surprised to see it
return to effectively no-swap performance levels after a short period of
lower performance. I'm guessing this is not a good long-term solution as my
dataset grows. The problem with using large amounts of swap is that each
time Riak starts it needs to read all keys into RAM. Long term, as our
dataset grows, the amount of time needed to read keys into RAM will cause a
very long restart time (and thus period of unavailability), which could
endanger availability for a prolonged period if multiple nodes go down at
once.

Thanks!
Daniel Miller
Dimagi, Inc.
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17729.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17733">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17733">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17775.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak CS: avoiding RAM overflow and OOM killer</span> <span class="sender italic">Daniel Miller</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17775.html">Re: Riak CS: avoiding RAM overflow and OOM killer</a></span> <span class="sender italic">Daniel Miller</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17776.html">Re: Riak CS: avoiding RAM overflow and OOM kill...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17778.html">Re: Riak CS: avoiding RAM overflow and OOM ...</a></span> <span class="sender italic">Daniel Miller</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17777.html">Re: Riak CS: avoiding RAM overflow and ...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17782.html">Re: Riak CS: avoiding RAM overflow...</a></span> <span class="sender italic">DeadZen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17783.html">Re: Riak CS: avoiding RAM over...</a></span> <span class="sender italic">Alexander Sicular</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg17786.html">Re: Riak CS: avoiding RAM overflow...</a></span> <span class="sender italic">Daniel Miller</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak CS: avoiding RAM overflow and OOM killer">
<input type="hidden" name="msgid" value="CADigEi4rjMiW9qeE5uNFROtnK-+Gr8g+3on1GFYhx7-eGytkPA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17733.html">
<input type="submit" value=" Daniel Miller ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+CS%5C%3A+avoiding+RAM+overflow+and+OOM+killer%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17729.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17775.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CADigEi4rjMiW9qeE5uNFROtnK-+Gr8g+3on1GFYhx7-eGytkPA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
