<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: haproxy issues with protocol buffers on 2.x releases</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd11.html#16273" id="c">
<link rel="index" href="mail10.html#16273" id="i">
<link rel="prev" href="msg16214.html" id="p">
<link rel="next" href="msg16199.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16273.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+haproxy+issues+with+protocol+buffers+on+2.x+releases%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: haproxy issues with protocol buffers on 2.x releases</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150705" rel="nofollow">Sun, 05 Jul 2015 21:42:00 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Ah hah!
Coming back to this problem after a month seems to have jogged my
thoughts. I've
figured it out.</pre><pre>

The Basho guide to haproxy for Riak CS specifies:
    timeout client    5000
    timeout server    5000

In the example configuration. Those are values in milliseconds.
So if the client or server does not send any data over the connection for
5000 milliseconds, haproxy considers it dead, and closes the connection.

On a moderately well loaded production system, you probably have enough
data coming and going to keep those connections alive, but on a testing
instance, the connections will be getting closed down all the time.

My fix is to add these lines:
    timeout tunnel 7d
    timeout client-fin 30s

But I'd appreciate your thoughts too.

-Toby



On Mon, 6 Jul 2015 at 13:13 Toby Corkindale &lt;t...@dryft.net&gt; wrote:

&gt; Hi Matt,
&gt; I've tested against both haproxy 1.4 and haproxy 1.5,  both Riak 2.0.5 and
&gt; 2.1.1, and Riak CS 2.0.1 and Stanchion 2.0.0.
&gt; I've test both KVM and LXC virtualisation.
&gt;
&gt; In all combinations I tested, the problem persists. If Riak CS connects to
&gt; Riak via haproxy, then Riak CS frequently loses the connection and returns
&gt; a failure to the s3 client.
&gt;
&gt; The failures show up very quickly, if you want to try and replicate this.
&gt; I'll upload the configurations for you. They're for a three-node cluster,
&gt; which is obviously too small for production, but should be the minimum to
&gt; demonstrate this bug, right? I'm sure it'd manifest on a four or five node
&gt; cluster too.
&gt;
&gt; I run this command:
&gt;     perl mkfiles.pl; s3cmd -c s3cfg sync *.txt s3://test/
&gt; (mkfiles.pl just creates 100 small unique files by writing a bit of junk
&gt; and an index value to them.)
&gt;
&gt; If Riak-CS is talking to the haproxy port instead of directly to Riak,
&gt; it'll fail partway through the sync. Every time. The number of files it
&gt; gets through varies between 1 and 40ish, I'd say, but I haven't actually
&gt; kept track.
&gt;
&gt; Configuration files and test script at:
&gt; <a  rel="nofollow" href="https://www.dropbox.com/s/cnt9y0fegrb42fb/haproxy-riak-cs-issue.zip?dl=0">https://www.dropbox.com/s/cnt9y0fegrb42fb/haproxy-riak-cs-issue.zip?dl=0</a>
&gt;
&gt; Toby
&gt;
&gt; On Sat, 4 Jul 2015 at 01:30 Matthew Brender &lt;mbren...@basho.com&gt; wrote:
&gt;
&gt;&gt; Hey Toby,
&gt;&gt;
&gt;&gt; Did you find anything further during this testing? I'd love to make sure
&gt;&gt; others on riak-user know how to configure local testing to prevent this
&gt;&gt; situation.
&gt;&gt;
&gt;&gt; Cheers,
&gt;&gt; Matt
&gt;&gt;
&gt;&gt;
&gt;&gt; *Matt Brender | Developer Advocacy Lead*
&gt;&gt; Basho Technologies
&gt;&gt; t: @mjbrender &lt;<a  rel="nofollow" href="https://twitter.com/mjbrender">https://twitter.com/mjbrender</a>&gt;
&gt;&gt; c: +1 617.817.3195
&gt;&gt;
&gt;&gt; On Fri, Jun 5, 2015 at 2:16 AM, Toby Corkindale &lt;t...@dryft.net&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Kota,
&gt;&gt;&gt; Our production nodes are Riak CS 1.5 and Riak 1.4.x -- they're running
&gt;&gt;&gt; haproxy 1.4.x, and it's all been happy for some time now.
&gt;&gt;&gt;
&gt;&gt;&gt; Testing the new nodes, still same haproxy versions, but Riak CS 2.0.1
&gt;&gt;&gt; and Riak 1.0.5.
&gt;&gt;&gt; Very confused as to why the connections are being dropped when going
&gt;&gt;&gt; through haproxy. The problem persists even after restarting CS.
&gt;&gt;&gt; I tried staggering the restarts.. increasing the PB request pool.. etc..
&gt;&gt;&gt;  no change.
&gt;&gt;&gt;
&gt;&gt;&gt; But it works fine if CS connects directly to the localhost riak pb.
&gt;&gt;&gt; (Which isn't a great idea.. big Riak instances sometimes take too long
&gt;&gt;&gt; to start, and CS falls over because it started too fast and couldn't
&gt;&gt;&gt; connect, if you're going to localhost)
&gt;&gt;&gt;
&gt;&gt;&gt; Confusing! I'm wondering if it's because the testing machines are in
&gt;&gt;&gt; virtual machines, compared to production which is real hardware.
&gt;&gt;&gt; But.. normally haproxy still works fine on VMs.
&gt;&gt;&gt;
&gt;&gt;&gt; I'll continue to play around.. Must be something that's botched on the
&gt;&gt;&gt; testing setup... but don't want to replicate that into production!
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Fri, 5 Jun 2015 at 13:59 Kota Uenishi &lt;k...@basho.com&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Toby,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; As PB connection management haven't been changed between CS 1.5 and
&gt;&gt;&gt;&gt; 2.0, I think it should work. What's the version the load balancing
&gt;&gt;&gt;&gt; working stable? It depends of the reason why connection has been cut,
&gt;&gt;&gt;&gt; but I would recommend you restart just the CS node and recreate the
&gt;&gt;&gt;&gt; connection pool.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Thu, Jun 4, 2015 at 2:33 PM, Toby Corkindale &lt;t...@dryft.net&gt; wrote:
&gt;&gt;&gt;&gt; &gt; Hi,
&gt;&gt;&gt;&gt; &gt; I've been happily using haproxy in front of Riak and Riak CS 1.x in
&gt;&gt;&gt;&gt; &gt; production for quite a while.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; I've been trying to bring up a new cluster based on riak/cs 2.0.x
&gt;&gt;&gt;&gt; recently,
&gt;&gt;&gt;&gt; &gt; as you've probably noticed from the flurry of emails to this list :)
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; I'm discovering that if I have haproxy sitting between riak-cs and
&gt;&gt;&gt;&gt; riak,
&gt;&gt;&gt;&gt; &gt; then I get a lot of errors about disconnections. Initially I thought
&gt;&gt;&gt;&gt; this
&gt;&gt;&gt;&gt; &gt; must be related to pb backlogs or pool sizes or file handle limits --
&gt;&gt;&gt;&gt; but
&gt;&gt;&gt;&gt; &gt; I've played with all those things to no avail.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; I *have* noticed that if I get riak-cs to connect directly to a riak
&gt;&gt;&gt;&gt; &gt; (bypassing haproxy) then everything is fine, including with the
&gt;&gt;&gt;&gt; original
&gt;&gt;&gt;&gt; &gt; default request pool and backlog sizes.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; I am essentially using the recommended haproxy.cfg, which has worked
&gt;&gt;&gt;&gt; fine in
&gt;&gt;&gt;&gt; &gt; production elsewhere.
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; Any suggestions?
&gt;&gt;&gt;&gt; &gt; Error message sample follows:
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt;&gt;&gt;&gt; &gt; &lt;0.283.0&gt;@riak_cs_riak_client:get_user_with_pbc:293 Fetching user re
&gt;&gt;&gt;&gt; &gt; cord with strong option failed: disconnected
&gt;&gt;&gt;&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt;&gt;&gt;&gt; &gt; &lt;0.2095.0&gt;@riak_cs_pbc:check_connection_status:97 Connection status
&gt;&gt;&gt;&gt; &gt; of &lt;0.287.0&gt; at maybe_create_user: {false,[]}
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16214.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd11.html#16273">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail10.html#16273">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16199.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16197.html">haproxy issues with protocol buffers on 2.x releases</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16211.html">Re: haproxy issues with protocol buffers on 2.x relea...</a></span> <span class="sender italic">Kota Uenishi</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16214.html">Re: haproxy issues with protocol buffers on 2.x r...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: haproxy issues with protocol buffers on 2...</span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: haproxy issues with protocol buffers on 2.x releases">
<input type="hidden" name="msgid" value="CABEgq97Q+J31ptUASY54HW4zsRF=J5F6TQ7o3NgDLhmneF093w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16273.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+haproxy+issues+with+protocol+buffers+on+2.x+releases%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16214.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16199.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABEgq97Q+J31ptUASY54HW4zsRF=J5F6TQ7o3NgDLhmneF093w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
