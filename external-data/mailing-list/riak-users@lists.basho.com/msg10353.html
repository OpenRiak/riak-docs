<!DOCTYPE html>
<html lang="en">
<head>
<title>Delete keys still in Riak db</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#10353" id="c">
<link rel="index" href="mail3.html#10353" id="i">
<link rel="prev" href="msg10351.html" id="p">
<link rel="next" href="msg10355.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10353.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Delete+keys+still+in+Riak+db%22&amp;o=newest" rel="nofollow"><span itemprop="name">Delete keys still in Riak db</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Daniel+Iwan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Daniel Iwan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130307" rel="nofollow">Thu, 07 Mar 2013 12:12:32 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>In our tests we are adding 3000 keys into 3-node Riak db right after nodes
have joined.
For each key one node reads it and modifies it and another node does the
same but also deletes the key when it sees other change (key is no longer
needed). After all keys are processed our test framework checks if all keys
have been processed and deleted (bucket listing)</pre><pre>

Now, since deletion is not instant in Riak I believe here is 3 second
delay, we are  doing that check in a loop listing and counting number of
keys in a bucket to check the progress. So far we've seen number of keys
going down, eventually reaching zero. Sometimes the number of keys remained
greater than zero, but after attempt to get a value we got null (Java
client) which indicates key has been deleted.
It's not perfect but it worked so far.

When we changed to ring size 512 things got bit hairy.
Our test fails and we have 24, 37 or 44  keys hanging around never going
down to zero, but rather going up and down between those numbers.

Test fails eventually. After that when I checked riak-admin transfer I
could see 96 partitions to be transfer on every node. BTW Active Transfer
section was showing nothing (I'm pretty sure there should be MB/s now)
In the end partitions pending for transfer hit zero few minuter after test
failed but that did not change anything.
Listing keys in the bucket via http client showed between 24-44 keys.
Manual reading via http client shows keys does not exist, and it looks like
read-repair removes it, but somehow number of keys cannot reach 0

When those keys will be removed? Do I need to get every key to trigger
read-repair?
Any suggestions what to change to improve that behaviour?

Bucket has allow_multi set to true, which I believe is necessary for that
kind of usage.
Riak db is in version 1.2.1 and backend LevelDB

Regards
Daniel
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10351.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#10353">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail3.html#10353">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10355.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Delete keys still in Riak db</span> <span class="sender italic">Daniel Iwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10355.html">Re: Delete keys still in Riak db</a></span> <span class="sender italic">John Daily</span></li>
<li class="icons-email"><span class="subject"><a href="msg10361.html">Re: Delete keys still in Riak db</a></span> <span class="sender italic">Daniel Iwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10362.html">Re: Delete keys still in Riak db</a></span> <span class="sender italic">Jeremy Raymond</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10373.html">Re: Delete keys still in Riak db</a></span> <span class="sender italic">Daniel Iwan</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Delete keys still in Riak db">
<input type="hidden" name="msgid" value="CANOWVA3k7jHBQbNjZYTvvCbzR4KMcj9JcVvPqivgh1y2Qzc9+Q@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10353.html">
<input type="submit" value=" Daniel Iwan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Delete+keys+still+in+Riak+db%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10351.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10355.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CANOWVA3k7jHBQbNjZYTvvCbzR4KMcj9JcVvPqivgh1y2Qzc9+Q@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
