<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak CS 1.3 S3 access does not seem to mark s3 deleted file as	truly deleted</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#11146" id="c">
<link rel="index" href="maillist.html#11146" id="i">
<link rel="prev" href="msg11143.html" id="p">
<link rel="next" href="msg11147.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11146.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+CS+1.3+S3+access+does+not+seem+to+mark+s3+deleted+file+as%09truly+deleted%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak CS 1.3 S3 access does not seem to mark s3 deleted file as	truly deleted</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kelly+McLaughlin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kelly McLaughlin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130521" rel="nofollow">Tue, 21 May 2013 16:28:23 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Idan,

Bitcask can sometimes be slow to reclaim space after deleting objects from
Riak CS. Are the settings you included the settings that have been in place
during all of your uploads and deletions? I am surprised that just a few
tens of uploads of 32 MB objects used up 15 GB of space. Can you be more
specific on a count of uploads? Also do you have any error output in the
riak or riak cs log files that may be related? Finally, which packages are
you using for your testing?</pre><pre>

Kelly


On Tue, May 21, 2013 at 2:18 PM, Idan Shinberg &lt;idan.shinb...@idomoo.com&gt;wrote:

&gt; Thus , I fear Riak never treats their data as &quot;dead-bytes&quot; and they never
&gt; get merged
&gt;
&gt; I created 2 buckets using s3cmd and made several tens of uploads  of 32mb
&gt; sized files , deleting them right afterwards ( with proper s3cmd commands ,
&gt; of course) .
&gt;
&gt; I ended up with no buckets and no keys in my riak s3 database ,
&gt; however , directory /var/lib/riak/bitcask/ 64 partitions now occupy 15GB
&gt; worth of space
&gt;
&gt; several riak restarts did not trigger any merges , and my merge settings
&gt; are set to impose very though merge triggering criterias , So I'm guessing
&gt; the only reason the data is not being cleared is the fact that it's still
&gt; in use ...
&gt;
&gt; Relevant riak-cs config :
&gt;
&gt; *              %% == Garbage Collection ==*
&gt; *
&gt; *
&gt; *              %% The number of seconds to retain the block*
&gt; *              %% for an object after it has been deleted.*
&gt; *              %% This leeway time is set to give the delete*
&gt; *              %% indication time to propogate to all replicas.*
&gt; *              %% 86400 is 24-hours.*
&gt; *              {leeway_seconds, 30},*
&gt; *
&gt; *
&gt; *              %% How often the garbage collection daemon*
&gt; *              %% waits in-between gc batches.*
&gt; *              %% 900 is 15-minutes.*
&gt; *              {gc_interval, 60},*
&gt; *
&gt; *
&gt; *              %% How long a move to the garbage*
&gt; *              %% collection to do list can remain*
&gt; *              %% failed, before we retry it.*
&gt; *              %% 21600 is 6-hours.*
&gt; *              {gc_retry_interval,300},*
&gt;
&gt;
&gt;
&gt; Relevant Riak Config
&gt;
&gt; *{riak_kv, [*
&gt; *            %% Storage_backend specifies the Erlang module defining the
&gt; storage*
&gt; *            %% mechanism that will be used on this node.*
&gt; *                {add_paths,
&gt; [&quot;/usr/lib64/riak-cs/lib/riak_cs-1.3.1/ebin&quot;]},*
&gt; *                {storage_backend, riak_cs_kv_multi_backend},*
&gt; *                {multi_backend_prefix_list, [{&lt;&lt;&quot;0b:&quot;&gt;&gt;, be_blocks}]},*
&gt; *                {multi_backend_default, be_default},*
&gt; *                {multi_backend, [*
&gt; *                    {be_default, riak_kv_eleveldb_backend, [*
&gt; *                        {max_open_files, 50},*
&gt; *                        {data_root, &quot;/var/lib/riak/leveldb&quot;}*
&gt; *                    ]},*
&gt; *                    {be_blocks, riak_kv_bitcask_backend, [*
&gt; *
&gt; *
&gt; *                        {max_file_size, 16#4000000}, %% 64MB*
&gt; *
&gt; *
&gt; *                        %% Trigger a merge if any of the following are
&gt; true:*
&gt; *                        {frag_merge_trigger, 10}, %% fragmentation &gt;= 10%
&gt; *
&gt; *                        {dead_bytes_merge_trigger, 33554432}, %% dead
&gt; bytes &gt; 32 MB*
&gt; *
&gt; *
&gt; *                        %% Conditions that determine if a file will be
&gt; examined during a merge:*
&gt; *                        {frag_threshold, 5}, %% fragmentation &gt;= 5%*
&gt; *                        {dead_bytes_threshold, 8388608}, %% dead bytes &gt;
&gt; 8 MB*
&gt; *                        {small_file_threshold, 16#80000000}, %% file is
&gt; &lt; 2GB*
&gt; *
&gt; *
&gt; *                        {data_root, &quot;/var/lib/riak/bitcask&quot;}*
&gt; *                    ]}*
&gt; *                ]},*
&gt;
&gt; ...
&gt; ...
&gt; ...
&gt;
&gt; * {bitcask, [*
&gt; *             %% Configure how Bitcask writes data to disk.*
&gt; *             %%   erlang: Erlang's built-in file API*
&gt; *             %%      nif: Direct calls to the POSIX C API*
&gt; *             %%*
&gt; *             %% The NIF mode provides higher throughput for certain*
&gt; *             %% workloads, but has the potential to negatively impact*
&gt; *             %% the Erlang VM, leading to higher worst-case latencies*
&gt; *             %% and possible throughput collapse.*
&gt; *             {io_mode, erlang},*
&gt; *
&gt; *
&gt; *             {max_file_size, 16#4000000}, %% 64MB*
&gt; *             {merge_window, always}, %% Span of hours during which merge
&gt; is acceptable.*
&gt; *
&gt; *
&gt; *             %% Trigger a merge if any of the following are true:*
&gt; *             {frag_merge_trigger, 10}, %% fragmentation &gt;= 10%*
&gt; *             {dead_bytes_merge_trigger, 33554432}, %% dead bytes &gt; 32 MB*
&gt; *
&gt; *
&gt; *             %% Conditions that determine if a file will be examined
&gt; during a merge:*
&gt; *             {frag_threshold, 5}, %% fragmentation &gt;= 5%*
&gt; *             {dead_bytes_threshold, 8388608}, %% dead bytes &gt; 8 MB*
&gt; *             {small_file_threshold, 16#80000000}, %% file is &lt; 2GB*
&gt; *
&gt; *
&gt; *             {data_root, &quot;/var/lib/riak/bitcask&quot;}*
&gt; *
&gt; *
&gt; *           ]},*
&gt;
&gt; I do see merges taking place in riak's console.log , they're just not
&gt; making that much of a difference ...
&gt;
&gt; Any idea what I might be missing here ?
&gt;
&gt; Thanks
&gt;
&gt; Idan Shinberg
&gt; idomoo
&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11143.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#11146">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#11146">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11147.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11143.html">Riak CS 1.3 S3 access does not seem to mark s3 deleted fi...</a></span> <span class="sender italic">Idan Shinberg</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak CS 1.3 S3 access does not seem to mark s3 d...</span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11147.html">Re: Riak CS 1.3 S3 access does not seem to mark ...</a></span> <span class="sender italic">Idan Shinberg</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11161.html">Re: Riak CS 1.3 S3 access does not seem to m...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11192.html">Re: Riak CS 1.3 S3 access does not seem ...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg11177.html">Re: Riak CS 1.3 S3 access does not seem to mark s3 d...</a></span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak CS 1.3 S3 access does not seem to mark s3 deleted file as	truly deleted">
<input type="hidden" name="msgid" value="CAK3SJOi4fkqdpdOqhPUBsXbkZg7Kz=5HzOx_HD4CT5GaWfJevg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11146.html">
<input type="submit" value=" Kelly McLaughlin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+CS+1.3+S3+access+does+not+seem+to+mark+s3+deleted+file+as%09truly+deleted%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11143.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11147.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAK3SJOi4fkqdpdOqhPUBsXbkZg7Kz=5HzOx_HD4CT5GaWfJevg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
