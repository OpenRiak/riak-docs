<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak performance issue with many connected objects (11 million +)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08422" id="c">
<link rel="index" href="maillist.html#08422" id="i">
<link rel="prev" href="msg08414.html" id="p">
<link rel="next" href="msg08424.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08422.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+performance+issue+with+many+connected+objects+%5C%2811+million+%5C%2B%5C%29%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak performance issue with many connected objects (11 million +)</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Lei+Gu%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Lei Gu</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120831" rel="nofollow">Fri, 31 Aug 2012 08:54:36 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I started performance testing Riak by loading 11 million connected objects in 
Riak. Loading has not been an issue, although it did take a long time.
Now when I tried to access an object, Riak never returns and was using 100% of 
CPU and 74% of memory.</pre><pre>

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 8952 riak      20   0 23.4g  11g 1708 S 100.6 74.1   1520:49 beam.smp

This raises major concern on our side. I am using LevelDB for secondary index 
support and I haven't turn on free text search yet. I am running Centos6, with 
16 G memory and Intel i7 8 core.
Any help is highly appreciated.
Thanks.
-- Lei


Riak status:
[root@lgu-linux performance]# cat riak-status.txt
Attempting to restart script through sudo -u riak
1-minute stats for 'riak@127.0.0.1&lt;mailto:'riak@127.0.0.1&gt;'
-------------------------------------------
vnode gets : 13728
vnode_puts : 9153
vnode_index_reads : 0
vnode_index_writes : 9153
vnode_index_writes_postings : 4575
vnode_index_deletes : 234
vnode_index_deletes_postings : 0
read_repairs : 0
vnode_gets_total : 17412882
vnode_puts_total : 11608449
vnode_index_reads_total : 0
vnode_index_writes_total : 11608449
vnode_index_writes_postings_total : 5798670
vnode_index_deletes_total : 234
vnode_index_deletes_postings_total : 402
node_gets : 0
node_gets_total : 5804294
node_get_fsm_time_mean : 0
node_get_fsm_time_median : 0
node_get_fsm_time_95 : 0
node_get_fsm_time_99 : 0
node_get_fsm_time_100 : 0
node_puts : 0
node_puts_total : 3869483
node_put_fsm_time_mean : 0
node_put_fsm_time_median : 0
node_put_fsm_time_95 : 0
node_put_fsm_time_99 : 0
node_put_fsm_time_100 : 0
node_get_fsm_siblings_mean : 0
node_get_fsm_siblings_median : 0
node_get_fsm_siblings_95 : 0
node_get_fsm_siblings_99 : 0
node_get_fsm_siblings_100 : 0
node_get_fsm_objsize_mean : 0
node_get_fsm_objsize_median : 0
node_get_fsm_objsize_95 : 0
node_get_fsm_objsize_99 : 0
node_get_fsm_objsize_100 : 0
read_repairs_total : 0
coord_redirs_total : 0
precommit_fail : 0
postcommit_fail : 0
cpu_nprocs : 655
cpu_avg1 : 8
cpu_avg5 : 3
cpu_avg15 : 5
mem_total : 16699068416
mem_allocated : 5336322048
disk : [{&quot;/&quot;,51606140,18},
        {&quot;/dev/shm&quot;,8153840,1},
        {&quot;/boot&quot;,495844,9},
        {&quot;/home&quot;,891064276,1}]
nodename : 'riak@127.0.0.1&lt;mailto:'riak@127.0.0.1&gt;'
connected_nodes : []
sys_driver_version : &lt;&lt;&quot;1.5&quot;&gt;&gt;
sys_global_heaps_size : 0
sys_heap_type : private
sys_logical_processors : 8
sys_otp_release : &lt;&lt;&quot;R14B04&quot;&gt;&gt;
sys_process_count : 1559
sys_smp_support : true
sys_system_version : &lt;&lt;&quot;Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:8:8] 
[rq:8] [async-threads:64] [hipe] [kernel-poll:true]&quot;&gt;&gt;
sys_system_architecture : &lt;&lt;&quot;x86_64-unknown-linux-gnu&quot;&gt;&gt;
sys_threads_enabled : true
sys_thread_pool_size : 64
sys_wordsize : 8
ring_members : ['riak@127.0.0.1&lt;mailto:'riak@127.0.0.1&gt;']
ring_num_partitions : 64
ring_ownership : &lt;&lt;&quot;[{'riak@127.0.0.1&lt;mailto:'riak@127.0.0.1&gt;',64}]&quot;&gt;&gt;
ring_creation_size : 64
storage_backend : riak_kv_eleveldb_backend
pbc_connects_total : 10
pbc_connects : 1
pbc_active : 0
ssl_version : &lt;&lt;&quot;4.1.6&quot;&gt;&gt;
public_key_version : &lt;&lt;&quot;0.13&quot;&gt;&gt;
runtime_tools_version : &lt;&lt;&quot;1.8.6&quot;&gt;&gt;
basho_stats_version : &lt;&lt;&quot;1.0.2&quot;&gt;&gt;
riak_search_version : &lt;&lt;&quot;1.1.2&quot;&gt;&gt;
riak_kv_version : &lt;&lt;&quot;1.1.4&quot;&gt;&gt;
bitcask_version : &lt;&lt;&quot;1.5.1&quot;&gt;&gt;
luke_version : &lt;&lt;&quot;0.2.5&quot;&gt;&gt;
erlang_js_version : &lt;&lt;&quot;1.0.2&quot;&gt;&gt;
mochiweb_version : &lt;&lt;&quot;1.5.1&quot;&gt;&gt;
inets_version : &lt;&lt;&quot;5.7.1&quot;&gt;&gt;
riak_pipe_version : &lt;&lt;&quot;1.1.2&quot;&gt;&gt;
merge_index_version : &lt;&lt;&quot;1.1.0&quot;&gt;&gt;
cluster_info_version : &lt;&lt;&quot;1.2.1&quot;&gt;&gt;
basho_metrics_version : &lt;&lt;&quot;1.0.0&quot;&gt;&gt;
riak_control_version : &lt;&lt;&quot;0.1.0&quot;&gt;&gt;
riak_core_version : &lt;&lt;&quot;1.1.2&quot;&gt;&gt;
lager_version : &lt;&lt;&quot;1.0.0&quot;&gt;&gt;
riak_sysmon_version : &lt;&lt;&quot;1.1.2&quot;&gt;&gt;
webmachine_version : &lt;&lt;&quot;1.9.1&quot;&gt;&gt;
crypto_version : &lt;&lt;&quot;2.0.4&quot;&gt;&gt;
os_mon_version : &lt;&lt;&quot;2.2.7&quot;&gt;&gt;
sasl_version : &lt;&lt;&quot;2.1.10&quot;&gt;&gt;
stdlib_version : &lt;&lt;&quot;1.17.5&quot;&gt;&gt;
kernel_version : &lt;&lt;&quot;2.14.5&quot;&gt;&gt;
executing_mappers : 0
memory_total : 29539192
memory_processes : 9988968
memory_processes_used : 9958144
memory_system : 19550224
memory_atom : 1050169
memory_atom_used : 1036476
memory_binary : 421104
memory_code : 9330790
memory_ets : 4598912


Riak config file:

%% -*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ft=erlang ts=4 sw=4 et
[
 %% Riak Core config
 {riak_core, [
              %% Default location of ringstate
              {ring_state_dir, &quot;/var/lib/riak/ring&quot;},

              %% http is a list of IP addresses and TCP ports that the Riak
              %% HTTP interface will bind.
              {http, [ {&quot;0.0.0.0&quot;, 8098 } ]},

              %% https is a list of IP addresses and TCP ports that the Riak
              %% HTTPS interface will bind.
              %{https, [{ &quot;127.0.0.1&quot;, 8098 }]},

              %% Default cert and key locations for https can be overridden
              %% with the ssl config variable, for example:
              %{ssl, [
              %       {certfile, &quot;/etc/riak/cert.pem&quot;},
              %       {keyfile, &quot;/etc/riak/key.pem&quot;}
              %      ]},

              %% riak_handoff_port is the TCP port that Riak uses for
              %% intra-cluster data handoff.
              {handoff_port, 8099 },

              %% To encrypt riak_core intra-cluster data handoff traffic,
              %% uncomment the following line and edit its path to an
              %% appropriate certfile and keyfile.  (This example uses a
              %% single file with both items concatenated together.)
              %{handoff_ssl_options, [{certfile, &quot;/tmp/erlserver.pem&quot;}]},

              %% Disable legacy vnode routing for 1.1.x and above clusters
              %% (use vnode proxies).  Only set true on mixed clusters.
              {legacy_vnode_routing, false},

              %% Platform-specific installation paths (substituted by rebar)
              {platform_bin_dir, &quot;/usr/sbin&quot;},
              {platform_data_dir, &quot;/var/lib/riak&quot;},
              {platform_etc_dir, &quot;/etc/riak&quot;},
              {platform_lib_dir, &quot;/usr/lib64/riak&quot;},
              {platform_log_dir, &quot;/var/log/riak&quot;}
             ]},

 %% Riak KV config
 {riak_kv, [
            %% Storage_backend specifies the Erlang module defining the storage
            %% mechanism that will be used on this node.
            {storage_backend, riak_kv_eleveldb_backend},

            %% pb_ip is the IP address that the Riak Protocol Buffers interface
            %% will bind to.  If this is undefined, the interface will not run.
            {pb_ip,   &quot;0.0.0.0&quot; },

            %% pb_port is the TCP port that the Riak Protocol Buffers interface
            %% will bind to
            {pb_port, 8087 },

            %% pb_backlog is the maximum length to which the queue of pending
            %% connections may grow. If set, it must be an integer &gt;= 0.
            %% By default the value is 5. If you anticipate a huge number of
            %% connections being initialised *simultaneously*, set this number
            %% higher.
            %% {pb_backlog, 64},

            %% raw_name is the first part of all URLS used by the Riak raw HTTP
            %% interface.  See riak_web.erl and raw_http_resource.erl for
            %% details.
            %{raw_name, &quot;riak&quot;},

            %% mapred_name is URL used to submit map/reduce requests to Riak.
            {mapred_name, &quot;mapred&quot;},

            %% mapred_system indicates which version of the MapReduce
            %% system should be used: 'pipe' means riak_pipe will
            %% power MapReduce queries, while 'legacy' means that luke
            %% will be used
            {mapred_system, pipe},

            %% mapred_2i_pipe indicates whether secondary-index
            %% MapReduce inputs are queued in parallel via their own
            %% pipe ('true'), or serially via a helper process
            %% ('false' or undefined).  Set to 'false' or leave
            %% undefined during a rolling upgrade from 1.0.
            {mapred_2i_pipe, true},

            %% directory used to store a transient queue for pending
            %% map tasks
            %% Only valid when mapred_system == legacy
            %% {mapred_queue_dir, &quot;/var/lib/riak/mr_queue&quot; },

            %% Each of the following entries control how many Javascript
            %% virtual machines are available for executing map, reduce,
            %% pre- and post-commit hook functions.
            {map_js_vm_count, 8 },
            {reduce_js_vm_count, 6 },
            {hook_js_vm_count, 2 },

            %% Number of items the mapper will fetch in one request.
            %% Larger values can impact read/write performance for
            %% non-MapReduce requests.
            %% Only valid when mapred_system == legacy
            %% {mapper_batch_size, 5},

            %% js_max_vm_mem is the maximum amount of memory, in megabytes,
            %% allocated to the Javascript VMs. If unset, the default is
            %% 8MB.
            {js_max_vm_mem, 8},

            %% js_thread_stack is the maximum amount of thread stack, in 
megabyes,
            %% allocate to the Javascript VMs. If unset, the default is 16MB.
            %% NOTE: This is not the same as the C thread stack.
            {js_thread_stack, 16},

            %% Number of objects held in the MapReduce cache. These will be
            %% ejected when the cache runs out of room or the bucket/key
            %% pair for that entry changes
            %% Only valid when mapred_system == legacy
            %% {map_cache_size, 10000},

            %% js_source_dir should point to a directory containing Javascript
            %% source files which will be loaded by Riak when it initializes
            %% Javascript VMs.
            %{js_source_dir, &quot;/tmp/js_source&quot;},

            %% http_url_encoding determines how Riak treats URL encoded
            %% buckets, keys, and links over the REST API. When set to 'on'
            %% Riak always decodes encoded values sent as URLs and Headers.
            %% Otherwise, Riak defaults to compatibility mode where links
            %% are decoded, but buckets and keys are not. The compatibility
            %% mode will be removed in a future release.
            {http_url_encoding, on},

            %% riak_stat enables the use of the &quot;riak-admin status&quot; command to
            %% retrieve information the Riak node for performance and debugging 
needs
            {riak_kv_stat, true},

            %% When using riak_kv_stat, use the legacy routines for tracking
            {legacy_stats, true},

            %% Switch to vnode-based vclocks rather than client ids.  This
            %% significantly reduces the number of vclock entries.
            %% Only set true if *all* nodes in the cluster are upgraded to 1.0
            {vnode_vclocks, true},

            %% This option enables compatability of bucket and key listing
            %% with 0.14 and earlier versions. Once a rolling upgrade to
            %% a version &gt; 0.14 is completed for a cluster, this should be
            %% set to false for improved performance for bucket and key
            %% listing operations.
            {legacy_keylisting, false},

            %% This option toggles compatibility of keylisting with 1.0
            %% and earlier versions.  Once a rolling upgrade to a version
            %% &gt; 1.0 is completed for a cluster, this should be set to
            %% true for better control of memory usage during key listing
            %% operations
            {listkeys_backpressure, true}
           ]},

 %% Riak Search Config
 {riak_search, [
                %% To enable Search functionality set this 'true'.
                {enabled, true}
               ]},

 %% Merge Index Config
 {merge_index, [
                %% The root dir to store search merge_index data
                {data_root, &quot;/var/lib/riak/merge_index&quot;},

                %% The root dir to store secondary index merge_index data
                {data_root_2i, &quot;/var/lib/riak/merge_index_2i&quot;},

                %% Size, in bytes, of the in-memory buffer.  When this
                %% threshold has been reached the data is transformed
                %% into a segment file which resides on disk.
                {buffer_rollover_size, 1048576},

                %% Overtime the segment files need to be compacted.
                %% This is the maximum number of segments that will be
                %% compacted at once.  A lower value will lead to
                %% quicker but more frequent compactions.
                {max_compact_segments, 20}
               ]},

 %% Bitcask Config
 {bitcask, [
             {data_root, &quot;/var/lib/riak/bitcask&quot;}
           ]},

 %% eLevelDB Config
 {eleveldb, [
             {data_root, &quot;/var/lib/riak/leveldb&quot;}
            ]},

 %% Lager Config
 {lager, [
            %% What handlers to install with what arguments
            %% The defaults for the logfiles are to rotate the files when
            %% they reach 10Mb or at midnight, whichever comes first, and keep
            %% the last 5 rotations. See the lager README for a description of
            %% the time rotation format:
            %% <a  rel="nofollow" href="https://github.com/basho/lager/blob/master/README.org">https://github.com/basho/lager/blob/master/README.org</a>
            %%
            %% If you wish to disable rotation, you can either set the size to 0
            %% and the rotation time to &quot;&quot;, or instead specify a 2-tuple that 
only
            %% consists of {Logfile, Level}.
            {handlers, [
                {lager_console_backend, info},
                {lager_file_backend, [
                    {&quot;/var/log/riak/error.log&quot;, error, 10485760, &quot;$D0&quot;, 5},
                    {&quot;/var/log/riak/console.log&quot;, info, 10485760, &quot;$D0&quot;, 5}
                ]}
            ]},

            %% Whether to write a crash log, and where.
            %% Commented/omitted/undefined means no crash logger.
            {crash_log, &quot;/var/log/riak/crash.log&quot;},

            %% Maximum size in bytes of events in the crash log - defaults to 
65536
            {crash_log_msg_size, 65536},

            %% Maximum size of the crash log in bytes, before its rotated, set
            %% to 0 to disable rotation - default is 0
            {crash_log_size, 10485760},

            %% What time to rotate the crash log - default is no time
            %% rotation. See the lager README for a description of this format:
            %% <a  rel="nofollow" href="https://github.com/basho/lager/blob/master/README.org">https://github.com/basho/lager/blob/master/README.org</a>
            {crash_log_date, &quot;$D0&quot;},

            %% Number of rotated crash logs to keep, 0 means keep only the
            %% current one - default is 0
            {crash_log_count, 5},

            %% Whether to redirect error_logger messages into lager - defaults 
to true
            {error_logger_redirect, true}
        ]},

 %% riak_sysmon config
 {riak_sysmon, [
         %% To disable forwarding events of a particular type, use a
         %% limit of 0.
         {process_limit, 30},
         {port_limit, 2},

         %% Finding reasonable limits for a given workload is a matter
         %% of experimentation.
         {gc_ms_limit, 100},
         {heap_word_limit, 40111000},

         %% Configure the following items to 'false' to disable logging
         %% of that event type.
         {busy_port, true},
         {busy_dist_port, true}
        ]},

 %% SASL config
 {sasl, [
         {sasl_error_logger, false}
        ]},

 %% riak_control config
 {riak_control, [
                %% Set to false to disable the admin panel.
                {enabled, false},

                %% Authentication style used for access to the admin
                %% panel. Valid styles are 'userlist' &lt;TODO&gt;.
                {auth, userlist},

                %% If auth is set to 'userlist' then this is the
                %% list of usernames and passwords for access to the
                %% admin panel.
                {userlist, [{&quot;user&quot;, &quot;pass&quot;}
                           ]},

                %% The admin panel is broken up into multiple
                %% components, each of which is enabled or disabled
                %% by one of these settings.
                {admin, true}
                ]}
].


________________________________
The information contained in this electronic mail transmission is intended only 
for the use of the individual or entity named in this transmission. If you are 
not the intended recipient of this transmission, you are hereby notified that 
any disclosure, copying or distribution of the contents of this transmission is 
strictly prohibited and that you should delete the contents of this 
transmission from your system immediately. Any comments or statements contained 
in this transmission do not necessarily reflect the views or position of GSI 
Commerce, Inc. or its subsidiaries and/or affiliates.

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08414.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08422">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08422">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08424.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak performance issue with many connected objects (11 millio...</span> <span class="sender italic">Lei Gu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08424.html">Re: Riak performance issue with many connected objects (...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg08426.html">Re: Riak performance issue with many connected objects (...</a></span> <span class="sender italic">Lei Gu</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak performance issue with many connected objects (11 million +)">
<input type="hidden" name="msgid" value="CC665674.EA2%legu@e-dialog.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08422.html">
<input type="submit" value=" Lei Gu ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+performance+issue+with+many+connected+objects+%5C%2811+million+%5C%2B%5C%29%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08414.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08424.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CC665674.EA2%legu@e-dialog.com</li>
</ul>
</div>
</body>
</html>
