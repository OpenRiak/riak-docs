<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Java Riak client can't handle a Riak node failure?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#16618" id="c">
<link rel="index" href="mail3.html#16618" id="i">
<link rel="prev" href="msg16616.html" id="p">
<link rel="next" href="msg16626.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16618.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Java+Riak+client+can%27t+handle+a+Riak+node+failure%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Java Riak client can't handle a Riak node failure?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Dmitri+Zagidulin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Dmitri Zagidulin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151007" rel="nofollow">Wed, 07 Oct 2015 06:35:34 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Yeah, definitely find out what the sysadmin's experience was, with the load
balancer. It could have just been a wrong configuration or something.</pre><pre>

And yes, that's the documentation page I recommend -
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/configs/load-balancing-proxy/">http://docs.basho.com/riak/latest/ops/advanced/configs/load-balancing-proxy/</a>
Just set up HAProxy, and point your Java clients to its IP.

The drawbacks to load-balancing on the java client side (yes, the cluster
object) instead of a standalone load balancer like HAProxy, are the
following:

1) Adding node means code changes (or at very least, config file changes)
rolled out to all your clients. Which turns out to be a pretty serious
hassle. Instead, HAProxy allows you to add or remove nodes without changing
any java code or config files.

2) Performance. We've ran many tests to compare performance, and
client-side load balancing results in significantly lower throughput than
you'd have using haproxy (or nginx). (Specifically, you actually want to
use the 'leastconn' load balancing algorithm with HAProxy, instead of round
robin).

3) The health check on the client side (so that the java load balancer can
tell when a remote node is down) is much less intelligent than a dedicated
load balancer would provide. With something like HAProxy, you should be
able to take down nodes with no ill effects for the client code.

Now, if you load balance on the client side and you take a node down, it's
not supposed to stop working completely. (I'm not sure why it's failing for
you, we can investigate, but it'll be easier to just use a load balancer).
It should throw an error or two, but then start working again (on the
retry).

Dmitri

On Wed, Oct 7, 2015 at 2:45 PM, Vanessa Williams &lt;
vanessa.willi...@thoughtwire.ca&gt; wrote:

&gt; Hi Dmitri, thanks for the quick reply.
&gt;
&gt; It was actually our sysadmin who tried the load balancer approach and had
&gt; no success, late last evening. However I haven't discussed the gory details
&gt; with him yet. The failure he saw was at the application level (i.e. failure
&gt; to read a key), but I don't know a) how he set up the LB or b) what the
&gt; Java exception was, if any. I'll find that out in an hour or two and report
&gt; back.
&gt;
&gt; I did find this article just now:
&gt;
&gt;
&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/configs/load-balancing-proxy/">http://docs.basho.com/riak/latest/ops/advanced/configs/load-balancing-proxy/</a>
&gt;
&gt; So I suppose we'll give those suggestions a try this morning.
&gt;
&gt; What is the drawback to having the client connect to all 4 nodes (the
&gt; cluster client, I assume you mean?) My understanding from reading articles
&gt; I've found is that one of the nodes going away causes that client to fail
&gt; as well. Is that what you mean, or are there other drawbacks as well?
&gt;
&gt; If there's anything else you can recommend, or links other than the one
&gt; above you can point me to, it would be much appreciated. We expect both
&gt; node failure and deliberate node removal for upgrade, repair, replacement,
&gt; etc.
&gt;
&gt; Regards,
&gt; Vanessa
&gt;
&gt; On Wed, Oct 7, 2015 at 8:29 AM, Dmitri Zagidulin &lt;dzagidu...@basho.com&gt;
&gt; wrote:
&gt;
&gt;&gt; Hi Vanessa,
&gt;&gt;
&gt;&gt; Riak is definitely meant to run behind a load balancer. (Or, at the worst
&gt;&gt; case, to be load-balanced on the client side. That is, all clients connect
&gt;&gt; to all 4 nodes).
&gt;&gt;
&gt;&gt; When you say &quot;we did try putting all 4 Riak nodes behind a load-balancer
&gt;&gt; and pointing the clients at it, but it didn't help.&quot; -- what do you mean
&gt;&gt; exactly, by &quot;it didn't help&quot;? What happened when you tried using the load
&gt;&gt; balancer?
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Oct 7, 2015 at 1:57 PM, Vanessa Williams &lt;
&gt;&gt; vanessa.willi...@thoughtwire.ca&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Hi all, we are still (for a while longer) using Riak 1.4 and the
&gt;&gt;&gt; matching Java client. The client(s) connect to one node in the cluster
&gt;&gt;&gt; (since that's all it can do in this client version). The cluster itself has
&gt;&gt;&gt; 4 nodes (sorry, we can't use 5 in this scenario). There are 2 separate
&gt;&gt;&gt; clients.
&gt;&gt;&gt;
&gt;&gt;&gt; We've tried both n_val = 3 and n_val=4. We achieve consistency-by-writes
&gt;&gt;&gt; by setting w=all. Therefore, we only require one successful read (r=1).
&gt;&gt;&gt;
&gt;&gt;&gt; When all nodes are up, everything is fine. If one node fails, the
&gt;&gt;&gt; clients can no longer read any keys at all. There's an exception like this:
&gt;&gt;&gt;
&gt;&gt;&gt; com.basho.riak.client.RiakRetryFailedException:
&gt;&gt;&gt; java.net.ConnectException: Connection refused
&gt;&gt;&gt;
&gt;&gt;&gt; Now, it isn't possible that Riak can't operate when one node fails, so
&gt;&gt;&gt; we're clearly missing something here.
&gt;&gt;&gt;
&gt;&gt;&gt; Note: we did try putting all 4 Riak nodes behind a load-balancer and
&gt;&gt;&gt; pointing the clients at it, but it didn't help.
&gt;&gt;&gt;
&gt;&gt;&gt; Riak is a high-availability key-value store, so... why are we failing to
&gt;&gt;&gt; achieve high-availability? Any suggestions greatly appreciated, and if more
&gt;&gt;&gt; info is required I'll do my best to provide it.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks in advance,
&gt;&gt;&gt; Vanessa
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Vanessa Williams
&gt;&gt;&gt; ThoughtWire Corporation
&gt;&gt;&gt; <a  rel="nofollow" href="http://www.thoughtwire.com">http://www.thoughtwire.com</a>
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16616.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#16618">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail3.html#16618">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16626.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16613.html">Java Riak client can't handle a Riak node failure?</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16615.html">Re: Java Riak client can't handle a Riak node failur...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16616.html">Re: Java Riak client can't handle a Riak node fa...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Java Riak client can't handle a Riak nod...</span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16626.html">Re: Java Riak client can't handle a Riak...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16627.html">Re: Java Riak client can't handle a...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16628.html">Re: Java Riak client can't hand...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16633.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li class="icons-email"><span class="subject"><a href="msg16662.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li class="icons-email"><span class="subject"><a href="msg17043.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li class="icons-email"><span class="subject"><a href="msg17045.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Alex Moore</span></li>
<li class="icons-email"><span class="subject"><a href="msg17050.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Vanessa Williams</span></li>
<li class="icons-email"><span class="subject"><a href="msg17052.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Alex Moore</span></li>
<li class="icons-email"><span class="subject"><a href="msg17054.html">Re: Java Riak client can't ...</a></span> <span class="sender italic">Vanessa Williams</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Java Riak client can't handle a Riak node failure?">
<input type="hidden" name="msgid" value="CA+TO3kVzhy9BqSy_2MY4ibcjwYTeWyyksMP61KV2qefjXM67dw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16618.html">
<input type="submit" value=" Dmitri Zagidulin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Java+Riak+client+can%27t+handle+a+Riak+node+failure%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16616.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16626.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA+TO3kVzhy9BqSy_2MY4ibcjwYTeWyyksMP61KV2qefjXM67dw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
