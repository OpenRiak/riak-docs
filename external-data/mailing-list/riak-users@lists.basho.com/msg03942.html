<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak crashing due to "eheap_alloc: Cannot allocate xxxx bytes	of  memory"</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03942" id="c">
<link rel="index" href="maillist.html#03942" id="i">
<link rel="prev" href="msg03941.html" id="p">
<link rel="next" href="msg03932.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03942.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+crashing+due+to+%5C%22eheap_alloc%5C%3A+Cannot+allocate+xxxx+bytes%09of++memory%5C%22%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak crashing due to "eheap_alloc: Cannot allocate xxxx bytes	of  memory"</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Aphyr%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Aphyr</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110705" rel="nofollow">Tue, 05 Jul 2011 21:36:43 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<tt>Since you were able to create and write these objects in the first 
</tt><tt>place, you probably had enough ram at one point to load and save them. I 
</tt><tt>would try bringing each node up in isolation, then issuing a delete 
</tt><tt>request against the local node, then restarting the node in normal, 
</tt><tt>talking-to-the-ring mode. If there are any local processes you can stop 
</tt><tt>to free up memory, try that too.
</tt><pre style="margin: 0em;">

</pre><tt>When I encountered this problem, I was able to use the riak:local_client 
</tt><tt>at the erlang shell to delete my huge objects--so long as other 
</tt><tt>processes weren't hammering it with requests.
</tt><pre style="margin: 0em;"></pre><pre>

--Kyle

On 07/05/2011 09:28 PM, Jeff Pollard wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Thanks to some help from Aphyr + Sean Cribbs on IRC, we narrowed the
issue down to us having several multiple-hundred-megabyte sized
documents and one 1.1 gig document.  Deletion of those documents has now
kept the cluster running quite happily for 3+ hours now, where before
nodes were crashing after 15 minutes.

I've managed to delete most of the large documents, but there are still
a handful (3) that I am unable to delete.  Attempts to curl -X DELETE
them result in 503 error from Riak:

    &lt; HTTP/1.1 503 Service Unavailable
    &lt; Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)
    &lt; Date: Wed, 06 Jul 2011 04:20:15 GMT
    &lt; Content-Type: text/plain
    &lt; Content-Length: 18

    &lt;
    request timed out


In the erlang.log, I see this right before the timeout comes back:

    =INFO REPORT==== 5-Jul-2011::21:26:35 ===
    [{alarm_handler,{set,{process_memory_high_watermark,&lt;0.10425.0&gt;}}}]


Anyone have any help/ideas on what's going on here and how to fix it?

On Tue, Jul 5, 2011 at 8:58 AM, Jeff Pollard &lt;jeff.poll...@gmail.com
&lt;<a  rel="nofollow" href="mailto:jeff.poll...@gmail.com">mailto:jeff.poll...@gmail.com</a>&gt;&gt; wrote:

    Over the last few days we've had random nodes in our 5-node cluster
    crash with &quot;eheap_alloc: Cannot allocate xxxx bytes of memory&quot;
    errors in the erl_crash.dump file.  In general, the error messages
    seem to crash trying to allocate 13-20 gigs of memory (our boxes
    have 32 gigs total).  As far as I can tell crashing doesn't seem to
    coincide with any particular requests to Riak.  I've tried to make
    some sense fo the erl_crash.dump file but haven't had any luck.  I'm
    also in the process of restoring our riak bakups to our staging
    cluster in hopes of more accurately reproducing the issue in a less
    noisy environment.

    My questions for the list are:

       1. Any clue how to further diagnose the issue? I can attach my
          erl_crash.dump if needed.
       2. Is it possible/likely this is due to large m/r requests?  We
          have a couple m/r requests.  One goes over no more than 4
          documents at a time while the other goes over anywhere between
          60 and 10,000 documents, though more towards the smaller
          number of documents.  We use 16 js VMs with max memory for the
          VM and stack of 32 MB, each.
       3. We're running riak 0.14.1.  Would upgrading to 0.14.2 help?

    Thanks!




_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03941.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03942">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03942">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03932.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03929.html">Riak crashing due to &quot;eheap_alloc: Cannot allocate xxxx ...</a></span> <span class="sender italic">Jeff Pollard</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03941.html">Re: Riak crashing due to &quot;eheap_alloc: Cannot alloc...</a></span> <span class="sender italic">Jeff Pollard</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak crashing due to &quot;eheap_alloc: Cannot a...</span> <span class="sender italic">Aphyr</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak crashing due to &quot;eheap_alloc: Cannot allocate xxxx bytes	of  memory&quot;">
<input type="hidden" name="msgid" value="4E13E647.7030802@aphyr.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03942.html">
<input type="submit" value=" Aphyr ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+crashing+due+to+%5C%22eheap_alloc%5C%3A+Cannot+allocate+xxxx+bytes%09of++memory%5C%22%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03941.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03932.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">4E13E647.7030802@aphyr.com</li>
</ul>
</div>
</body>
</html>
