<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak HTTPS listener hangs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14114" id="c">
<link rel="index" href="maillist.html#14114" id="i">
<link rel="prev" href="msg14112.html" id="p">
<link rel="next" href="msg14117.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14114.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+HTTPS+listener+hangs%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak HTTPS listener hangs</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Adam+Leko%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Adam Leko</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140418" rel="nofollow">Fri, 18 Apr 2014 09:24:07 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>We have a 5-node Riak cluster and we're having problems keeping the HTTPS
listener running properly. The problem typically manifests itself a few
hours after Riak is started. When it happens, the HTTPS listener on a Riak
node will accept new connections but will never respond to them.
Connections made via curl or OpenSSL's s_client show the client sending the
SSL hello but never getting a response. When this happens, the OS does show
pending data for the socket that isn't being processed (trimmed output):</pre><pre>

# ss -lt
State      Recv-Q Send-Q    Local Address:Port    Peer Address:Port
LISTEN     129    128        1.2.3.4:8098         *:*
One of the times the Erlang VM was in this state I grabbed a crash dump via
SIGUSR1. The Mochiweb process shows up in a &quot;Waiting&quot; state:

=proc:&lt;0.190.0&gt;
State: Waiting
Name: 'https_1.2.3.4:8098_mochiweb'
Spawned as: proc_lib:init_p/5
Spawned by: &lt;0.150.0&gt;
Started: Thu Apr 17 21:01:12 2014
Message queue length: 0
Number of heap fragments: 0
Heap fragment data: 0
Link list: [#Port&lt;0.3873&gt;, &lt;0.4203.0&gt;, &lt;0.150.0&gt;, &lt;0.5788.48&gt;,
&lt;0.12559.49&gt;, &lt;0.4819.45&gt;, &lt;0.17031.51&gt;, &lt;0.19186.51&gt;, &lt;0.18428.51&gt;,
&lt;0.25106.51&gt;, &lt;0.20568.51&gt;, &lt;0.16399.51&gt;, &lt;0.25307.51&gt;, &lt;0.25382.51&gt;,
&lt;0.31884.51&gt;, &lt;0.30289.51&gt;, &lt;0.29247.51&gt;, &lt;0.25168.51&gt;]
Reductions: 50203
Stack+heap: 1597
OldHeap: 0
Heap unused: 495
OldHeap unused: 0
Program counter: 0x00007fb03fea4de8 (gen_server:loop/6 + 264)
CP: 0x0000000000000000 (invalid)
arity = 0

All the processes linked from the main Mochiweb process are also in a
&quot;Waiting&quot; state. If I connect to the riak console and manually kill the
mochiweb process (via exit(pid(...), kill)), its supervisor restarts it and
the node starts servicing HTTPS requests again.

We do have the Erlang cluster behind haproxy but the SSL connections hang
even if you try to connect locally from the machine running the RIak
service. We're using a lightly modified config from what is suggested in
the docs (
<a  rel="nofollow" href="http://docs.basho.com/riak/1.3.1/cookbooks/Load-Balancing-and-Proxy-Configuration/">http://docs.basho.com/riak/1.3.1/cookbooks/Load-Balancing-and-Proxy-Configuration/</a>)
with a much lower max connections setting. When the hangs happen, netstat
only shows a handful of open connections to the haproxy front end.

It's also worth pointing out that when the hangs happen, there are no
messages that show up in the log files that indicate any errors. The rest
of the services on the Riak node don't appear to be affected as well - we
still get periodic anti-&quot;entropy&quot; exchange log messages and all the usual
suspects in riak-admin status check out.

We are using a pretty standard OS configuration - Ubuntu 12.04 LTS with the
Basho apt repo, riak 1.4.8-1, erts-5.9.1 that comes bundled with the Riak
packages.

Are there any known issues with accessing Riak over its HTTPS interface or
any known problems with erts' SSL implementation? As of now we're forced to
use periodic rolling restarts on the nodes in our production cluster to
keep the HTTPS listeners functional, which is a pretty disgusting
workaround.

Thanks for taking the time to read this. I'd appreciate any insight or
guidance on how to address/track down this problem.

-Adam Leko
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14112.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14114">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14114">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14117.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak HTTPS listener hangs</span> <span class="sender italic">Adam Leko</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14117.html">Re: Riak HTTPS listener hangs</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14118.html">Re: Riak HTTPS listener hangs</a></span> <span class="sender italic">Adam Leko</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak HTTPS listener hangs">
<input type="hidden" name="msgid" value="CAMip16v-+STbQ0JJwzA2RiCU1qZ3KkbNrBFy5Pop6aG8DyjfOw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14114.html">
<input type="submit" value=" Adam Leko ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+HTTPS+listener+hangs%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14112.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14117.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAMip16v-+STbQ0JJwzA2RiCU1qZ3KkbNrBFy5Pop6aG8DyjfOw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
