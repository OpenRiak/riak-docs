<!DOCTYPE html>
<html lang="en">
<head>
<title>RE: High disk usage on node</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#18570" id="c">
<link rel="index" href="maillist.html#18570" id="i">
<link rel="prev" href="msg18569.html" id="p">
<link rel="next" href="msg18571.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18570.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+High+disk+usage+on+node%22&amp;o=newest" rel="nofollow"><span itemprop="name">RE: High disk usage on node</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Nicholas+Adams%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Nicholas Adams</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20181101" rel="nofollow">Thu, 01 Nov 2018 07:24:41 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Travis,
I see you have encountered the disk space pickle. Just for the record, the 
safest way to run Riak in production is to keep all resources (CPU, RAM, 
Network, Disk Space, I/O etc.) below 70% utilization on all nodes at all times. 
The reason behind this is to compensate for when one or more nodes go down. 
When this does happen, the remaining nodes have to carry all the load of the 
offline node(s) on top of their existing load and therefore need to have 
sufficient free resources available to do it. If you are running right on the 
limit for any resource then you need to expect issues like this or worse to 
happen on a regular basis.</pre><pre>

Potential initial prevention
When you join all the nodes together to form your cluster, you get to run 
`riak-admin cluster plan` and it will show you how things will turn out. If you 
like this plan, run `riak-admin cluster commit` and partitions will be moved 
around accordingly. If not, you can cancel the plan and generate a new one and 
keep doing so until you are happy with the distribution. Sometimes with 
unfortunate divisions of partitions/nodes/ring size then one node gets its fair 
share and then some but often a replan will make it as painless as possible.

Temporary escape from current situation
Before beginning here, let me mention that this method does have the potential 
to go horribly wrong so proceed at your own risk. With regards to the server 
with the filled disk, you can follow the method underneath:

  *   Stop Riak
  *   Attach additional storage (USB, additional disks, NAS, whatever)
  *   Copy partitions from the data directory of, presumably bitcask, to the 
additional storage
  *   Once the copy has been completed, delete the data from the regular node's 
hard disk
  *   Create a symlink from the external storage to where you just deleted the 
data from
  *   Repeat until you have freed up sufficient disk space (new stuff may be 
copied here, so make sure you do have enough space)
  *   Start Riak

The above should bring your server back in touch with the cluster. Monitor 
transfers and once they have all finished, add your new node to the cluster. 
After this new node has been added and all transfers have finished, take the 
previously full node offline and reverse the steps above until you are able to 
remove the additional storage.

Note: running a mixed version cluster for a prolonged period of time is not 
recommended in production. Out of preference, I would suggest installing the 
same version of Riak on the new node, going through the above and then looking 
at upgrading the cluster once everything is stable.

Good luck,

Nicholas
From: riak-users &lt;riak-users-boun...@lists.basho.com&gt; On Behalf Of Travis 
Kirstine
Sent: 01 November 2018 22:25
To: riak-users@lists.basho.com
Subject: High disk usage on node

I'm running riak (v2.14) in a 5 node cluster and for some reason one of the 
nodes has higher disk usage than the other nodes.  The problem seems to be 
related to how riak distributes the partitions, in my case I'm using the 
default 64, riak has given each node 12 partition except one node that gets 16 
(4x12+16=64).  As a result the node with 16 partitions has filled the disk and 
become 'un-reachable'.

I have a node on standby with roughly the same disk space as the failed node, 
my concern is that if a add it to the cluster it will overflow as well.

How do I recover the failed node and add a new node without destroying the 
cluster..... BTW just to make things more fun the new node is at a newer 
version of riak so I need to perform a rolling upgrade at the same time.

Any help would be greatly appreciated!
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18569.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#18570">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18570">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18571.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18569.html">High disk usage on node</a></span> <span class="sender italic">Travis Kirstine</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">RE: High disk usage on node</span> <span class="sender italic">Nicholas Adams</span></li>
<li class="icons-email"><span class="subject"><a href="msg18571.html">Re: High disk usage on node</a></span> <span class="sender italic">Fred Dushin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18572.html">RE: High disk usage on node</a></span> <span class="sender italic">Travis Kirstine</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg18573.html">Re: High disk usage on node</a></span> <span class="sender italic">Istv√°n</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="RE: High disk usage on node">
<input type="hidden" name="msgid" value="002aed17bdfd4388b5899f8f89079ef6@MBX04C-ORD1.mex06.mlsrvr.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18570.html">
<input type="submit" value=" Nicholas Adams ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+High+disk+usage+on+node%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18569.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18571.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">002aed17bdfd4388b5899f8f89079ef6@MBX04C-ORD1.mex06.mlsrvr.com</li>
</ul>
</div>
</body>
</html>
