<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07529" id="c">
<link rel="index" href="maillist.html#07529" id="i">
<link rel="prev" href="msg07521.html" id="p">
<link rel="next" href="msg07530.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07529.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Client+Resources%2C%09Deleting+a+Key+Doesn%27t+Remove+it+from+bucket.keys%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Reid+Draper%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Reid Draper</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120524" rel="nofollow">Thu, 24 May 2012 08:28:00 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I have a pretty good idea what is causing this problem.

Riak uses &quot;tombstone&quot; values to denote that an object has been deleted.
Under normal conditions, this tombstone value (really, the key/value pair)
will be deleted three (3) seconds after the delete. The delete_mode config
lets you change the time from three seconds, or to put it at immediate or
keep.</pre><pre>

Regardless of the value of delete_mode, the key will continue to show
up in list-keys and 2i $key queries as long as the tombstone is still
around. This is because those calls simply iterate through the keys,
and don't inspect the values for tombstones (this could potentially
by quite costly, depending on the backend). 

For a more detailed explanation of deletes in Riak, I highly
suggest you read Jon Meredith's ML post [1].

Since in both of these cases, you have delete_mode set to either
3s or immediate, we are seeing a case where the first time the tombstone
is attempted to be reaped, it fails. The tombstone reaping isn't attempted
again until you do a GET on the object, which is why you see it no longer
appear in 2i and list-keys queries afterward. This is because a read-repair-like
mechanism runs and sees that the tombstone needs to be reaped.

So why is the tombstone reap failing the first time? There could be several
reasons. It's important to know, first, that the reaping process requires all
N _primary_ replicas to be up and responding. Here are some potential
reasons:

1. One of the primaries is temporarily unreachable.
2. The original tombstone writes didn't go to all N primaries, for any reason
3. The async GET after that starts the tombstone reaping times out, for any 
reason

I don't have a silver-bullet recommendation for this problem at the moment.
If you'd like to favor having deleted keys _not_ show up in 2i/list-keys
requests over delete-availability, you can make your delete requests
with PR = PW = R = W = all (note 'all' is equivalent to whatever your bucket's
N value is).

We'll also be exploring how we can fix or mitigate this situation for
an upcoming release.

[1]: 
<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html</a>

Thanks,
Reid Draper
Software Engineer
Basho

On May 23, 2012, at 4:42 PM, Steve Warren wrote:

&gt; I have a 5 node cluster and given a successful delete call, I expect to get 
&gt; the latest data back given the bucket properties (as shown below)...
&gt; 
&gt; Bucket properties:
&gt; 
&gt; {&quot;props&quot;:{&quot;name&quot;:&quot;mybucket&quot;,&quot;allow_mult&quot;:false,&quot;basic_quorum&quot;:false,&quot;big_vclock&quot;:50,&quot;chash_keyfun&quot;:{&quot;mod&quot;:&quot;riak_core_util&quot;,&quot;fun&quot;:&quot;chash_std_keyfun&quot;},&quot;dw&quot;:&quot;quorum&quot;,&quot;last_write_wins&quot;:false,&quot;linkfun&quot;:{&quot;mod&quot;:&quot;riak_kv_wm_link_walker&quot;,&quot;fun&quot;:&quot;mapreduce_linkfun&quot;},&quot;n_val&quot;:4,&quot;notfound_ok&quot;:true,&quot;old_vclock&quot;:86400,&quot;postcommit&quot;:[],&quot;pr&quot;:&quot;quorum&quot;,&quot;precommit&quot;:[],&quot;pw&quot;:&quot;quorum&quot;,&quot;r&quot;:&quot;quorum&quot;,&quot;rw&quot;:&quot;quorum&quot;,&quot;small_vclock&quot;:50,&quot;w&quot;:&quot;quorum&quot;,&quot;young_vclock&quot;:20}}
&gt; 
&gt; Is my understanding not correct in this (the important properties to me are 
&gt; the pw/pr settings to ensure a good distribution and consistency).
&gt; 
&gt; Regards
&gt; Steve
&gt; 
&gt; On Wed, May 23, 2012 at 1:31 PM, Shuhao Wu &lt;ad...@thekks.net&gt; wrote:
&gt; Riak is eventually consistent. Deleting it doesn't show up immediately. There 
&gt; is an option like delete_immediate
&gt; 
&gt; Shuhao
&gt; 
&gt; On May 23, 2012 4:08 PM, &quot;Steve Warren&quot; &lt;swar...@myvest.com&gt; wrote:
&gt; I'm seeing this pretty consistently and have no explanation for it. I delete 
&gt; a large number of keys (20k to 100k), but when I then search on the keys 
&gt; ($key/0/g) anywhere from 0-200 or so of the deleted keys show up in the 
&gt; results. It doesn't matter how long I wait after completing the deletion 
&gt; step, the keys stay in the list until I try to access the object and then it 
&gt; goes away. I'm using 1.1.2 and the riak-java client, and getting no errors on 
&gt; the deletion step.
&gt; 
&gt; On Tue, May 22, 2012 at 9:34 AM, Steve Warren &lt;swar...@myvest.com&gt; wrote:
&gt; Thank you for the reply. My observation does not quite match up with this 
&gt; though so I'm still a bit confused. The deleted keys appeared to stay long 
&gt; past the 3 seconds described in the post you referenced. In fact, I don't 
&gt; know if they ever &quot;went away&quot;. I'll run some more tests to see if I can 
&gt; narrow down the exact behavior, for example not all key deletions exhibited 
&gt; this behavior (the test I ran resulted in 118 residual keys out of around 20K 
&gt; deletes). If I directly queried any of the keys it would respond with &quot;not 
&gt; found&quot; and immediately stop showing up in the key list or $key index query.
&gt; 
&gt; I'm still running a bunch of tests just to learn the behavior of the system 
&gt; so I'll keep plugging away at it. For example, I'm observing that $key index 
&gt; queries halt inserts into the same bucket while the query is running, I don't 
&gt; know yet if this halts all server activity or just the inserts for that 
&gt; bucket though.
&gt; 
&gt; Regards
&gt; Steve
&gt; 
&gt; On Tue, May 22, 2012 at 8:58 AM, Kelly McLaughlin &lt;ke...@basho.com&gt; wrote:
&gt; Hi Steve. There is no caching of key lists in riak. What you are seeing is 
&gt; likely the fact that listing of keys or index queries can pick up deleted 
&gt; keys due to the fact that riak keeps tombstone markers around for deleted 
&gt; objects for some period. For a really good explanation of riak's delete 
&gt; behavior check out this writeup by Jon Meredith: 
&gt; <a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html</a>.
&gt;  You can set delete_mode to immediate as described in that post and you will 
&gt; most likely not see any deleted keys when you do an index query or key list. 
&gt; The tradeoff is that you may get the unexpected behavior when doing 
&gt; concurrent updates to the same set of keys that the delete_mode changes were 
&gt; designed to address as Jon also indicates in that post.  We are considering 
&gt; different options on this front, but at this time no actual changes have been 
&gt; made to address this. 
&gt; 
&gt; Kelly
&gt; 
&gt; On May 20, 2012, at 10:13 AM, Steve Warren wrote:
&gt; 
&gt;&gt; The last message I saw on this (from a year ago) says the caching of key 
&gt;&gt; lists will be removed. I just ran into it while running a $key index range 
&gt;&gt; search. I then ran a ?key=stream search on the bucket and the same stale key 
&gt;&gt; list appeared (I had created a bunch of data and then deleted it as a test). 
&gt;&gt; Did the caching removal not happen? I'm running 1.1.2
&gt;&gt; 
&gt;&gt; The query:
&gt;&gt; 
&gt;&gt; curl 'localhost:8098/buckets/testbucket/index/$key/0/g'
&gt;&gt; 
&gt;&gt; As others have noted, this behavior is quite disconcerting and I don't want 
&gt;&gt; to pepper the application with otherwise unnecessary checks for stale keys 
&gt;&gt; even on 2i range queries. Or is that unavoidable?
&gt;&gt; 
&gt;&gt; Regards
&gt;&gt; Steve
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07521.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07529">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07529">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07530.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07491.html">Riak Client Resources,	Deleting a Key Doesn't Remove it f...</a></span> <span class="sender italic">Steve Warren</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07501.html">Re: Riak Client Resources,	Deleting a Key Doesn't Re...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07504.html">Re: Riak Client Resources,	Deleting a Key Doesn'...</a></span> <span class="sender italic">Steve Warren</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07518.html">Re: Riak Client Resources,	Deleting a Key Do...</a></span> <span class="sender italic">Steve Warren</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07519.html">Re: Riak Client Resources,	Deleting a Ke...</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07521.html">Re: Riak Client Resources,	Deleting...</a></span> <span class="sender italic">Steve Warren</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Client Resources,	Dele...</span> <span class="sender italic">Reid Draper</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07530.html">Re: Riak Client Resources,	...</a></span> <span class="sender italic">Steve Warren</span></li>
<li class="icons-email"><span class="subject"><a href="msg07531.html">Re: Riak Client Resources,	...</a></span> <span class="sender italic">Reid Draper</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg07520.html">Re: Riak Client Resources,  Deleting a K...</a></span> <span class="sender italic">Kyle Kingsbury</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07522.html">Re: Riak Client Resources,	Deleting...</a></span> <span class="sender italic">Steve Warren</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07523.html">Re: Riak Client Resources,	Dele...</a></span> <span class="sender italic">Reid Draper</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys">
<input type="hidden" name="msgid" value="7306E7F8-6F50-474B-99F1-D6D613018045@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07529.html">
<input type="submit" value=" Reid Draper ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Client+Resources%2C%09Deleting+a+Key+Doesn%27t+Remove+it+from+bucket.keys%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07521.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07530.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">7306E7F8-6F50-474B-99F1-D6D613018045@gmail.com</li>
</ul>
</div>
</body>
</html>
