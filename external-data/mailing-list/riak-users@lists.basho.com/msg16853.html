<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Two quick questions about X-RIak-Meta-* headers....</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16853" id="c">
<link rel="index" href="maillist.html#16853" id="i">
<link rel="prev" href="msg16850.html" id="p">
<link rel="next" href="msg16854.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16853.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Two+quick+questions+about+X%5C-RIak%5C-Meta%5C-%5C%2A+headers....%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Two quick questions about X-RIak-Meta-* headers....</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joe+Olson%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joe Olson</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151208" rel="nofollow">Tue, 08 Dec 2015 07:17:31 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Damien and Dmitri – Thanks for the guidance. This really helps me out. 

I see from the link Dmitri provided that a PB fetch object call does indeed 
support a request for returning only metadata. Unfortunately, I do not think 
this functionality is exposed in the Riak Python API RiakBucket.get method, 
according to the docs at 
<a  rel="nofollow" href="http://basho.github.io/riak-python-client/bucket.html#bucket-objects">http://basho.github.io/riak-python-client/bucket.html#bucket-objects</a> . I looked 
in the Python Riak client source code in GitHub (bucket.py), and also did not 
see a HEAD implementation in ./transports/http/transport.py. Am I looking in 
the right place? If it were implemented, it would be a function of the ‘get' 
method on the bucket object, right? </pre><pre>

I did test the http HEAD method (albeit with curl’s flawed –X HEAD 
implementation) and that did work. 

I can live with internal cluster bandwidth being used for a metadata request. 
Simply add more nodes, right? :) I just don’t want to send large objects back 
down to the client that aren’t being used. 

I understand the strategy of storing metadata for a given key in a different 
bucket using the same key. I’m trying to avoid turning my key-value store into 
a key-key-value-value store. There is an elegance to storing both the data and 
the metadata at the same time and in the same place via the same operation, so 
that is the preferred direction. 



From: &quot;Damien Krotkine&quot; &lt;dkrotk...@gmail.com&gt; 
To: &quot;Dmitri Zagidulin&quot; &lt;dzagidu...@basho.com&gt; 
Cc: &quot;Joe Olson&quot; &lt;technol...@nododos.com&gt;, &quot;riak-users&quot; 
&lt;riak-users@lists.basho.com&gt; 
Sent: Tuesday, December 8, 2015 12:35:56 AM 
Subject: Re: Two quick questions about X-RIak-Meta-* headers.... 

Hi Joe, 

First of all, what Dmitri says makes a lot of sense. From what I understand, 
you are trying to avoid wasting network bandwidth by transferring data where 
you only need the metadata of your keys. As Dmitri pointed out, if your 
replication factor is 3 (default), then Riak will internally query all the 
replica full *data* and metadata, then only return the metadata to the client. 
From a network perspective, you'll save network bandwidth *outside* of your 
cluster, but you'll use quite a lot of network bandwidth *inside* of your 
cluster. Maybe that's not an issue. But if it is, read on: 

1/ first solution : as Dmitri suggested, the best approach is to decouple your 
metadata and data, if possible. If your key is &quot;my_stuff&quot;, then have your data 
stored in the bucket &quot;data&quot; and the metadata stored in the bucket &quot;metadata&quot;. 
So that you'd fetch &quot;metadata/my_stuff&quot;, then fetch &quot;data/my_stuff&quot;. This 
should make your life way easier, but the issue is that you loose the strong 
relationship between data and metadata. To try to mitigate this: 
- when writing your data, start by writing &quot;data/my_stuff&quot; with conservative 
parameters ( w=3 for instance ) then wait for the successful write before 
storing the metadata. So that when the metadata is there, there is a very high 
chance that the data is there as well. 
- when updating your data: ry to be smart, like marking the metadata as invalid 
or unavailable, while you change the data underneath then update the metadata 
- be fault tolerant on your application: if you fetch some metadata, but the 
data is missing, retry, or wait, or gracefully fallback. 
- be fault tolerant again: when fetching some data, have it contain a header or 
an id that must match with the metadata. If it doesn't match, you need to 
wait/retry/fallback 
- if you don't want/can't handle that on the client side, it's possible to 
enrich the Riak API and have Riak do the bookeeping itself. If you're 
interested, let me know. 

2/ second solution: you don't want / can't separate metadata and data. In this 
case, you can try to reduce the network usage 
- first, reduce the internal network usage inside the cluster. When querying 
the metadata, if you're using the PB API, you can pass &quot;n_val&quot; as parameter of 
your request. If you pass n_val=1, then Riak will not query the 3 replicas to 
fetch the value, instead it'll fetch only one replica, saving a lot of internal 
bandwidth. 
- second, you can have your client query one of the primary node (where one of 
the replica is) for a given key. Coupled with passing n_val=1, Riak will not 
transfer anything on the internal network. you can check out 
<a  rel="nofollow" href="https://github.com/dams/riak_preflists">https://github.com/dams/riak_preflists</a> to find the primary nodes. 

Dmitri Zagidulin wrote: 



Hi Joe, 

1. Yes, it's possible (with the HTTP HEAD request, or the client library 
equivalent (I'm pretty sure all the client libraries expose the 'return only 
the headers' part of the object fetch -- see the Optional Parameters head=true 
section of the PB API 
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/dev/references/protocol-buffers/fetch-object/">http://docs.basho.com/riak/latest/dev/references/protocol-buffers/fetch-object/</a> 
)). 

However, this is not going to be very helpful in your case. Behind the scenes, 
a HEAD request still requests all replicas of an object -- *full* replicas, 
including the value. It's just that the node coordinating the request drops the 
actual object value before returning the metadata/headers to the client. 
So, if you use this 'just give me the metadata' request, you're only saving on 
the cost of shipping the object value down the wire from the cluster to the 
client. But you're still incurring the cost of all 3 copies of the object (so, 
3-4MB, in your case) being transferred over the network between the nodes, as a 
result of that HEAD request. 

2. I don't know that there is a specific size limit on the object header 
values. However, this question is definitely a red flag -- it's very likely 
that you're trying to use the custom headers in a way that they weren't 
intended for. 

Can you describe in more detail what's your use case? (As in, what are you 
trying to store as metadata, and why would retrieving just the headers be 
useful to you.) 

Don't forget, that if you need to store a LOT of metadata on an object, and you 
can't do it within the object value itself (for example, when storing binary 
images), you can simply store a separate metadata object, in a different 
bucket, using the same key as the object. 
For example, if I'm storing my primary objects in the 'blobs' bucket, I can 
also store a JSON object with corresponding metadata in a 'blobs-meta' object, 
like so: 

/buckets/blobs/keys/blob123 --&gt; binary object value 
/buckets/blobs-meta/keys/blob123 --&gt; json metadata object 

The downsides of this setup is that you're now doing 2 writes for each object 
(one to the blobs bucket, and one to the meta bucket). 
But the benefits are considerable: 

- You can store arbitrarily large metadata object (you're not abusing object 
headers by stuffing large values into them) 
- Since the metadata object is likely to be much smaller than the object it's 
referring to, you can use the metadata object to check for an object's 
existence (or to get the actual headers that you care about) without the cost 
of requesting the full giant blob. 

Dmitri 



On Mon, Nov 30, 2015 at 12:18 PM, Joe Olson &lt; technol...@nododos.com &gt; wrote: 

BQ_BEGIN

Two quick questions about X-RIak-Meta-* headers: 

1. Is it possible to pull the headers for a key without pulling the key itself? 
The reason I am interested in this is because the values for our keys are in 
the 1.2-1.6 MB range, so the headers are a lot smaller in comparison. I know I 
can index the headers using Solr or 2i, but I am trying to involve the overhead 
of doing that. 

2. What are the size limits on the headers values that are strings? 

As always, thanks in advance! 

_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 





_______________________________________________
riak-users mailing list riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 

BQ_END



</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16850.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16853">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16853">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16854.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16834.html">Two quick questions about X-RIak-Meta-* headers....</a></span> <span class="sender italic">Joe Olson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16849.html">Re: Two quick questions about X-RIak-Meta-* headers....</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16850.html">Re: Two quick questions about X-RIak-Meta-* head...</a></span> <span class="sender italic">Damien Krotkine</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Two quick questions about X-RIak-Meta-* ...</span> <span class="sender italic">Joe Olson</span></li>
<li class="icons-email"><span class="subject"><a href="msg16854.html">Re: Two quick questions about X-RIak-Meta-* ...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Two quick questions about X-RIak-Meta-* headers....">
<input type="hidden" name="msgid" value="2054457757.17602.1449587160212.JavaMail.zimbra@nododos.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16853.html">
<input type="submit" value=" Joe Olson ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Two+quick+questions+about+X%5C-RIak%5C-Meta%5C-%5C%2A+headers....%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16850.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16854.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">2054457757.17602.1449587160212.JavaMail.zimbra@nododos.com</li>
</ul>
</div>
</body>
</html>
