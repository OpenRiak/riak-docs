<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: How to make Riak work faster (writing)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09177" id="c">
<link rel="index" href="maillist.html#09177" id="i">
<link rel="prev" href="msg09174.html" id="p">
<link rel="next" href="msg09178.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09177.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+How+to+make+Riak+work+faster+%5C%28writing%5C%29%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: How to make Riak work faster (writing)</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Uruka+Dark%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Uruka Dark</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121102" rel="nofollow">Fri, 02 Nov 2012 19:03:41 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>First of all, thank you for your replies, Brian and Christian.

I rewrote the script in python:</pre><pre>

#######################
import riak
import time
import sys

hostname = '10.1.1.221'
portnumber = 8087
#portnumber = 8098
if len(sys.argv) &gt; 1:
        hostname = sys.argv[1]

#client = riak.RiakClient(host=hostname,port=portnumber)
client =
riak.RiakClient(host=hostname,port=portnumber,transport_class=riak.RiakPbcTransport)
print hostname + ':' + str(portnumber)

# Choose the bucket to store data in.
bucket = client.bucket('nBucket')

data = 'X' * 10240
cnt = 0
last = time.time()

while 1 :
        obj = bucket.new(None, data)
        obj.store()
        cnt += 1
        if time.time() - last &gt;= 1:
                print cnt
                last = time.time()
                cnt = 0
#######################

This time I got better numbers just changing from PHP to Python.
Using HTTP in python, I got roughly 96 objs/sec (against 72 objs/sec in
php).
Using Protocol Buffers in python, I got roughly 175 objs/sec (not available
in php).

I also tried to run more than one process in python, with PB:
1 proc = 175 objs/sec
2 proc = 157 objs/sec (each)
3 proc = 124 objs/sec (each)

As we can see, using a new language and Protocol Buffers I can get much
better results. Unfortunately, I think those numbers are still too low
(considering that I'm using the Memory backend). Do you think we can get
better results?

And again, thank you for your support.

On Fri, Nov 2, 2012 at 5:30 PM, Christian Dahlqvist &lt;christ...@whitenode.com
&gt; wrote:

&gt;  On 02/11/2012 19:10, Uruka Dark wrote:
&gt;
&gt; Hi Dimitri,
&gt; I don't know why, but I could not receive your reply. I saw it following
&gt; the url of the mailing list.
&gt;
&gt;  Any way, thank you for your reply.
&gt;
&gt;  This is my PHP script:
&gt;
&gt;  *&lt;?php*
&gt; * require_once &quot;riak_lib/riak.php&quot;;*
&gt; *
&gt; *
&gt; * if (isset($argv[1]))*
&gt; * {*
&gt; * define('HOST', $argv[1]);*
&gt; * }*
&gt; * else*
&gt; * {*
&gt; * define('HOST', '10.1.1.221');*
&gt; * }*
&gt; * define('PORT', 8098);*
&gt; *
&gt; *
&gt; * $client = new RiakClient(HOST, PORT);*
&gt; * $str = HOST . &quot;:&quot; . PORT;*
&gt; * if ($client-&gt;isAlive())*
&gt; * {*
&gt; * echo &quot;$str - ALIVE\n&quot;;*
&gt; * }*
&gt; * else*
&gt; * {*
&gt; * echo &quot;$str - DEAD\n&quot;;*
&gt; * die();*
&gt; * }*
&gt; *
&gt; *
&gt; * $bucket = $client-&gt;bucket('zbucket');*
&gt; * $bucket-&gt;setNVal(2);*
&gt; *
&gt; *
&gt; * $cnt = 0;*
&gt; * $last = time();*
&gt; * $data = '';*
&gt; * for ($i=0; $i&lt;10240; $i++)*
&gt; * {*
&gt; * $data .= 'A';*
&gt; * }*
&gt; *
&gt; *
&gt; * // main loop*
&gt; * for ($i=0; true; $i++)*
&gt; * {*
&gt; * $obj = $bucket-&gt;newObject(NULL, $data . $i);*
&gt; * $obj-&gt;store();*
&gt; * $cnt++;*
&gt; * if (time() - $last == 1)*
&gt; * {*
&gt; * echo &quot;$cnt in $i\n&quot;;*
&gt; * $cnt = 0;*
&gt; * $last = time();*
&gt; * }*
&gt; * }*
&gt; *?&gt;*
&gt;
&gt;
&gt;  ---------------------------
&gt;
&gt; Uruka,
&gt;
&gt; What does your load testing script look like? If you post the code
&gt; somewhere, I'll take a look to see if any obvious stumbling block comes to
&gt; mind. I agree, that's way lower than you should be getting with Riak on
&gt; that hardware.
&gt;
&gt; Dmitri
&gt;
&gt;
&gt; On Fri, Nov 2, 2012 at 2:30 PM, Uruka Dark &lt;urukad...@gmail.com&gt; wrote:
&gt;
&gt;&gt;  As I told, maybe I'm trying to use Riak in an improperly way, but this
&gt;&gt; is a kind of requirement for me and I expected to be able to do it with
&gt;&gt; Riak. I'm looking for a &quot;NoSQL&quot; solution and after try out a few of them, I
&gt;&gt; think that I have two great solutions, Couchbase and Riak. To me, Riak
&gt;&gt; seems to be much more mature, and this is my primary option, but, as I
&gt;&gt; told, I can achieve some numbers with Couchbase that I can't with Riak.
&gt;&gt; Given the maturity of Riak, I'm pretty sure that this is a configuration
&gt;&gt; problem, but I need some help to find out how to solve it. If any one could
&gt;&gt; help me with it, I'll be thankful. I don't want to give up on Riak so fast.
&gt;&gt; Thank you.
&gt;&gt;
&gt;&gt;  On Fri, Nov 2, 2012 at 9:46 AM, Uruka Dark &lt;urukad...@gmail.com&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; I understand.
&gt;&gt;&gt; To eliminate any problems related to Bitcask, I changed to Memory
&gt;&gt;&gt; backend and now I can store roughly 80 objs/sec. This speed can be achieved
&gt;&gt;&gt; hitting just one of them.
&gt;&gt;&gt; I tried to hit both of them at same time, and the speed drops to roughly
&gt;&gt;&gt; 68 objs/sec (each).
&gt;&gt;&gt; Do you have any suggestion about it?
&gt;&gt;&gt;
&gt;&gt;&gt;  Thank you.
&gt;&gt;&gt;
&gt;&gt;&gt;  On Fri, Nov 2, 2012 at 9:20 AM, Sebastian Cohnen &lt;
&gt;&gt;&gt; sebastian.coh...@gmail.com&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt;  You should hit both servers and not just with a concurrency level of
&gt;&gt;&gt;&gt; 1.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;  There are many more factors to consider, but these are highly
&gt;&gt;&gt;&gt; dependent on your actual problem (not just a simple benchmark). Just to
&gt;&gt;&gt;&gt; name a few: bitcask settings (
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/tutorials/choosing-a-backend/Bitcask/#Tuning-Bitcask">http://docs.basho.com/riak/latest/tutorials/choosing-a-backend/Bitcask/#Tuning-Bitcask</a>),
&gt;&gt;&gt;&gt; w-quorum, HTTP vs ProtoBuf, ring_creation_size, ...
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;  On 02.11.2012, at 13:15, Uruka Dark &lt;urukad...@gmail.com&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I'm hitting just one of them.
&gt;&gt;&gt;&gt; At the beginning I tried to use the default settings (n_val = 3), then
&gt;&gt;&gt;&gt; I started to create the bucket with n_val = 2. I've tested a lot of
&gt;&gt;&gt;&gt; combinations to w, but I could not see any substantial improvement.
&gt;&gt;&gt;&gt; If you have any suggestion, please, let me know. I can do any test.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Fri, Nov 2, 2012 at 9:04 AM, Sebastian Cohnen &lt;
&gt;&gt;&gt;&gt; sebastian.coh...@gmail.com&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; What level of concurrency are you using in your test setup? Are you
&gt;&gt;&gt;&gt;&gt; hitting both servers with your test? What is your n_val and w?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On 02.11.2012, at 03:42, Uruka Dark &lt;urukad...@gmail.com&gt; wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; &gt; Hi,
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; I'm new here and with Riak. If I do something wrong, please, let me
&gt;&gt;&gt;&gt;&gt; know.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; I've made a Riak cluster with two identical machines: Intel core i3
&gt;&gt;&gt;&gt;&gt; 2.3GHz 4GB RAM 1TB HD. They are connected by a gigabit ethernet network.
&gt;&gt;&gt;&gt;&gt; Everything is working fine. I'm using a Bitcask backend.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; I've made a PHP script to do a performance test and find out how
&gt;&gt;&gt;&gt;&gt; fast Riak can be with these settings. What my script is doing is: to store
&gt;&gt;&gt;&gt;&gt; 10000 objects with a 10K long data (string of 10240 x 'A'), and 
&gt;&gt;&gt;&gt;&gt; calculating
&gt;&gt;&gt;&gt;&gt; how many objects it stores per second.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; Right now, using Bitcask backend, it can store roughly 68 objects
&gt;&gt;&gt;&gt;&gt; per second. It seems to be a small number to me, but I don't know too much
&gt;&gt;&gt;&gt;&gt; about Riak. I've tested the same script on a Couchbase cluster, with the
&gt;&gt;&gt;&gt;&gt; same settings, and it could store roughly 1000 objects per second.
&gt;&gt;&gt;&gt;&gt; Obviously, on Couchbase test, the data is not sent to non-volatile media
&gt;&gt;&gt;&gt;&gt; immediately. Data is kept in memory to acknowledge the reception as fast 
&gt;&gt;&gt;&gt;&gt; as
&gt;&gt;&gt;&gt;&gt; possible, and is sent to non-volatile media in background. I want Riak to
&gt;&gt;&gt;&gt;&gt; behave the same way to increase the &quot;writing speed&quot;, but I don't know how
&gt;&gt;&gt;&gt;&gt; to do it or if it is possible. May be I'm trying to do something 
&gt;&gt;&gt;&gt;&gt; completely
&gt;&gt;&gt;&gt;&gt; out of the purpose of Riak.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; I've tested Riak with Memory backend too, but it achieved only 72
&gt;&gt;&gt;&gt;&gt; objects per second. I expected it to work faster with Memory backend, 
&gt;&gt;&gt;&gt;&gt; cause
&gt;&gt;&gt;&gt;&gt; there is no disk activity involved on it, but the final result is not that
&gt;&gt;&gt;&gt;&gt; high.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; Again, I don't know if I'm trying to do something inappropriate. I
&gt;&gt;&gt;&gt;&gt; think I'm missing something.
&gt;&gt;&gt;&gt;&gt; &gt; Is there any way to do it?
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt; If I could not make myself clear, please, let me know.
&gt;&gt;&gt;&gt;&gt; &gt; Thank you.
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt; &gt;
&gt;&gt;&gt;&gt;&gt;  &gt; _______________________________________________
&gt;&gt;&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing 
&gt; listriak-users@lists.basho.com<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;  Uruka,
&gt;
&gt; The PHP client currently only supports the HTTP interface (
&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/1.2.0/references/Client-Libraries/">http://docs.basho.com/riak/1.2.0/references/Client-Libraries/</a>), which is
&gt; slower than using protocol buffers. I looked through the documentation for
&gt; the PHP client (have not used it myself) trying to see if keep-alive is
&gt; enabled by default, but could not find any information about this nor any
&gt; way to set it on the client. I suppose it therefore might be possible that
&gt; a new connection is established for every request, which would add a lot of
&gt; overhead in your case as you seem to be performing all the inserts using a
&gt; single thread. The numbers you are getting seem to be of the same magnitude
&gt; as I recall getting when performing a large number of curl inserts through
&gt; a simple script (not multithreaded) on a machine of similar spec a couple
&gt; of months ago, which leads me to suspect that keep-alive might very well
&gt; not be enabled.
&gt;
&gt; You should be able to increase the throughput significantly by splitting
&gt; the data and running multiple copies of your script in parallel against
&gt; both nodes at once.
&gt;
&gt; If you can rewrite the test in some other language so that you can take
&gt; advantage of a protocol buffer client, I would expect you to get
&gt; significantly better numbers, especially if using multiple
&gt; processes/threads.
&gt;
&gt; Best regards,
&gt;
&gt; Christian
&gt;
&gt;
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09174.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09177">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09177">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09178.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09151.html">How to make Riak work faster (writing)</a></span> <span class="sender italic">Uruka Dark</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09152.html">Re: How to make Riak work faster (writing)</a></span> <span class="sender italic">Sebastian Cohnen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09153.html">Re: How to make Riak work faster (writing)</a></span> <span class="sender italic">Uruka Dark</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09154.html">Re: How to make Riak work faster (writing...</a></span> <span class="sender italic">Sebastian Cohnen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09155.html">Re: How to make Riak work faster (wri...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09165.html">Re: How to make Riak work faster...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09166.html">Re: How to make Riak work fa...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li class="icons-email"><span class="subject"><a href="msg09169.html">Re: How to make Riak work fa...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09170.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Brian Akins</span></li>
<li class="icons-email"><span class="subject"><a href="msg09174.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: How to make Riak wor...</span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09178.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg09179.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg09180.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09183.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg09186.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09198.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09199.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09204.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg09207.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Uruka Dark</span></li>
<li class="icons-email"><span class="subject"><a href="msg09209.html">Re: How to make Riak wor...</a></span> <span class="sender italic">Jared Morrow</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: How to make Riak work faster (writing)">
<input type="hidden" name="msgid" value="CA+vXBu==7a6-o=UCqMR0xpqAy6_cswnh418z2sS=mod95speNg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09177.html">
<input type="submit" value=" Uruka Dark ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+How+to+make+Riak+work+faster+%5C%28writing%5C%29%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09174.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09178.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA+vXBu==7a6-o=UCqMR0xpqAy6_cswnh418z2sS=mod95speNg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
