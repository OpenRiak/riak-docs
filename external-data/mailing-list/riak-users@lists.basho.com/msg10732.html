<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Map reduce weirdness on Riak 1.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10732" id="c">
<link rel="index" href="maillist.html#10732" id="i">
<link rel="prev" href="msg10731.html" id="p">
<link rel="next" href="msg10733.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10732.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Map+reduce+weirdness+on+Riak+1.3%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Map reduce weirdness on Riak 1.3</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Christian+Dahlqvist%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Christian Dahlqvist</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130406" rel="nofollow">Sat, 06 Apr 2013 12:21:09 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Kartik,

What you are seeing is a result of you not accounting for re-reduce in you 
reduce phase function. </pre><pre>

In Riak reduce phases generally run recursively and the input for each run may 
contain both values from preceding map phase as well as output from previous 
iterations of the reduce phase. In order for the reduce phase to behave 
correctly you will need to distinguish between the different types of input 
records in your reduce function. 

Best regards,

Christian




On 6 Apr 2013, at 19:09, Kartik Thakore &lt;kthak...@aimed.cc&gt; wrote:

&gt; Hello,
&gt; 
&gt; I recently setup a test cluster to try to do a tech demo web application on.
&gt; 
&gt; I have been having some weirdness with the map reduce functionality.
&gt; 
&gt; My database is here:
&gt; 
&gt; <a  rel="nofollow" href="http://aimed.cc:8098/riak/rekon/go#/buckets/test_rand_docs">http://aimed.cc:8098/riak/rekon/go#/buckets/test_rand_docs</a>
&gt; 
&gt; The cluster has 5 nodes
&gt; ulimit 4096
&gt; 
&gt; This is Riak 1.3.0 release on Debian with 663 of free memory.
&gt; 
&gt; I am running this map reduce:
&gt; 
&gt; curl -X POST -H &quot;content-type: application/json&quot; \
&gt;     <a  rel="nofollow" href="http://aimed.cc:8098/mapred">http://aimed.cc:8098/mapred</a> --data @-&lt;&lt;\EOF
&gt; {&quot;inputs&quot;: &quot;test_rand_docs&quot;,
&gt; &quot;query&quot;:[{&quot;map&quot;:{&quot;language&quot;:&quot;javascript&quot;,&quot;source&quot;:&quot;
&gt;     function (v) {
&gt;         var r = {};
&gt;         var data = JSON.parse(v.values[0].data);
&gt;         r.data = data;
&gt;         r.key = v.key;
&gt;         return [ r ];
&gt;     }
&gt; &quot;}},{&quot;reduce&quot;:{&quot;language&quot;:&quot;javascript&quot;,&quot;source&quot;:&quot;
&gt;     function (v) {
&gt;         var r = {};
&gt;         for( var i in v )
&gt;         {
&gt;             var doc = v[i];
&gt;             if( doc['data'] !== undefined) {
&gt;                 var age = doc['data']['age_int'];
&gt;                 if ( age !== undefined &amp;&amp; age &gt; 10 &amp;&amp; age &lt;25 ){
&gt;                     r[doc['key']] = doc['data'];
&gt;                 }
&gt;             }
&gt;         }
&gt;         return  [ r ];
&gt; 
&gt;     }
&gt; &quot;}}]
&gt; 
&gt; 
&gt; my result is randomly:
&gt; 
&gt; [{&quot;9DYMGV0B6Jdn5DivoTExiqyDYUC&quot;:{&quot;age_int&quot;:24},&quot;JQYUs2onC822EOzMaToz71j77e&quot;:{&quot;age_int&quot;:18},&quot;AcrUwotAdYaV5zitaMylnUgYsWY&quot;:{&quot;age_int&quot;:24}}]
&gt; 
&gt; 
&gt; or
&gt; 
&gt; [{&quot;LYJpg97ZA5qjZTTv2cfavmRgxLb&quot;:{&quot;age_int&quot;:11}}]
&gt; 
&gt; but it is clear with this:
&gt; 
&gt; <a  rel="nofollow" href="http://aimed.cc:8098/solr/test_rand_docs/select?q=age_int:[10%20TO%2025">http://aimed.cc:8098/solr/test_rand_docs/select?q=age_int:[10%20TO%2025</a>]
&gt; 
&gt; 
&gt; that there are 134 records ....
&gt; 
&gt; so what is going on?
&gt; 
&gt; 
&gt; Is it low memory? Or that it is on a XEN machine (Linode)? Is there a 
&gt; scaleable memory server vendor (AWS or w/e) I should consider?
&gt; 
&gt; Thanks,
&gt; Kartik Thakore
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10731.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10732">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10732">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10733.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10731.html">Map reduce weirdness on Riak 1.3</a></span> <span class="sender italic">Kartik Thakore</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Map reduce weirdness on Riak 1.3</span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10733.html">Re: Map reduce weirdness on Riak 1.3</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10734.html">Re: Map reduce weirdness on Riak 1.3</a></span> <span class="sender italic">Kartik Thakore</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10737.html">Re: Map reduce weirdness on Riak 1.3</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Map reduce weirdness on Riak 1.3">
<input type="hidden" name="msgid" value="2D14593C-BFFF-4BB0-956E-469B5F864A50@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10732.html">
<input type="submit" value=" Christian Dahlqvist ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Map+reduce+weirdness+on+Riak+1.3%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10731.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10733.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">2D14593C-BFFF-4BB0-956E-469B5F864A50@basho.com</li>
</ul>
</div>
</body>
</html>
