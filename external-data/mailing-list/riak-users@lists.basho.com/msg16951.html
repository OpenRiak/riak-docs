<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak-S2 javascript aws-sdk failing on multi-part uploads</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16951" id="c">
<link rel="index" href="maillist.html#16951" id="i">
<link rel="prev" href="msg16950.html" id="p">
<link rel="next" href="msg16952.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16951.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C-S2+javascript+aws%5C-sdk+failing+on+multi%5C-part+uploads%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak-S2 javascript aws-sdk failing on multi-part uploads</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22John+Fanjoy%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">John Fanjoy</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160113" rel="nofollow">Wed, 13 Jan 2016 14:48:05 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Luke,

Yes on both parts. To confirm cyberduck was using multi-part I actually tailed 
the console.log while it was uploading the file, and it uploaded the file in 
approx. 40 parts. Afterwards the parts were reassembled as you would expect. 
The AWS-SDK for javascript has an object called ManagedUpload which 
automatically switches to multi-part when the input is larger than the 
maxpartsize (default 5mb). I have confirmed that it is splitting the files up, 
but so far I’ve only ever seen one part get successfully uploaded before the 
others failed at which point it removes the upload (DELETE call) automatically. 
I also verified that the javascript I have in place does work with an actual 
AWS S3 bucket to rule out coding issues on my end and the same &gt;400mb file was 
successfully uploaded to the bucket I created there without issue.</pre><pre>

A few things worth mentioning that I missed before. I am running riak-s2 behind 
haproxy. Haproxy is handling ssl and enabling CORS for browser based requests. 
I have tested smaller files (~4-5mb) and GET requests using the browser client 
and everything works with my current haproxy configuration, but the larger 
files are failing, usually after 1 part is successfully uploaded. I can also 
list bucket contents and delete existing contents. The only feature that is not 
working appears to be the multi-part uploads. We are running centOS 7 (kernel 
version 3.10.0-327.4.4.el7.x86_64). Please let me know if you have any further 
questions.

--
John Fanjoy
Systems Engineer
jfan...@inetu.net






On 1/13/16, 5:33 PM, &quot;Luke Bakken&quot; &lt;lbak...@basho.com&gt; wrote:

&gt;Hi John,
&gt;
&gt;Does CyberDuck automatically enable multi-part uploads for files
&gt;greater than a certain size? Does the aws-sdk support multi-part
&gt;uploads?
&gt;--
&gt;Luke Bakken
&gt;Engineer
&gt;lbak...@basho.com
&gt;
&gt;
&gt;On Wed, Jan 13, 2016 at 1:24 PM, John Fanjoy &lt;jfan...@inetu.net&gt; wrote:
&gt;&gt; Hello Everyone,
&gt;&gt;
&gt;&gt; I have been doing some searching around to see if anyone has come across the
&gt;&gt; specific issue I am having and can’t find anything. I have a project that
&gt;&gt; provides a file upload interface through a website and puts the uploaded
&gt;&gt; object into riak-cs. The front end uses the javascript aws-sdk 2.1.29 (tried
&gt;&gt; .19 as well) with a patch I found using the list archives to fix up some url
&gt;&gt; encoding issues with uploadIDs. Everything seems to work fine when the image
&gt;&gt; is less than 5mb (max part size), however when the object is larger the
&gt;&gt; ManagedUpload functionality of the S3 object is failing after the first
&gt;&gt; part. I’ve tested the code I’m using against a vanilla AWS bucket and a 400+
&gt;&gt; mb file was uploaded without issue. I tested the same file with riak-cs
&gt;&gt; using the aws-sdk and CyberDuck. Cyberduck was able to upload the file
&gt;&gt; without any failure, but it has not been successful even once using the
&gt;&gt; javascript library. I have turned the riak-cs debug logging on, and I am
&gt;&gt; getting some errors logged, but I’m not really sure how useful they are:
&gt;&gt;
&gt;&gt; ```
&gt;&gt; 2016-01-13 15:34:51.648 [error] &lt;0.1255.0&gt; Webmachine error at path
&gt;&gt; &quot;/buckets/three2016com-devopsdevel/objects/DeSMan_Ep1_Create_Website_720p_DRAFT%2520%25281%2529.mov/uploads/kL9dRGLaQCiZBNnPSpu5mw==&quot;
&gt;&gt; :
&gt;&gt; {error,{error,{badmatch,{error,closed}},[{webmachine_request,recv_unchunked_body,3,[{file,&quot;src/webmachine_request.erl&quot;},{line,490}]},{riak_cs_wm_object_upload_part,accept_streambody,4,[{file,&quot;src/riak_cs_wm_object_upload_part.erl&quot;},{line,308}]},{riak_cs_wm_object_upload_part,accept_body,2,[{file,&quot;src/riak_cs_wm_object_upload_part.erl&quot;},{line,224}]},{riak_cs_wm_common,accept_body,2,[{file,&quot;src/riak_cs_wm_common.erl&quot;},{line,342}]},{webmachine_resource,resource_call,3,[{file,&quot;src/webmachine_re...&quot;},...]},...]}}
&gt;&gt; in webmachine_request:recv_unchunked_body/3 line 490
&gt;&gt; ```
&gt;&gt;
&gt;&gt; This error does not show up when using Cyberduck or performing an upload
&gt;&gt; that is &lt;5mb using javascript. I’ve tried riak-cs 1.5 and now risk-s2 2.1.0
&gt;&gt; with out any success. Any help you can offer would be greatly appreciated.
&gt;&gt; If you have any questions for me or need additional information let me know
&gt;&gt; and I’ll fill in any holes I left.
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; Thank you in advance,
&gt;&gt;
&gt;&gt; John Fanjoy
&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16950.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16951">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16951">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16952.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16948.html">Riak-S2 javascript aws-sdk failing on multi-part upload...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16949.html">Re: Riak-S2 javascript aws-sdk failing on multi-pa...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16950.html">Re: Riak-S2 javascript aws-sdk failing on multi-pa...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak-S2 javascript aws-sdk failing on mult...</span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16952.html">Re: Riak-S2 javascript aws-sdk failing on ...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16953.html">Re: Riak-S2 javascript aws-sdk failing...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16954.html">Re: Riak-S2 javascript aws-sdk fa...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16955.html">Re: Riak-S2 javascript aws-sd...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16956.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg16964.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">Shunichi Shinohara</span></li>
<li class="icons-email"><span class="subject"><a href="msg16965.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16968.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16972.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak-S2 javascript aws-sdk failing on multi-part uploads">
<input type="hidden" name="msgid" value="0E7B9611-9249-44A0-90D4-D7544C6BDD62@inetu.net">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16951.html">
<input type="submit" value=" John Fanjoy ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C-S2+javascript+aws%5C-sdk+failing+on+multi%5C-part+uploads%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16950.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16952.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">0E7B9611-9249-44A0-90D4-D7544C6BDD62@inetu.net</li>
</ul>
</div>
</body>
</html>
