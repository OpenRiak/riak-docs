<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: [CRDT_OP-in-CommitHook]</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#18052" id="c">
<link rel="index" href="maillist.html#18052" id="i">
<link rel="prev" href="msg18051.html" id="p">
<link rel="next" href="msg18053.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18052.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%5C%5BCRDT_OP%5C-in%5C-CommitHook%5C%5D%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: [CRDT_OP-in-CommitHook]</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Russell+Brown%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Russell Brown</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20170302" rel="nofollow">Thu, 02 Mar 2017 00:34:17 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

You’re using internal details of the CRDT implementation, I’m not sure that is 
such a great idea. You always have your `Context` set to `undefined` but if 
your ops are all adds that shouldn’t matter in this case.</pre><pre>

The issue is that you’re calling `riak_kv_crdt:update` that needs to be called 
from within the vnode. The `ThisNode` value is not a serial actor, so you may 
have many concurrent updates with the actor `ThisNode`, and that’s not how to 
do it. It is crucial that the actor updating the CRDT acts in serial issuing an 
increasing count of events. Thats why we put the CRDT code inside Riak, inside 
the vnode.

You’re doing neither one thing nor the other, in that your using a datatype 
bucket but not the datatype API (it sends Ops from the client, you’re doing 
read/modify/write.)

I can see the issue here is that the API is external only, if you _must_ use 
the internal API have a look at 
<a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/develop/src/riak_kv_pb_crdt.erl">https://github.com/basho/riak_kv/blob/develop/src/riak_kv_pb_crdt.erl</a> and you 
see that the CRDT_OP is all that is sent by the client.

<a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/develop/src/riak_kv_pb_crdt.erl#L162">https://github.com/basho/riak_kv/blob/develop/src/riak_kv_pb_crdt.erl#L162</a>

Those put options matter too, especially for counters, less so for sets.

I guess it would be great if riak_client had some internal API functions that 
made this easier to do from a hook. If you open an issue on 
github.com/basho/riak_kv I can look into that and make a PR.

Hope that helps

Russell

On 1 Mar 2017, at 09:30, 李明 &lt;lmlmlmlal...@gmail.com&gt; wrote:

&gt; Hi 
&gt;    I am new to erlang and riak.  I started to use riak as a kv store couple 
&gt; of months ago. Now i want to implement a commit hook to riak so that riak 
&gt; could help me to make some statistics.
&gt; i read some docs and write a pre-hook scripts, which will fetch the object 
&gt; key and store it into a set.
&gt;    This hook works fine if there is only one client write to riak, but if i 
&gt; increase the connection to riak writing, i found it lost some elements in the 
&gt; set. Looks like the crdt_op did not do the merge operation.And there is no 
&gt; obvious error in the log files.
&gt; 
&gt;    Could someone help me to finger out what happened or what i has missed.
&gt; 
&gt; i am using the riak 2.1.3
&gt; 
&gt; Thanks all!
&gt; 
&gt; 
&gt; Here is the hook scripts:
&gt; 
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; -module(myhook).
&gt; -export([pretest/1]).
&gt; 
&gt; now_to_local_string({MegaSecs, Secs, MicroSecs}) -&gt;
&gt;     LocalTime = calendar:now_to_local_time({MegaSecs, Secs, MicroSecs}),
&gt;     {{Year, Month, Day}, {Hour, Minute, _}} = LocalTime,
&gt;     TimeStr = lists:flatten(io_lib:format(&quot;~4..0w~2..0w~2..0w~2..0w~2..0w&quot;,
&gt;                 [Year, Month, Day, Hour, Minute])),
&gt;     TimeStr.
&gt; 
&gt; is_deleted(Object)-&gt;
&gt;     case dict:find(&lt;&lt;&quot;X-Riak-Deleted&quot;&gt;&gt;,riak_object:get_metadata(Object)) of
&gt;         {ok,_} -&gt;
&gt;             true;
&gt;         _ -&gt;
&gt;             false
&gt;     end.
&gt; 
&gt; pretest(Object) -&gt;
&gt;     % timer:sleep(10000),
&gt;     try
&gt;       ObjBucket = riak_object:bucket(Object),
&gt;   %           riak_object:bucket(Obj).
&gt;               % {&lt;&lt;&quot;cn-archive&quot;&gt;&gt;,&lt;&lt;&quot;local-test&quot;&gt;&gt;}
&gt; 
&gt;               Bucket = element(2, ObjBucket),
&gt;               BucketType = element(1, ObjBucket),
&gt; 
&gt;               ObjKey = riak_object:key(Object),
&gt;               % Key = binary_to_list(ObjKey),
&gt;               % ObjData = riak_object:get_value(Object),
&gt;               % Msg = binary_to_list(ObjData),
&gt;           CommitItem = iolist_to_binary(mochijson2:encode({struct, [{b, 
&gt; Bucket}, {k, ObjKey}, {t, BucketType}]})),
&gt; 
&gt;           case is_deleted(Object) of
&gt;               true -&gt;
&gt;                       KeyPrefix = &quot;delete&quot;;
&gt;                       _ -&gt;
&gt;                               KeyPrefix = &quot;update&quot;
&gt;               end,
&gt; 
&gt;               CurMin = now_to_local_string(os:timestamp()),
&gt;           IndexKey = binary:list_to_bin(io_lib:format(&quot;~s-~s&quot;, [CurMin, 
&gt; KeyPrefix])),
&gt; 
&gt;           %% Get a riak client
&gt;       {ok, C} = riak:local_client(),
&gt;       % get node obj
&gt;               ThisNode = atom_to_binary(node(), latin1),
&gt; 
&gt;               % get index obj and set context
&gt;               BType = &lt;&lt;&quot;archive&quot;&gt;&gt;,
&gt;               B = &lt;&lt;&quot;local-test&quot;&gt;&gt;,
&gt;               
&gt;               {SetObj, Context} = case C:get({BType, B}, IndexKey) of
&gt;                   {error, notfound} -&gt; 
&gt;                       ThisSetObj = riak_kv_crdt:new({BType, B}, IndexKey, 
&gt; riak_dt_orswot),
&gt;                       {ThisSetObj, undefined};
&gt;                   {ok, ThisSetObj} -&gt;
&gt;                       % The datatype update requires the context if the value 
&gt; exists
&gt;                       {{Ctx, _}, _} = riak_kv_crdt:value(ThisSetObj, 
&gt; riak_dt_orswot),
&gt;                       {ThisSetObj, Ctx}
&gt;               end,
&gt; 
&gt;               UpdateIndex = [{add, CommitItem}],
&gt;               % UpdateOp = {crdt_op, riak_dt_orswot, {update, UpdateIndex}, 
&gt; Context},
&gt;               UpdateOp = {crdt_op, riak_dt_orswot, {update, UpdateIndex}, 
&gt; undefined},
&gt;               NewObj = riak_kv_crdt:update(SetObj, ThisNode, UpdateOp),
&gt; 
&gt;               error_logger:info_msg(&quot;Updating index for ~s,to set ~s~n&quot;, 
&gt; [binary:bin_to_list(CommitItem), IndexKey]),
&gt; 
&gt;               C:put(NewObj),
&gt;               Object
&gt;     catch
&gt;       error:Error -&gt;
&gt;                       {fail, 
&gt; lists:flatten(io_lib:format(&quot;[PREHOOKEXCEPTION]~p&quot;,[Error]))}
&gt;       end.
&gt; 
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; 
&gt; This is the set bucket props
&gt; ------------------------------------------------------------------------------------------------------
&gt; 
&gt; active: true
&gt; allow_mult: true
&gt; basic_quorum: false
&gt; big_vclock: 50
&gt; chash_keyfun: {riak_core_util,chash_std_keyfun}
&gt; claimant: 'riak@192.168.100.2'
&gt; datatype: set
&gt; dvv_enabled: true
&gt; dw: quorum
&gt; last_write_wins: false
&gt; linkfun: {modfun,riak_kv_wm_link_walker,mapreduce_linkfun}
&gt; n_val: 3
&gt; notfound_ok: true
&gt; old_vclock: 86400
&gt; postcommit: []
&gt; pr: 0
&gt; precommit: []
&gt; pw: 0
&gt; r: quorum
&gt; rw: quorum
&gt; small_vclock: 50
&gt; w: quorum
&gt; young_vclock: 20
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18051.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#18052">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18052">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18053.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18051.html">[CRDT_OP-in-CommitHook]</a></span> <span class="sender italic">李明</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: [CRDT_OP-in-CommitHook]</span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18053.html">Re: [CRDT_OP-in-CommitHook]</a></span> <span class="sender italic">李明</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18056.html">Re: [CRDT_OP-in-CommitHook]</a></span> <span class="sender italic">李明</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: [CRDT_OP-in-CommitHook]">
<input type="hidden" name="msgid" value="C071556C-F6B7-4247-9885-14800A5FC5C9@mac.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18052.html">
<input type="submit" value=" Russell Brown ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%5C%5BCRDT_OP%5C-in%5C-CommitHook%5C%5D%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18051.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18053.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">C071556C-F6B7-4247-9885-14800A5FC5C9@mac.com</li>
</ul>
</div>
</body>
</html>
