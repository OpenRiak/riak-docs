<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: More Migration Questions</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09314" id="c">
<link rel="index" href="maillist.html#09314" id="i">
<link rel="prev" href="msg09305.html" id="p">
<link rel="next" href="msg09315.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09314.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+More+Migration+Questions%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: More Migration Questions</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Martin+Woods%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Martin Woods</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121113" rel="nofollow">Tue, 13 Nov 2012 14:44:27 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Tom

I'd be very interested to know if Shane's approach should work, or if you
know of any good reason why that approach would cause issues.</pre><pre>

Also, aren't there several very real business use cases here that users of
Riak will inevitably encounter, and must be able to satisfy? Shane mentions
two use cases below: creation of a test environment using a copy of data
from a production cluster; and the migration of data within one cloud
provider from one set of systems to a distinct, separate set of systems.

To add to this, what about the case where a Riak customer needs to move
from one cloud provider to another? How does this customer take his data
with him?

All of the above cases require that a separate cluster be spun up from the
original cluster, with different names and IP addresses for the Riak nodes
 involved in the cluster.

None of these use cases are satisfied by using the riak-admin cluster
command.

It seemed that this was the purpose of the reip command, but if Basho is
poised to deprecate this command, and indeed no longer recommends its use,
how are the previous cases supported? Surely these are important scenarios
for users of Riak, and therefore Basho?

At one level, it seems it should be entirely possible to simply copy the
data directory from each Riak node and tell Riak that the node names and IP
addresses have changed (reip!). So what's the problem with doing this?

Regards,
Martin.


On 13 November 2012 17:16, Thomas Santero &lt;tsant...@basho.com&gt; wrote:

&gt; Hi Shane,
&gt;
&gt; I'm sorry for the delay on this. Over the weekend I was working to
&gt; replicate your setup so I can answer your question from experience. Alas,
&gt; time got the best of me and I have not yet finished.
&gt;
&gt; That said, I'm inclined to suggest upgrading riak on your current cluster
&gt; first and then using riak-admin replace to move off of the VM's and onto
&gt; metal.
&gt;
&gt; * In this scenario, do a rolling upgrade (including making backups) of the
&gt; current cluster.
&gt; * Install riak onto the new machines
&gt; * join the first machine to the cluster
&gt; * use riak-admin replace to replace one of the old nodes with the new node
&gt; * wait for ring-ready, then repeat for the other nodes.
&gt;
&gt; Tom
&gt;
&gt;
&gt; On Tue, Nov 13, 2012 at 11:59 AM, Shane McEwan &lt;sh...@mcewan.id.au&gt; wrote:
&gt;
&gt;&gt; Anyone? Beuller? :-)
&gt;&gt;
&gt;&gt; Installing Riak 1.1.1 on the new nodes, copying the data directories from
&gt;&gt; the old nodes, issuing a &quot;reip&quot; on all the new nodes, starting up, waiting
&gt;&gt; for partition handoffs to complete, shutting down, upgrading to 1.2.1 and
&gt;&gt; starting up again got us to where we want to be. But this is not very
&gt;&gt; convenient.
&gt;&gt;
&gt;&gt; What do I do when I come to creating our test environment where I'll be
&gt;&gt; wanting to copy production data onto the test nodes on a regular basis? At
&gt;&gt; that point I won't have the &quot;luxury&quot; of downgrading to 1.1.1 to have a
&gt;&gt; working &quot;reip&quot; command.
&gt;&gt;
&gt;&gt; Surely there's gotta be an easier way to spin up a new cluster with new
&gt;&gt; names and IPs but with old data?
&gt;&gt;
&gt;&gt; Shane.
&gt;&gt;
&gt;&gt;
&gt;&gt; On 08/11/12 21:10, Shane McEwan wrote:
&gt;&gt;
&gt;&gt;&gt; G'day!
&gt;&gt;&gt;
&gt;&gt;&gt; Just to add to the list of people asking questions about migrating to
&gt;&gt;&gt; 1.2.1 . . .
&gt;&gt;&gt;
&gt;&gt;&gt; We're about to migrate our 4 node production Riak database from 1.1.1 to
&gt;&gt;&gt; 1.2.1. At the same time we're also migrating from virtual machines to
&gt;&gt;&gt; physical machines. These machines will have new names and IP addresses.
&gt;&gt;&gt;
&gt;&gt;&gt; The process of doing rolling upgrades is well documented but I'm unsure
&gt;&gt;&gt; of the correct procedure for moving to an entirely new cluster.
&gt;&gt;&gt;
&gt;&gt;&gt; We have the luxury of a maintenance window so we don't need to keep
&gt;&gt;&gt; everything running during the migration. Therefore the current plan is
&gt;&gt;&gt; to stop the current cluster, copy the Riak data directories to the new
&gt;&gt;&gt; machines and start up the new cluster. The hazy part of the process is
&gt;&gt;&gt; how we &quot;reip&quot; the database so it will work in the new cluster.
&gt;&gt;&gt;
&gt;&gt;&gt; We've tried using the &quot;riak-admin reip&quot; command but were left with one
&gt;&gt;&gt; of our nodes in &quot;(legacy)&quot; mode according to &quot;riak-admin member-status&quot;.
&gt;&gt;&gt; From an earlier E-Mail thread[1] it seems like &quot;reip&quot; is deprecated and
&gt;&gt;&gt; we should be doing a &quot;cluster force replace&quot; instead.
&gt;&gt;&gt;
&gt;&gt;&gt; So, would the new procedure be the following?
&gt;&gt;&gt;
&gt;&gt;&gt; 1. Shutdown old cluster
&gt;&gt;&gt; 2. Copy data directory
&gt;&gt;&gt; 3. Start new cluster (QUESTION: The new nodes don't own any of the
&gt;&gt;&gt; partitions in the data directory. What does it do?) (QUESTION: The new
&gt;&gt;&gt; nodes won't be part of a cluster yet. Do I need to &quot;join&quot; them before I
&gt;&gt;&gt; can do any of the following commands? Or do I just put all the joins and
&gt;&gt;&gt; force-replace commands into the same plan and commit it all together?)
&gt;&gt;&gt; 3. Issue &quot;riak-admin cluster force-replace old-node1 new-node1&quot;
&gt;&gt;&gt; (QUESTION: Do I run this command just on &quot;new-node1&quot; or on all nodes?)
&gt;&gt;&gt; 4. Issue &quot;force-replace&quot; commands for the remaining three nodes.
&gt;&gt;&gt; 5. Issue a &quot;cluster plan&quot; and &quot;cluster commit&quot; to commit the changes.
&gt;&gt;&gt; 6. Cross fingers.
&gt;&gt;&gt;
&gt;&gt;&gt; In my mind the &quot;replace&quot; and/or &quot;force-replace&quot; commands are something
&gt;&gt;&gt; we would use it we had a failed node and needed to bring a spare online
&gt;&gt;&gt; to take over. It doesn't feel like something you would do if you don't
&gt;&gt;&gt; already have a cluster in place and are needing to &quot;replace&quot; ALL nodes.
&gt;&gt;&gt;
&gt;&gt;&gt; Of course, we want to test this procedure before doing it for real. What
&gt;&gt;&gt; are the risks of doing the above procedure while the old cluster is
&gt;&gt;&gt; still running? While the new nodes are on a segregated network and
&gt;&gt;&gt; shouldn't be able to contact the old nodes what would happen if we did
&gt;&gt;&gt; the above and found the network wasn't as segregated as we originally
&gt;&gt;&gt; thought? Would the new nodes start trying to communicate with the old
&gt;&gt;&gt; nodes before the &quot;force-replace&quot; can take effect? Or, because all the
&gt;&gt;&gt; cluster changes are atomic there won't be any risk of that?
&gt;&gt;&gt;
&gt;&gt;&gt; Sorry for all the questions. I'm just trying to get a clear procedure
&gt;&gt;&gt; for moving an entire cluster to new hardware and hopefully this thread
&gt;&gt;&gt; will help other people in the future.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks in advance!
&gt;&gt;&gt;
&gt;&gt;&gt; Shane.
&gt;&gt;&gt;
&gt;&gt;&gt; [1] 
&gt;&gt;&gt; <a  rel="nofollow" href="http://comments.gmane.org/**gmane.comp.db.riak.user/8418">http://comments.gmane.org/**gmane.comp.db.riak.user/8418</a>&lt;<a  rel="nofollow" href="http://comments.gmane.org/gmane.comp.db.riak.user/8418">http://comments.gmane.org/gmane.comp.db.riak.user/8418</a>&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; ______________________________**_________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/**mailman/listinfo/riak-users_**lists.basho.com">http://lists.basho.com/**mailman/listinfo/riak-users_**lists.basho.com</a>&lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; ______________________________**_________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/**mailman/listinfo/riak-users_**lists.basho.com">http://lists.basho.com/**mailman/listinfo/riak-users_**lists.basho.com</a>&lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; @tsantero &lt;<a  rel="nofollow" href="https://twitter.com/#!/tsantero">https://twitter.com/#!/tsantero</a>&gt;
&gt; Technical Evangelist
&gt; Basho Technologies
&gt; 347-571-3995
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09305.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09314">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09314">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09315.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09251.html">More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09255.html">Re: More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li class="icons-email"><span class="subject"><a href="msg09304.html">Re: More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09305.html">Re: More Migration Questions</a></span> <span class="sender italic">Thomas Santero</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: More Migration Questions</span> <span class="sender italic">Martin Woods</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09315.html">Re: More Migration Questions</a></span> <span class="sender italic">Matt Black</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09316.html">Re: More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09318.html">Re: More Migration Questions</a></span> <span class="sender italic">Martin Woods</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: More Migration Questions">
<input type="hidden" name="msgid" value="CALEDdzOUEMkHHxwxk=UbvQge5yNHNMxuLZbgJsMiUKc2EqrCwA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09314.html">
<input type="submit" value=" Martin Woods ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+More+Migration+Questions%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09305.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09315.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CALEDdzOUEMkHHxwxk=UbvQge5yNHNMxuLZbgJsMiUKc2EqrCwA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
