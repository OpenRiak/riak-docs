<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak 2.2.3, allow_mult=false but still siblings</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#18611" id="c">
<link rel="index" href="maillist.html#18611" id="i">
<link rel="prev" href="msg18610.html" id="p">
<link rel="next" href="msg18612.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18611.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+2.2.3%2C+allow_mult%3Dfalse+but+still+siblings%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak 2.2.3, allow_mult=false but still siblings</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Russell+Brown+via+riak%5C-users%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Russell Brown via riak-users</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20190415" rel="nofollow">Mon, 15 Apr 2019 07:57:36 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<tt>That's actually very useful, I hope you are OK if that I re-add back in 
</tt><tt>the list so that this thread can be indexed/used in future.
</tt><pre style="margin: 0em;">
</pre><pre>

On 15/04/2019 15:14, ジョハンガル wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>After -X DELETE types/???/buckets/???/props the properties reverted to 
</tt><tt>the bucket type properties!
</tt><pre style="margin: 0em;">
​
Thank you a lot!
​

-----Original Message-----
*From:* &quot;Russell Brown&quot;&lt;russell.br...@mac.com&gt;
*To:* &quot;ジョハンガル&quot;&lt;gall.jo...@linecorp.com&gt;;
*Cc:*
*Sent:* 2019-04-15 (月) 19:10:24 (GMT+09:00)
*Subject:* Re: riak 2.2.3, allow_mult=false but still siblings

I'm sorry, I don't know, I've not worked much on that code.


Here is how I assume it works


1, create a bucket type T (allow_mult=true by default)

2, create a bucket B of type T (allow_mult &quot;inherited&quot; from T)

3, change property allow_mult of B to false (it is false on B only, not T)


Default buckets have a default set of properties, allow_mult=false

Typed buckets have a default set of properties, allow_mult=true


buckets (named) inherit their Types properties, unless you change the
bucket properties.


On 15/04/2019 09:41, ジョハンガル wrote:
&gt; So if I understand well
&gt; There are basic bucket properties who are ignored
I don't understand &quot;who are ignored&quot; bucket properties are not ignored
&gt; /buckets/???/props
&gt; ​
&gt; Then there are bucket types
&gt; riak-admin bucket-type ...​
&gt; ​
&gt; Then there are bucket type properties under that type
&gt; /types/???/buckets/???/props
&gt; ​
&gt; Are /types/??A/buckets/???/props and /types/??B/buckets/???/props
&gt; different

Only if you changed the properties of A or B on creation of the type.
And further you can change the properties of buckets that or type A or B
(unless the types has immutable properties (like the allow_mult property
of a datatyped bucket))


&gt; ​
&gt; Just to make sure, I am quite confused.
&gt; ​
&gt; If I run -X DELETE /types/???/buckets/???/props would it revert it to
&gt; the default bucket type properties??

I don't think so, no, I don't think you can delete bucket props that
way. You need to set the properties you want


If it helps, I'm confused too. What do the docs say on the matter?


Cheers


Russell

&gt; ​
&gt;
&gt; -----Original Message-----
&gt; *From:* &quot;Russell Brown&quot;&lt;russell.br...@mac.com&gt;
&gt; *To:* &quot;ジョハンガル&quot;&lt;gall.jo...@linecorp.com&gt;;
&gt; *Cc:*
&gt; *Sent:* 2019-04-15 (月) 17:14:34 (GMT+09:00)
&gt; *Subject:* Re: riak 2.2.3, allow_mult=false but still siblings
&gt;
&gt; That bucket has allow_mult=true, so the siblings are expected. How the
&gt; bucket props managed to be changed from the bucket-type defaults is
&gt; worth investigating though.
&gt;
&gt;
&gt; On 15/04/2019 08:49, ジョハンガル wrote:
&gt; &gt; Sorry for the late answer!
&gt; &gt; ​
&gt; &gt; ​​
&gt; &gt; ​
&gt; &gt; Is it a case of bucket props overriding the type?
&gt; &gt; We deleted all the bucket props recently. (curl -X DELETE .... /props)
&gt; &gt;
&gt; &gt; -----Original Message-----
&gt; &gt; *From:* &quot;Russell Brown&quot;&lt;russell.br...@mac.com&gt;
&gt; &gt; *To:* &quot;ジョハンガル&quot;&lt;gall.jo...@linecorp.com&gt;;
&gt; &gt; *Cc:*
&gt; &gt; *Sent:* 2019-04-13 (土) 05:05:33 (GMT+09:00)
&gt; &gt; *Subject:* Re: riak 2.2.3, allow_mult=false but still siblings
&gt; &gt;
&gt; &gt; Can I see the bucket properties for the bucket in question, please?
&gt; &gt; Buckets can override their type's properties, iirc
&gt; &gt;
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt;
&gt; &gt; Russell
&gt; &gt;
&gt; &gt;
&gt; &gt; On 12/04/2019 13:36, ジョハンガル wrote:
&gt; &gt; &gt; for the bucket type definition:
&gt; &gt; &gt; ​
&gt; &gt; &gt; ​
&gt; &gt; &gt; For the headers
&gt; &gt; &gt; ​
&gt; &gt; &gt; ​
</pre><tt>&gt; &gt; &gt; These buckets formally allowed siblings (more of a default thing 
</tt><tt>than
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; anything).
&gt; &gt; &gt; Following sibling explosion problems we modified all buckets that
&gt; &gt; &gt; received updates from a single source to not allow siblings anymore.
&gt; &gt; &gt; During some time we had bucket properties and types used at the same
&gt; &gt; &gt; type, following the previously mentioned (property broadcast bug)
</pre><tt>&gt; &gt; &gt; repeatedly bringing our machines down, we identified the 
</tt><tt>problem, made
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; sure everything run with &gt;2.0 clients, reset (deleted) all bucket
</pre><tt>&gt; &gt; &gt; properties and made sure to use types. Then the cluster became 
</tt><tt>stable.
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; Then while monitoring I noticed these siblings that shouldn't be.
&gt; &gt; &gt; ​
&gt; &gt; &gt; The entire content of these buckets is batch regenerated multiple
</pre><tt>&gt; &gt; &gt; times by minute (~1 to 10). There is very little total content 
</tt><tt>(a few
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; megabytes in that bucket) and the machines used are ridiculously
&gt; &gt; &gt; overprovisionned (many cores 64gb ram machines).
&gt; &gt; &gt; ​
&gt; &gt; &gt;
&gt; &gt; &gt; -----Original Message-----
&gt; &gt; &gt; *From:* &quot;Russell Brown&quot;&lt;russell.br...@mac.com&gt;
&gt; &gt; &gt; *To:* &quot;ジョハンガル&quot;&lt;gall.jo...@linecorp.com&gt;;
&gt; &gt; &gt; &lt;riak-users@lists.basho.com&gt;;
&gt; &gt; &gt; *Cc:*
&gt; &gt; &gt; *Sent:* 2019-04-12 (金) 20:47:56 (GMT+09:00)
&gt; &gt; &gt; *Subject:* Re: riak 2.2.3, allow_mult=false but still siblings
&gt; &gt; &gt;
&gt; &gt; &gt; Can you let us see the bucket type definition, please?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Can you show me the headers from the curl command that returns
&gt; siblings,
&gt; &gt; &gt; please?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; I want to say that what you are seeing is unpossible (from what I
</pre><tt>&gt; &gt; &gt; remember of the code.) But I don't remember the 2.2.3 release 
</tt><tt>process,
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; and I'd like to see some more evidence before I look at the code
&gt; again.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; I wonder if you remember the history of the bucket/bucket type in
&gt; &gt; &gt; question. Has it had changes to allow_mult etc?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Cheers
&gt; &gt; &gt;
&gt; &gt; &gt; Russell
&gt; &gt; &gt;
&gt; &gt; &gt; On 12/04/2019 12:29, ジョハンガル wrote:
&gt; &gt; &gt; &gt; Hello,
&gt; &gt; &gt; &gt; ​
&gt; &gt; &gt; &gt; I would be thankful is somebody could help me with some weird
&gt; &gt; &gt; &gt; abnormalities.
&gt; &gt; &gt; &gt; ​
</pre><tt>&gt; &gt; &gt; &gt; curl <a  rel="nofollow" href="https://~~~/types/THE-TYPE/bucket/~~~/keys/~~~">https://~~~/types/THE-TYPE/bucket/~~~/keys/~~~</a> returns 
</tt><tt>siblings
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; &gt; ​
&gt; &gt; &gt; &gt; However the corresponding type has &quot;allow_mult&quot; set to false...
&gt; &gt; &gt; &gt; ​​
&gt; &gt; &gt; &gt; The phenomenon appear with both
&gt; &gt; &gt; &gt; &quot;last_write_wins=true;dvv_enabled=false&quot; and
&gt; &gt; &gt; &gt; &quot;last_write_wins=false;dvv_enabled=true&quot;.
</pre><tt>&gt; &gt; &gt; &gt; The backend is leveldb (in a multi configuration), secondary 
</tt><tt>indices
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; &gt; are used.
&gt; &gt; &gt; &gt; ​
&gt; &gt; &gt; &gt; The cluster is an old cluster (pre 2.0) that received rolling
&gt; updates
&gt; &gt; &gt; &gt; to 2.0 (remove node, reinstall riak with new config, read node).
&gt; &gt; &gt; &gt; Currently 2.2.3
&gt; &gt; &gt; &gt; We used to hit that problem a lot until we found out about it and
&gt; &gt; &gt; &gt; fixed the problem <a  rel="nofollow" href="https://github.com/basho/yokozuna/issues/389">https://github.com/basho/yokozuna/issues/389</a>
&gt; &gt; &gt; &gt; I don't if it has any kind of relevancy though.
&gt; &gt; &gt; &gt; ​
</pre><tt>&gt; &gt; &gt; &gt; Does somebody have some kind of hint? Or diagnostic command I 
</tt><tt>might
</tt><pre style="margin: 0em;">
&gt; &gt; &gt; &gt; run? Am I missing something obvious?
&gt; &gt; &gt; &gt; ​
&gt; &gt; &gt; &gt; Best regards,
&gt; &gt; &gt; &gt; ​
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; _______________________________________________
&gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt; &gt;
&gt; &gt;
&gt;

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18610.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#18611">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18611">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18612.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18609.html">riak 2.2.3, allow_mult=false but still siblin...</a></span> <span class="sender italic">ジョハンガル</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18610.html">Re: riak 2.2.3, allow_mult=false but sti...</a></span> <span class="sender italic">Russell Brown via riak-users</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak 2.2.3, allow_mult=false but...</span> <span class="sender italic">Russell Brown via riak-users</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak 2.2.3, allow_mult=false but still siblings">
<input type="hidden" name="msgid" value="70e0acb7-0567-3889-71c9-acb8577518ef@mac.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18611.html">
<input type="submit" value=" Russell Brown via riak-users ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+2.2.3%2C+allow_mult%3Dfalse+but+still+siblings%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18610.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18612.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">70e0acb7-0567-3889-71c9-acb8577518ef@mac.com</li>
</ul>
</div>
</body>
</html>
