<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: leveldb Hot Threads in 1.4.9?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14460" id="c">
<link rel="index" href="maillist.html#14460" id="i">
<link rel="prev" href="msg14344.html" id="p">
<link rel="next" href="msg14468.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14460.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+leveldb+Hot+Threads+in+1.4.9%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: leveldb Hot Threads in 1.4.9?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Von%5C-Maszewski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Von-Maszewski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140705" rel="nofollow">Sat, 05 Jul 2014 10:36:06 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Tom,

Basho prides itself on quickly responding to all user queries.  I have failed 
that tradition in this case.  Please accept my apologies.</pre><pre>


The LOG data suggests leveldb is not stalling, especially not for 4 hours.  
Therefore the problem is related to disk utilization.

You appear to have large values.  I see .sst files where the average value is 
100K to 1Mbyte in size.  Is this intentional, or might you have a sibling 
problem?


My assessment is that your lower levels are full and therefore cascading 
regularly.  &quot;cascading&quot; is like the typical champagne glass pyramid you see at 
weddings.  Once all the glasses are full, new champagne at the top causes each 
subsequent layer to overflow into the one below that.  You have the same 
problem, but with data.  

Your large values have filled each of the lower levels and regularly cause 
cascading data between multiple levels.  The cascading is causing each 100K 
value write to become the equivalent of a 300K or 500K value as levels 
overflow.  This cascading is chewing up your hard disk performance (by reducing 
the amount of time the hard drive has available for read requests).

The leveldb code for Riak 2.0 has increased the size of all the levels.  The 
table of sizes is found at the top of leveldb's db/version_set.cc.  You could 
patch your current code if desired with this table from 2.0:

{                                                                               
                                                  
    {10485760,  262144000,  57671680,      209715200,                 0,     
420000000, true},                                   
    {10485760,   82914560,  57671680,      419430400,                 0,     
209715200, true},                                   
    {10485760,  314572800,  57671680,     3082813440,         200000000,     
314572800, false},                                   
    {10485760,  419430400,  57671680,     6442450944ULL,     4294967296ULL,  
419430400, false},                                   
    {10485760,  524288000,  57671680,   128849018880ULL,    85899345920ULL,  
524288000, false},                                   
    {10485760,  629145600,  57671680,  2576980377600ULL,  1717986918400ULL,  
629145600, false},                                   
    {10485760,  734003200,  57671680, 51539607552000ULL, 34359738368000ULL,  
734003200, false}                                   
};                                                                              
                                  

You cannot take the entire 2.0 leveldb into your 1.4 code base due to various 
option changes.


Let me know if this helps.  I have previously hypothesized that &quot;grooming&quot; 
compactions should be limited to one thread total.  However my test datasets 
never demonstrated a benefit.  Your dataset might be the case that proves the 
benefit.  I will go find the grooming patch to hot_threads for you if the above 
table proves insufficient.

Matthew




On Jul 2, 2014, at 9:20 PM, Tom Lanyon &lt;tom+r...@oneshoeco.com&gt; wrote:

&gt; Hi Matthew, 
&gt; 
&gt; Just thought I'd see whether you were back from your travels and had had a 
&gt; chance to take a look at the log file provided?
&gt; 
&gt; There's no rush if you haven't had a chance!
&gt; 
&gt; Regards,
&gt; Tom
&gt; 
&gt; 
&gt; On Tuesday, 24 June 2014 at 10:45, Tom Lanyon wrote:
&gt; 
&gt;&gt; No problem, Matthew. 
&gt;&gt; 
&gt;&gt; Appreciate you taking a look when you have time.
&gt;&gt; 
&gt;&gt; Regards,
&gt;&gt; Tom
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Tuesday, 24 June 2014 at 9:45, Matthew Von-Maszewski wrote:
&gt;&gt; 
&gt;&gt;&gt; Tom,
&gt;&gt;&gt; 
&gt;&gt;&gt; I have been distracted today and on a plane tomorrow. I apologize for the 
&gt;&gt;&gt; delayed response. It may be late tomorrow before I can share further 
&gt;&gt;&gt; thoughts. 
&gt;&gt;&gt; 
&gt;&gt;&gt; Again my apologies.
&gt;&gt;&gt; 
&gt;&gt;&gt; Matthew Von-Maszewski
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Jun 23, 2014, at 8:58, Tom Lanyon &lt;tom+r...@oneshoeco.com 
&gt;&gt;&gt; (<a  rel="nofollow" href="mailto:tom+r...@oneshoeco.com">mailto:tom+r...@oneshoeco.com</a>)&gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thanks; the combined_log for our Riak node 3 is here:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="https://www.dropbox.com/s/krhhwnplpeyhl0c/riak3-combined_log-20140623.log.gz">https://www.dropbox.com/s/krhhwnplpeyhl0c/riak3-combined_log-20140623.log.gz</a>
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Let me know if you can't retrieve/view it.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; With timestamps relative to this log file, at 2014/06/23-05:35 our 
&gt;&gt;&gt;&gt; monitoring detected node3's Riak as &quot;down&quot;; it wasn't serving any client 
&gt;&gt;&gt;&gt; protobuf requests, &quot;riak ping&quot; didn't respond and all of the other nodes 
&gt;&gt;&gt;&gt; marked node 3 as unreachable. We watched the process and it was busy doing 
&gt;&gt;&gt;&gt; leveldb compactions so we left it alone and it eventually recovered at 
&gt;&gt;&gt;&gt; 2014/06/23-09:32 (so ~4 hours unresponsive).
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Yes - this cluster started at 1.2.1 and then I believe it went to 1.3.1, 
&gt;&gt;&gt;&gt; 1.4.2 and now 1.4.8. However, we went from 1.3.1--&gt;1.4.2 in September 2013 
&gt;&gt;&gt;&gt; and 1.4.2--&gt;1.4.8 in May, so we've been running 1.4.x for many months - 
&gt;&gt;&gt;&gt; does this fit with the 'one time cost of upgrading' you mentioned?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Regards,
&gt;&gt;&gt;&gt; Tom
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Monday, 23 June 2014 at 19:29, Matthew Von-Maszewski wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Yes, off list is fine for the data files. I may or may not respond via 
&gt;&gt;&gt;&gt;&gt; the list depending upon what I find.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I did recall a case where leveldb seems unresponsive for hours. This case 
&gt;&gt;&gt;&gt;&gt; was a one time cost of upgrading some 1.2 or 1.3 systems to 1.4. Would 
&gt;&gt;&gt;&gt;&gt; that happen to describe your scenario?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Matthew Von-Maszewski
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Jun 23, 2014, at 0:28, Tom Lanyon &lt;tom+r...@oneshoeco.com 
&gt;&gt;&gt;&gt;&gt; (<a  rel="nofollow" href="mailto:tom+r...@oneshoeco.com">mailto:tom+r...@oneshoeco.com</a>)&gt; wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Hi Matthew, 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Thanks for the response and apologies for my off-list reply.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; I can send a combined_log example directly to you if that helps? It's 
&gt;&gt;&gt;&gt;&gt;&gt; 13MB gzip'ed.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Regards,
&gt;&gt;&gt;&gt;&gt;&gt; Tom
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Monday, 23 June 2014 at 12:30, Matthew Von-Maszewski wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hot threads is included with 1.4.9. The leveldb source file 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; leveldb/util//hot_threads.cc (<a  rel="nofollow" href="http://hot_threads.cc">http://hot_threads.cc</a> 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (<a  rel="nofollow" href="http://_threads.cc">http://_threads.cc</a>) (<a  rel="nofollow" href="http://_threads.cc">http://_threads.cc</a>) (<a  rel="nofollow" href="http://_threads.cc">http://_threads.cc</a>)) is the 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; key file.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; The code helps throughput, but is not magical. &quot;unresponsive for hours&quot; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; is not a known problem in the 1.4.x code base. Would you mind posting 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; an aggregate LOG file from a period when this happens?
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; sort /var/lib/riak/*/LOG &gt;combined_log
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Substitute your actual data path for /var/lib/riak.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Matthew Von-Maszewski
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On Jun 22, 2014, at 22:07, Tom Lanyon &lt;tom+r...@oneshoeco.com 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (<a  rel="nofollow" href="mailto:tom+r...@oneshoeco.com">mailto:tom+r...@oneshoeco.com</a>)&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Could someone please confirm whether 1.4.9 includes &quot;Hot Threads&quot; in 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; leveldb? 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; The release notes have a link to it, but I couldn't find my way 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; through the rebar &amp; git maze to be absolutely sure it is in 1.4.9 but 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; not 1.4.8.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; We're seeing nodes unresponsive for hours during large compactions and 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; wondered if this leveldb improvement would help.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Tom
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14344.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14460">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14460">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14468.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14342.html">leveldb Hot Threads in 1.4.9?</a></span> <span class="sender italic">Tom Lanyon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14344.html">Re: leveldb Hot Threads in 1.4.9?</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: leveldb Hot Threads in 1.4.9?</span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14468.html">Re: leveldb Hot Threads in 1.4.9?</a></span> <span class="sender italic">Tom Lanyon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14470.html">Re: leveldb Hot Threads in 1.4.9?</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: leveldb Hot Threads in 1.4.9?">
<input type="hidden" name="msgid" value="B4DCBF2E-4C95-48CF-AA9B-434135632571@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14460.html">
<input type="submit" value=" Matthew Von-Maszewski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+leveldb+Hot+Threads+in+1.4.9%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14344.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14468.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">B4DCBF2E-4C95-48CF-AA9B-434135632571@basho.com</li>
</ul>
</div>
</body>
</html>
