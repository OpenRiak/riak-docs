<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: The best (fastest) way to delete/clear a bucket [python]</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14239" id="c">
<link rel="index" href="maillist.html#14239" id="i">
<link rel="prev" href="msg14238.html" id="p">
<link rel="next" href="msg14240.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14239.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+The+best+%5C%28fastest%5C%29+way+to+delete%5C%2Fclear+a+bucket+%5C%5Bpython%5C%5D%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: The best (fastest) way to delete/clear a bucket [python]</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Dmitri+Zagidulin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Dmitri Zagidulin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140519" rel="nofollow">Mon, 19 May 2014 15:26:20 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Ah, that's interesting, let's see if we can test this.

The 'delete_mode' configuration is not supported in the regular riak.conf
file, from what I understand.
However, you can still set it in the 'advanced.config' file, as described
here:
<a  rel="nofollow" href="https://github.com/basho/basho_docs/blob/features/lp/advanced-conf/source/languages/en/riak/ops/advanced/configs/configuration-files.md#the-advancedconfig-file">https://github.com/basho/basho_docs/blob/features/lp/advanced-conf/source/languages/en/riak/ops/advanced/configs/configuration-files.md#the-advancedconfig-file</a>
(those docs are a current work-in-progress, mind you)</pre><pre>

So, create an advanced.config file in your riak etc/ directory (this will
be in addition to your existing riak.conf), with the following contents:
[
 {riak_kv, [
   {delete_mode, immediate}
 ]}
].

Restart the node, and try your tests again. The tombstones should disappear
now on every delete request. (You should probably also wipe all of the old
data, by deleting the contents of the bitcask and anti_entropy directories
in your riak data dir, just to make sure the old ones are gone. This should
be done while the node is down, of course.)



On Mon, May 19, 2014 at 4:33 PM, Paweł Królikowski &lt;rabb...@gmail.com&gt;wrote:

&gt; The problem is that the tombstones never disappear - they keep coming back
&gt; through bucket.get_keys() hours after deletion, even after a restart.
&gt;
&gt; I said I'm using the delete_mode default configuration, because I didn't
&gt; change it. I now tried, and apparently it's not supported any more in Riak
&gt; 2.0.
&gt;
&gt; 17:16:56.318 [error] You've tried to set delete_mode, but there is no
&gt; setting with that name.^M
&gt; 17:16:56.318 [error]   Did you mean one of these?^M
&gt; 17:16:56.335 [error]     dtrace^M
&gt; 17:16:56.335 [error]     nodename^M
&gt; 17:16:56.335 [error]     ssl.keyfile^M
&gt; 17:16:56.335 [error] Error generating configuration in phase
&gt; transform_datatypes^M
&gt; 17:16:56.335 [error] Conf file attempted to set unknown variable:
&gt; delete_mode^M
&gt; Error generating config with cuttlefish
&gt;
&gt; I'm using Riak 2.0.0pre20, on strongly consistent buckets, on a single
&gt; node cluster. Can this be the reason? I guess what I need is a confirmation
&gt; that something is broken/that I'm doing something stupid.
&gt;
&gt; I've tried looking for similar issues (github.com/basho/riak/issues),
&gt; didn't find any -&gt; I guess that suggests I'm doing something stupid, I just
&gt; don't know what yet.
&gt;
&gt;
&gt; Thanks again :)
&gt;
&gt; --
&gt; Paweł
&gt;
&gt;
&gt; On 19 May 2014 18:00, Dmitri Zagidulin &lt;dzagidu...@basho.com&gt; wrote:
&gt;
&gt;&gt; Ah, yes, you bring up a good point. (And, that's another subtlety to keep
&gt;&gt; in mind, with Option #1).
&gt;&gt;
&gt;&gt; Tombstones are definitely something to keep in mind, when deleting unit
&gt;&gt; test data.
&gt;&gt; As you mentioned in your earlier question, if you're using default
&gt;&gt; delete_mode configuration ( 3 seconds ), it means that if you issue a
&gt;&gt; delete, a tombstone object is going to be written (and stick around for at
&gt;&gt; least 3 seconds), and unfortunately, it is going to show up as a false
&gt;&gt; positive on a List Keys call.
&gt;&gt;
&gt;&gt; The easiest thing to try, in your case, is to set 'delete_mode' to
&gt;&gt; 'immediate', restart the test cluster, and retest. With an immediate
&gt;&gt; delete, your second test with 10 keys should not take as long as the
&gt;&gt; previous delete with 10000 keys.
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, May 19, 2014 at 11:46 AM, Paweł Królikowski &lt;rabb...@gmail.com&gt;wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Dmitri,
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks a lot for the answer. Option #1 seems the best, but I have a
&gt;&gt;&gt; follow up question:
&gt;&gt;&gt;
&gt;&gt;&gt; - when do the deleted keys disappear from Riak: a part of my problem
&gt;&gt;&gt; (have not explained it correctly the first time), is that get_keys()
&gt;&gt;&gt; returns keys that no longer exist. So, I run a test with 10 000 keys, I
&gt;&gt;&gt; remove them, it takes Nseconds. I then follow with a test with 10 keys, but
&gt;&gt;&gt; removing them takes just as much time - I imagine it's because I'm going
&gt;&gt;&gt; over that 10 000 keys again.
&gt;&gt;&gt;
&gt;&gt;&gt; This article seems relevant:
&gt;&gt;&gt; <a  rel="nofollow" href="http://basho.com/riaks-config-behaviors-part-3/">http://basho.com/riaks-config-behaviors-part-3/</a> - it seems like the
&gt;&gt;&gt; tombstones simply remain in my system indefinitely.
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Paweł
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 19 May 2014 15:32, Dmitri Zagidulin &lt;dzagidu...@basho.com&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi Pawel,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; There's basically three ways to clear data from Riak (for the purposes
&gt;&gt;&gt;&gt; of automated testing):
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 1. Iterate through the keys via get_keys(), and delete each one. This
&gt;&gt;&gt;&gt; is what you're currently doing, except you don't need to invoke 
&gt;&gt;&gt;&gt; if.exists().
&gt;&gt;&gt;&gt; if.exists() makes an additional API call to Riak, and it takes twice as
&gt;&gt;&gt;&gt; long as just calling delete() (and trapping a potential 404 doesn't exist
&gt;&gt;&gt;&gt; error).
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Advantages: Easy to understand, can be done entirely in code (without
&gt;&gt;&gt;&gt; invoking OS/shell commands).
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Disadvantages: It can get slow, for large data sets. Another subtle
&gt;&gt;&gt;&gt; disadvantage is that, as your app grows, it can get difficult to keep track
&gt;&gt;&gt;&gt; of which buckets you've created and need to be cleared.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 2. Stop the Riak cluster, delete the riak data directory, and re-start.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Advantages: Very fast, and you can be sure that you're deleting all
&gt;&gt;&gt;&gt; buckets.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Disadvantages: Involves invoking OS/shell commands. This is fairly easy
&gt;&gt;&gt;&gt; if your Riak node is running on the same machine as your tests (and if it's
&gt;&gt;&gt;&gt; a single node). To delete the data directories of a multi-node cluster, now
&gt;&gt;&gt;&gt; you need to involve either a bash script that uses SSH to log in and
&gt;&gt;&gt;&gt; restart, or a coordination framework like Ansible.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 3. Use an in-memory back end. (And to drop all data, just restart the
&gt;&gt;&gt;&gt; node(s)).
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Advantages: Same as #2 - fast, thorough.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Disadvantages: Same as #2 (involves shell commands, potentially SSH
&gt;&gt;&gt;&gt; etc). In addition, since you're likely not going to be running your
&gt;&gt;&gt;&gt; production code on an in-memory back end, this method introduces a
&gt;&gt;&gt;&gt; potential environmental/functional difference between your testing and
&gt;&gt;&gt;&gt; production clusters.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I generally use method #1 in my unit tests, and manually delete each
&gt;&gt;&gt;&gt; key.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Dmitri
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Mon, May 19, 2014 at 8:53 AM, Paweł Królikowski 
&gt;&gt;&gt;&gt; &lt;rabb...@gmail.com&gt;wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; For testing, I'd like to be able to throw a large number of data at
&gt;&gt;&gt;&gt;&gt; Riak (100k+ entries), check how it performed, change something in the
&gt;&gt;&gt;&gt;&gt; application, run the test again. I'd like to use the same data every time,
&gt;&gt;&gt;&gt;&gt; so, I'd like to clear the bucket between every test.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The documentation (
&gt;&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/2.0.0beta1/dev/references/http/">http://docs.basho.com/riak/2.0.0beta1/dev/references/http/</a>) says:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; *Delete Buckets*
&gt;&gt;&gt;&gt;&gt; There is no straightforward way to delete an entire Bucket. To delete
&gt;&gt;&gt;&gt;&gt; all the keys in a bucket, you’ll need to delete them all individually.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; So, I'm currently using something like:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; for k in r_bk.get_keys():
&gt;&gt;&gt;&gt;&gt; v = r_bk.get(k)
&gt;&gt;&gt;&gt;&gt;  if v.exists:
&gt;&gt;&gt;&gt;&gt; r_bk.delete(v)
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The problem is that r_bk.get_keys() returns a lot of elements that
&gt;&gt;&gt;&gt;&gt; don't exist (tombstones?) and iterating over all of them takes time.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Is that the way it's supposed to work? Or am I missing something?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; - I'm using default delete_mode configuration ( 3 seconds )
&gt;&gt;&gt;&gt;&gt; - I'm using Riak 2.0 alpha 19 with Python. ( there's a bug with strong
&gt;&gt;&gt;&gt;&gt; consistency in Beta1, cannot use it)
&gt;&gt;&gt;&gt;&gt; - changing the bucket name for every run seems .. impractical?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Any advices welcomed,
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt; Paweł
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14238.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14239">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14239">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14240.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14230.html">The best (fastest) way to delete/clear a bucket [pytho...</a></span> <span class="sender italic">Paweł Królikowski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14233.html">Re: The best (fastest) way to delete/clear a buck...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14236.html">Re: The best (fastest) way to delete/clear a ...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14238.html">Re: The best (fastest) way to delete/clea...</a></span> <span class="sender italic">Paweł Królikowski</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: The best (fastest) way to delete/...</span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14240.html">Re: The best (fastest) way to de...</a></span> <span class="sender italic">Paweł Królikowski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14241.html">Re: The best (fastest) way t...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14242.html">Re: The best (fastest) w...</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li class="icons-email"><span class="subject"><a href="msg14250.html">Re: The best (fastest) w...</a></span> <span class="sender italic">Paweł Królikowski</span></li>
<li class="icons-email"><span class="subject"><a href="msg14311.html">Re: The best (fastest) w...</a></span> <span class="sender italic">Dave Martorana</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: The best (fastest) way to delete/clear a bucket [python]">
<input type="hidden" name="msgid" value="CA+TO3kXe=n7rAiVGMW7+P=yYwqsPutPg6=i6aDPYvJHJQ2RMJQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14239.html">
<input type="submit" value=" Dmitri Zagidulin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+The+best+%5C%28fastest%5C%29+way+to+delete%5C%2Fclear+a+bucket+%5C%5Bpython%5C%5D%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14238.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14240.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA+TO3kXe=n7rAiVGMW7+P=yYwqsPutPg6=i6aDPYvJHJQ2RMJQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
