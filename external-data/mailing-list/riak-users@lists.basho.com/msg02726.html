<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Multiple disks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02726" id="c">
<link rel="index" href="maillist.html#02726" id="i">
<link rel="prev" href="msg02723.html" id="p">
<link rel="next" href="msg02727.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02726.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Multiple disks</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Nico+Meyer%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Nico Meyer</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110323" rel="nofollow">Wed, 23 Mar 2011 16:56:21 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Greg,

</pre><tt>I don't think the vnodes will always die. I have seen some situations 
</tt><tt>(disk full, filesystem becoming read only due to device errors, 
</tt><tt>corrupted bitcask files after a mashine crash) where the vnode did not 
</tt><tt>crash, but the get and/or put requests returned errors.
</tt><tt>Even if the process crashes, it will just be restarted, possibly over 
</tt><tt>and over again.
</tt><tt>Also, the handoff logic only operates on the level of a whole node, not 
</tt><tt>individual vnodes, which makes monitoring and detecting disk failures 
</tt><tt>very important.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>We were also thinking about how to use multiple disk per node. But its 
</tt><tt>not a very pressing problem for us, since we have a lot of relatively 
</tt><tt>small entries (~1000 bytes), so the RAM used by bitcask is a problem 
</tt><tt>long before we can even fill one disk.
</tt><pre style="margin: 0em;">

Cheers,
Nico


On 23.03.2011 23:50, Greg Nelson wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Joe,

With a few hours of investigation today, your patch is looking
promising. Maybe you can give some more detail on what you did in your
experiments a few months ago?

What I did was set up a Ubuntu VM with three loopback file systems. Then
built Riak 0.14.1 with your patch, configured as you described to spread
across the three disks. I ran a single node, and it correctly spread
partitions across the disks.

I then corrupted the file system on one of the disks (by zeroing out the
loop device), and did some more GETs and PUTs against Riak. In the logs
it looks like the vnode processes that had bitcasks on that disk died,
as expected, and the other vnodes continued to operate.

I need to do a bit more investigation with more than one node, but given
how well it handled this scenario, it seems like we're on the right track.

Oh, one thing I noticed is that while Riak starts up, if there's a bad
disk then it will shutdown (the whole node), at this line:

<a  rel="nofollow" href="https://github.com/jtuple/riak_kv/blob/jdb-multi-dirs/src/riak_kv_bitcask_backend.erl#L103">https://github.com/jtuple/riak_kv/blob/jdb-multi-dirs/src/riak_kv_bitcask_backend.erl#L103</a>

That makes sense, but I'm wondering if it's possible to let the node
start since some of its vnodes would be able to open their bitcasks just
fine. I wonder if it's as simple as removing that line?

Greg

On Tuesday, March 22, 2011 at 9:54 AM, Joseph Blomstedt wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
You're forgetting how awesome riak actually is. Given how riak is
implemented, my patches should work without any operational headaches
at all. Let me explain.

First, there was the one issue from yesterday. My initial patch didn't
reuse the same partition bitcask on the same node. I've fixed that in
a newer commit:
<a  rel="nofollow" href="https://github.com/jtuple/riak_kv/commit/de6b83a4fb53c25b1013f31b8c4172cc40de73ed">https://github.com/jtuple/riak_kv/commit/de6b83a4fb53c25b1013f31b8c4172cc40de73ed</a>

Now, about how this all works in operation.

Let's consider a simple scenario under normal riak. The key concept
here is to realize that riak's vnodes are completely independent, and
that failure and partition ownership changes are handled through
handoff alone.

Let's say we have an 8-partition ring with 3 riak nodes:
n1 owns partitions 1,4,7
n2 owns partitions 2,5,8
n3 owns partitions 3,6
ie: Ring = (0/n1, 1/n2, 2/n3, 3/n1, 4/n2, 5/n3, 6/n1, 7/n2, 8/n3)

Each node runs an independent vnode for each partition it owns, and
each vnode will setup it's own bitcask:

vnode 0/1: {n1-root}/data/bitcask/1
vnode 0/4: {n1-root}/data/bitcask/4
...
vnode 2/2: {n2-root}/data/bitcask/2
...
vnode 3/6: {n3-root}/data/bitcask/6

Reads/writes are routed to the appropriate vnodes and to the
appropriate bitcasks. Under failure, hinted handoff comes into play.

Let's have a write to preflist [1,2,3] while n2 is down/split. Since
n2 is down, riak will send the write meant for partition 2 to another
node, let's say n3. n3 will spawn a new vnode for partition 2 which is
initially empty:

vnode 3/2: {n3-root}/data/bitcask/2

and, write the incoming write to the new bitcask.

Later, when n2 rejoins, n3 will eventually engage in handoff, and send
all (k,v) in its data/bitcask/2 to n2, which writes them into its
data/bitcask/2. After handing off data, n3 will shutdown it's 3/2
vnode and delete the bitcask directory {n3-root}/data/bitcask/2.

Under node rebalancing / ownership changes, a similar event occurs.
For example, if a new node n4 takes ownership of partition 4, then n1
will handoff it's data to n4 and then shutdown its vnode and delete
its {n1-root}/data/bitcask/4.

If you take the above scenario, and change all the directories of the
form:
{NODE-root}/data/bitcask/P
to:
/mnt/DISK-N/NODE/bitcask/P

and allow DISK-N to be any randomly chosen directory in /mnt, then the
scenario plays out exactly the same provided that riak always selects
the same DISK-N for a given P on a given node (across nodes doesn't
matter, vnodes are independent). My new commit handles this. A simple
configuration could be:

n1-vars.config:
{bitcask_data_root, {random, [&quot;/mnt/bitcask/disk1/n1&quot;,
&quot;/mnt/bitcask/disk2/n1&quot;, &quot;/mnt/bitcask/disk3/n1&quot;]}}
n2-vars.config:
{bitcask_data_root, {random, [&quot;/mnt/bitcask/disk1/n2&quot;,
&quot;/mnt/bitcask/disk2/n2&quot;, &quot;/mnt/bitcask/disk3/n2&quot;]}}
(...etc...)

There is no inherent need for symlinks, or needing to pre-create any
initial links per partition index. riak already creates and deletes
partition bitcask directories on demand. If a disk fails, then all
vnodes with bitcasks on that disk fail in the same manner as a disk
failure under normal riak. Standard read repair, handoff, and node
replacement apply.

-Joe

On Tue, Mar 22, 2011 at 9:53 AM, Alexander Sicular &lt;sicul...@gmail.com
&lt;<a  rel="nofollow" href="mailto:sicul...@gmail.com">mailto:sicul...@gmail.com</a>&gt;&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Ya, my original message just highlighted the standard 0,1,5 that most
people/hardware should know/be able to support. There are better
options and
10 would be one of them.


@siculars on twitter
<a  rel="nofollow" href="http://siculars.posterous.com">http://siculars.posterous.com</a>
Sent from my iPhone
On Mar 22, 2011, at 8:43, Ryan Zezeski &lt;rzeze...@gmail.com
&lt;<a  rel="nofollow" href="mailto:rzeze...@gmail.com">mailto:rzeze...@gmail.com</a>&gt;&gt; wrote:



On Tue, Mar 22, 2011 at 10:01 AM, Alexander Sicular
&lt;sicul...@gmail.com &lt;<a  rel="nofollow" href="mailto:sicul...@gmail.com">mailto:sicul...@gmail.com</a>&gt;&gt;
wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Save your ops dudes the headache and just use raid 5 and be done
with it.
</pre></blockquote><pre style="margin: 0em;">

Depending on the number of disks available I might even argue running
software RAID 10 for better throughput and less chance of data loss
(as long
as you can afford to cut your avail storage in half on every
machine). It's
not too hard to setup on modern Linux distros (mdadm); at least I was
doing
it 5 years ago and I'm no sys admin.
-Ryan
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02723.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02726">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02726">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02727.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li><ul>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02695.html">Re: Multiple disks</a></span> <span class="sender italic">Luke Monahan</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg02698.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02699.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02702.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02704.html">Re: Multiple disks</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02705.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02706.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02708.html">Re: Multiple disks</a></span> <span class="sender italic">Les Mikesell</span></li>
<li class="icons-email"><span class="subject"><a href="msg02709.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02723.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Multiple disks</span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg02727.html">Re: Multiple disks</a></span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg02729.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02751.html">Re: Multiple disks</a></span> <span class="sender italic">Dan Reverri</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg02707.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02710.html">Re: Multiple disks</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Multiple disks">
<input type="hidden" name="msgid" value="4D8A889D.7010701@adition.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02726.html">
<input type="submit" value=" Nico Meyer ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02723.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02727.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">4D8A889D.7010701@adition.com</li>
</ul>
</div>
</body>
</html>
