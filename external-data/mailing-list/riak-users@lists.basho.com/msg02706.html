<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Multiple disks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02706" id="c">
<link rel="index" href="maillist.html#02706" id="i">
<link rel="prev" href="msg02705.html" id="p">
<link rel="next" href="msg02708.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02706.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Multiple disks</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joseph+Blomstedt%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joseph Blomstedt</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110322" rel="nofollow">Tue, 22 Mar 2011 09:54:46 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>You're forgetting how awesome riak actually is. Given how riak is
implemented, my patches should work without any operational headaches
at all. Let me explain.</pre><pre>

First, there was the one issue from yesterday. My initial patch didn't
reuse the same partition bitcask on the same node. I've fixed that in
a newer commit:
<a  rel="nofollow" href="https://github.com/jtuple/riak_kv/commit/de6b83a4fb53c25b1013f31b8c4172cc40de73ed">https://github.com/jtuple/riak_kv/commit/de6b83a4fb53c25b1013f31b8c4172cc40de73ed</a>

Now, about how this all works in operation.

Let's consider a simple scenario under normal riak. The key concept
here is to realize that riak's vnodes are completely independent, and
that failure and partition ownership changes are handled through
handoff alone.

Let's say we have an 8-partition ring with 3 riak nodes:
n1 owns partitions 1,4,7
n2 owns partitions 2,5,8
n3 owns partitions 3,6
ie: Ring = (0/n1, 1/n2, 2/n3, 3/n1, 4/n2, 5/n3, 6/n1, 7/n2, 8/n3)

Each node runs an independent vnode for each partition it owns, and
each vnode will setup it's own bitcask:

vnode 0/1: {n1-root}/data/bitcask/1
vnode 0/4: {n1-root}/data/bitcask/4
...
vnode 2/2: {n2-root}/data/bitcask/2
...
vnode 3/6: {n3-root}/data/bitcask/6

Reads/writes are routed to the appropriate vnodes and to the
appropriate bitcasks. Under failure, hinted handoff comes into play.

Let's have a write to preflist [1,2,3] while n2 is down/split. Since
n2 is down, riak will send the write meant for partition 2 to another
node, let's say n3. n3 will spawn a new vnode for partition 2 which is
initially empty:

vnode 3/2: {n3-root}/data/bitcask/2

and, write the incoming write to the new bitcask.

Later, when n2 rejoins, n3 will eventually engage in handoff, and send
all (k,v) in its data/bitcask/2 to n2, which writes them into its
data/bitcask/2. After handing off data, n3 will shutdown it's 3/2
vnode and delete the bitcask directory {n3-root}/data/bitcask/2.

Under node rebalancing / ownership changes, a similar event occurs.
For example, if a new node n4 takes ownership of partition 4, then n1
will handoff it's data to n4 and then shutdown its vnode and delete
its {n1-root}/data/bitcask/4.

If you take the above scenario, and change all the directories of the form:
{NODE-root}/data/bitcask/P
to:
/mnt/DISK-N/NODE/bitcask/P

and allow DISK-N to be any randomly chosen directory in /mnt, then the
scenario plays out exactly the same provided that riak always selects
the same DISK-N for a given P on a given node (across nodes doesn't
matter, vnodes are independent). My new commit handles this. A simple
configuration could be:

n1-vars.config:
{bitcask_data_root, {random, [&quot;/mnt/bitcask/disk1/n1&quot;,
&quot;/mnt/bitcask/disk2/n1&quot;, &quot;/mnt/bitcask/disk3/n1&quot;]}}
n2-vars.config:
{bitcask_data_root, {random, [&quot;/mnt/bitcask/disk1/n2&quot;,
&quot;/mnt/bitcask/disk2/n2&quot;, &quot;/mnt/bitcask/disk3/n2&quot;]}}
(...etc...)

There is no inherent need for symlinks, or needing to pre-create any
initial links per partition index. riak already creates and deletes
partition bitcask directories on demand. If a disk fails, then all
vnodes with bitcasks on that disk fail in the same manner as a disk
failure under normal riak. Standard read repair, handoff, and node
replacement apply.

-Joe

On Tue, Mar 22, 2011 at 9:53 AM, Alexander Sicular &lt;sicul...@gmail.com&gt; wrote:
&gt; Ya, my original message just highlighted the standard 0,1,5 that most
&gt; people/hardware should know/be able to support. There are better options and
&gt; 10 would be one of them.
&gt;
&gt;
&gt; @siculars on twitter
&gt; <a  rel="nofollow" href="http://siculars.posterous.com">http://siculars.posterous.com</a>
&gt; Sent from my iPhone
&gt; On Mar 22, 2011, at 8:43, Ryan Zezeski &lt;rzeze...@gmail.com&gt; wrote:
&gt;
&gt;
&gt;
&gt; On Tue, Mar 22, 2011 at 10:01 AM, Alexander Sicular &lt;sicul...@gmail.com&gt;
&gt; wrote:
&gt;&gt;
&gt;&gt;  Save your ops dudes the headache and just use raid 5 and be done with it.
&gt;&gt;
&gt;
&gt; Depending on the number of disks available I might even argue running
&gt; software RAID 10 for better throughput and less chance of data loss (as long
&gt; as you can afford to cut your avail storage in half on every machine).  It's
&gt; not too hard to setup on modern Linux distros (mdadm); at least I was doing
&gt; it 5 years ago and I'm no sys admin.
&gt; -Ryan

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02705.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02706">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02706">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02708.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02692.html">Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02693.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02694.html">Re: Multiple disks</a></span> <span class="sender italic">Seth Falcon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02695.html">Re: Multiple disks</a></span> <span class="sender italic">Luke Monahan</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg02698.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02699.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02702.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02704.html">Re: Multiple disks</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02705.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Multiple disks</span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02708.html">Re: Multiple disks</a></span> <span class="sender italic">Les Mikesell</span></li>
<li class="icons-email"><span class="subject"><a href="msg02709.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02723.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li class="icons-email"><span class="subject"><a href="msg02726.html">Re: Multiple disks</a></span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg02727.html">Re: Multiple disks</a></span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg02729.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02751.html">Re: Multiple disks</a></span> <span class="sender italic">Dan Reverri</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg02707.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02710.html">Re: Multiple disks</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Multiple disks">
<input type="hidden" name="msgid" value="AANLkTikw5CceKUYKnZZvWCcfpSJiA28v=fii07qsKs3R@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02706.html">
<input type="submit" value=" Joseph Blomstedt ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02705.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02708.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTikw5CceKUYKnZZvWCcfpSJiA28v=fii07qsKs3R@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
