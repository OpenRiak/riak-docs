<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Connection Pooling with the python-riak-client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06383" id="c">
<link rel="index" href="maillist.html#06383" id="i">
<link rel="prev" href="msg06344.html" id="p">
<link rel="next" href="msg06389.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06383.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Connection Pooling with the python-riak-client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Greg+Stein%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Greg Stein</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120123" rel="nofollow">Mon, 23 Jan 2012 19:08:40 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>On Fri, Jan 20, 2012 at 15:53, Michael Clemmons &lt;glassresis...@gmail.com&gt; wrote:
&gt;...
&gt; I've decided to go back and cleanup that approach and reapply it to the
&gt; current master branch.  To my surprise I found that the ConnectionManager
&gt; supports multiple connections and has the tools to add and remove them.
&gt; Looking at the simple case of the RiakHttpTransport layer and the
&gt; http_request method it looks like it should grab a new connection(or an old
&gt; one) and try it and if it fails move on to the next putting the host port
&gt; pair at the bottom of the list.</pre><pre>

Right. That is the intent.

I will note that a failure does not automatically remove a host/port
pair, but fails the particular request (after N retries). I'm not sure
that is entirely &quot;the best strategy&quot; (see below, ref: many
strategies), but the plumbing should be there for applications to
decide the proper behavior. It may be possible to decide a
best/default strategy so that (most) applications do not have to get
involved.

&gt; So it looked like all I needed to do was update the client code to accept a
&gt; list of hostport pairs and it would just work, which sounded too easy to be
&gt; true.  I tested it anyways and if I use one hostport that is a working riak
&gt; node it connects and everything works.  If I include 2 nodes one working and
&gt; one a random port it fails no matter the order.  So its not just trying to
&gt; connect to the first and failing its connecting to them all and failing if
&gt; any fail.

Well, yeah. You started the thing up, saying all the host/port pairs
were proper. It is telling you they are not :-)

One question: when does the failure happen? At instantiation time, or
later at request time? On the first request, or some later request?

(as I recall, it should lazy-open all host/port pairs, so the failure
should not happen until later... and only when the pair is attempted
to be used)

&gt; Anyone have any idea of why its built this way and what other solutions

The overall intent is to connect to (at least) one known working node.
That node can then be queried for &quot;all&quot; other known working nodes,
which are then added into the ConnectionManager (CM). The (long-lived)
process can then continue to monitor the status of the ring and make
corresponding updates to the CM.

The code does not (yet) have a well-defined process for *removal* of
non-working nodes. That is a complex application-level decision.
Should it remove the host/port permanently? If it is just a network
glitch, or the particular host is have transient issues, then maybe
the pair should be kept around (but unused) and re-installed in a
minute or two when the host starts replying again. Maybe you just
remove the pair and wait for a general background monitoring thread to
note their existence and reinstall the pair.

For a single-threaded, short-lived application, the multiple host/port
pair capability is not very useful. That functionality is really
necessary for multiple threads and/or long-lived processes. In this
scenario, as existing connections get used up, the CM will spin up new
connections for threads to use to perform their operations. (the
underlying connections are persistent and reused until the server
decides to close them, where the client will attempt to reopen and
reuse the connection again)

What happens when you give the CM a list of *working* host/port pairs?
Does that still fail for you? It is true that when one goes down, then
some level of the stack should remove the pair, but &quot;which level&quot; just
hasn't been decided.

There is also a &quot;monitor&quot; concept that has been sketched out in the
code, but not implemented. See riak/transports/monitor.py. That should
be used in a long-running application to periodically hit the riak
servers, querying what nodes are in the ring, and adding new ones and
removing broken ones. I sketched it out but neither myself nor anybody
else has further worked on such logic.

&gt; people have worked out on their own?  My intent is to do this so it merges
&gt; cleanly with the current master, and doesn't introduce unnecessary change,
&gt; to increase the likelyhood of a successful pull request.

For production code, some of this host/port pair management needs to
be done. It would be nice to have the monitor (thread) completed, but
that may not be appropriate for your application.

I think that Brett's work on timeouts is necessary for production
code. The key decision point here is Python compatibility support. If
the library requires 2.7, then it should be quite easy to merge his
changes. I think (but don't recall offhand) that the timeout parameter
for HTTPConnection might be available in 2.6, but I definitely know it
is not available for Python 2.5. When I began my work on the client, I
was targeting 2.5 and made many compatibility changes with that in
mind. This was primarily to support my 2.5-based dev environment, even
though I was going to deploy to 2.7. I eventually upgraded my dev
environment, so compatibility isn't a huge concern for me any more. I
would leave that decision to the Basho folks, who are controlling the
decisions and guidance for the client.

Hopefully, that gives you a good background on the current decision
and thoughts around it. I'd be more than happy to elaborate further on
the choices made... please just ask!

Cheers,
-g

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06344.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06383">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06383">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06389.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06342.html">Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06343.html">Re: Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06344.html">Re: Connection Pooling with the python-riak-clie...</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Connection Pooling with the python-riak-client</span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06389.html">Re: Connection Pooling with the python-riak-clie...</a></span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06391.html">Re: Connection Pooling with the python-riak-...</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06393.html">Re: Connection Pooling with the python-r...</a></span> <span class="sender italic">Michael Clemmons</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Connection Pooling with the python-riak-client">
<input type="hidden" name="msgid" value="CABD8fLV5VV+NWj86ghNPBcLTV1UCW0QCrqbZnWP9uQ4P=61cKQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06383.html">
<input type="submit" value=" Greg Stein ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06344.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06389.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABD8fLV5VV+NWj86ghNPBcLTV1UCW0QCrqbZnWP9uQ4P=61cKQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
