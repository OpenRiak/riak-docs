<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak CS/Stanchion troubleshooting (Retrieval of user record)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16811" id="c">
<link rel="index" href="maillist.html#16811" id="i">
<link rel="prev" href="msg16792.html" id="p">
<link rel="next" href="msg16768.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16811.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+CS%5C%2FStanchion+troubleshooting+%5C%28Retrieval+of+user+record%5C%29%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak CS/Stanchion troubleshooting (Retrieval of user record)</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kazuhiro+Suzuki%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kazuhiro Suzuki</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151125" rel="nofollow">Wed, 25 Nov 2015 02:15:58 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

&gt; I think that I need to extend my Riak cluster with more nodes to increase 
&gt; performance.</pre><pre>

It can be a simple solution if your cluster just faced over capacity
on most/all nodes. However, it would be better to make sure a fact by
reading logs, and monitoring system resources.

&gt; I think that it is not haproxy's timeouts issue. Am I right?

It depends on what you want to see in logs. If you prefer to see
obvious timeout error message in logs when a Riak cluster slows down,
you should set client timeout to the same with server timeout. If not,
you will see disconnected error in logs instead of timeout error as
you saw. IIRC, 'cD' in your tcplogs means a haproxy closed connections
due to client timeout.

BTW, haproxy's docs says:

&gt; In TCP mode (and to a lesser extent, in HTTP mode), it is highly recommended 
&gt; that the
&gt; client timeout remains equal to the server timeout in order to avoid complex 
&gt; situations to debug.


&gt; I want to mention again taht I have about 1000 rps to Riak CS, average object 
&gt; size is 10 Kb.

It seems to fit a usecase of Riak, not Riak CS, if you don't need S3
API and multi tenancy. Riak CS is designed for a large object over a
few MB and multi-tenancy, and makes some performance overhead for
achieving the features.


On Thu, Nov 19, 2015 at 8:04 PM, Vladyslav Zakhozhai
&lt;v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt; Hi,
&gt;
&gt; Sorry for my long silence. Kazhuiro thank you for your answer. The situation
&gt; is more clear. I think that I need to extend my Riak cluster with more nodes
&gt; to increase performance. The reason for my opinion is:
&gt;
&gt; Nov 19 11:42:40 localhost haproxy[24678]: 172.18.103.31:49608
&gt; [19/Nov/2015:11:42:40.137] riak riak_backend/viper 3/5/113 1471 --
&gt; 8191/2594/2594/138/0 0/0
&gt; Nov 19 11:42:41 localhost haproxy[24678]: 172.18.108.170:44517
&gt; [19/Nov/2015:11:41:42.264] riak riak_backend/serpent 1/0/58806 5982 cD
&gt; 8191/2849/2849/155/0 0/0
&gt; Nov 19 11:59:46 localhost haproxy[24678]: 172.18.102.39:42919
&gt; [19/Nov/2015:11:42:14.566] riak riak_backend/mussurana 1/0/1052250 1484789
&gt; -- 3134/2888/2888/154/0 0/0
&gt; Nov 19 12:07:26 localhost haproxy[24678]: 172.18.40.2:44946
&gt; [19/Nov/2015:11:42:14.508] riak riak_backend/rattler 1/0/1511814 2471638 cD
&gt; 3172/2888/2888/161/0 0/0
&gt; Nov 19 12:17:56 localhost haproxy[24678]: 172.18.103.30:58654
&gt; [19/Nov/2015:11:42:40.141] riak riak_backend/mamba 3/1/2116572 3383878 cD
&gt; 2988/2886/2886/166/0 0/0
&gt; Nov 19 12:23:55 localhost haproxy[24678]: 172.18.40.4:59089
&gt; [19/Nov/2015:11:41:39.831] riak riak_backend/eggeater 1/0/2535854 4109579 CD
&gt; 3020/2888/2888/153/0 0/0
&gt; Nov 19 12:38:54 localhost haproxy[24678]: 172.18.40.4:37536
&gt; [19/Nov/2015:11:41:47.533] riak riak_backend/cobra 1/0/3427457 3387298 --
&gt; 2983/2886/2886/159/0 0/0
&gt; Nov 19 12:50:37 localhost haproxy[24678]: 172.18.102.39:51870
&gt; [19/Nov/2015:11:41:49.413] riak riak_backend/lora 1/0/4128262 6445878 --
&gt; 2989/2889/2889/164/0 0/0
&gt;
&gt; I think that it is not haproxy's timeouts issue. Am I right?
&gt;
&gt; Regarding to HAProxy config I have the following config for Riak pb:
&gt; frontend riak
&gt;     bind    172.18.108.170:8087
&gt;
&gt;     mode    tcp
&gt;     option  tcplog
&gt;     option  contstats
&gt;
&gt;     timeout client 30s
&gt;
&gt;     default_backend     riak_backend
&gt;
&gt; backend riak_backend
&gt;     mode    tcp
&gt;     balance roundrobin
&gt;     option  tcpka
&gt;     option  srvtcpka
&gt;     option  httpchk GET /ping
&gt;
&gt;     timeout server 60s
&gt;
&gt;     server rinkhals rinkhals.pleiad.uaprom:8087 weight 1 maxconn 1024 check
&gt; port 8090
&gt;     server chuckwalla chuckwalla.pleiad.uaprom:8087 weight 1 maxconn 1024
&gt; check port 8090
&gt;  and so on...
&gt;
&gt; And config for Riak CS:
&gt; frontend riakcs
&gt;     bind    193.34.169.1:80
&gt;     mode    http
&gt;     option  contstats
&gt;     option  httplog
&gt;     option  http-server-close
&gt;     timeout client      30s
&gt;
&gt;     default_backend riakcs_backend
&gt;
&gt; backend riakcs_backend
&gt;     mode http
&gt;     balance roundrobin
&gt;
&gt;     option httpchk GET /riak-cs/ping
&gt;     option redispatch
&gt;     retries 3
&gt;
&gt;     timeout server 60s
&gt;     timeout connect 60s
&gt;     timeout http-request 60s
&gt;
&gt;     server rinkhals rinkhals.pleiad.uaprom:8080 weight 1 maxconn 1024 check
&gt; port 8000
&gt;     server chuckwalla chuckwalla.pleiad.uaprom:8080 weight 1 maxconn 1024
&gt; check port 8000
&gt;     and so on...
&gt;
&gt; And default section:
&gt; defaults
&gt;         log     global
&gt;         option  dontlognull
&gt;         retries 3
&gt;         option redispatch
&gt;         maxconn 8192
&gt;         timeout connect 5000
&gt;         timeout client 4h
&gt;         timeout server 4h
&gt;         balance leastconn
&gt;
&gt; I want to mention again taht I have about 1000 rps to Riak CS, average
&gt; object size is 10 Kb.
&gt;
&gt; Thank you.
&gt;
&gt;
&gt; On Mon, Nov 16, 2015 at 4:01 AM Kazuhiro Suzuki &lt;k...@basho.com&gt; wrote:
&gt;&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; ha_proxy's timeout settings often causes disconnected errors on a Riak
&gt;&gt; CS deployment by high work load. termination_stat [1] in tcplog [2]
&gt;&gt; lets you know if timeout happens or not.
&gt;&gt;
&gt;&gt; &gt; 2015-11-13 13:13:09.514 [error]
&gt;&gt; &gt; &lt;0.11264.1387&gt;@riak_cs_wm_common:maybe_create_user:222 Retrieval of user
&gt;&gt; &gt; record for s3 failed. Reason: disconnected
&gt;&gt;
&gt;&gt; This means Riak CS failed to read a user data from Riak for
&gt;&gt; authentication due to a disconnected error.
&gt;&gt;
&gt;&gt; &gt; Riak CS adds, removes, gets properties through Stanchion service. Am I
&gt;&gt; &gt; right? I can't exactly understand where is my bottleneck - Riak, Riak CS or
&gt;&gt; &gt; Stanchion.
&gt;&gt;
&gt;&gt; Mainly Stanchion is only used to update/delete data of users and
&gt;&gt; buckets. To inspect a node, Riak S2/CS 2.1 introduced new metrics
&gt;&gt; including various latencies and counters, which help to identify
&gt;&gt; bottleneck.
&gt;&gt;
&gt;&gt; &gt; When we need authenticated access for reading object from bucket do we
&gt;&gt; &gt; need Stanchion? If not I can't understand why I had a lot of error during
&gt;&gt; &gt; getting objects from Riak CS.
&gt;&gt;
&gt;&gt; Authenticated access is always necessary but a read request of user
&gt;&gt; data for auth is issued from Riak CS to Riak directly, not through
&gt;&gt; Stanchion.
&gt;&gt;
&gt;&gt; &gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion
&gt;&gt; &gt; connectivity I need to restart Riak CS.
&gt;&gt;
&gt;&gt; Riak CS 1.5.0 has connection pool leak problem [3]. You might hit the
&gt;&gt; issue...
&gt;&gt;
&gt;&gt; [1]: <a  rel="nofollow" href="https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.5">https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.5</a>
&gt;&gt; [2]: <a  rel="nofollow" href="https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.2.2">https://cbonte.github.io/haproxy-dconv/configuration-1.5.html#8.2.2</a>
&gt;&gt; [3]:
&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riakcs/latest/cookbooks/Riak-CS-Release-Notes/#Riak-CS-1-5-2">http://docs.basho.com/riakcs/latest/cookbooks/Riak-CS-Release-Notes/#Riak-CS-1-5-2</a>
&gt;&gt;
&gt;&gt; On Sat, Nov 14, 2015 at 2:04 AM, Vladyslav Zakhozhai
&gt;&gt; &lt;v.zakhoz...@smartweb.com.ua&gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Hello.
&gt;&gt; &gt;
&gt;&gt; &gt; I have Riak CS cluster with 18 nodes. On each node there is Riak CS and
&gt;&gt; &gt; Riak
&gt;&gt; &gt; service and one Stanchion node.
&gt;&gt; &gt;
&gt;&gt; &gt; Versions:
&gt;&gt; &gt; Riak 1.4.12
&gt;&gt; &gt; Riak CS 1.5.0
&gt;&gt; &gt; Stanchion 1.5.0
&gt;&gt; &gt;
&gt;&gt; &gt; Riak CS and Riak allocated behind HAProxy balancers:
&gt;&gt; &gt;
&gt;&gt; &gt; WAN -&gt; HAProxy -&gt; Riak CS nodes -&gt; HAProxy -&gt; Riak nodes.
&gt;&gt; &gt; ans
&gt;&gt; &gt; Stanchion -&gt; HAProxy -&gt; Riak
&gt;&gt; &gt;
&gt;&gt; &gt; Today due a spike of traffic load (about 1000 rps) on the cluster 50% of
&gt;&gt; &gt; Riak CS returned HTTP 500 and 503 (querying /riak-cs/ping resource also
&gt;&gt; &gt; was
&gt;&gt; &gt; not successful).
&gt;&gt; &gt;
&gt;&gt; &gt; In Riak CS logs I've seen the following messages:
&gt;&gt; &gt;
&gt;&gt; &gt; 2015-11-13 13:13:09.514 [error]
&gt;&gt; &gt; &lt;0.11264.1387&gt;@riak_cs_wm_common:maybe_create_user:222 Retrieval of user
&gt;&gt; &gt; record for s3 failed. Reason: disconnected
&gt;&gt; &gt;
&gt;&gt; &gt; In Riak CS logs I see the following:
&gt;&gt; &gt; 2015-11-13 17:31:52.995 [error] &lt;0.11254.6534&gt; Lager event handler
&gt;&gt; &gt; error_logger_lager_h exited with reason
&gt;&gt; &gt;
&gt;&gt; &gt; {'EXIT',{{badmatch,[&quot;/buckets/uaprom-image/objects/272547384_cid1322007_pid183135512-26a7c1f3.jpg&quot;,{error,{error,{badmatch,{error,closed}},[{webmachine_request,recv_unchunked_body,3,[{file,&quot;src/webmachine_request.erl&quot;},{line,471}]},{webmachine_request,call,2,[{file,&quot;src/webmachine_request.erl&quot;},{line,193}]},{wrq,stream_req_body,2,[{file,&quot;src/wrq.erl&quot;},{line,121}]},{riak_cs_wm_object,handle_normal_put,2,[{file,&quot;src/riak_cs_wm_object.erl&quot;},{line,341}]},{riak_cs_wm_common,accept_body,2,[{file,...},...]},...]}},...]},...}}
&gt;&gt; &gt;
&gt;&gt; &gt; I suspect that there were problem between Riak CS - Stanhion or Stanhion
&gt;&gt; &gt; -
&gt;&gt; &gt; Riak. I have no clear idea in Stanchion troubleshooting. The main reason
&gt;&gt; &gt; is
&gt;&gt; &gt; the following. Stanhion works fine, service is up (answers on ping
&gt;&gt; &gt; command).
&gt;&gt; &gt; But it is very laconic: there is almost nothing in console and error
&gt;&gt; &gt; logs
&gt;&gt; &gt; (even with debug log level).
&gt;&gt; &gt;
&gt;&gt; &gt; Riak CS adds, removes, gets properties through Stanchion service. Am I
&gt;&gt; &gt; right? I can't exactly understand where is my bottleneck - Riak, Riak CS
&gt;&gt; &gt; or
&gt;&gt; &gt; Stanhion.
&gt;&gt; &gt;
&gt;&gt; &gt; When we need authenticated access for reading object from bucket do we
&gt;&gt; &gt; need
&gt;&gt; &gt; Stanchion? If not I can't understand why I had a lot of error during
&gt;&gt; &gt; getting
&gt;&gt; &gt; objects from Riak CS.
&gt;&gt; &gt;
&gt;&gt; &gt; Thank you in advance.
&gt;&gt; &gt;
&gt;&gt; &gt; P. S. Sometimes when there is some issues with Riak CS - Stanchion
&gt;&gt; &gt; connectivity I need to restart Riak CS.
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; _______________________________________________
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Kazuhiro Suzuki | Basho Japan KK



-- 
Kazuhiro Suzuki | Basho Japan KK

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16792.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16811">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16811">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16768.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16767.html">Riak CS/Stanchion troubleshooting (Retrieval of user r...</a></span> <span class="sender italic">Vladyslav Zakhozhai</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16770.html">Re: Riak CS/Stanchion troubleshooting (Retrieval ...</a></span> <span class="sender italic">Kazuhiro Suzuki</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16792.html">Re: Riak CS/Stanchion troubleshooting (Retrie...</a></span> <span class="sender italic">Vladyslav Zakhozhai</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak CS/Stanchion troubleshooting (Re...</span> <span class="sender italic">Kazuhiro Suzuki</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak CS/Stanchion troubleshooting (Retrieval of user record)">
<input type="hidden" name="msgid" value="CAKPjYYdmbyO=WpoBpkid_w7zBc23ZBF=OK4-v8HB3Ou4hZBpXA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16811.html">
<input type="submit" value=" Kazuhiro Suzuki ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+CS%5C%2FStanchion+troubleshooting+%5C%28Retrieval+of+user+record%5C%29%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16792.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16768.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAKPjYYdmbyO=WpoBpkid_w7zBc23ZBF=OK4-v8HB3Ou4hZBpXA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
