<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak_core: different types of commands</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06077" id="c">
<link rel="index" href="maillist.html#06077" id="i">
<link rel="prev" href="msg06067.html" id="p">
<link rel="next" href="msg06068.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06077.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak_core%5C%3A+different+types+of+commands%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak_core: different types of commands</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ryan+Zezeski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ryan Zezeski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111227" rel="nofollow">Tue, 27 Dec 2011 09:48:09 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Adam, comments inline.

On Sat, Dec 24, 2011 at 7:04 AM, Adam Schepis &lt;adam.sche...@gmail.com&gt;wrote:
&gt;
&gt;
&gt; What is the difference between the different ways to send a command in
&gt; riak_core_vnode_master?
&gt; - command
&gt; - sync_command
&gt; - sync_spawn_command
&gt;</pre><pre>

A command is async and is typically how a request should arrive at vnode.

The sync_command is the same as command but now the caller (i.e. the caller
of sync_command) will block until a reply is delivered by the vnode.
 Contrary to the comments in the code the master is _not_ blocked by the
reply (possibly a case of code and docs getting out of sync).

The sync_spawn_command, according to the comments, is supposed to be
sync_command but without the side effect of blocking the master.  As I
said, my guess this is historical and docs have not been kept in sync with
code.  The spawn command does two things differently: 1) it spawn_links a
new process and 2) it sends the msg to the vnode via send_all_state_event
which causes the event to be handled by the handle_event callback rather
than the current state (which is moot in riak_core_vnode since there is
only one state).  Looking at Riak I see sync_spawn_command only used it two
places, both in riak_kv_vnode: 1) fold and 2) get_vclocks.  In the case of
fold this is only used by the backup process (all other folds go thru a
different code path).  I see get_vclocks referenced nowhere.  It is my
opinion that this is legacy code that should be removed.


&gt; as far as i can tell, the sync commands will hold up the Sender process
&gt; until the Sender receives a {reply, Whatever, State}, whereas command is
&gt; asynchronous and the Sender won't wait for a result. I returned noreply
&gt; from a handle_command that was called by sync_spawn_command and it hung on
&gt; the Sender side.
&gt;
&gt; Next, when is it appropriate to use reply and noreply in handle_command?
&gt; Does no reply really mean there will never be a reply or just that it may
&gt; come from someone else at a later time (e.g. async call)
&gt;

It is useful to use noreply so that you may offload the request to another
process but at the same time unblock your vnode.  I couldn't quickly find a
good example of this out in the wild, I would have thought listkeys does
something like this but it has it's own machinery which looks new.

It's also used in the case where a reply was already made in some helper
code.  You can see this technique used in the KV_PUT_REQ code of
riak_kv_vnode.

Finally, maybe there is nothing to reply with.


&gt; Finally, what is a Preflist? Is it just the list of preferred vnodes for a
&gt; particular command (e.g. if nothing has crashed, here are the people who
&gt; should see this.)
&gt;

The preference list, or preflist for short, is the preferred vnodes to use
for a given operation.  The notion of &quot;preferred&quot; comes from the idea of
 _the ring_ and that in the best case you want to always send a particular
command to the same vnodes if possible.  If the preferred vnodes aren't
available then you can look further down the list for secondary vnodes to
stand in place while the preferred vnodes are down or unavailable.  If you
look at the core code you'll find the words &quot;primary&quot; and &quot;fallback&quot;

-Ryan
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06067.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06077">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06077">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06068.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06067.html">riak_core: different types of commands</a></span> <span class="sender italic">Adam Schepis</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak_core: different types of commands</span> <span class="sender italic">Ryan Zezeski</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak_core: different types of commands">
<input type="hidden" name="msgid" value="CACZcpekn3ah9zB1RwXsn--rj9Vm9i4OjG5dOSmc6oz1mxomYTg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06077.html">
<input type="submit" value=" Ryan Zezeski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak_core%5C%3A+different+types+of+commands%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06067.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06068.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACZcpekn3ah9zB1RwXsn--rj9Vm9i4OjG5dOSmc6oz1mxomYTg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
