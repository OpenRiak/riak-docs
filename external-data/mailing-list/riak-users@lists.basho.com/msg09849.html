<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Merge On Restarts Only</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09849" id="c">
<link rel="index" href="maillist.html#09849" id="i">
<link rel="prev" href="msg09844.html" id="p">
<link rel="next" href="msg09870.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09849.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Merge+On+Restarts+Only%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Merge On Restarts Only</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Brian+Sparrow%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Brian Sparrow</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130119" rel="nofollow">Sat, 19 Jan 2013 11:02:04 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Ian, 

Q: Why does this happen on a restart only and not at other times, even though 
we have set our merge_window config setting to 'always'?</pre><pre>

A: The merge_window setting defaults to always and that simply means that 
bitcask will merge anytime the merge_triggers and thresholds set in the 
app.config are satisfied on a closed bitcask file. A bitcask data file is 
closed when it reaches the max_file_size threshold set in app.config(default of 
2GB) or the node is stopped. Merging is happening on restart because this file 
is now closed and eligible for merge. You are not seeing merging during normal 
operation because the files are not reaching the 2GB max_file_size.

Q: I'm assuming our config values are correct as the restart considers the 
thresholds met to go ahead with a merge.

A: I do not see anything wrong with your configuration with the exception of no 
max_file_size being set. If you want to merge more often, reduce the max_file 
size to 1GB or lower(the lower the file size, the more merging). A good way to 
estimate the appropriate size is to look at how large your .data files are 
getting in your bitcask data directory and deciding from there what size 
threshold you would like to set based on your disk usage needs.

Q: Also: Are there any tools out there that I can run on my data directory that 
will tell me the size of the dead byte ratios? Would be nice to see what the 
dead byte 'state' of my data dir is in so I can tell whether indeed merge 
conditions are met.

A: The command you are looking for is riak-admin vnode_status. This will list 
all partitions on the local node as well as the number of keys in each 
partition and a list of closed bitcask data files in the format:

{CLOSE_DATA_FILE_NAME, FRAG_PERCENTAGE, DEAD_BYTES, TOTAL_FILE_SIZE}

Again, a data file must be closed(reached max_file_size or closed by node stop) 
to be reported in this command.

Hope this answers all your questions.

Thanks!


-- 
Brian Sparrow
Customer Service Engineer
Basho Technologies


On Friday, January 18, 2013 at 5:14 PM, Ian Ha wrote:

&gt; Hi,
&gt; 
&gt; In our production system, we notice that merges are not taking place. We have 
&gt; noticed, however, that when we restart riak (via a 'riak stop' then a 'riak 
&gt; start'), then the merges are triggered and our disk usage goes way day (which 
&gt; is what we want). We use bitcask. 
&gt; 
&gt; Why does this happen on a restart only and not at other times, even though we 
&gt; have set our merge_window config setting to 'always'?
&gt; 
&gt; I'm assuming our config values are correct as the restart considers the 
&gt; thresholds met to go ahead with a merge. 
&gt; 
&gt; Also: Are there any tools out there that I can run on my data directory that 
&gt; will tell me the size of the dead byte ratios? Would be nice to see what the 
&gt; dead byte 'state' of my data dir is in so I can tell whether indeed merge 
&gt; conditions are met. 
&gt; 
&gt; Our bit cask configs are as follows in app.config:
&gt; 
&gt; {bitcask, [
&gt;                 {data_root, &quot;/var/lib/riak/bitcask&quot;},
&gt;                 {dead_bytes_merge_trigger, 268435456},
&gt;                 {dead_bytes_threshold, 134217728},
&gt;                 {expiry_secs, 3888000},
&gt;                 {frag_merge_trigger, 40},
&gt;                 {frag_threshold, 20},
&gt;                 {merge_window, always},
&gt;                 {small_file_threshold, 10485760},
&gt;                 {sync_strategy, none}
&gt;         ]},
&gt; 
&gt; 
&gt; 
&gt; Thanks! 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 


</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09844.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09849">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09849">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09870.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09844.html">Riak Merge On Restarts Only</a></span> <span class="sender italic">Ian Ha</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Merge On Restarts Only</span> <span class="sender italic">Brian Sparrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09870.html">Re: Riak Merge On Restarts Only</a></span> <span class="sender italic">Ian Ha</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09871.html">Re: Riak Merge On Restarts Only</a></span> <span class="sender italic">Brian Sparrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09872.html">Re: Riak Merge On Restarts Only</a></span> <span class="sender italic">Hector Castro</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Merge On Restarts Only">
<input type="hidden" name="msgid" value="104EB034D66640D3A74075AB159E96ED@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09849.html">
<input type="submit" value=" Brian Sparrow ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Merge+On+Restarts+Only%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09844.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09870.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">104EB034D66640D3A74075AB159E96ED@basho.com</li>
</ul>
</div>
</body>
</html>
