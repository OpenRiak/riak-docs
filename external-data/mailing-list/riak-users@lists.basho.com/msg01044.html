<!DOCTYPE html>
<html lang="en">
<head>
<title>Using Erlang funs for map reduce via the REST API and protocol	buffers client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#01044" id="c">
<link rel="index" href="maillist.html#01044" id="i">
<link rel="prev" href="msg01042.html" id="p">
<link rel="next" href="msg01045.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg01044.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Using+Erlang+funs+for+map+reduce+via+the+REST+API+and+protocol%09buffers+client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Using Erlang funs for map reduce via the REST API and protocol	buffers client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Seth+Falcon%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Seth Falcon</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20100906" rel="nofollow">Mon, 06 Sep 2010 20:57:20 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi all,

I think it would be convenient to be able to specify map and reduce
query phase operations as Erlang funs when using the Erlang protocol
buffer client and when interacting with Riak via its REST API.  Such a
feature would be useful during development and for exploratory queries
when the data in Riak is stored using Erlang's native serialization
format (term_to_binary).  The advantage over {M, F, A} is that you
don't have to get (new) code loaded into each node in your cluster to
execute an Erlang-based query.</pre><pre>

Serializing funs for execution on remote nodes in Erlang is fraught
with subtlety -- certainly not all funs can be used in this fashion.
An alternative is to specify the source for a fun as a string and
evaluate it on a remote node to obtain a fun -- just as is done for
Javascript functions specified in the REST API.

As an experiment, I put together a patch for riak_kv that adds a new
FunTerm type for a Query:

%%&lt;li&gt;  {strfun, Fun} : Fun is a string (list or binary)
%%         containing the definition of an anonymous
%%         Erlang function.&lt;/li&gt;

With these changes (code link below), you can do the following using
the pb client:

Mapper = &quot;fun(G, _X, _Y) -&gt;
  O = riak_object:get_value(G),
  [proplists:get_value(blah, O)]
 end.&quot;.

riakc_pb_socket:mapred(Pid, Input, [{map, {strfun, Mapper}, unset, true}]).

Along similar lines, the changes allow Erlang funs to be specified in
the REST API:

{&quot;reduce&quot;:{&quot;language&quot;:&quot;erlang&quot;,
                &quot;source&quot;:&quot;
fun(ValueList, _Arg) -&gt;
  [lists:foldl(fun erlang:'+'/2, 0, ValueList)]
end.&quot;,
&quot;keep&quot;:true}}


If there is interest, I'd be willing to cleanup/enhance the patch for
inclusion.  I wanted to get some feedback before spending any more
time on it -- perhaps there are other issues with this approach that
I'm not aware of or a more elegant solution...

BTW, the inspiration for the approach came from this post by the
Erjang developer:
<a  rel="nofollow" href="http://www.javalimit.com/2010/05/passing-funs-to-other-erlang-nodes.html">http://www.javalimit.com/2010/05/passing-funs-to-other-erlang-nodes.html</a>

The code is here: <a  rel="nofollow" href="http://github.com/seth/riak_kv">http://github.com/seth/riak_kv</a>


+ seth

-- 
Seth Falcon | @sfalcon | <a  rel="nofollow" href="http://userprimary.net/">http://userprimary.net/</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg01042.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#01044">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#01044">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg01045.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">

</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Using Erlang funs for map reduce via the REST API and protocol	buffers client">
<input type="hidden" name="msgid" value="AANLkTimVbe78RggUQcd3-cc6M46nRmZ2rAnp_q5T-eKH@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg01044.html">
<input type="submit" value=" Seth Falcon ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Using+Erlang+funs+for+map+reduce+via+the+REST+API+and+protocol%09buffers+client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg01042.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg01045.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTimVbe78RggUQcd3-cc6M46nRmZ2rAnp_q5T-eKH@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
