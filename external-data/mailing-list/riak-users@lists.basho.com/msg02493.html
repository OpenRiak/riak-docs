<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Inconsistent data when a node goes down</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02493" id="c">
<link rel="index" href="maillist.html#02493" id="i">
<link rel="prev" href="msg02492.html" id="p">
<link rel="next" href="msg02494.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02493.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Inconsistent+data+when+a+node+goes+down%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Inconsistent data when a node goes down</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Dan+Reverri%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Dan Reverri</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110228" rel="nofollow">Mon, 28 Feb 2011 13:38:11 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Luca,

For any request Riak will ask 3 vnodes for an object's value (assuming N=3).
If a majority of vnodes return &quot;not found&quot;, Riak will return &quot;not found&quot; to
the client. When a node is taken down other nodes can act as a fallback for
that node. When a fallback node takes over for a primary node it will not
immediately be aware of the objects for which the primary node is
responsible. This means that the fallback node can return not found for some
objects. Read repair will eventually populate the fallback node with any
missing data:
<a  rel="nofollow" href="https://wiki.basho.com/Riak-Glossary.html#Read-Repair">https://wiki.basho.com/Riak-Glossary.html#Read-Repair</a></pre><pre>

In your situation, the majority of vnodes responding for the &quot;not found&quot;
objects are fallback vnodes that are not yet aware of the objects for which
it is responsible. After your script reads the &quot;not found&quot; objects the read
repair mechanism populates the fallback vnodes. Subsequent reads on the
fallback vnodes will return the object. Also note that this behavior is
observed even with R=1 because of a process known as basic quorum. Basic
quorum assumes that if a majority of nodes returns &quot;not found&quot; it is likely
the object does not exist and will not wait for the third vnode to respond.
Bug 992 has been opened to investigate improving this behavior:
<a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=992">https://issues.basho.com/show_bug.cgi?id=992</a>

Let me know if that makes sense.

Thanks,
Dan

Daniel Reverri
Developer Advocate
Basho Technologies, Inc.
d...@basho.com


On Mon, Feb 28, 2011 at 12:48 PM, Alexander Sicular &lt;sicul...@gmail.com&gt;wrote:

&gt; I think it has to do with how the vnodes are partitioned against your
&gt; physical nodes. You really need a minimum of three physical nodes (or
&gt; virtual machines) to deploy and or do any failure testing.
&gt;
&gt; -Alexander
&gt;
&gt; On Mon, Feb 28, 2011 at 13:29, Luca Spiller &lt;l...@stackednotion.com&gt;
&gt; wrote:
&gt; &gt; Hi all,
&gt; &gt;
&gt; &gt; I've come across some issues while testing what happens when failures
&gt; happen
&gt; &gt; on our system, for example a machine failing. One of the (slightly scary)
&gt; &gt; issues I have come across is for a short while when a Riak node goes
&gt; down,
&gt; &gt; data that is read from another node isn't always consistent. I have
&gt; written
&gt; &gt; a small test script to demonstrate this issue:
&gt; &gt;
&gt; &gt; <a  rel="nofollow" href="https://gist.github.com/847749">https://gist.github.com/847749</a>
&gt; &gt; Halfway through I switch off a node; here are the results:
&gt; &gt;
&gt; &gt; Deleted 0
&gt; &gt; Wrote 100 454551
&gt; &gt; 1298916758: 100 454551
&gt; &gt; 1298916759: 100 454551
&gt; &gt; 1298916760: 100 454551
&gt; &gt; 1298916761: 100 454551
&gt; &gt; 1298916762: 100 454551
&gt; &gt; 1298916762: 100 454551
&gt; &gt; 1298916763: 100 454551
&gt; &gt; 1298916764: 100 454551  (Shutdown around here)
&gt; &gt; 1298916765: 100 454551
&gt; &gt; 1298916766: 99 460532
&gt; &gt; 1298916767: 91 412241
&gt; &gt; 1298916768: 100 454551
&gt; &gt; 1298916769: 100 454551
&gt; &gt; 1298916770: 100 454551
&gt; &gt; 1298916771: 100 454551
&gt; &gt; 1298916772: 100 454551
&gt; &gt; 1298916773: 100 454551
&gt; &gt; 1298916774: 100 454551
&gt; &gt; 1298916775: 100 454551
&gt; &gt; 1298916776: 100 454551
&gt; &gt; 1298916777: 100 454551
&gt; &gt; ^C1298916777: 100 454551
&gt; &gt; Deleted 100
&gt; &gt;
&gt; &gt; Slightly more scary is that it appears to sometimes read old (deleted)
&gt; data:
&gt; &gt;
&gt; &gt; Deleted 0
&gt; &gt; Wrote 100 495792
&gt; &gt; 1298916784: 100 495792
&gt; &gt; 1298916785: 100 495792
&gt; &gt; 1298916786: 100 495792
&gt; &gt; 1298916786: 100 495792  (Shutdown around here)
&gt; &gt; 1298916787: 100 495792
&gt; &gt; 1298916788: 100 487322
&gt; &gt; 1298916789: 100 495792
&gt; &gt; 1298916790: 100 495792
&gt; &gt; 1298916791: 100 495792
&gt; &gt; 1298916792: 100 495792
&gt; &gt; 1298916793: 100 495792
&gt; &gt; 1298916794: 100 495792
&gt; &gt; 1298916795: 100 495792
&gt; &gt; ^C1298916796: 100 495792
&gt; &gt; 1298916797: 100 495792
&gt; &gt; Deleted 100
&gt; &gt;
&gt; &gt; This is using the Ripple library (0.8.3) talking directly to the local
&gt; node,
&gt; &gt; however I believe the same problem is happening when using the Erlang PBC
&gt; &gt; library. This problem seems to be exacerbated when there are larger
&gt; amounts
&gt; &gt; of data being stored in Riak, and the eventual consistency takes longer
&gt; to
&gt; &gt; occur.
&gt; &gt; I am quite puzzled as to why this is happening, I could kind of
&gt; understand
&gt; &gt; if data went missing, but the eventual consistency is what puzzles me, I
&gt; &gt; only have two nodes, so why does the data eventually sort itself out?
&gt; &gt; Secondly why does this still happen even with W and DW set to 3
&gt; &gt; (I originally had the script using the default values, but thought I
&gt; would
&gt; &gt; try this)?
&gt; &gt; Both of the nodes are running Riak 0.14.0, here are the relavent configs:
&gt; &gt; <a  rel="nofollow" href="https://gist.github.com/847756">https://gist.github.com/847756</a>
&gt; &gt; Apologies if I am just doing something stupid, it has been a rather long
&gt; day
&gt; &gt; :)
&gt; &gt; Regards,
&gt; &gt; Luca Spiller
&gt; &gt; _______________________________________________
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt;
&gt; &gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02492.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02493">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02493">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02494.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02491.html">Inconsistent data when a node goes down</a></span> <span class="sender italic">Luca Spiller</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02492.html">Re: Inconsistent data when a node goes down</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Inconsistent data when a node goes down</span> <span class="sender italic">Dan Reverri</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Inconsistent data when a node goes down">
<input type="hidden" name="msgid" value="AANLkTikPDbTAwsearxnw-aZ9J4Ovc2hf1M+wsW9121Zh@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02493.html">
<input type="submit" value=" Dan Reverri ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Inconsistent+data+when+a+node+goes+down%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02492.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02494.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTikPDbTAwsearxnw-aZ9J4Ovc2hf1M+wsW9121Zh@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
