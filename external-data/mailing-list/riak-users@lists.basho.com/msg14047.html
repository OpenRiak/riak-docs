<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Rebuilding AAE hashes - small question</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14047" id="c">
<link rel="index" href="maillist.html#14047" id="i">
<link rel="prev" href="msg14041.html" id="p">
<link rel="next" href="msg14050.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14047.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Rebuilding+AAE+hashes+%5C-+small+question%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Rebuilding AAE hashes - small question</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Engel+Sanchez%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Engel Sanchez</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140410" rel="nofollow">Thu, 10 Apr 2014 06:24:08 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey there. There are a couple of things to keep in mind when deleting
invalid AAE trees from the 1.4.3-1.4.7 series after upgrading to 1.4.8:</pre><pre>

* If AAE is disabled, you don't have to stop the node to delete the data in
the anti_entropy directories
* If AAE is enabled, deleting the AAE data in a rolling manner may trigger
an avalanche of read repairs between nodes with the bad trees and nodes
with good trees as the data seems to diverge.

If your nodes are already up, with AAE enabled and with old incorrect trees
in the mix, there is a better way.  You can dynamically disable AAE with
some console commands. At that point, without stopping the nodes, you can
delete all AAE data across the cluster.  At a convenient time, re-enable
AAE.  I say convenient because all trees will start to rebuild, and that
can be problematic in an overloaded cluster.  Doing this over the weekend
might be a good idea unless your cluster can take the extra load.

To dynamically disable AAE from the Riak console, you can run this command:

&gt; riak_core_util:rpc_every_member_ann(riak_kv_entropy_manager, disable, [],
60000).

and enable with the similar:

&gt; riak_core_util:rpc_every_member_ann(riak_kv_entropy_manager, enable, [],
60000).

That last number is just a timeout for the RPC operation.  I hope this
saves you some extra load on your clusters.


On Wed, Apr 9, 2014 at 11:02 AM, Luke Bakken &lt;lbak...@basho.com&gt; wrote:

&gt; Hi Guido,
&gt;
&gt; I specifically meant riak-admin transfers however using riak-admin
&gt; wait-for-service riak_kv riak@node is a good first step before waiting
&gt; for transfers.
&gt;
&gt; Thanks!
&gt;
&gt; --
&gt; Luke Bakken
&gt; CSE
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Wed, Apr 9, 2014 at 7:54 AM, Guido Medina &lt;guido.med...@temetra.com&gt;wrote:
&gt;
&gt;&gt;  What do you mean by &quot;wait for handoff&quot; to finish?
&gt;&gt;
&gt;&gt; Are you referring to wait for the service to be fully started? i.e.
&gt;&gt; &quot;riak-admin wait-for-service riak_kv riak@node&quot;
&gt;&gt;
&gt;&gt; Or do you mean to check for &quot;riak-admin transfers&quot; on the started node
&gt;&gt; and wait until those handoffs/transfers are gone?
&gt;&gt;
&gt;&gt; Guido.
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On 09/04/14 15:46, Luke Bakken wrote:
&gt;&gt;
&gt;&gt; Hi Guido,
&gt;&gt;
&gt;&gt;  That is the correct process. Be sure to use the rolling restart
&gt;&gt; procedure when restarting nodes (i.e. wait for handoff to finish before
&gt;&gt; moving on).
&gt;&gt;
&gt;&gt; --
&gt;&gt; Luke Bakken
&gt;&gt; CSE
&gt;&gt; lbak...@basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Apr 9, 2014 at 6:34 AM, Guido Medina &lt;guido.med...@temetra.com&gt;wrote:
&gt;&gt;
&gt;&gt;&gt;  Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; If nodes are already upgraded to 1.4.8 (and they went all the way from
&gt;&gt;&gt; 1.4.0 to 1.4.8 including AAE buggy versions)
&gt;&gt;&gt;
&gt;&gt;&gt; Will the following command (as root) on Ubuntu Servers 12.04:
&gt;&gt;&gt;
&gt;&gt;&gt; riak stop; rm -Rf /var/lib/riak/anti_entropy/*; riak start
&gt;&gt;&gt;
&gt;&gt;&gt; executed on each node be enough to rebuild AAE hashes?
&gt;&gt;&gt;
&gt;&gt;&gt; Regards,
&gt;&gt;&gt;
&gt;&gt;&gt; Guido.
&gt;&gt;&gt;
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14041.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14047">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14047">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14050.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14038.html">Rebuilding AAE hashes - small question</a></span> <span class="sender italic">Guido Medina</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14039.html">Re: Rebuilding AAE hashes - small question</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14040.html">Re: Rebuilding AAE hashes - small question</a></span> <span class="sender italic">Guido Medina</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14041.html">Re: Rebuilding AAE hashes - small question</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Rebuilding AAE hashes - small questio...</span> <span class="sender italic">Engel Sanchez</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14050.html">Re: Rebuilding AAE hashes - small qu...</a></span> <span class="sender italic">Guido Medina</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg14058.html">Re: Rebuilding AAE hashes - small question</a></span> <span class="sender italic">Timo Gatsonides</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Rebuilding AAE hashes - small question">
<input type="hidden" name="msgid" value="CABx-oYwBzo-wNGNLCoJSijNwqR3WjK=apfgJo495D1-F9Ug38w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14047.html">
<input type="submit" value=" Engel Sanchez ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Rebuilding+AAE+hashes+%5C-+small+question%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14041.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14050.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABx-oYwBzo-wNGNLCoJSijNwqR3WjK=apfgJo495D1-F9Ug38w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
