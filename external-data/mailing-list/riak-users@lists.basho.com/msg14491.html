<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak handoffs stalled</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14491" id="c">
<link rel="index" href="maillist.html#14491" id="i">
<link rel="prev" href="msg14490.html" id="p">
<link rel="next" href="msg14492.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14491.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+handoffs+stalled%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak handoffs stalled</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22%D0%9B%D0%B5%D0%BE%D0%BD%D0%B8%D0%B4+%D0%A0%D1%8F%D0%B1%D0%BE%D1%88%D1%82%D0%B0%D0%BD%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Леонид Рябоштан</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140714" rel="nofollow">Mon, 14 Jul 2014 05:35:29 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hello,

riak version is 1.1.4-1. We set transfer limit in config made it equal to 4.</pre><pre>

I don't think we have riak-admin transfer-limit or riak-admin cluster plan.

The problem is that damn nodes can't pass partition between each other,
probably because they're too big. Each 5k files(leveldb backend) and
weights 10GB each. There're no problems with smaller partitions. We can't
find anything usefull on handoff fail in riak or system logs. Seems like
ulimit and erlang ports are way higher, we increased it 4 times today.

It begins like:
2014-07-14 12:22:45.518 UTC [info]
&lt;0.10544.0&gt;@riak_core_handoff_sender:start_fold:83 Starting handoff of
partition riak_kv_vnode 68507889249886074290797726533575766546371837952
from 'riak@192.168.153.182' to 'riak@192.168.164.133'

And ends like:
2014-07-14 08:43:28.829 UTC [error]
&lt;0.2264.0&gt;@riak_core_handoff_sender:start_fold:152 Handoff of partition
riak_kv_vnode 68507889249886074290797726533575766546371837952 from '
riak@192.168.153.182' to 'riak@192.168.164.133' FAILED after sending
1318000 objects in 1455.15 seconds: closed
2014-07-14 10:40:18.294 UTC [error]
&lt;0.11555.0&gt;@riak_core_handoff_sender:start_fold:152 Handoff of partition
riak_kv_vnode 68507889249886074290797726533575766546371837952 from '
riak@192.168.153.182' to 'riak@192.168.164.133' FAILED after sending 911000
objects in 2734.48 seconds: closed
2014-07-14 09:43:43.197 UTC [error]
&lt;0.26922.2&gt;@riak_core_handoff_sender:start_fold:152 Handoff of partition
riak_kv_vnode 68507889249886074290797726533575766546371837952 from '
riak@192.168.153.182' to 'riak@192.168.164.133' FAILED after sending 32000
objects in 963.06 seconds: timeout

Maybe we need to check something else on target node? Actually it always
runs in GC problems:
2014-07-14 12:30:03.579 UTC [info]
&lt;0.99.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor long_gc &lt;0.468.0&gt;
[{initial_call,{riak_kv_js_vm,init,1}},{almost_current_function,{xmerl_ucs,expand_utf8_1,3}},{message_queue_len,0}]
[{timeout,118},{old_heap_block_size,0},{heap_block_size,196418},{mbuf_size,0},{stack_size,45},{old_heap_size,0},{heap_size,136165}]
2014-07-14 12:30:44.386 UTC [info]
&lt;0.99.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor long_gc &lt;0.713.0&gt;
[{initial_call,{riak_core_vnode,init,1}},{almost_current_function,{gen_fsm,loop,7}},{message_queue_len,0}]
[{timeout,126},{old_heap_block_size,0},{heap_block_size,1597},{mbuf_size,0},{stack_size,38},{old_heap_size,0},{heap_size,658}]

Probably we have some CPU issues here, but node is not under load currently.

Thank you,
Leonid


2014-07-14 16:11 GMT+04:00 Ciprian Manea &lt;cipr...@basho.com&gt;:

&gt; Hi Leonid,
&gt;
&gt; Which Riak version are you running?
&gt;
&gt; Have you committed* the cluster plan after issuing the cluster
&gt; force-remove &lt;node&gt; commands?
&gt;
&gt; What is the output of $ riak-admin transfer-limit, ran from one of your
&gt; riak nodes?
&gt;
&gt;
&gt; *Do not run this command yet if you have not done it already.
&gt; Please run a riak-admin cluster plan and attach its output here.
&gt;
&gt;
&gt; Thanks,
&gt; Ciprian
&gt;
&gt;
&gt; On Mon, Jul 14, 2014 at 2:41 PM, Леонид Рябоштан &lt;
&gt; leonid.riabosh...@twiket.com&gt; wrote:
&gt;
&gt;&gt; Hello, guys,
&gt;&gt;
&gt;&gt; It seems like we ran into emergency. I wonder if there can be any help on
&gt;&gt; that.
&gt;&gt;
&gt;&gt; Everything that happened below was because we were trying to rebalace
&gt;&gt; space used by nodes that we running out of space.
&gt;&gt;
&gt;&gt; Cluster is 7 machines now, member_status looks like:
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; ================================= Membership
&gt;&gt; ==================================
&gt;&gt; Status     Ring    Pending    Node
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; valid      15.6%     20.3%    'riak@192.168.135.180'
&gt;&gt; valid       0.0%      0.0%    'riak@192.168.152.90'
&gt;&gt; valid       0.0%      0.0%    'riak@192.168.153.182'
&gt;&gt; valid      26.6%     23.4%    'riak@192.168.164.133'
&gt;&gt; valid      27.3%     21.1%    'riak@192.168.177.36'
&gt;&gt; valid       8.6%     15.6%    'riak@192.168.194.138'
&gt;&gt; valid      21.9%     19.5%    'riak@192.168.194.149'
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; Valid:7 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt;&gt;
&gt;&gt; 2 nodes with 0 Ring was made to force leave the cluster, they have plenty
&gt;&gt; of data on them which is now seems to be not accessible. Handoffs are stuck
&gt;&gt; it seems. Node 'riak@192.168.152.90'(is in same situation as '
&gt;&gt; riak@192.168.153.182') tries to handoff partitions to '
&gt;&gt; riak@192.168.164.133' but fails for unknown reason after huge
&gt;&gt; timeouts(from 5 to 40 minutes). Partition it's trying to move is about 10Gb
&gt;&gt; in size. It grows slowly on target node, but probably it's just usual
&gt;&gt; writes from normal operation. It doesn't get any smaller on source node.
&gt;&gt;
&gt;&gt; I wonder is there any way to let cluster know that we want those nodes to
&gt;&gt; be actually members of source node and there's no actual need to transfer
&gt;&gt; them? How to redo cluster ownership balance? Revert this force-leave stuff.
&gt;&gt;
&gt;&gt; Thank you,
&gt;&gt; Leonid
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14490.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14491">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14491">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14492.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14489.html">riak handoffs stalled</a></span> <span class="sender italic">Леонид Рябоштан</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14490.html">Re: riak handoffs stalled</a></span> <span class="sender italic">Ciprian Manea</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak handoffs stalled</span> <span class="sender italic">Леонид Рябоштан</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14492.html">Re: riak handoffs stalled</a></span> <span class="sender italic">Ciprian Manea</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak handoffs stalled">
<input type="hidden" name="msgid" value="CAPPe8QY471qu0KwdYY8B9_E6rno3nMYvoZs6b_dWeWzZU_F7RQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14491.html">
<input type="submit" value=" Леонид Рябоштан ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+handoffs+stalled%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14490.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14492.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAPPe8QY471qu0KwdYY8B9_E6rno3nMYvoZs6b_dWeWzZU_F7RQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
