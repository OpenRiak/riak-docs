<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14735" id="c">
<link rel="index" href="maillist.html#14735" id="i">
<link rel="prev" href="msg14733.html" id="p">
<link rel="next" href="msg14712.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14735.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Fwd%5C%3A+RiakCS+504+Timeout+on+s3cmd+for+certain+keys%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kelly+McLaughlin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kelly McLaughlin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140819" rel="nofollow">Tue, 19 Aug 2014 09:29:22 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Alex,

</pre><tt>The value you had set for the fold_objects_for_list_keys setting is one 
</tt><tt>I was very interested to see and I highly recommend setting it to true 
</tt><tt>for your cluster.
</tt><tt>The impact of setting this to true should be to make bucket listing 
</tt><tt>operations generally more efficient. There should be no detrimental 
</tt><tt>effects. There are
</tt><tt>also some optimizations for bucket listing queries that use the prefix 
</tt><tt>request parameter so I would expect queries to list specific 
</tt><tt>subdirectories in a bucket to
</tt><tt>show improved perforamnce as well. Changing the app.config and 
</tt><tt>restarting the CS node is the correct way to have it take effect.
</tt><pre style="margin: 0em;"></pre><pre>


</pre><tt>As for GC performance, I would recommend to add an entry to your 
</tt><tt>app.config file to se||||t gc_paginated_indexes to true. This option 
</tt><tt>causes the GC process
</tt><tt>to use a more efficient process for determining data that is eligible 
</tt><tt>for collection and generally results in far fewer timeouts and better 
</tt><tt>success for
</tt><pre style="margin: 0em;">
users.


Kelly

On 08/19/2014 07:32 AM, Alex Millar wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hey Kota,

We’re currently using the following versions;

# Download RiakCS
# Version: 1.4.5
# OS: Ubuntu 12.04 (Precise) AMD 64
</pre><tt>curl -O 
</tt><tt><a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak-cs/1.4/1.4.5/ubuntu/precise/riak-cs_1.4.5-1_amd64.deb</a>
</tt><pre style="margin: 0em;">

# Download Riak
# Version: 1.4.8
# OS: Ubuntu 12.04 (Precise) AMD 64
</pre><tt>curl -O 
</tt><tt><a  rel="nofollow" href="http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb">http://s3.amazonaws.com/downloads.basho.com/riak/1.4/1.4.8/ubuntu/precise/riak_1.4.8-1_amd64.deb</a>
</tt><pre style="margin: 0em;">

</pre><tt>I checked our RiakCS app.config and fold_objects_for_list_keys is set 
</tt><tt>to false. What impact would it have my cluster if I flip that to true? 
</tt><tt>Would I simply update the app.config and restart RiakCS?
</tt><pre style="margin: 0em;">

</pre><tt>As for the consideration on garbage collection, the slow performance 
</tt><tt>is happening consistently over the span of a week (since we noticed it 
</tt><tt>as we don’t often list buckets). I suspect its not the case regarding 
</tt><tt>large amounts of objects being deleted as generally all data going 
</tt><tt>into that bucket is write-once (we process PDFs pages to .JPG and PUT 
</tt><tt>them in that bucket, the only time overwrites occur is if we manually 
</tt><tt>re-trigger the processing script to run on a specific document)
</tt><pre style="margin: 0em;">

</pre><tt>*Adding ke...@basho.com* as we have another thread going on about this 
</tt><tt>same topic, I figured we could merge the discussion to reduce 
</tt><tt>duplicate effort here.
</tt><pre style="margin: 0em;">

Bonfire Logo    *Alex Millar*, CTO
Office: 1-800-354-8010 ext. 704 &lt;tel:+18003548010&gt;
Mobile: 519-729-2539 &lt;tel:+15197292539&gt;
*GoBonfire*.com &lt;<a  rel="nofollow" href="http://GoBonfire.com">http://GoBonfire.com</a>&gt;


From: Kota Uenishi &lt;k...@basho.com&gt; &lt;<a  rel="nofollow" href="mailto:k...@basho.com">mailto:k...@basho.com</a>&gt;
Reply: Kota Uenishi &lt;k...@basho.com&gt;&gt; &lt;<a  rel="nofollow" href="mailto:k...@basho.com">mailto:k...@basho.com</a>&gt;
Date: August 18, 2014 at 10:03:40 PM
To: Alex Millar &lt;a...@gobonfire.com&gt;&gt; &lt;<a  rel="nofollow" href="mailto:a...@gobonfire.com">mailto:a...@gobonfire.com</a>&gt;
</pre><tt>Cc: Charlie Voiselle &lt;cvoise...@basho.com&gt;&gt; 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:cvoise...@basho.com">mailto:cvoise...@basho.com</a>&gt;, Tad Bickford &lt;tbickf...@basho.com&gt;&gt; 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:tbickf...@basho.com">mailto:tbickf...@basho.com</a>&gt;, Riak-Users &lt;riak-users@lists.basho.com&gt;&gt; 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;, Brandon Noad 
</tt><tt>&lt;bran...@gobonfire.com&gt;&gt; &lt;<a  rel="nofollow" href="mailto:bran...@gobonfire.com">mailto:bran...@gobonfire.com</a>&gt;
</tt><pre style="margin: 0em;">
Subject: Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Alex,

</pre><tt>Riak CS 1.4.5 and 1.5.0 had a lot of improvement after those articles 
</tt><tt>you put the URL, not it is not using Riak's bucket listing but using 
</tt><tt>Riak's internal API for more efficient listing. What version of Riak 
</tt><tt>CS are you using? I want you to make sure you're using those versions 
</tt><tt>and a line `{fold_objects_for_list_keys, true},` at riak_cs section 
</tt><tt>of app.config (assuming all other Riak part correctly configured).
</tt><pre style="margin: 0em;">

</pre><tt>&gt;Based on this I’m thinking that cost of this type of query is only 
</tt><tt>going to get worse over time as we add more keys to this bucket 
</tt><tt>(unless secondary indexes can be added). Or am I totally out to lunch 
</tt><tt>here and there’s some other underlying problem?
</tt><pre style="margin: 0em;">

</pre><tt>The strange part is s3cmd. Riak CS has incremental bucket listing API 
</tt><tt>that requires clients to iterate on every 1000 objects (common 
</tt><tt>prefixes), but s3cmd iterates all the specified bucket before 
</tt><tt>printing them all. You can observe how s3cmd and Riak CS interacts if 
</tt><tt>you specify '-d' option like this:
</tt><pre style="margin: 0em;">

```
s3cmd -d -c yours.s3cfg ls -r s3://yourbucket/yourdir/
```

</pre><tt>I would expect Riak CS's listing API is not much slow  as to need 5 
</tt><tt>seconds (or, say, &gt;10 seconds) because, on each request it just 
</tt><tt>returns 1000 objects.
</tt><pre style="margin: 0em;">

</pre><tt>There might be another possibility on slow query - if you had many 
</tt><tt>(say, more than 10 thousands) deleted objects on the same bucket it 
</tt><tt>might affect each 1000 listing. This will eventually be solved as 
</tt><tt>Riak CS's garbage collection removes deleted manifests, which is just 
</tt><tt>marked as deleted (and to be ignored correctly).
</tt><pre style="margin: 0em;">

</pre><tt>[1] 
</tt><tt><a  rel="nofollow" href="http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why">http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why</a>
</tt><pre style="margin: 0em;">

</pre><tt>On Thu, Aug 14, 2014 at 6:05 AM, Alex Millar &lt;a...@gobonfire.com 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:a...@gobonfire.com">mailto:a...@gobonfire.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

    Good afternoon Charlie,

    So the issue we’re having is only with bucket listing.

    alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls
    s3://bonfirehub-resources-can-east-doc-conversion
           DIR
    s3://bonfirehub-resources-can-east-doc-conversion/organizations/

    real 2m0.747s
    user 0m0.076s
    sys 0m0.030s

    where as…

    alxndrmlr@alxndrmlr-mbp $ time s3cmd -c .s3cfg-riakcs-admin ls
    
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals
           DIR
    
s3://bonfirehub-resources-can-east-doc-conversion/organizations/OrganizationID-1/documents/proposals/

    real 0m10.262s
    user 0m0.075s
    sys 0m0.028s

    The contents of this bucket contains a lot of very small files
    (basically for each PDF we receive I split it to .JPG foreach
    page and store them here. Based on the my latest counts it looks
    like we have around *170,000* .JPG files in that bucket.

    Here’s a snippet from the HAProxy log for the 504 timeouts…

    Aug 12 16:01:34
    &lt;<a  rel="nofollow" href="http://airmail.calendar/2014-08-12%2016:01:34%20EDT">http://airmail.calendar/2014-08-12%2016:01:34%20EDT</a>&gt; localhost.localdomain
    haproxy[4718]: 192.0.223.236:48457 &lt;<a  rel="nofollow" href="http://192.0.223.236:48457">http://192.0.223.236:48457</a>&gt;
    [12/Aug/2014:16:01:24.454] riak_cs~ riak_cs_backend/riak3
    161/0/0/-1/10162 504 194 - - sH-- 0/0/0/0/0 0/0
    {bonfirehub-resources-can-east-doc-conversion.bf-riakcs.com
    &lt;<a  rel="nofollow" href="http://bonfirehub-resources-can-east-doc-conversion.bf-riakcs.com/">http://bonfirehub-resources-can-east-doc-conversion.bf-riakcs.com/</a>&gt;}
    &quot;GET /?delimiter=/ HTTP/1.1&quot;

    I’ve put together a video showing off the top results of each of
    the 5 riak nodes while performing $ time s3cmd -c
    .s3cfg-riakcs-admin
    lss3://bonfirehub-resources-can-east-doc-conversion

    
<a  rel="nofollow" href="https://dl.dropboxusercontent.com/u/5723659/RiakCS%20ls%20monitoring%20results.mov">https://dl.dropboxusercontent.com/u/5723659/RiakCS%20ls%20monitoring%20results.mov</a>

    Now I’ve had a hunch this is just a fundamentally expensive
    operation which exceeds the 5000ms response time threshold set in
    our HAProxy config (which I raised during the video to illustrate
    what’s going on). After reading
    
<a  rel="nofollow" href="http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why">http://www.quora.com/Riak/Is-it-really-expensive-for-Riak-to-list-all-buckets-Why</a>
 and
    <a  rel="nofollow" href="http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html">http://www.paperplanes.de/2011/12/13/list-all-of-the-riak-keys.html</a> I’m
    feeling like this is just a fundamental issue with the data
    structure in Riak.

    Based on this I’m thinking that cost of this type of query is
    only going to get worse over time as we add more keys to this
    bucket (unless secondary indexes can be added). Or am I totally
    out to lunch here and there’s some other underlying problem?

    I’ve cc’d the mailing list on this as suggested.

    Bonfire Logo        *Alex Millar*, CTO
    Office: 1-800-354-8010 ext. 704 &lt;tel:+18003548010&gt;
    Mobile: 519-729-2539 &lt;tel:+15197292539&gt;
    *GoBonfire*.com &lt;<a  rel="nofollow" href="http://GoBonfire.com">http://GoBonfire.com</a>&gt;


    From: Charlie Voiselle &lt;cvoise...@basho.com&gt;
    &lt;<a  rel="nofollow" href="mailto:cvoise...@basho.com">mailto:cvoise...@basho.com</a>&gt;
    Reply: Charlie Voiselle &lt;cvoise...@basho.com&gt;&gt;
    &lt;<a  rel="nofollow" href="mailto:cvoise...@basho.com">mailto:cvoise...@basho.com</a>&gt;
    Date: August 13, 2014 at 10:36:51 AM
    To: Alex Millar &lt;a...@gobonfire.com&gt;&gt; &lt;<a  rel="nofollow" href="mailto:a...@gobonfire.com">mailto:a...@gobonfire.com</a>&gt;
    Cc: Tad Bickford &lt;tbickf...@basho.com&gt;&gt; &lt;<a  rel="nofollow" href="mailto:tbickf...@basho.com">mailto:tbickf...@basho.com</a>&gt;
    Subject: Fwd: RiakCS 504 Timeout on s3cmd for certain keys

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

    _______________________________________________
    riak-users mailing list
    riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
    <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>




--
Kota UENISHI / @kuenishi
Basho Japan KK
</pre></blockquote></blockquote><pre style="margin: 0em;">

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14733.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14735">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14735">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14712.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14711.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys</a></span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14726.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain key...</a></span> <span class="sender italic">Kota Uenishi</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14733.html">Re: Fwd: RiakCS 504 Timeout on s3cmd for certain...</a></span> <span class="sender italic">Alex Millar</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Fwd: RiakCS 504 Timeout on s3cmd for cer...</span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Fwd: RiakCS 504 Timeout on s3cmd for certain keys">
<input type="hidden" name="msgid" value="53F37AE6.60900@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14735.html">
<input type="submit" value=" Kelly McLaughlin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Fwd%5C%3A+RiakCS+504+Timeout+on+s3cmd+for+certain+keys%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14733.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14712.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">53F37AE6.60900@basho.com</li>
</ul>
</div>
</body>
</html>
