<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Advice on making a Riak middleware easy to configure</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#15903" id="c">
<link rel="index" href="maillist.html#15903" id="i">
<link rel="prev" href="msg15901.html" id="p">
<link rel="next" href="msg15869.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg15903.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Advice+on+making+a+Riak+middleware+easy+to+configure%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Advice on making a Riak middleware easy to configure</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Marc+Savy%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Marc Savy</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150319" rel="nofollow">Thu, 19 Mar 2015 05:38:46 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Dmitri,

Many thanks for your impressive response, it's very helpful indeed!</pre><pre>

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
In order to answer the setup questions specifically, we'd need to
know more about what the project is intending to do. Will users be
typically installing their own Riak clusters and then setting up
apiman to help manage APIs?
</pre></blockquote><pre style="margin: 0em;">

This is one of the areas I'm not sure about. Ideally I'd like the user
to bring their own Riak cluster and manage it themselves, but wasn't
sure if there was a large use-base that might *expect* us to set
everything up for them

In the ideal world: users come along and say &quot;I want to use Riak for the
distributed components rather than Infinispan or ElasticSearch, and
here's an end-point(s) to connect to&quot;.

If I can make that assumption for a dev/test environment too, that's great!

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Or is this more of a multi-tenant kind of situation, where apiman
would be spinning up nodes or clusters for users? To put it another
way, how does apiman handle ElasticSearch?
</pre></blockquote><pre style="margin: 0em;">

We would leave the spinning up of additional nodes to some other element
of the system (e.g. kubernetes). It's outside of our domain, really.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Ah, ok, if I understand your question correctly -- if you're not
spinning up VMs or setting up the nodes yourself via ssh (using
something like our Ansible playbook), then you can expect an already
set up cluster. (FWIW, the various configuration management tools
such as Ansible that install Riak clusters do provide idempotency). I
can't really picture a situation where users would set up nodes but
not join them and leave that up to apiman.
</pre></blockquote><pre style="margin: 0em;">

You understood correctly. Thanks!

Essentially, I can use a simple RiakClient with a single address (or
list of addresses) and I don't need to worry about a more complex
RiakCluster set-up routine as below; correct?

addresses = &lt;list of addrs&gt;
... nodes = RiakNode.Builder.buildNodes(builder, addresses);
... cluster = new RiakCluster.Builder(nodes).build();
cluster.start();
RiakClient client = new RiakClient(cluster)

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
A load balancer is crucial (we recommend either a hardware based one,
or something like HAProxy or Nginx). I know some users connect to a
Riak cluster using the round-robin load balancing built into a Riak
client, but that should be a last resort measure (if, for example,
you're not allowed to spin up another machine for HAProxy). A
dedicated load balancer (with a least-connection load balancing
algorithm) is significantly faster. (Not to mention, provides logging
and a rich ecosystem of tools and dashboards).

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Given the introduction of Riak Data Types on buckets, whom should I
expect to set up the data types?
</pre></blockquote><pre style="margin: 0em;">

There isn't currently an API to create bucket types remotely. So
unless apiman has daemons that will be running on the individual Riak
nodes and can make commandline calls, you will have to leave bucket
type creation to the users.
</pre></blockquote><pre style="margin: 0em;">

This is all excellent information, and exactly what I wanted to know.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
For example, Strongly Consistent buckets are useful for atomic
operations like user password management, security group management
and so on. So, you could require that users would create a bucket
type named 'sc' and enable Strong Consistency on it. (Any buckets
under that bucket type would then also be strongly consistent, and
usable by apiman or by the users' client code).
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Similarly, given that metering is a goal, you would also need
bucket types for the various server-side Data Types. That is,
require users to create a Maps bucket type named 'maps', a Counters
type named 'counters', and a Sets type named 'sets', for example.

Other things to keep on your radar, as far as bucket types:

* You can attach a Solr Search index to a bucket type. However,
given that you can only associate a single search index with a
bucket type, this isn't as generic/reusable as Data Types. I could
see setting up a Search index for something like API logging,
though.

* You probably want provisions for Riak Authentication &amp;
Authorization (<a  rel="nofollow" href="http://docs.basho.com/riak/2.0.4/ops/running/authz/">http://docs.basho.com/riak/2.0.4/ops/running/authz/</a>
). (Specifically, for supporting user-created users &amp; passwords,
since at the moment we don't have a remote API to manage these).
</pre></blockquote></blockquote><pre style="margin: 0em;">

I could provide a script to set everything up as an example, and also
document the process in the community. That being said, it would be nice
to be able to do this kind of preparatory and meta-data set-up using a
simple schema (e.g. json-schema). For instance, things like setting up
buckets, data types, name-spaces, etc.

This is invaluable information; thank you very much. We'll definitely
consider Riak implementations for those elements, too.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
In terms of options, do you mean like best-practice/recommended riak
 config files that you'd point your users to?
</pre></blockquote><pre style="margin: 0em;">

I was thinking more of what config they would expect to be available in
Apiman's config to facilitate using their Riak cluster with our
components. I think you've answered this point already.

Regards,
Marc

On 17/03/2015 13:14, Dmitri Zagidulin wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Marc,

This sounds like a very cool project! I'd be very interested in hearing
more about this, and answering any data modeling or setup questions.

In order to answer the setup questions specifically, we'd need to know
more about what the project is intending to do. Will users be typically
installing their own Riak clusters and then setting up apiman to help
manage APIs? Or is this more of a multi-tenant kind of situation, where
apiman would be spinning up nodes or clusters for users? To put it
another way, how does apiman handle ElasticSearch?

Couple of thoughts, from your questions.

 &gt; To be more concrete, should I, for example, expect the user to have
 &gt; already set up and joined together their Riak cluster a priori, with
 &gt; everything behind a load-balancer: just give me a single URI to connect
 &gt; to). [Or attempt to join them into a cluster].

Ah, ok, if I understand your question correctly -- if you're not
spinning up VMs or setting up the nodes yourself via ssh (using
something like our Ansible playbook), then you can expect an already set
up cluster. (FWIW, the various configuration management tools such as
Ansible that install Riak clusters do provide idempotency). I can't
really picture a situation where users would set up nodes but not join
them and leave that up to apiman.

 &gt; As far as I can tell, there is no node discovery/sharing
 &gt; implementation

If you know the IP of one node, you can definitely discover the other
nodes via an HTTP call to /stats
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/nodes/inspecting/">http://docs.basho.com/riak/latest/ops/running/nodes/inspecting/</a> (via
'ring_members'). But, unless apiman provides some sort of monitoring or
keepalive-checking capability, I don't think there's any reason to do that.

A load balancer is crucial (we recommend either a hardware based one, or
something like HAProxy or Nginx). I know some users connect to a Riak
cluster using the round-robin load balancing built into a Riak client,
but that should be a last resort measure (if, for example, you're not
allowed to spin up another machine for HAProxy). A dedicated load
balancer (with a least-connection load balancing algorithm) is
significantly faster. (Not to mention, provides logging and a rich
ecosystem of tools and dashboards).

 &gt; Given the introduction of Riak
 &gt; Data Types on buckets, whom should I expect to set up the data types?

There isn't currently an API to create bucket types remotely. So unless
apiman has daemons that will be running on the individual Riak nodes and
can make commandline calls, you will have to leave bucket type creation
to the users.

That said, I could easily see you requiring a certain set of bucket
types of your users.

For example, Strongly Consistent buckets are useful for atomic
operations like user password management, security group management and
so on. So, you could require that users would create a bucket type named
'sc' and enable Strong Consistency on it. (Any buckets under that bucket
type would then also be strongly consistent, and usable by apiman or by
the users' client code).

Similarly, given that metering is a goal, you would also need bucket
types for the various server-side Data Types. That is, require users to
create a Maps bucket type named 'maps', a Counters type named
'counters', and a Sets type named 'sets', for example.

Other things to keep on your radar, as far as bucket types:

* You can attach a Solr Search index to a bucket type. However, given
that you can only associate a single search index with a bucket type,
this isn't as generic/reusable as Data Types. I could see setting up a
Search index for something like API logging, though.

* You probably want provisions for Riak Authentication &amp; Authorization
(<a  rel="nofollow" href="http://docs.basho.com/riak/2.0.4/ops/running/authz/">http://docs.basho.com/riak/2.0.4/ops/running/authz/</a> ). (Specifically,
for supporting user-created users &amp; passwords, since at the moment we
don't have a remote API to manage these).

 &gt; I'm very interested to know to present a convenient set of options that
 &gt; will allow a typical development and deployment environment to be
supported.

In terms of options, do you mean like best-practice/recommended riak
config files that you'd point your users to?

Let me know if you have further questions.

Dmitri




On Sat, Mar 7, 2015 at 10:35 AM, Marc Savy &lt;ms...@redhat.com
&lt;<a  rel="nofollow" href="mailto:ms...@redhat.com">mailto:ms...@redhat.com</a>&gt;&gt; wrote:

    Hi All,

    I'm involved in a FOSS API management project (apiman), and I've been
    thinking about providing a Riak implementation of its gateway components
    in the community (where we already have ElasticSearch and Infinispan).
    These components provide the distributed storage for tasks like
    rate-limiting counters, IP white-listing, black-listing, etc and are
    applied by a horizontally scalable, async gateway (to vastly
    oversimplify!).

    I'm in need of advice principally in regards to configuration and
    set-up. Namely, what assumptions can I safely make about a Riak user's
    set-up, and which settings I should expose in the component's
    configuration. Note that many gateways can exist, and hence any set-up
    ideally needs to already in advance, or be idempotent in case multiple
    nodes attempt to do it at once (or otherwise for it to be
    lockable/exclusionary).

    To be more concrete, should I, for example, expect the user to have
    already set up and joined together their Riak cluster a priori, with
    everything behind a load-balancer: just give me a single URI to connect
    to). Or, should I expect a list of FQDNs/IPs and attempt to join them
    together into a cluster on the user's behalf - or will there be
    idempotence issues if I do that multiple times?

    As far as I can tell, there is no node discovery/sharing
    implementation[1], so I take it there's no way, for instance, to hit a
    single node (which has already been joined with other nodes), and
    thereby automatically gain knowledge of all cluster members?

    A couple of other configuration issues: Given the introduction of Riak
    Data Types on buckets, whom should I expect to set up the data types[2]?
    Should I create them automatically if they don't exist? Same for the
    bucket itself.

    I'm very interested to know to present a convenient set of options that
    will allow a typical development and deployment environment to be
    supported.

    Regards,
    Marc

    [0] With the usual consistency limitations
    [1] <a  rel="nofollow" href="https://github.com/basho/riak/__issues/356">https://github.com/basho/riak/__issues/356</a>
    &lt;<a  rel="nofollow" href="https://github.com/basho/riak/issues/356">https://github.com/basho/riak/issues/356</a>&gt;
    [2]
    
<a  rel="nofollow" href="http://docs.basho.com/riak/__latest/dev/using/data-types/#__Setting-Up-Buckets-to-Use-__Riak-Data-Types">http://docs.basho.com/riak/__latest/dev/using/data-types/#__Setting-Up-Buckets-to-Use-__Riak-Data-Types</a>
    
&lt;<a  rel="nofollow" href="http://docs.basho.com/riak/latest/dev/using/data-types/#Setting-Up-Buckets-to-Use-Riak-Data-Types">http://docs.basho.com/riak/latest/dev/using/data-types/#Setting-Up-Buckets-to-Use-Riak-Data-Types</a>&gt;

    _________________________________________________
    riak-users mailing list
    riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
    <a  rel="nofollow" href="http://lists.basho.com/__mailman/listinfo/riak-users___lists.basho.com">http://lists.basho.com/__mailman/listinfo/riak-users___lists.basho.com</a>
    &lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;


</pre></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg15901.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#15903">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#15903">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg15869.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg15853.html">Advice on making a Riak middleware easy to configure</a></span> <span class="sender italic">Marc Savy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg15900.html">Re: Advice on making a Riak middleware easy to confi...</a></span> <span class="sender italic">Matthew Brender</span></li>
<li class="icons-email"><span class="subject"><a href="msg15901.html">Re: Advice on making a Riak middleware easy to confi...</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Advice on making a Riak middleware easy to c...</span> <span class="sender italic">Marc Savy</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Advice on making a Riak middleware easy to configure">
<input type="hidden" name="msgid" value="550AC2F6.5030507@redhat.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg15903.html">
<input type="submit" value=" Marc Savy ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Advice+on+making+a+Riak+middleware+easy+to+configure%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg15901.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg15869.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">550AC2F6.5030507@redhat.com</li>
</ul>
</div>
</body>
</html>
