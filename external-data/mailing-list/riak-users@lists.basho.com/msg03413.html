<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak doesn't use consistent hashing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03413" id="c">
<link rel="index" href="maillist.html#03413" id="i">
<link rel="prev" href="msg03412.html" id="p">
<link rel="next" href="msg03419.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03413.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+doesn%27t+use+consistent+hashing%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak doesn't use consistent hashing</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Greg+Nelson%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Greg Nelson</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110525" rel="nofollow">Wed, 25 May 2011 22:55:10 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've been doing some digging through the details of how a node joins a cluster. 
When you hear that Riak uses consistent hashing, you'd expect it to distribute 
keys to nodes by hashing keys onto the ring AND hashing nodes onto the ring. 
Keys belong to the closest node on the ring, in the clockwise direction. Add a 
node, it hashes onto the ring and takes over some keys. Ordinarily the node 
would hash onto the ring in several places, to achieve better spread. Some data 
(roughly 1 / #nodes) moves to the new node from each of the other nodes, and 
everything else stays the same.</pre><pre>

In what Amazon describes as operationally simpler (strategy 3 in the Dynamo 
paper), the ring is instead divided into equally-sized partitions. Nodes are 
hashed onto the ring, and preflists are calculated by walking clockwise from a 
partition, skipping partitions on already visited nodes. Riak does something 
similar: it divides the ring into equally-sized partitions, then nodes 
&quot;randomly&quot; claim partitions. However, the skipping bit isn't part of Riak's 
preflist calculation. Instead, nodes claim partitions in such a way as to be 
spaced out by target_n_val, to obviate the need for skipping.

Now, getting back to what happens when a node joins. The new node calculates a 
new ring state that maintains the target_n_val invariant, as well as trying to 
keep even spread of partitions per node. The algorithm (default_choose_claim) 
is heuristic and greedy in nature, and recursively transfers partitions to the 
new node until optimal spread is achieved, maintaining target_n_val along the 
way. But if -- during one of those recursive calls -- it can't meet the 
target_n_val, it will throw up its hands and completely re-do the whole ring 
(by calling claim_rebalance_n). Striping the partitions across nodes, in a 
round-robin fashion. When that happens, most of the data needs to be handed off 
between nodes.

This happens a lot, with many ring sizes. With ring_creation_size=128 (i.e., 
128 partitions), it will happen when adding node 9 (87.5% of data moves), 
adding node 12 (82%), adding node 15 (80%), adding node 19 (94%). It happens 
with all ring sizes &gt;= 128 (256, 512, 1024, ...). It appears that any 
ring_creation_size (64 by default) is safe for growing to 8 nodes or so. But if 
you want to go beyond that... A ring size of &gt;= 128 with more than 8 nodes 
doesn't seem all that unusual, surely someone has hit this before? I've filed a 
bug report here: <a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=1111">https://issues.basho.com/show_bug.cgi?id=1111</a>

Anyway, this feels like a bit of a departure from consistent hashing. In fact, 
could this not be replaced by normal hashing + a lookup table mapping intervals 
of the hash space to nodes? And isn't that simply sharding?

At any rate, I believe the claim algorithm can be improved to avoid those 
&quot;throw up hands and stripe everything&quot; scenarios. In fact, here is such an 
implementation: <a  rel="nofollow" href="https://github.com/basho/riak_core/pull/55">https://github.com/basho/riak_core/pull/55</a>. It is still 
heuristic and greedy, but it seems to do a better job of avoiding re-stripe. 
Test results are attached in a zip on the bug linked above. I'd love to get the 
riak_core gurus at Basho to look at this and help validate it. It probably 
could use some cleaning up, but I want to make sure there aren't other 
invariants or considerations I'm leaving out -- besides maintaining 
target_n_val, keeping optimal partition spread, and minimizing handoff between 
ring states.

-Greg </pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03412.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03413">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03413">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03419.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak doesn't use consistent hashing</span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03419.html">Re: Riak doesn't use consistent hashing</a></span> <span class="sender italic">Jonathan Langevin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03420.html">Re: Riak doesn't use consistent hashing</a></span> <span class="sender italic">Ben Tilly</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03436.html">Re: Riak doesn't use consistent hashing</a></span> <span class="sender italic">Greg Nelson</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak doesn't use consistent hashing">
<input type="hidden" name="msgid" value="97D542C27D7A4CECAA43652D67A402D0@dropcam.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03413.html">
<input type="submit" value=" Greg Nelson ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+doesn%27t+use+consistent+hashing%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03412.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03419.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">97D542C27D7A4CECAA43652D67A402D0@dropcam.com</li>
</ul>
</div>
</body>
</html>
