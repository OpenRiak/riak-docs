<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Memory Usage Constantly Growing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08784" id="c">
<link rel="index" href="maillist.html#08784" id="i">
<link rel="prev" href="msg08783.html" id="p">
<link rel="next" href="msg08785.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08784.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Memory+Usage+Constantly+Growing%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Memory Usage Constantly Growing</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22John+E.+Vincent%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">John E. Vincent</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121002" rel="nofollow">Tue, 02 Oct 2012 05:12:16 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I would highly suggest you upgrade to 1.2 when possible. We were, up
until recently, running on 1.4 and seeing the same problems you
describe. Take a look at this graph:</pre><pre>

<a  rel="nofollow" href="http://i.imgur.com/0RtsU.png">http://i.imgur.com/0RtsU.png</a>

That's just one of our nodes but all of them exhibited the same
behavior. The falloffs are where we had to bounce riak.

This is what one of our nodes looks like now and has looked like since
the upgrade:

<a  rel="nofollow" href="http://i.imgur.com/pm7Nk.png">http://i.imgur.com/pm7Nk.png</a>

The change was SO dramatic that I seriously though /stats was broken.
I've verified outside of Riak and inside. The memory usage change was
very positive. Evidently there's even still a memory leak.

We're heavy 2i users. No multi backend.

On Tue, Oct 2, 2012 at 4:08 AM, Shane McEwan &lt;sh...@mcewan.id.au&gt; wrote:
&gt; G'day!
&gt;
&gt; Just recently we've noticed memory usage in our Riak cluster constantly
&gt; increasing.
&gt;
&gt; The memory usage reported by the Riak stats &quot;memory_total&quot; parameter has
&gt; been less than 100MB for nearly a year but has recently increased to over
&gt; 1GB.
&gt;
&gt; If we restart the cluster memory usage usually returns back to what we would
&gt; call &quot;normal&quot; but after a week or so of stability the memory usage starts
&gt; gradually growing again. Sometimes after a growth spurt over a few days the
&gt; memory usage will plateau and be stable again for a week or two and then put
&gt; on another growth spurt. The memory usage starts increasing at the same
&gt; moment on all 4 nodes.
&gt;
&gt; This graph [<a  rel="nofollow" href="http://imagebin.org/230614">http://imagebin.org/230614</a>] shows what I mean. The green shows
&gt; the memory usage as reported by &quot;memory_total&quot; (left-hand y-axis scale). The
&gt; red line shows the memory used by Riak's beam.smp process (right-hand y-axis
&gt; scale).
&gt;
&gt; Also notice that the gradient of the recent growth seems to be increasing
&gt; compared to the memory increases we had in August.
&gt;
&gt; We might have just assumed that the memory usage was normal Riak behaviour.
&gt; Perhaps we have just tipped over some sort of internal buffer or cache and
&gt; that causes some more memory to be allocated. However, whenever we notice
&gt; the memory usage increasing it always coincides with the &quot;riak-admin top&quot;
&gt; command failing to run.
&gt;
&gt; We try to run &quot;riak-admin top&quot; to diagnose what is using the memory but it
&gt; returns: &quot;Output server crashed: connection_lost&quot;. If we restart the cluster
&gt; the top command works fine (but, of course, there's nothing interesting to
&gt; see after a restart!).
&gt;
&gt; So our theory at the moment is that some sort of instability or race
&gt; condition is causing Riak to start consuming more and more memory. A side
&gt; effect of this instability is that the internal processes needed for running
&gt; the top command are not working correctly. The actual functionality of Riak
&gt; doesn't seem to be affected. Our application is running fine. We see a
&gt; slight increase in &quot;FSM Put&quot; times and CPU usage during the memory growth
&gt; phases but all other parameters we're monitoring on the system seem
&gt; unaffected.
&gt;
&gt; There's nothing abnormal in the logs. We get a lot of &quot;riak_pipe_builder_sup
&gt; {sink_died,normal}&quot; messages but they can be ignored, apparently. The
&gt; cluster is under constant load so we would expect to see either gradual
&gt; memory increase or a steady state but not both. Erlang process count, open
&gt; file handles, etc are stable.
&gt;
&gt; So I was wondering if anyone has seen similar behaviour before?
&gt; Is there anything else we can do to diagnose the problem?
&gt; I'm accessing the stats URL once per minute, could that have any side
&gt; effects?
&gt; We'll be upgrading to Riak 1.2 and new hardware in the next few weeks so
&gt; should we just ignore it and hope it goes away?
&gt; Any other ideas?
&gt; Or is this just normal?
&gt;
&gt; Riak config:
&gt; 4 VMware nodes
&gt; ring_creation_size, 256
&gt; n_val, 3
&gt; eleveldb backend:
&gt;   max_open_files, 20
&gt;   cache_size, 15728640
&gt; &quot;riak_kv_version&quot;:&quot;1.1.1&quot;,
&gt; &quot;riak_core_version&quot;:&quot;1.1.1&quot;,
&gt; &quot;stdlib_version&quot;:&quot;1.17.4&quot;,
&gt; &quot;kernel_version&quot;:&quot;2.14.4&quot;
&gt; Erlang R14B03 (erts-5.8.4)
&gt;
&gt; Thanks!
&gt;
&gt; Shane.
&gt;
&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08783.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08784">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08784">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08785.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08783.html">Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Memory Usage Constantly Growing</span> <span class="sender italic">John E. Vincent</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08785.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08788.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
<li class="icons-email"><span class="subject"><a href="msg08789.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
<li class="icons-email"><span class="subject"><a href="msg08790.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08791.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Memory Usage Constantly Growing">
<input type="hidden" name="msgid" value="CAPy8ofL4aDEXW=y=VaP9Yi6Mm3sd=fox0mWT79HWXXtVKBeYdQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08784.html">
<input type="submit" value=" John E. Vincent ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Memory+Usage+Constantly+Growing%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08783.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08785.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAPy8ofL4aDEXW=y=VaP9Yi6Mm3sd=fox0mWT79HWXXtVKBeYdQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
