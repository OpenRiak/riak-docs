<!DOCTYPE html>
<html lang="en">
<head>
<title>ssl support?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#07923" id="c">
<link rel="index" href="mail2.html#07923" id="i">
<link rel="prev" href="msg07922.html" id="p">
<link rel="next" href="msg07924.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07923.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22ssl+support%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">ssl support?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Michael+Johnson%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Michael Johnson</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120713" rel="nofollow">Fri, 13 Jul 2012 11:34:47 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've been having problems getting riak to function via https and have not
been able to find anything online that seems to help so far.  I am using a
self-signed certificate (which is one I generated specifically for this
testing, and thus could post as it will not be used for anything else) and
have it stored as separate .crt and .key files.  I've used open SSL to
verify the certificate and it appears to be all good.  Here is what the
relevant bits of my app.config look like (I can post the rest as needed,
but I'm trying to be consise):</pre><pre>

              {http, [{&quot;0.0.0.0&quot;, 8091}]},
              {https, [{&quot;0.0.0.0&quot;, 8092}]},
              {ssl, [
                     {certfile, &quot;/etc/riak/ssl.crt&quot;},
                     {keyfile, &quot;/etc/riak/ssl.key&quot;}
                    ]},

Starting riak does not generate any errors, and 'riak-admin test' works:
[root@riak01 riak]# riak-admin test
Attempting to restart script through sudo -u riak
Successfully completed 1 read/write cycle to 'r...@riak01.mediatemple.net'

Manuallly querying riak via http also works fine:

[root@riak01 riak]# curl -k -vvv
<a  rel="nofollow" href="http://127.0.0.1:8091/riak/__riak_client_test__">http://127.0.0.1:8091/riak/__riak_client_test__</a>
* About to connect() to 127.0.0.1 port 8091 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 8091 (#0)
&gt; GET /riak/__riak_client_test__ HTTP/1.1
&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/
3.13.1.0 zlib/1.2.3 libidn/1.18 libssh2/1.2.2
&gt; Host: 127.0.0.1:8091
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Vary: Accept-Encoding
&lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&lt; Date: Fri, 13 Jul 2012 18:03:13 GMT
&lt; Content-Type: application/json
&lt; Content-Length: 410
&lt;
* Connection #0 to host 127.0.0.1 left intact
* Closing connection #0
{&quot;props&quot;:{&quot;name&quot;:&quot;__riak_client_test__&quot;,&quot;allow_mult&quot;:false,&quot;basic_quorum&quot;:false,&quot;big_vclock&quot;:50,&quot;chash_keyfun&quot;:{&quot;mod&quot;:&quot;riak_core_util&quot;,&quot;fun&quot;:&quot;chash_std_keyfun&quot;},&quot;dw&quot;:1,&quot;last_write_wins&quot;:false,&quot;linkfun&quot;:{&quot;mod&quot;:&quot;riak_kv_wm_link_walker&quot;,&quot;fun&quot;:&quot;mapreduce_linkfun&quot;},&quot;n_val&quot;:1,&quot;notfound_ok&quot;:true,&quot;old_vclock&quot;:86400,&quot;postcommit&quot;:[],&quot;pr&quot;:0,&quot;precommit&quot;:[],&quot;pw&quot;:0,&quot;r&quot;:1,&quot;rw&quot;:1,&quot;small_vclock&quot;:50,&quot;w&quot;:1,&quot;young_vclock&quot;:20}}


But the minute I try to connect via https I have problems:

[root@riak01 riak]# curl -k -vvv
<a  rel="nofollow" href="https://127.0.0.1:8092/riak/__riak_client_test__">https://127.0.0.1:8092/riak/__riak_client_test__</a>
* About to connect() to 127.0.0.1 port 8092 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 8092 (#0)
* Initializing NSS with certpath: sql:/etc/pki/nssdb
* warning: ignoring value of ssl.verifyhost
* NSS error -5938
* Closing connection #0
* SSL connect error
curl: (35) SSL connect error

And I see the following in the logs:

console.log:
2012-07-13 11:05:52.023 [error] &lt;0.5313.0&gt; CRASH REPORT Process &lt;0.5313.0&gt;
with 0 neighbours crashed with reason:
{ekeyfile,[{gen_fsm,init_it,6},{proc_lib,init_p_do_apply,3}]}
2012-07-13 11:05:52.026 [error] &lt;0.134.0&gt; Supervisor ssl_connection_sup had
child undefined started with {ssl_connection,start_link,undefined} at
&lt;0.5313.0&gt; exit with reason ekeyfile in context child_terminated
2012-07-13 11:05:52.031 [error] &lt;0.139.0&gt; application: mochiweb, &quot;Accept
failed error&quot;, &quot;{error,ekeyfile}&quot;
2012-07-13 11:05:52.033 [error] &lt;0.139.0&gt; CRASH REPORT Process &lt;0.139.0&gt;
with 0 neighbours crashed with reason: {error,accept_failed}
2012-07-13 11:05:52.035 [error] &lt;0.135.0&gt;
{mochiweb_socket_server,310,{acceptor_error,{error,accept_failed}}}

crash.log:
2012-07-13 11:05:52 =ERROR REPORT====
[83,83,76,58,32,&quot;1112&quot;,58,32,&quot;error&quot;,58,&quot;[]&quot;,32,&quot;/etc/riak/ssl.key&quot;,&quot;\n&quot;,32,32,[91,[[123,[&quot;ssl_connection&quot;,44,&quot;init_private_key&quot;,44,&quot;5&quot;],125],44,10,&quot;
  &quot;,[123,[&quot;ssl_connection&quot;,44,&quot;ssl_init&quot;,44,&quot;2&quot;],125],44,10,&quot;
&quot;,[123,[&quot;ssl_connection&quot;,44,&quot;init&quot;,44,&quot;1&quot;],125],44,10,&quot;
&quot;,[123,[&quot;gen_fsm&quot;,44,&quot;init_it&quot;,44,&quot;6&quot;],125],44,10,&quot;
&quot;,[123,[&quot;proc_lib&quot;,44,&quot;init_p_do_apply&quot;,44,&quot;3&quot;],125]],93],&quot;\n&quot;]2012-07-13
11:05:52 =CRASH REPORT====
  crasher:
    initial call: ssl_connection:init/1
    pid: &lt;0.5313.0&gt;
    registered_name: []
    exception exit: ekeyfile
      in function  gen_fsm:init_it/6
      in call from proc_lib:init_p_do_apply/3
    ancestors: [ssl_connection_sup,ssl_sup,&lt;0.130.0&gt;]
    messages: []
    links: [&lt;0.134.0&gt;]
    dictionary: []
    trap_exit: false
    status: running
    heap_size: 1597
    stack_size: 24
    reductions: 1185
  neighbours:
2012-07-13 11:05:52 =SUPERVISOR REPORT====
     Supervisor: {local,ssl_connection_sup}
     Context:    child_terminated
     Reason:     ekeyfile
     Offender:
[{pid,&lt;0.5313.0&gt;},{name,undefined},{mfargs,{ssl_connection,start_link,undefined}},{restart_type,temporary},{shutdown,4000},{child_type,worker}]

2012-07-13 11:05:52 =ERROR REPORT====
[{application,mochiweb},&quot;Accept failed error&quot;,&quot;{error,ekeyfile}&quot;]2012-07-13
11:05:52 =CRASH REPORT====
  crasher:
    initial call: mochiweb_acceptor:init/3
    pid: &lt;0.139.0&gt;
    registered_name: []
    exception exit: {error,accept_failed}
      in function  mochiweb_acceptor:init/3
      in call from proc_lib:init_p_do_apply/3
    ancestors: ['https_0.0.0.0:8092',riak_core_sup,&lt;0.88.0&gt;]
    messages: []
    links: [&lt;0.135.0&gt;,#Port&lt;0.5661&gt;]
    dictionary: []
    trap_exit: false
    status: running
    heap_size: 233
    stack_size: 24
    reductions: 818
  neighbours:
2012-07-13 11:05:52 =ERROR REPORT====
{mochiweb_socket_server,310,{acceptor_error,{error,accept_failed}}}

erlang.log.1 and error.log (which are identical):
11:05:52.018 [error] SSL: 1112: error:[] /etc/riak/ssl.key
  [{ssl_connection,init_private_key,5},
   {ssl_connection,ssl_init,2},
   {ssl_connection,init,1},
   {gen_fsm,init_it,6},
   {proc_lib,init_p_do_apply,3}]

11:05:52.023 [error] CRASH REPORT Process &lt;0.5313.0&gt; with 0 neighbours
crashed with reason:
{ekeyfile,[{gen_fsm,init_it,6},{proc_lib,init_p_do_apply,3}]}
11:05:52.026 [error] Supervisor ssl_connection_sup had child undefined
started with {ssl_connection,start_link,undefined} at &lt;0.5313.0&gt; exit with
reason ekeyfile in context child_terminated
11:05:52.031 [error] application: mochiweb, &quot;Accept failed error&quot;,
&quot;{error,ekeyfile}&quot;
11:05:52.033 [error] CRASH REPORT Process &lt;0.139.0&gt; with 0 neighbours
crashed with reason: {error,accept_failed}
11:05:52.035 [error]
{mochiweb_socket_server,310,{acceptor_error,{error,accept_failed}}}


Everything I am finding says this means my key file is bad.  However, as
previously mentioned, I've verified this with openssl:

[root@riak01 riak]# openssl verify /etc/riak/ssl.crt
/etc/riak/ssl.crt: C = US, ST = California, L = Culver City, O = Default
Company Ltd, CN = example.com, emailAddress = ad...@example.com
error 18 at 0 depth lookup:self signed certificate
OK

[root@riak01 riak]# ( openssl x509 -noout -modulus -in /etc/riak/ssl.crt |
openssl md5; openssl rsa -noout -modulus -in /etc/riak/ssl.key | openssl
md5 ) | uniq
(stdin)= b3d4187d8472f2d0b73cf5597d5d65b8


I'm just really not sure what else to look at.  Everything seems to be fine
except for that fact it's not working.  Does anybody have SSL working with
self-signed certificate using the basho provided binary packages on CentOS
6.3? I'm beginning to thing that they might be the problem and I just don't
know where to go from here.

Any suggestions will be appreciated.
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07922.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#07923">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#07923">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07924.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">ssl support?</span> <span class="sender italic">Michael Johnson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07924.html">Re: ssl support?</a></span> <span class="sender italic">John E. Vincent</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07926.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07927.html">Re: ssl support?</a></span> <span class="sender italic">Chris Meiklejohn</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07928.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07929.html">Re: ssl support?</a></span> <span class="sender italic">Dave Parfitt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07930.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li class="icons-email"><span class="subject"><a href="msg07931.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07932.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li class="icons-email"><span class="subject"><a href="msg07964.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
<li class="icons-email"><span class="subject"><a href="msg08178.html">Re: ssl support?</a></span> <span class="sender italic">Michael Johnson</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="ssl support?">
<input type="hidden" name="msgid" value="CAHjDDKNeRYp2j60+TCWQ7teTQB-M+TBshSoQdyuL8vHOA73D_g@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07923.html">
<input type="submit" value=" Michael Johnson ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22ssl+support%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07922.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07924.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAHjDDKNeRYp2j60+TCWQ7teTQB-M+TBshSoQdyuL8vHOA73D_g@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
