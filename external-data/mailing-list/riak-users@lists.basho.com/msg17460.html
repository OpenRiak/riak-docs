<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: How to cold (re)boot a cluster with already existing node data</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd4.html#17460" id="c">
<link rel="index" href="mail4.html#17460" id="i">
<link rel="prev" href="msg17459.html" id="p">
<link rel="next" href="msg17461.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17460.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+How+to+cold+%5C%28re%5C%29boot+a+cluster+with+already+existing+node+data%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: How to cold (re)boot a cluster with already existing node data</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22DeadZen%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">DeadZen</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160606" rel="nofollow">Mon, 06 Jun 2016 14:11:57 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I wasn't referring to a cluster replace. node name/reip change can be
done on all offline nodes before starting them.
They still have a cluster if you dont delete the ring data.
Having done that you actually deleted the cluster, (but not the data) when
all that occurred was an ip address change such that the node its looking
for in the dict. cant be found.</pre><pre>

orddict,fetch,['riak@10.44.2.8'...
Youd want a reip of the old r...@10.xx to riak@10.44.2.8 iirc

then the node would boot as if nothing happened.

personally I think this state could be detected and a friendlier, I cant
find x have you recently transferred to a new node or ip? etc etc


On Monday, June 6, 2016, Sargun Dhillon &lt;sar...@sargun.me&gt; wrote:

&gt; Two suggestions:
&gt; 1. Use Riak-EE, and have two rings. When you do an update, copy over one
&gt; ring to the other side after you do a &quot;cold reboot&quot;
&gt; 2. Use the Riak Mesos Framework. Mesos is like K8s, but it has stateful
&gt; storage primitives. (Link: <a  rel="nofollow" href="https://github.com/basho-labs/riak-mesos">https://github.com/basho-labs/riak-mesos</a>)
&gt;
&gt; On Mon, Jun 6, 2016 at 10:37 AM, Jan-Philip Loos &lt;maxda...@gmail.com
&gt; &lt;javascript:_e(%7B%7D,'cvml','maxda...@gmail.com');&gt;&gt; wrote:
&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Mon, 6 Jun 2016 at 16:52 Alex Moore &lt;amo...@basho.com
&gt;&gt; &lt;javascript:_e(%7B%7D,'cvml','amo...@basho.com');&gt;&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Jan,
&gt;&gt;&gt;
&gt;&gt;&gt; When you update the Kubernates nodes, do you have to do them all at once
&gt;&gt;&gt; or can they be done in a rolling fashion (one after another)?
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; Thnaks for your reply,
&gt;&gt;
&gt;&gt; sadly this is not possible. Kubernetes with GKE just tears all nodes
&gt;&gt; down, creating new nodes with new kubernets version and reschedule all
&gt;&gt; services on these nodes. So after an upgrade, all riak nodes are
&gt;&gt; stand-alone (when starting after deleting /var/lib/riak/ring)
&gt;&gt;
&gt;&gt; Greetings
&gt;&gt;
&gt;&gt; Jan
&gt;&gt;
&gt;&gt;
&gt;&gt;&gt; If you can do them rolling-wise, you should be able to:
&gt;&gt;&gt;
&gt;&gt;&gt; For each node, one at a time:
&gt;&gt;&gt; 1. Shut down Riak
&gt;&gt;&gt; 2. Shutdown/restart/upgrade Kubernates
&gt;&gt;&gt; 3. Start Riak
&gt;&gt;&gt; 4. Use `riak-admin force-replace` to rename the old node name to the new
&gt;&gt;&gt; node name
&gt;&gt;&gt; 5. Repeat on remaining nodes.
&gt;&gt;&gt;
&gt;&gt;&gt; This is covered in &quot;Renaming Multi-node clusters
&gt;&gt;&gt; &lt;<a  rel="nofollow" href="http://docs.basho.com/riak/kv/2.1.4/using/cluster-operations/changing-cluster-info/#rename-multi-node-clusters">http://docs.basho.com/riak/kv/2.1.4/using/cluster-operations/changing-cluster-info/#rename-multi-node-clusters</a>&gt;&quot;
&gt;&gt;&gt; doc.
&gt;&gt;&gt;
&gt;&gt;&gt; As for your current predicament,  have you created any new
&gt;&gt;&gt; buckets/changed bucket props in the default namespace since you restarted?
&gt;&gt;&gt; Or have you only done regular operations since?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Alex
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Mon, Jun 6, 2016 at 5:25 AM Jan-Philip Loos &lt;maxda...@gmail.com
&gt;&gt;&gt; &lt;javascript:_e(%7B%7D,'cvml','maxda...@gmail.com');&gt;&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; we are using riak in a kuberentes cluster (on GKE). Sometimes it's
&gt;&gt;&gt;&gt; necessary to reboot the complete cluster to update the kubernetes-nodes.
&gt;&gt;&gt;&gt; This results in a complete shutdown of the riak cluster and the riak-nodes
&gt;&gt;&gt;&gt; are rescheduled with a new IP. So how can I handle this situation? How can
&gt;&gt;&gt;&gt; I form a new riak cluster out of the old nodes with new names?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The /var/lib/riak directory is persisted. I had to delete the
&gt;&gt;&gt;&gt; /var/lib/riak/ring folder otherwise &quot;riak start&quot; crashed with this message
&gt;&gt;&gt;&gt; (but saved the old ring state in a tar):
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; {&quot;Kernel pid
&gt;&gt;&gt;&gt;&gt; terminated&quot;,application_controller,&quot;{application_start_failure,riak_core,{{shutdown,{failed_to_start_child,riak_core_broadcast,{'EXIT',{function_clause,[{orddict,fetch,['
&gt;&gt;&gt;&gt;&gt; riak@10.44.2.8 &lt;javascript:_e(%7B%7D,'cvml','riak@10.44.2.8');&gt;
&gt;&gt;&gt;&gt;&gt; ',[]],[{file,\&quot;orddict.erl\&quot;},{line,72}]},{riak_core_broadcast,init_peers,1,[{file,\&quot;src/riak_core_broadcast.erl\&quot;},{line,616}]},{riak_core_broadcast,start_link,0,[{file,\&quot;src/riak_core_broadcast.erl\&quot;},{line,116}]},{supervisor,do_start_child,2,[{file,\&quot;supervisor.erl\&quot;},{line,310}]},{supervisor,start_children,3,[{file,\&quot;supervisor.erl\&quot;},{line,293}]},{supervisor,init_children,2,[{file,\&quot;supervisor.erl\&quot;},{line,259}]},{gen_server,init_it,6,[{file,\&quot;gen_server.erl\&quot;},{line,304}]},{proc_lib,init_p_do_apply,3,[{file,\&quot;proc_lib.erl\&quot;},{line,239}]}]}}}},{riak_core_app,start,[normal,[]]}}}&quot;}
&gt;&gt;&gt;&gt;&gt; Crash dump was written to: /var/log/riak/erl_crash.dump
&gt;&gt;&gt;&gt;&gt; Kernel pid terminated (application_controller)
&gt;&gt;&gt;&gt;&gt; ({application_start_failure,riak_core,{{shutdown,{failed_to_start_child,riak_core_broadcast,{'EXIT',{function_clause,[{orddict,fetch,['
&gt;&gt;&gt;&gt;&gt; riak@10.44.2.8 &lt;javascript:_e(%7B%7D,'cvml','riak@10.44.2.8');&gt;',
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; The I formed a new cluster via join &amp; plan &amp; commit.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; But now, I discovered a problems with incomplete and inconsistent
&gt;&gt;&gt;&gt; partitions:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; *$ *curl -Ss &quot;
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot">http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot</a>;
&gt;&gt;&gt;&gt; | jq '.[] | length'
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 3064
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; *$* curl -Ss &quot;
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot">http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot</a>;
&gt;&gt;&gt;&gt; | jq '.[] | length'
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 2987
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; *$* curl -Ss &quot;
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot">http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot</a>;
&gt;&gt;&gt;&gt; | jq '.[] | length'
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; 705
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; *$* curl -Ss &quot;
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot">http://riak.default.svc.cluster.local:8098/buckets/users/keys?keys=true&quot</a>;
&gt;&gt;&gt;&gt; | jq '.[] | length'
&gt;&gt;&gt;&gt; 3064
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Is there a way to fix this? I guess this is caused by the missing old
&gt;&gt;&gt;&gt; ring-state?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Greetings
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Jan
&gt;&gt;&gt;&gt;
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; &lt;javascript:_e(%7B%7D,'cvml','riak-users@lists.basho.com');&gt;
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; &lt;javascript:_e(%7B%7D,'cvml','riak-users@lists.basho.com');&gt;
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17459.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd4.html#17460">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail4.html#17460">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17461.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg17454.html">How to cold (re)boot a cluster with already existing node ...</a></span> <span class="sender italic">Jan-Philip Loos</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17455.html">Re: How to cold (re)boot a cluster with already exist...</a></span> <span class="sender italic">DeadZen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17457.html">Re: How to cold (re)boot a cluster with already e...</a></span> <span class="sender italic">Jan-Philip Loos</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg17456.html">Re: How to cold (re)boot a cluster with already exist...</a></span> <span class="sender italic">Alex Moore</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17458.html">Re: How to cold (re)boot a cluster with already e...</a></span> <span class="sender italic">Jan-Philip Loos</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17459.html">Re: How to cold (re)boot a cluster with alrea...</a></span> <span class="sender italic">Sargun Dhillon</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: How to cold (re)boot a cluster with a...</span> <span class="sender italic">DeadZen</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: How to cold (re)boot a cluster with already existing node data">
<input type="hidden" name="msgid" value="CAAaFgHsqtGpKxr2XQeu-W7Vp4phdAayJgTPywyUNzy9DCSvC6g@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17460.html">
<input type="submit" value=" DeadZen ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+How+to+cold+%5C%28re%5C%29boot+a+cluster+with+already+existing+node+data%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17459.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17461.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAAaFgHsqtGpKxr2XQeu-W7Vp4phdAayJgTPywyUNzy9DCSvC6g@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
