<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak 2i http query much faster than python api?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10846" id="c">
<link rel="index" href="maillist.html#10846" id="i">
<link rel="prev" href="msg10845.html" id="p">
<link rel="next" href="msg10849.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10846.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+2i+http+query+much+faster+than+python+api%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak 2i http query much faster than python api?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Christian+Dahlqvist%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Christian Dahlqvist</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130411" rel="nofollow">Thu, 11 Apr 2013 00:44:34 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Jeff,

Segmenting the keys based on some random number will allow you to run smaller 
jobs, but if you still need to run all the batches in order to get a result, I 
am not sure you have gained much. Exactly what the best way to process and 
prepare data depends highly on your use case and what your access patterns will 
look like and how you need to query your access/data.</pre><pre>

One way to spread the cost of aggregating data may be to add a timestamp as a 
secondary index and periodically aggregate data for specific time periods that 
make sense to your application. Further aggregation can then later be based on 
these aggregation records rather than the individual records, which will most 
likely be much faster.

If you can provide additional details about your use case, expected access 
patterns and queries we might be able to help better. If you do not feel 
comfortable sharing it here on the list, please feel free to email me directly.

Best regards,

Christian



On 11 Apr 2013, at 03:49, Jeff Peck &lt;je...@tnrglobal.com&gt; wrote:

&gt;&gt; Out of curiousity, how are you planning on segmenting the data?
&gt;&gt; 
&gt; 
&gt; My plan to segment the data would be to have a secondary index on a key 
&gt; called seg_id (or something similar).
&gt; 
&gt; When I add an object to Riak, I will set seg_id to be the first three 
&gt; characters of the md5 of the object's key, which should yield an even 
&gt; distribution.
&gt; 
&gt; Then, when querying the data, I will run map-reduce against each segment (so 
&gt; for 3 hexadecimal characters, it would be 4,096 map-reduce queries).
&gt; 
&gt; The inputs part of the query would look like this:
&gt; 
&gt; &quot;inputs&quot;:{
&gt;        &quot;bucket&quot;:&quot;mybucket&quot;,
&gt;        &quot;index&quot;:&quot;seg_id_bin&quot;,
&gt;        &quot;key&quot;:&quot;aaa&quot;
&gt;     }
&gt; 
&gt; I would run the map-reduce queries in parallel.
&gt; 
&gt; It sounds like a lot of work to just get the value of one field, which makes 
&gt; me think that there is a better way. Plus, I do not know that this will 
&gt; actually work as fast as I expect it to. That's why I'm asking here before I 
&gt; implement it.
&gt;&gt; Also, how are you setting up your servers? Single nodes? Multiple nodes?
&gt;&gt; 
&gt; 
&gt; I am using the default Riak installation (with leveldb as the backend and 
&gt; search turned on). I am on a 16 core 3Ghz node with 20Gb of memory, however 
&gt; it appears that Riak is not using all of the resources available to it. I 
&gt; suspect that this can be resolved by modifying the configuration
&gt; 
&gt; That said, if you, or anyone reading this, could suggest a configuration that 
&gt; is more suited for performing a relatively small batch operation across 900k 
&gt; (and soon to be about 5 million) or objects, that would be greatly 
&gt; appreciated.
&gt; 
&gt; Thanks!
&gt; 
&gt; - Jeff
&gt; 
&gt; 
&gt; On Apr 10, 2013, at 10:32 PM, Shuhao Wu &lt;shu...@shuhaowu.com&gt; wrote:
&gt; 
&gt;&gt; Out of curiousity, how are you planning on segmenting the data? Map reduce 
&gt;&gt; will execute over the entire data set.
&gt;&gt; 
&gt;&gt; Also, how are you setting up your servers? Single nodes? Multiple nodes?
&gt;&gt; 
&gt;&gt; Shuhao
&gt;&gt; Sent from my phone.
&gt;&gt; 
&gt;&gt; On 2013-04-10 10:25 PM, &quot;Jeff Peck&quot; &lt;je...@tnrglobal.com&gt; wrote:
&gt;&gt; As a follow-up to this thread and my thread from earlier today, I am 
&gt;&gt; basically looking for a simple way to extract the value of a single field 
&gt;&gt; from approximately 900,000 documents (which happens to be indexed). I have 
&gt;&gt; been trying many options including a map-reduce function that executes 
&gt;&gt; entirely over http (taking out any python client bottlenecks). I let that 
&gt;&gt; run for over an hour before I stopped it. It did not return any output.
&gt;&gt; 
&gt;&gt; I also have tried grabbing a list of the 900k keys from a secondary index 
&gt;&gt; (very fast, about 11 seconds) and then trying to fetch each key in parallel 
&gt;&gt; (using curl and gnu parallel). That was also too slow to be feasible.
&gt;&gt; 
&gt;&gt; Is there something basic that I am missing?
&gt;&gt; 
&gt;&gt; One idea that I though of was to have a secondary index that is intended to 
&gt;&gt; split all of my data into segments. I would use the first three characters 
&gt;&gt; of the md5 of the document's key in hexadecimal format. So, the index would 
&gt;&gt; contain strings like &quot;ae1&quot;, &quot;2f4&quot;, &quot;5ee&quot;, etc. Then, I can run my map-reduce 
&gt;&gt; query against *each* segment individually and possibly even in parallel.
&gt;&gt; 
&gt;&gt; I have observed that map-reduce is very fast with small sets of data (i.e. 
&gt;&gt; 5,000 objects), but with 900,000 objects it does not appear to run in a 
&gt;&gt; proportionately fast time. So, the idea is to divide the data into segments 
&gt;&gt; that can be better handled by map-reduce.
&gt;&gt; 
&gt;&gt; Before I implement this, I want to ask: Does this seem like the appropriate 
&gt;&gt; way to handle this type of operation? And, is there any better way to do 
&gt;&gt; this in the current version of Riak?
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Apr 10, 2013, at 6:10 PM, Shuhao Wu &lt;shu...@shuhaowu.com&gt; wrote:
&gt;&gt; 
&gt;&gt;&gt; There are some inefficiencies in the python client... I've been profiling 
&gt;&gt;&gt; it recently and found that it occasionally takes the python client longer 
&gt;&gt;&gt; when you're on the same machine.
&gt;&gt;&gt; 
&gt;&gt;&gt; Perhaps Sean could comment?
&gt;&gt;&gt; 
&gt;&gt;&gt; Shuhao
&gt;&gt;&gt; Sent from my phone.
&gt;&gt;&gt; 
&gt;&gt;&gt; On 2013-04-10 4:04 PM, &quot;Jeff Peck&quot; &lt;je...@tnrglobal.com&gt; wrote:
&gt;&gt;&gt; Thanks Evan. I tried doing it in python like this (realizing that the 
&gt;&gt;&gt; previous way I did it uses MapReduce) and I had better results. It finished 
&gt;&gt;&gt; in 3.5 minutes, but nowhere close to the 15 seconds from the straight http 
&gt;&gt;&gt; query:
&gt;&gt;&gt; 
&gt;&gt;&gt; import riak
&gt;&gt;&gt; from pprint import pprint
&gt;&gt;&gt; 
&gt;&gt;&gt; bucket_name = &quot;mybucket&quot;
&gt;&gt;&gt; 
&gt;&gt;&gt; client = riak.RiakClient(port=8087,transport_class=riak.RiakPbcTransport)
&gt;&gt;&gt; bucket = client.bucket(bucket_name)
&gt;&gt;&gt; results = bucket.get_index('status_bin', 'PERSISTED')
&gt;&gt;&gt; 
&gt;&gt;&gt; print len(results)
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Apr 10, 2013, at 4:00 PM, Evan Vigil-McClanahan &lt;emcclana...@basho.com&gt; 
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; &gt; get_index() is the right function there, I think.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; On Wed, Apr 10, 2013 at 2:53 PM, Jeff Peck &lt;je...@tnrglobal.com&gt; wrote:
&gt;&gt;&gt; &gt;&gt; I can grab over 900,000 keys from an indexs, using an http query in 
&gt;&gt;&gt; &gt;&gt; about 15 seconds, whereas the same operation in python times out after 5 
&gt;&gt;&gt; &gt;&gt; minutes. Does this indicate that I am using the python API incorrectly? 
&gt;&gt;&gt; &gt;&gt; Should I be relying on an http request initially when I need to grab 
&gt;&gt;&gt; &gt;&gt; this many keys?
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; (Note: This is tied to the question that I asked earlier, but is also a 
&gt;&gt;&gt; &gt;&gt; general question to help understand the proper usage of the python API.)
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; Thanks! Examples are below.
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; - Jeff
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; ---
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; HTTP:
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; $ time curl -s 
&gt;&gt;&gt; &gt;&gt; <a  rel="nofollow" href="http://localhost:8098/buckets/mybucket/index/status_bin/PERSISTED">http://localhost:8098/buckets/mybucket/index/status_bin/PERSISTED</a> | grep 
&gt;&gt;&gt; &gt;&gt; -o , | wc -l
&gt;&gt;&gt; &gt;&gt; 926047
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; real    0m14.583s
&gt;&gt;&gt; &gt;&gt; user    0m2.500s
&gt;&gt;&gt; &gt;&gt; sys     0m0.270s
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; ---
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; Python:
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; import riak
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; bucket = &quot;my bucket&quot;
&gt;&gt;&gt; &gt;&gt; client = riak.RiakClient(port=8098)
&gt;&gt;&gt; &gt;&gt; results = client.index(bucket, 'status_bin', 
&gt;&gt;&gt; &gt;&gt; 'PERSISTED').run(timeout=5*60*1000) # 5 minute timeout
&gt;&gt;&gt; &gt;&gt; print len(results)
&gt;&gt;&gt; &gt;&gt;
&gt;&gt;&gt; &gt;&gt; (times out after 5 minutes)
&gt;&gt;&gt; &gt;&gt; _______________________________________________
&gt;&gt;&gt; &gt;&gt; riak-users mailing list
&gt;&gt;&gt; &gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; &gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10845.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10846">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10846">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10849.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10834.html">Riak 2i http query much faster than python api?</a></span> <span class="sender italic">Jeff Peck</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10835.html">Re: Riak 2i http query much faster than python ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10836.html">Re: Riak 2i http query much faster than pyt...</a></span> <span class="sender italic">Jeff Peck</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10843.html">Re: Riak 2i http query much faster than...</a></span> <span class="sender italic">Jeff Peck</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10844.html">Re: Riak 2i http query much faster ...</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10845.html">Re: Riak 2i http query much fa...</a></span> <span class="sender italic">Jeff Peck</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak 2i http query muc...</span> <span class="sender italic">Christian Dahlqvist</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10849.html">Re: Riak 2i http query much faster ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10852.html">Re: Riak 2i http query much fa...</a></span> <span class="sender italic">Shuhao</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10853.html">Re: Riak 2i http query muc...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak 2i http query much faster than python api?">
<input type="hidden" name="msgid" value="8E1629A7-824C-4E4A-9DAA-BA9F50321F02@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10846.html">
<input type="submit" value=" Christian Dahlqvist ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+2i+http+query+much+faster+than+python+api%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10845.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10849.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">8E1629A7-824C-4E4A-9DAA-BA9F50321F02@basho.com</li>
</ul>
</div>
</body>
</html>
