<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Using withoutFetch with DomainBucket</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#10380" id="c">
<link rel="index" href="mail2.html#10380" id="i">
<link rel="prev" href="msg10379.html" id="p">
<link rel="next" href="msg10451.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10380.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Using+withoutFetch+with+DomainBucket%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Using withoutFetch with DomainBucket</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Brian+Roach%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Brian Roach</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130312" rel="nofollow">Tue, 12 Mar 2013 11:06:13 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Daniel -

Nothing detects whether there is a vclock or not. If there isn't one
provided (the value is `null` in Java), then one isn't sent to Riak -
it is not a requirement for a store operation for it to be present. If
an object exists when such a store is performed and allow_multi=true
for the bucket, then a sibling is created.</pre><pre>

The .withoutFetch() method was added to the StoreObject as a requested
feature. It is meant for when you are storing an object that was
previously fetched from Riak and want to avoid doing another fetch. If
that previous fetch returned nothing (the key was not found) then the
vector clock will be null.

When talking about deleted keys ... unless you change the default
`delete_mode` in Riak's app.config, you're not usually going to get a
tombstone - they are reaped after 3s.  Unless either you do a fetch
immediately following a delete, you're doing store operations without
vclocks with allow_multi=true for the bucket (which is basically
&quot;doing it wrong&quot;) immediately after a delete and a sibling gets
created, or hit a very small window with multiple writers under heavy
load where the read/write cycle interleaves with a delete and a
tombstone sibling gets created.

With that being said, yes, unless you set 'returnDeletedVClock(true)`
they are silently discarded by the Java client and not passed to the
Converter. If that has been set, the default JSONConverter will return
a new instance of whatever POJO is being used (if possible - if
there's not a default constructor it will throw an exception) and then
set a @RiakTombstone annotated boolean field to `true` if one exists.
It detects this by calling the .isDeleted() method of the returned
IRiakObject.

- Roach

On Tue, Mar 12, 2013 at 9:43 AM, Daniel Iwan &lt;iwan.dan...@gmail.com&gt; wrote:
&gt; Brian,
&gt;
&gt; Where I got lost was the fact that I was using custom Converter and I did
&gt; not do anything with vclock passed into fromDomain().
&gt; That was undetected because at the same time I wasn't using withoutFetch,
&gt; which I believe is the only moment where missing @RiakVClock annotation
&gt; can be detected. Normally when JSONConverter is used missing @RiakVClock
&gt; would also be detected.
&gt; Could you confirm?
&gt;
&gt; Few additional, related questions:
&gt; - if I use byte[] or VClock field and use withoutFetch() what is default
&gt; value it should be set to (since it will be extracted via StoreObject)?
&gt; - if I want to avoid overwriting deleted keys, I guess I need to set
&gt; returnDeletedVClock as below,
&gt;      DomainBucketBuilder&lt;Custom&gt; builder = DomainBucket.builder(bucket,
&gt; Custom.class)
&gt;      builder.returnDeletedVClock(true);
&gt;
&gt; and then check isDeleted on sibblings and use ConditionalStoreMutation to
&gt; return false id one of he sibblings has that flag set to true?
&gt; I believe it needs to use VClock of deleted sibbling as well?
&gt;
&gt; Thanks
&gt; Daniel
&gt;
&gt;
&gt;
&gt;&gt; The .withoutFetch() method isn't available when using the DomanBucket.
&gt;&gt;
&gt;&gt; As for the vector clock, when using .withoutFetch() the .execute()
&gt;&gt; method of StoreObject is going to extract the vector clock from the
&gt;&gt; POJO returned from your Mutation by looking for a VectorClock or
&gt;&gt; byte[] field that is annotated with @RiakVClock. It is then passed to
&gt;&gt; the Converter's .fromDomain() method as an argument.  If you are
&gt;&gt; storing an object you previously fetched from Riak, that vector clock
&gt;&gt; and annotation needs to be there.
&gt;&gt;
&gt;&gt; The easiest way to implement that is:
&gt;&gt; 1. Have a VectorClock or byte[] field in your POJO annotated with
&gt;&gt; @RiakVClock
&gt;&gt;
&gt;&gt; 2. When you fetch, in the .toDomain() method of your Converter have
&gt;&gt; the line of code you noted.
&gt;&gt;
&gt;&gt; 3. When you store, the vector clock stored in that field will be
&gt;&gt; passed to the .fromDomain() method of your Converter. Make sure to
&gt;&gt; call the .withVClock(vclock) method of the RiakObjectBuilder or
&gt;&gt; explicitly set it in the IRiakObject being returned.
&gt;&gt;
&gt;&gt; - Roach
&gt;&gt;
&gt;&gt;
&gt;&gt; On Fri, Mar 8, 2013 at 3:31 PM, Daniel Iwan &lt;iwan.dan...@gmail.com&gt; wrote:
&gt;&gt; &gt; Somehow I cannot find a way to avoid pre-fetch during store operation
&gt;&gt; &gt; (Java
&gt;&gt; &gt; client).
&gt;&gt; &gt; I know in StoreObject there is withoutFetch method for that purpose but
&gt;&gt; &gt; I
&gt;&gt; &gt; cannot find corresponding method/property in DomainBucket or
&gt;&gt; &gt; DomainBucketBuilder
&gt;&gt; &gt;
&gt;&gt; &gt; Am I missing something?
&gt;&gt; &gt;
&gt;&gt; &gt; Also on related note when withoutFetch is used I guess I need to provide
&gt;&gt; &gt; annotated RiakVClock field and use something like:
&gt;&gt; &gt;
&gt;&gt; &gt; VClockUtil.setVClock(domainObject, riakObject.getVClock());
&gt;&gt; &gt;
&gt;&gt; &gt; in my Converter. Is that right or is there better way to do it?
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; I'm using Riak Java client 1.1.0
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks
&gt;&gt; &gt; Daniel
&gt;&gt; &gt;
&gt;&gt; &gt; _______________________________________________
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; &gt;
&gt;
&gt;

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10379.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#10380">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#10380">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10451.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10366.html">Using withoutFetch with DomainBucket</a></span> <span class="sender italic">Daniel Iwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10378.html">Re: Using withoutFetch with DomainBucket</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10379.html">Re: Using withoutFetch with DomainBucket</a></span> <span class="sender italic">Daniel Iwan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Using withoutFetch with DomainBucket</span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10451.html">Re: Using withoutFetch with DomainBucket</a></span> <span class="sender italic">Daniel Iwan</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Using withoutFetch with DomainBucket">
<input type="hidden" name="msgid" value="CAM+FMBsTaVZwygn9niNP3Ooex6nzvUgZiYdzUrGYARpBynh3Kw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10380.html">
<input type="submit" value=" Brian Roach ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Using+withoutFetch+with+DomainBucket%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10379.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10451.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAM+FMBsTaVZwygn9niNP3Ooex6nzvUgZiYdzUrGYARpBynh3Kw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
