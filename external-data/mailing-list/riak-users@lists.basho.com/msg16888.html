<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Solr indexes are dropped after recovering a node</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16888" id="c">
<link rel="index" href="maillist.html#16888" id="i">
<link rel="prev" href="msg16886.html" id="p">
<link rel="next" href="msg16887.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16888.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Solr+indexes+are+dropped+after+recovering+a+node%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Solr indexes are dropped after recovering a node</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Fred+Dushin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Fred Dushin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151224" rel="nofollow">Thu, 24 Dec 2015 08:02:31 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Istvan,

A couple of questions:</pre><pre>

1. Do the buckets (or bucket types) the data is written to still contain the 
search index to be used to index the data?
2. Did the indices get re-created on the new nodes you added?  You can verify 
this by looking at /var/lib/riak/yz/&lt;index-name&gt; (or wherever your platform 
data directory is on your platform), where &lt;index-name&gt; is the name of the index
3. Do you have AAE enabled?

If the indices have been removed on all of the nodes, you will need to recreate 
them, via the riak-admin command [1].

If you have AAE enabled, data should get reindexed when the trees expire.  You 
can force them to expire via riak attach:

shell$ bin/riak attach
Remote Shell: Use &quot;Ctrl-C a&quot; to quit. q() or init:stop() will terminate the 
riak node.
Erlang R16B02_basho9 (erts-5.10.3) [source] [64-bit] [smp:8:8] 
[async-threads:10] [kernel-poll:false] [dtrace]

Eshell V5.10.3  (abort with ^G)
(dev1@127.0.0.1)1&gt; yz_entropy_mgr:expire_trees().  
ok

It may take some time for the trees to rebuild, but eventually you should see 
entries in the log, such as

2015-12-23 21:18:04.536 [info] &lt;0.4457.0&gt;@yz_exchange_fsm:key_exchange:176 Will 
repair 342 keys of partition 0 for preflist 
{1278813932664540053428224228626747642198940975104,3}
2015-12-23 21:18:19.541 [info] &lt;0.4533.0&gt;@yz_exchange_fsm:key_exchange:176 Will 
repair 368 keys of partition 0 for preflist 
{1370157784997721485815954530671515330927436759040,3}
2015-12-23 21:18:34.560 [info] &lt;0.4609.0&gt;@yz_exchange_fsm:key_exchange:176 Will 
repair 347 keys of partition 0 for preflist {0,3}

If you are not happy with that pace, you can adjust the hash tree build limits 
as described in the &quot;Hash Trees&quot; section of [2].  Those settings are for 
Riak/KV AAE, but YZ will inherit them automatically on restart.  If you only 
want to adjust these settings for YZ AAE, you can use the settings listed in 
[3], but you'll need to set those in your advanced.config, as I do not believe 
we have cuttlefish schema for these settings.

Some examples:

# riak.conf
anti_entropy.tree.build_limit.per_timespan = 1m
anti_entropy.tree.build_limit.number = 5

%% advanced.config
...
{yokozuna, [{anti_entropy_concurrency, 5}, {anti_entropy_build_limit, {5, 
60000}}]}
...

Hope that helps.

-Fred

[1] <a  rel="nofollow" href="http://docs.basho.com/riak/latest/dev/using/search/">http://docs.basho.com/riak/latest/dev/using/search/</a> 
&lt;<a  rel="nofollow" href="http://docs.basho.com/riak/latest/dev/using/search/">http://docs.basho.com/riak/latest/dev/using/search/</a>&gt;
[2] <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/aae/#Configuring-AAE">http://docs.basho.com/riak/latest/ops/advanced/aae/#Configuring-AAE</a> 
&lt;<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/aae/#Configuring-AAE">http://docs.basho.com/riak/latest/ops/advanced/aae/#Configuring-AAE</a>&gt;
[3] <a  rel="nofollow" href="https://github.com/basho/yokozuna/blob/2.1.1/include/yokozuna.hrl#L192">https://github.com/basho/yokozuna/blob/2.1.1/include/yokozuna.hrl#L192</a>



&gt; On Dec 23, 2015, at 5:10 PM, István &lt;lecc...@gmail.com&gt; wrote:
&gt; 
&gt; Hi Jason,
&gt; 
&gt; Actually I was moving nodes, one by one. I guess I was missing the riak-admin 
&gt; replace command. Is there an easy way of restoring Solr indexes on disk on a 
&gt; node? The data is fine after the recovery but the index data got deleted in 
&gt; the yz folder. Any advice how to restore it when a cluster is running and the 
&gt; data is there?
&gt; 
&gt; If the fastest way to recover is the reload the entire dataset that is fine 
&gt; too.
&gt; 
&gt; Thank you in advance,
&gt; Istvan
&gt; 
&gt; On Wed, Dec 23, 2015 at 7:51 PM, Jason Voegele &lt;jvoeg...@basho.com 
&gt; &lt;<a  rel="nofollow" href="mailto:jvoeg...@basho.com">mailto:jvoeg...@basho.com</a>&gt;&gt; wrote:
&gt;&gt; On Dec 23, 2015, at 12:54 PM, István &lt;lecc...@gmail.com 
&gt;&gt; &lt;<a  rel="nofollow" href="mailto:lecc...@gmail.com">mailto:lecc...@gmail.com</a>&gt;&gt; wrote:
&gt;&gt; 
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; I had to move the nodes of a Riak cluster to new ones. Everything is fine 
&gt;&gt; with the data, we have been following the recovery procedures here:
&gt;&gt; 
&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/backups/#Restoring-a-Node">http://docs.basho.com/riak/latest/ops/running/backups/#Restoring-a-Node</a> 
&gt;&gt; &lt;<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/backups/#Restoring-a-Node">http://docs.basho.com/riak/latest/ops/running/backups/#Restoring-a-Node</a>&gt;
&gt;&gt; 
&gt;&gt; After the moving all of the nodes I found out that all of the Solr indexes 
&gt;&gt; are gone.
&gt; 
&gt; Hi Istvan,
&gt; 
&gt; It looks like you are restoring an entire cluster, not just a single node 
&gt; within a cluster. If so, the relevant recovery procedures are documented on 
&gt; this page:
&gt; 
&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/recovery/failure-recovery/#Cluster-Recovery-From-Backups">http://docs.basho.com/riak/latest/ops/running/recovery/failure-recovery/#Cluster-Recovery-From-Backups</a>
&gt;  
&gt; &lt;<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/recovery/failure-recovery/#Cluster-Recovery-From-Backups">http://docs.basho.com/riak/latest/ops/running/recovery/failure-recovery/#Cluster-Recovery-From-Backups</a>&gt;
&gt; 
&gt; Can you try following the full cluster recovery procedure and see if that 
&gt; solves the problem?
&gt; 
&gt; -- 
&gt; Jason Voegele
&gt; Manly's Maxim:
&gt;       Logic is a systematic method of coming to the wrong conclusion
&gt;       with confidence.
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 
&gt; &lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; the sun shines for all
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16886.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16888">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16888">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16887.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16884.html">Solr indexes are dropped after recovering a node</a></span> <span class="sender italic">István</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16885.html">Re: Solr indexes are dropped after recovering a node</a></span> <span class="sender italic">Jason Voegele</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16886.html">Re: Solr indexes are dropped after recovering a nod...</a></span> <span class="sender italic">István</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Solr indexes are dropped after recovering a...</span> <span class="sender italic">Fred Dushin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Solr indexes are dropped after recovering a node">
<input type="hidden" name="msgid" value="24A7AAC6-6554-4C08-80BE-618E5CE65711@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16888.html">
<input type="submit" value=" Fred Dushin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Solr+indexes+are+dropped+after+recovering+a+node%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16886.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16887.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">24A7AAC6-6554-4C08-80BE-618E5CE65711@basho.com</li>
</ul>
</div>
</body>
</html>
