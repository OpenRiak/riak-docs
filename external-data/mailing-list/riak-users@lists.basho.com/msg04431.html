<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak Map Reduce Performance</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#04431" id="c">
<link rel="index" href="maillist.html#04431" id="i">
<link rel="prev" href="msg04418.html" id="p">
<link rel="next" href="msg04473.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg04431.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+Map+Reduce+Performance%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak Map Reduce Performance</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Fisher%2C+Ryan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Fisher, Ryan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110823" rel="nofollow">Tue, 23 Aug 2011 12:10:50 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi all,

We have been using riak for a few months now (started using 14.0 and we
have recently upgraded to 14.2).  Development of our app has been going
well and I am now integrating my code w/ a larger system.  The testing of
the overall read / write performance of our cluster seems good as well.</pre><pre>

I am now starting to dive further into map reduce queries, and unlike the
regular read / writes that seem to perform very fast, I am seeing map
reduce performance is getting worse as our data set grows.

The query I am using to test the map / reduce speed and get a key count is
this:

map = function (v) { return [1]; }
reduce = Riak.reduceSum


It takes 138 seconds using that query on a bucket w/ 50,000 keys.
It takes around 20 seconds using that query on a bucket w/ 108 keys.

Do these query times for map reduce seem appropriate?

I'll try and give an overall picture of how we currently use riak and
maybe someone can say if the performance of our map / reduce operations is
on par or if there are things I could tweak to try and get the query times
to come down a bit.

The system we have sends data to riak at a fairly fast pace and we need to
keep all incoming data for 30 minutes, so we can examine the data and
retrieve any individual keys.  After 30 minutes we can aggregate messages
into groups to reduce the overall number of keys and data.

We currently have an &quot;incoming&quot; bucket where keys are written at a rate of
around 20 / second.  An archiving thread checks every so often for keys
that are older then 30 min. and if it finds any it removes them from the
'incoming' bucket and aggregates them into an 'archive' bucket for the
given hour.  

As you can imagine this causes the bitcask files to fragment and grow
fairly large, however it seems like the best way to maintain some
granularity of the data, but not be forced to keep every single data point
that flows into the system.  It also gives us a predictable growth rate
for the 'archive' bucket even if the 'incoming' data increases beyond the
20 / second. 

One thing I was wondering and planning on trying was to reduce the bitcask
configuration merge threshold and trigger values to help keep the files a
little smaller which might help the map reduce performance some?  Or
should that even matter since I'm only looking through keys and those
should be in memory anyway?

We currently have a 4 node cluster running ubuntu 11.04 x64.  Each riak
node has 8 GB of memory, and 'free Â­m' on the nodes reports around 4000
used and 4000 free on average.

Basho Bench using the riakc_pb.config with a get=1, update=2, and put=3
for 5 minutes seems to be good... Here is the graph:
<a  rel="nofollow" href="http://tinypic.com/r/30tm977/7">http://tinypic.com/r/30tm977/7</a>

So does anyone have any similarly sized systems where they use map reduce?
 Or can anyone recommend performance tweaks I can make that would help
accelerate these queries?

Thank you,
-ryan
</pre>
<p><strong><a href="msg04431/smime.p7s" ><img src="../attachment.png" alt="Attachment:" width=27 height=28></a>
<a href="msg04431/smime.p7s" >smime.p7s</a></strong><br>
<em>Description:</em> S/MIME cryptographic signature</p>
<pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg04418.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#04431">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#04431">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04473.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak Map Reduce Performance</span> <span class="sender italic">Fisher, Ryan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04473.html">Fwd: Riak Map Reduce Performance</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak Map Reduce Performance">
<input type="hidden" name="msgid" value="CA797306.B01%rfisher@cyberpointllc.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg04431.html">
<input type="submit" value=" Fisher, Ryan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+Map+Reduce+Performance%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg04418.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04473.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA797306.B01%rfisher@cyberpointllc.com</li>
</ul>
</div>
</body>
</html>
