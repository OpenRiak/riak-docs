<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: cluster health check using riak-java-client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16857" id="c">
<link rel="index" href="maillist.html#16857" id="i">
<link rel="prev" href="msg16856.html" id="p">
<link rel="next" href="msg16967.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16857.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+cluster+health+check+using+riak%5C-java%5C-client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: cluster health check using riak-java-client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22David+Byron%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">David Byron</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151213" rel="nofollow">Sun, 13 Dec 2015 17:33:51 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<tt>Thanks for this.  I think in the end I'm going to assume there's 
</tt><tt>sufficient traffic that the node state that riak-java-client keeps track 
</tt><tt>of is up to date enough.
</tt><pre style="margin: 0em;">

</pre><tt>Of course I have yet another question.  Even if I assume the state of 
</tt><tt>each node is correct, how do I know if the cluster overall is considered 
</tt><tt>healthy?  This may not be a valid question, but I hope it is.  For 
</tt><tt>example, if the cluster configuration requires 3 nodes to write, I can 
</tt><tt>write some fairly detailed code in riak-java-client to realize that's 
</tt><tt>the configuration and count that there are enough healthy nodes. 
</tt><tt>However, if I'm using something like haproxy, I'm not sure there's a 
</tt><tt>great spot to put that logic.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>Is there a way to query the cluster overall to ask a health question 
</tt><tt>like this?
</tt><pre style="margin: 0em;">

-DB

On 12/8/15 1:09 PM, Alexander Sicular wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Besides just plainly writing a key, you could also do something like (pseudo 
code):

Riak.put(canaryKey, pw=n_val){
   If ok -&gt; cool!
   If borked -&gt; sad face
}

The important bit is the pw (primary write) equals your replication value. This 
means that all copies in the virtual node replica set need to go to virtual 
nodes allocated to their primary physical machines. This is a way you can check 
cluster status from the app level as in , is the cluster in some kind of borked 
state.

-Alexander

@siculars
<a  rel="nofollow" href="http://siculars.posthaven.com">http://siculars.posthaven.com</a>

Sent from my iRotaryPhone

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Dec 8, 2015, at 14:13, David Byron &lt;dby...@dbyron.com&gt; wrote:

I'm still curious what people think here.  As I stare at this longer, I'd like 
to be able to call RiakNode.checkHealth(), but it's private.

HealthMonitorTask.run that only calls checkHealth some of the time, so without 
the ability to call it directly, I think I'm getting a stale notion of health 
in circumstances like I outlined below -- when the last operation was 
successful, but the node has since gone down.

Thanks for your input.

-DB

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 12/2/15 10:25 PM, David Byron wrote:
I'm implementing a health check for a service of mine that uses riak.
I've seen this code from
<a  rel="nofollow" href="https://github.com/basho/riak-java-client/issues/456:">https://github.com/basho/riak-java-client/issues/456:</a>

RiakCluster cluster = clientInstance.getRiakCluster();
List&lt;RiakNode&gt; nodes = cluster.getNodes();
for (RiakNode node : nodes)
{
   State state = node.getNodeState();
}

and it's great.  From what I can tell, it depends on some background
processing that keeps track of the state of the nodes.  I did a quick
test though, and if I run 'riak stop' from the command line and then
this loop with no intervening operations, the nodes report RUNNING. Even
after some time passes (more than three minutes), still RUNNING.

However, if I run do run an intervening operation (some actual query of
data for example) that fails, the nodes then report HEALTH_CHECKING.
Then, after 'riak start', the nodes report RUNNING again.  I suppose
that's good.

So, I'm trying to decide how to implement the health check.  The above
loop doesn't seem to be enough, but do I really need to do something like:

final RiakFuture&lt;Void, Void&gt; future = cluster.execute(new PingOperation());

try {
   future.await();
   future.get();
} catch (ExecutionException | InterruptedException e) {
   // bad
}
// good

Maybe it's sufficient to only do this if all the nodes report RUNNING? I
suppose there's always a small window in time where a node could report
bad, but via a ping I'd learn it was up...so I'm torn.  Any suggestions
for whether pinging every time is correct, or there's something more
efficient (and safe)?

Thanks for your help.

-DB
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16856.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16857">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16857">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16967.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16840.html">cluster health check using riak-java-client</a></span> <span class="sender italic">David Byron</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16855.html">Re: cluster health check using riak-java-client</a></span> <span class="sender italic">David Byron</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16856.html">Re: cluster health check using riak-java-client</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: cluster health check using riak-java-cl...</span> <span class="sender italic">David Byron</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16967.html">Re: cluster health check using riak-jav...</a></span> <span class="sender italic">Luke Bakken</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: cluster health check using riak-java-client">
<input type="hidden" name="msgid" value="566E1C15.9080308@dbyron.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16857.html">
<input type="submit" value=" David Byron ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+cluster+health+check+using+riak%5C-java%5C-client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16856.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16967.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">566E1C15.9080308@dbyron.com</li>
</ul>
</div>
</body>
</html>
