<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Slow write performance for Riak CS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd15.html#11188" id="c">
<link rel="index" href="mail15.html#11188" id="i">
<link rel="prev" href="msg11187.html" id="p">
<link rel="next" href="msg11184.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11188.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Slow+write+performance+for+Riak+CS%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Slow write performance for Riak CS</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130528" rel="nofollow">Tue, 28 May 2013 19:29:50 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 29/05/13 06:12, Reid Draper wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hey Toby,</pre><pre>

Another option is to explore some of the Riak CS PUT configuration parameters, 
like the internal write concurrency and the buffer size. These can either be 
changed by editing the app.config, or changing them at run-time in an Erlang 
shell (via riak-cs attach). The two parameters are `put_concurrency` and 
`put_buffer_factor`.

They both default to 1. The `put_concurrency` controls the number of threads 
inside of Riak CS that are used to write blocks to Riak. The 
`put_buffer_factor` controls the number of blocks that will be buffered 
in-memory in Riak CS before it starts to slow down reading from the HTTP 
client. I suggesting trying to raise these values to get higher single-client 
throughput. If you wish to edit the app.config, add lines like in the `riak_cs` 
section:

{put_concurrency, 8},
{put_buffer_factor, 16},
</pre></blockquote><pre style="margin: 0em;">


</pre><tt>Ah, thanks -- that's interesting. Bumping up those up a bit did improve 
</tt><tt>things a bit -- I went for a conservative concurrency of 4, 
</tt><tt>buffer_factor of 8, and that took speeds on 500M files from 8-9mb/s to 
</tt><tt>12-13mb/sec.
</tt><pre style="margin: 0em;">

</pre><tt>Might play with other values when I next get time, but for now that's a 
</tt><tt>good cheap win.
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
In increasing these values, you might also find it useful to run a load 
balancer between the Riak CS and Riak nodes, instead of having Riak CS just 
communicate with the local Riak node. We intend to have this behavior built 
into Riak CS in the future, but for now a load balancer will suffice.
</pre></blockquote><pre style="margin: 0em;">

Ah, ta. Can do.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Furthermore, please make sure you've looked through the Linux Tuning page for 
Riak [1]. And as for +zdbbl, you can try even higher, like 128MB: +zdbbl 131072.
</pre></blockquote><pre style="margin: 0em;">

Thanks.
</pre><tt>I'd been through there already, and applied things like filesystem and 
</tt><tt>scheduler options.
</tt><tt>I haven't touched the networking sysctls since they came with a warning 
</tt><tt>that they should only be messed with if networking *was* the bottleneck.
</tt><pre style="margin: 0em;">

Given what I've mentioned so far, do you think it's likely?
I guess it can't hurt to adjust them and see..

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
[1] 
<a  rel="nofollow" href="http://docs.basho.com/riak/1.3.1/cookbooks/Linux-Performance-Tuning/#Linux-Tuning">http://docs.basho.com/riak/1.3.1/cookbooks/Linux-Performance-Tuning/#Linux-Tuning</a>
</pre></blockquote><pre style="margin: 0em;">


Thanks for your advice,
Toby


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">


Reid

On May 27, 2013, at 11:50 PM, Toby Corkindale 
&lt;toby.corkind...@strategicdata.com.au&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 28/05/13 13:11, Jared Morrow wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Toby,

Can you trying putting data with a second client simultaneously?  When
people have slow benchmarking, lots of times just using multiple
worker/clients helps.  Also, what client library are you using?
</pre></blockquote><pre style="margin: 0em;">

Running up three S3 clients (on separate machines) simultaneously saw them 
return 8, 8, 6 MB/sec. Interesting to note that the performance hasn't dropped 
threefold, but still, it'd be really nice if an individual transfer would run 
faster, given the performance of the underlying hardware.

The nodes hardly get utilised during a write operation. I've uploading a total 
of 1500M from the three nodes, and yet CPUs are 90% idle, and there's no real 
disk activity going on, apart from a couple of times when several hundred get 
flushed out over the course of a second.

I feel like something isn't quite right. What is the system *waiting* for? 
There's plenty of CPU and IO to go around.


In the case of the current benchmarking, I'm using either s3cmd or curl.



</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Also I meant to mention in my first reply, but Boundary
<a  rel="nofollow" href="http://boundary.com/">http://boundary.com/</a> worked wonders for us being able to see how much
data was really moving around.  They have a free trial as far as I know.
  It might be worth it to see if there are any obvious bottlenecks.
</pre></blockquote><pre style="margin: 0em;">

Thanks, I'll have a look and see if the effort of setting it all up looks 
worthwhile.

Cheers,
Toby


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Mon, May 27, 2013 at 8:46 PM, Toby Corkindale
&lt;toby.corkind...@strategicdata.com.au
&lt;<a  rel="nofollow" href="mailto:toby.corkind...@strategicdata.com.au">mailto:toby.corkind...@strategicdata.com.au</a>&gt;&gt; wrote:

    On 28/05/13 01:41, Jared Morrow wrote:

        Toby,

        If you write with multiple clients does it still stick to 9mb/s or
        does it increase?  What is the network link between your client and
        the Riak CS cluster?  On our internal CS cluster we were seeing
        around 2gb/s read+write at the network level so I know CS can take
        the speeds, so my gut thinks you single client might have a slow
        link.  That is just a guess.


    The network links are all Ethernet, and appear to be functioning OK.
    iperf reports:
    bandwidth from client to loadbalancer: 2.20 gbit/sec
    bandwidth from loadbalancer to a riak node: 941 mbit/sec
    bandwidth from one riak node to another node: 942 mbit/s

    I've tested going direct from a client to a riak node rather than
    via the loadbalancer, but it doesn't seem to make any difference.

    Having tested a bit further now, I'd guess that the problem lies
    with Riak rather than Riak CS.

    I've noticed that if I try to push files directly into Riak, they go
    fairly slowly too - around 10-20mbyte/sec.

    I've tried 3, 10 and 50 MB files, against bitcask, leveldb and even
    memory backends, and in all cases I get fairly consistent transfer
    rates in that range. (just using curl for testing here)

    I've tried reducing n_val to 1, there was a small but not
    significant improvement.

    I'm a bit stumped.. However I do note that the log files seem to
    have a lot of &quot;monitor busy_dist_port&quot; messages in them.. I'm
    wondering if that might be related somehow?

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11187.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd15.html#11188">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail15.html#11188">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11184.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11181.html">Re: Slow write performance for Riak CS</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11182.html">Re: Slow write performance for Riak CS</a></span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11183.html">Re: Slow write performance for Riak CS</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11187.html">Re: Slow write performance for Riak CS</a></span> <span class="sender italic">Reid Draper</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Slow write performance for Riak CS</span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Slow write performance for Riak CS">
<input type="hidden" name="msgid" value="51A56751.9090603@strategicdata.com.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11188.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Slow+write+performance+for+Riak+CS%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11187.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11184.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">51A56751.9090603@strategicdata.com.au</li>
</ul>
</div>
</body>
</html>
