<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Yokozuna inconsistent search results</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17171" id="c">
<link rel="index" href="maillist.html#17171" id="i">
<link rel="prev" href="msg17170.html" id="p">
<link rel="next" href="msg17172.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17171.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna+inconsistent+search+results%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Yokozuna inconsistent search results</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Magnus+Kessler%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Magnus Kessler</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160324" rel="nofollow">Thu, 24 Mar 2016 04:29:26 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Oleksiy,

As a first step, I suggest to simply expire the Yokozuna AAE trees again if
the output of `riak-admin search aae-status` still suggests that no recent
exchanges have taken place. To do this, run `riak attach` on one node and
then</pre><pre>

riak_core_util:rpc_every_member_ann(yz_entropy_mgr, expire_trees, [], 5000).


Exit from the riak console with `Ctrl+G q`.

Depending on your settings and amount of data the full index should be
rebuilt within the next 2.5 days (for a cluster with ring size 128 and
default settings). You can monitor the progress with `riak-admin search
aae-status` and also in the logs, which should have messages along the
lines of

2016-03-24 10:28:25.372 [info]
&lt;0.4647.6477&gt;@yz_exchange_fsm:key_exchange:179 Repaired 83055 keys during
active anti-entropy exchange of partition
1210306043414653979137426502093171875652569137152 for preflist
{1164634117248063262943561351070788031288321245184,3}


Re-indexing can put additional strain on the cluster and may cause elevated
latency on a cluster already under heavy load. Please monitor the response
times while the cluster is re-indexing data.

If the cluster load allows it, you can force more rapid re-indexing by
changing a few parameters. Again at the `riak attach` console, run

riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna,
anti_entropy_build_limit, {4, 60000}], 5000).
riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna,
anti_entropy_concurrency, 5], 5000).

This will allow up to 4 trees per node to be built/exchanged per hour, with
up to 5 concurrent exchanges throughout the cluster. To return back to the
default settings, use

riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna,
anti_entropy_build_limit, {1, 360000}], 5000).
riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna,
anti_entropy_concurrency, 2], 5000).


If the cluster still doesn't make any progress with automatically
re-indexing data, the next steps are pretty much what you already
suggested, to drop the existing index and re-index from scratch. I'm
assuming that losing the indexes temporarily is acceptable to you at this
point.

Using any client API that supports RpbYokozunaIndexDeleteReq, you can drop
the index from all Solr instances, losing any data stored there
immediately. Next, you'll have to re-create the index. I have tried this
with the python API, where I deleted the index and re-created it with the
same already uploaded schema:

from riak import RiakClient

c = RiakClient()
c.delete_search_index('my_index')
c.create_search_index('my_index', 'my_schema')

Note that simply deleting the index does not remove it's existing
association with any bucket or bucket type. Any PUT operations on these
buckets will lead to indexing failures being logged until the index has
been recreated. However, this also means that no separate operation in
`riak-admin` is required to associate the newly recreated index with the
buckets again.

After recreating the index expire the trees as explained previously.

Let us know if this solves your issue.

Kind Regards,

Magnus


On 24 March 2016 at 08:44, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt; wrote:

&gt; This is how things are looking after two weeks:
&gt;
&gt; - there are no solr indexing issues for a long period (2 weeks)
&gt; - there are no yokozuna errors at all for 2 weeks
&gt; - there is an index with all empty schema, just _yz_* fields, objects
&gt; stored in a bucket(s) are binary and so are not analysed by yokozuna
&gt; - same yokozuna query repeated gives different number for num_found,
&gt; typically the difference between real number of keys in a bucket and
&gt; num_found is about 25%
&gt; - number of keys repaired by AAE (according to logs) is about 1-2 per few
&gt; hours (number of keys &quot;missing&quot; in index is close to 1,000,000)
&gt;
&gt; Should I now try to delete the index and yokozuna AAE data and wait
&gt; another 2 weeks? If yes - how should I delete the index and AAE data?
&gt; Will RpbYokozunaIndexDeleteReq be enough?
&gt;
&gt;
&gt;
-- 
Magnus Kessler
Client Services Engineer
Basho Technologies Limited

Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17170.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17171">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17171">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17172.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg17096.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17119.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17122.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17139.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17140.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17151.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Fred Dushin</span></li>
<li class="icons-email"><span class="subject"><a href="msg17152.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17161.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17162.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email"><span class="subject"><a href="msg17170.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Yokozuna inconsistent search result...</span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email"><span class="subject"><a href="msg17172.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17173.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email"><span class="subject"><a href="msg17174.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17175.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17185.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17196.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17197.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Fred Dushin</span></li>
<li class="icons-email"><span class="subject"><a href="msg17198.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17200.html">Re: Yokozuna inconsistent search result...</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Yokozuna inconsistent search results">
<input type="hidden" name="msgid" value="CAL3YJWbh-FJMwCV+t3t2TdTScNWsmUwU3nGQbcZkbZ7oEZ5X8A@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17171.html">
<input type="submit" value=" Magnus Kessler ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna+inconsistent+search+results%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17170.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17172.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAL3YJWbh-FJMwCV+t3t2TdTScNWsmUwU3nGQbcZkbZ7oEZ5X8A@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
