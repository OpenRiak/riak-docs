<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Yokozuna inconsistent search results</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17200" id="c">
<link rel="index" href="maillist.html#17200" id="i">
<link rel="prev" href="msg17198.html" id="p">
<link rel="next" href="msg17079.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17200.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna+inconsistent+search+results%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Yokozuna inconsistent search results</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Oleksiy+Krivoshey%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Oleksiy Krivoshey</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160407" rel="nofollow">Thu, 07 Apr 2016 08:10:45 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>So after 2 more days I can still see AAE trees that haven't been rebuilt
for 30 days, I can also see that some trees didn't have exchanges for the
same period.
I still have inconsistent search results from Yokozuna. To summarise this
long discussion:</pre><pre>

- I have fixed all Solr indexing issues though none of them was related to
the search index in question
- there were no Solr indexing issues for 30 days
- search schema for this index doesn't have any fields beside required _yk_*
- I have dropped and re-created this search index two times
- I have tried expiring AAE trees 3 times
- some (quite a lot) of AAE trees don't have exchanges and are not rebuilt

Last output of `search aae-status` from all nodes attached.


On 5 April 2016 at 22:54, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt; wrote:

&gt; Hi Fred,
&gt;
&gt; Thanks for internal call tips, I'll dig deeper!
&gt;
&gt; I've attached recent results of `riak-admin search aae-status` from all
&gt; nodes.
&gt;
&gt;
&gt; On 5 April 2016 at 22:41, Fred Dushin &lt;fdus...@basho.com&gt; wrote:
&gt;
&gt;&gt; Hi Oleksiy,
&gt;&gt;
&gt;&gt; I assume you are getting this information through riak-admin.  Can you
&gt;&gt; post the results here?
&gt;&gt;
&gt;&gt; If you want to dig deeper, you can probe the individual hash trees for
&gt;&gt; their build time.  I will paste a few snippets of erlang here, which I am
&gt;&gt; hoping you can extend to use with list comprehensions and rpc:multicalls.
&gt;&gt; If that's too much to ask, let us know and I can try to put something
&gt;&gt; together that is more &quot;big easy button&quot;.
&gt;&gt;
&gt;&gt; First, on any individual node, you can get the Riak partitions on that
&gt;&gt; node, via
&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)1&gt; Partitons = [P || {_, P, _} &lt;-
&gt;&gt; riak_core_vnode_manager:all_vnodes(riak_kv_vnode)].
&gt;&gt; [913438523331814323877303020447676887284957839360,
&gt;&gt;  182687704666362864775460604089535377456991567872,
&gt;&gt;  1187470080331358621040493926581979953470445191168,
&gt;&gt;  730750818665451459101842416358141509827966271488,
&gt;&gt;  1370157784997721485815954530671515330927436759040,
&gt;&gt;  1004782375664995756265033322492444576013453623296,
&gt;&gt;  822094670998632891489572718402909198556462055424,
&gt;&gt;  456719261665907161938651510223838443642478919680,
&gt;&gt;  274031556999544297163190906134303066185487351808,
&gt;&gt;  1096126227998177188652763624537212264741949407232,
&gt;&gt;  365375409332725729550921208179070754913983135744,
&gt;&gt;  91343852333181432387730302044767688728495783936,
&gt;&gt;  639406966332270026714112114313373821099470487552,0,
&gt;&gt;  1278813932664540053428224228626747642198940975104,
&gt;&gt;  548063113999088594326381812268606132370974703616]
&gt;&gt;
&gt;&gt; For any one partition, you can get to the Pid associated with the
&gt;&gt; yz_index_hashtree associated with that partition, e.g.,
&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)2&gt; {ok, Pid} =
&gt;&gt; yz_entropy_mgr:get_tree(913438523331814323877303020447676887284957839360).
&gt;&gt; {ok,&lt;0.2872.0&gt;}
&gt;&gt;
&gt;&gt; and from there you can get the state information about the hahstree,
&gt;&gt; which includes its build time.  You can read the record definitions
&gt;&gt; associated with the yz_index_hashtree state by calling rr() on the
&gt;&gt; yz_index_hashtree module first, if you want to make the state slightly more
&gt;&gt; readable:
&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)3&gt; rr(yz_index_hashtree).
&gt;&gt; [entropy_data,state,xmerl_event,xmerl_fun_states,
&gt;&gt;  xmerl_scanner,xmlAttribute,xmlComment,xmlContext,xmlDecl,
&gt;&gt;  xmlDocument,xmlElement,xmlNamespace,xmlNode,xmlNsNode,
&gt;&gt;  xmlObj,xmlPI,xmlText]
&gt;&gt; (dev1@127.0.0.1)5&gt; sys:get_state(Pid).
&gt;&gt; #state{index = 913438523331814323877303020447676887284957839360,
&gt;&gt;        built = true,expired = false,lock = undefined,
&gt;&gt;        path =
&gt;&gt; &quot;./data/yz_anti_entropy/913438523331814323877303020447676887284957839360&quot;,
&gt;&gt;        build_time = {1459,801655,506719},
&gt;&gt;        trees = [{{867766597165223607683437869425293042920709947392,
&gt;&gt;                   3},
&gt;&gt;                  {state,&lt;&lt;152,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...&gt;&gt;,
&gt;&gt;
&gt;&gt;   913438523331814323877303020447676887284957839360,3,1048576,
&gt;&gt;                         1024,0,
&gt;&gt;                         {dict,0,16,16,8,80,48,{[],[],...},{{...}}},
&gt;&gt;                         &lt;&lt;&gt;&gt;,
&gt;&gt;
&gt;&gt;   &quot;./data/yz_anti_entropy/913438523331814323877303020447676887284957839360&quot;,
&gt;&gt;                         &lt;&lt;&gt;&gt;,incremental,[],0,
&gt;&gt;                         {array,38837,0,...}}},
&gt;&gt;                 {{890602560248518965780370444936484965102833893376,3},
&gt;&gt;                  {state,&lt;&lt;156,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...&gt;&gt;,
&gt;&gt;
&gt;&gt;   913438523331814323877303020447676887284957839360,3,1048576,
&gt;&gt;                         1024,0,
&gt;&gt;                         {dict,0,16,16,8,80,48,{[],...},{...}},
&gt;&gt;                         &lt;&lt;&gt;&gt;,
&gt;&gt;
&gt;&gt;   &quot;./data/yz_anti_entropy/913438523331814323877303020447676887284957839360&quot;,
&gt;&gt;                         &lt;&lt;&gt;&gt;,incremental,[],0,
&gt;&gt;                         {array,38837,...}}},
&gt;&gt;                 {{913438523331814323877303020447676887284957839360,3},
&gt;&gt;                  {state,&lt;&lt;160,0,0,0,0,0,0,0,0,0,0,0,0,0,...&gt;&gt;,
&gt;&gt;
&gt;&gt;   913438523331814323877303020447676887284957839360,3,1048576,
&gt;&gt;                         1024,0,
&gt;&gt;                         {dict,0,16,16,8,80,48,{...},...},
&gt;&gt;                         &lt;&lt;&gt;&gt;,
&gt;&gt;
&gt;&gt;   &quot;./data/yz_anti_entropy/913438523331814323877303020447676887284957839360&quot;,
&gt;&gt;                         &lt;&lt;&gt;&gt;,incremental,[],0,
&gt;&gt;                         {array,...}}}],
&gt;&gt;        closed = false}
&gt;&gt;
&gt;&gt; You can convert the timestamp to local time via:
&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)8&gt; calendar:now_to_local_time({1459,801655,506719}).
&gt;&gt; {{2016,4,4},{16,27,35}}
&gt;&gt;
&gt;&gt;
&gt;&gt; Again, this is just an example, but with the right erlang incantations,
&gt;&gt; you should be able to iterate over all the timestamps across all the nodes.
&gt;&gt;
&gt;&gt; Let us know if that is helpful, or if you need more examples so you can
&gt;&gt; do it in one swipe.
&gt;&gt;
&gt;&gt; -Fred
&gt;&gt;
&gt;&gt; On Apr 5, 2016, at 9:29 AM, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt; wrote:
&gt;&gt;
&gt;&gt; How can I check that AAE trees have expired? Yesterday I ran &quot;
&gt;&gt;  riak_core_util:rpc_every_member_ann(yz_entropy_mgr, expire_trees, [],
&gt;&gt; 5000).&quot; on each node (just to be sure). Still today I see that on 3 nodes
&gt;&gt; (of 5) all entropy tress and all last AAE exchanges are older than 20 days.
&gt;&gt;
&gt;&gt; On 4 April 2016 at 17:15, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; Continuation...
&gt;&gt;&gt;
&gt;&gt;&gt; The new index has the same inconsistent search results problem.
&gt;&gt;&gt; I was making a snapshot of `search aae-status` command almost each day.
&gt;&gt;&gt; There were absolutely no Yokozuna errors in logs.
&gt;&gt;&gt;
&gt;&gt;&gt; I can see that some AAE trees were not expired (built &gt; 20 days ago). I
&gt;&gt;&gt; can also see that on two nodes (of 5) last AAE exchanges happened &gt; 20 days
&gt;&gt;&gt; ago.
&gt;&gt;&gt;
&gt;&gt;&gt; For now I have issued
&gt;&gt;&gt; ` riak_core_util:rpc_every_member_ann(yz_entropy_mgr, expire_trees, [],
&gt;&gt;&gt; 5000).` on each node again. I will wait 10 days more but I don't think that
&gt;&gt;&gt; will fix anything.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 25 March 2016 at 09:28, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; One interesting moment happened when I tried removing the index:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; - this index was associated with a bucket type, called fs_chunks
&gt;&gt;&gt;&gt; - so I first called RpbSetBucketTypeReq to set search_index:
&gt;&gt;&gt;&gt; _dont_index_
&gt;&gt;&gt;&gt; - i then tried to remove the index with RpbYokozunaIndexDeleteReq which
&gt;&gt;&gt;&gt; failed with &quot;index is in use&quot; and list of all buckets of the fs_chunks type
&gt;&gt;&gt;&gt; - for some reason all these buckets had their own search_index property
&gt;&gt;&gt;&gt; set to that same index
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; How can this happen if I definitely never set the search_index property
&gt;&gt;&gt;&gt; per bucket?
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 24 March 2016 at 22:41, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt;
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; OK!
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; On 24 March 2016 at 21:11, Magnus Kessler &lt;mkess...@basho.com&gt; wrote:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; On 24 March 2016 at 14:55, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt;
&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Magnus,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Thanks! I guess I will go with index deletion because I've already
&gt;&gt;&gt;&gt;&gt;&gt;&gt; tried expiring the trees before.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Do I need to delete AAE data somehow or removing the index is enough?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; If you expire the AAE trees with the commands I posted earlier, there
&gt;&gt;&gt;&gt;&gt;&gt; should be no need to remove the AAE data directories manually.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; I hope this works for you. Please monitor the tree rebuild and
&gt;&gt;&gt;&gt;&gt;&gt; exchanges with `riak-admin search aae-status` for the next few days. In
&gt;&gt;&gt;&gt;&gt;&gt; particular the exchanges should be ongoing on a continuous basis once all
&gt;&gt;&gt;&gt;&gt;&gt; trees have been rebuilt. If they don't, please let me know. At that point
&gt;&gt;&gt;&gt;&gt;&gt; you should also gather `riak-debug` output from all nodes before it gets
&gt;&gt;&gt;&gt;&gt;&gt; rotated out after 5 days by default.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Kind Regards,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Magnus
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 24 March 2016 at 13:28, Magnus Kessler &lt;mkess...@basho.com&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi Oleksiy,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; As a first step, I suggest to simply expire the Yokozuna AAE trees
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; again if the output of `riak-admin search aae-status` still suggests 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; that
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; no recent exchanges have taken place. To do this, run `riak attach` on 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; one
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; node and then
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak_core_util:rpc_every_member_ann(yz_entropy_mgr, expire_trees, [], 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 5000).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Exit from the riak console with `Ctrl+G q`.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Depending on your settings and amount of data the full index should
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; be rebuilt within the next 2.5 days (for a cluster with ring size 128 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; and
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; default settings). You can monitor the progress with `riak-admin search
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; aae-status` and also in the logs, which should have messages along the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; lines of
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2016-03-24 10:28:25.372 [info]
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.4647.6477&gt;@yz_exchange_fsm:key_exchange:179 Repaired 83055 keys 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; during
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; active anti-entropy exchange of partition
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1210306043414653979137426502093171875652569137152 for preflist
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; {1164634117248063262943561351070788031288321245184,3}
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Re-indexing can put additional strain on the cluster and may cause
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; elevated latency on a cluster already under heavy load. Please monitor 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; response times while the cluster is re-indexing data.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; If the cluster load allows it, you can force more rapid re-indexing
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; by changing a few parameters. Again at the `riak attach` console, run
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; anti_entropy_build_limit, {4, 60000}], 5000).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; anti_entropy_concurrency, 5], 5000).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; This will allow up to 4 trees per node to be built/exchanged per
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; hour, with up to 5 concurrent exchanges throughout the cluster. To 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; return
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; back to the default settings, use
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; anti_entropy_build_limit, {1, 360000}], 5000).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak_core_util:rpc_every_member_ann(application, set_env, [yokozuna, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; anti_entropy_concurrency, 2], 5000).
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; If the cluster still doesn't make any progress with automatically
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; re-indexing data, the next steps are pretty much what you already
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; suggested, to drop the existing index and re-index from scratch. I'm
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; assuming that losing the indexes temporarily is acceptable to you at 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; this
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; point.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Using any client API that supports RpbYokozunaIndexDeleteReq, you
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; can drop the index from all Solr instances, losing any data stored 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; there
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; immediately. Next, you'll have to re-create the index. I have tried 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; this
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; with the python API, where I deleted the index and re-created it with 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; same already uploaded schema:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; from riak import RiakClient
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; c = RiakClient()
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; c.delete_search_index('my_index')
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; c.create_search_index('my_index', 'my_schema')
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Note that simply deleting the index does not remove it's existing
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; association with any bucket or bucket type. Any PUT operations on these
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; buckets will lead to indexing failures being logged until the index has
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; been recreated. However, this also means that no separate operation in
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; `riak-admin` is required to associate the newly recreated index with 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; the
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; buckets again.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; After recreating the index expire the trees as explained previously.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Let us know if this solves your issue.
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Kind Regards,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Magnus
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; On 24 March 2016 at 08:44, Oleksiy Krivoshey &lt;oleks...@gmail.com&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; This is how things are looking after two weeks:
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; - there are no solr indexing issues for a long period (2 weeks)
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; - there are no yokozuna errors at all for 2 weeks
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; - there is an index with all empty schema, just _yz_* fields,
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; objects stored in a bucket(s) are binary and so are not analysed by 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; yokozuna
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; - same yokozuna query repeated gives different number
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; for num_found, typically the difference between real number of keys 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; in a
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; bucket and num_found is about 25%
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; - number of keys repaired by AAE (according to logs) is about 1-2
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; per few hours (number of keys &quot;missing&quot; in index is close to 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1,000,000)
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Should I now try to delete the index and yokozuna AAE data and
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; wait another 2 weeks? If yes - how should I delete the index and AAE 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; data?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Will RpbYokozunaIndexDeleteReq be enough?
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 07970431
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; Magnus Kessler
&gt;&gt;&gt;&gt;&gt;&gt; Client Services Engineer
&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies Limited
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Registered Office - 8 Lincoln’s Inn Fields London WC2A 3BP Reg
&gt;&gt;&gt;&gt;&gt;&gt; 07970431
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt;
&gt;
</pre>
<p><strong><a href="msg17200/search-aae.tar.gz" ><img src="../attachment.png" alt="Attachment:" width=27 height=28></a>
<a href="msg17200/search-aae.tar.gz" >search-aae.tar.gz</a></strong><br>
<em>Description:</em> GNU Zip compressed data</p>
<pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17198.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17200">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17200">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17079.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg17170.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17171.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email"><span class="subject"><a href="msg17172.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17173.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email"><span class="subject"><a href="msg17174.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17175.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17185.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17196.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email"><span class="subject"><a href="msg17197.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Fred Dushin</span></li>
<li class="icons-email"><span class="subject"><a href="msg17198.html">Re: Yokozuna inconsistent search results</a></span> <span class="sender italic">Oleksiy Krivoshey</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Yokozuna inconsistent search results</span> <span class="sender italic">Oleksiy Krivoshey</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Yokozuna inconsistent search results">
<input type="hidden" name="msgid" value="CAKsWuRdDb+P8NRxCpoH99dcFN6yKAQ_uAkOK4HRtiWZFxiyCqw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17200.html">
<input type="submit" value=" Oleksiy Krivoshey ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna+inconsistent+search+results%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17198.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17079.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAKsWuRdDb+P8NRxCpoH99dcFN6yKAQ_uAkOK4HRtiWZFxiyCqw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
