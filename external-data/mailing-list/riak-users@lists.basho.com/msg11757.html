<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Corrupted Erlang binary term inside LevelDB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd13.html#11757" id="c">
<link rel="index" href="mail13.html#11757" id="i">
<link rel="prev" href="msg11738.html" id="p">
<link rel="next" href="msg11758.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11757.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Corrupted+Erlang+binary+term+inside+LevelDB%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Corrupted Erlang binary term inside LevelDB</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Von%5C-Maszewski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Von-Maszewski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130725" rel="nofollow">Thu, 25 Jul 2013 11:04:24 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Vladimir,

I can explain what happened, but not how to correct the problem.  The gentleman 
that can walk you through a repair is tied up on another project, but he 
intends to respond as soon as he is able.</pre><pre>

We recently discovered / realized that Google's leveldb code does not check the 
CRC of each block rewritten during a compaction.  This means that blocks with 
bad CRCs get read without being flagged as bad, then rewritten to a new file 
with a new, valid CRC.  The corruption is now hidden.

A more thorough discussion of the problem is found here:

<a  rel="nofollow" href="https://github.com/basho/leveldb/wiki/mv-verify-compactions">https://github.com/basho/leveldb/wiki/mv-verify-compactions</a>


We added code to the 1.3.2 and 1.4 Riak releases to have the block CRC checked 
during both read (Get) requests and compaction rewrites.  This prevents future 
corruption hiding.  Unfortunately, it does NOTHING for blocks already corrupted 
and rewritten with valid CRCs.  You are encountering this latter condition.  We 
have a developer advocate / client services person that has walked others 
through a fix via the Riak data replicas … 

… please hold and the doctor will be with you shortly.

Matthew


On Jul 24, 2013, at 9:39 PM, Vladimir Shabanov &lt;vshaban...@gmail.com&gt; wrote:

&gt; Hello,
&gt; 
&gt; Recently I've started expanding my Riak cluster and found that handoffs were 
&gt; continuously retried for one partition.
&gt; 
&gt; Here are logs from two nodes
&gt; <a  rel="nofollow" href="https://gist.github.com/vshabanov/41282e622479fbe81974">https://gist.github.com/vshabanov/41282e622479fbe81974</a>
&gt; 
&gt; The most interesting parts of logs are
&gt; &quot;Handoff receiver for partition ... exited abnormally after processing 
&gt; 2860338 objects: {{badarg,[{erlang,binary_to_term,...&quot;
&gt; and
&gt; &quot;bad argument in call to erlang:binary_to_term(&lt;&lt;131,104,....&quot;
&gt; 
&gt; Both nodes are running Riak 1.3.2 (old one was running 1.3.1 previously).
&gt; 
&gt; 
&gt; When I've printed corrupted binary string I found that it corresponds to one 
&gt; value.
&gt; 
&gt; When I've tried to &quot;get&quot; it, it was read OK but node with corrupted value 
&gt; shown the same binary_to_term error.
&gt; 
&gt; When I've tried to delete corrupted value I've got timeout.
&gt; 
&gt; 
&gt; I'm running machines with ECC memory and ZFS filesystem (which doesn't report 
&gt; any checksum failures) so I doubt data was silently corrupted on disk.
&gt; 
&gt; LOG from corresponding LevelDB partition doesn't show any errors. But there 
&gt; is a lost/BLOCKS.bad file in this partition (7kb, created more than a month 
&gt; ago and looks like it doesn't contain corrupted value).
&gt; 
&gt; At the moment I've stopped handoffs using &quot;risk-admin transfer-limit 0&quot;.
&gt; 
&gt; Why the value was corrupted? It there any way to remove it or fix it?
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11738.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd13.html#11757">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail13.html#11757">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11758.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11738.html">Corrupted Erlang binary term inside LevelDB</a></span> <span class="sender italic">Vladimir Shabanov</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Corrupted Erlang binary term inside LevelDB</span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11758.html">Re: Corrupted Erlang binary term inside Lev...</a></span> <span class="sender italic">Vladimir Shabanov</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11759.html">Re: Corrupted Erlang binary term inside...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11761.html">Re: Corrupted Erlang binary term in...</a></span> <span class="sender italic">Vladimir Shabanov</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11770.html">Re: Corrupted Erlang binary te...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11813.html">Re: Corrupted Erlang binar...</a></span> <span class="sender italic">Vladimir Shabanov</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11818.html">Re: Corrupted Erlang b...</a></span> <span class="sender italic">Brian Sparrow</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Corrupted Erlang binary term inside LevelDB">
<input type="hidden" name="msgid" value="EC410A3A-6176-43D5-B8E5-367C538518B8@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11757.html">
<input type="submit" value=" Matthew Von-Maszewski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Corrupted+Erlang+binary+term+inside+LevelDB%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11738.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11758.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">EC410A3A-6176-43D5-B8E5-367C538518B8@basho.com</li>
</ul>
</div>
</body>
</html>
