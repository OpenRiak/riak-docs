<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: 1.4.2: 'riak-admin reip' no longer works?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd8.html#12727" id="c">
<link rel="index" href="mail8.html#12727" id="i">
<link rel="prev" href="msg12724.html" id="p">
<link rel="next" href="msg12708.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12727.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+1.4.2%5C%3A+%27riak%5C-admin+reip%27+no+longer+works%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: 1.4.2: 'riak-admin reip' no longer works?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Rune+Skou+Larsen%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Rune Skou Larsen</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131022" rel="nofollow">Tue, 22 Oct 2013 04:10:45 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Den 22-10-2013 09:53, Shane McEwan skrev:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 21/10/13 17:57, Joe Caswell wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
The only use case left for reip is when you have simultaneously changed the
node name for every node in the cluster, such as when loading an entire
cluster's worth of backups to new machines.
</pre></blockquote><pre style="margin: 0em;">
When I need to do this I just create a new, empty cluster with the new
names. Then shut down the cluster and restore only the data directories
(leveldb, for example) from the backup, leaving the ring directory
alone. Then I start up the cluster and it finds the restored data.
</pre></blockquote><tt>Thanks for the tip. Beware that this will not restore bucket props, 
</tt><tt>because they are stored in the ring dir and not the data dir.
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
You need to be careful about restoring the old node's data to the
corresponding new node otherwise you'll get hinted handoffs flying
between all your nodes but after a bit of trial and error you can figure
out which node is which.
</pre></blockquote><tt>When you create the new, empty cluster, Riak distributes the partitions 
</tt><tt>between the nodes using the claim function. I believe claim_v2 
</tt><tt>(riak_core_claim.erl) is still the default claim function and it will 
</tt><tt>produce different partition distributions in different runs when joining 
</tt><tt>nodes to form a cluster. Including the dreaded 12,12,12,12,16 on a 
</tt><tt>default config with 5 nodes.
</tt><tt>I guess sometimes you'll be lucky, and the new shiny cluster will have 
</tt><tt>the same partition distribution as the backup, but in my experience, 
</tt><tt>this is not always the case, which means the new cluster will need to 
</tt><tt>handoff data between nodes, to match the data with the ring-files' 
</tt><tt>partition distribution.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>The good(tm) way to restore a complete backup to a new environment is to 
</tt><tt>restore data and partition distribution together - i.e. both the data 
</tt><tt>dirs and the ring files.
</tt><tt>For this purpose, reip was very useful in v 1.3.x, where the node it was 
</tt><tt>called on, did not have to be running. Unfortunately in 1.4.2, the 
</tt><tt>reip'ed node must be running (which sort of defies the purpose of reip):
</tt><pre style="margin: 0em;">

&quot;riak-1.3.2/rel/riak/bin&gt; ./riak-admin reip bla bla2
</pre><tt>Backed up existing ring file to 
</tt><tt>&quot;./data/ring/riak_core_ring.default.20131004091923.BAK&quot;
</tt><pre style="margin: 0em;">
New ring file written to &quot;./data/ring/riak_core_ring.default.20131022105325

riak-1.4.2/rel/riak/bin&gt; ./riak-admin reip bla bla2
Node is not running!&quot;

</pre><tt>A common case where you need reip'ing non-running nodes, is when you 
</tt><tt>copy production data to a staging environment, and need to ensure that 
</tt><tt>your new staging cluster doesn't reference production nodes before 
</tt><tt>firing it up. Does anyone know a good solution to this in 1.4? The only 
</tt><tt>two ways I see are: 1) Edit the ring-files by hand 2) Restore to a new 
</tt><tt>cluster with potentially mismatched partition distribution between data 
</tt><tt>and ring-files, and wait for handoffs to complete.
</tt><pre style="margin: 0em;">

- Rune, Trifork

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12724.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd8.html#12727">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail8.html#12727">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12708.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12707.html">1.4.2: 'riak-admin reip' no longer works?</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12710.html">Re: 1.4.2: 'riak-admin reip' no longer works?</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12711.html">Re: 1.4.2: 'riak-admin reip' no longer works?</a></span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12714.html">Re: 1.4.2: 'riak-admin reip' no longer wor...</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12713.html">Re: 1.4.2: 'riak-admin reip' no longer...</a></span> <span class="sender italic">Dave Brady</span></li>
<li class="icons-email"><span class="subject"><a href="msg12716.html">Re: 1.4.2: 'riak-admin reip' no longer...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12717.html">Re: 1.4.2: 'riak-admin reip' no l...</a></span> <span class="sender italic">Dave Brady</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12718.html">Re: 1.4.2: 'riak-admin reip' ...</a></span> <span class="sender italic">Brady Wetherington</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12719.html">Re: 1.4.2: 'riak-admin re...</a></span> <span class="sender italic">Joe Caswell</span></li>
<li class="icons-email"><span class="subject"><a href="msg12724.html">Re: 1.4.2: 'riak-admin re...</a></span> <span class="sender italic">Shane McEwan</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: 1.4.2: 'riak-admin re...</span> <span class="sender italic">Rune Skou Larsen</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: 1.4.2: 'riak-admin reip' no longer works?">
<input type="hidden" name="msgid" value="52665CE0.1040207@trifork.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12727.html">
<input type="submit" value=" Rune Skou Larsen ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+1.4.2%5C%3A+%27riak%5C-admin+reip%27+no+longer+works%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12724.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12708.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">52665CE0.1040207@trifork.com</li>
</ul>
</div>
</body>
</html>
