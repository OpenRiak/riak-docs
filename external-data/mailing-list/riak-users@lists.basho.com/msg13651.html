<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak crashing when indexing for search</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#13651" id="c">
<link rel="index" href="mail3.html#13651" id="i">
<link rel="prev" href="msg13649.html" id="p">
<link rel="next" href="msg13652.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg13651.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+crashing+when+indexing+for+search%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak crashing when indexing for search</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ryan+Zezeski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ryan Zezeski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140213" rel="nofollow">Thu, 13 Feb 2014 07:29:36 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Glory,

On Tue, Feb 11, 2014 at 1:29 AM, Glory Lo &lt;gloryl...@gmail.com&gt; wrote:
&gt;
&gt;
&gt; While indexing it seem to run fine part way.. then I noticed it hangs (it
&gt; freezed my machine on a couple of attempts on linux mint 13).  Then it
&gt; crashes.  I have 3 nodes running and I only tried indexing one of them
&gt; doing a search-cmd mybucket dev1/data/leveldb
&gt;</pre><pre>

What was the process for indexing? How much data were you indexing? What
content-type? How big is each object? What is your schema?


&gt; My crash log has multiple errors of different sorts which I haven't
&gt; discern yet.  However, the last errors w/ a close timestamp are as follows
&gt; which mentions some timeouts (likely with the freeze):
&gt;

It's hard to discern ripple effect errors from the the origin error. I see
some stuff that is indicative of disk corruption but there's a good chance
that only happened because some other error caused merge_index to hard
crash. Could you attach a tar.gz of all your logs?


&gt;
&gt; 2014-02-08 23:15:53 =ERROR REPORT====
&gt; Error in process &lt;0.2799.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {badarg,[{ets,lookup,[145752322,{1118962191081472546749696200048404186924073353216,'
&gt; dev2@127.0.0.1
&gt; '}],[]},{riak_search_client,'-process_terms_1/4-fun-2-',3,[{file,&quot;src/riak_search_client.erl&quot;},{line,295}]},{riak_search_utils,'-ptransform/2-fun-0-',2,[{file,&quot;src/riak_search_utils....
&gt;

This is an error finding the temporary ETS table for building the postings
list. That's a really interesting error to have and makes me wonder if you
someone hit the ETS system limit. I'm not even sure that is possible given
how high we've raised the default limit.


&gt;
&gt; 2014-02-08 23:18:46 =ERROR REPORT====
&gt; Error in process &lt;0.2350.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {terminated,[{io,format,[&lt;17869.23.0&gt;,&quot;DEBUG: ~p:~p - ~p~n~n
&gt; ~p~n~n&quot;,[riak_search_dir_indexer,194,&quot;{ error , Type , Error , erlang :
&gt; get_stacktrace ( )
&gt; }&quot;,{error,error,{case_clause,{error,timeout}},[{riak_search_client,'-index_docs/1-fun-0-'...
&gt;

I'm actually a bit baffled exactly what this trace is saying. I think more
detail might be in the error.log.


&gt;
&gt; 2014-02-08 23:20:00 =ERROR REPORT====
&gt; Error in process &lt;0.4231.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {{case_clause,{data,4711}},[{cpu_sup,get_uint32_measurement,2,[{file,&quot;cpu_sup.erl&quot;},{line,227}]},{cpu_sup,measurement_server_loop,1,[{file,&quot;cpu_sup.erl&quot;},{line,585}]}]}
&gt;

Yikes, this looks really bad and makes me wonder if this is an environment
issue as this error should not be related to search.


&gt;
&gt; 2014-02-08 23:23:37 =ERROR REPORT====
&gt; Error in process &lt;0.6359.1&gt; on node 'dev1@127.0.0.1' with exit value:
&gt; {badarg,[{erlang,binary_to_term,[&lt;&lt;31359
&gt; bytes&gt;&gt;],[]},{mi_segment,iterate_all_bytes,2,[{file,&quot;src/mi_segment.erl&quot;},{line,167}]},{mi_segment_writer,from_iterator,4,[{file,&quot;src/mi_segment_writer.erl&quot;},{line,102}]},{mi_segment_writer,from_iterator...
&gt;

This is typically what you see when data corruption occurs but it's hard to
say if data corruption caused the other errors of the other errors caused
corruption.


&gt;
&gt;
&gt;
&gt; 2014-02-08 23:24:58 =ERROR REPORT====
&gt; ** State machine &lt;0.3211.0&gt; terminating
&gt; ** Last message in was {'EXIT',&lt;0.168.0&gt;,shutdown}
&gt; ** When State == active
&gt; **      Data  ==
&gt; {state,1438665674247607560106752257205091097473808596992,riak_search_vnode,{vstate,1438665674247607560106752257205091097473808596992,merge_index_backend,{state,1438665674247607560106752257205091097473808596992,&lt;0.3212.0&gt;}},undefined,none,undefined,undefined,&lt;0.3221.0&gt;,{pool,riak_search_worker,2,[]},undefined,86616}
&gt; ** Reason for termination =
&gt; ** {timeout,{gen_server,call,[&lt;0.3212.0&gt;,stop]}}
&gt; 2014-02-08 23:24:58 =CRASH REPORT====
&gt;   crasher:
&gt;     initial call: riak_core_vnode:init/1
&gt;     pid: &lt;0.3211.0&gt;
&gt;     registered_name: []
&gt;     exception exit:
&gt; {{timeout,{gen_server,call,[&lt;0.3212.0&gt;,stop]}},[{gen_fsm,terminate,7,[{file,&quot;gen_fsm.erl&quot;},{line,589}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}
&gt;     ancestors: [riak_core_vnode_sup,riak_core_sup,&lt;0.162.0&gt;]
&gt;     messages:
&gt; [{'EXIT',&lt;0.3221.0&gt;,shutdown},{#Ref&lt;0.0.1.215952&gt;,ok},{'EXIT',&lt;0.3212.0&gt;,normal}]
&gt;     links: []
&gt;     dictionary: [{random_seed,{27839,21123,25074}}]
&gt;     trap_exit: true
&gt;     status: running
&gt;     heap_size: 46368
&gt;     stack_size: 24
&gt;     reductions: 24758
&gt;   neighbours:
&gt;

This is one of the riak_search vnodes crashing because it's merge index
process crashed. Which is expected given the circumstances.


&gt; 2014-02-08 23:24:58 =ERROR REPORT====
&gt; ** State machine &lt;0.5392.1&gt; terminating
&gt; ** Last message in was
&gt; {'$gen_sync_all_state_event',{&lt;0.5390.1&gt;,#Ref&lt;0.0.1.215861&gt;},{shutdown,60000}}
&gt; ** When State == ready
&gt; **      Data  == {state,{[],[]},&lt;0.5393.1&gt;,[],undefined}
&gt; ** Reason for termination =
&gt; ** {timeout,{gen_fsm,sync_send_all_state_event,[&lt;0.5393.1&gt;,stop]}}
&gt; 2014-02-08 23:24:58 =CRASH REPORT====
&gt;   crasher:
&gt;     initial call: riak_core_vnode_worker_pool:init/1
&gt;     pid: &lt;0.5392.1&gt;
&gt;     registered_name: []
&gt;     exception exit:
&gt; {{timeout,{gen_fsm,sync_send_all_state_event,[&lt;0.5393.1&gt;,stop]}},[{gen_fsm,handle_msg,7,[{file,&quot;gen_fsm.erl&quot;},{line,511}]},{proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}
&gt;     ancestors: [&lt;0.5390.1&gt;,riak_core_vnode_sup,riak_core_sup,&lt;0.162.0&gt;]
&gt;     messages: []
&gt;     links: [&lt;0.5390.1&gt;,&lt;0.5393.1&gt;]
&gt;     dictionary: []
&gt;     trap_exit: false
&gt;     status: running
&gt;     heap_size: 233
&gt;     stack_size: 24
&gt;     reductions: 225
&gt;   neighbours:
&gt;

This is the worker pool crashing probably because it's vnode crashed.


&gt; 2014-02-08 23:25:01 =SUPERVISOR REPORT====
&gt;      Supervisor: {local,riak_core_vnode_sup}
&gt;      Context:    shutdown_error
&gt;      Reason:     {timeout,{gen_server,call,[&lt;0.5436.1&gt;,stop]}}
&gt;      Offender:
&gt; [{nb_children,1},{name,undefined},{mfargs,{riak_core_vnode,start_link,[]}},{restart_type,temporary},{shutdown,300000},{child_type,worker}]
&gt;

Supervisor reports just indicating that vnodes have crashed because of a
timeout. Expected given the circumstances.


&gt;
&gt; Can someone provide some guidance as to where to troubleshoot the issue?
&gt;  If it's timing out which is a mere symptom of it being in hang state.
&gt;  What however is the root cause of it being stuck with those other errors
&gt; like bad arg and bad match.
&gt;

Attach your logs and I should be able to take a closer look.

-Z
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg13649.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#13651">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail3.html#13651">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13652.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">

</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak crashing when indexing for search">
<input type="hidden" name="msgid" value="CACZcpen7nukjKeDsnri4eEno=Jk11-hQkY4b=nsHrvx0huVhvw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg13651.html">
<input type="submit" value=" Ryan Zezeski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+crashing+when+indexing+for+search%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg13649.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13652.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACZcpen7nukjKeDsnri4eEno=Jk11-hQkY4b=nsHrvx0huVhvw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
