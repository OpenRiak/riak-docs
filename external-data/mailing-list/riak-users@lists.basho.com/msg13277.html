<!DOCTYPE html>
<html lang="en">
<head>
<title>RE: May allow_mult cause DoS?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd5.html#13277" id="c">
<link rel="index" href="mail5.html#13277" id="i">
<link rel="prev" href="msg13273.html" id="p">
<link rel="next" href="msg13280.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg13277.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+May+allow_mult+cause+DoS%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">RE: May allow_mult cause DoS?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Erik+S%C3%B8e+S%C3%B8rensen%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Erik Søe Sørensen</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131217" rel="nofollow">Tue, 17 Dec 2013 17:34:21 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>It really is not a good idea to use siblings to represent 1-to-many relations. 
That's not what it's intended for, nor what it's optimized for...
Can you tell us exactly why you need Bitcask rather than LevelDB? 2i would 
probably do it.
Otherwise, storing a list of items under each key could be a solution, 
depending of course on the number of items per key. (But do perform conflict 
resolution.)
/Erik</pre><pre>



-------- Oprindelig meddelelse --------
Fra: Viable Nisei &lt;vsni...@gmail.com&gt;
Dato:
Til: riak-users@lists.basho.com
Emne: May allow_mult cause DoS?


Hi.

Recently we've described that something is going unexpectedly. We are using 
Riak 1.4.2 with some buckets with allow_mult=true.
We've tried our app under load then found that... concurrently writes into 
bucket with allow_mult turning Riak into irresponsible slowpoke and even crash 
it.

Core i3 with 4GB RAM performs only 20 writes/sec with 5 client threads writing 
20 short strings into 20 keys in bucket with allow_mult=true, search=false. 
With 40 values per 40 keys it performs only 6 writes/sec. 60x60 cause riak 
crash?
Throughput drops drastically. Ok, we've not chaged concurrency factor (5) and 
increased our data set 4x, but why throughput drops?
Ok, we increase our dataset linear, 20 strings * 20 keys, 40 strings*20 keys,  
60 strings*20 keys... Results will be same - exponential throughput drop with 
crash at end.

Cluster of five Amazon EC2 cc2.8xlarge nodes becomes irresponsibly with 
throughput 1-5 writes/sec with only 80-100 values per 1-10 keys.

So, we think it is very strange.

Here you can check our code sample (in java) reproducing this behavior: 
<a  rel="nofollow" href="https://bitbucket.org/vsnisei/riak-allow_mult_wtf">https://bitbucket.org/vsnisei/riak-allow_mult_wtf</a>

So, we have asked Basho about this, but they said that &quot;we think SQLish&quot; and 
asked us for $5k for 2-days consultation to resolve our problem.
So, I've decided to ask here if we are really so stupid and not able to 
understood some simple things or Basho didn't understood us correctly?..

Anyway, looks like that some DoS/DDoS attack approach utilizing this behavior 
may be proposed. We should only know that some service/appliation/website is 
using Riak with allow_mult buckets then provoke concurrent writes into them...

Actually our question to Basho was broader. Our application needs to implement 
1-many bindings. Riak allows the following approaches to simultate such 
bindings, according to documentation:

 1.  Riak search - but we've found that it's VERY slow (20x performance drop 
when search enabled, even for simple objects like {source_id: xxx, target_id: 
yyy}, also we've found that search is not really scalable - adding new nodes 
into cluster not increasing throughput, but even slows cluster down...
 2.  secondary indexes. But, according to docs, they are working only on 
LevelDb, but we need Bitcask
 3.  Link walking. But, according to docs, it's &quot;rest only operation&quot; and in 
java driver it's implemented as a hack
 4.  allow_mult. But we've found that it's just a nightmare. So we told Basho 
about this and given link to our example, but they didn't given us any feedback
 5.  Bucket keys enumeration. But, according to docs, this operation causes 
full keys scan on each node and must not be used in production
 6.  Mapred queries. Ok, we didn't tried them yet, maybe it's silver bullet, 
really. But according to docs (and common sense) mapred causes full-scan (for 
bucket at least. Or for all keys?) and it's operation with unpredictable 
latency.

So, where we are wrong? Is everything ok with behavior I've described? Are we 
misunderstood Riak completely and should pay $5k for some mind-expansion, or 
there is no any hidden mystical knowledge and they will not say us anything 
excepting approaches listed above?

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg13273.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd5.html#13277">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail5.html#13277">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13280.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg13268.html">May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13270.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Reid Draper</span></li>
<li class="icons-email"><span class="subject"><a href="msg13273.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Brian Roach</span></li>
<li class="icons-email tSliceCur"><span class="subject">RE: May allow_mult cause DoS?</span> <span class="sender italic">Erik Søe Sørensen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13280.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13281.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13289.html">Fwd: May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13292.html">SV: May allow_mult cause DoS?</a></span> <span class="sender italic">Rune Skou Larsen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13297.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13298.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Andy Gross</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13302.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13307.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13312.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13313.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Andrew Stone</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="RE: May allow_mult cause DoS?">
<input type="hidden" name="msgid" value="aj4hvgwmvlgbwqijqyp7g2o4.1387330334512@email.android.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg13277.html">
<input type="submit" value=" Erik Søe Sørensen ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22RE%5C%3A+May+allow_mult+cause+DoS%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg13273.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13280.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">aj4hvgwmvlgbwqijqyp7g2o4.1387330334512@email.android.com</li>
</ul>
</div>
</body>
</html>
