<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Ownership handoff never completes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd6.html#13038" id="c">
<link rel="index" href="mail6.html#13038" id="i">
<link rel="prev" href="msg13032.html" id="p">
<link rel="next" href="msg13039.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg13038.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Ownership+handoff+never+completes%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Ownership handoff never completes</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jeppe+Toustrup%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jeppe Toustrup</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131120" rel="nofollow">Wed, 20 Nov 2013 10:36:37 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've got the problem solved thanks to Brian Sparrow on the IRC channel.

Here's the steps we tried during the troubleshooting session:</pre><pre>

1. We first tried to delete the data folders on the receiving node for
the two partitions, while the node was stopped, to see if it would
retrigger the ownership handoff. It didn't change anything.

2. We then tried to insert the following Erlang code on the sending
node, in order to see if it would retrigger the ownership handoff. The
partition IDs were for the partitions needing to be transfered:
IdxList = [696496874040508421956443553091353626554780352512,
239777612374601260017792042867515182912301432832],
  Mod = riak_kv,
  Ring = riak_core_ring_manager:get_my_ring(),
  riak_core_ring_manager:ring_trans(
        fun(Ring, _) -&gt;
                Ring2 = lists:foldl(
                          fun(Idx, Ring) -&gt;

riak_core_ring:handoff_complete(Ring, Idx, Mod)
                          end,
                          Ring,
                          IdxList),
                {new_ring, Ring2}
        end, []).

That piece of code didn't help anything either. The output of the
command showed the two partitions to be in the &quot;awaiting&quot; state:

                [{239777612374601260017792042867515182912301432832,
                  'riak@10.0.0.96','riak@10.0.0.93',
                  [riak_kv,riak_kv_vnode,riak_pipe_vnode],
                  awaiting},
                 {696496874040508421956443553091353626554780352512,
                  'riak@10.0.0.96','riak@10.0.0.93',
                  [riak_kv,riak_kv_vnode,riak_pipe_vnode],
                  awaiting}],

3. Brian suggested that I should run
&quot;riak_core_ring_events:force_update().&quot; in the Erlang console as well,
but that didn't have any effect.

4. I send the ring directories from the source and destination nodes
to Brian, and he came back with the following Erlang code which
problem for us:

IdxList = [696496874040508421956443553091353626554780352512,
239777612374601260017792042867515182912301432832],
  Mod = riak_kv_vnode,
  Ring = riak_core_ring_manager:get_my_ring(),
  riak_core_ring_manager:ring_trans(
        fun(Ring, _) -&gt;
                Ring1 = begin
                            A = element(7, Ring),
                            B = [{B1, B2, B3,
                                  [B4E || B4E &lt;- B4, B4E /= riak_kv],
                                B5} || {B1, B2, B3, B4, B5} &lt;- A],
                            setelement(7,Ring, B)
                        end,
                Ring2 = lists:foldl(
                          fun(Idx, R) -&gt;
                                  riak_core_ring:handoff_complete(R, Idx, Mod)
                          end,
                          Ring1,
                          IdxList),
                {new_ring, Ring2}
        end, []).

The output of the command showed the handoffs was complete:

                [{239777612374601260017792042867515182912301432832,
                  'riak@10.0.0.96','riak@10.0.0.93',
                  [riak_kv_vnode,riak_pipe_vnode],
                  complete},
                 {696496874040508421956443553091353626554780352512,
                  'riak@10.0.0.96','riak@10.0.0.93',
                  [riak_kv_vnode,riak_pipe_vnode],
                  complete}],

And I could confirm that with the usual &quot;ring-status&quot;, &quot;member-status&quot;
and &quot;transfers&quot; commands. There were no pending transfers, no pending
ownership handoffs and the cluster didn't show the rebalancing to be
in progress any more.

Thanks a lot to Brian for helping solve this issue. I hope anybody
else who may encounter it can use the above info.

-- 
Jeppe Fihl Toustrup
Operations Engineer
Falcon Social


On 20 November 2013 17:52, Mark Phillips &lt;m...@basho.com&gt; wrote:
&gt; Hmm. The fact that you've disabled Search probably changes things but I'm
&gt; not entirely sure how.
&gt;
&gt; Ryan et al - any ideas?
&gt;
&gt; Mark
&gt;
&gt; On Wednesday, November 20, 2013, Jeppe Toustrup wrote:
&gt;&gt;
&gt;&gt; Hi
&gt;&gt;
&gt;&gt; Thank you for the guide. I stopped two of the nodes (the source and
&gt;&gt; the destination of the partition transfers), renamed the folders
&gt;&gt; inside the merge_index folder and started them again. The ownership
&gt;&gt; handoff does however not seem to be retried.
&gt;&gt;
&gt;&gt; Looking at the logs it seems like the last attempt was 48 hours ago.
&gt;&gt; Is there any logic inside Riak which causes it to give up after a
&gt;&gt; certain amount of tries?
&gt;&gt; Is there a way I can retrigger the handoffs?
&gt;&gt; I have tried to set the transfer-limit on the cluster to 0 and then
&gt;&gt; back to 2, but it doesn't seem to do anything.
&gt;&gt;
&gt;&gt; I wonder if we need the merge_index folder at all, as we have disabled
&gt;&gt; Riak search since the initial configuration of the cluster. We found a
&gt;&gt; better way to query our data so that we don't need Riak search
&gt;&gt; anymore. We disabled it by resetting the properties on the buckets
&gt;&gt; where search was enabled, and then disabled search in app.config
&gt;&gt; followed by a restart of each of the nodes. This was done after the
&gt;&gt; ownership handoff issue first occurred.
&gt;&gt;
&gt;&gt; --
&gt;&gt; Jeppe Fihl Toustrup
&gt;&gt; Operations Engineer
&gt;&gt; Falcon Social
&gt;&gt;
&gt;&gt;
&gt;&gt; On 19 November 2013 23:17, Mark Phillips &lt;m...@basho.com&gt; wrote:
&gt;&gt; &gt; Hi Jeppe,
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; As you suspected, this looks like index corruption in Search that's
&gt;&gt; &gt; preventing handoff from finishing.  Specifically, you'll need to delete
&gt;&gt; &gt; the
&gt;&gt; &gt;
&gt;&gt; &gt; segment files for the two partitions' indexes and rebuild those indexes
&gt;&gt; &gt; post-transfer.
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; Here's the full process:
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; - Stop each node that owns the partitions in question.
&gt;&gt; &gt; - Delete the data directory for each partition (which contains the
&gt;&gt; &gt; segment
&gt;&gt; &gt; files). It should be something like:
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; &quot;rm -rf /var/lib/riak/merge_index/&lt;p&gt;&quot;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; - Restart each node
&gt;&gt; &gt;
&gt;&gt; &gt; - Wait for the transfers to complete
&gt;&gt; &gt; - Rebuild the indexes in question [1]
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; Let us know if you run into any further issues.
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; Mark
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; [1]
&gt;&gt; &gt;
&gt;&gt; &gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/recovery/repairing-indexes/">http://docs.basho.com/riak/latest/ops/running/recovery/repairing-indexes/</a>
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; On Tue, Nov 19, 2013 at 4:26 AM, Jeppe Toustrup &lt;je...@falconsocial.com&gt;
&gt;&gt; &gt; wrote:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Hi
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; I have recently added two extra nodes to the now seven node Riak
&gt;&gt; &gt;&gt; cluster. The rebalancing following the expansion worked fine, except
&gt;&gt; &gt;&gt; for two partitions which seem to not being able to go through. Running
&gt;&gt; &gt;&gt; &quot;riak-admin ring-status&quot; shows the following:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; ============================== Ownership Handoff
&gt;&gt; &gt;&gt; ==============================
&gt;&gt; &gt;&gt; Owner:      riak@10.0.0.96
&gt;&gt; &gt;&gt; Next Owner: riak@10.0.0.93
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Index: 239777612374601260017792042867515182912301432832
&gt;&gt; &gt;&gt;   Waiting on: []
&gt;&gt; &gt;&gt;   Complete:   [riak_kv_vnode,riak_pipe_vnode]
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Index: 696496874040508421956443553091353626554780352512
&gt;&gt; &gt;&gt;   Waiting on: []
&gt;&gt; &gt;&gt;   Complete:   [riak_kv_vnode,riak_pipe_vnode]
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; -------------------------------------------------------------------------------
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; I can see from the log file on the source node (10.0.0.96) that it has
&gt;&gt; &gt;&gt; made numerous attempt to transfer the partitions, but it ends up
&gt;&gt; &gt;&gt; failing all the time. Here's an except of the log file showing the
&gt;&gt; &gt;&gt; lines from when the transfer attempt ends up failing:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; 2013-11-18 12:29:03.694 [error] emulator Error in process &lt;0.5745.8&gt;
&gt;&gt; &gt;&gt; on node 'riak@10.0.0.96' with exit value:
&gt;&gt; &gt;&gt; {badarg,[{erlang,binary_to_term,[&lt;&lt;29942
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; bytes&gt;&gt;],[]},{mi_segment,iterate_all_bytes,2,[{file,&quot;src/mi_segment.erl&quot;},{line,167}]},{mi_server,'-group_iterator/2-fun-1-',2,[{file,&quot;src/mi_server.erl&quot;},{line,725}]},{mi_server,'-group_iterator/2-fun-0-'...
&gt;&gt; &gt;&gt; 2013-11-18 12:29:03.885 [error] &lt;0.3269.0&gt;@mi_server:handle_info:524
&gt;&gt; &gt;&gt; lookup/range failure:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; {badarg,[{erlang,binary_to_term,[&lt;&lt;131,109,0,0,244,240,108,109,102,97,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg13032.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd6.html#13038">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail6.html#13038">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13039.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg13016.html">Ownership handoff never completes</a></span> <span class="sender italic">Jeppe Toustrup</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13024.html">Re: Ownership handoff never completes</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13028.html">Re: Ownership handoff never completes</a></span> <span class="sender italic">Jeppe Toustrup</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13032.html">Re: Ownership handoff never completes</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Ownership handoff never completes</span> <span class="sender italic">Jeppe Toustrup</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13039.html">Ownership handoff never completes</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13040.html">Re: Ownership handoff never compl...</a></span> <span class="sender italic">Brian Sparrow</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Ownership handoff never completes">
<input type="hidden" name="msgid" value="CA+QV=MCDnkS6VnVQh8MywP62eTva95Y_OKDhs8d4bLoWcXwDUQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg13038.html">
<input type="submit" value=" Jeppe Toustrup ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Ownership+handoff+never+completes%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg13032.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13039.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA+QV=MCDnkS6VnVQh8MywP62eTva95Y_OKDhs8d4bLoWcXwDUQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
