<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Advice for storing records in Riak</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10880" id="c">
<link rel="index" href="maillist.html#10880" id="i">
<link rel="prev" href="msg10868.html" id="p">
<link rel="next" href="msg10864.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10880.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Advice+for+storing+records+in+Riak%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Advice for storing records in Riak</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130414" rel="nofollow">Sun, 14 Apr 2013 19:39:34 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 12/04/13 19:49, Christian Dahlqvist wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Toby,</pre><pre>

Inserting lots of small records in Riak and querying the full data set
via MapReduce is definitely not the best way to go around things. As
Alexander points out, easy object is stored with metadata, which adds
some overhead and Riak MapReduce tends to work best when run over
smaller data sets.

In order to help and come up with suggestions on how to model your data
efficiently I would need to better understand the nature of the data you
want to store in Riak, the access patterns and how you need to be able
to query it.

- What does the data represent? Are there any natural way to group records?
- How frequently are records inserted? How often are they updated? Do
you delete records or keep them forever?
- How do you need to be able to query this data? What is the logical
task of the MapReduce job you described?
- In what different ways is the data aggregated?
</pre></blockquote><pre style="margin: 0em;">


Hi Christian,
thanks for your offer of help.

The dataset I'm looking at is roughly described as follows:

</pre><tt>Records consist of a small number of organisations and their metadata; a 
</tt><tt>moderate number of people associated with those organisations and their 
</tt><tt>metadata; and then a large number of events which refer to a single 
</tt><tt>person and single organisation along with data about the event.
</tt><pre style="margin: 0em;">

</pre><tt>This dataset has data that goes back in time a fair way, and the intent 
</tt><tt>is to keep it indefinitely. New data arrives in batches throughout the 
</tt><tt>year. The only time data is deleted is when it is discovered to be 
</tt><tt>faulty and is replaced by a new batch of corrected records.
</tt><pre style="margin: 0em;">

</pre><tt>There are some ways the data could be logically grouped, such as by 
</tt><tt>organisation, or by person, but we can't just roll it all up into 
</tt><tt>aggregates at the start.
</tt><pre style="margin: 0em;">

</pre><tt>Actual queries can easily be segmented to only be working over a subset 
</tt><tt>of the whole data, per query. We do that already on the existing SQL system.
</tt><pre style="margin: 0em;">

</pre><tt>The actual queries we run usually aggregate the data from the raw events 
</tt><tt>up to either person or organisation level by time period. Some are quite 
</tt><tt>simple queries, such as &quot;number of events per org where this single 
</tt><tt>value exceeded a fixed threshold&quot;. Some others are more complex, such as 
</tt><tt>finding events where certain values have exceeded the typical range for 
</tt><tt>that value as seen by the parent person or organisation.
</tt><pre style="margin: 0em;">

</pre><tt>The big queries don't need to run instantly; we run them all and store 
</tt><tt>the results.
</tt><tt>The queries tend to get tweaked or updated regularly, requiring them to 
</tt><tt>be re-run over the entire dataset, or at least the recent periods, and 
</tt><tt>it's desirable that this process completes in a reasonable timeframe.
</tt><pre style="margin: 0em;">



</pre><tt>Currently this all runs in a big PostgreSQL database, reasonably 
</tt><tt>successfully, but as the amount of data and the number of queries grows, 
</tt><tt>I'm investigating options to horizontally scale the system, and on the 
</tt><tt>face of it I think the data and queries would suit a map-reduce system?
</tt><pre style="margin: 0em;">


Cheers,
Toby


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 12 Apr 2013, at 09:11, Alexander Sicular &lt;sicul...@gmail.com
&lt;<a  rel="nofollow" href="mailto:sicul...@gmail.com">mailto:sicul...@gmail.com</a>&gt;&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Inline -Alexander.

On Apr 12, 2013 3:11 AM, &quot;Toby Corkindale&quot;
&lt;toby.corkind...@strategicdata.com.au
&lt;<a  rel="nofollow" href="mailto:toby.corkind...@strategicdata.com.au">mailto:toby.corkind...@strategicdata.com.au</a>&gt;&gt; wrote:
&gt;
&gt; Hi,
&gt; I wondered if I could get a little advice on good practices for
storing my records in Riak, such that they perform reasonably well in
map-reduce queries?
&gt;
&gt; I have a little over 200 million records, currently stored in a
regular SQL database. I'm expecting this dataset to continue to grow,
of course.
&gt; Each record is reasonably small - some get up to couple of hundred
bytes, but most are smaller, and consist of around a dozen numeric
fields and some small alphanumeric identifier fields.
&gt;
&gt; My initial trial of importing these into Riak were to take each
database row and convert it into a small JSON of key=&gt;value pairs.
&gt;
&gt; I'm find two issues with this though.
&gt; 1) It takes a really long time to import everything into Riak, at
least compared to ingesting into PostgreSQL. (I'm using Riak's HTTP API)

Proto buff interface is faster,  less overhead. ..

&gt; 2) An initial trial of some map-reduce queries was significantly
slower than I was hoping; I suspect this is because of my data
structure though.
&gt; My initial map phase was iterating over a high percentage of the
keys, decoding the JSON, and then returning just one or two of the
fields from the JSON structure, which is maybe an inefficient way to
go about things?

Not the most efficient.  Everything is translated from erlang to
JavaScript and shipped over to the coordinating node.  MR over smaller
sets,  accumulate over some range like time or something native to
your app.

&gt;
&gt;
&gt; So I was wondering if there's a better way to be approaching the
problem.. I wondered about breaking up the records further, and
storing individual fields against keys, rather than the whole record
as a JSON object.
&gt;
&gt; Eg. This was my initial method:
&gt; Key: {id}:{recordtype}:{recordid}
&gt; Value: { field1: &quot;foo&quot;, field2: &quot;bar&quot;, field3: &quot;baz&quot; }
&gt;
&gt; I wondered about this, creating one key for each field:
&gt; {id}:{recordtype}:{recordid}:field1 ==&gt; &quot;foo&quot;
&gt; {id}:{recordtype}:{recordid}:field2 ==&gt; &quot;bar&quot;
&gt; {id}:{recordtype}:{recordid}:field3 ==&gt; &quot;baz&quot;
&gt;

Don't do that.  There is a ~400b per key overhead in riak.

&gt; That would avoid the need for one of the map phases; but on the
other hand, now I'd be creating an order of magnitude more overall
keys in the db.
&gt;
&gt;
&gt; On the other hand, I wondered about going the other way, and
grouping records under one key. So instead of having keys 100, 101,
102 .. 109, I would have one key 10x that contained a JSON structure
with an array of records.. (I don't know whether I store 10, 50 or 100
records per key)
&gt;

I might batch depending on your access pattern and update pattern. If
you update values with any frequency it may not be worth it.  Riak has
no in place updates.

&gt; This would speed up the time taken to ingest data to Riak, and
reduce the number of total queries made by the map phase.. but would
increase the work DONE in the map phase and add inefficiencies as
sometimes only a few rows of the set would actually be required for a
given query.
&gt;
&gt;
&gt;
&gt; And the third consideration is that maybe I just need to scale up
the cluster size to have more machines. Currently it's running on a
small cluster of four nodes while trialling Riak. (And I'm comparing
performance with a single, but significantly more powerful, PostgreSQL
node)
&gt;
&gt;
&gt; There's nothing to stop me trying out all these methods, but I
thought I'd poll the community for advice since no doubt implemented
similar things before and know what rough things may or may not work well.
&gt;
&gt;
&gt; Thanks,
&gt; Toby
</pre></blockquote></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10868.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10880">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10880">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10864.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10863.html">Advice for storing records in Riak</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10865.html">Re: Advice for storing records in Riak</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10868.html">Re: Advice for storing records in Riak</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Advice for storing records in Riak</span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Advice for storing records in Riak">
<input type="hidden" name="msgid" value="516B6811.80905@strategicdata.com.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10880.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Advice+for+storing+records+in+Riak%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10868.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10864.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">516B6811.80905@strategicdata.com.au</li>
</ul>
</div>
</body>
</html>
