<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak performance problems when LevelDB database grows beyond 16GB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#08948" id="c">
<link rel="index" href="mail3.html#08948" id="i">
<link rel="prev" href="msg08930.html" id="p">
<link rel="next" href="msg08969.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08948.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak performance problems when LevelDB database grows beyond 16GB</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jan.Evangelista%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jan.Evangelista</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121017" rel="nofollow">Wed, 17 Oct 2012 05:59:26 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Evan,

I corrected the setup according to your recommendations:</pre><pre>

- vm.swappiness is 0
- fs is ext4 on software RAID1, mounted with noatime
- disk scheduler is set to deadline (it was the default)
- eleveldb max_open_files is set to 200, cache is set to default

(BTW, why is Riak not using the new O_NOATIME open(2) flag?)

I restarted the last test with 3x40G and 1x14G DB, and it was able to sustain 
1000 ops/sec for 5 minutes. Then node5 stalled with the call stack described in 
the original mail, 1 of 4 cores almost 100% busy. The node did write 29 M/s 
(140 IOPs), with an occasional read (&lt;5 IOPs), with 252 open LevelDB files. The 
disk has 869G of free space.

When I looked at the performance graphs 17 hours later, it still did write at 
cca 29M/s (120 IOPs), with the same call stack. The Riak node was  busy even 
after 17 hours without any application requests, and it was not even connected 
to the rest of the Riak cluster (the node was not listed by erlang:nodes() on 
other nodes). I would suspect a bug in LevelDB, but people are using it in 
production, aren't they?

I intend to retry the test without the software RAID. Any other hints?

Best regards, Jan

---------- Původní zpráva ----------
Od: Evan Vigil-McClanahan 
Datum: 12. 10. 2012
Předmět: Re: Re: Riak performance problems when LevelDB database grows beyond 
16GB
Hi there, Jan,

The lsof issue is that max_open_files is per backend, iirc, so if
you're maxed out you'll see vnode count * max_open_files.

I think on the second try, you may have set the cache too high.   I'd
drop it back to 8 or 16 MB, and possibly up the open files a bit more,
but you don't seem to be running into contention at this point.
There's a RAM cost, so maybe just leave it where it is for now, unless
you have quite a lot of memory.

Another thing to check is that vm.swappiness is set to 0 and that your
disk scheduler is set to deadline for spinning disks and noop for
SSDs.

On Fri, Oct 12, 2012 at 5:02 AM,   wrote:
&gt;&gt; Can you attach the eleveldb portion of your app.config file?
&gt;&gt; Configuration problems, especially max_open_files being too low, can
&gt;&gt; often cause issues like this.
&gt;&gt;
&gt;&gt; If it isn't sensitive, the whole app.config and vm.args files are also
&gt;&gt; often helpful.
&gt;
&gt; Hello Evan,
&gt;
&gt; thanks for responding.
&gt;
&gt; I originally had default LevelDB settings. When the node stalled, I changed it
&gt;  to
&gt;
&gt;  {eleveldb, [
&gt;              {data_root, &quot;/home/riak/leveldb&quot;},
&gt;              {max_open_files, 132},
&gt;              {cache_size, 377487360}
&gt;             ]},
&gt;
&gt; on all nodes and I restarted them all. The application started to run with
&gt; about 1000 requests/second, after about 1 minute it dropped to &lt;500
&gt; requests/second, and the node stalled again after 41 minutes. BTW according to
&gt;  lsof(1) it had 267 open LevelDB files which is more than the 132 files limit
&gt; (??).
_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08930.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#08948">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail3.html#08948">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08969.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08881.html">Riak performance problems when LevelDB database grow...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08887.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08893.html">Re: Re: Riak performance problems when Leve...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08894.html">Re: Re: Riak performance problems when ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08924.html">Re: Re: Re: Riak performance proble...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08927.html">Re: Riak performance problems ...</a></span> <span class="sender italic">Eli Janssen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08930.html">Re: Re: Riak performance p...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul></li>
</ul></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak performance problems when ...</span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08969.html">Re: Riak performance problems ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08959.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08970.html">Re: Riak performance problems when LevelDB ...</a></span> <span class="sender italic">István</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg09003.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09017.html">Re: Riak performance problems when LevelDB ...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li class="icons-email"><span class="subject"><a href="msg09361.html">Re: Re: Riak performance problems when Leve...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09362.html">Re: Riak performance problems when Leve...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09369.html">Re: Re: Riak performance problems w...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak performance problems when LevelDB database grows beyond 16GB">
<input type="hidden" name="msgid" value="13V.2jUNu.6j9uKjMC{NE.1GVgkS@seznam.cz">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08948.html">
<input type="submit" value=" Jan.Evangelista ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08930.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08969.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">13V.2jUNu.6j9uKjMC{NE.1GVgkS@seznam.cz</li>
</ul>
</div>
</body>
</html>
