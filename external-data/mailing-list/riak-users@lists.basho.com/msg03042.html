<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: "Failed to compact" in RiakSearch</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03042" id="c">
<link rel="index" href="maillist.html#03042" id="i">
<link rel="prev" href="msg03017.html" id="p">
<link rel="next" href="msg03056.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03042.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%5C%22Failed+to+compact%5C%22+in+RiakSearch%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: "Failed to compact" in RiakSearch</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Rusty+Klophaus%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Rusty Klophaus</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110414" rel="nofollow">Thu, 14 Apr 2011 11:00:24 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Morten,

Thanks for sending the log files. I was able to figure out, at least
partially, what's going on here.</pre><pre>

The &quot;Failed to compact&quot; message is a result of trying to index a token
that's greater than 32kb in size. (The index storage engine, called
merge_index, assumes tokens sizes smaller than 32kb.) I was able to decode
part of the term in question by pulling data from the log file, and it looks
like you may be indexing HTML with base64 encoded inline images, ie: &lt;img
src=&quot;data:image/jpeg;base64,iVBORw0KG...&quot;&gt; The inline image is being treated
as a single token, and it's greater than 32kb.

The short term workaround is to either:

1) Preprocess your data to avoid this situation.
2) Or, create a custom analyzer that limits the size of terms (See
<a  rel="nofollow" href="http://wiki.basho.com/Riak-Search---Schema.html">http://wiki.basho.com/Riak-Search---Schema.html</a> for more information about
analyzers and custom analyzers.)

The long term solution is for us to increase the maximum token size in
merge_index. I've filed a bugzilla issue for this, trackable here:
<a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=1069">https://issues.basho.com/show_bug.cgi?id=1069</a>

Still investigating the &quot;Too many db tables&quot; error. This is being caused by
the system opening too many ETS tables. It *may* be related to the
compaction error described above, but I'm not sure.

Search (specifically merge_index) uses ETS tables heavily, and the number of
tables is affected by a few different factors. Can you send me some more
information to help debug, specifically:

   - How many partitions (vnodes) are in your cluster? (If you haven't
   changed any settings, then the default is 64.)
   - How many machines are in your cluster?
   - How many segments are on the node where you are seeing these errors?
   (Run: &quot;*find DATAPATH/merge_index/*/*.data | wc -l*&quot;, replacing DATAPATH
   with the path to your Riak data directory for that node.)
   - Approximately how much data are you loading (# Docs and # MB), and how
   quickly are you trying to load it?

Best,
Rusty

On Thu, Apr 14, 2011 at 3:07 AM, Morten Siebuhr &lt;sbhr+li...@sbhr.dk&gt; wrote:

&gt; Hi Rusty &amp; al,
&gt;
&gt; On Wed, Apr 13, 2011 at 11:20 PM, Rusty Klophaus &lt;ru...@basho.com&gt; wrote:
&gt; &gt; Thanks Morten, having the logs (including the numbers) will help us debug
&gt; &gt; what's going on.
&gt;
&gt; Here it is.
&gt;
&gt; It seems we've hit some db-imposed limit during the night's test data
&gt; import - I'll have to investigate that too...
&gt;
&gt; Kind regards,
&gt; Morten Siebuhr
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03017.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03042">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03042">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03056.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02999.html">&quot;Failed to compact&quot; in RiakSearch</a></span> <span class="sender italic">Morten Siebuhr</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03001.html">Re: &quot;Failed to compact&quot; in RiakSearch</a></span> <span class="sender italic">Andrew Thompson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03016.html">Re: &quot;Failed to compact&quot; in RiakSearch</a></span> <span class="sender italic">Morten Siebuhr</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03017.html">Re: &quot;Failed to compact&quot; in RiakSear...</a></span> <span class="sender italic">Rusty Klophaus</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: &quot;Failed to compact&quot; in Riak...</span> <span class="sender italic">Rusty Klophaus</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03056.html">Re: &quot;Failed to compact&quot; in...</a></span> <span class="sender italic">Morten Siebuhr</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03057.html">Re: &quot;Failed to compact&quot...</a></span> <span class="sender italic">Rusty Klophaus</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03069.html">Re: &quot;Failed to compact&...</a></span> <span class="sender italic">Morten Siebuhr</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: &quot;Failed to compact&quot; in RiakSearch">
<input type="hidden" name="msgid" value="BANLkTi=cLUB58QMZ8Lo=c6d2bdeJJtOG9w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03042.html">
<input type="submit" value=" Rusty Klophaus ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%5C%22Failed+to+compact%5C%22+in+RiakSearch%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03017.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03056.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">BANLkTi=cLUB58QMZ8Lo=c6d2bdeJJtOG9w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
