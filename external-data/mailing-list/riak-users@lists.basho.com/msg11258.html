<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Segmentation fault in eleveldb.so on Riak startup</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd15.html#11258" id="c">
<link rel="index" href="mail15.html#11258" id="i">
<link rel="prev" href="msg11257.html" id="p">
<link rel="next" href="msg11259.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11258.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Segmentation+fault+in+eleveldb.so+on+Riak+startup%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Segmentation fault in eleveldb.so on Riak startup</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Von%5C-Maszewski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Von-Maszewski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130612" rel="nofollow">Wed, 12 Jun 2013 16:06:56 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Vladimir,

You have one of two problems, either there is something in one of the existing 
.sst files causing compaction to crash, or there is some type of threading 
problem that crash during the hash/bloom creation.  I am going to assume an 
.sst file problem for now.</pre><pre>

The last time you crashed, only 6 vnodes were actively compacting.  Their 
directory names start as follows:

 21694
 23977
 473846
 65082
 7478777
 7707137

I leave it to you to copy and paste the full directory names.

The first step is to find which directory is crashing.  Use the instructions 
here

<a  rel="nofollow" href="https://gist.github.com/gburd/b88aee6da7fee81dc036">https://gist.github.com/gburd/b88aee6da7fee81dc036</a>

BUT instead of &quot;eleveldb:repair&quot;, use &quot;eleveldb:open&quot;. Wait five minutes after 
each open to see if each vnode's compactions run completely without crashing.

If one crashes, that is where the problem exists.  If none of them crash, then 
there is a threading / race condition … and I will have to think on how to 
diagnose.

Matthew


On Jun 12, 2013, at 6:09 PM, Vladimir Shabanov &lt;vshaban...@gmail.com&gt; wrote:

&gt; Unfortunately I don't see any 'Compaction error' in my logs.
&gt; 
&gt; Should I run eleveldb:repair() on all partitions? And if should how I can run 
&gt; a function for all files in directory in Erlang? Running function manually 
&gt; for all partitions is too tiresome.
&gt; 
&gt; 
&gt; 2013/6/13 Matthew Von-Maszewski &lt;matth...@basho.com&gt;
&gt; Vladimir,
&gt; 
&gt; Also, my colleague sent this to me after my first email.  This is roughly the 
&gt; plan I intend to follow … if the LOG file gives us a direct pointer to a file 
&gt; corruption:
&gt; 
&gt; <a  rel="nofollow" href="https://gist.github.com/gburd/b88aee6da7fee81dc036">https://gist.github.com/gburd/b88aee6da7fee81dc036</a>
&gt; 
&gt; However, your crash point suggests we might have to do a bit more work to 
&gt; isolate the bad input file.  But I would be happy to be wrong and the above 
&gt; work as is.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; On Jun 12, 2013, at 5:13 PM, Matthew Von-Maszewski &lt;matth...@basho.com&gt; wrote:
&gt; 
&gt;&gt; Vladimir,
&gt;&gt; 
&gt;&gt; I asked around the Basho chat room and you have a crash that has never been 
&gt;&gt; seen.  This should be interesting.
&gt;&gt; 
&gt;&gt; The crash is happening during a compaction, specifically during the creation 
&gt;&gt; of the bloom filter for a new .sst file.  Maybe we can isolate the old file 
&gt;&gt; that feeding this compaction and move it out of the way for further 
&gt;&gt; debugging … and get you running while the debugging happens off-line.
&gt;&gt; 
&gt;&gt; Would you tar/zip the following files (changing the paths as appropriate for 
&gt;&gt; your system):
&gt;&gt; 
&gt;&gt; tar -czf vladimir_LOGs.tgz /var/lib/riak/leveldb/*/LOG*
&gt;&gt; and your app.config file.
&gt;&gt; 
&gt;&gt; I will see if I can determine where the bad input file resides and help you 
&gt;&gt; get back running.  Then we can decide how to look deeper for root cause.
&gt;&gt; 
&gt;&gt; Matthew
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Jun 12, 2013, at 4:02 PM, Vladimir Shabanov &lt;vshaban...@gmail.com&gt; wrote:
&gt;&gt; 
&gt;&gt;&gt; Hello,
&gt;&gt;&gt; 
&gt;&gt;&gt; I have a cluster of 8 Riak-1.3.1 nodes. Recently one of my nodes silently 
&gt;&gt;&gt; crashed. Nothing unusual was reported in logs.
&gt;&gt;&gt; 
&gt;&gt;&gt; When I've tried to start my node again it worked for few seconds and 
&gt;&gt;&gt; silently crashed again. I've run 'riak console' and seen &quot;Segmentation 
&gt;&gt;&gt; fault&quot;.
&gt;&gt;&gt; 
&gt;&gt;&gt; gdb with dumped core shows:
&gt;&gt;&gt; 
&gt;&gt;&gt; Program terminated with signal 11, Segmentation fault.
&gt;&gt;&gt; #0  0x00007f162547fa30 in MurmurHash64A(void const*, int, unsigned int) ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; 
&gt;&gt;&gt; Backtrace shows that it happens somewhere in LevelDB compaction.
&gt;&gt;&gt; 
&gt;&gt;&gt; (gdb) bt
&gt;&gt;&gt; #0  0x00007f162547fa30 in MurmurHash64A(void const*, int, unsigned int) ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #1  0x00007f162547833c in leveldb::(anonymous 
&gt;&gt;&gt; namespace)::BloomFilterPolicy2::CreateFilter(leveldb::Slice const*, int, 
&gt;&gt;&gt; std::string*) const ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #2  0x00007f162548382d in leveldb::FilterBlockBuilder::GenerateFilter() ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #3  0x00007f1625483a58 in leveldb::FilterBlockBuilder::StartBlock(unsigned 
&gt;&gt;&gt; long) ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #4  0x00007f1625475175 in leveldb::TableBuilder::Flush() ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #5  0x00007f1625475395 in leveldb::TableBuilder::Add(leveldb::Slice const&amp;, 
&gt;&gt;&gt; leveldb::Slice const&amp;) () from 
&gt;&gt;&gt; /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #6  0x00007f162545b561 in 
&gt;&gt;&gt; leveldb::DBImpl::DoCompactionWork(leveldb::DBImpl::CompactionState*) () 
&gt;&gt;&gt; from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #7  0x00007f162545bd3b in leveldb::DBImpl::BackgroundCompaction() ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #8  0x00007f162545ca5d in leveldb::DBImpl::BackgroundCall() ()
&gt;&gt;&gt;    from /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #9  0x00007f162547bb38 in leveldb::(anonymous 
&gt;&gt;&gt; namespace)::PosixEnv::BGThreadWrapper(void*) () from 
&gt;&gt;&gt; /tank/riak-1.3.1/lib/eleveldb-1.3.0/priv/eleveldb.so
&gt;&gt;&gt; #10 0x00007f163366ab50 in start_thread () from 
&gt;&gt;&gt; /lib/x86_64-linux-gnu/libpthread.so.0
&gt;&gt;&gt; #11 0x00007f16331aca7d in clone () from /lib/x86_64-linux-gnu/libc.so.6
&gt;&gt;&gt; #12 0x0000000000000000 in ?? ()
&gt;&gt;&gt; 
&gt;&gt;&gt; gdb output in gist
&gt;&gt;&gt; <a  rel="nofollow" href="https://gist.github.com/vshabanov/5768546">https://gist.github.com/vshabanov/5768546</a>
&gt;&gt;&gt; 
&gt;&gt;&gt; Why it's happening and how to bring the node back to life?
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; 
&gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11257.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd15.html#11258">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail15.html#11258">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11259.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11255.html">Segmentation fault in eleveldb.so on Riak startup</a></span> <span class="sender italic">Vladimir Shabanov</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11256.html">Re: Segmentation fault in eleveldb.so on Riak s...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11257.html">Re: Segmentation fault in eleveldb.so on Ri...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Segmentation fault in eleveldb.so o...</span> <span class="sender italic">Matthew Von-Maszewski</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Segmentation fault in eleveldb.so on Riak startup">
<input type="hidden" name="msgid" value="EF8C4287-72F7-470F-A7D6-F356B4AE5F81@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11258.html">
<input type="submit" value=" Matthew Von-Maszewski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Segmentation+fault+in+eleveldb.so+on+Riak+startup%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11257.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11259.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">EF8C4287-72F7-470F-A7D6-F356B4AE5F81@basho.com</li>
</ul>
</div>
</body>
</html>
