<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: haproxy issues with protocol buffers on 2.x releases</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16214" id="c">
<link rel="index" href="maillist.html#16214" id="i">
<link rel="prev" href="msg16211.html" id="p">
<link rel="next" href="msg16273.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16214.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+haproxy+issues+with+protocol+buffers+on+2.x+releases%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: haproxy issues with protocol buffers on 2.x releases</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150604" rel="nofollow">Thu, 04 Jun 2015 23:17:46 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Kota,
Our production nodes are Riak CS 1.5 and Riak 1.4.x -- they're running
haproxy 1.4.x, and it's all been happy for some time now.</pre><pre>

Testing the new nodes, still same haproxy versions, but Riak CS 2.0.1 and
Riak 1.0.5.
Very confused as to why the connections are being dropped when going
through haproxy. The problem persists even after restarting CS.
I tried staggering the restarts.. increasing the PB request pool.. etc..
 no change.

But it works fine if CS connects directly to the localhost riak pb.
(Which isn't a great idea.. big Riak instances sometimes take too long to
start, and CS falls over because it started too fast and couldn't connect,
if you're going to localhost)

Confusing! I'm wondering if it's because the testing machines are in
virtual machines, compared to production which is real hardware.
But.. normally haproxy still works fine on VMs.

I'll continue to play around.. Must be something that's botched on the
testing setup... but don't want to replicate that into production!


On Fri, 5 Jun 2015 at 13:59 Kota Uenishi &lt;k...@basho.com&gt; wrote:

&gt; Toby,
&gt;
&gt; As PB connection management haven't been changed between CS 1.5 and
&gt; 2.0, I think it should work. What's the version the load balancing
&gt; working stable? It depends of the reason why connection has been cut,
&gt; but I would recommend you restart just the CS node and recreate the
&gt; connection pool.
&gt;
&gt; On Thu, Jun 4, 2015 at 2:33 PM, Toby Corkindale &lt;t...@dryft.net&gt; wrote:
&gt; &gt; Hi,
&gt; &gt; I've been happily using haproxy in front of Riak and Riak CS 1.x in
&gt; &gt; production for quite a while.
&gt; &gt;
&gt; &gt; I've been trying to bring up a new cluster based on riak/cs 2.0.x
&gt; recently,
&gt; &gt; as you've probably noticed from the flurry of emails to this list :)
&gt; &gt;
&gt; &gt; I'm discovering that if I have haproxy sitting between riak-cs and riak,
&gt; &gt; then I get a lot of errors about disconnections. Initially I thought this
&gt; &gt; must be related to pb backlogs or pool sizes or file handle limits -- but
&gt; &gt; I've played with all those things to no avail.
&gt; &gt;
&gt; &gt; I *have* noticed that if I get riak-cs to connect directly to a riak
&gt; &gt; (bypassing haproxy) then everything is fine, including with the original
&gt; &gt; default request pool and backlog sizes.
&gt; &gt;
&gt; &gt; I am essentially using the recommended haproxy.cfg, which has worked
&gt; fine in
&gt; &gt; production elsewhere.
&gt; &gt;
&gt; &gt; Any suggestions?
&gt; &gt; Error message sample follows:
&gt; &gt;
&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt; &gt; &lt;0.283.0&gt;@riak_cs_riak_client:get_user_with_pbc:293 Fetching user re
&gt; &gt; cord with strong option failed: disconnected
&gt; &gt; 2015-06-04 15:26:16.447 [warning]
&gt; &gt; &lt;0.2095.0&gt;@riak_cs_pbc:check_connection_status:97 Connection status
&gt; &gt; of &lt;0.287.0&gt; at maybe_create_user: {false,[]}
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; Cheers
&gt; &gt; Toby
&gt; &gt;
&gt; &gt; _______________________________________________
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Kota UENISHI / @kuenishi
&gt; Basho Japan KK
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16211.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16214">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16214">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16273.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16197.html">haproxy issues with protocol buffers on 2.x releases</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16211.html">Re: haproxy issues with protocol buffers on 2.x relea...</a></span> <span class="sender italic">Kota Uenishi</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: haproxy issues with protocol buffers on 2.x r...</span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16273.html">Re: haproxy issues with protocol buffers on 2...</a></span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: haproxy issues with protocol buffers on 2.x releases">
<input type="hidden" name="msgid" value="CABEgq95hoHMYtQ+6hwNY6C0QdExmXGyedE3t-W6o4m71z9Sv5w@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16214.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+haproxy+issues+with+protocol+buffers+on+2.x+releases%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16211.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16273.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABEgq95hoHMYtQ+6hwNY6C0QdExmXGyedE3t-W6o4m71z9Sv5w@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
