<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Invalid hintfiles</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd10.html#12316" id="c">
<link rel="index" href="mail10.html#12316" id="i">
<link rel="prev" href="msg12315.html" id="p">
<link rel="next" href="msg12430.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12316.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Invalid+hintfiles%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Invalid hintfiles</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Seth+Thomas%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Seth Thomas</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130918" rel="nofollow">Wed, 18 Sep 2013 19:05:23 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<table width="100%"><tr><td style=""><div id="bloop_customfont" style="font-family:Helvetica,Arial;font-size:13px; margin: 0px; line-height: auto;">Toby,</div><div id="bloop_customfont" style="font-family:Helvetica,Arial;font-size:13px; margin: 0px; line-height: auto;"><br></div><div id="bloop_customfont" style="font-family:Helvetica,Arial;font-size:13px; margin: 0px; line-height: auto;">Although I haven't traced a root cause just yet I've had several reports in IRC of odd behavior when using nginx as a load balancer for Riak CS. In almost every case, removing nginx from the equation and switching to haproxy or pointing directly at the nodes in the application has resolved issues. It's anecdotal until I can actually determine a root cause but it's worth testing out if you're experiencing trouble.</div><div id="bloop_customfont" style="font-family:Helvetica,Arial;font-size:13px; margin: 0px; line-height: auto;"><br></div> <div class="" id="bloop_sign_1379556051394056192"><span style="font-family:helvetica,arial;font-size:13px"></span>--&nbsp;<br>Seth Thomas</div><p style="color:#A0A0A8;">On September 18, 2013 at 8:48:27 PM, Toby Corkindale (toby.corkind...@strategicdata.com.au) wrote:</p> <blockquote type="cite" style="border-left-style:solid;border-width:1px;margin-left:0px;padding-left:10px;"><span><div>On 19/09/13 11:17, Luke Bakken wrote:
<br>&gt; Hi Toby,
<br>&gt;
<br>&gt; Invalid hint files won't cause Riak to fail requests - there must have
<br>&gt; been something else happening. Hint files are used by Riak to speed
<br>&gt; start time when loading a large key set.
<br>&gt;
<br>&gt; You mentioned a "load-balancer pool" - are you using something like
<br>&gt; HAProxy to load-balance requests to your Riak CS cluster?
<br>&gt;
<br>&gt; The "error: disconnected" message is a good clue. If you can provide
<br>&gt; log files that may point to the cause.
<br>
<br>Hi Luke,
<br>I'm still seeing quite a few failed requests. I've been chasing the  
<br>hintfiles but I guess that was a red herring.
<br>
<br>We're using nginx to load balance requests to Riak CS.
<br>I tried going directly to each node in turn, and it didn't show that any  
<br>one node was reliably failing every request.
<br>
<br>Hitting one server just now came up with OK/403/403/OK/OK.
<br>Trying another was OK/OK/OK/OK/403 though.
<br>
<br>Here's some logs from riak-cs:
<br>
<br>error.log:2013-09-19 11:37:02.242 [error]  
<br>&lt;0.5105.0&gt;@riak_cs_wm_common:maybe_create_user:223 Retrieval of user  
<br>record for s3 failed. Reason: disconnected
<br>
<br>There wasn't anything immediately either side of that. The riak logs for  
<br>the same minute on that server likewise do not have anything.
<br>
<br>There's quite a lot of free memory on the servers; they have 32000 file  
<br>handles available.
<br>
<br>Toby
<br>
<br>
<br>&gt; On Wed, Sep 18, 2013 at 4:29 PM, Toby Corkindale
<br>&gt; &lt;toby.corkind...@strategicdata.com.au&gt; wrote:
<br>&gt;&gt; I found one Riak server was reporting a lot of errors like
<br>&gt;&gt; [error] &lt;0.808.0&gt; Hintfile
<br>&gt;&gt; '/var/lib/riak/bitcask/68507889249886074290797726533575766546371837952/3.bitcask.hint'
<br>&gt;&gt; invalid
<br>&gt;&gt;
<br>&gt;&gt; And the Riak CS logs contained a lot of messages about being unable to
<br>&gt;&gt; retrieve s3 user details because "error: disconnected"
<br>&gt;&gt;
<br>&gt;&gt; I think I've blown away the bad hintfiles and have had them repaired from
<br>&gt;&gt; other replicas now, and I haven't seen any more errors for a little while.
<br>&gt;&gt;
<br>&gt;&gt; I'm not sure what caused those to become invalid.
<br>&gt;&gt; Just a thought, but would be good if Riak could automatically repair them
<br>&gt;&gt; rather than failing requests.
<br>&gt;&gt;
<br>&gt;&gt; Cheer,s
<br>&gt;&gt; Toby
<br>&gt;&gt;
<br>&gt;&gt; On 19/09/13 08:42, Toby Corkindale wrote:
<br>&gt;&gt;&gt;
<br>&gt;&gt;&gt; Ah, hold on.. have just discovered that rather than it being deletion
<br>&gt;&gt;&gt; calls, it seems to just be every X calls of any sort.. sounds like one
<br>&gt;&gt;&gt; of the servers in the load-balancer pool must be misconfigured somehow,
<br>&gt;&gt;&gt; but the rest are OK.
<br>&gt;&gt;&gt;
<br>&gt;&gt;&gt; On 19/09/13 08:34, Toby Corkindale wrote:
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; I've just upgraded from Riak CS 1.3.1 to 1.4.1
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; Using s3cmd to test a few things, I've found some odd behaviour.
<br>&gt;&gt;&gt;&gt; Creating a bucket and putting a file works just fine, eg:
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; s3cmd mb s3://test
<br>&gt;&gt;&gt;&gt; s3cmd put README s3://test
<br>&gt;&gt;&gt;&gt; s3cmd get s3://test/README
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; However if I try to delete a file or bucket, it throws an error:
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; s3cmd del s3://test/README
<br>&gt;&gt;&gt;&gt; ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you
<br>&gt;&gt;&gt;&gt; provided does not exist in our records.
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; s3cmd rb s3://test
<br>&gt;&gt;&gt;&gt; ERROR: S3 error: 403 (InvalidAccessKeyId): The AWS Access Key Id you
<br>&gt;&gt;&gt;&gt; provided does not exist in our records.
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt;
<br>&gt;&gt;&gt;&gt; Have I messed something up during the upgrade, or is this a bug in 1.4.1?
<br>
<br>
<br>_______________________________________________
<br>riak-users mailing list
<br>riak-users@lists.basho.com
<br>http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com
<br></div></span></blockquote></td></tr></table><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12315.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd10.html#12316">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail10.html#12316">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12430.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12310.html">Riak CS 1.4.1 bug? InvalidAccessKeyId reported for deletio...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12311.html">Re: Riak CS 1.4.1 bug? InvalidAccessKeyId reported fo...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12313.html">Invalid hintfiles (was: Riak CS 1.4.1 bug? Invali...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12314.html">Re: Invalid hintfiles (was: Riak CS 1.4.1 bug...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12315.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Invalid hintfiles</span> <span class="sender italic">Seth Thomas</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12430.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Toby Corkindale</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg12317.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12318.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Andrew Stone</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12320.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12321.html">Re: Invalid hintfiles</a></span> <span class="sender italic">Andrew Stone</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Invalid hintfiles">
<input type="hidden" name="msgid" value="etPan.523a5b4e.6b8b4567.11a@wakizashi.local">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12316.html">
<input type="submit" value=" Seth Thomas ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Invalid+hintfiles%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12315.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12430.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">etPan.523a5b4e.6b8b4567.11a@wakizashi.local</li>
</ul>
</div>
</body>
</html>
