<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Object not found after successful PUT on S3 API</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#18193" id="c">
<link rel="index" href="maillist.html#18193" id="i">
<link rel="prev" href="msg18184.html" id="p">
<link rel="next" href="msg18195.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18193.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Object+not+found+after+successful+PUT+on+S3+API%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Object not found after successful PUT on S3 API</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Matthew+Von%5C-Maszewski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Matthew Von-Maszewski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20170502" rel="nofollow">Tue, 02 May 2017 08:03:05 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Daniel,

1G of ram is an interesting and untested challenge.  Others have succeeded in 
getting regular Riak KV to operate on a Raspberry PI with 2g of Ram.</pre><pre>

Here are the 3 things you can do in an attempt to drive down required RAM (in 
order of priority):

1.  reduce the ring size:  in riak.conf set “ring_size=16”.  It is currently 
128.  You will have to rebuild your dataset from scratch.

2.  reduce the memory model used by leveldb from “normal” to “developer&quot;

        {multi_backend, [
            {be_default, riak_kv_eleveldb_backend, [
                {data_root, &quot;/opt/data/ecrypt/riak/leveldb”},
                {limited_developer_mem, true}
            ]},
            {be_blocks, riak_kv_eleveldb_backend, [
                {data_root, &quot;/opt/data/ecrypt/riak/blocks”},
                {limited_developer_mem, true}
            ]}
        ]}

3.  disable the active anti-entropy feature:  in riak.conf set &quot;anti_entropy = 
passive&quot;


The above 3 changes greatly reduce that runtime memory requirements.  I 
understand why your swappiness setting is helping.  It is pushing executable 
pages into swap in favor of data memory pages.  That is going to help in your 
situation.  Do not waste time going back to swappiness=0.

Matthew



&gt; On May 2, 2017, at 8:39 AM, Daniel Miller &lt;dmil...@dimagi.com 
&gt; &lt;<a  rel="nofollow" href="mailto:dmil...@dimagi.com">mailto:dmil...@dimagi.com</a>&gt;&gt; wrote:
&gt; 
&gt; Hi Mattew,
&gt; 
&gt; I have attached the file generated by riak-debug as requested. Thanks for 
&gt; taking a look at this for me.
&gt; 
&gt; The node I ran this on has had swappiness temporarily set back to 0 as it was 
&gt; when the load avg was spiking and the node was becoming unresponsive. I say 
&gt; &quot;temporarily&quot; because I had changed swappiness to 20 on all nodes over the 
&gt; weekend in an attempt to hopefully make the cluster more stable than it had 
&gt; been with swappiness=0. Incidentally, setting swappiness to 20 seemed to calm 
&gt; things down and the cluster has been stable with no issues over the weekend, 
&gt; which is great news, although a little confusing. I did notice that memory 
&gt; use is slowly increasing, so it's possible that once all of swap has been 
&gt; consumed the cluster will become unstable again.
&gt; 
&gt; In case you haven't reviewed the history on this thread, this is not a 
&gt; standard Riak CS configuration. I'm using leveldb for both be_blocks and 
&gt; be_default as directed by Luke Bakken after he discovered that the previous 
&gt; thing I had tried (storage_backend=leveldb with no advanced.config, and 
&gt; therefore no multi_backend), could possibly result in silent loss of data due 
&gt; to manifests being randomly overwritten.
&gt; 
&gt; The reason we're trying to use leveldb for both backends rather than bitcask 
&gt; is to hopefully run Riak in a more RAM constrained environment than is 
&gt; typical. As I understand it, bitcask keeps all keys in RAM while leveldb does 
&gt; not. The tradeoff of with using leveldb instead of bitcask is additional 
&gt; latency, but so far this has not been a problem for us.
&gt; 
&gt; Daniel
&gt; 
&gt; 
&gt; On Fri, Apr 28, 2017 at 10:15 AM, Matthew Von-Maszewski &lt;matth...@basho.com 
&gt; &lt;<a  rel="nofollow" href="mailto:matth...@basho.com">mailto:matth...@basho.com</a>&gt;&gt; wrote:
&gt; Daniel,
&gt; 
&gt; Something is wrong.  All instances of leveldb within a node share the total 
&gt; memory configuration.  The memory is equally divided between all active 
&gt; vnodes.  It is possible to create an OOM situation if total RAM is low and 
&gt; vnodes count per node is high relative to RAM size.
&gt; 
&gt; The best next step would be for you to execute the riak-debug program on one 
&gt; of the nodes known to experience OOM.  Send the resulting .tar.gz file 
&gt; directly to me (no need to share that with the mailing list).  I will review 
&gt; the memory situation and suggest options.
&gt; 
&gt; Matthew
&gt; 
&gt;&gt; On Apr 28, 2017, at 8:22 AM, Daniel Miller &lt;dmil...@dimagi.com 
&gt;&gt; &lt;<a  rel="nofollow" href="mailto:dmil...@dimagi.com">mailto:dmil...@dimagi.com</a>&gt;&gt; wrote:
&gt;&gt; 
&gt;&gt; Hi Luke,
&gt;&gt; 
&gt;&gt; I'm reviving this thread from March where we discussed a new backend 
&gt;&gt; configuration for our riak cluster. We have had a chance to test out the new 
&gt;&gt; recommended configuration, and so far we have not been successful in 
&gt;&gt; limiting the RAM usage of leveldb with multi_backend. We have tried various 
&gt;&gt; configurations to limit memory usage without success.
&gt;&gt; 
&gt;&gt; First try (default config).
&gt;&gt; riak.conf: leveldb.maximum_memory.percent = 70
&gt;&gt; 
&gt;&gt; Second try.
&gt;&gt; riak.conf: leveldb.maximum_memory.percent = 40
&gt;&gt; 
&gt;&gt; Third try
&gt;&gt; riak.conf: #leveldb.maximum_memory.percent = 40 (commented out)
&gt;&gt; advanced.config: [{eleveldb, [{total_leveldb_mem_percent, 30}]}, ...
&gt;&gt; 
&gt;&gt; In all cases (under load) riak consumes all available RAM and eventually 
&gt;&gt; becomes unresponsive, presumably due to OOM conditions. Is there a way to 
&gt;&gt; limit the amount of RAM consumed by riak with the new multi_backend 
&gt;&gt; configuration? For example, do we need to consider ring size or other 
&gt;&gt; configuration parameters when calculating the value of 
&gt;&gt; total_leveldb_mem_percent?
&gt;&gt; 
&gt;&gt; Notably, the old (storage_backend = leveldb in riak.conf, empty 
&gt;&gt; advanced.config) clusters have had very good RAM and disk usage 
&gt;&gt; characteristics. Is there any way we can make riak or riak cs avoid the rare 
&gt;&gt; occasions where it overwrites the manifest file while using this (non-multi) 
&gt;&gt; backend?
&gt;&gt; 
&gt;&gt; Thank you,
&gt;&gt; Daniel Miller
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Tue, Mar 7, 2017 at 3:58 PM, Luke Bakken &lt;lbak...@basho.com 
&gt;&gt; &lt;<a  rel="nofollow" href="mailto:lbak...@basho.com">mailto:lbak...@basho.com</a>&gt;&gt; wrote:
&gt;&gt; Hi Daniel,
&gt;&gt; 
&gt;&gt; Thanks for providing all of that information.
&gt;&gt; 
&gt;&gt; You are missing important configuration for riak_kv that can only be 
&gt;&gt; provided in an /etc/riak/advanced.config file. Please see the following 
&gt;&gt; document, especially the section to which I link here:
&gt;&gt; 
&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/riak-for-cs/#setting-up-the-proper-riak-backend">http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/riak-for-cs/#setting-up-the-proper-riak-backend</a>
&gt;&gt;  
&gt;&gt; &lt;<a  rel="nofollow" href="http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/riak-for-cs/#setting-up-the-proper-riak-backend">http://docs.basho.com/riak/cs/2.1.1/cookbooks/configuration/riak-for-cs/#setting-up-the-proper-riak-backend</a>&gt;
&gt;&gt; 
&gt;&gt; [
&gt;&gt;     {riak_kv, [
&gt;&gt;         % NOTE: double-check this path for your environment:
&gt;&gt;         {add_paths, [&quot;/usr/lib/riak-cs/lib/riak_cs-2.1.1/ebin&quot;]},
&gt;&gt;         {storage_backend, riak_cs_kv_multi_backend},
&gt;&gt;         {multi_backend_prefix_list, [{&lt;&lt;&quot;0b:&quot;&gt;&gt;, be_blocks}]},
&gt;&gt;         {multi_backend_default, be_default},
&gt;&gt;         {multi_backend, [
&gt;&gt;             {be_default, riak_kv_eleveldb_backend, [
&gt;&gt;                 {data_root, &quot;/opt/data/ecryptfs/riak&quot;}
&gt;&gt;             ]},
&gt;&gt;             {be_blocks, riak_kv_eleveldb_backend, [
&gt;&gt;                 {data_root, &quot;/opt/data/ecryptfs/riak_blocks&quot;}
&gt;&gt;             ]}
&gt;&gt;         ]}
&gt;&gt;     ]}
&gt;&gt; ].
&gt;&gt; 
&gt;&gt; Your configuration will look like the above. The contents of this file are 
&gt;&gt; merged with the contents of /etc/riak/riak.conf to produce the configuration 
&gt;&gt; that Riak uses.
&gt;&gt; 
&gt;&gt; Notice that I chose riak_kv_eleveldb_backend twice because of the discussion 
&gt;&gt; you had previously about RAM usage and bitcask 
&gt;&gt; (<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2016-November/018801.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2016-November/018801.html</a>
&gt;&gt;  
&gt;&gt; &lt;<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2016-November/018801.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2016-November/018801.html</a>&gt;)
&gt;&gt; 
&gt;&gt; In your current configuration, you are not using the expected prefix for the 
&gt;&gt; block data. My guess is that on very rare occasions your data happens to 
&gt;&gt; overwrite the manifest for a file. You may also have corrupted files at this 
&gt;&gt; point without noticing it at all.
&gt;&gt; 
&gt;&gt; IMPORTANT: you can't switch from your current configuration to this new one 
&gt;&gt; without re-saving all of your data.
&gt;&gt; 
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 
&gt;&gt; &lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;
&gt; 
&gt; 
&gt; &lt;r...@hqriak17.internal-in.commcarehq.org-riak-debug.tar.gz 
&gt; &lt;<a  rel="nofollow" href="mailto:r...@hqriak17.internal-in.commcarehq.org-riak-debug.tar.gz">mailto:r...@hqriak17.internal-in.commcarehq.org-riak-debug.tar.gz</a>&gt;&gt;

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18184.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#18193">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18193">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18195.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18070.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg18077.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Daniel Miller</span></li>
<li class="icons-email"><span class="subject"><a href="msg18078.html">Fwd: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg18082.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Daniel Miller</span></li>
<li class="icons-email"><span class="subject"><a href="msg18083.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li class="icons-email"><span class="subject"><a href="msg18084.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg18085.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li class="icons-email"><span class="subject"><a href="msg18182.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Daniel Miller</span></li>
<li class="icons-email"><span class="subject"><a href="msg18183.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li class="icons-email"><span class="subject"><a href="msg18184.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Object not found after successful PUT on S3 API</span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li class="icons-email"><span class="subject"><a href="msg18195.html">Re: Object not found after successful PUT on S3 API</a></span> <span class="sender italic">Daniel Miller</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Object not found after successful PUT on S3 API">
<input type="hidden" name="msgid" value="5EF1E615-9503-4BA5-AE56-5EB72AAFF8CA@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18193.html">
<input type="submit" value=" Matthew Von-Maszewski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Object+not+found+after+successful+PUT+on+S3+API%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18184.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18195.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5EF1E615-9503-4BA5-AE56-5EB72AAFF8CA@basho.com</li>
</ul>
</div>
</body>
</html>
