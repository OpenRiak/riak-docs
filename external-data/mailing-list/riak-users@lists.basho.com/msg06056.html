<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: php 5.3 protocol buffer client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06056" id="c">
<link rel="index" href="maillist.html#06056" id="i">
<link rel="prev" href="msg06055.html" id="p">
<link rel="next" href="msg06058.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06056.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+php+5.3+protocol+buffer+client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: php 5.3 protocol buffer client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22John+Loehrer%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">John Loehrer</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111223" rel="nofollow">Fri, 23 Dec 2011 08:08:08 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>For the getkeys method i experimented with passing in a callback handler that 
will be passed each key as it is read. I set up a hook in the curl write 
function to be able to grab the data as it streams instead of waiting for the 
entire result set to come over the wire. I will probably port this into the new 
transport library as well.</pre><pre>

<a  rel="nofollow" href="https://github.com/gaiaops/riak-php-client/blob/pool/riak.php#L1032">https://github.com/gaiaops/riak-php-client/blob/pool/riak.php#L1032</a>

We could use this approach for anything that is likely to send huge data 
responses, like map reduce operations or getKeys.

The other interesting thing i did with the http client was allow the http 
request to be attached to a pool object that will issue many requests in 
parallel and do a curl_mult_select on the attached resources to grab back the 
data as it comes over the wire. Using this approach I could queue up and run 
many hundreds of requests in parallel and get far better results than any of 
the clients I've seen so far when many requests need to be made in parallel.

I could probably do the same for the protocol buffer transports as well, since 
writing a socket select pool isn't terribly difficult. Just want to make sure 
there is an actual use-case. One use-case I can see so far is when you need to 
bulk add or delete objects for migration of data.


~ John


----- Original Message -----
From: &quot;Mark Steele&quot; &lt;mste...@beringmedia.com&gt;
To: &quot;John Loehrer&quot; &lt;jloeh...@gaiaonline.com&gt;
Cc: &quot;Joseph Lambert&quot; &lt;joseph.g.lamb...@gmail.com&gt;, &quot;riak-users Users&quot; 
&lt;riak-users@lists.basho.com&gt;
Sent: Friday, December 23, 2011 7:55:56 AM
Subject: Re: php 5.3 protocol buffer client

In case it's helpful: 
<a  rel="nofollow" href="http://www.control-alt-del.org/2011/09/06/building-a-better-riak-client-for-php/">http://www.control-alt-del.org/2011/09/06/building-a-better-riak-client-for-php/</a>
 


Write up a did a while back on how to improve/re-write the php client for PB. 
We're using something very similar to what I wrote up (with a custom C protobuf 
pecl extension) with good results. 


There's probably loads of room for improvement there, I believe we're seeing 
much higher throughput. 


My biggest gripes with the stock client were the lack of streaming support for 
results and the class structure and obviously the HTTP interface (with no 
keepalives!). I highly recommend using something like an iterator to handle 
streaming results sets to not have to buffer everything in RAM. Also one oft 
overlooked performance booster is making sure the client isn't retrieving the 
body on puts if you want to do conflict resolution on reads (returnbody should 
be false!), or don't care about siblings. 


Cheers, 

Mark Steele, CISSP, CSM 
Bering Media Inc. 




On Fri, Dec 23, 2011 at 10:31 AM, John Loehrer &lt; jloeh...@gaiaonline.com &gt; 
wrote: 


I did some xdebug code profiling on the http client and found that parsing http 
headers was consuming 15% of the time. swapping that one part out with the 
pecl-http function if it is available speeds it up to as fast as drslump: 

<a  rel="nofollow" href="http://php.net/manual/en/function.http-parse-headers.php">http://php.net/manual/en/function.http-parse-headers.php</a> 

writes: 254 
reads: 357 

This illustrates how a one line change in the code can make a huge difference. 
I will continue to profile the different transport methods to see what can be 
done. 


~ John 

----- Original Message ----- 
From: &quot;John Loehrer&quot; &lt; jloeh...@gaiaonline.com &gt; 

To: &quot;Joseph Lambert&quot; &lt; joseph.g.lamb...@gmail.com &gt; 
Cc: &quot;riak-users Users&quot; &lt; riak-users@lists.basho.com &gt; 



Sent: Friday, December 23, 2011 6:13:18 AM 
Subject: Re: php 5.3 protocol buffer client 

I tested each transport method against each other. Each writes 10,000 objects 
into riak, then reads those same objects back in serial order. The benchmark 
doesn't really measure riak performance, just useful for comparing the 
difference between each transport method since the backend is the same for all 
the clients. Http is the slowest and the protobuf transport is more than 2x 
faster on reads. 


per sec: w - r 
====================== 
http: 233 - 303 
drslump: 250 - 374 
pb: 310 - 444 
protobuf: 391 - 654 


~ John 


&quot;riak-users Users&quot; &lt; riak-users@lists.basho.com &gt; 
Sent: Thursday, December 22, 2011 9:17:33 PM 
Subject: Re: php 5.3 protocol buffer client 

I have compared drslump vs 2 others, and found the fastest so far is the one 
based off of: 

<a  rel="nofollow" href="https://github.com/bramp/protoc-gen-php">https://github.com/bramp/protoc-gen-php</a> 

By a factor of 2x. So far DrSlump is the slowest of the three. The refactored 
code based off of pb4php comes in at a close second: 

<a  rel="nofollow" href="http://code.google.com/p/pb4php/">http://code.google.com/p/pb4php/</a> 

My refactoring didn't make it any faster or slower, just made the api cleaner 
and more to my liking. Still working on it, and will post both parts as 
standalone components on github once i am done refactoring. 


~ John 

----- Original Message ----- 
From: &quot;Joseph Lambert&quot; &lt; joseph.g.lamb...@gmail.com &gt; 
To: &quot;John Loehrer&quot; &lt; jloeh...@gaiaonline.com &gt; 
Cc: &quot;riak-users Users&quot; &lt; riak-users@lists.basho.com &gt; 
Sent: Thursday, December 22, 2011 5:52:19 PM 
Subject: Re: php 5.3 protocol buffer client 

Nice! 


I had actually done the same thing using DrSlump's protobuf library and found 
that it worked quite well and was about 40% faster than HTTP. 


I'm curious what your results might be performance-wise comparing what you have 
written to DrSlumps (I noticed there is a commit comment about comparing to 
DrSlumps). 

- Joe Lambert 



On Fri, Dec 23, 2011 at 5:39 AM, John Loehrer &lt; jloeh...@gaiaonline.com &gt; 
wrote: 


Sorry if it wasn't clear, all the changes are in the transport branch: 

<a  rel="nofollow" href="https://github.com/gaiaops/riak-php-client/tree/transport">https://github.com/gaiaops/riak-php-client/tree/transport</a> 

It can be merged into master once we are sure it is production ready. 

~ John 



----- Original Message ----- 
From: &quot;John Loehrer&quot; &lt; jloeh...@gaiaonline.com &gt; 
To: &quot;riak-users Users&quot; &lt; riak-users@lists.basho.com &gt; 
Sent: Thursday, December 22, 2011 1:34:36 PM 
Subject: php 5.3 protocol buffer client 

Past few days I have been experimenting with a protocol buffers client for riak 
in php 5.3. 

<a  rel="nofollow" href="https://github.com/gaiaops/riak-php-client">https://github.com/gaiaops/riak-php-client</a> 
<a  rel="nofollow" href="https://github.com/basho/riak-php-client/pull/20">https://github.com/basho/riak-php-client/pull/20</a> 


It is a port of the existing php client and should be backward compatible with 
the existing code. Everything seems to work as expected and passes the unit 
tests. 

Anyone willing to play with it in their test environments to help me find bugs? 
Also, interested in getting help finishing it, as maintaining the code is a lot 
of work. 


~ John 

_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 

_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 


_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 

_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 

_______________________________________________ 
riak-users mailing list 
riak-users@lists.basho.com 
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a> 


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06055.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06056">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06056">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06058.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06040.html">php 5.3 protocol buffer client</a></span> <span class="sender italic">John Loehrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06041.html">Re: php 5.3 protocol buffer client</a></span> <span class="sender italic">John Loehrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06044.html">Re: php 5.3 protocol buffer client</a></span> <span class="sender italic">Joseph Lambert</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06046.html">Re: php 5.3 protocol buffer client</a></span> <span class="sender italic">John Loehrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06052.html">Re: php 5.3 protocol buffer client</a></span> <span class="sender italic">John Loehrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06054.html">Re: php 5.3 protocol buffer client</a></span> <span class="sender italic">John Loehrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06055.html">Re: php 5.3 protocol buffer clien...</a></span> <span class="sender italic">Mark Steele</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: php 5.3 protocol buffer c...</span> <span class="sender italic">John Loehrer</span></li>
<li class="icons-email"><span class="subject"><a href="msg06058.html">Re: php 5.3 protocol buffer c...</a></span> <span class="sender italic">Mark Steele</span></li>
<li class="icons-email"><span class="subject"><a href="msg06061.html">Re: php 5.3 protocol buffer c...</a></span> <span class="sender italic">John Loehrer</span></li>
<li class="icons-email"><span class="subject"><a href="msg06057.html">Re: php 5.3 protocol buffer c...</a></span> <span class="sender italic">John Loehrer</span></li>
<li class="icons-email"><span class="subject"><a href="msg06060.html">Re: php 5.3 protocol buffer c...</a></span> <span class="sender italic">Mark Steele</span></li>
<li class="icons-email"><span class="subject"><a href="msg06062.html">Re: php 5.3 protocol buffer c...</a></span> <span class="sender italic">John Loehrer</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: php 5.3 protocol buffer client">
<input type="hidden" name="msgid" value="5cedefc2-ee0d-4cb3-bcd3-7a0d73b107ec@zms-vm01.sv3.gaiaonline.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06056.html">
<input type="submit" value=" John Loehrer ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+php+5.3+protocol+buffer+client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06055.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06058.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5cedefc2-ee0d-4cb3-bcd3-7a0d73b107ec@zms-vm01.sv3.gaiaonline.com</li>
</ul>
</div>
</body>
</html>
