<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: speeding up riaksearch precommit indexing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03662" id="c">
<link rel="index" href="maillist.html#03662" id="i">
<link rel="prev" href="msg03618.html" id="p">
<link rel="next" href="msg03699.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03662.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+speeding+up+riaksearch+precommit+indexing%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: speeding up riaksearch precommit indexing</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Steve+Webb%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Steve Webb</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110613" rel="nofollow">Mon, 13 Jun 2011 10:46:21 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Ok, I've changed my two VMs to each have:

3 CPUs, 1GB ram, 120GB disk</pre><pre>

</pre><tt>I'm ingesting the twitter spritzer stream (about 10-20 tweets per second, 
</tt><tt>approx 2k of data per tweet).  One bucket is storing the non-indexed 
</tt><tt>tweets in full.  Another bucket is storing the indexed tweet string, id, 
</tt><tt>date and username.  A maximum of 20 clients can be hitting the 'cluster' 
</tt><tt>at any one time.
</tt><pre style="margin: 0em;">

I'm using n_val=2 so there is replication going on behind the scenes.

</pre><tt>I'm using a hardware load-balancer to distribute the work amongst the two 
</tt><tt>nodes and now I'm seeing about 75% CPU usage as opposed to 100% on one 
</tt><tt>node and 50% on the replicating-only node.
</tt><pre style="margin: 0em;">

</pre><tt>I've monitored the VM over the last few days and it seems to be 
</tt><tt>mostly CPU-bound.  The disk I/O is low.  The Network I/O is low.
</tt><pre style="margin: 0em;">

</pre><tt>Q: Can I change the pre-commit to a post-commit trigger or something 
</tt><tt>perhaps or will that make any difference at all?  I'm ok if the tweet 
</tt><tt>stuff doesn't get indexed immediately and there's a slight lag in indexing 
</tt><tt>if it saves on CPU.
</tt><pre style="margin: 0em;">

Here's my search schema (the default, I think):

root@ha2:/var/log/riaksearch# search-cmd show_schema Index
Attempting to restart script through sudo -u riak

%% Schema for 'Index'

{
    schema,
    [
        {version, &quot;1.1&quot;},
        {n_val, 3},
        {default_field, &quot;value&quot;},
</pre><tt>        {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>whitespace_analyzer_factory}}
</tt><pre style="margin: 0em;">
    ],
    [
        %% Field names ending in &quot;_num&quot; are indexed as integers
        {dynamic_field, [
            {name, &quot;*_num&quot;},
            {type, integer},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>integer_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Field names ending in &quot;_int&quot; are indexed as integers
        {dynamic_field, [
            {name, &quot;*_int&quot;},
            {type, integer},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>integer_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Field names ending in &quot;_dt&quot; are indexed as dates
        {dynamic_field, [
            {name, &quot;*_dt&quot;},
            {type, date},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>noop_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Field names ending in &quot;_date&quot; are indexed as dates
        {dynamic_field, [
            {name, &quot;*_date&quot;},
            {type, date},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>noop_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Field names ending in &quot;_txt&quot; are indexed as full text&quot;
        {dynamic_field, [
            {name, &quot;*_txt&quot;},
            {type, string},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>standard_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Field names ending in &quot;_text&quot; are indexed as full text&quot;
        {dynamic_field, [
            {name, &quot;*_text&quot;},
            {type, string},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>standard_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]},

        %% Everything else is a string
        {dynamic_field, [
            {name, &quot;*&quot;},
            {type, string},
</pre><tt>            {analyzer_factory, {erlang, text_analyzers, 
</tt><tt>whitespace_analyzer_factory}}
</tt><pre style="margin: 0em;">
        ]}
    ]
}.

Here's an indexed record:

root@ha1:~# curl -s <a  rel="nofollow" href="http://ha:8098/riak/gnip/80329247314550784">http://ha:8098/riak/gnip/80329247314550784</a> | json_xs
{
   &quot;created_at&quot; : &quot;Mon Jun 13 17:42:39 +0000 2011&quot;,
   &quot;tweet&quot; : &quot;@NielJDBSimpson yeaah&quot;,
   &quot;screen_name&quot; : &quot;SophieBieber69&quot;
}

A non-indexed record:

root@ha1:~# curl -s <a  rel="nofollow" href="http://ha:8098/riak/tweets/80329247314550784">http://ha:8098/riak/tweets/80329247314550784</a>

</pre><tt>&quot;{\&quot;entities\&quot;:{\&quot;urls\&quot;:[],\&quot;hashtags\&quot;:[],\&quot;user_mentions\&quot;:[{\&quot;indices\&quot;:[0,15],\&quot;screen_name\&quot;:\&quot;NielJDBSimpson\&quot;,\&quot;name\&quot;:\&quot;\\u2665Enielle 
</tt><tt>Anne\\u2665 
</tt><tt>\\u25d5\\u203f\\u25d5\&quot;,\&quot;id_str\&quot;:\&quot;197405933\&quot;,\&quot;id\&quot;:197405933}]},\&quot;retweet_count\&quot;:0,\&quot;truncated\&quot;:false,\&quot;text\&quot;:\&quot;@NielJDBSimpson 
</tt><tt>yeaah\&quot;,\&quot;created_at\&quot;:\&quot;Mon Jun 13 17:42:39 +0000 
</tt><tt>2011\&quot;,\&quot;place\&quot;:null,\&quot;in_reply_to_status_id\&quot;:77609368182472704,\&quot;coordinates\&quot;:null,\&quot;source\&quot;:\&quot;web\&quot;,\&quot;geo\&quot;:null,\&quot;favorited\&quot;:false,\&quot;in_reply_to_status_id_str\&quot;:\&quot;77609368182472704\&quot;,\&quot;id_str\&quot;:\&quot;80329247314550784\&quot;,\&quot;in_reply_to_screen_name\&quot;:\&quot;N
</tt><tt>ielJDBSimpson\&quot;,\&quot;in_reply_to_user_id_str\&quot;:\&quot;197405933\&quot;,\&quot;user\&quot;:{\&quot;lang\&quot;:\&quot;en\&quot;,\&quot;created_at\&quot;:\&quot;Wed 
</tt><tt>May 04 17:02:14 +0000 
</tt><tt>2011\&quot;,\&quot;profile_text_color\&quot;:\&quot;3D1957\&quot;,\&quot;profile_image_url\&quot;:\&quot;http:\\\/\\\/a3.twimg.com\\\/profile_images\\\/1372500926\\\/IMG01256-20110418-1827_normal.jpg\&quot;,\&quot;is_translator\&quot;:false,\&quot;statuses_count\&quot;:124,\&quot;profile_sidebar_fill_color\&quot;:\&quot;7AC3EE\&quot;,\&quot;li
</tt><tt>sted_count\&quot;:0,\&quot;following\&quot;:null,\&quot;profile_background_tile\&quot;:true,\&quot;friends_count\&quot;:425,\&quot;description\&quot;:\&quot;I 
</tt><tt>love Justin Bieber i saw him 23\\\/03\\\/2011 in concert best nite ever. 
</tt><tt>Never say Never imma beliber.Follow me I will follow back xx 
</tt><tt>:P\&quot;,\&quot;screen_name\&quot;:\&quot;SophieBieber69\&quot;,\&quot;contributors_enabled\&quot;:false,\&quot;verified\&quot;:false,\&quot;profile_link_color\&quot;:\&quot;FF0000\&quot;,\&quot;url\&quot;:null,\&quot;profile_sidebar_border_color\&quot;:\&quot;65B0DA\&quot;,\&quot;default_profile_image\&quot;:false,\&quot;time_zone\&quot;:null,\&quot;protected\&quot;:false,\&quot;i
</tt><tt>d_str\&quot;:\&quot;293033762\&quot;,\&quot;notifications\&quot;:null,\&quot;profile_use_background_image\&quot;:true,\&quot;favourites_count\&quot;:6,\&quot;location\&quot;:\&quot;Sheffield\&quot;,\&quot;name\&quot;:\&quot;Sophie 
</tt><tt>Bieber 
</tt><tt>\&quot;,\&quot;profile_background_color\&quot;:\&quot;642D8B\&quot;,\&quot;id\&quot;:293033762,\&quot;default_profile\&quot;:false,\&quot;show_all_inline_media\&quot;:false,\&quot;follow_request_sent\&quot;:null,\&quot;geo_enabled\&quot;:false,\&quot;profile_background_image_url\&quot;:\&quot;http:\\\/\\\/a1.twimg.com\\\/images\\\/themes\\\/th
</tt><pre style="margin: 0em;">
eme10\\\/bg.gif\&quot;,\&quot;utc_offset\&quot;:null,\&quot;followers_count\&quot;:184},\&quot;id\&quot;:80329247314550784,\&quot;contributors\&quot;:null,\&quot;retweeted\&quot;:false,\&quot;in_reply_to_user_id\&quot;:197405933}\r&quot;

- Steve Webb

</pre><tt>-- Steve Webb - Senior System Administrator for gnip.com 
</tt><tt><a  rel="nofollow" href="http://twitter.com/GnipWebb">http://twitter.com/GnipWebb</a>
</tt><pre style="margin: 0em;">

On Thu, 9 Jun 2011, Rusty Klophaus wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Steve,

Riak does best with a lot of memory and a fast disk. Depending on how much
data you have in the system, putting two nodes into 1GB of memory on a
single VM may be causing the system to overrun available resources and page
out to disk, and depending on how you've set up your virtualized
environment, you could be paying extra costs with each disk access,
compounding the problem. My first recommendation would be to either run the
test again while monitoring disk operations using iostat to see if disk is
the problem, or to just go ahead and test on bigger hardware. I suspect you
will see much less of a performance difference between the tests once there
are ample resources.

That said, some slowdown is expected when you turn on indexing, as Riak
Search adds quite a bit of overhead in parsing and tokenizing the document,
and then storing the results.

There are two ways to speed up indexing:

  1. Reduce the size of your documents. If your documents are large, but
  you only need one or two fields indexed, you can create smaller &quot;surrogate&quot;
  documents with just the fields you need indexed, plus a link back to your
  original document.
  2. Batch your writes using the Solr interface. Riak Search uses
  &quot;term-based partitioning&quot;. Term-based partitioning reduces complexity during
  queries, at the cost of increased complexity during writes.  You can gain
  back some of the lost performance by batching your writes. This allows the
  system to plan which messages it sends more intelligently, thus sending
  fewer messages and reducing overhead. The downside here is that you can't
  use the Riak KV interface, you need to switch to the Solr interface.

Would you mind describing a bit more about your the size and shape of your
data (how many objects, average object size, object format, throughput,
etc.) and ideally attach your Riak Search schema?

Thanks,
Rusty


On Tue, Jun 7, 2011 at 4:35 PM, Steve Webb &lt;sw...@gnip.com&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hey there.

I'm inserting twitter spritzer tweets into a bucket that doesn't have a
precommit index hook, and a few fields from the tweet into a second bucket
that does have the precommit hook.

Speeds on the inserts into the indexed bucket are an order or magnitude
slower than the non-indexed bucket.

I'm using a 1GB ram, 20GB disk vmware VM, 2-node cluster, ubuntu 10.4,
riaksearch 0.14.0 with n_val = 2.

Is there a way to do a more lazy indexing to where it doesn't slow down
inserts so much?

- Steve

--
Steve Webb - Senior System Administrator for gnip.com
<a  rel="nofollow" href="http://twitter.com/GnipWebb">http://twitter.com/GnipWebb</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03618.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03662">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03662">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03699.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03600.html">speeding up riaksearch precommit indexing</a></span> <span class="sender italic">Steve Webb</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03618.html">Re: speeding up riaksearch precommit indexing</a></span> <span class="sender italic">Rusty Klophaus</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: speeding up riaksearch precommit indexing</span> <span class="sender italic">Steve Webb</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03699.html">Re: speeding up riaksearch precommit indexing</a></span> <span class="sender italic">Rusty Klophaus</span></li>
<li class="icons-email"><span class="subject"><a href="msg03743.html">Re: speeding up riaksearch precommit indexing</a></span> <span class="sender italic">John D. Rowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03745.html">Re: speeding up riaksearch precommit index...</a></span> <span class="sender italic">Les Mikesell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03746.html">Re: speeding up riaksearch precommit ...</a></span> <span class="sender italic">John D. Rowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03767.html">Re: speeding up riaksearch precom...</a></span> <span class="sender italic">Les Mikesell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03768.html">Re: speeding up riaksearch pr...</a></span> <span class="sender italic">Sylvain Niles</span></li>
<li class="icons-email"><span class="subject"><a href="msg03770.html">Re: speeding up riaksearch pr...</a></span> <span class="sender italic">Les Mikesell</span></li>
<li class="icons-email"><span class="subject"><a href="msg03772.html">Re: speeding up riaksearch pr...</a></span> <span class="sender italic">Mathias Meyer</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: speeding up riaksearch precommit indexing">
<input type="hidden" name="msgid" value="alpine.OSX.1.00.1106131125310.54897@steve-webbs-macbook-pro.local">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03662.html">
<input type="submit" value=" Steve Webb ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+speeding+up+riaksearch+precommit+indexing%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03618.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03699.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">alpine.OSX.1.00.1106131125310.54897@steve-webbs-macbook-pro.local</li>
</ul>
</div>
</body>
</html>
