<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Understanding Riaks rebalancing and handoff behaviour</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#01538" id="c">
<link rel="index" href="maillist.html#01538" id="i">
<link rel="prev" href="msg01528.html" id="p">
<link rel="next" href="msg01523.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg01538.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Understanding+Riaks+rebalancing+and+handoff+behaviour%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Understanding Riaks rebalancing and handoff behaviour</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Sven+Riedel%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sven Riedel</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20101115" rel="nofollow">Mon, 15 Nov 2010 00:32:55 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>
On Nov 12, 2010, at 3:57 PM, Nico Meyer wrote:

&gt; Am Freitag, den 12.11.2010, 08:43 +0100 schrieb Sven Riedel:
&gt;&gt;&gt; 
&gt;&gt;&gt; It's not a problem right away. But since the replicated data is not
&gt;&gt;&gt; actively synchronized in the background the keys that were not copied
&gt;&gt;&gt; until the node dies have one less replica. That is until they are read
&gt;&gt;&gt; at least once, at which point read repair does replicate the key again.
&gt;&gt;&gt; So it depends on your setup and requirements, if this is acceptable or
&gt;&gt;&gt; not.
&gt;&gt; 
&gt;&gt; So if the relevant data isn't read in a while and two more nodes go down 
&gt;&gt; (with 
&gt;&gt; an n_val of 3), there is a chance that some data is lost.
&gt;&gt; 
&gt; 
&gt; Correct. This might be highly unlikely though.</pre><pre>

I agree. But still good to know to be fully informed about the risks involved 
when choosing a small n_val with large, write-heavy datasets on few nodes :)

&gt; 
&gt;&gt;&gt; It kind of works anyway, but the vnodes are started and transfered
&gt;&gt;&gt; sequentially. Normally four partitions are transferred in parallel, so I
&gt;&gt;&gt; don't know if this is by design or by accident. The details are
&gt;&gt;&gt; convoluted enough to suspect the latter.
&gt;&gt;&gt; In any case this would also make also have the effect that those
&gt;&gt;&gt; partitions won't show up in the output of riak-admin transfers, since
&gt;&gt;&gt; only running vnodes are considered.
&gt;&gt; 
&gt;&gt; From what I saw in my case the number of handoffs were displayed correctly 
&gt;&gt; in the beginning, however the numbers didn't decrease (or change at all) as 
&gt;&gt; data got handed around.
&gt;&gt; 
&gt; 
&gt; If the node is not restarted, all vnodes are still running, so the
&gt; number would be correct. Most likely no handoffs were being done
&gt; anymore, because four of them crashed and the locks are not cleared in
&gt; this case. By default only four handoffs are allowed at the same time.
&gt; Have you looked in for the error messages I mentioned in your logs?

I just had a look and I see a slightly different exception: 
On riak01 (which had been sending out data, and subsequently shut down):

ERROR: &quot;Handoff receiver for partition ~p exiting abnormally after processing 
~p objects: ~p\n&quot; - [ 0,
{ noproc, 
  {gen_fsm,
   sync_send_all_state_event,
   [&lt;0.24196.2404&gt;,
    {handoff_data, 
    &lt;&lt;...binary...&gt;&gt;
   },
   60000]}}]

Nothing interesting that I can see on the receiving end(s).


&gt; 
&gt; 
&gt;&gt;&gt; I should probably create a bug report for this, with my patch attached.
&gt;&gt;&gt; Stupid laziness!
&gt;&gt;&gt; 
&gt;&gt;&gt; After reading your original post again, I think almost all of the things
&gt;&gt;&gt; you saw can be explained by the bug that I mentioned in my first answer
&gt;&gt;&gt; (the ring status of removed nodes is not synchronized with the remaining
&gt;&gt;&gt; nodes). The problem obviously becomes worse if you remove several nodes
&gt;&gt;&gt; at a time.
&gt;&gt; 
&gt;&gt; Which means that I shouldn't just wait for riak-admin ringready to return 
&gt;&gt; TRUE, but for the data handoffs to have completed as well before changing 
&gt;&gt; the network topology again?
&gt;&gt; 
&gt; 
&gt; Yes. By using e.g. 'df' or listing the directories in your bitcask dir,
&gt; which should be empty if everything went well.
&gt; But with the two bugs that are still present it might never finish.
&gt; The workaround for this is quite involved at the moment.
&gt; I will try to create bug reports in the next few days.
&gt; 

I see, this wasn't clear to me. This was then probably what caused everything 
to get off track. 
I think I'll throw away the test cluster then and start over, this time not 
just waiting for ringready. Maybe this should be mentioned more prominently in 
the documentation alongside the description of riak-admin ringready. Having a 
&quot;settled ring&quot; implied to me that it's ok to proceed with topology changes :)
&gt; 

Regards,
Sven

------------------------------------------
Scoreloop AG, Brecherspitzstrasse 8, 81541 Munich, Germany, www.scoreloop.com
sven.rie...@scoreloop.com

Sitz der Gesellschaft: München, Registergericht: Amtsgericht München, HRB 
174805 
Vorstand: Dr. Marc Gumpinger (Vorsitzender), Dominik Westner, Christian van der 
Leeden, Vorsitzender des Aufsichtsrates: Olaf Jacobi 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg01528.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#01538">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#01538">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg01523.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg01510.html">Understanding Riaks rebalancing and handoff behaviou...</a></span> <span class="sender italic">Sven Riedel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01508.html">Re: Understanding Riaks rebalancing and handoff...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01515.html">Re: Understanding Riaks rebalancing and han...</a></span> <span class="sender italic">Justin Sheehy</span></li>
<li class="icons-email"><span class="subject"><a href="msg01516.html">Re: Understanding Riaks rebalancing and han...</a></span> <span class="sender italic">Sven Riedel</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg01520.html">Re: Understanding Riaks rebalancing and handoff...</a></span> <span class="sender italic">Nico Meyer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01521.html">Re: Understanding Riaks rebalancing and han...</a></span> <span class="sender italic">Sven Riedel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01522.html">Re: Understanding Riaks rebalancing and...</a></span> <span class="sender italic">Nico Meyer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01527.html">Re: Understanding Riaks rebalancing...</a></span> <span class="sender italic">Sven Riedel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01528.html">Re: Understanding Riaks rebala...</a></span> <span class="sender italic">Nico Meyer</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Understanding Riaks re...</span> <span class="sender italic">Sven Riedel</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg01523.html">Re: Understanding Riaks rebalancing and han...</a></span> <span class="sender italic">Scott Lystig Fritchie</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Understanding Riaks rebalancing and handoff behaviour">
<input type="hidden" name="msgid" value="8B9B3C2B-1825-4DD9-9ABC-1ED7C944D6D5@scoreloop.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg01538.html">
<input type="submit" value=" Sven Riedel ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Understanding+Riaks+rebalancing+and+handoff+behaviour%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg01528.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg01523.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">8B9B3C2B-1825-4DD9-9ABC-1ED7C944D6D5@scoreloop.com</li>
</ul>
</div>
</body>
</html>
