<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: I did a bad bad thing....</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09335" id="c">
<link rel="index" href="maillist.html#09335" id="i">
<link rel="prev" href="msg09334.html" id="p">
<link rel="next" href="msg09336.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09335.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+I+did+a+bad+bad+thing....%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: I did a bad bad thing....</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joseph+Blomstedt%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joseph Blomstedt</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121115" rel="nofollow">Thu, 15 Nov 2012 20:14:45 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>&gt; 02:59:35.392 [error] CRASH REPORT Process &lt;0.149.0&gt; with 0 neighbours exited
&gt; with reason: bad argument in call to erlang:binary_to_term(&lt;&lt;&gt;&gt;) in
&gt; riak_core_ring_manager:read_ringfile/1 line 154 in gen_server2:init_it/6
&gt; line 384</pre><pre>

There are several cases where Riak doesn't start cleanly after running
out of disk space. Many of cases are &quot;on the list&quot; to fix. Luckily,
most of these cases don't compromise your data and can be corrected.
Your particular error is a truncated ring file. This is your cluster
metadata that is gossiped between nodes and stored in Riak's data/ring
directory. There should be multiple files in that directory. You
should be able to delete the most recent file and try running &quot;riak
console&quot; again. If that doesn't work, you can always delete the entire
&quot;data/ring&quot; directory and start the node up fresh. It'll have all it's
data, but no longer be a member of your Riak cluster -- no big deal,
just &quot;riak-admin join&quot; back to cluster and everything will be sorted.
Part of the joining process is replacing the local node's ring with
the ring from the cluster it's joining.

As for absolute guarantees, an individual Riak node doesn't strictly
guarantee to be out-of-space proof. Most of the time things are fine,
but there are cases where you end up with corrupted backend files that
cannot be recovered. You can delete the appropriate bad files, and
Riak will start just fine, but some of your data may be missing. Of
course, you have replicas on other nodes, so your missing replicas can
be recovered from theirs siblings.

Replicas are repaired anytime data is read through Riak's read-repair
mechanism. We also have the manual repair feature we introduced in
Riak 1.2:
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/cookbooks/Repairing-KV-Indexes">http://docs.basho.com/riak/latest/cookbooks/Repairing-KV-Indexes</a>

The next major release of Riak will also include
continuous/incremental active anti-entropy that will automatically
repair all divergent/missing replicas without any user intervention at
all.

Obviously, all of these solutions assume you didn't somehow corrupt
the exact same data on all nodes in your clusters. You're right that
the the real world, having a node here or there run out of disk space
is possible. Have multiple nodes run out of disk space at the same
time is much less common, and something that Riak assumes doesn't
happen. This is something that you will naturally aim to avoid
regardless of the crash-recovery scenario. You don't want nodes
running out of disk-space and shutting down. Your service isn't
available when nodes are offline, and Riak is intended to be used for
highly available, always running services. Part of this is proper
capacity planning and monitoring, and making sure to add new nodes to
your Riak cluster (or upgrade existing nodes) in order to grow
capacity as needed.

Hope this answers some of your questions.

Regards,
Joe

On Thu, Nov 15, 2012 at 7:35 PM, Mike Ellis &lt;mike.el...@credorax.com&gt; wrote:
&gt; Hi fellow Riak users – a special shout-out to those I got a chance to meet
&gt; at Ricon 2012.
&gt;
&gt;
&gt;
&gt; I learned some new things, interacted with really smart people, and decided
&gt; to do a Riak project to learn about this tech.
&gt;
&gt;
&gt;
&gt; 5 node cluster, all proud of myself that I got JSON searching etc. working
&gt; (some speed/other things to clean up), haproxy, but overall, things are
&gt; looking pretty good.
&gt;
&gt;
&gt;
&gt; I’m pumping in loads of JSON data into these KV pairs, and things are
&gt; looking good…
&gt;
&gt; UNTIL….
&gt;
&gt; I let the nodes run out of disk-space… OUCH rookie mistake.
&gt;
&gt;
&gt;
&gt; But I’m thinking – this shouldn’t (but can) happen in real life, lets see
&gt; how well Riak recovers from such a thing. Learning opportunity!
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt;
&gt;
&gt; The boxes were wedged HARD – no login possible, so they had to be rebooted.
&gt;
&gt; Riak wasn’t running after reboot (just the epm daemon), rest couldn’t start
&gt; since disk was still 100% full.
&gt;
&gt;
&gt;
&gt; I brought some new filesystems online, (properly) copied the content of
&gt; leveldb, and pointed the config-files to the new location of leveldb,
&gt; cleaned some disk-space. Did this on all 5 nodes.
&gt;
&gt;
&gt;
&gt; On 3 out of 5 nodes, things came back to life… Not bad. But on 2 nodes,
&gt; there is no joy.  (riak console error below).
&gt;
&gt;
&gt;
&gt; I found some utilities that check the merge_index for consistency, and that
&gt; didn’t point to any issues.
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt;
&gt;
&gt; So since 3/5 nodes are up, I THINK all my data is safe. Is there some sort
&gt; of scrubbing operation I can run to basically fsck the bajezus out of this
&gt; thing to ensure the data is correct/consistent/fully available across these
&gt; 3 surviving nodes? Its taking writes again, so it appears (on the surface)
&gt; to be in reasonable shape, eventhough 2/5 nodes are MIA.
&gt;
&gt;
&gt;
&gt; I guess I would have been up the creek if 2/5 came back to life, not 3/5?
&gt;
&gt; Is there any value (or possibility) to bring one of the failed nodes back to
&gt; life, or just nuke the data and re-join?
&gt;
&gt; This sort of thing is bound to happen in real life to some unsuspecting
&gt; person out there. Is this a bug?
&gt;
&gt; Should Riak have handled an out of space condition a bit cleaner? (if not
&gt; from crashing from a recovery perspective?) I would have expected some sort
&gt; of atomic recovery point.
&gt;
&gt;
&gt;
&gt; Any general thoughts/guidance/education (other than “never let your riak
&gt; cluster run out of disk-space”) are much appreciated.
&gt;
&gt;
&gt;
&gt; Thanks,
&gt;
&gt;
&gt;
&gt; n  MikeE
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; -bash-4.1$ riak console
&gt;
&gt; Exec: /usr/lib64/riak/erts-5.9.1/bin/erlexec -boot
&gt; /usr/lib64/riak/releases/1.2.0/riak             -embedded -config
&gt; /etc/riak/app.config             -pa /usr/lib64/riak/basho-patches
&gt; -args_file /etc/riak/vm.args -- console
&gt;
&gt; Root: /usr/lib64/riak
&gt;
&gt; Erlang R15B01 (erts-5.9.1) [source] [64-bit] [async-threads:64]
&gt; [kernel-poll:true]
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; =INFO REPORT==== 16-Nov-2012::02:59:34 ===
&gt;
&gt;     alarm_handler: {set,{system_memory_high_watermark,[]}}
&gt;
&gt; ** /usr/lib64/riak/lib/observer-1.1/ebin/etop_txt.beam hides
&gt; /usr/lib64/riak/lib/basho-patches/etop_txt.beam
&gt;
&gt; ** Found 1 name clashes in code paths
&gt;
&gt; 02:59:35.273 [info] Application lager started on node 'riak@xxxxxxxxxxx'
&gt;
&gt; 02:59:35.392 [error] CRASH REPORT Process &lt;0.149.0&gt; with 0 neighbours exited
&gt; with reason: bad argument in call to erlang:binary_to_term(&lt;&lt;&gt;&gt;) in
&gt; riak_core_ring_manager:read_ringfile/1 line 154 in gen_server2:init_it/6
&gt; line 384
&gt;
&gt; /usr/lib64/riak/lib/os_mon-2.2.9/priv/bin/memsup: Erlang has closed.
&gt;
&gt;
&gt;
&gt; =INFO REPORT==== 16-Nov-2012::02:59:35 ===
&gt;
&gt;     alarm_handler: {clear,system_memory_high_watermark}
&gt;
&gt; Erlang has closed
&gt;
&gt;                  {&quot;Kernel pid
&gt; terminated&quot;,application_controller,&quot;{application_start_failure,riak_core,{shutdown,{riak_core_app,start,[normal,[]]}}}&quot;}
&gt;
&gt;
&gt;
&gt; Crash dump was written to: /var/log/riak/erl_crash.dump
&gt;
&gt; Kernel pid terminated (application_controller)
&gt; ({application_start_failure,riak_core,{shutdown,{riak_core_app,start,[normal,[]]}}})
&gt;
&gt; -bash-4.1$
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;



-- 
Joseph Blomstedt &lt;j...@basho.com&gt;
Senior Software Engineer
Basho Technologies, Inc.
<a  rel="nofollow" href="http://www.basho.com/">http://www.basho.com/</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09334.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09335">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09335">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09336.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09334.html">RE: I did a bad bad thing....</a></span> <span class="sender italic">Mike Ellis</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: I did a bad bad thing....</span> <span class="sender italic">Joseph Blomstedt</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: I did a bad bad thing....">
<input type="hidden" name="msgid" value="CANvk2KTVemu=9pHMiTTX3ktpP6VwjAj00wz5c+nnnRrvHEuUkg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09335.html">
<input type="submit" value=" Joseph Blomstedt ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+I+did+a+bad+bad+thing....%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09334.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09336.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CANvk2KTVemu=9pHMiTTX3ktpP6VwjAj00wz5c+nnnRrvHEuUkg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
