<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Multiple disks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#02729" id="c">
<link rel="index" href="maillist.html#02729" id="i">
<link rel="prev" href="msg02727.html" id="p">
<link rel="next" href="msg02751.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg02729.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Multiple disks</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Joseph+Blomstedt%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joseph Blomstedt</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110323" rel="nofollow">Wed, 23 Mar 2011 17:59:05 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Sorry, I don't have a lot of time right now. I'll try to write a more
detailed response later.</pre><pre>

&gt;&gt;&gt; With a few hours of investigation today, your patch is looking
&gt;&gt;&gt; promising. Maybe you can give some more detail on what you did in your
&gt;&gt;&gt; experiments a few months ago?

I'll try to write something up when I have the time. I need to find my
notes. In general, the focus was mostly on performance tuning,
although I did look into error/recovery a bit as well. My main goal at
the time was trying to reduce disk seeks as much as possible. Bitcask
is awesome as it is an append only store, but if you have multiple
bitcasks being written to on the same disk you still end up with disk
seeking depending on how the underlying file system works. I was
trying to mitigate this as much as possible, given a project that used
bitcask in a predominately write-only mode (basically as a transaction
log that was only written to; read only in failure conditions). BTW,
concerning RAID, I recall seeing better performance spreading vnode
bitcasks across several smaller RAID arrays than using a single larger
RAID array during write-heavy bursts.

&gt;&gt;&gt; Oh, one thing I noticed is that while Riak starts up, if there's a bad
&gt;&gt;&gt; disk then it will shutdown (the whole node), at this line:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; <a  rel="nofollow" href="https://github.com/jtuple/riak_kv/blob/jdb-multi-dirs/src/riak_kv_bitcask_backend.erl#L103">https://github.com/jtuple/riak_kv/blob/jdb-multi-dirs/src/riak_kv_bitcask_backend.erl#L103</a>
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; That makes sense, but I'm wondering if it's possible to let the node
&gt;&gt;&gt; start since some of its vnodes would be able to open their bitcasks just
&gt;&gt;&gt; fine. I wonder if it's as simple as removing that line?
&gt;&gt;&gt;

You don't want to remove that line, riak expects the vnode to come
online or kill the entire node. You would need to have a vnode failure
trigger an ownership change if you really wanted things to behave
properly.

The better case is to not have the vnode fail if there are other
existing disks. That's an easy change that I'll throw together when I
have time. Basically, when a vnode starts, have it pick a bitcask
directory, if that directory fails, then have it pick a different
directory. If all configured directories fail, then call riak:stop.
Thus, if a disk fails and a vnode restarts, it should create a new
empty bitcask on a working disk. Then read repair will slowly rewrite
your data depending on data access (handoff won't occur though, unless
that's added in patch).

&gt; After reading todays recap, I am a bit unsure:
&gt;
&gt;&gt; 5) Q --- Would Riak handle an individual vnode failure the same way as
&gt;&gt; an entire node failure? (from grourk via #riak)
&gt;&gt;
&gt;&gt;    A --- Yes. The request to that vnode would fail and will be routed
&gt;&gt; to the next available vnode
&gt;
&gt; Is it really handled the same way? I don't believe handoff will occur. The
&gt; R/W values still apply of course, but I think there will be one less replica
&gt; of the keys that map to the failed vnode until the situation.
&gt; I have delved quite a bit into the riak code, but if I really missed
&gt; something I would be glad if someone could point me to the place where a
&gt; vnode failure is detected. As far as I can see, the heavy lifting happens in
&gt; riak_kv_util:try_cast/5 (
&gt; <a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/riak_kv-0.14.1/src/riak_kv_util.erl#L78">https://github.com/basho/riak_kv/blob/riak_kv-0.14.1/src/riak_kv_util.erl#L78</a>),
&gt; which only checks if the whole node is up.

I don't think handoff occurs either. Maybe folks at Basho can look
into this further, or someone can test it. I'll test it
tonight/tomorrow if I have the time. It looks like the cast will
occur, but never return. So, your overall write may fail depending on
your W-val. Is there something we're both missing here?

-Joe

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg02727.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#02729">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#02729">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg02751.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg02699.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02702.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02704.html">Re: Multiple disks</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02705.html">Re: Multiple disks</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02706.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02708.html">Re: Multiple disks</a></span> <span class="sender italic">Les Mikesell</span></li>
<li class="icons-email"><span class="subject"><a href="msg02709.html">Re: Multiple disks</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02723.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li class="icons-email"><span class="subject"><a href="msg02726.html">Re: Multiple disks</a></span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg02727.html">Re: Multiple disks</a></span> <span class="sender italic">Nico Meyer</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Multiple disks</span> <span class="sender italic">Joseph Blomstedt</span></li>
<li class="icons-email"><span class="subject"><a href="msg02751.html">Re: Multiple disks</a></span> <span class="sender italic">Dan Reverri</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg02707.html">Re: Multiple disks</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg02710.html">Re: Multiple disks</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Multiple disks">
<input type="hidden" name="msgid" value="AANLkTik32-FqsfUxF+tWQF2SkRUrdH3beBDBCU9y+cf0@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg02729.html">
<input type="submit" value=" Joseph Blomstedt ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Multiple+disks%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg02727.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg02751.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTik32-FqsfUxF+tWQF2SkRUrdH3beBDBCU9y+cf0@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
