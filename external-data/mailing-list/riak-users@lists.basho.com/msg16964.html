<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak-S2 javascript aws-sdk failing on multi-part uploads</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16964" id="c">
<link rel="index" href="maillist.html#16964" id="i">
<link rel="prev" href="msg16956.html" id="p">
<link rel="next" href="msg16965.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16964.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C-S2+javascript+aws%5C-sdk+failing+on+multi%5C-part+uploads%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak-S2 javascript aws-sdk failing on multi-part uploads</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shunichi+Shinohara%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shunichi Shinohara</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160114" rel="nofollow">Thu, 14 Jan 2016 06:33:27 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi John,

I tested Multipart Upload with aws-sdk-js with the patch you
mentioned, against riak_cs (s2),
upload finished without errors up to 1GB object. The environment is
all local on my laptop,
so latency is small. The script I used is in [1].</pre><pre>

As Luke mentioned, HAProxy would be the point to be investigated first.
Or, if it's possible to get packet capture, by finding some wrong TCP
packet, like
RST or premature (from the point of HTTP) FIN, one can identify who
closes TCP connection
actively. In this case, packet should be captured on client box,
HAProxy box and riak cs box.

[1] <a  rel="nofollow" href="https://gist.github.com/shino/ac7d56398557fb936899">https://gist.github.com/shino/ac7d56398557fb936899</a>

Thanks,
Shino


2016-01-14 8:51 GMT+09:00 Luke Bakken &lt;lbak...@basho.com&gt;:
&gt; Hi John,
&gt;
&gt; Thanks for the info. I'm very curious to see what's in the haproxy
&gt; logs with regard to TCP.
&gt; --
&gt; Luke Bakken
&gt; Engineer
&gt; lbak...@basho.com
&gt;
&gt;
&gt; On Wed, Jan 13, 2016 at 3:50 PM, John Fanjoy &lt;jfan...@inetu.net&gt; wrote:
&gt;&gt; Luke,
&gt;&gt;
&gt;&gt; As a test I’ve already increased all timeouts to 5 minutes but the failure 
&gt;&gt; occurs within under 1 minute so it doesn’t appear to be timeout related. I 
&gt;&gt; change the logs to tcplog tomorrow and let you know if I find anything.
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt;
&gt;&gt; John Fanjoy
&gt;&gt; Systems Engineer
&gt;&gt; jfan...@inetu.net
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On 1/13/16, 6:05 PM, &quot;Luke Bakken&quot; &lt;lbak...@basho.com&gt; wrote:
&gt;&gt;
&gt;&gt;&gt;haproxy ships with some &quot;short&quot; default timeouts. If CyberDuck is able
&gt;&gt;&gt;to upload these files faster than aws-sdk, it may be doing so within
&gt;&gt;&gt;the default haproxy timeouts.
&gt;&gt;&gt;
&gt;&gt;&gt;You can also look at haproxy's log to see if you find any TCP
&gt;&gt;&gt;connections that it has closed.
&gt;&gt;&gt;--
&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;Engineer
&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;On Wed, Jan 13, 2016 at 3:02 PM, John Fanjoy &lt;jfan...@inetu.net&gt; wrote:
&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I may be able to do that. The only problem is without haproxy I have no 
&gt;&gt;&gt;&gt; way to inject CORS headers which the browser requires, but I may be able 
&gt;&gt;&gt;&gt; to write up small nodejs app to get past that and see if it is somehow 
&gt;&gt;&gt;&gt; related to haproxy. The fact that these errors are not present when using 
&gt;&gt;&gt;&gt; Cyberduck which is also talking to haproxy leads me to believe that’s not 
&gt;&gt;&gt;&gt; the cause, but it’s definitely worth testing.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On 1/13/16, 5:55 PM, &quot;Luke Bakken&quot; &lt;lbak...@basho.com&gt; wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;John -
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;The following error indicates that the connection was unexpectedly
&gt;&gt;&gt;&gt;&gt;closed by something outside of Riak while the chunk is uploading:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;{badmatch,{error,closed}}
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;Is it possible to remove haproxy to test using the the aws-sdk?
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;That is my first thought as to the cause of this issue, especially
&gt;&gt;&gt;&gt;&gt;since writing to S3 works with the same code.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;--
&gt;&gt;&gt;&gt;&gt;Luke Bakken
&gt;&gt;&gt;&gt;&gt;Engineer
&gt;&gt;&gt;&gt;&gt;lbak...@basho.com
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;On Wed, Jan 13, 2016 at 2:46 PM, John Fanjoy &lt;jfan...@inetu.net&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Luke,
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; Yes on both parts. To confirm cyberduck was using multi-part I actually 
&gt;&gt;&gt;&gt;&gt;&gt; tailed the console.log while it was uploading the file, and it uploaded 
&gt;&gt;&gt;&gt;&gt;&gt; the file in approx. 40 parts. Afterwards the parts were reassembled as 
&gt;&gt;&gt;&gt;&gt;&gt; you would expect. The AWS-SDK for javascript has an object called 
&gt;&gt;&gt;&gt;&gt;&gt; ManagedUpload which automatically switches to multi-part when the input 
&gt;&gt;&gt;&gt;&gt;&gt; is larger than the maxpartsize (default 5mb). I have confirmed that it 
&gt;&gt;&gt;&gt;&gt;&gt; is splitting the files up, but so far I’ve only ever seen one part get 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded before the others failed at which point it removes 
&gt;&gt;&gt;&gt;&gt;&gt; the upload (DELETE call) automatically. I also verified that the 
&gt;&gt;&gt;&gt;&gt;&gt; javascript I have in place does work with an actual AWS S3 bucket to 
&gt;&gt;&gt;&gt;&gt;&gt; rule out coding issues on my end and the same &gt;400mb file was 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded to the bucket I created there without issue.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; A few things worth mentioning that I missed before. I am running riak-s2 
&gt;&gt;&gt;&gt;&gt;&gt; behind haproxy. Haproxy is handling ssl and enabling CORS for browser 
&gt;&gt;&gt;&gt;&gt;&gt; based requests. I have tested smaller files (~4-5mb) and GET requests 
&gt;&gt;&gt;&gt;&gt;&gt; using the browser client and everything works with my current haproxy 
&gt;&gt;&gt;&gt;&gt;&gt; configuration, but the larger files are failing, usually after 1 part is 
&gt;&gt;&gt;&gt;&gt;&gt; successfully uploaded. I can also list bucket contents and delete 
&gt;&gt;&gt;&gt;&gt;&gt; existing contents. The only feature that is not working appears to be 
&gt;&gt;&gt;&gt;&gt;&gt; the multi-part uploads. We are running centOS 7 (kernel version 
&gt;&gt;&gt;&gt;&gt;&gt; 3.10.0-327.4.4.el7.x86_64). Please let me know if you have any further 
&gt;&gt;&gt;&gt;&gt;&gt; questions.
&gt;&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; John Fanjoy
&gt;&gt;&gt;&gt;&gt;&gt; Systems Engineer
&gt;&gt;&gt;&gt;&gt;&gt; jfan...@inetu.net
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16956.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16964">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16964">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16965.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16948.html">Riak-S2 javascript aws-sdk failing on multi-part upload...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16949.html">Re: Riak-S2 javascript aws-sdk failing on multi-pa...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16950.html">Re: Riak-S2 javascript aws-sdk failing on multi-pa...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16951.html">Re: Riak-S2 javascript aws-sdk failing on mult...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16952.html">Re: Riak-S2 javascript aws-sdk failing on ...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16953.html">Re: Riak-S2 javascript aws-sdk failing...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16954.html">Re: Riak-S2 javascript aws-sdk fa...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16955.html">Re: Riak-S2 javascript aws-sd...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16956.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak-S2 javascript aw...</span> <span class="sender italic">Shunichi Shinohara</span></li>
<li class="icons-email"><span class="subject"><a href="msg16965.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16968.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
<li class="icons-email"><span class="subject"><a href="msg16972.html">Re: Riak-S2 javascript aw...</a></span> <span class="sender italic">John Fanjoy</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak-S2 javascript aws-sdk failing on multi-part uploads">
<input type="hidden" name="msgid" value="CAMe3p=TytgWVAQxfrk0rN=2k0caKCNygO+UHoZ3vGkHsgXd1dg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16964.html">
<input type="submit" value=" Shunichi Shinohara ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak%5C-S2+javascript+aws%5C-sdk+failing+on+multi%5C-part+uploads%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16956.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16965.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAMe3p=TytgWVAQxfrk0rN=2k0caKCNygO+UHoZ3vGkHsgXd1dg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
