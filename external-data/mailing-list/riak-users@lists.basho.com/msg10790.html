<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Post commit hooks are a single process, so they are executed	in the same order as the commits ?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10790" id="c">
<link rel="index" href="maillist.html#10790" id="i">
<link rel="prev" href="msg10789.html" id="p">
<link rel="next" href="msg10780.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10790.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Post+commit+hooks+are+a+single+process%2C+so+they+are+executed%09in+the+same+order+as+the+commits+%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Post commit hooks are a single process, so they are executed	in the same order as the commits ?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Guido+Medina%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Guido Medina</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130409" rel="nofollow">Tue, 09 Apr 2013 04:02:21 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Simon,

</pre><tt>  We use a similar approach, using 2i and batch numbers (every 
</tt><tt>bucket/key we are interested is stamped with a 2i batch number which 
</tt><tt>increases once a minute), a Java client that copies to two different 
</tt><tt>clusters once a minute also, from &quot;last batch number copied&quot; to &quot;current 
</tt><tt>batch number - 1&quot;, so it is always a minute behind, like I said it uses 
</tt><tt>2i (current batch number is read only for target clusters and read-write 
</tt><tt>on the target clusters), and it also copies keys concurrently.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>Though we have Riak EE, we felt the same about having a fine grained 
</tt><tt>cluster copy tool.
</tt><pre style="margin: 0em;">

</pre><tt>With that tool in place we don't need post-commits nor sync-ed operation 
</tt><tt>on the &quot;master cluster&quot;, we don't actually call it master cluster, we 
</tt><tt>merely use the tool to have backups. There is tracking key that holds 
</tt><tt>the batch number value and a list of buckets to operate.
</tt><pre style="margin: 0em;">

Hope that helps,

Guido.

On 09/04/13 11:36, Simon Majou wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Ryan,

</pre><tt>Yes I know about Riak Enterprise, but I am thinking about a more 
</tt><tt>&quot;fine-grained&quot; multi-cluster, by setting a X-Meta-primary-cluster 
</tt><tt>property on each value.
</tt><pre style="margin: 0em;">

</pre><tt>In that scenario, the object would be written always on the primary 
</tt><tt>cluster, and read on both clusters.
</tt><tt>In case of failure all the writes would be done on the active cluster, 
</tt><tt>with the primary-cluster updated to the new primary.
</tt><pre style="margin: 0em;">

</pre><tt>From your explanation on the post commit hook I understand that I will 
</tt><tt>need a message queue between the cluster, in order to free the hook as 
</tt><tt>fast as possible, and to not lose any updates in case of crash of one 
</tt><tt>cluster.
</tt><pre style="margin: 0em;">


Simon


</pre><tt>On Tue, Apr 9, 2013 at 3:55 AM, Ryan Zezeski &lt;rzeze...@basho.com 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:rzeze...@basho.com">mailto:rzeze...@basho.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

    Simon,


    On Mon, Apr 8, 2013 at 7:14 PM, Simon Majou &lt;si...@majou.org
    &lt;<a  rel="nofollow" href="mailto:si...@majou.org">mailto:si...@majou.org</a>&gt;&gt; wrote:

        Hello,

        I want to sync a bucket of a first cluster with the bucket of
        a second cluster. To do that I think using the post commit hook.


    If you didn't know, this is exactly what Riak Enterprise was built
    to do.  I.e. handle multi-cluster replication.  However, if you
    want to give it a go on your own a post-commit hook is one way to
    get the job done.  You'll want to think through failure scenarios
    where the receiving cluster is down and how to deal with msgs that
    are dropped between clusters.  The post-commit hook runs on a
    process called the &quot;coordinator&quot;, there is a coordinator for every
    incoming request.  So you won't block the vnodes, which is
    important, but the client/user request will block until your
    post-commit returns.


        Is there any risk that the sequence of PUTs to be mixed in
        such a scenario ?


    Do you mean the sequence seen on cluster A vs. cluster B?  Are you
    asking if the object could appear to be on B before A even though
    the PUT was sent to A?  The answer is, it depends.  With a healthy
    system it's probably unlikely but it will depend on your DW values
    and state of each cluster.  E.g. if cluster A nodes get slow disk
    I/O then perhaps the replication to cluster B could beat writes on
    A.  If we start introducing node and network failures, or changing
    W/DW values then things can get more complicated.  You could have
    success on cluster A, fire replica to cluster B, all primary nodes
    for that object on cluster A die, now cluster B will have a key
    for which cluster A says not_found (well, not totally true,
    depends on your PR value).

    -Z





_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10789.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10790">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10790">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10780.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10773.html">Post commit hooks are a single process, so they are executed ...</a></span> <span class="sender italic">Simon Majou</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10785.html">Re: Post commit hooks are a single process, so they are ...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10789.html">Re: Post commit hooks are a single process, so they ...</a></span> <span class="sender italic">Simon Majou</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Post commit hooks are a single process, so t...</span> <span class="sender italic">Guido Medina</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Post commit hooks are a single process, so they are executed	in the same order as the commits ?">
<input type="hidden" name="msgid" value="5163F4F6.1030105@temetra.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10790.html">
<input type="submit" value=" Guido Medina ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Post+commit+hooks+are+a+single+process%2C+so+they+are+executed%09in+the+same+order+as+the+commits+%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10789.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10780.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5163F4F6.1030105@temetra.com</li>
</ul>
</div>
</body>
</html>
