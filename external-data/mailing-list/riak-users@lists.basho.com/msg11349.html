<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak database fails after a short period</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd15.html#11349" id="c">
<link rel="index" href="mail15.html#11349" id="i">
<link rel="prev" href="msg11344.html" id="p">
<link rel="next" href="msg11419.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11349.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+database+fails+after+a+short+period%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak database fails after a short period</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kirill+K.%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kirill K.</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130627" rel="nofollow">Thu, 27 Jun 2013 09:38:26 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

I created a simple erlang application which periodically collects required
data and puts it in a riak database.</pre><pre>

As I start my application it runs smoothly.. but after a period of time it
stucks as PUT requests to riak database becomes too slow.. It is logs from
my app:

2013-06-26 12:44:09.090 [info] &lt;0.60.0&gt; data processed in [16476 ms]
2013-06-26 12:45:51.472 [info] &lt;0.60.0&gt; data processed in [18793 ms]
...
2013-06-26 12:57:28.138 [info] &lt;0.60.0&gt; data processed in [15135 ms]
2013-06-26 13:07:01.484 [info] &lt;0.60.0&gt; data processed in [488420 ms]
2013-06-26 14:03:11.561 [info] &lt;0.60.0&gt; data processed in [3370075 ms]

In riak crash logs I can see a lot of messages like

2013-06-26 17:06:20 =CRASH REPORT====
crasher:
initial call: riak_kv_index_hashtree:init/1
pid: &lt;0.13660.7&gt;
registered_name: []
exception exit: {{{badmatch,{error,{db_open,&quot;IO error: ./data/anti_entropy/
    433883298582611803841718934712646521460354973696/MANIFEST-000004:
    Cannot allocate memory&quot;}}}, [{hashtree,new_segment_store,2,
    [{file,&quot;src/hashtree.erl&quot;},{line,499}]},
    {hashtree,new,2,[{file,&quot;src/hashtree.erl&quot;},{line,215}]},
    {riak_kv_index_hashtree,do_new_tree,2,
    [{file,&quot;src/riak_kv_index_hashtree.erl&quot;},
    {line,426}]},{lists,foldl,3,[{file,&quot;lists.erl&quot;},
    {line,1197}]},{riak_kv_index_hashtree,
    init_trees,2,[{file,&quot;src/riak_kv_index_hashtree.erl&quot;},
    {line,368}]},{riak_kv_index_hashtree,init,1,
    [{file,&quot;src/riak_kv_index_hashtree.erl&quot;},
    {line,225}]},{gen_server,init_it,6,[{file,&quot;gen_server.erl&quot;},{line,304}]},
    {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]},
    [{gen_server,init_it,6,[{file,&quot;gen_server.erl&quot;},{line,328}]},
    {proc_lib,init_p_do_apply,3,[{file,&quot;proc_lib.erl&quot;},{line,227}]}]}
ancestors: [&lt;0.955.0&gt;,riak_core_vnode_sup,riak_core_sup,&lt;0.129.0&gt;]
messages: []
links: []
dictionary: []
trap_exit: false
status: running
heap_size: 1597
stack_size: 24
reductions: 593
neighbours:

I can see the same behavior on Amazon AWS and local virtual machine. my
VM's are quite small 512-1024 mb.. AWS is Micro, so it has the same amount
of memory.

There are no cluster currently. Just single node with riak and my app
running on it.

I've checked riak documentation and basic things they recommend to do is to
increase ulimit and to update sysctl. So, my server ulimit shows: ulimit -n
65536 AND sysctl updated as recommended.

I've tried bitcask and eleveldb, but result is the same.

Currently, I can't figure out what is broken and why riak Cannot allocate
memory..

Thanks.


Kirill
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11344.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd15.html#11349">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail15.html#11349">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11419.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak database fails after a short period</span> <span class="sender italic">Kirill K.</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11419.html">Re: Riak database fails after a short period</a></span> <span class="sender italic">Mark Phillips</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak database fails after a short period">
<input type="hidden" name="msgid" value="CA+V3zvtVZoX4AeQHAv+O9RSQts19mE5XDL40nN8Ngeqy3Kw5tg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11349.html">
<input type="submit" value=" Kirill K. ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak+database+fails+after+a+short+period%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11344.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11419.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CA+V3zvtVZoX4AeQHAv+O9RSQts19mE5XDL40nN8Ngeqy3Kw5tg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
