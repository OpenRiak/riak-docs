<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Ensembles failing to reach "Leader ready" state</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16032" id="c">
<link rel="index" href="maillist.html#16032" id="i">
<link rel="prev" href="msg15913.html" id="p">
<link rel="next" href="msg16039.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16032.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Ensembles+failing+to+reach+%5C%22Leader+ready%5C%22+state%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Ensembles failing to reach "Leader ready" state</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Andrew+Stone%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Andrew Stone</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150417" rel="nofollow">Fri, 17 Apr 2015 13:23:08 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Jonathan,

Sorry for the late reply. It looks like riak_ensemble still thinks that
those old nodes are part of the cluster. Did you remove them with
'riak-admin cluster leave' ? If so they should have been removed from the
root ensemble also, and the machines shouldn't have actually left the
cluster until all the ensembles were reconfigured via joint consensus. Can
you paste the results from the following commands:</pre><pre>

riak-admin member-status
riak-admin ring-status

Thanks,
Andrew


On Mon, Mar 23, 2015 at 11:25 AM, Jonathan Koff &lt;jonat...@projexity.com&gt;
wrote:

&gt; Hi all,
&gt;
&gt; I recently used Riak’s Strong Consistency functionality to get
&gt; auto-incrementing IDs for a feature of an application I’m working on, and
&gt; although this worked great in dev (5 nodes in 1 VM) and staging (3 servers
&gt; across NA) environments, I’ve run into some odd behaviour in production
&gt; (originally 3 servers, now 4) that prevents it from working.
&gt;
&gt; I initially noticed that consistent requests were immediately failing as
&gt; timeouts, and upon checking `riak-admin ensemble-status` saw that many
&gt; ensembles were at 0 / 3, from the vantage point of the box I was SSH’d
&gt; into. Interestingly, SSH-ing into different boxes showed different results.
&gt; Here’s a brief snippet of what I see now, after adding a fourth server in a
&gt; troubleshooting attempt:
&gt;
&gt; *Machine 1* (104.131.39.61)
&gt;
&gt; ============================== Consensus System
&gt; ===============================
&gt; Enabled:     true
&gt; Active:      true
&gt; Ring Ready:  true
&gt; Validation:  strong (trusted majority required)
&gt; Metadata:    best-effort replication (asynchronous)
&gt;
&gt; ================================== Ensembles
&gt; ==================================
&gt;  Ensemble     Quorum        Nodes      Leader
&gt;
&gt; -------------------------------------------------------------------------------
&gt;    root       0 / 6         3 / 6      --
&gt;     2         0 / 3         3 / 3      --
&gt;     3         3 / 3         3 / 3      riak@104.131.130.237
&gt;     4         3 / 3         3 / 3      riak@104.131.130.237
&gt;     5         3 / 3         3 / 3      riak@104.131.130.237
&gt;     6         0 / 3         3 / 3      --
&gt;     7         0 / 3         3 / 3      --
&gt;     8         0 / 3         3 / 3      --
&gt;     9         3 / 3         3 / 3      riak@104.131.130.237
&gt;     10        3 / 3         3 / 3      riak@104.131.130.237
&gt;     11        0 / 3         3 / 3      --
&gt;
&gt; *Machine 2* (104.236.79.78)
&gt;
&gt; ============================== Consensus System
&gt; ===============================
&gt; Enabled:     true
&gt; Active:      true
&gt; Ring Ready:  true
&gt; Validation:  strong (trusted majority required)
&gt; Metadata:    best-effort replication (asynchronous)
&gt;
&gt; ================================== Ensembles
&gt; ==================================
&gt;  Ensemble     Quorum        Nodes      Leader
&gt;
&gt; -------------------------------------------------------------------------------
&gt;    root       0 / 6         3 / 6      --
&gt;     2         3 / 3         3 / 3      riak@104.236.79.78
&gt;     3         3 / 3         3 / 3      riak@104.131.130.237
&gt;     4         3 / 3         3 / 3      riak@104.131.130.237
&gt;     5         3 / 3         3 / 3      riak@104.131.130.237
&gt;     6         3 / 3         3 / 3      riak@104.236.79.78
&gt;     7         0 / 3         3 / 3      --
&gt;     8         0 / 3         3 / 3      --
&gt;     9         3 / 3         3 / 3      riak@104.131.130.237
&gt;     10        3 / 3         3 / 3      riak@104.131.130.237
&gt;     11        3 / 3         3 / 3      riak@104.236.79.78
&gt;
&gt; *Machine 3* (104.131.130.237)
&gt;
&gt; ============================== Consensus System
&gt; ===============================
&gt; Enabled:     true
&gt; Active:      true
&gt; Ring Ready:  true
&gt; Validation:  strong (trusted majority required)
&gt; Metadata:    best-effort replication (asynchronous)
&gt;
&gt; ================================== Ensembles
&gt; ==================================
&gt;  Ensemble     Quorum        Nodes      Leader
&gt;
&gt; -------------------------------------------------------------------------------
&gt;    root       0 / 6         3 / 6      --
&gt;     2         0 / 3         3 / 3      --
&gt;     3         3 / 3         3 / 3      riak@104.131.130.237
&gt;     4         3 / 3         3 / 3      riak@104.131.130.237
&gt;     5         3 / 3         3 / 3      riak@104.131.130.237
&gt;     6         0 / 3         3 / 3      --
&gt;     7         0 / 3         3 / 3      --
&gt;     8         0 / 3         3 / 3      --
&gt;     9         3 / 3         3 / 3      riak@104.131.130.237
&gt;     10        3 / 3         3 / 3      riak@104.131.130.237
&gt;     11        0 / 3         3 / 3      --
&gt;
&gt; *Machine 4* (162.243.5.87)
&gt;
&gt; ============================== Consensus System
&gt; ===============================
&gt; Enabled:     true
&gt; Active:      true
&gt; Ring Ready:  true
&gt; Validation:  strong (trusted majority required)
&gt; Metadata:    best-effort replication (asynchronous)
&gt;
&gt; ================================== Ensembles
&gt; ==================================
&gt;  Ensemble     Quorum        Nodes      Leader
&gt;
&gt; -------------------------------------------------------------------------------
&gt;    root       0 / 6         3 / 6      --
&gt;     2         3 / 3         3 / 3      riak@104.236.79.78
&gt;     3         3 / 3         3 / 3      riak@104.131.130.237
&gt;     4         3 / 3         3 / 3      riak@104.131.130.237
&gt;     5         3 / 3         3 / 3      riak@104.131.130.237
&gt;     6         3 / 3         3 / 3      riak@104.236.79.78
&gt;     7         3 / 3         3 / 3      riak@162.243.5.87
&gt;     8         3 / 3         3 / 3      riak@162.243.5.87
&gt;     9         3 / 3         3 / 3      riak@104.131.130.237
&gt;     10        3 / 3         3 / 3      riak@104.131.130.237
&gt;     11        3 / 3         3 / 3      riak@104.236.79.78
&gt;
&gt;
&gt; Interestingly, Machine 4 has full quora for all ensembles except for root,
&gt; while Machine 3 only sees itself as a leader.
&gt;
&gt; Another interesting point is the output of `riak-admin ensemble-status
&gt; root`:
&gt;
&gt; ================================= Ensemble #1
&gt; =================================
&gt; Id:           root
&gt; Leader:       --
&gt; Leader ready: false
&gt;
&gt; ==================================== Peers
&gt; ====================================
&gt;  Peer  Status     Trusted          Epoch         Node
&gt;
&gt; -------------------------------------------------------------------------------
&gt;   1    (offline)    --              --           riak@104.131.45.32
&gt;   2      probe      no              8            riak@104.131.130.237
&gt;   3    (offline)    --              --           riak@104.131.141.237
&gt;   4    (offline)    --              --           riak@104.131.199.79
&gt;   5      probe      no              8            riak@104.236.79.78
&gt;   6      probe      no              8            riak@162.243.5.87
&gt;
&gt; This is consistent across all 4 machines, and seems to include some old
&gt; IPs from machines that left the cluster quite a while back, almost
&gt; definitely before I’d used Riak's Strong Consistency. Note that the reason
&gt; I added the fourth machine (104.131.39.61) was to see if this output would
&gt; change, perhaps resulting in a quorum for the root ensemble.
&gt;
&gt; For reference, here’s the status of a sample ensemble that isn’t “Leader
&gt; ready”, from the perspective of Machine 2:
&gt; ================================ Ensemble #62
&gt; =================================
&gt; Id:           {kv,1370157784997721485815954530671515330927436759040,3}
&gt; Leader:       --
&gt; Leader ready: false
&gt;
&gt; ==================================== Peers
&gt; ====================================
&gt;  Peer  Status     Trusted          Epoch         Node
&gt;
&gt; -------------------------------------------------------------------------------
&gt;   1    following    yes             43           riak@104.131.130.237
&gt;   2    following    yes             43           riak@104.236.79.78
&gt;   3     leading     yes             43           riak@162.243.5.87
&gt;
&gt;
&gt; My config consists of riak.conf with:
&gt;
&gt; strong_consistency = on
&gt;
&gt; and advanced.config with:
&gt;
&gt; [
&gt;   {riak_core,
&gt;     [
&gt;       {target_n_val, 5}
&gt;       ]},
&gt;   {riak_ensemble,
&gt;     [
&gt;       {ensemble_tick, 5000}
&gt;     ]}
&gt; ].
&gt;
&gt; though I’ve experimented with the latter in an attempt to get this
&gt; resolved.
&gt;
&gt; I didn’t see any relevant-looking log output on any of the servers.
&gt;
&gt; Has anyone come across this before?
&gt;
&gt; Thanks!
&gt;
&gt; *Jonathan Koff* B.CS.
&gt; co-founder of Projexity
&gt; www.projexity.com
&gt;
&gt; follow us on facebook at: www.facebook.com/projexity
&gt; follow us on twitter at: twitter.com/projexity
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg15913.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16032">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16032">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16039.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg15913.html">Ensembles failing to reach &quot;Leader ready&quot; stat...</a></span> <span class="sender italic">Jonathan Koff</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Ensembles failing to reach &quot;Leader ready&q...</span> <span class="sender italic">Andrew Stone</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16039.html">Re: Ensembles failing to reach &quot;Leader rea...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16038.html">Re: Ensembles failing to reach &quot;Leader...</a></span> <span class="sender italic">Jonathan Koff</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16049.html">Re: Ensembles failing to reach &quot;Le...</a></span> <span class="sender italic">Andrew Stone</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16048.html">Re: Ensembles failing to reach &qu...</a></span> <span class="sender italic">Jonathan Koff</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Ensembles failing to reach &quot;Leader ready&quot; state">
<input type="hidden" name="msgid" value="CAL3qbFKZo1qq3OMacm3G5ro=oSMwtcMhSZRmXEMESCo5_WAU1Q@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16032.html">
<input type="submit" value=" Andrew Stone ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Ensembles+failing+to+reach+%5C%22Leader+ready%5C%22+state%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg15913.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16039.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAL3qbFKZo1qq3OMacm3G5ro=oSMwtcMhSZRmXEMESCo5_WAU1Q@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
