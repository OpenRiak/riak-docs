<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak JAVA Client Performance</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08880" id="c">
<link rel="index" href="maillist.html#08880" id="i">
<link rel="prev" href="msg08879.html" id="p">
<link rel="next" href="msg08908.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08880.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+JAVA+Client+Performance%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak JAVA Client Performance</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Guido+Medina%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Guido Medina</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121011" rel="nofollow">Thu, 11 Oct 2012 02:40:40 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Pavel,

</pre><tt>  I'm not an expert with the pool size, but depending on your average 
</tt><tt>key size and nodes you could tune it to your needs, regarding the 
</tt><tt>client, a single shared client instance will suffice, there is a retrier 
</tt><tt>parameter which says how many times Riak will retry your operation 
</tt><tt>before returning you an exception (3 by default), and there is a timeout 
</tt><tt>on acquiring the connection, this is an example config:
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>The pool size here is for 4 nodes cluster kind of guessing for Erlang 8 
</tt><tt>threads per node to allow Riak nodes do other things too, remember they 
</tt><tt>have to sync their data between the nodes:
</tt><pre style="margin: 0em;">

*host* = your balancer host
*port* = your balancer port

</pre><tt>*final PBClientConfig clientConfig=new 
</tt><tt>PBClientConfig.Builder().withHost(host).withPort(port).withPoolSize(32).withConnectionTimeoutMillis(5000).build();**
</tt><pre style="margin: 0em;">
final IRiakClient riakClient=RiakFactory.newClient(clientConfig);
*
</pre><tt>That we have it running with no issues, the pool size depends on your 
</tt><tt>needs and data size, you could run with a pool size of 50 to a 100 if 
</tt><tt>your keys are really small, you will have to try your own values.
</tt><pre style="margin: 0em;">

Regards,

Guido.

On 11/10/12 08:40, Pavel Kogan wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Thanks Guido, Pawel,

</pre><tt>I will try using HAProxy + holding N concurrent connections on the 
</tt><tt>client side.
</tt><pre style="margin: 0em;">
I want clear for myself some point about concurrent connections:
1) What is reasonable limit of concurrent connections?
</pre><tt>2) Concurrent connections = separate generated pbc clients or single 
</tt><tt>shared pbc client?
</tt><pre style="margin: 0em;">
3) Will connection timeout if no requests would be done for some period?

Pavel

</pre><tt>On Wed, Oct 10, 2012 at 8:57 PM, Guido Medina 
</tt><tt>&lt;guido.med...@temetra.com &lt;<a  rel="nofollow" href="mailto:guido.med...@temetra.com">mailto:guido.med...@temetra.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

    From that perspective, for now it is better to treat the client as
    you would treat a JDBC DataSource pool, the tidy up comes when
    connecting the client, either one node or many, the client will
    behave better if it has no knowledge of whats going on at the
    cluster side, of course, that's as of 1.0.6, so that might change.

    He could try to connect to one node with a pool from 8 to 16
    concurrent connections and start from there, then, when talking to
    a cluster, he needs the balancer in the middle, main reason is
    because Riak expect you to connect to all nodes (it will simply
    behave better), otherwise it will be overloaded at one node and
    give you IOExceptions from time to time.

    Hope that helps,

    Guido.


    On 10/10/12 19:24, kamiseq wrote:

        ok, you have 100% point here, on the other hand I think pavel
        looks
        for some guidance how to improve performance on client side,
        so he can
        be 100% sure he is not wasting time on something. this is maybe
        premature optimization but it maybe also good position to
        understand
        library and enter new world of riak

        pozdrawiam
        Paweł Kamiński

        kami...@gmail.com &lt;<a  rel="nofollow" href="mailto:kami...@gmail.com">mailto:kami...@gmail.com</a>&gt;
        pkaminski....@gmail.com &lt;<a  rel="nofollow" href="mailto:pkaminski....@gmail.com">mailto:pkaminski....@gmail.com</a>&gt;
        ______________________


        On 10 October 2012 17:30, Guido Medina
        &lt;guido.med...@temetra.com &lt;<a  rel="nofollow" href="mailto:guido.med...@temetra.com">mailto:guido.med...@temetra.com</a>&gt;&gt;
        wrote:

            In fact, as more nodes, you might be surprised it that it
            might be
            faster....see my point? Riak is a lot of things, 1st you
            have to be aware of
            the hashing, hashmap, how a key gets copied into different
            nodes, how one or
            more nodes are responsible for a key, etc...so it is not
            that simple.


            On 10/10/12 16:28, Guido Medina wrote:

            That's why I keep pushing to one answer, Riak is not meant
            to be in one
            cluster, you are removing the external factors and CAP
            settings you will be
            using, and it won't be linear, you could get the same
            results with RW=2 with
            3, 4 and 5 nodes, there are several factors that will
            influence your
            benchmark, I would start with 3 nodes, up to 5 by altering
            those numbers,
            then you could end up with a formula which I asure you, it
            won't be linear.

            Regards,

            Guido.

            On 10/10/12 16:19, Pavel Kogan wrote:

            I understand that load balancing is a final solution, but
            I want to
            benchmark single node.
            If I knew that I can load single node with N requests /
            sec, I could assume
            that after load balancing over 5 nodes my throughput limit
            will increase
            linearly.

            Pavel

            On Wed, Oct 10, 2012 at 2:51 PM, Guido Medina
            &lt;guido.med...@temetra.com &lt;<a  rel="nofollow" href="mailto:guido.med...@temetra.com">mailto:guido.med...@temetra.com</a>&gt;&gt;
            wrote:

                The answer is there, create a client config with N
                pooled connections to
                your load balancer whatever you are using, I know HA
                proxy supports the PBC
                config (TCP based) which is faster than HTTP client,
                and hence my
                recommendation.

                Say, a non-clustered client config with N connections
                to balancer_host at
                8087 and your balancer_host connected to EACH node,
                that's the way to go,
                the rest is about the CAP level you want to support
                which will impact your
                performance vs integrity. Up to you.

                CAP doc:
                
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/tutorials/fast-track/Tunable-CAP-Controls-in-Riak/">http://docs.basho.com/riak/latest/tutorials/fast-track/Tunable-CAP-Controls-in-Riak/</a>

                Guido.


                On 10/10/12 13:33, Pavel Kogan wrote:

                Hi,

                The node is OK and not down.
                I have a way to do load balancing externally to JAVA
                Client.
                I am evaluating Riak for using in my company and want
                to measure maximal
                throughput vs single node.

                Thanks,
                    Pavel

                On Wed, Oct 10, 2012 at 2:13 PM, Guido Medina
                &lt;guido.med...@temetra.com
                &lt;<a  rel="nofollow" href="mailto:guido.med...@temetra.com">mailto:guido.med...@temetra.com</a>&gt;&gt;
                wrote:

                    That question has been answered few times, here is
                    my old answer:

                    Hi,

                       It is the Java client which to be honest,
                    doesn't handle well one node
                    going down, so, for example, in my company we use
                    HA proxy for that, here
                    is
                    a starting configuration:
                    <a  rel="nofollow" href="https://gist.github.com/1507077">https://gist.github.com/1507077</a>

                       Once we switched to HA proxy we just use a
                    simple client without
                    cluster
                    config, so the Java client doesn't know anything
                    about the load balancing
                    going on. It works well, I can upgrade and restart
                    servers without our
                    Java
                    application be complaining.

                    Regards,

                    Guido.


                    On 10/10/12 12:58, Pavel Kogan wrote:

                    Thanks,

                    I will try this solution.

                    Pavel

                    On Wed, Oct 10, 2012 at 1:51 PM, kamiseq
                    &lt;kami...@gmail.com &lt;<a  rel="nofollow" href="mailto:kami...@gmail.com">mailto:kami...@gmail.com</a>&gt;&gt; wrote:

                        well I asked same question few days ago (maybe
                        2 weeks form now) and
                        the answer was that yes sharing client is
                        thread safe and all you
                        should do is to create new bucket instance on
                        every request

                        pozdrawiam
                        Paweł Kamiński

                        kami...@gmail.com &lt;<a  rel="nofollow" href="mailto:kami...@gmail.com">mailto:kami...@gmail.com</a>&gt;
                        pkaminski....@gmail.com
                        &lt;<a  rel="nofollow" href="mailto:pkaminski....@gmail.com">mailto:pkaminski....@gmail.com</a>&gt;
                        ______________________


                        On 10 October 2012 09:25, Pavel Kogan
                        &lt;pavel.ko...@cortica.com
                        &lt;<a  rel="nofollow" href="mailto:pavel.ko...@cortica.com">mailto:pavel.ko...@cortica.com</a>&gt;&gt; wrote:

                            1) Is it ok to share a single pbc client
                            object between 50 threads?
                            Should
                            it be protected by lock ?
                            2) I didn't do load balancing between
                            nodes yet, cause I want to
                            understand
                            better throughput limit. I am planning to
                            do it for much higher
                            throughput.

                            Pavel


                            On Wed, Oct 10, 2012 at 9:21 AM, kamiseq
                            &lt;kami...@gmail.com
                            &lt;<a  rel="nofollow" href="mailto:kami...@gmail.com">mailto:kami...@gmail.com</a>&gt;&gt; wrote:

                                maybe the good start is to share
                                pbclient object and only create
                                bucket per request, you will save few
                                steps on client configuration.
                                have you tried balancing requests to
                                cluster and distribute them over
                                all
                                nodes?

                                pozdrawiam
                                Paweł Kamiński

                                kami...@gmail.com
                                &lt;<a  rel="nofollow" href="mailto:kami...@gmail.com">mailto:kami...@gmail.com</a>&gt;
                                pkaminski....@gmail.com
                                &lt;<a  rel="nofollow" href="mailto:pkaminski....@gmail.com">mailto:pkaminski....@gmail.com</a>&gt;
                                ______________________


                                On 10 October 2012 06:18, Pavel Kogan
                                &lt;pavel.ko...@cortica.com
                                &lt;<a  rel="nofollow" href="mailto:pavel.ko...@cortica.com">mailto:pavel.ko...@cortica.com</a>&gt;&gt;
                                wrote:

                                    Hi all,

                                    I have Riak cluster consisting of
                                    5 nodes that contains about 30
                                    millions of
                                    keys (35% of capacity according to
                                    Riak Control).
                                    Currently we have single JAVA
                                    client reading and writing records to
                                    same
                                    node. I need some tips, how to use
                                    the client efficiently
                                    to reach maximal throughput - I
                                    would like to be able to read/write
                                    up
                                    to
                                    100 records/sec on 1Gbit network.
                                    Currently I get a lot
                                    of JAVA socket exceptions after a
                                    while (even for the much slower
                                    rate -
                                    10
                                    records/sec), after which I  need
                                    to restart client and node.

                                    Thanks,
                                        Pavel

                                    P.S: My client using 50 threads
                                    and pbc client is created and
                                    shut-downed
                                    per request.

                                    
_______________________________________________
                                    riak-users mailing list
                                    riak-users@lists.basho.com
                                    &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
                                    
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>





                    _______________________________________________
                    riak-users mailing list
                    riak-users@lists.basho.com
                    &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
                    
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



                    _______________________________________________
                    riak-users mailing list
                    riak-users@lists.basho.com
                    &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
                    
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



                _______________________________________________
                riak-users mailing list
                riak-users@lists.basho.com
                &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
                
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>




            _______________________________________________
            riak-users mailing list
            riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
            <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



    _______________________________________________
    riak-users mailing list
    riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
    <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


</pre></blockquote><pre style="margin: 0em;">

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08879.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08880">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08880">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08908.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08864.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Pavel Kogan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08865.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Guido Medina</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08866.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Pavel Kogan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08867.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Guido Medina</span></li>
<li class="icons-email"><span class="subject"><a href="msg08870.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Pavel Kogan</span></li>
<li class="icons-email"><span class="subject"><a href="msg08871.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Guido Medina</span></li>
<li class="icons-email"><span class="subject"><a href="msg08872.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Guido Medina</span></li>
<li class="icons-email"><span class="subject"><a href="msg08873.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">kamiseq</span></li>
<li class="icons-email"><span class="subject"><a href="msg08874.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Guido Medina</span></li>
<li class="icons-email"><span class="subject"><a href="msg08879.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Pavel Kogan</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak JAVA Client Performance</span> <span class="sender italic">Guido Medina</span></li>
<li class="icons-email"><span class="subject"><a href="msg08908.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Brian Roach</span></li>
<li class="icons-email"><span class="subject"><a href="msg08909.html">Re: Riak JAVA Client Performance</a></span> <span class="sender italic">Pavel Kogan</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak JAVA Client Performance">
<input type="hidden" name="msgid" value="507693EF.7010200@temetra.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08880.html">
<input type="submit" value=" Guido Medina ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+JAVA+Client+Performance%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08879.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08908.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">507693EF.7010200@temetra.com</li>
</ul>
</div>
</body>
</html>
