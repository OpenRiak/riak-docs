<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Yokozuna's inconsistent query problem</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#18022" id="c">
<link rel="index" href="maillist.html#18022" id="i">
<link rel="prev" href="msg18021.html" id="p">
<link rel="next" href="msg18026.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18022.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna%27s+inconsistent+query+problem%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Yokozuna's inconsistent query problem</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Fred+Dushin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Fred Dushin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20170223" rel="nofollow">Thu, 23 Feb 2017 19:45:07 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hello Witeman,

What you are seeing with your two queries is the result of two different 
coverage plans, querying different parts of the cluster.  Riak Search 
translates coverage plans to Solr sharded queries, and will periodically change 
the coverage plan, so as to more evenly distribute queries across the cluster.  
So what you are seeing is effectively two different sharded queries, hitting 
different solr instances in your cluster.  You are seeing inconsistent search 
results, which suggests there is a discrepancy between what is stored in Solr 
and what is stored in Riak.  Generally speaking, AAE should detect these 
repairs and correct them over time.</pre><pre>

Can you please send the output of the following two commands:

riak-admin aae-status
riak-admin search aae-status

That will tell you something about the behavior of the underlying KV and 
Yokozuna AAE subsystems.

Out of curiosity, can you you read the &quot;2772439&quot; key in the &quot;data_201702&quot; 
bucket in Riak with quorum equal to all?  If you do that read, does that affect 
the behavior of your query you posted?  (I am wondering if you trigger read 
repair that will repair the entry in Solr)

Thanks,
-Fred

&gt; On Feb 23, 2017, at 10:11 PM, Witeman Zheng &lt;witema...@gmail.com&gt; wrote:
&gt; 
&gt; Hi,
&gt; 
&gt; 
&gt; I am having a 10 nodes of RiakKV 2.2.0, and turn on Riak Search(Yokozuna).  
&gt; Having about 3million records in one bucket with index, every record has 
&gt; about 1k size.
&gt; 
&gt; Then when it is triggered a Yokozuna query for one specific id, sometimes 
&gt; return the record, sometimes return NOT FOUND, it is very weird.
&gt; 
&gt; FOUND case:
&gt; wt=json&amp;q=*:*&amp;rows=1000&amp;start=0&amp;sort=collect_id_l%20asc&amp;fq=agent_uid_i:1191&amp;fq=id_l:2772439&amp;indent=true&quot;
&gt; {
&gt;   &quot;responseHeader&quot;:{
&gt;     &quot;status&quot;:0,
&gt;     &quot;QTime&quot;:57,
&gt;     &quot;params&quot;:{
&gt;       &quot;10.100.205.80:8093&quot;:&quot;_yz_pn:230 OR _yz_pn:200 OR _yz_pn:170 OR 
&gt; _yz_pn:140 OR _yz_pn:110 OR _yz_pn:80 OR _yz_pn:50 OR _yz_pn:20&quot;,
&gt;       &quot;10.100.205.79:8093&quot;:&quot;_yz_pn:239 OR _yz_pn:209 OR _yz_pn:179 OR 
&gt; _yz_pn:149 OR _yz_pn:119 OR _yz_pn:89 OR _yz_pn:59 OR _yz_pn:29&quot;,
&gt;       &quot;indent&quot;:&quot;true&quot;,
&gt;       &quot;10.100.205.73:8093&quot;:&quot;_yz_pn:233 OR _yz_pn:203 OR _yz_pn:173 OR 
&gt; _yz_pn:143 OR _yz_pn:113 OR _yz_pn:83 OR _yz_pn:53 OR _yz_pn:23&quot;,
&gt;       &quot;start&quot;:&quot;0&quot;,
&gt;       &quot;sort&quot;:&quot;collect_id_l asc&quot;,
&gt;       &quot;fq&quot;:[&quot;agent_uid_i:1191&quot;,
&gt;         &quot;id_l:2772439&quot;],
&gt;       &quot;rows&quot;:&quot;1000&quot;,
&gt;       &quot;10.100.205.76:8093&quot;:&quot;_yz_pn:236 OR _yz_pn:206 OR _yz_pn:176 OR 
&gt; _yz_pn:146 OR _yz_pn:116 OR _yz_pn:86 OR _yz_pn:56 OR _yz_pn:26&quot;,
&gt;       &quot;q&quot;:&quot;*:*&quot;,
&gt;       
&gt; &quot;shards&quot;:&quot;10.100.205.71:8093/internal_solr/game_data_records_index,10.100.205.72:8093/internal_solr/game_data_records_index,10.100.205.73:8093/internal_solr/game_data_records_index,10.100.205.74:8093/internal_solr/game_data_records_index,10.100.205.75:8093/internal_solr/game_data_records_index,10.100.205.76:8093/internal_solr/game_data_records_index,10.100.205.77:8093/internal_solr/game_data_records_index,10.100.205.78:8093/internal_solr/game_data_records_index,10.100.205.79:8093/internal_solr/game_data_records_index,10.100.205.80:8093/internal_solr/game_data_records_index&quot;,
&gt;       &quot;10.100.205.71:8093&quot;:&quot;_yz_pn:251 OR _yz_pn:221 OR _yz_pn:191 OR 
&gt; _yz_pn:161 OR _yz_pn:131 OR _yz_pn:101 OR _yz_pn:71 OR _yz_pn:41 OR 
&gt; _yz_pn:11&quot;,
&gt;       &quot;10.100.205.74:8093&quot;:&quot;_yz_pn:224 OR _yz_pn:194 OR _yz_pn:164 OR 
&gt; _yz_pn:134 OR _yz_pn:104 OR _yz_pn:74 OR _yz_pn:44 OR _yz_pn:14&quot;,
&gt;       &quot;10.100.205.77:8093&quot;:&quot;_yz_pn:227 OR _yz_pn:197 OR _yz_pn:167 OR 
&gt; _yz_pn:137 OR _yz_pn:107 OR _yz_pn:77 OR _yz_pn:47 OR _yz_pn:17&quot;,
&gt;       &quot;10.100.205.78:8093&quot;:&quot;_yz_pn:248 OR _yz_pn:218 OR _yz_pn:188 OR 
&gt; _yz_pn:158 OR _yz_pn:128 OR _yz_pn:98 OR _yz_pn:68 OR _yz_pn:38 OR _yz_pn:8&quot;,
&gt;       &quot;10.100.205.75:8093&quot;:&quot;_yz_pn:255 OR _yz_pn:245 OR _yz_pn:215 OR 
&gt; _yz_pn:185 OR _yz_pn:155 OR _yz_pn:125 OR _yz_pn:95 OR _yz_pn:65 OR _yz_pn:35 
&gt; OR _yz_pn:5&quot;,
&gt;       &quot;wt&quot;:&quot;json&quot;,
&gt;       &quot;10.100.205.72:8093&quot;:&quot;(_yz_pn:252 AND (_yz_fpn:252)) OR _yz_pn:242 OR 
&gt; _yz_pn:212 OR _yz_pn:182 OR _yz_pn:152 OR _yz_pn:122 OR _yz_pn:92 OR 
&gt; _yz_pn:62 OR _yz_pn:32 OR _yz_pn:2&quot;}},
&gt;   &quot;response&quot;:{&quot;numFound&quot;:1,&quot;start&quot;:0,&quot;docs&quot;:[
&gt;       {
&gt;         â€œsome_field_1_l&quot;:0,
&gt;         &quot;some_field_2_l&quot;:0,
&gt;         &quot;some_field_3_s&quot;:&quot;[]&quot;,
&gt;         &quot;some_field_4_s&quot;:&quot;[]&quot;,
&gt;         &quot;some_field_5_l&quot;:0,
&gt;         &quot;some_field_6_l&quot;:0,
&gt;         &quot;some_field_7_s&quot;:&quot;[]&quot;,
&gt;         
&gt; &quot;some_field_8_s&quot;:&quot;[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0],[11,0],[12,0],[13,0],[14,0],[15,0],[16,0],[17,0],[18,0],[19,0],[20,0]]&quot;,
&gt;         &quot;collect_id_l&quot;:2765608,
&gt;         &quot;some_field_9_i&quot;:1191,
&gt;         &quot;some_field_10_i&quot;:1191,
&gt;         &quot;some_field_11_i&quot;:1,
&gt;         &quot;some_field_12_l&quot;:0,
&gt;         &quot;some_field_13_l&quot;:2000,
&gt;         &quot;some_field_14_l&quot;:764846,
&gt;         &quot;some_field_15_l&quot;:766846,
&gt;         &quot;some_field_16_i&quot;:57,
&gt;         &quot;some_field_17_i&quot;:1,
&gt;         &quot;some_field_18_s&quot;:&quot;UTC_-4&quot;,
&gt;         &quot;some_field_19_i&quot;:1487822270,
&gt;         &quot;some_field_20_s&quot;:&quot;61.221.181.7&quot;,
&gt;         &quot;some_field_21_l&quot;:2869104,
&gt;         &quot;some_field_22_s&quot;:&quot;[1,4,10,4,5,3,5,6,8,4,3,2,2,1,10]&quot;,
&gt;         &quot;some_field_23_i&quot;:20,
&gt;         &quot;some_field_24_i&quot;:1,
&gt;         &quot;some_field_25_i&quot;:1,
&gt;         &quot;agent_uid_i&quot;:1191,
&gt;         &quot;some_field_26_l&quot;:2772439,
&gt;         &quot;some_field_27_i&quot;:100,
&gt;         &quot;_yz_id&quot;:&quot;1*default*data_201702*2772439*203&quot;,
&gt;         &quot;_yz_rk&quot;:&quot;2772439&quot;,
&gt;         &quot;_yz_rt&quot;:&quot;default&quot;,
&gt;         &quot;_yz_rb&quot;:&quot;data_201702&quot;}]
&gt; 
&gt;   }}
&gt; 
&gt; 
&gt; 
&gt; 
&gt; NOTFOUND case:
&gt; 
&gt; wt=json&amp;q=*:*&amp;rows=1000&amp;start=0&amp;sort=collect_id_l%20asc&amp;fq=agent_uid_i:1191&amp;fq=id_l:2772439&amp;indent=true&quot;
&gt; {
&gt;   &quot;responseHeader&quot;:{
&gt;     &quot;status&quot;:0,
&gt;     &quot;QTime&quot;:62,
&gt;     &quot;params&quot;:{
&gt;       &quot;10.100.205.80:8093&quot;:&quot;_yz_pn:240 OR _yz_pn:210 OR _yz_pn:180 OR 
&gt; _yz_pn:150 OR _yz_pn:120 OR _yz_pn:90 OR _yz_pn:60 OR _yz_pn:30&quot;,
&gt;       &quot;10.100.205.79:8093&quot;:&quot;_yz_pn:249 OR _yz_pn:219 OR _yz_pn:189 OR 
&gt; _yz_pn:159 OR _yz_pn:129 OR _yz_pn:99 OR _yz_pn:69 OR _yz_pn:39 OR _yz_pn:9&quot;,
&gt;       &quot;indent&quot;:&quot;true&quot;,
&gt;       &quot;10.100.205.73:8093&quot;:&quot;(_yz_pn:253 AND (_yz_fpn:253)) OR _yz_pn:243 OR 
&gt; _yz_pn:213 OR _yz_pn:183 OR _yz_pn:153 OR _yz_pn:123 OR _yz_pn:93 OR 
&gt; _yz_pn:63 OR _yz_pn:33 OR _yz_pn:3&quot;,
&gt;       &quot;start&quot;:&quot;0&quot;,
&gt;       &quot;sort&quot;:&quot;collect_id_l asc&quot;,
&gt;       &quot;fq&quot;:[&quot;agent_uid_i:1191&quot;,
&gt;         &quot;id_l:2772439&quot;],
&gt;       &quot;rows&quot;:&quot;1000&quot;,
&gt;       &quot;10.100.205.76:8093&quot;:&quot;_yz_pn:256 OR _yz_pn:246 OR _yz_pn:216 OR 
&gt; _yz_pn:186 OR _yz_pn:156 OR _yz_pn:126 OR _yz_pn:96 OR _yz_pn:66 OR _yz_pn:36 
&gt; OR _yz_pn:6&quot;,
&gt;       &quot;q&quot;:&quot;*:*&quot;,
&gt;       
&gt; &quot;shards&quot;:&quot;10.100.205.71:8093/internal_solr/game_data_records_index,10.100.205.72:8093/internal_solr/game_data_records_index,10.100.205.73:8093/internal_solr/game_data_records_index,10.100.205.74:8093/internal_solr/game_data_records_index,10.100.205.75:8093/internal_solr/game_data_records_index,10.100.205.76:8093/internal_solr/game_data_records_index,10.100.205.77:8093/internal_solr/game_data_records_index,10.100.205.78:8093/internal_solr/game_data_records_index,10.100.205.79:8093/internal_solr/game_data_records_index,10.100.205.80:8093/internal_solr/game_data_records_index&quot;,
&gt;       &quot;10.100.205.71:8093&quot;:&quot;_yz_pn:231 OR _yz_pn:201 OR _yz_pn:171 OR 
&gt; _yz_pn:141 OR _yz_pn:111 OR _yz_pn:81 OR _yz_pn:51 OR _yz_pn:21&quot;,
&gt;       &quot;10.100.205.74:8093&quot;:&quot;_yz_pn:234 OR _yz_pn:204 OR _yz_pn:174 OR 
&gt; _yz_pn:144 OR _yz_pn:114 OR _yz_pn:84 OR _yz_pn:54 OR _yz_pn:24&quot;,
&gt;       &quot;10.100.205.77:8093&quot;:&quot;_yz_pn:237 OR _yz_pn:207 OR _yz_pn:177 OR 
&gt; _yz_pn:147 OR _yz_pn:117 OR _yz_pn:87 OR _yz_pn:57 OR _yz_pn:27&quot;,
&gt;       &quot;10.100.205.78:8093&quot;:&quot;_yz_pn:228 OR _yz_pn:198 OR _yz_pn:168 OR 
&gt; _yz_pn:138 OR _yz_pn:108 OR _yz_pn:78 OR _yz_pn:48 OR _yz_pn:18&quot;,
&gt;       &quot;10.100.205.75:8093&quot;:&quot;_yz_pn:225 OR _yz_pn:195 OR _yz_pn:165 OR 
&gt; _yz_pn:135 OR _yz_pn:105 OR _yz_pn:75 OR _yz_pn:45 OR _yz_pn:15&quot;,
&gt;       &quot;wt&quot;:&quot;json&quot;,
&gt;       &quot;10.100.205.72:8093&quot;:&quot;_yz_pn:252 OR _yz_pn:222 OR _yz_pn:192 OR 
&gt; _yz_pn:162 OR _yz_pn:132 OR _yz_pn:102 OR _yz_pn:72 OR _yz_pn:42 OR 
&gt; _yz_pn:12&quot;}},
&gt;   &quot;response&quot;:{&quot;numFound&quot;:0,&quot;start&quot;:0,&quot;docs&quot;:[]
&gt;   }}
&gt; 
&gt; 
&gt; I can select this record from solr webapp from some of these 10 nodes.  So 
&gt; this record should be indexed by solr.  So I guessed the problem cause this 
&gt; is related with Yokozunaâ€™s distributed shards, since one query would shard to 
&gt; every solr instance by Yokozuna, then Yokozuna would collect all the returns 
&gt; and reduce to a fix result, something like map-reduce mechanism.
&gt; 
&gt; So the problem here may underlay in map phase or reduce phase.
&gt; 
&gt; The default configuration of riak search applied in these 10 nodes.
&gt; 
&gt; Would anyone have some insight on how to fix this?  By modified the 
&gt; configuration of search?
&gt; 
&gt; 
&gt; Best regards,
&gt; Witeman
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18021.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#18022">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18022">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18026.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18021.html">Yokozuna's inconsistent query problem</a></span> <span class="sender italic">Witeman Zheng</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Yokozuna's inconsistent query problem</span> <span class="sender italic">Fred Dushin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18026.html">Re: Yokozuna's inconsistent query problem</a></span> <span class="sender italic">Witeman Zheng</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18035.html">Re: Yokozuna's inconsistent query problem</a></span> <span class="sender italic">Witeman Zheng</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Yokozuna's inconsistent query problem">
<input type="hidden" name="msgid" value="C7361183-705C-4563-A3A6-8A6C9833C976@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18022.html">
<input type="submit" value=" Fred Dushin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Yokozuna%27s+inconsistent+query+problem%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18021.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18026.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">C7361183-705C-4563-A3A6-8A6C9833C976@basho.com</li>
</ul>
</div>
</body>
</html>
