<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak cluster unresponsive after single node failure</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07400" id="c">
<link rel="index" href="maillist.html#07400" id="i">
<link rel="prev" href="msg07399.html" id="p">
<link rel="next" href="msg07401.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07400.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+cluster+unresponsive+after+single+node+failure%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak cluster unresponsive after single node failure</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Armon+Dadgar%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Armon Dadgar</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120508" rel="nofollow">Tue, 08 May 2012 11:18:27 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey,

The cluster is back up and running by going through the following steps:
  1) Force terminate east-riak-001 using the AWS console
  2) &quot;riak-admin down r...@east-riak-001.cluster.kiip.me&quot; on ALL nodes
  3) riak stop &amp;&amp; riak start  on ALL nodes</pre><pre>

All the nodes appeared to have been blocked trying to talk to riak 001 which was
the ring claimant at the time. Doing this seems to have cleared the state 
enough for
the cluster to make progress again.

In regards to the other questions:
  * Backend : LevelDB
  * OS: Ubuntu 10.04
  * Size: 500 bytes - 1KB
  * Traffic: 300 ops/sec

I will send the vm.args file offline too.

Best Regards,

Armon Dadgar


On Tuesday, May 8, 2012 at 11:12 AM, Mark Phillips wrote:

&gt; Hey Armon, 
&gt; 
&gt; So &quot;monitor busy_dist_port&quot; means your nodes aren't talking but we need to 
&gt; figure out why. Specifically it looks like you're kv vnodes aren't able to 
&gt; communicate.
&gt; 
&gt; First questions
&gt; 
&gt; * Which backend are you using? 
&gt; * What OS?
&gt; * What size are your values?
&gt; * What is the typical traffic (ops/second) on the cluster?
&gt; 
&gt; Also, if you could send a copy of your vm.args (probably best off-list) that 
&gt; would be helpful, too. 
&gt; 
&gt; Mark 
&gt; 
&gt; On Tue, May 8, 2012 at 10:25 AM, Armon Dadgar &lt;armon.dad...@gmail.com 
&gt; (<a  rel="nofollow" href="mailto:armon.dad...@gmail.com">mailto:armon.dad...@gmail.com</a>)&gt; wrote:
&gt; &gt; We are currently running a 4 node cluster with 1.1.2 on Ubuntu 10.04, and 
&gt; &gt; are experiencing an issue where losing a single node has cause the entire
&gt; &gt; cluster to fail.
&gt; &gt; 
&gt; &gt; Nagios reported that node 1 had failed, shortly after, all the logs are 
&gt; &gt; filled with: 
&gt; &gt; 2012-05-08 08:13:22.319 [error] &lt;0.27873.2568&gt;@riak_kv_put_fsm:prepare:199 
&gt; &gt; Unable to forward put for 
&gt; &gt; {&lt;&lt;&quot;session&quot;&gt;&gt;,&lt;&lt;&quot;3a538aaa-b503-4a2e-94f9-7b62074815c7&quot;&gt;&gt;} to 
&gt; &gt; 'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)' - nodedown
&gt; &gt; 2012-05-08 08:21:11.890 [error] 
&gt; &gt; &lt;0.16614.2569&gt;@riak_core_handoff_sender:start_fold:178 Handoff of partition 
&gt; &gt; riak_kv_vnode 456719261665907161938651510223838443642478919680 from 
&gt; &gt; 'r...@east-riak-004.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-004.cluster.kiip.me">mailto:r...@east-riak-004.cluster.kiip.me</a>)' to 
&gt; &gt; 'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)' failed 
&gt; &gt; exit:{noproc,{gen_server2,call,[{riak_kv_handoff_listener,'r...@east-riak-001.cluster.kiip.me
&gt; &gt;  (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'},handoff_port,infinity]}}
&gt; &gt; 2012-05-08 08:23:18.005 [error] &lt;0.19071.2569&gt;@riak_kv_put_fsm:prepare:199 
&gt; &gt; Unable to forward put for 
&gt; &gt; {&lt;&lt;&quot;session&quot;&gt;&gt;,&lt;&lt;&quot;7a015cff-d361-4a38-a624-004f3e7bc76a&quot;&gt;&gt;} to 
&gt; &gt; 'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)' - timeout
&gt; &gt; 2012-05-08 08:23:21.312 [error] &lt;0.19178.2569&gt;@riak_kv_put_fsm:prepare:199 
&gt; &gt; Unable to forward put for 
&gt; &gt; {&lt;&lt;&quot;session&quot;&gt;&gt;,&lt;&lt;&quot;b9bd30fa-ddba-4219-b1d9-e4b761797615&quot;&gt;&gt;} to 
&gt; &gt; 'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)' - timeout
&gt; &gt; ...
&gt; &gt; 2012-05-08 08:30:26.379 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.4921.2570&gt; 
&gt; &gt; [{initial_call,{riak_kv_put_fsm,init,1}},{almost_current_function,{erlang,bif_return_trap,1}},{message_queue_len,0}]
&gt; &gt;  {#Port&lt;0.35446433&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; 2012-05-08 08:30:26.556 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:89 Monitor got 
&gt; &gt; {suppressed,port_events,7}
&gt; &gt; 2012-05-08 08:30:26.616 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.4930.2570&gt; 
&gt; &gt; [{initial_call,{riak_kv_put_fsm,init,1}},{almost_current_function,{erlang,bif_return_trap,1}},{message_queue_len,0}]
&gt; &gt;  {#Port&lt;0.35446433&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; 2012-05-08 08:30:27.565 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:89 Monitor got 
&gt; &gt; {suppressed,port_events,4}
&gt; &gt; 2012-05-08 08:30:27.668 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.3151.2570&gt; 
&gt; &gt; [{initial_call,{riak_core_vnode,init,1}},{almost_current_function,{erlang,bif_return_trap,1}},{message_queue_len,0}]
&gt; &gt;  {#Port&lt;0.35446433&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; ...
&gt; &gt; 2012-05-08 10:20:30.088 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.31200.2576&gt; [{initial_call,{riak_kv_put_fsm,init,1}},{almost_curren
&gt; &gt; t_function,{erlang,bif_return_trap,1}},{message_queue_len,0}] 
&gt; &gt; {#Port&lt;0.35534018&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; 2012-05-08 10:20:31.261 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.31202.2576&gt; [{initial_call,{riak_kv_put_fsm,init,1}},{almost_curren
&gt; &gt; t_function,{erlang,bif_return_trap,1}},{message_queue_len,0}] 
&gt; &gt; {#Port&lt;0.35534018&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; 2012-05-08 10:20:32.736 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:85 monitor busy_dist_port 
&gt; &gt; &lt;0.1629.2570&gt; [{initial_call,{riak_core_vnode,init,1}},{almost_current
&gt; &gt; _function,{erlang,bif_return_trap,1}},{message_queue_len,0}] 
&gt; &gt; {#Port&lt;0.35534018&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}
&gt; &gt; 2012-05-08 10:20:33.552 [info] 
&gt; &gt; &lt;0.77.0&gt;@riak_core_sysmon_handler:handle_event:89 Monitor got 
&gt; &gt; {suppressed,port_events,3}
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Now all the logs are basically being completely filled with &quot;monitor 
&gt; &gt; busy_dist_port &lt;0.22647.2610&gt; 
&gt; &gt; [{initial_call,{riak_kv_put_fsm,init,1}},{almost_current_function,{erlang,bif_return_trap,1}},{message_queue_len,0}]
&gt; &gt;  {#Port&lt;0.35563927&gt;,'r...@east-riak-001.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-001.cluster.kiip.me">mailto:r...@east-riak-001.cluster.kiip.me</a>)'}&quot; or similar. 
&gt; &gt; 
&gt; &gt; Riak-admin is unable to report any information about the cluster, and same 
&gt; &gt; with Riak Control.
&gt; &gt; Both just timeout and return:
&gt; &gt; 
&gt; &gt; production-vpc east-riak-002 riak $ riak-admin ring_status 
&gt; &gt; Attempting to restart script through sudo -u riak
&gt; &gt; RPC to 'r...@east-riak-002.cluster.kiip.me 
&gt; &gt; (<a  rel="nofollow" href="mailto:r...@east-riak-002.cluster.kiip.me">mailto:r...@east-riak-002.cluster.kiip.me</a>)' failed: {'EXIT',
&gt; &gt;                                                      {timeout,
&gt; &gt;                                                       {gen_server,call,
&gt; &gt;                                                        [riak_core_gossip,
&gt; &gt;                                                         legacy_gossip]}}}
&gt; &gt; 
&gt; &gt; 
&gt; &gt; At this point, the cluster has stopped responding to any requests as far as 
&gt; &gt; I can tell,
&gt; &gt; or any operations that do complete take well over 60 seconds for a single 
&gt; &gt; put with w=1.
&gt; &gt; 
&gt; &gt; Wondering if anybody else has seen this, and if so any advise for getting 
&gt; &gt; it resolved?
&gt; &gt; 
&gt; &gt; Best Regards,
&gt; &gt; 
&gt; &gt; Armon Dadgar
&gt; &gt; 
&gt; &gt; 
&gt; &gt; _______________________________________________
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07399.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07400">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07400">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07401.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07398.html">Riak cluster unresponsive after single node failure</a></span> <span class="sender italic">Armon Dadgar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07399.html">Re: Riak cluster unresponsive after single node...</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak cluster unresponsive after single ...</span> <span class="sender italic">Armon Dadgar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07401.html">Re: Riak cluster unresponsive after sin...</a></span> <span class="sender italic">Scott Lystig Fritchie</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07402.html">Re: Riak cluster unresponsive after...</a></span> <span class="sender italic">Armon Dadgar</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07403.html">Re: Riak cluster unresponsive ...</a></span> <span class="sender italic">Armon Dadgar</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak cluster unresponsive after single node failure">
<input type="hidden" name="msgid" value="1D7A92C890A149079CB87C98A5980C83@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07400.html">
<input type="submit" value=" Armon Dadgar ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+cluster+unresponsive+after+single+node+failure%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07399.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07401.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">1D7A92C890A149079CB87C98A5980C83@gmail.com</li>
</ul>
</div>
</body>
</html>
