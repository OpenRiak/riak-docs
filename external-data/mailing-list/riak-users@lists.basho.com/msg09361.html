<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Re: Riak performance problems when LevelDB database grows beyond 16GB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#09361" id="c">
<link rel="index" href="maillist.html#09361" id="i">
<link rel="prev" href="msg09017.html" id="p">
<link rel="next" href="msg09362.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09361.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Re: Riak performance problems when LevelDB database grows beyond 16GB</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jan.Evangelista%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jan.Evangelista</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121121" rel="nofollow">Wed, 21 Nov 2012 07:53:00 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>---------- Původní zpráva ----------
&gt; Od: Matthew Von-Maszewski 
&gt; Datum: 22. 10. 2012
&gt; Předmět: Re: Riak performance problems when LevelDB database grows beyond 16GB
&gt; Jan,
&gt; 
&gt; ...
&gt; The next question from me is whether the drive / disk array problems are your 
&gt; only problem at this point.  The data in log_jan.txt looks ok until 
&gt; the failures start.  I am willing to work more, but I need to better 
&gt; understand your next level of problems.
&gt;
&gt; Matthew</pre><pre>

Hi Matthew,

thanks again for helping me. It was actually bad RAM. It took me some time to 
convince the hosting provider since the problem did not show up in their 
hardware tests. :-/

I ran a 4 day test when the two bad nodes got fixed, and the original issue 
(that a Riak node got stuck) did not appear again.

There are however other problems which seem to be caused by my &quot;misuse&quot; of 
LevelDB for storing short-lived data (the data is valid only for 24 hours).

Here is the application throughput during a 4 days test with 5 Riak nodes:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka#5Riak_4d_edited.jpg">http://janevangelista.rajce.idnes.cz/nastenka#5Riak_4d_edited.jpg</a>

This graph shows memory use on a Riak node:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka/#MemNode3-edited.jpg">http://janevangelista.rajce.idnes.cz/nastenka/#MemNode3-edited.jpg</a>

(Memory use on other nodes looks similar, but the OOM killed was not invoked 
there.)

And this graph shows disk space consumption on a Riak node:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace-4d-edited.jpg">http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace-4d-edited.jpg</a>

The OOM condition which killed one Riak node (and slowed down the other ones) 
seems to be caused by the map-reduce jobs which 
periodically delete old data from the database. The entries are deleted with a 
mapred job querying the secondary index and using the reduce function published 
at <a  rel="nofollow" href="http://contrib.basho.com/delete_keys.html">http://contrib.basho.com/delete_keys.html</a> .

I wish LevelDB could expire old entries in the same was as BitCask does. :-)

In an older 3 day test I had only 5 min timeout for the mapred jobs (a bug). It 
caused premature cancellation of the jobs deleting the old data - but the 
throughput was better:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka#4Riak_3d_8K_edited.jpg">http://janevangelista.rajce.idnes.cz/nastenka#4Riak_3d_8K_edited.jpg</a>

The memory use looked reasonable as well:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka/#Memory-3d-edited.jpg">http://janevangelista.rajce.idnes.cz/nastenka/#Memory-3d-edited.jpg</a>

The disk use in this case was:

<a  rel="nofollow" href="http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace.jpg">http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace.jpg</a>

The databases were cca 85 GB.

So the only problem now seems to be how to get rid of the old data. Any hints?

Thanks, Jan

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09017.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#09361">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09361">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09362.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li><ul>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08894.html">Re: Re: Riak performance problems when Leve...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08924.html">Re: Re: Re: Riak performance problems w...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08927.html">Re: Riak performance problems when ...</a></span> <span class="sender italic">Eli Janssen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08930.html">Re: Re: Riak performance probl...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08948.html">Re: Riak performance problems when Leve...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08969.html">Re: Riak performance problems when ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08959.html">Re: Riak performance problems when LevelDB database ...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08970.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">István</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg09003.html">Re: Riak performance problems when LevelDB database ...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09017.html">Re: Riak performance problems when LevelDB data...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Re: Riak performance problems when LevelDB ...</span> <span class="sender italic">Jan.Evangelista</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09362.html">Re: Riak performance problems when LevelDB ...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09369.html">Re: Re: Riak performance problems when ...</a></span> <span class="sender italic">Jan.Evangelista</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Re: Riak performance problems when LevelDB database grows beyond 16GB">
<input type="hidden" name="msgid" value="1Nhr.2jUMm.7iemLu3IP1T.1GhFZJ@seznam.cz">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09361.html">
<input type="submit" value=" Jan.Evangelista ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Re%5C%3A+Riak+performance+problems+when+LevelDB+database+grows+beyond+16GB%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09017.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09362.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">1Nhr.2jUMm.7iemLu3IP1T.1GhFZJ@seznam.cz</li>
</ul>
</div>
</body>
</html>
