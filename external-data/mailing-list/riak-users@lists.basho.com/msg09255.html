<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: More Migration Questions</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09255" id="c">
<link rel="index" href="maillist.html#09255" id="i">
<link rel="prev" href="msg09251.html" id="p">
<link rel="next" href="msg09304.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09255.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+More+Migration+Questions%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: More Migration Questions</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shane+McEwan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shane McEwan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121109" rel="nofollow">Fri, 09 Nov 2012 07:17:00 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
OK, I've managed to answer one of my own questions:

</pre><tt>QUESTION: The new nodes don't own any of the partitions in the data 
</tt><tt>directory. What does it do?
</tt><pre style="margin: 0em;">
ANSWER: The nodes won't start. They crash with:
</pre><tt>{&quot;Kernel pid 
</tt><tt>terminated&quot;,application_controller,&quot;{application_start_failure,riak_core,{bad_return,{{riak_core_app,start,[normal,[]]},{'EXIT',{{function_clause,[{orddict,fetch,['riakjade@10.20.15.11',[{'riakmercury@10.20.11.168',[{{riak_core,vnode_routing},[legacy]}]},{'riakpyrite@10.20.11.169',[{{riak_core,vnode_routing},[legacy]}]},{'riaktopaz@10.20.11.170',[{{riak_core,vnode_routing},[legacy]}]}]],[{file,[111,114,100,100,105,99,116,46,101,114,108]},{line,72}]},{riak_core_capability,renegotiate_capabilities,1,[{file,[115,114,99,47,114,105,97,107,95,99,111,114,101,95,99,97,112,97,98,105,108,105,116,121,46,101,114,108]},{line,415}]},{riak_core_capability,handle_call,3,[{file,[115,114,99,47,114,105,97,107,95,99,111,114,101,95,99,97,112,97,98,105,108,105,116,121,46,101,114,108]},{line,208}]},{gen_server,handle_msg,5,[{file,[103,101,110,95,115,101,114,118,101,114,46,101,114,108]},{line,588}]},{proc_lib,init_p_do_apply,3,[{file,[112,114,111,99,95,108,105,98,46,101,114,108]},{line,227}]}]},{gen_server,c
</tt><pre style="margin: 0em;">
all,[riak_core_capability,{register,{riak_core,vnode_routing},{capability,[proxy,legacy],legacy,{riak_core,legacy_vnode_routing,[{true,legacy},{false,proxy}]}}},infinity]}}}}}}&quot;}</pre><pre>

Crash dump was written to: ./log/erl_crash.dump
</pre><tt>Kernel pid terminated (application_controller) 
</tt><tt>({application_start_failure,riak_core,{bad_return,{{riak_core_app,start,[normal,[]]},{'EXIT',{{function_clause,[{orddict,fetch,['riakjade@10.20.15.11',
</tt><pre style="margin: 0em;">

</pre><tt>I assume that's because none of the nodes mentioned in the ring file are 
</tt><tt>accessible.
</tt><pre style="margin: 0em;">

</pre><tt>Last night I thought I'd got it working! I used &quot;reip&quot; on all the nodes 
</tt><tt>and started them up. This time &quot;member-status&quot; reported that all the 
</tt><tt>nodes were valid. &quot;transfers&quot; showed partition handoff was happening. 
</tt><tt>Unfortunately, today we noticed that some data was missing from the 
</tt><tt>cluster. Upon investigation I found that I hadn't copied one of the data 
</tt><tt>directories correctly so one of the nodes actually started with an empty 
</tt><tt>data directory! The weird thing is if there's one node in the cluster 
</tt><tt>that hasn't needed to upgrade its data directory then the other nodes 
</tt><tt>seem to upgrade OK and we don't get the problem of one node being in 
</tt><tt>&quot;legacy&quot; state.
</tt><pre style="margin: 0em;">

Two other things we've tried:

</pre><tt>&quot;reip&quot; just the node we're going to start Riak on, start it up and then 
</tt><tt>replace the other nodes. Riak starts up but the &quot;force-replace&quot; fails with:
</tt><tt>13:11:53.540 [error] Forced node replacement failed 
</tt><tt>exit:{{nodedown,'riakamber@10.20.11.167'},{gen_server,call,[{riak_core_claimant,'riakamber@10.20.11.167'},{stage,'riakmercury@10.20.11.168',{force_replace,'riakjade@10.20.15.11'}},infinity]}}
</tt><pre style="margin: 0em;">
I'm not surprised because none of the nodes it's trying to talk to exist.

</pre><tt>Change the node name in vm.args to the old node and start it up then try 
</tt><tt>to replace the node with the new name. But we couldn't communicate with 
</tt><tt>the node because riak-admin uses the current node name to connect and it 
</tt><tt>wasn't valid.
</tt><pre style="margin: 0em;">

</pre><tt>The next thing we're about to do is install 1.1.1 on the new nodes, 
</tt><tt>&quot;reip&quot; the ring, start Riak and let it handoff any partitions it needs 
</tt><tt>to, shut it down, install 1.2.1, start it up and hope for the best. In 
</tt><tt>theory this &quot;rolling upgrade&quot; should work . . . assuming 1.1.1 &quot;reip&quot; 
</tt><tt>actually works.
</tt><pre style="margin: 0em;">

I'm really keen to hear from anyone with any suggestions.

On 08/11/12 21:10, Shane McEwan wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
G'day!

Just to add to the list of people asking questions about migrating to
1.2.1 . . .

We're about to migrate our 4 node production Riak database from 1.1.1 to
1.2.1. At the same time we're also migrating from virtual machines to
physical machines. These machines will have new names and IP addresses.

The process of doing rolling upgrades is well documented but I'm unsure
of the correct procedure for moving to an entirely new cluster.

We have the luxury of a maintenance window so we don't need to keep
everything running during the migration. Therefore the current plan is
to stop the current cluster, copy the Riak data directories to the new
machines and start up the new cluster. The hazy part of the process is
how we &quot;reip&quot; the database so it will work in the new cluster.

We've tried using the &quot;riak-admin reip&quot; command but were left with one
of our nodes in &quot;(legacy)&quot; mode according to &quot;riak-admin member-status&quot;.
From an earlier E-Mail thread[1] it seems like &quot;reip&quot; is deprecated and
we should be doing a &quot;cluster force replace&quot; instead.

So, would the new procedure be the following?

1. Shutdown old cluster
2. Copy data directory
3. Start new cluster (QUESTION: The new nodes don't own any of the
partitions in the data directory. What does it do?) (QUESTION: The new
nodes won't be part of a cluster yet. Do I need to &quot;join&quot; them before I
can do any of the following commands? Or do I just put all the joins and
force-replace commands into the same plan and commit it all together?)
3. Issue &quot;riak-admin cluster force-replace old-node1 new-node1&quot;
(QUESTION: Do I run this command just on &quot;new-node1&quot; or on all nodes?)
4. Issue &quot;force-replace&quot; commands for the remaining three nodes.
5. Issue a &quot;cluster plan&quot; and &quot;cluster commit&quot; to commit the changes.
6. Cross fingers.

In my mind the &quot;replace&quot; and/or &quot;force-replace&quot; commands are something
we would use it we had a failed node and needed to bring a spare online
to take over. It doesn't feel like something you would do if you don't
already have a cluster in place and are needing to &quot;replace&quot; ALL nodes.

Of course, we want to test this procedure before doing it for real. What
are the risks of doing the above procedure while the old cluster is
still running? While the new nodes are on a segregated network and
shouldn't be able to contact the old nodes what would happen if we did
the above and found the network wasn't as segregated as we originally
thought? Would the new nodes start trying to communicate with the old
nodes before the &quot;force-replace&quot; can take effect? Or, because all the
cluster changes are atomic there won't be any risk of that?

Sorry for all the questions. I'm just trying to get a clear procedure
for moving an entire cluster to new hardware and hopefully this thread
will help other people in the future.

Thanks in advance!

Shane.

[1] <a  rel="nofollow" href="http://comments.gmane.org/gmane.comp.db.riak.user/8418">http://comments.gmane.org/gmane.comp.db.riak.user/8418</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09251.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09255">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09255">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09304.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09251.html">More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: More Migration Questions</span> <span class="sender italic">Shane McEwan</span></li>
<li class="icons-email"><span class="subject"><a href="msg09304.html">Re: More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09305.html">Re: More Migration Questions</a></span> <span class="sender italic">Thomas Santero</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09314.html">Re: More Migration Questions</a></span> <span class="sender italic">Martin Woods</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09315.html">Re: More Migration Questions</a></span> <span class="sender italic">Matt Black</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09316.html">Re: More Migration Questions</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09318.html">Re: More Migration Questions</a></span> <span class="sender italic">Martin Woods</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: More Migration Questions">
<input type="hidden" name="msgid" value="509D1E64.2020008@mcewan.id.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09255.html">
<input type="submit" value=" Shane McEwan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+More+Migration+Questions%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09251.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09304.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">509D1E64.2020008@mcewan.id.au</li>
</ul>
</div>
</body>
</html>
