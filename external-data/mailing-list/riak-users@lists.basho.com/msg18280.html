<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Solr search response time spikes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#18280" id="c">
<link rel="index" href="maillist.html#18280" id="i">
<link rel="prev" href="msg18277.html" id="p">
<link rel="next" href="msg18284.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg18280.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Solr+search+response+time+spikes%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Solr search response time spikes</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Fred+Dushin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Fred Dushin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20170622" rel="nofollow">Thu, 22 Jun 2017 13:41:54 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>It's pretty strange that you are seeing no search latency measurements on node 
5.  Are you sure your round robining is working?  Are you favoring node 1?</pre><pre>

In general, I don't think which node you hit for query should make a 
difference, but I'd have to stare at the code some to be sure.  In essence, all 
the node that services the query does is convert the query into a sharded Solr 
query based on a coverage plan, which changes every minute or so, and then runs 
the sharded query on the local Solr node.  The Solr node then distributes the 
query to the rest of the nodes in the cluster, but that's all Solr comms -- 
Riak is out of the picture, by then.

Now, if you have a lot of sharded queries accumulating on one node, that might 
make a difference to Solr.  I am not a Solr expert, and I don't even play one 
on TV.  But maybe the fact that you are not hitting node 5 is relevant for that 
reason?

Can you do more analysis on your client, to make sure you are not favoring node 
1?

-Fred

&gt; On Jun 22, 2017, at 10:20 AM, sean mcevoy &lt;sean.mce...@gmail.com&gt; wrote:
&gt; 
&gt; Hi List,
&gt; 
&gt; We have a standard riak cluster with 5 nodes and at the minute the traffic 
&gt; levels are fairly low. Each of our application nodes has 25 client 
&gt; connections, 5 to each riak node which get selected in a round robin.
&gt; 
&gt; Our application level requests involve multiple riak requests so our traffic 
&gt; tends to make requests in small bursts. Everything works fine for KV gets, 
&gt; puts &amp; deletes but we're seeing timeouts &amp; weird response time spikes on solr 
&gt; search operations.
&gt; 
&gt; In the past 36 hours (the only period I have riak stats for) I see one 
&gt; response time of 38.8 seconds, 3 hours earlier a response time of 20.8 
&gt; seconds, and the third biggest spike is an acceptable 3.5 seconds.
&gt; 
&gt; See below all search_query stats for the minute of the 38 sec sample. In the 
&gt; application request we made 5 riak search requests to the same index in 
&gt; parallel, which happens for each request of this type and normally doesn't 
&gt; have an issue. But in this case all 5 timed out, and one timed out again on 
&gt; retry with the other 4 succeeding.
&gt; 
&gt; Anyone ever seen anything like this before? Is there any known deadlock in 
&gt; solr that I might hit if I make the same request on another connection before 
&gt; the first has completed? This is what we do when our riak client times out 
&gt; after 2 seconds and immediately retries.
&gt; 
&gt; Any advice or pointers welcomed.
&gt; Thanks,
&gt; //Sean.
&gt; 
&gt; 
&gt; Riak node 1
&gt; search_query_throughput_one: 14
&gt; search_query_throughput_count: 259
&gt; search_query_latency_min: 2776
&gt; search_query_latency_median: 69411
&gt; search_query_latency_mean: 4900973
&gt; search_query_latency_max: 38887902
&gt; search_query_latency_999: 38887902
&gt; search_query_latency_99: 38887902
&gt; search_query_latency_95: 2046215
&gt; search_query_fail_one: 0
&gt; search_query_fail_count: 0
&gt; 
&gt; Riak node 2
&gt; search_query_throughput_one: 22
&gt; search_query_throughput_count: 564
&gt; search_query_latency_min: 4006
&gt; search_query_latency_median: 8800
&gt; search_query_latency_mean: 11834
&gt; search_query_latency_max: 25509
&gt; search_query_latency_999: 25509
&gt; search_query_latency_99: 25509
&gt; search_query_latency_95: 24035
&gt; search_query_fail_one: 0
&gt; search_query_fail_count: 0
&gt; 
&gt; Riak node 3
&gt; search_query_throughput_one: 6
&gt; search_query_throughput_count: 298
&gt; search_query_latency_min: 3200
&gt; search_query_latency_median: 15391
&gt; search_query_latency_mean: 18062
&gt; search_query_latency_max: 31759
&gt; search_query_latency_999: 31759
&gt; search_query_latency_99: 31759
&gt; search_query_latency_95: 31759
&gt; search_query_fail_one: 0
&gt; search_query_fail_count: 0
&gt; 
&gt; Riak node 4
&gt; search_query_throughput_one: 8
&gt; search_query_throughput_count: 334
&gt; search_query_latency_min: 2404
&gt; search_query_latency_median: 7230
&gt; search_query_latency_mean: 10211
&gt; search_query_latency_max: 22502
&gt; search_query_latency_999: 22502
&gt; search_query_latency_99: 22502
&gt; search_query_latency_95: 22502
&gt; search_query_fail_one: 0
&gt; search_query_fail_count: 0
&gt; 
&gt; Riak node 5
&gt; search_query_throughput_one: 0
&gt; search_query_throughput_count: 0
&gt; search_query_latency_min: 0
&gt; search_query_latency_median: 0
&gt; search_query_latency_mean: 0
&gt; search_query_latency_max: 0
&gt; search_query_latency_999: 0
&gt; search_query_latency_99: 0
&gt; search_query_latency_95: 0
&gt; search_query_fail_one: 0
&gt; search_query_fail_count: 0
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg18277.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#18280">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#18280">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg18284.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg18277.html">Solr search response time spikes</a></span> <span class="sender italic">sean mcevoy</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Solr search response time spikes</span> <span class="sender italic">Fred Dushin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18284.html">Re: Solr search response time spikes</a></span> <span class="sender italic">sean mcevoy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg18308.html">Re: Solr search response time spikes</a></span> <span class="sender italic">sean mcevoy</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Solr search response time spikes">
<input type="hidden" name="msgid" value="0FDE5D10-516F-4B26-A2A2-9139EEA8D304@dushin.net">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg18280.html">
<input type="submit" value=" Fred Dushin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Solr+search+response+time+spikes%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg18277.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg18284.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">0FDE5D10-516F-4B26-A2A2-9139EEA8D304@dushin.net</li>
</ul>
</div>
</body>
</html>
