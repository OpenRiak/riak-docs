<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Connection Pooling with the python-riak-client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06389" id="c">
<link rel="index" href="maillist.html#06389" id="i">
<link rel="prev" href="msg06383.html" id="p">
<link rel="next" href="msg06391.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06389.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Connection Pooling with the python-riak-client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Michael+Clemmons%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Michael Clemmons</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120124" rel="nofollow">Tue, 24 Jan 2012 09:34:43 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Greg,
Your amazing thanks.  In my application its failing on the start of the
application, I do not believe while trying to do a request but its possible
let me grok and get back to you with some trace backs.
As far as Im aware to define more than one hostport with the client you
still have to hack the client.  Adding an optional hostports or servers
parameter would be simple.
Being able to define the connection manager as a kwarg might be a good
option.  If the intent is to define the conextmanager by subclassing the
transport, things make more sense.  I think for multiple nodes round robin
might be the most sane default for longterm or short term connections.
Thanks again for replying, I'll see what happens when I try this with
multiple live nodes, and get back with more thoughts.</pre><pre>

On Mon, Jan 23, 2012 at 7:08 PM, Greg Stein &lt;gst...@gmail.com&gt; wrote:

&gt; On Fri, Jan 20, 2012 at 15:53, Michael Clemmons &lt;glassresis...@gmail.com&gt;
&gt; wrote:
&gt; &gt;...
&gt; &gt; I've decided to go back and cleanup that approach and reapply it to the
&gt; &gt; current master branch.  To my surprise I found that the ConnectionManager
&gt; &gt; supports multiple connections and has the tools to add and remove them.
&gt; &gt; Looking at the simple case of the RiakHttpTransport layer and the
&gt; &gt; http_request method it looks like it should grab a new connection(or an
&gt; old
&gt; &gt; one) and try it and if it fails move on to the next putting the host port
&gt; &gt; pair at the bottom of the list.
&gt;
&gt; Right. That is the intent.
&gt;
&gt; I will note that a failure does not automatically remove a host/port
&gt; pair, but fails the particular request (after N retries). I'm not sure
&gt; that is entirely &quot;the best strategy&quot; (see below, ref: many
&gt; strategies), but the plumbing should be there for applications to
&gt; decide the proper behavior. It may be possible to decide a
&gt; best/default strategy so that (most) applications do not have to get
&gt; involved.
&gt;
&gt; &gt; So it looked like all I needed to do was update the client code to
&gt; accept a
&gt; &gt; list of hostport pairs and it would just work, which sounded too easy to
&gt; be
&gt; &gt; true.  I tested it anyways and if I use one hostport that is a working
&gt; riak
&gt; &gt; node it connects and everything works.  If I include 2 nodes one working
&gt; and
&gt; &gt; one a random port it fails no matter the order.  So its not just trying
&gt; to
&gt; &gt; connect to the first and failing its connecting to them all and failing
&gt; if
&gt; &gt; any fail.
&gt;
&gt; Well, yeah. You started the thing up, saying all the host/port pairs
&gt; were proper. It is telling you they are not :-)
&gt;
&gt; One question: when does the failure happen? At instantiation time, or
&gt; later at request time? On the first request, or some later request?
&gt;
&gt; (as I recall, it should lazy-open all host/port pairs, so the failure
&gt; should not happen until later... and only when the pair is attempted
&gt; to be used)
&gt;
&gt; &gt; Anyone have any idea of why its built this way and what other solutions
&gt;
&gt; The overall intent is to connect to (at least) one known working node.
&gt; That node can then be queried for &quot;all&quot; other known working nodes,
&gt; which are then added into the ConnectionManager (CM). The (long-lived)
&gt; process can then continue to monitor the status of the ring and make
&gt; corresponding updates to the CM.
&gt;
&gt; The code does not (yet) have a well-defined process for *removal* of
&gt; non-working nodes. That is a complex application-level decision.
&gt; Should it remove the host/port permanently? If it is just a network
&gt; glitch, or the particular host is have transient issues, then maybe
&gt; the pair should be kept around (but unused) and re-installed in a
&gt; minute or two when the host starts replying again. Maybe you just
&gt; remove the pair and wait for a general background monitoring thread to
&gt; note their existence and reinstall the pair.
&gt;
&gt; For a single-threaded, short-lived application, the multiple host/port
&gt; pair capability is not very useful. That functionality is really
&gt; necessary for multiple threads and/or long-lived processes. In this
&gt; scenario, as existing connections get used up, the CM will spin up new
&gt; connections for threads to use to perform their operations. (the
&gt; underlying connections are persistent and reused until the server
&gt; decides to close them, where the client will attempt to reopen and
&gt; reuse the connection again)
&gt;
&gt; What happens when you give the CM a list of *working* host/port pairs?
&gt; Does that still fail for you? It is true that when one goes down, then
&gt; some level of the stack should remove the pair, but &quot;which level&quot; just
&gt; hasn't been decided.
&gt;
&gt; There is also a &quot;monitor&quot; concept that has been sketched out in the
&gt; code, but not implemented. See riak/transports/monitor.py. That should
&gt; be used in a long-running application to periodically hit the riak
&gt; servers, querying what nodes are in the ring, and adding new ones and
&gt; removing broken ones. I sketched it out but neither myself nor anybody
&gt; else has further worked on such logic.
&gt;
&gt; &gt; people have worked out on their own?  My intent is to do this so it
&gt; merges
&gt; &gt; cleanly with the current master, and doesn't introduce unnecessary
&gt; change,
&gt; &gt; to increase the likelyhood of a successful pull request.
&gt;
&gt; For production code, some of this host/port pair management needs to
&gt; be done. It would be nice to have the monitor (thread) completed, but
&gt; that may not be appropriate for your application.
&gt;
&gt; I think that Brett's work on timeouts is necessary for production
&gt; code. The key decision point here is Python compatibility support. If
&gt; the library requires 2.7, then it should be quite easy to merge his
&gt; changes. I think (but don't recall offhand) that the timeout parameter
&gt; for HTTPConnection might be available in 2.6, but I definitely know it
&gt; is not available for Python 2.5. When I began my work on the client, I
&gt; was targeting 2.5 and made many compatibility changes with that in
&gt; mind. This was primarily to support my 2.5-based dev environment, even
&gt; though I was going to deploy to 2.7. I eventually upgraded my dev
&gt; environment, so compatibility isn't a huge concern for me any more. I
&gt; would leave that decision to the Basho folks, who are controlling the
&gt; decisions and guidance for the client.
&gt;
&gt; Hopefully, that gives you a good background on the current decision
&gt; and thoughts around it. I'd be more than happy to elaborate further on
&gt; the choices made... please just ask!
&gt;
&gt; Cheers,
&gt; -g
&gt;



-- 
-Michael
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06383.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06389">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06389">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06391.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06342.html">Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06343.html">Re: Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06344.html">Re: Connection Pooling with the python-riak-clie...</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg06383.html">Re: Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Connection Pooling with the python-riak-clie...</span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06391.html">Re: Connection Pooling with the python-riak-...</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06393.html">Re: Connection Pooling with the python-r...</a></span> <span class="sender italic">Michael Clemmons</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Connection Pooling with the python-riak-client">
<input type="hidden" name="msgid" value="CABfaNM4+vJLzLoc-dPaEbQKCNetsfxjM8hL5CGpA_Gw+=ciNzQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06389.html">
<input type="submit" value=" Michael Clemmons ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06383.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06391.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABfaNM4+vJLzLoc-dPaEbQKCNetsfxjM8hL5CGpA_Gw+=ciNzQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
