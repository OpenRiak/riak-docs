<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: simpler implementation of RiakMap</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16776" id="c">
<link rel="index" href="maillist.html#16776" id="i">
<link rel="prev" href="msg16768.html" id="p">
<link rel="next" href="msg16769.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16776.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+simpler+implementation+of+RiakMap%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: simpler implementation of RiakMap</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Alex+Moore%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex Moore</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151116" rel="nofollow">Mon, 16 Nov 2015 21:16:43 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey David,

So with the CRDT Map implementation, you can have a register, a counter, an
inner map, a set, and a flag embedded within a map, all with the same name
(oh my!).</pre><pre>

In the underlying API the map entry identifier is actually made of both the
name and the type, so you can pull off that bit of trickery.  You can see
this bleed through a little bit in the HTTP JSON API, where map field id's
are represented as &lt;name&gt;_&lt;type&gt; :

curl -XPOST 
<a  rel="nofollow" href="http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info">http://localhost:8098/types/maps/buckets/customers/datatypes/ahmed_info</a>
\ -H &quot;Content-Type: application/json&quot; \ -d ' { &quot;update&quot;: {
&quot;annika_info_map&quot;: { &quot;update&quot;: { &quot;first_name_register&quot;: &quot;Annika&quot;,
&quot;last_name_register&quot;: &quot;Weiss&quot;, &quot;phone_number_register&quot;: &quot;5559876543&quot; } } }
} '

Also since the API's been out for awhile now, doing the changes you listed
could break compatibility with other clients / users :-/

I'll take a look at getRegister and friends, and see if there's a better
way to implement them though.

Thanks,
Alex

On Fri, Nov 13, 2015 at 7:49 PM, David Byron &lt;dby...@dbyron.com&gt; wrote:

&gt; As I stare at the code for RiakMap in the riak-java-client (
&gt; <a  rel="nofollow" href="https://github.com/basho/riak-java-client/blob/develop/src/main/java/com/basho/riak/client/core/query/crdt/types/RiakMap.java">https://github.com/basho/riak-java-client/blob/develop/src/main/java/com/basho/riak/client/core/query/crdt/types/RiakMap.java</a>),
&gt; I have the urge for a simpler implementation.
&gt;
&gt; If I'm reading the code right, it looks like it handles a value of each
&gt; RiakDatatype for each key.  As in, it's possible for the same key in a map
&gt; to have all of a counter, map, flag, register and set value.
&gt;
&gt; If it turns out that the underlying data has only one of those, or perhaps
&gt; that I only care about one of those, it feels like
&gt;
&gt;     private final Map&lt;BinaryValue, List&lt;RiakDatatype&gt;&gt; entries =
&gt;         new HashMap&lt;BinaryValue, List&lt;RiakDatatype&gt;&gt;();
&gt;
&gt; could become
&gt;
&gt;    private final Map&lt;BinaryValue, RiakDatatype&gt; entries =
&gt;         new HashMap&lt;BinaryValue, RiakDatatype&gt;();
&gt;
&gt; What I'm getting at is that the code I'm writing to iterate over the
&gt; elements in a map is doing way more than I'd like.  For a map whose values
&gt; are all registers, I've got something like:
&gt;
&gt;   RiakMap myMap;
&gt;   for (BinaryValue key : myMap.view().keySet()) {
&gt;     RiakRegister register = myMap.getRegister(key);
&gt;   }
&gt;
&gt; which looks clean enough, but is busy under the covers.  I'm really
&gt; whining about the implementation of getRegister and friends:
&gt;
&gt; public RiakRegister getRegister(BinaryValue key)
&gt; {
&gt;   if (entries.containsKey(key)) {
&gt;     for (RiakDatatype dt : entries.get(key)) {
&gt;       if (dt.isRegister()) {
&gt;         return dt.getAsRegister();
&gt;       }
&gt;     }
&gt;   }
&gt;   return null;
&gt; }
&gt;
&gt; Because I'm iterating I already know the key is one of the entries, so
&gt; would you consider a patch with an unsafe* (or any other name) set of
&gt; accessors that assumes the key is present?  I could of course call view and
&gt; implement my own method, but I can't see how to take out the loop without
&gt; changing the underlying data structure for entries.
&gt;
&gt; If I'm iterating over lots and lots of keys (i.e. myMap.view().keySet()
&gt; contains lots and lots of elements), it might actually be enough savings to
&gt; notice.  In addition though, I think it's simpler enough to be helpful when
&gt; trying to read/understand the code.
&gt;
&gt; It is of course possible that the underlying data isn't what I expect, and
&gt; contains other data types too.  So a full implementation might need hints
&gt; from the caller about whether to use the more general/existing data
&gt; structure, or the simplified one...and then whether to fail in the face of
&gt; data that doesn't fit in the simplified one, or silently ignore it...or
&gt; ignore it but notify the caller that it's present...and probably other
&gt; stuff I haven't considered yet.
&gt;
&gt; I'd love to hear what you think about all of this.
&gt;
&gt; Thanks much for your help.
&gt;
&gt; -DB
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16768.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16776">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16776">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16769.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16768.html">simpler implementation of RiakMap</a></span> <span class="sender italic">David Byron</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: simpler implementation of RiakMap</span> <span class="sender italic">Alex Moore</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: simpler implementation of RiakMap">
<input type="hidden" name="msgid" value="CADjd2Tf_Qo3ByMu6OjKBh670OZQ6Fj9Ja3rzubL8g-3ye4o2XA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16776.html">
<input type="submit" value=" Alex Moore ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+simpler+implementation+of+RiakMap%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16768.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16769.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CADjd2Tf_Qo3ByMu6OjKBh670OZQ6Fj9Ja3rzubL8g-3ye4o2XA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
