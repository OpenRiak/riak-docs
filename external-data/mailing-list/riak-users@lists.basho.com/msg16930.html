<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: High CPU on a single node in production</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16930" id="c">
<link rel="index" href="maillist.html#16930" id="i">
<link rel="prev" href="msg16925.html" id="p">
<link rel="next" href="msg16923.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16930.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+High+CPU+on+a+single+node+in+production%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: High CPU on a single node in production</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Josh+Yudaken%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Josh Yudaken</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160107" rel="nofollow">Thu, 07 Jan 2016 18:08:54 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Fred,

That makes a lot of sense. Yes the server was under high indexing load
as the handoffs have all caused re-indexing. I'm going to drop
transfer-limit to 1 [from 2] across the board which will hopefully
reduce further issues.</pre><pre>

At the moment our cluster wants to perform a ton of handoffs, almost
moving every single vnode. See cluster status/handoff summary. I
attempted to reduce this but couldn't get the `cluster plan` lower so
eventually just resorted to committing it and letting riak slowly
churn through the transfers. I'll set up statistics on the vnode queue
lengths and see if it reveals anything interesting.

At this point in time we're primarily using Riak as a search engine,
and it doesn't feel production ready. Is there any time frame on being
&quot; a better solr citizen&quot;? We originally chose Riak over ElasticSearch
as we needed a key-value database and the &quot;search for free&quot; aspect was
great.. but it's becoming far more problematic than we believe simply
running two databases would be.

If you notice `riak33` in status/summary is down. Bringing it back up
causes the issues described, and ends up taking down our site within
five hours.

Regards,
Josh

===
Cluster status:
+------------------------------------------+------+-------+-----+-------+
|                   node                   |status| avail |ring |pending|
+------------------------------------------+------+-------+-----+-------+
| (C) riak@riak25-2.c.authbox-api.internal |valid |  up   |  8.3|  10.7 |
|     riak@riak26-2.c.authbox-api.internal |valid |  up   |  8.6|   9.3 |
|     riak@riak27-2.c.authbox-api.internal |valid |  up   | 10.4|  11.2 |
|     riak@riak28-2.c.authbox-api.internal |valid |  up   | 10.1|  10.0 |
|     riak@riak29-2.c.authbox-api.internal |valid |  up   | 11.3|  10.0 |
|     riak@riak30-2.c.authbox-api.internal |valid |  up   | 11.7|  10.1 |
|     riak@riak31-2.c.authbox-api.internal |valid |  up   | 11.5|   9.9 |
|     riak@riak32-2.c.authbox-api.internal |valid |  up   | 11.2|   9.8 |
|      riak@riak33.c.authbox-api.internal  |valid | down! | 10.1|  10.1 |
|      riak@riak35.c.authbox-api.internal  |valid |  up   |  6.8|   9.1 |
+------------------------------------------+------+-------+-----+-------+
===
Handoff summary:
+----------------------------------------+-----+---------+------+------+------+
|                  Node                  |Total|Ownership|Resize|Hinted|Repair|
+----------------------------------------+-----+---------+------+------+------+
|  riak@riak25-2.c.authbox-api.internal  |  0  | 0 (95)  |      |      |      |
|  riak@riak26-2.c.authbox-api.internal  |  1  | 1 (111) |      |      |      |
|  riak@riak27-2.c.authbox-api.internal  |  0  | 0 (118) |      |      |      |
|  riak@riak28-2.c.authbox-api.internal  |  0  | 0 (119) |      |      |      |
|  riak@riak29-2.c.authbox-api.internal  |  0  | 0 (122) |      |      |      |
|  riak@riak30-2.c.authbox-api.internal  |  1  | 1 (131) |      |      |      |
|  riak@riak31-2.c.authbox-api.internal  |  0  | 0 (138) |      |      |      |
|  riak@riak32-2.c.authbox-api.internal  |  0  | 0 (133) |      |      |      |
|   riak@riak35.c.authbox-api.internal   |  0  | 0 (97)  |      |      |      |
+----------------------------------------+-----+---------+------+------+------+

(unreachable): riak@riak33.c.authbox-api.internal
===



&gt; Hi Josh,
&gt;
&gt; Sorry for not getting back sooner.
&gt;
&gt; I am not entirely sure what is going on with your handoffs.  It could be that 
&gt; you have overloaded Solr with handoff activity, and that is causing vnodes to 
&gt; become unresponsive.  We are actively working on a fix for this, which allows 
&gt; vnodes to continue their work, even if Solr is taking its time with ingest.  
&gt; This also includes batching, with aggregates insertion (and deletion) 
&gt; operations into Solr, to smooth out some of the bumps, while at the same time 
&gt; being a better Solr citizen.
&gt;
&gt; The hundreds of entries you see on close trees seem to be due to the fact 
&gt; that your YZ AAE trees are in need of being rebuilt.  Can it be that you have 
&gt; hit the magic 7 day grace period on AAE tree expiry?  The index failures you 
&gt; see in the logs seem to be because the yz_entropy_mgr has been shut down.  
&gt; You are seeing this during a riak stop, correct?  Is the system under high 
&gt; indexing load, at the time?  That could account for the log messages, as 
&gt; index operations may be coming in while yokozuna is being shut down.
&gt;
&gt; Regarding ring resize, please have a look at 
&gt; <a  rel="nofollow" href="https://github.com/basho/yokozuna/issues/279">https://github.com/basho/yokozuna/issues/279</a> 
&gt; &lt;<a  rel="nofollow" href="https://github.com/basho/yokozuna/issues/279">https://github.com/basho/yokozuna/issues/279</a>&gt;.  I do not believe these 
&gt; issues have been rectified, so the official line is what you see in the 
&gt; documentation.  You can, of course, reindex your data after a ring resize, 
&gt; but that is not acceptable in a production scenario, if you have an SLA 
&gt; around search availability.
&gt;
&gt; Hope that helps, and let us know if you have any more information about what 
&gt; might be consuming CPU on your nodes.  I would keep a close eye on the vnode 
&gt; queue lengths in the Riak stats (riak_kv_vnodeq_(min|max|avg|mean|etc)).  If 
&gt; your vnode queues start getting deep, then vnodes are likely being blocked by 
&gt; Solr.
&gt;
&gt; -Fred

On Wed, Jan 6, 2016 at 2:11 PM, Luke Bakken &lt;lbak...@basho.com&gt; wrote:
&gt;&gt; We're planning on having a rather large cluster rather soon, which was
&gt;&gt; the reason for the large ring size. Your documentation indicates ring
&gt;&gt; resize is *not* possible with search 2.0 [1], although an issue I
&gt;&gt; found on github indicated it might be now? [2]
&gt;
&gt; Yeah, resize not applicable in your situation. Are you planning on
&gt; having 20 or more nodes eventually?
&gt;
&gt;&gt; I've been through the tuning list multiple times, and haven't seen any
&gt;&gt; changes
&gt;
&gt; So I'll assume the tunings have all been applied.
&gt;
&gt;&gt; I migrated the machine seeing issues to a new host, and now
&gt;&gt; the new host is seeing similar problems. Heres a screenshot of `htop`
&gt;&gt; just before I stopped the node in order to bring our site back up [3].
&gt;
&gt; Just so I'm clear, that &quot;htop&quot; output (<a  rel="nofollow" href="https://goo.gl/k8Wtcw">https://goo.gl/k8Wtcw</a>) is from
&gt; one node, correct? There shouldn't be more than one beam.smp process
&gt; running. Is this a per-thread view? Doesn't seem to be, with all the
&gt; different PIDs listed, but I've only ever used top or the varios &quot;sar&quot;
&gt; utilites.
&gt;
&gt; Thanks,
&gt; Luke

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16925.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16930">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16930">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16923.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16920.html">High CPU on a single node in production</a></span> <span class="sender italic">Josh Yudaken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16921.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16922.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Josh Yudaken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16924.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Fred Dushin</span></li>
<li class="icons-email"><span class="subject"><a href="msg16925.html">Re: High CPU on a single node in production</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: High CPU on a single node in production</span> <span class="sender italic">Josh Yudaken</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: High CPU on a single node in production">
<input type="hidden" name="msgid" value="CAMOY83970ss+nK4Y7LmFBO98cJKYf4S41c=J9SSrM1yrOMu0FQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16930.html">
<input type="submit" value=" Josh Yudaken ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+High+CPU+on+a+single+node+in+production%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16925.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16923.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAMOY83970ss+nK4Y7LmFBO98cJKYf4S41c=J9SSrM1yrOMu0FQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
