<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Active Anti Entropy with Bitcask Key Expiry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10936" id="c">
<link rel="index" href="maillist.html#10936" id="i">
<link rel="prev" href="msg10899.html" id="p">
<link rel="next" href="msg10900.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10936.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Active+Anti+Entropy+with+Bitcask+Key+Expiry%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Active Anti Entropy with Bitcask Key Expiry</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ryan+Zezeski%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ryan Zezeski</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130418" rel="nofollow">Thu, 18 Apr 2013 08:10:02 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Ben,

AAE should not resurrect keys when bitcask expiry is enabled.  However, a
non-trivial amount of work may be performed if a lot of keys expire all at
once.</pre><pre>

You're correct that the layers above bitcask have no notion of expiry.
 When a key expires no notification is sent to Riak.  This means that
hashtrees (which I'll call trees from here on out) will continue storing an
entry for a key after it has expired.  As long as all trees agree that the
key is still there AAE will be none the wiser about expiry.  However, AAE
has its own notion of expiry.  Every tree has en expiration date at which
point is is discarded and rebuilt from scratch based on the data in the
backend.  By default trees expire after a week.  This means there could be
a window where the trees disagree because some were rebuilt and no longer
include the expired key.  At this point AAE will try to repair the data by
invoking a read-repair.  Since bitcask honors expiry on 'get' all N copies
will return not_found and thus read-repair will do nothing.  Then AAE will
send a 'rehash' request to all N replicas [1] [2].  The rehash will notice
the key is no longer and delete it from the tree.

So, keys should not be resurrected, but it could generate additional I/O
proportional to the number of keys expired.  For example:

1. bitcask expiry is set to 1 day
2. millions of keys are written in hour time span thus every hour millions
of keys expire
3. the same key is never overwritten inside a weeks time
4. AAE is using default tree expiry of a week
5. the trees for a given preflist are _not_ all expired at about the same
time

In this scenario, when a tree expires it may have millions of expired keys
to deal with.  This means millions of Riak 'get' calls plus millions of
'rehash' calls.  Now, since the rehash operation is sent to all replicas
only 1 tree of a preflist needs to expire for all replica trees to be
repaired.  This means the maximum number of times you should take this hit
is Q / N where Q = ring size, N = n_val.

Point #3, #4, #5 really are the key here.  There must be an overlap where
keys are expired and only a subset of a preflist's trees have been rebuilt.
 The more often keys are re-written and the more nodes you have the less
likely it will be to hit this window.

-Z

[1]
<a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/master/src/riak_kv_exchange_fsm.erl#L232">https://github.com/basho/riak_kv/blob/master/src/riak_kv_exchange_fsm.erl#L232</a>

[2] <a  rel="nofollow" href="https://github.com/basho/riak_kv/blob/master/src/riak_kv_vnode.erl#L482">https://github.com/basho/riak_kv/blob/master/src/riak_kv_vnode.erl#L482</a>


On Tue, Apr 16, 2013 at 11:07 AM, Ben Murphy &lt;benmmur...@gmail.com&gt; wrote:

&gt; Does anyone know if these two place nice with each other? As far as I can
&gt; see the higher layers sitting on top of bitcask are not aware that bitcask
&gt; can expire keys. Would the anti-entropy code try to resurrect expired keys?
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10899.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10936">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10936">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10900.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10899.html">Active Anti Entropy with Bitcask Key Expiry</a></span> <span class="sender italic">Ben Murphy</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Active Anti Entropy with Bitcask Key Expiry</span> <span class="sender italic">Ryan Zezeski</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Active Anti Entropy with Bitcask Key Expiry">
<input type="hidden" name="msgid" value="CACZcpe=eOtssntiG8csBBsf6x5CQDUqOEsiDfX74UmnfSyjPvQ@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10936.html">
<input type="submit" value=" Ryan Zezeski ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Active+Anti+Entropy+with+Bitcask+Key+Expiry%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10899.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10900.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACZcpe=eOtssntiG8csBBsf6x5CQDUqOEsiDfX74UmnfSyjPvQ@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
