<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Bitcask Key Listing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#14751" id="c">
<link rel="index" href="maillist.html#14751" id="i">
<link rel="prev" href="msg14734.html" id="p">
<link rel="next" href="msg14758.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg14751.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Bitcask+Key+Listing%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Bitcask Key Listing</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jason+Campbell%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jason Campbell</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20140819" rel="nofollow">Tue, 19 Aug 2014 15:53:14 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hello Kelly,

Thanks for the detailed response, but I'm still a bit confused.  I understand 
the overhead over the covering set, and the key listing will only complete as 
fast as the slowest node.  The data transfer shouldn't be much for a small key 
set though.  So assuming we aren't doing something crazy like trying to stream 
billions of keys, it should be roughly the same speed as getting those keys 
from 1/3 of the nodes.</pre><pre>

As far as bitcask being unordered, I'm not sure how that is possible.  I 
understand it's on-disk format is log structured, which although ordered by 
last-modified time, is fairly useless for most purposes.  But in-memory it has 
to be able to satisfy requests for a random key name in fairly fixed time to 
meet the latency guarantees that are expected of it.  I would expect it to be 
some kind of search tree, in which case, it could be used to filter partial 
ranges (like a bucket lookup) just as easily as a full key lookup.  It could 
also be a hash of the key, at which point it would be useless for partial 
ranges, but then so would the bitcask memory calculator, as it would be a fixed 
size per record, not variable with the length of the bucket and key.

I don't know Erlang well enough to jump into the bitcask source, and the papers 
I have found explain the keydir and data structures well enough, but not how a 
request is able to look up a key in memory.  Is it using a b-tree?

Thanks,
Jason

----- Original Message -----
From: &quot;Kelly McLaughlin&quot; &lt;ke...@basho.com&gt;
To: &quot;Jason Campbell&quot; &lt;xia...@xiaclo.net&gt;, &quot;riak-users&quot; 
&lt;riak-users@lists.basho.com&gt;
Sent: Wednesday, 20 August, 2014 1:26:36 AM
Subject: Re: Bitcask Key Listing

Jason,

There are two aspects to to a key listing operation that make it 
expensive relative to normal gets or puts.

The first part is that, due to the way data is distributed in Riak, key 
listing requires a covering set of vnodes to participate in
order to determine the list of keys for a bucket. A minimal covering set 
of vnodes works out to 1/N nodes in the cluster where N
is the n_val of the bucket. By default this is 3 so in the default case 
a key listing request must send a request to and receive
responses from 1/3 of the nodes in the cluster. This incurs network 
traversal overhead as the keys from each vnode are returned
and the speed to completion is limited by the slowest vnode in the 
covering set. This is true regardless of the backend in use.

The second part is specific to bitcask. Bitcask is an unordered backend 
and the consequence of this when doing a key listing is
that all of the keys stored by a vnode that participates in a key 
listing request must be scanned. It doesn't matter if there are
2 keys or 2000 keys for the bucket being queried, they all must be 
scanned. This is a case where all the keys being stored in memory
is beneficial to performance, but as the amount of data stored increases 
so does the expense to scan over it. The leveldb backend is
ordered and we are able to take advantage of that fact to only scan over 
data for the bucket in question, but for bitcask that is
not an option.

At this time there is nothing in the works to specifically improve key 
listing performance. It is certainly something we are aware of,
but at this time there are other things with higher priority.

Hope that helps answer your question.


Kelly


On 08/19/2014 05:17 AM, Jaston Campbell wrote:
&gt; I currently maintain my own indexes for some things, and use natural keys 
&gt; where I can, but a question has been nagging me lately.
&gt;
&gt; Why is key listing slow?  Specifically, why is bitcask key listing slow?
&gt;
&gt; One of the biggest issues with bitcask is all keys (including the bucket name 
&gt; and some overhead) must fit into RAM.  For large amounts of keys, I 
&gt; understand the coordination data transfer will hurt, but shouldn't things 
&gt; like list buckets (or listing keys from small buckets) be fast?
&gt;
&gt; Is there a reason this is slow, and is there a plan to fix it?
&gt;
&gt; Thanks,
&gt; Jason
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg14734.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#14751">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#14751">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg14758.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg14732.html">Bitcask Key Listing</a></span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14734.html">Re: Bitcask Key Listing</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Bitcask Key Listing</span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg14758.html">Re: Bitcask Key Listing</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Bitcask Key Listing">
<input type="hidden" name="msgid" value="5142027.259.1408488686806.JavaMail.Jason@JasonWin8">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg14751.html">
<input type="submit" value=" Jason Campbell ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Bitcask+Key+Listing%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg14734.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg14758.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5142027.259.1408488686806.JavaMail.Jason@JasonWin8</li>
</ul>
</div>
</body>
</html>
