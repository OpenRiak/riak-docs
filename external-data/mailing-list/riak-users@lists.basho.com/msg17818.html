<!DOCTYPE html>
<html lang="en">
<head>
<title>Riak-CS issues when Riak endpoint fails-over to new server</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17818" id="c">
<link rel="index" href="maillist.html#17818" id="i">
<link rel="prev" href="msg17816.html" id="p">
<link rel="next" href="msg17827.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17818.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak%5C-CS+issues+when+Riak+endpoint+fails%5C-over+to+new+server%22&amp;o=newest" rel="nofollow"><span itemprop="name">Riak-CS issues when Riak endpoint fails-over to new server</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20161221" rel="nofollow">Wed, 21 Dec 2016 21:49:40 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,
We've been seeing some issues with Riak CS for a while in a specific
situation. Maybe you can advise if we're doing something wrong?</pre><pre>

Our setup has redundant haproxy instances in front of a cluster of riak
nodes, for both HTTP and PBC. The haproxy instances share a floating IP
address.
Only one node holds the IP, but if it goes down, another takes it up.

Our Riak CS nodes are configured to talk to the haproxy on that floating IP.

The problem occurs if the floating IP moves from one haproxy to another.

Suddenly we see a flurry of errors in riak-cs log files.

This is presumably because it was holding open TCP connections, and the new
haproxy instance doesn't know anything about them, so they get TCP RESET
and shutdown.

The problem is that riak-cs doesn't try to reconnect and retry immediately,
instead it just throws a 503 error back to the client. Who then retries,
but Riak-CS has a pool of a couple of hundred connections to cycle through,
all of which throw the error!

Does this sound like it is a likely description of the fault?
Do you have any ways to mitigate this issue in Riak CS when using TCP load
balancing above Riak PBC?

Toby
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17816.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17818">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17818">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17827.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Riak-CS issues when Riak endpoint fails-over to new server</span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17827.html">Re: Riak-CS issues when Riak endpoint fails-over to n...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17828.html">Re: Riak-CS issues when Riak endpoint fails-over ...</a></span> <span class="sender italic">Magnus Kessler</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17829.html">Re: Riak-CS issues when Riak endpoint fails-o...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17830.html">Re: Riak-CS issues when Riak endpoint fai...</a></span> <span class="sender italic">Shaun McVey</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17834.html">Re: Riak-CS issues when Riak endpoin...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17872.html">Riak CS race condition at start-...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17873.html">Re: Riak CS race condition a...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg17874.html">Re: Riak CS race condition a...</a></span> <span class="sender italic">Toby Corkindale</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Riak-CS issues when Riak endpoint fails-over to new server">
<input type="hidden" name="msgid" value="CABEgq9761sE40GV2F2O8Tm1=HUyTNVU1DQu0CZkxHA-hmroM7Q@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17818.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Riak%5C-CS+issues+when+Riak+endpoint+fails%5C-over+to+new+server%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17816.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17827.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABEgq9761sE40GV2F2O8Tm1=HUyTNVU1DQu0CZkxHA-hmroM7Q@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
