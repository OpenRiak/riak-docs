<!DOCTYPE html>
<html lang="en">
<head>
<title>Inconsistent cluster membership</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#11032" id="c">
<link rel="index" href="maillist.html#11032" id="i">
<link rel="prev" href="msg11030.html" id="p">
<link rel="next" href="msg11041.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11032.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Inconsistent+cluster+membership%22&amp;o=newest" rel="nofollow"><span itemprop="name">Inconsistent cluster membership</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Pavel+Kirienko%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Pavel Kirienko</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130506" rel="nofollow">Mon, 06 May 2013 03:30:46 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi everyone,

We recently updated our 4-node cluster from 1.2 to 1.3.1. The cluster used
to work somehow stable until updated.</pre><pre>

We did update in the following order:
1. Performed clean installation of Riak 1.3.1 on the first node
(192.168.0.2) (thus, the Riak settings and data directory were wiped out);
2. Connected the first node to the rest of cluster;
3. Updated the other three nodes to 1.3.1, leaving data directories
unchanged.

We use Ubuntu Server 12.04 on the first node and 10.04 on the others;
backend is LevelDB.

When the update was done, we could see that every node had been connected
to the cluster and everything was fine:
Status     Ring    Pending    Node
-------------------------------------------------------------------------------
valid      25.0%      --      'riak@192.168.0.3'
valid      25.0%      --      'riak@192.168.0.2'   &lt;-- first node
valid      25.0%      --      'riak@192.168.0.4'
valid      25.0%      --      'riak@192.168.0.6'
-------------------------------------------------------------------------------
Valid:4 / Leaving:0 / Exiting:0 / Joining:0 / Down:0


A week later the first node detached from the cluster by it's own, and now
member-status on the first node shows that:
Status     Ring    Pending    Node
-------------------------------------------------------------------------------
valid     100.0%      --      'riak@192.168.0.2'
-------------------------------------------------------------------------------
Valid:1 / Leaving:0 / Exiting:0 / Joining:0 / Down:0


However, other nodes say that they are still participate in the full
cluster:
Status     Ring    Pending    Node
-------------------------------------------------------------------------------
joining    25.0%      --      'riak@192.168.0.3'
valid      25.0%      --      'riak@192.168.0.2'   &lt;-- first node
valid      25.0%      --      'riak@192.168.0.4'
valid      25.0%      --      'riak@192.168.0.6'
-------------------------------------------------------------------------------
Valid:3 / Leaving:0 / Exiting:0 / Joining:1 / Down:0


Despite the fact that the node 192.168.0.2 is said to be detached
(according to its member-status output), its data is still available
throughout the cluster:

$ curl -XPOST <a  rel="nofollow" href="http://192.168.0.2:8098/buckets/test/keys/foo">http://192.168.0.2:8098/buckets/test/keys/foo</a> -d BAR
$ curl <a  rel="nofollow" href="http://192.168.0.2:8098/buckets/test/keys/foo">http://192.168.0.2:8098/buckets/test/keys/foo</a>
BAR
$ curl <a  rel="nofollow" href="http://192.168.0.3:8098/buckets/test/keys/foo">http://192.168.0.3:8098/buckets/test/keys/foo</a>
BAR


Here are the questions:
1. Why member-status output on different nodes is inconsistent, and what to
do about it?
2. Sometimes the first node returns error &quot;{insufficient_vnodes,0,need,2}&quot;
on read queries. This error goes away for few days when the node restarted.
I suspect that this has some relation to the first question.
3. Node on 192.168.0.3 is desperately trying to join the cluster for at
least 10 days, still no luck. (overall data size is about 60GB, network is
100Mbit Ethernet)

Which additional info may help?

As I said before, things went wrong when the cluster was updated to 1.3.1.
So, maybe the right way to fix these problems is to install 1.3.1 cleanly,
then restore the data from backup?

Thanks in advance!
Pavel.
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11030.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#11032">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#11032">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11041.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Inconsistent cluster membership</span> <span class="sender italic">Pavel Kirienko</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11041.html">Re: Inconsistent cluster membership</a></span> <span class="sender italic">Joe Caswell</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Inconsistent cluster membership">
<input type="hidden" name="msgid" value="CAGfq0uuwdF-AWW70YJgP-UbTiJVa2nja_EUTxr4WtSi2c6A1rg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11032.html">
<input type="submit" value=" Pavel Kirienko ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Inconsistent+cluster+membership%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11030.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11041.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAGfq0uuwdF-AWW70YJgP-UbTiJVa2nja_EUTxr4WtSi2c6A1rg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
