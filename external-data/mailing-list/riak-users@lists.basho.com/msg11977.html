<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: riak core dumped, merge_index corruption?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd12.html#11977" id="c">
<link rel="index" href="mail12.html#11977" id="i">
<link rel="prev" href="msg11919.html" id="p">
<link rel="next" href="msg11921.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11977.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+core+dumped%2C+merge_index+corruption%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: riak core dumped, merge_index corruption?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Deyan+Dyankov%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Deyan Dyankov</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130812" rel="nofollow">Mon, 12 Aug 2013 05:49:55 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Ryan,

sorry for the late reply. We are running 1.3.2 and after deleting the buffer.* 
files, riak started. However, running the riak_search_vnode:repair( P ) 
resulted in plenty of errors like:
[…]
2013-08-08 16:36:08.261 [error] &lt;0.1938.0&gt; Supervisor mi_buffer_converter_sup 
had child ignored started with mi_buffer_converter:start_link(&lt;0.8157.0&gt;, 
&quot;/storage/riak/merge_index/1050454301831586472458898473514828420377701515264&quot;, 
{buffer,&quot;/storage/riak/merge_index/1050454301831586472458898473514828420377701515264/buffer.12&quot;,...})
 at &lt;0.30960.49&gt; exit with reason 
{mi_segment,segment_already_exists,&quot;/storage/riak/merge_index/1050454301831586472458898473514828420377701515264/segment.12&quot;}
 in context child_terminated
[…]</pre><pre>

As our Riak Search app isn't yet critical, I decided to do a rolling restart 
with rm -rf /storage/riak/merge_index/* on each node. The KV (leveldb) + MR 
functionality was working and new keys were properly indexed by Riak search. 
All I had to do was rewrite old keys in Riak search in order to reindex them. 
So everything is working now.

I am now performing a migration to Riak 1.4.1. My initial idea was to use 
yokozuna but I noticed that it's bundled for 1.4.0 only and I'd rather have the 
fixes that come with 1.4.1. So I guess that we'll have to wait a bit more for 
it.

Thanks for the help!

regards,
Deyan

On Aug 6, 2013, at 11:49 PM, Ryan Zezeski &lt;rzeze...@basho.com&gt; wrote:

&gt; Deyan,
&gt; 
&gt; What Riak version are you running?  There was a corruption issue discovered 
&gt; and fixed in the 1.4.0 release.
&gt; 
&gt; <a  rel="nofollow" href="https://github.com/basho/riak/blob/riak-1.4.0/RELEASE-NOTES.md#issues--prs-resolved">https://github.com/basho/riak/blob/riak-1.4.0/RELEASE-NOTES.md#issues--prs-resolved</a>
&gt; <a  rel="nofollow" href="https://github.com/basho/merge_index/pull/30">https://github.com/basho/merge_index/pull/30</a>
&gt; 
&gt; As for fixing, you'll want to delete the buffer files for the partitions 
&gt; which are having issues.  E.g. if you look in crash.log you'll see partition 
&gt; numbers for the crashing vnodes.
&gt; 
&gt; &gt; **      Data  == 
&gt; &gt; {state,685078892498860742907977265335757665463718379520,riak_search_vnode,undefined,undefined,none,undefined,undefined,undefined,undefined,0}
&gt; 
&gt; In the 
&gt; /storage/riak/merge_index/685078892498860742907977265335757665463718379520 
&gt; you'll see buffer files.  You'll want to delete those.  After deleting all 
&gt; these bad buffers Riak Search should start fine.  You'll then want to upgrade 
&gt; to 1.4.1 to avoid corruption in the future.  Finally, since you have to 
&gt; delete the buffers you'll have missing indexes and you'll want to re-index 
&gt; your data.
&gt; 
&gt; Since only one of your nodes experience corruption you can use the built-in 
&gt; repair functionality to re-index only data for those partitions.  First 
&gt; you'll want to attach to one of your nodes.  Then for each partition run the 
&gt; following.
&gt; 
&gt; &gt; riak_search_vnode:repair(P)
&gt; 
&gt; Make sure to run repair for only one partition at a time to avoid overloading 
&gt; anything.
&gt; 
&gt; To determine when a repair is finished you can periodically call the 
&gt; following.  Once it returns 'no_repair' that indicates it has finished.
&gt; 
&gt; &gt; riak_search_vnode:repair_status(P)
&gt; 
&gt; Here is more information on the repair command.
&gt; 
&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/cookbooks/Repairing-Search-Indexes/">http://docs.basho.com/riak/latest/cookbooks/Repairing-Search-Indexes/</a>
&gt; 
&gt; 
&gt; -Z
&gt; 
&gt; 
&gt; 
&gt; On Tue, Aug 6, 2013 at 5:17 AM, Deyan Dyankov &lt;dyan...@cloudxcel.com&gt; wrote:
&gt; hi,
&gt; 
&gt; we have a 3 node cluster and one of the node crashed yesterday.
&gt; Nodes are db1, db2 and db3. We started other services on db1 and db2 and db1 
&gt; crashed. Currently db2 and db3 are fine, balanced, receiving writes and 
&gt; serving reads.
&gt; However, db1 has issues starting. When I start the node, it outputs numerous 
&gt; errors and this finally results in a core dump. We use Riak search and this 
&gt; may be the reason for the dump. After starting the node, these are the first 
&gt; errors that are seen in the log file:
&gt; 
&gt; […]
&gt; 2013-08-06 11:06:08.989 [info] &lt;0.7.0&gt; Application erlydtl started on node 
&gt; 'r...@db1.locations.cxl-cdn.net'
&gt; 2013-08-06 11:06:16.675 [warning] &lt;0.5010.0&gt; Corrupted posting detected in 
&gt; /storage/riak/merge_index/456719261665907161938651510223838443642478919680/buffer.598
&gt;  after reading 2281
&gt; 49 bytes, ignoring remainder.
&gt; 2013-08-06 11:06:18.922 [error] &lt;0.5310.0&gt; CRASH REPORT Process &lt;0.5310.0&gt; 
&gt; with 0 neighbours exited with reason: bad argument in call to 
&gt; erlang:binary_to_term(&lt;&lt;131,108,0,0,0,1,10
&gt; 4,4,104,3,109,0,0,0,25,99,120,108,101,118,101,110,116,115,95,99,97,107,101,...&gt;&gt;)
&gt;  in mi_buffer:read_value/2 line 162 in gen_server:init_it/6 line 328
&gt; 2013-08-06 11:06:20.751 [error] &lt;0.5309.0&gt; gen_fsm &lt;0.5309.0&gt; in state 
&gt; started terminated with reason: no function clause matching 
&gt; riak_search_vnode:terminate({{badmatch,{error,{b
&gt; adarg,[{erlang,binary_to_term,[&lt;&lt;131,108,0,0,0,1,104,4,104,3,109,0,0,0,25,...&gt;&gt;],...},...]}}},...},
&gt;  undefined) line 233
&gt; […]
&gt; 
&gt; Attached is an archive of the /var/log/riak directory. The logs there are for 
&gt; the latest starting attempt. Riak core dumped in a minute or two after being 
&gt; started.
&gt; Is there a way to fix the merge index corruption and start the node?
&gt; 
&gt; thank you for your efforts,
&gt; Deyan
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11919.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd12.html#11977">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail12.html#11977">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11921.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11919.html">Re: riak core dumped, merge_index corruption?</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: riak core dumped, merge_index corruption?</span> <span class="sender italic">Deyan Dyankov</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: riak core dumped, merge_index corruption?">
<input type="hidden" name="msgid" value="3DCFCC99-6D88-46F9-8EF3-CB9EE0926D9C@cloudxcel.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11977.html">
<input type="submit" value=" Deyan Dyankov ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+riak+core+dumped%2C+merge_index+corruption%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11919.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11921.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">3DCFCC99-6D88-46F9-8EF3-CB9EE0926D9C@cloudxcel.com</li>
</ul>
</div>
</body>
</html>
