<!DOCTYPE html>
<html lang="en">
<head>
<title>debugging riak behavior by looking at the network</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07251" id="c">
<link rel="index" href="maillist.html#07251" id="i">
<link rel="prev" href="msg07250.html" id="p">
<link rel="next" href="msg07258.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07251.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22debugging+riak+behavior+by+looking+at+the+network%22&amp;o=newest" rel="nofollow"><span itemprop="name">debugging riak behavior by looking at the network</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Dietrich+Featherston%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Dietrich Featherston</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120419" rel="nofollow">Thu, 19 Apr 2012 17:25:32 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hey guys,

I just wrote a new blog post debugging some issues I'm seeing with riak by
looking at the network. Lots of words and pretty pictures here:
<a  rel="nofollow" href="http://blog.boundary.com/2012/04/19/hungry-kobayashi-pt1/">http://blog.boundary.com/2012/04/19/hungry-kobayashi-pt1/</a></pre><pre>

What seems to be happening is that cleanup tasks in our app eventually
become the primary workload of the cluster (our app is using the
riak-java-client+pb 1.0.3 btw). Those cleanup tasks look like the following.

1. Look in the 2i $key index for keys that fall within a known range (never
really takes more than 7s or so)
2. Sequentially delete those keys from the app (takes several minutes in
the worst case)

Eventually this becomes the primary workload of the cluster and individual
deletion latencies grow (more detailed measurements on the shape of this
degradation are forthcoming if that is helpful).

We are using riak 1.1 directly from
<a  rel="nofollow" href="https://github.com/basho/riak/tree/1.1with">https://github.com/basho/riak/tree/1.1with</a> the eleveldb backend. The
eleveldb specific configuration follows, but
fiddling with these settings hasn't noticeably impacted behavior we've
seen. Planning to set delete_mode to immediate and see if that helps.

Here's some other info that might be helpful but feel free to ask for
anything else.

N = 3 (changing to 2) on 9 physical nodes w 32GB memory each

Our leveldb config looks like this:

 %% eLevelDB Config
 {eleveldb, [
             {data_root, &quot;/srv/riak/leveldb&quot;},
             {max_open_files, 400},
             {block_size, 262144},
             {cache_size, 1932735280},
             {sync, false}
            ]},

Changes we've considered making to avoid the need for cleanup tasks:
- use the bitcask backend and have it handle key expiration for us (can't
because our keys definitely won't fit in memory)
- round-robin keys to avoid cleanup tasks and make the applications smart
enough to translate logical keys (time) into stored keys (0-N) -- this is
time-series data. unsure how leveldb would respond to overwriting keys this
way.
- write a custom backend or riak_core app for storage

Comments appreciated as I dig into this.

Thanks,
D
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07250.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07251">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07251">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07258.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">

</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="debugging riak behavior by looking at the network">
<input type="hidden" name="msgid" value="CAHQXTbEDpWQ-cStkysAf_UsxJ21SRoPRbiQrH0iadhNCV=XH7Q@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07251.html">
<input type="submit" value=" Dietrich Featherston ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22debugging+riak+behavior+by+looking+at+the+network%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07250.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07258.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAHQXTbEDpWQ-cStkysAf_UsxJ21SRoPRbiQrH0iadhNCV=XH7Q@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
