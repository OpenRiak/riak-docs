<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: 'not found' after join</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03229" id="c">
<link rel="index" href="maillist.html#03229" id="i">
<link rel="prev" href="msg03228.html" id="p">
<link rel="next" href="msg03231.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03229.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%27not+found%27+after+join%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: 'not found' after join</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kresten+Krab+Thorup%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kresten Krab Thorup</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110505" rel="nofollow">Thu, 05 May 2011 01:05:33 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've also been asking for this, and the current master has code to remedy these 
things, but it's not in an official release yet.</pre><pre>

At Erlang level, you can specify options to a RiakClient:get as follows


-type option() :: {r, pos_integer()} |         %% Minimum number of successful 
responses
                  {pr, non_neg_integer()} |    %% Minimum number of primary 
vnodes participating
                  {basic_quorum, boolean()} |  %% Whether to use basic quorum 
(return early
                                               %% in some failure cases.
                  {notfound_ok, boolean()}  |  %% Count notfound reponses as 
successful.
                  {timeout, pos_integer() | infinity}. %% Timeout for vnode 
responses

And so to get the semantics I think you're asking for, do GET (assuming N=3) 
with

[{r,2},{pr, 2}, {basic_quorum, false}, {notfound_ok, true}]

So this will work as you want as long as there is only one node down.

During handoff you may see a new kind of error

HTTP 503 / {error r_value_unsatisfied ...}

which  is the behavior when basic quorum is disabled, i.e. the alternative to 
getting a notfound just because there was some node which did not have the 
value.

Each of those are also available as query parameters when doing a HTTP get.

curl <a  rel="nofollow" href="http://127.0.0.1:8091/riak/buck/key?r=2&amp;basic_quorum=false&amp;notfound_ok=true">http://127.0.0.1:8091/riak/buck/key?r=2&amp;basic_quorum=false&amp;notfound_ok=true</a>

I'm also looking forward to a release which has this, and I'm hoping that the 
defaults can somehow be simplified / strengthened so people new to this don't 
need to be so surprised about these things.

Kresten

On May 5, 2011, at 8:18 AM, Greg Nelson wrote:

I just added node #5 to our cluster, and once again the experience during the 
subsequent 60-minute handoff period was pretty awful!  I just don't understand 
why this would be expected behavior while adding a node.  There doesn't seem to 
be any realistic way to join a node to an online cluster.  As far as I'm 
concerned this is a huge defect in Riak.

Read-repair didn't seem to kick in immediately for data.  My application was 
configured to retry GETs (with a few seconds of backoff), and still got 404s.  
I manually requested an object repeatedly for over 20 minutes until finally 
getting a result.

I think bug #992 (<a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=992">https://issues.basho.com/show_bug.cgi?id=992</a>) describes the 
defect, but I'm wondering if there is more to it than this?  Especially since 
read-repair didn't quite seem to work.

Could what Daniel describes on that bug (&quot;Only return not found when all vnodes 
have reported not found (or error)&quot;) be implemented as a configurable option?  
Maybe something one could kick in when a node joins until all handoffs are 
complete?

What we can do to remedy this before I add node #6, #7, etc.  We're storing 
huge amounts of data, which means that a) we'll be adding nodes often, and b) 
the amount of data handoff will be large, which means long periods of handoff 
where we don't want to have downtime.

Greg

On Tuesday, May 3, 2011 at 2:30 AM, Nico Meyer wrote:

Hi everyone,

I just want to note that I observed similar behaviour with a somewhat
larger clusters of 10 or so nodes. I first noticed that handoff activity
after node join (or leave for that matter) involved a lot more
partitions than I would have expected. By comparing the old and the new
ring file, I found out that more than 80 percent of partitions had to be
moved to another node.
My naive expectation was that joining a node to a cluster of size X
would result in roughly ring_creation_size/(X+1) partitions to be handed
off, which would also be the minimum if one expects a balanced cluster
afterwards.
Furthermore it would in theory be possible to move partitions in such a
way that at least one partition from each preflist stays on the same
node. Maybe for X&gt;N it should even be possible to guarantee this for a
basic quorum of each preflist, eliminating the notfound problem
completely, but I am not sure about that.

I may be able to provide some ring files to analyze this behaviour if
someone from basho is interested.

Cheer Nico

Am Montag, den 02.05.2011, 23:14 -0400 schrieb Ryan Zezeski:
Greg,


Your expectations are fair, just because you added a node doesn't mean
Riak should return notfounds. Unfortunately, we aren't quite there
yet. This is a side effect of how Riak currently implements handoff
in that it immediately updates/gossips the ring causing
many partitions to handoff immediately. If a request comes in that
relies on these partitions then it will get a notfound and perform
read repair. You're situation is multiplied by the fact that you are
going from 3 nodes to 4. More vnode shuffling occurs because of the
small cluster size.


We're well aware of this and have it on our radar for improvement in a
future release.


All this said, you data will be eventually consistent. That is, all
your data will eventually be handed off and things will work as
normal. It's only during the handoff that you _may_ encounter
notfounds. In this case it would be best to add a new node to your
cluster at lowest load times and if you can spare additional hardware
a few more nodes to start with is an even easier option.


-Ryan

On Mon, May 2, 2011 at 9:48 PM, Greg Nelson 
&lt;gro...@dropcam.com&lt;<a  rel="nofollow" href="mailto:gro...@dropcam.com">mailto:gro...@dropcam.com</a>&gt;&gt;
wrote:
Hello riak users!


I have a 4 node cluster that started out as 3 nodes.
ring_creation_size = 2048, target_n_val is default (4), and
all buckets have n_val = 3.


When I joined the 4th node, for a few minutes some GETs were
returning 'not found' for data that was already in riak.
Eventually the data was returned, due to read repair I would
assume. Is this expected? It seems that 'not found' and read
repairs should only happen when something goes wrong, like a
node goes down. Not when adding a node to the cluster, which
is supposed to be part of normal operation!


Any help or insight is appreciated!


Greg

________________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

&lt;ATT00001..txt&gt;


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03228.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03229">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03229">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03231.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03191.html">'not found' after join</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03192.html">Re: 'not found' after join</a></span> <span class="sender italic">siculars</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03193.html">Re: 'not found' after join</a></span> <span class="sender italic">Greg Nelson</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg03194.html">Re: 'not found' after join</a></span> <span class="sender italic">Aphyr</span></li>
<li class="icons-email"><span class="subject"><a href="msg03195.html">Re: 'not found' after join</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03196.html">Re: 'not found' after join</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03197.html">Re: 'not found' after join</a></span> <span class="sender italic">Greg Nelson</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg03198.html">Re: 'not found' after join</a></span> <span class="sender italic">Nico Meyer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03228.html">Re: 'not found' after join</a></span> <span class="sender italic">Greg Nelson</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: 'not found' after join</span> <span class="sender italic">Kresten Krab Thorup</span></li>
<li class="icons-email"><span class="subject"><a href="msg03231.html">Re: 'not found' after join</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03232.html">Re: 'not found' after join</a></span> <span class="sender italic">John D. Rowell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03233.html">Re: 'not found' after join</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03234.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Ben Tilly</span></li>
<li class="icons-email"><span class="subject"><a href="msg03235.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Ben Tilly</span></li>
<li class="icons-email"><span class="subject"><a href="msg03236.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li class="icons-email"><span class="subject"><a href="msg03237.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Andy Gross</span></li>
<li class="icons-email"><span class="subject"><a href="msg03239.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Mike Oxford</span></li>
<li class="icons-email"><span class="subject"><a href="msg03244.html">Re: 'not found' after jo...</a></span> <span class="sender italic">John D. Rowell</span></li>
<li class="icons-email"><span class="subject"><a href="msg03240.html">Re: 'not found' after jo...</a></span> <span class="sender italic">Ben Tilly</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: 'not found' after join">
<input type="hidden" name="msgid" value="2E57701E-AF71-41D6-8868-D8AC79D9DA39@trifork.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03229.html">
<input type="submit" value=" Kresten Krab Thorup ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+%27not+found%27+after+join%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03228.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03231.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">2E57701E-AF71-41D6-8868-D8AC79D9DA39@trifork.com</li>
</ul>
</div>
</body>
</html>
