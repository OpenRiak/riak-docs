<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: May allow_mult cause DoS?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd5.html#13280" id="c">
<link rel="index" href="mail5.html#13280" id="i">
<link rel="prev" href="msg13277.html" id="p">
<link rel="next" href="msg13281.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg13280.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+May+allow_mult+cause+DoS%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: May allow_mult cause DoS?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Viable+Nisei%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Viable Nisei</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131217" rel="nofollow">Tue, 17 Dec 2013 20:33:29 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>On Wed, Dec 18, 2013 at 8:32 AM, Erik Søe Sørensen &lt;e...@trifork.com&gt; wrote:</pre><pre>

&gt; It really is not a good idea to use siblings to represent 1-to-many
&gt; relations. That's not what it's intended for, nor what it's optimized for...
&gt;
Ok, understood.


&gt; Can you tell us exactly why you need Bitcask rather than LevelDB? 2i would
&gt; probably do it.
&gt;
1) According to
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/running/backups/#LevelDB-Backups">http://docs.basho.com/riak/latest/ops/running/backups/#LevelDB-Backups</a> ,
it's real pain to implement backups with leveldb.
2) According to
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/ops/advanced/backends/leveldb/">http://docs.basho.com/riak/latest/ops/advanced/backends/leveldb/</a> , reads
may be slower comparing to bitcask, it's critical for us

Otherwise, storing a list of items under each key could be a solution,
&gt; depending of course on the number of items per key. (But do perform
&gt; conflict resolution.)
&gt;
Why any conflict resolving is required? As far as I understood, with
allow_mult=true riak should just collect all the values written to key
without anything additional work? What design decision leads to exponential
slowdown and crashes when multiple values allowed for any single key?.. So,
what's the REAL purpose of allow_mult=true if it's bad idea to use it for
unlimited values per single key?

Ok, documentation contains the following paragraph:

&gt; Sibling explosion occurs when an object rapidly collects siblings without
being reconciled. This can lead to a myriad of issues. Having an enormous
object in your node can cause reads of that object to crash the entire
node. Other issues are increased cluster latency as the object is
replicated and out of memory errors.

But there is no point if it related to allow_mult=false or both cases.

So, the only solution is leveldb+2i?


On Wed, Dec 18, 2013 at 8:32 AM, Erik Søe Sørensen &lt;e...@trifork.com&gt; wrote:

&gt; It really is not a good idea to use siblings to represent 1-to-many
&gt; relations. That's not what it's intended for, nor what it's optimized for...
&gt; Can you tell us exactly why you need Bitcask rather than LevelDB? 2i would
&gt; probably do it.
&gt; Otherwise, storing a list of items under each key could be a solution,
&gt; depending of course on the number of items per key. (But do perform
&gt; conflict resolution.)
&gt; /Erik
&gt;
&gt;
&gt;
&gt; -------- Oprindelig meddelelse --------
&gt; Fra: Viable Nisei &lt;vsni...@gmail.com&gt;
&gt; Dato:
&gt; Til: riak-users@lists.basho.com
&gt; Emne: May allow_mult cause DoS?
&gt;
&gt;
&gt; Hi.
&gt;
&gt; Recently we've described that something is going unexpectedly. We are
&gt; using Riak 1.4.2 with some buckets with allow_mult=true.
&gt; We've tried our app under load then found that... concurrently writes into
&gt; bucket with allow_mult turning Riak into irresponsible slowpoke and even
&gt; crash it.
&gt;
&gt; Core i3 with 4GB RAM performs only 20 writes/sec with 5 client threads
&gt; writing 20 short strings into 20 keys in bucket with allow_mult=true,
&gt; search=false. With 40 values per 40 keys it performs only 6 writes/sec.
&gt; 60x60 cause riak crash?
&gt; Throughput drops drastically. Ok, we've not chaged concurrency factor (5)
&gt; and increased our data set 4x, but why throughput drops?
&gt; Ok, we increase our dataset linear, 20 strings * 20 keys, 40 strings*20
&gt; keys,  60 strings*20 keys... Results will be same - exponential throughput
&gt; drop with crash at end.
&gt;
&gt; Cluster of five Amazon EC2 cc2.8xlarge nodes becomes irresponsibly with
&gt; throughput 1-5 writes/sec with only 80-100 values per 1-10 keys.
&gt;
&gt; So, we think it is very strange.
&gt;
&gt; Here you can check our code sample (in java) reproducing this behavior:
&gt; <a  rel="nofollow" href="https://bitbucket.org/vsnisei/riak-allow_mult_wtf">https://bitbucket.org/vsnisei/riak-allow_mult_wtf</a>
&gt;
&gt; So, we have asked Basho about this, but they said that &quot;we think SQLish&quot;
&gt; and asked us for $5k for 2-days consultation to resolve our problem.
&gt; So, I've decided to ask here if we are really so stupid and not able to
&gt; understood some simple things or Basho didn't understood us correctly?..
&gt;
&gt; Anyway, looks like that some DoS/DDoS attack approach utilizing this
&gt; behavior may be proposed. We should only know that some
&gt; service/appliation/website is using Riak with allow_mult buckets then
&gt; provoke concurrent writes into them...
&gt;
&gt; Actually our question to Basho was broader. Our application needs to
&gt; implement 1-many bindings. Riak allows the following approaches to
&gt; simultate such bindings, according to documentation:
&gt;
&gt;  1.  Riak search - but we've found that it's VERY slow (20x performance
&gt; drop when search enabled, even for simple objects like {source_id: xxx,
&gt; target_id: yyy}, also we've found that search is not really scalable -
&gt; adding new nodes into cluster not increasing throughput, but even slows
&gt; cluster down...
&gt;  2.  secondary indexes. But, according to docs, they are working only on
&gt; LevelDb, but we need Bitcask
&gt;  3.  Link walking. But, according to docs, it's &quot;rest only operation&quot; and
&gt; in java driver it's implemented as a hack
&gt;  4.  allow_mult. But we've found that it's just a nightmare. So we told
&gt; Basho about this and given link to our example, but they didn't given us
&gt; any feedback
&gt;  5.  Bucket keys enumeration. But, according to docs, this operation
&gt; causes full keys scan on each node and must not be used in production
&gt;  6.  Mapred queries. Ok, we didn't tried them yet, maybe it's silver
&gt; bullet, really. But according to docs (and common sense) mapred causes
&gt; full-scan (for bucket at least. Or for all keys?) and it's operation with
&gt; unpredictable latency.
&gt;
&gt; So, where we are wrong? Is everything ok with behavior I've described? Are
&gt; we misunderstood Riak completely and should pay $5k for some
&gt; mind-expansion, or there is no any hidden mystical knowledge and they will
&gt; not say us anything excepting approaches listed above?
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg13277.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd5.html#13280">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail5.html#13280">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13281.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg13268.html">May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13270.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Reid Draper</span></li>
<li class="icons-email"><span class="subject"><a href="msg13273.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Brian Roach</span></li>
<li class="icons-email"><span class="subject"><a href="msg13277.html">RE: May allow_mult cause DoS?</a></span> <span class="sender italic">Erik Søe Sørensen</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: May allow_mult cause DoS?</span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13281.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13289.html">Fwd: May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13292.html">SV: May allow_mult cause DoS?</a></span> <span class="sender italic">Rune Skou Larsen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13297.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Viable Nisei</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13298.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Andy Gross</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13302.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13307.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13312.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Jason Campbell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13313.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">Andrew Stone</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg13314.html">Re: May allow_mult cause DoS?</a></span> <span class="sender italic">John Daily</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: May allow_mult cause DoS?">
<input type="hidden" name="msgid" value="CAHdY28fCB_MyjwzABExfOykKoqeN-eMp8AYP1ngz-Hf4_CmVvA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg13280.html">
<input type="submit" value=" Viable Nisei ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+May+allow_mult+cause+DoS%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg13277.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13281.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAHdY28fCB_MyjwzABExfOykKoqeN-eMp8AYP1ngz-Hf4_CmVvA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
