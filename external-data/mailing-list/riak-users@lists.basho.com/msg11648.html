<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Quickly deleting + recreating item in Riak deletes new item</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd14.html#11648" id="c">
<link rel="index" href="mail13.html#11648" id="i">
<link rel="prev" href="msg11578.html" id="p">
<link rel="next" href="msg11657.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11648.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Quickly+deleting+%5C%2B+recreating+item+in+Riak+deletes+new+item%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Quickly deleting + recreating item in Riak deletes new item</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kelly+McLaughlin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kelly McLaughlin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130719" rel="nofollow">Fri, 19 Jul 2013 18:50:28 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Matthew,

I did some testing with your code and I was able to reproduce what you were
seeing. I would occasionally see an error similar to the following:</pre><pre>

    Failed to fetch item 460 err Object not found

This behavior is a result of the trade-offs of using an eventually
consistent database like Riak. It is not the case that your inserts are
failing to write or the data is being lost, but what is actually happening
is that the quick read after writing with the default request options does
not provide any guarantee that you will read your writes. So basically when
you make the read, the replicas that are responding to your request have
not seen the latest value yet and so you end up with &quot;Not Found&quot; as the
response. If you did another read attempt for one of those objects reported
missing, it would succeed because Riak's read-repair would have kicked in
to make sure each replica has the value. To increase the likelihood of
reading your writes you should set the optional request parameters pr and
pw to ensure that all of the primary replicas are available prior to
performing a read or write request. I altered your code to use those
options and put the updates in a gist [1] (it's my first stab at Go so my
changes may not be very idiomatic). Additionally I changed to riak driver
so that NotFoundOk was false instead of true. With these changes I was able
to run the test 50 times in a row with no errors where previously I would
see at least one error every 10 iterations or so. Hope that helps.

[1] : <a  rel="nofollow" href="https://gist.github.com/kellymclaughlin/6041109">https://gist.github.com/kellymclaughlin/6041109</a>

Kelly


On Wed, Jul 17, 2013 at 4:07 PM, Matthew Dawson &lt;matt...@mjdsystems.ca&gt;wrote:

&gt; On July 17, 2013 08:45:01 AM Kelly McLaughlin wrote:
&gt; &gt; Matthew,
&gt; &gt;
&gt; &gt; I find it really surprising that you don't see any difference in behavior
&gt; &gt; when you set delete_mode to keep. I think it would be helpful if you
&gt; could
&gt; &gt; outline your specific setup and give the steps to reproduce what you're
&gt; &gt; seeing to be able to make a determination if this represents a bug or
&gt; not.
&gt; &gt; Thanks.
&gt; &gt;
&gt; &gt; Kelly
&gt; Hi Kelly,
&gt;
&gt; Sure, no problem.  Hardware wise, I have:
&gt;  - An AMD Phenom II X6 Desktop with 16G memory, and a HDD with an SSD
&gt; cache.
&gt;  - An Intel Ivy Bridge Dual Core (+HT) Laptop with 16G memory and SSD.
&gt; Both have lots of free memory + disk space for running my tests, and my
&gt; Desktop never seems to be IO bound.  Both machines are connected over
&gt; Ethernet
&gt; on the same LAN.
&gt;
&gt; On top of that hardware, both are running two instances of Riak each, all
&gt; forming one 4 node cluster.  I'm using the default ring size of 64.  I've
&gt; also
&gt; upgraded all the nodes to the latest release, 1.4, using the 1.4 tag from
&gt; Git.
&gt; I'm not using this to seriously benchmark Riak, so I don't think this setup
&gt; should cause any issues.  I'm also going to setup a really cluster for
&gt; production use, so ring size is not a concern.
&gt; Each Riak instance uses LevelDB as the datastore, Riak Search is disabled.
&gt; I'm using Riak's PB API for access, and I've bumped up the backlog
&gt; parameter
&gt; to 1024 for now.  Originally my program would connect to a single node, but
&gt; recently I've been playing with HAProxy locally, and now I use that to
&gt; connect
&gt; to all four instances.  The problem existed before I implemented HAProxy.
&gt; Riak Control is also enabled on one node per computer.
&gt;
&gt; For my application, it effectively stores in Riak two pieces of
&gt; information.
&gt; First it stores a list of keys associated with an object, and then stores
&gt; an
&gt; individual item at each key.  I limit the number of keys to 10000 per
&gt; object.
&gt;
&gt; For my test suite, I automatically clean up after each test by listing all
&gt; the
&gt; keys associated with a bucket, and then delete each key individually.  I
&gt; only
&gt; store items in two buckets, so this cleans the slate before each run.
&gt;
&gt; The test that has the high chance of failing is testing how the system
&gt; deals
&gt; with inserting 10000 items against one object.  The key list remains below
&gt; 1M.
&gt; Occasionally I see other tests fail, but I think this one fails more often
&gt; as
&gt; it stresses the entire system the most.  If I stop the automatic cleanup,
&gt; the
&gt; not found key is also not findable by Curl either.
&gt;
&gt; Before posting, I would delete and insert keys, without using a vclock.  I
&gt; had
&gt; figured this was safe as I ran with allow_mult=true on both buckets, and I
&gt; implemented conflict resolution first.  As suggested on this list, I now
&gt; have
&gt; the 10000 item test suite use vclocks from start to finish.  However, I
&gt; still
&gt; see this behaviour.
&gt;
&gt; I've attached a program (written in go as that is what I'm using) to this
&gt; email which triggers the behaviour.  As far as I understand Riak, it is
&gt; properly fetching vclocks whenever possible.  The library I'm using
&gt; (located
&gt; at: github.com/tpjg/goriakpbc ) was just recently updated to ensure that
&gt; vclocks are fetched, even if the item is deleted.  I am using an up to date
&gt; version of the library.  The program is acts similarly to my app, but
&gt; paired
&gt; down as far as possible.  Note that this behaviour is unpredictable, and
&gt; this
&gt; program will sometimes execute fine.
&gt; I only tested this program against the default delete_mode setting.  Also,
&gt; using HAProxy seems to trigger the issue far more readily, but it happens
&gt; fine
&gt; without it.
&gt;
&gt;
&gt; If there is any other information I can provide to help, let me know.
&gt;
&gt; Thanks,
&gt; --
&gt; Matthew
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11578.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd14.html#11648">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail13.html#11648">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11657.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11523.html">Re: Quickly deleting + recreating item in Riak deletes ne...</a></span> <span class="sender italic">Seth Bunce</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11535.html">Re: Quickly deleting + recreating item in Riak delet...</a></span> <span class="sender italic">Matthew Dawson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11539.html">Re: Quickly deleting + recreating item in Riak d...</a></span> <span class="sender italic">Gabriel Littman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11543.html">Re: Quickly deleting + recreating item in Ri...</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li class="icons-email"><span class="subject"><a href="msg11548.html">Re: Quickly deleting + recreating item in Ri...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li class="icons-email"><span class="subject"><a href="msg11549.html">Re: Quickly deleting + recreating item in Ri...</a></span> <span class="sender italic">Matthew Dawson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11553.html">Re: Quickly deleting + recreating item i...</a></span> <span class="sender italic">Gabriel Littman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11562.html">Re: Quickly deleting + recreating i...</a></span> <span class="sender italic">Matthew Dawson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11572.html">Re: Quickly deleting + recreati...</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li class="icons-email"><span class="subject"><a href="msg11578.html">Re: Quickly deleting + recreati...</a></span> <span class="sender italic">Matthew Dawson</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Quickly deleting + recreati...</span> <span class="sender italic">Kelly McLaughlin</span></li>
<li class="icons-email"><span class="subject"><a href="msg11657.html">Re: Quickly deleting + recreati...</a></span> <span class="sender italic">Matthew Dawson</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg11527.html">Re: Quickly deleting + recreating item in Riak deletes ne...</a></span> <span class="sender italic">Andrew Thompson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11534.html">Re: Quickly deleting + recreating item in Riak delet...</a></span> <span class="sender italic">Matthew Dawson</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Quickly deleting + recreating item in Riak deletes new item">
<input type="hidden" name="msgid" value="CAK3SJOg1n9wKQw+t4JGyFT8_jnFEY8Wh6bAqLz7GQqLnF_9Yyw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11648.html">
<input type="submit" value=" Kelly McLaughlin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Quickly+deleting+%5C%2B+recreating+item+in+Riak+deletes+new+item%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11578.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11657.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAK3SJOg1n9wKQw+t4JGyFT8_jnFEY8Wh6bAqLz7GQqLnF_9Yyw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
