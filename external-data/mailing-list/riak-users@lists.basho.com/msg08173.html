<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Deletion followed by re-addition leads to siblings when it	shouldn't</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08173" id="c">
<link rel="index" href="maillist.html#08173" id="i">
<link rel="prev" href="msg08172.html" id="p">
<link rel="next" href="msg08192.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08173.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Deletion+followed+by+re%5C-addition+leads+to+siblings+when+it%09shouldn%27t%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Deletion followed by re-addition leads to siblings when it	shouldn't</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Sean+Cribbs%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sean Cribbs</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120803" rel="nofollow">Fri, 03 Aug 2012 04:50:06 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Kaspar,

Your code creates siblings because:</pre><pre>

1) When a key is deleted, Riak creates a tombstone (with a vector clock)
that is not reaped from storage immediately.
2) When store a new value without correlating it to an old value, it is
treated as having the &quot;empty&quot; vector clock and creates a sibling.

So in the siblings returned, one should be &quot;deleted&quot; and the other should
be your new value. You should be able to linearize this sequence by keeping
around the IRiakObject you fetched in the second step, and issuing the
delete and second store passing that object or its vector clock. I'm not
sure how that applies to the Java client, but that is the general strategy
in these cases.

On Fri, Aug 3, 2012 at 2:48 AM, Kaspar Thommen &lt;kaspar.thom...@gmail.com&gt;wrote:

&gt; Anyone please?
&gt; On Jul 28, 2012 6:59 PM, &quot;Kaspar Thommen&quot; &lt;kaspar.thom...@gmail.com&gt;
&gt; wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; I ran the following Java snippet that creates a bucket, stores a
&gt;&gt; key/value pair in it, deletes the key, and adds a new value for that same
&gt;&gt; key. The n-value is 3 and all r- and w-values are also set to 3 to ensure
&gt;&gt; full consistency (for testing only). Here's the code:
&gt;&gt;
&gt;&gt;     public static void main(String[] args) throws Exception {
&gt;&gt;         IRiakClient riak = RiakFactory.pbcClient();
&gt;&gt;         try {
&gt;&gt;             // store an object in a new bucket
&gt;&gt;             Bucket testBucket =
&gt;&gt; riak.createBucket(&quot;testBucket&quot;).nVal(3).allowSiblings(true).execute();
&gt;&gt;             testBucket.store(&quot;key&quot;, &quot;value1&quot;).w(3).execute();
&gt;&gt;
&gt;&gt; System.out.println(testBucket.fetch(&quot;key&quot;).r(3).execute().getValueAsString());
&gt;&gt;  // prints 'value1'
&gt;&gt;
&gt;&gt;             // now delete it and store another object with the same key
&gt;&gt;             testBucket.delete(&quot;key&quot;).r(3).w(3).execute();
&gt;&gt;             testBucket.store(&quot;key&quot;, &quot;value2&quot;).w(3).execute();
&gt;&gt;
&gt;&gt; System.out.println(testBucket.fetch(&quot;key&quot;).r(3).execute().getValueAsString());
&gt;&gt;  // throws 'UnresolvedConflictException: Siblings found'
&gt;&gt;
&gt;&gt;         } finally {
&gt;&gt;             riak.shutdown();
&gt;&gt;         }
&gt;&gt;     }
&gt;&gt;
&gt;&gt; As you can see by the comment I have added to the code fetching the key a
&gt;&gt; second time should, in my opinion, return the new value, but it fails
&gt;&gt; because there are siblings. Maybe I didn't fully understand how sibling
&gt;&gt; handling works, but I don't see how there can possibly be any siblings
&gt;&gt; given that r and w are 3. Any pointers? I tried the LevelDB and memory
&gt;&gt; backends, same result.
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Kaspar
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;


-- 
Sean Cribbs &lt;s...@basho.com&gt;
Software Engineer
Basho Technologies, Inc.
<a  rel="nofollow" href="http://basho.com/">http://basho.com/</a>
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08172.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08173">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08173">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08192.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08109.html">Deletion followed by re-addition leads to siblings when it ...</a></span> <span class="sender italic">Kaspar Thommen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08172.html">Re: Deletion followed by re-addition leads to siblings...</a></span> <span class="sender italic">Kaspar Thommen</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Deletion followed by re-addition leads to sibl...</span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08192.html">Re: Deletion followed by re-addition leads to ...</a></span> <span class="sender italic">Kaspar Thommen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08193.html">Re: Deletion followed by re-addition leads...</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08194.html">Re: Deletion followed by re-addition ...</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08197.html">Re: Deletion followed by re-addit...</a></span> <span class="sender italic">Kaspar Thommen</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg08196.html">Re: Deletion followed by re-addition leads...</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Deletion followed by re-addition leads to siblings when it	shouldn't">
<input type="hidden" name="msgid" value="CAHsw=e2UOoxL=NY=XcZ55CEsfhCZWcwbZYty0sZt1khnvCK68Q@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08173.html">
<input type="submit" value=" Sean Cribbs ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Deletion+followed+by+re%5C-addition+leads+to+siblings+when+it%09shouldn%27t%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08172.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08192.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAHsw=e2UOoxL=NY=XcZ55CEsfhCZWcwbZYty0sZt1khnvCK68Q@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
