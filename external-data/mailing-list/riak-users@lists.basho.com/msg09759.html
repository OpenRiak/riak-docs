<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Same MR query, different results every run...........</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09759" id="c">
<link rel="index" href="maillist.html#09759" id="i">
<link rel="prev" href="msg09753.html" id="p">
<link rel="next" href="msg09746.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09759.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Same+MR+query%2C+different+results+every+run...........%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Same MR query, different results every run...........</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Christian+Dahlqvist%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Christian Dahlqvist</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130108" rel="nofollow">Tue, 08 Jan 2013 00:20:43 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi David,

Is it always the same entry that is missing from the result set? If so, does 
the issue go away if you issue a read request for the record(s) causing 
problems (resulting in read-repair)?</pre><pre>

If this is the case, the cause of the problem might be explained by how 
MapReduce works in Riak.

In Riak, map phases are sent to a covering set of vnodes, and are executed 
where the data resides. When data is read in order to be passed in to the map 
phase, only the data stored on that vnode is considered (effectively a read 
with R=1 - not the default R value specified for the bucket). If all vnodes do 
not have the same version of the data, I believe it is possible the results may 
vary slightly between runs if the covering sets differ.

Best regards,

Christian



On 7 Jan 2013, at 23:33, David Montgomery &lt;davidmontgom...@gmail.com&gt; wrote:

&gt; Hi,
&gt; 
&gt; i do have a reduce phase
&gt; 
&gt; 
&gt; On Tue, Jan 8, 2013 at 12:08 AM, Mridul Kashatria &lt;mri...@readwhere.com&gt; 
&gt; wrote:
&gt; Hi,
&gt; 
&gt; If I am correct, adding a reduce function should return the same number of 
&gt; items.
&gt; 
&gt; I'm a riak noob but I faced some similar issue while testing with a map 
&gt; function only. Adding a reduce fixed it.
&gt; 
&gt; I believe as the map fans out to multiple nodes, whichever node returns data 
&gt; first is written to output and not collected by a reduce stage.
&gt; 
&gt; Please correct me if I'm wrong.
&gt; 
&gt; Thanks
&gt; 
&gt; --
&gt; Mridul
&gt; 
&gt; 
&gt; 
&gt; On Sunday 06 January 2013 11:07 AM, David Montgomery wrote:
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; Here is my my mapper...
&gt;&gt; 
&gt;&gt; query.map('''
&gt;&gt;     function(value, keyData, arg) {
&gt;&gt;     
&gt;&gt;         if(value.length == 0){
&gt;&gt;            return [];
&gt;&gt;         }else{
&gt;&gt;             var data = Riak.mapValuesJson(value)[0];
&gt;&gt;             var obj = {};
&gt;&gt;             if(data['campaign_id']=='%s'){
&gt;&gt;                 try{
&gt;&gt;                     var alt_key = data['ckid'] + '||' + data['gid'] + '||' + 
&gt;&gt; data['ts_hms'];  
&gt;&gt;                 }
&gt;&gt;                 catch(err){
&gt;&gt;                     var alt_key = 'error';
&gt;&gt;                 }
&gt;&gt;                 obj[alt_key] = 1;
&gt;&gt;                 return [ obj ];
&gt;&gt;             }else{
&gt;&gt;                return [];
&gt;&gt;             }
&gt;&gt;         }
&gt;&gt;     }''' % campaign_id)
&gt;&gt; 
&gt;&gt; When I run  the the query repeatedly, over and over, about every 2 seconds I 
&gt;&gt; get the below.  A few times I get 14 rows and a few times I get 13 then back 
&gt;&gt; to 14 etc.  So.....why?  There should be no variation.  I have a three node 
&gt;&gt; cluster, two cores, 4 gigs or ram on ubuntu 12.06 using the latest riak.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; TOTAL: 14
&gt;&gt; 3dc3f58f-faea-4751-94b5-8a9a076d4b3f||CAESEGYMM1Q34DV8Ev0i12IVKdY||2012-12-31
&gt;&gt;  08:36:21 1
&gt;&gt; b4d82fa0-5cd4-4813-a150-554ebca30f1f||CAESEM98NHldIIyAzY0CIUnKudw||2013-01-04
&gt;&gt;  06:18:37 1
&gt;&gt; 8743af22-a664-4b60-ac59-b79d52c12e9e||CAESEH2PIdEYXvk3Dsg2_vF6Qcc||2013-01-04
&gt;&gt;  09:13:30 1
&gt;&gt; cef36621-527c-4b7a-be6f-5842e13a1350||CAESEHsyPPSizUsT-j31I-nCLzQ||2013-01-05
&gt;&gt;  12:50:22 1
&gt;&gt; 663fb22d-c60d-46b7-8b5b-c9be103c2084||CAESEDtHYmtttm7DBCRpCSU9zYE||2013-01-04
&gt;&gt;  08:55:06 1
&gt;&gt; e2b6afda-b838-48d5-a449-7b568b9f6b04||CAESEBciJaIqccs2584wIgdsOqc||2013-01-04
&gt;&gt;  04:02:13 1
&gt;&gt; 66aa05fe-9c55-43b2-93ae-c8cb19d097d7||CAESEBuVyK-X_iNGaiiLhPsT0TE||2013-01-02
&gt;&gt;  01:29:38 1
&gt;&gt; 0969a7ca-4324-4118-9038-b6fc11f08a36||CAESENwCD1bw1VvtIamGBCUl_zk||2013-01-02
&gt;&gt;  00:55:01 1
&gt;&gt; f78b77f6-a08c-4f07-b982-7b2cdcefba4f||CAESEJiWNlcbRN7Sx9o2FB7fbaU||2012-12-29
&gt;&gt;  05:22:46 1
&gt;&gt; 8050e5a7-1583-459a-983f-55feaf0e2a6c||CAESED2NyW9XDEbiKb1UD4sTzvI||2013-01-05
&gt;&gt;  12:18:59 1
&gt;&gt; 58b84566-ad3a-4a3f-91bd-1c61986fbadb||CAESELQcGkigDvXrtRDgOlw9rX0||2013-01-04
&gt;&gt;  16:19:25 1
&gt;&gt; 0db77e8d-ed94-43cf-8860-b4e43dfa24aa||CAESECbwN7VY6o8om79mZ905GIA||2013-01-02
&gt;&gt;  16:15:34 1
&gt;&gt; 67e79552-7e06-44bd-9e95-87f7cb634de3||CAESEFA6fd_C1PBslKgOj6_BI28||2012-12-29
&gt;&gt;  05:23:11 1
&gt;&gt; ffc3c6ae-beee-4dfe-b41d-ec3a72bddf67||CAESEN_MAXs55jCPIwuyvfTZIZc||2012-12-28
&gt;&gt;  07:56:03 1
&gt;&gt; 
&gt;&gt; 
&gt;&gt; TOTAL: 13
&gt;&gt; b4d82fa0-5cd4-4813-a150-554ebca30f1f||CAESEM98NHldIIyAzY0CIUnKudw||2013-01-04
&gt;&gt;  06:18:37 1
&gt;&gt; 8743af22-a664-4b60-ac59-b79d52c12e9e||CAESEH2PIdEYXvk3Dsg2_vF6Qcc||2013-01-04
&gt;&gt;  09:13:30 1
&gt;&gt; cef36621-527c-4b7a-be6f-5842e13a1350||CAESEHsyPPSizUsT-j31I-nCLzQ||2013-01-05
&gt;&gt;  12:50:22 1
&gt;&gt; 663fb22d-c60d-46b7-8b5b-c9be103c2084||CAESEDtHYmtttm7DBCRpCSU9zYE||2013-01-04
&gt;&gt;  08:55:06 1
&gt;&gt; e2b6afda-b838-48d5-a449-7b568b9f6b04||CAESEBciJaIqccs2584wIgdsOqc||2013-01-04
&gt;&gt;  04:02:13 1
&gt;&gt; 66aa05fe-9c55-43b2-93ae-c8cb19d097d7||CAESEBuVyK-X_iNGaiiLhPsT0TE||2013-01-02
&gt;&gt;  01:29:38 1
&gt;&gt; 0969a7ca-4324-4118-9038-b6fc11f08a36||CAESENwCD1bw1VvtIamGBCUl_zk||2013-01-02
&gt;&gt;  00:55:01 1
&gt;&gt; f78b77f6-a08c-4f07-b982-7b2cdcefba4f||CAESEJiWNlcbRN7Sx9o2FB7fbaU||2012-12-29
&gt;&gt;  05:22:46 1
&gt;&gt; 8050e5a7-1583-459a-983f-55feaf0e2a6c||CAESED2NyW9XDEbiKb1UD4sTzvI||2013-01-05
&gt;&gt;  12:18:59 1
&gt;&gt; 58b84566-ad3a-4a3f-91bd-1c61986fbadb||CAESELQcGkigDvXrtRDgOlw9rX0||2013-01-04
&gt;&gt;  16:19:25 1
&gt;&gt; 3dc3f58f-faea-4751-94b5-8a9a076d4b3f||CAESEGYMM1Q34DV8Ev0i12IVKdY||2012-12-31
&gt;&gt;  08:36:21 1
&gt;&gt; 67e79552-7e06-44bd-9e95-87f7cb634de3||CAESEFA6fd_C1PBslKgOj6_BI28||2012-12-29
&gt;&gt;  05:23:11 1
&gt;&gt; 0db77e8d-ed94-43cf-8860-b4e43dfa24aa||CAESECbwN7VY6o8om79mZ905GIA||2013-01-02
&gt;&gt;  16:15:34 1
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09753.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09759">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09759">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09746.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09739.html">Same MR query, different results every run...........</a></span> <span class="sender italic">David Montgomery</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09745.html">Re: Same MR query, different results every run......</a></span> <span class="sender italic">Mridul Kashatria</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09753.html">Re: Same MR query, different results every ru...</a></span> <span class="sender italic">David Montgomery</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Same MR query, different results ever...</span> <span class="sender italic">Christian Dahlqvist</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Same MR query, different results every run...........">
<input type="hidden" name="msgid" value="B17DA1B6-E48C-4D58-A225-7BF0BE9EF28C@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09759.html">
<input type="submit" value=" Christian Dahlqvist ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Same+MR+query%2C+different+results+every+run...........%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09753.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09746.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">B17DA1B6-E48C-4D58-A225-7BF0BE9EF28C@basho.com</li>
</ul>
</div>
</body>
</html>
