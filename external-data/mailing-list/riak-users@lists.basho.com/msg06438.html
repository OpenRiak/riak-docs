<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Very (very) slow handoff, how to investigate?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd6.html#06438" id="c">
<link rel="index" href="mail6.html#06438" id="i">
<link rel="prev" href="msg06437.html" id="p">
<link rel="next" href="msg06443.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06438.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Very+%5C%28very%5C%29+slow+handoff%2C+how+to+investigate%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Very (very) slow handoff, how to investigate?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ian+Plosker%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ian Plosker</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120126" rel="nofollow">Thu, 26 Jan 2012 13:34:57 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Gal, 

The limiting factor on EC2 will likely be IOPs (i.e. Disk throughput). EC2 is a 
IOPs constrained environment, especially if you're using EBS. Further, doing a 
leave can induce a large number of ownership changes to ensure that preflists 
maintain the appropriate n_vals. The number of partitions that need to be 
shuffled can exceed 80% of all partitions. In short, it can take a while for 
the rebalance to complete. Assuming you're using a &gt;=1.0 release, you're 
cluster should still correctly respond to all incoming requests.</pre><pre>

Which version of Riak are you using? As of Riak 1.0.3, `handoff_concurrency`, 
the number of outgoing handoffs per node, is set to 1. This will reduce the 
rate at which the rebalance occurs, but it reduces the impact of the rebalance 
on your cluster. 

-- 
Ian Plosker &lt;i...@basho.com (<a  rel="nofollow" href="mailto:i...@basho.com">mailto:i...@basho.com</a>)&gt;
Developer Advocate
Basho Technologies, Inc.



On Thursday, January 26, 2012 at 3:43 PM, Gal Barnea wrote:

&gt; Ok, so now I can see in the &quot;leaving&quot; node logs:
&gt; 2012-01-26 19:18:23.015 [info] 
&gt; &lt;0.32148.2873&gt;@riak_core_handoff_sender:start_fold:39 Starting handoff of 
&gt; partition riak_kv_vnode 685078892498860742907977265335757665463718379520 from 
&gt; 'r...@ec2-leaving.compute-1.amazonaws.com 
&gt; (<a  rel="nofollow" href="mailto:r...@ec2-leaving.compute-1.amazonaws.com">mailto:r...@ec2-leaving.compute-1.amazonaws.com</a>)' to 
&gt; 'r...@ec2-othernode.compute-1.amazonaws.com 
&gt; (<a  rel="nofollow" href="mailto:r...@ec2-othernode.compute-1.amazonaws.com">mailto:r...@ec2-othernode.compute-1.amazonaws.com</a>)'
&gt; 2012-01-26 19:24:17.798 [info] &lt;0.31620.2873&gt; alarm_handler: 
&gt; {set,{system_memory_high_watermark,[]}}
&gt; 2012-01-26 20:23:28.991 [info] 
&gt; &lt;0.32148.2873&gt;@riak_core_handoff_sender:start_fold:87 Handoff of partition 
&gt; riak_kv_vnode 685078892498860742907977265335757665463718379520 from 
&gt; 'r...@leaving.compute-1.amazonaws.com 
&gt; (<a  rel="nofollow" href="mailto:r...@leaving.compute-1.amazonaws.com">mailto:r...@leaving.compute-1.amazonaws.com</a>)' to 
&gt; 'r...@ec2-othernode.compute-1.amazonaws.com 
&gt; (<a  rel="nofollow" href="mailto:r...@ec2-othernode.compute-1.amazonaws.com">mailto:r...@ec2-othernode.compute-1.amazonaws.com</a>)' completed: sent 5110665 
&gt; objects in 3905.97 seconds
&gt; 
&gt; so things *are* moving but at a rate of 1308 records per second.
&gt; This sounds very slow to me, accounting for the small record size, the high 
&gt; bw rate inside ec2 and practically 0% load on the servers
&gt; 
&gt; any thoughts? 
&gt; 
&gt; 
&gt; 
&gt; On Thu, Jan 26, 2012 at 10:12 PM, Gal Barnea &lt;g...@eyeviewdigital.com 
&gt; (<a  rel="nofollow" href="mailto:g...@eyeviewdigital.com">mailto:g...@eyeviewdigital.com</a>)&gt; wrote:
&gt; &gt; Hi all
&gt; &gt; 
&gt; &gt; I have a 6 server cluster running on ec2 (m1.large) - this is an evaluation 
&gt; &gt; environment, so practically no load besides the existing data (~200 million 
&gt; &gt; records, ~1k each) 
&gt; &gt; 
&gt; &gt; after running &quot;riak-admin leave&quot; on one of the node, I noticed that for 
&gt; &gt; more than 3 hours
&gt; &gt; 1 - member_status showed that there is one &quot;leaving&quot; node and pending data 
&gt; &gt; to handoff on the rest but the numbers never changed
&gt; &gt; 2 - riak-admin transfers -  showed handoffs waiting, but nothing changed
&gt; &gt; 
&gt; &gt; at this point, I restarted the &quot;leaving&quot; node, so now the status is 
&gt; &gt; 1 - member_status - still stuck with the same numbers
&gt; &gt; 2 - transfers - are slowly changing
&gt; &gt; 
&gt; &gt; The leaving server's logs are showing that a single handoff started after 
&gt; &gt; the restart,but nothing since (roughly an hour ago)
&gt; &gt; 
&gt; &gt; Interestingly, the leaving server is pretty idle while the remaining 
&gt; &gt; servers are working hard at 50%-60% cpu 
&gt; &gt; 
&gt; &gt; so, the question now is where should I dig around to try and understand 
&gt; &gt; what's going on. Any thoughts? 
&gt; &gt; 
&gt; &gt; Thanks
&gt; &gt; Gal
&gt; &gt; 
&gt; &gt;  
&gt; &gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 


</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06437.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd6.html#06438">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail6.html#06438">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06443.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06436.html">Very (very) slow handoff, how to investigate?</a></span> <span class="sender italic">Gal Barnea</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06437.html">Re: Very (very) slow handoff, how to investigate?</a></span> <span class="sender italic">Gal Barnea</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Very (very) slow handoff, how to investigate...</span> <span class="sender italic">Ian Plosker</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06443.html">Re: Very (very) slow handoff, how to investi...</a></span> <span class="sender italic">Gal Barnea</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06444.html">Re: Very (very) slow handoff, how to inv...</a></span> <span class="sender italic">Ian Plosker</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06445.html">Re: Very (very) slow handoff, how t...</a></span> <span class="sender italic">Joseph Blomstedt</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06467.html">Re: Very (very) slow handoff, h...</a></span> <span class="sender italic">Gal Barnea</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07533.html">Re: Very (very) slow handof...</a></span> <span class="sender italic">Matthew Tovbin</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Very (very) slow handoff, how to investigate?">
<input type="hidden" name="msgid" value="24D121BF0BF34E89952302AB74F7E38E@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06438.html">
<input type="submit" value=" Ian Plosker ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Very+%5C%28very%5C%29+slow+handoff%2C+how+to+investigate%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06437.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06443.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">24D121BF0BF34E89952302AB74F7E38E@basho.com</li>
</ul>
</div>
</body>
</html>
