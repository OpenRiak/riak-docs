<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Unable to create anonymous user</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16816" id="c">
<link rel="index" href="maillist.html#16816" id="i">
<link rel="prev" href="msg16815.html" id="p">
<link rel="next" href="msg16819.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16816.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Unable+to+create+anonymous+user%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Unable to create anonymous user</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shawn+Debnath%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shawn Debnath</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151125" rel="nofollow">Wed, 25 Nov 2015 10:15:52 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I have had issues where passing the POST body via —data didn’t work.

# Create credentials
curl -v --retry 5 --retry-delay 5 -XPOST &quot;<a  rel="nofollow" href="http://127.0.0.1:8080/riak-cs/user&quot">http://127.0.0.1:8080/riak-cs/user&quot</a>; \
     -H &quot;Content-Type: application/json&quot; \
     --data '{&quot;email”:”f...@bar.com&quot;, &quot;name”:&quot;foobar”}'</pre><pre>

Another way I have tried to do it via curl is:

curl –v -X POST -d @foobar.json &quot;<a  rel="nofollow" href="http://127.0.0.1:8080/riak-cs/user&quot">http://127.0.0.1:8080/riak-cs/user&quot</a>; --header 
&quot;Content–Type:application/json”

Given you are having trouble diagnosing whats getting up there, a good thing to 
do would be increase the verbosity level for curl by doing –vvv.

Been using the above two methods successfully for a while in PROD. One thing to 
note is that I always run it from the server itself.


From: riak-users 
&lt;riak-users-boun...@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users-boun...@lists.basho.com">mailto:riak-users-boun...@lists.basho.com</a>&gt;&gt; 
on behalf of Dmitri Zagidulin 
&lt;dzagidu...@basho.com&lt;<a  rel="nofollow" href="mailto:dzagidu...@basho.com">mailto:dzagidu...@basho.com</a>&gt;&gt;
Date: Wednesday, November 25, 2015 at 8:54 AM
To: Ben Rudolph &lt;brudo...@dimagi.com&lt;<a  rel="nofollow" href="mailto:brudo...@dimagi.com">mailto:brudo...@dimagi.com</a>&gt;&gt;
Cc: riak-users &lt;riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;&gt;
Subject: Re: Unable to create anonymous user

Ben,

Not sure what to advise. Your configs look ok.
I just downloaded a fresh copy of Riak CS 2.0.1, Stanchion, and a fresh Riak 2.
I set up the configs just as you have (changing only the paths in 
advanced.config to match my machine).
Cutting and pasting your curl line seems to result in correct user creation.
So, the dreaded &quot;Works For Me (tm)&quot;.

The only thing I can think of is - double and triple-check all involved 
firewalls.
Searching about for that error message let me to this thread:
<a  rel="nofollow" href="http://riak-users.197444.n3.nabble.com/adding-auth-user-not-valid-td4033452.html">http://riak-users.197444.n3.nabble.com/adding-auth-user-not-valid-td4033452.html</a>

Which indicates that the error message can be caused by CS not being able to 
access Stanchion. You mentioned that you can telnet into stanchion_host from 
the riak node. Is Stanchion set to listen to the correct IP and port?

Dmitri







On Wed, Nov 25, 2015 at 10:16 AM, Ben Rudolph 
&lt;brudo...@dimagi.com&lt;<a  rel="nofollow" href="mailto:brudo...@dimagi.com">mailto:brudo...@dimagi.com</a>&gt;&gt; wrote:
Thanks for the response Dmitri. Just double checked all those settings

1) I checked with stanchion ping and i'm also able to telnet into the 
stanchion_host from the riak node
2)Double checked and it shows up in the logs:
&lt;0.142.0&gt;@riak_cs_config:warnings:120 `anonymous_user_creation` is set as true. 
Set this as false when this CS nodes is populated as public service.
3) Yes
4) Yes

In case useful, here are our configs: 
<a  rel="nofollow" href="https://github.com/dimagi/commcarehq-ansible/tree/riak/ansible/roles/riakcs/templates">https://github.com/dimagi/commcarehq-ansible/tree/riak/ansible/roles/riakcs/templates</a>

On Wed, Nov 25, 2015 at 10:04 AM, Dmitri Zagidulin 
&lt;dzagidu...@basho.com&lt;<a  rel="nofollow" href="mailto:dzagidu...@basho.com">mailto:dzagidu...@basho.com</a>&gt;&gt; wrote:
Hi Ben,

Just to double-check:
1) is Stanchion installed and running, when you try to create the user? (and 
the stanchion_host entry is pointing to it, in cs config?)

2) is anonymous_user_creation = on in the config file?

3) do you have 'buckets.default.allow_mult = true' in the Riak config file?

4) (this is likely to be yes, but just to check) Have you restarted Riak since 
configuring the advanced.config backend?

Dmitri

On Tue, Nov 24, 2015 at 6:40 PM, Ben Rudolph 
&lt;brudo...@dimagi.com&lt;<a  rel="nofollow" href="mailto:brudo...@dimagi.com">mailto:brudo...@dimagi.com</a>&gt;&gt; wrote:
Hi,

I've almost completed the cluster setup but am running into issues with 
anonymous user creation. All machines ping/pong and their IPs are matching. 
When I run the curl command to create an anonymous user:

curl -H 'Content-Type: application/json' -XPOST <a  rel="nofollow" href="http://**:8080/riak-cs/user">http://**:8080/riak-cs/user</a> 
--data '{&quot;email&quot;:&quot;em...@email.com&lt;<a  rel="nofollow" href="mailto:em...@email.com">mailto:em...@email.com</a>&gt;&quot;, 
&quot;name&quot;:&quot;admin_user&quot;}'

And I get an XML response that says Internal Server Error. The console.log file 
looks like this:

2015-11-24 23:16:35.572 [error] &lt;0.439.0&gt; Webmachine error at path 
&quot;/riak-cs/user&quot; : 
{error,{error,{badmatch,{error,malformed_xml}},[{riak_cs_s3_response,xml_error_code,1,[{file,&quot;src/riak_cs_s3_response.erl&quot;},{line,335}]},{riak_cs_s3_response,error_response,1,[{file,&quot;src/riak_cs_s3_response.erl&quot;},{line,249}]},{riak_cs_wm_user,accept_json,2,[{file,&quot;src/riak_cs_wm_user.erl&quot;},{line,119}]},{webmachine_resource,resource_call,3,[{file,&quot;src/webmachine_resource.erl&quot;},{line,186}]},{webmachine_resource,do,3,[{file,&quot;src/webmachine_resource.erl&quot;},{line,142}]},{webmachine_decision_core,resource_call,...},...]}}
 in riak_cs_s3_response:xml_error_code/1 line 335

Which led me to this issue here&lt;<a  rel="nofollow" href="https://github.com/basho/riak_cs/issues/970">https://github.com/basho/riak_cs/issues/970</a>&gt;. 
However my advanced.config already looks like this (which is what is suggested 
in the issue):
[
 {riak_kv, [
              {add_paths, [&quot;/usr/lib/riak-cs/lib/riak_cs-2.0.1/ebin&quot;]},
              {storage_backend, riak_cs_kv_multi_backend},
              {multi_backend_prefix_list, [{&lt;&lt;&quot;0b:&quot;&gt;&gt;, be_blocks}]},
              {multi_backend_default, be_default},
              {multi_backend, [
                  {be_default, riak_kv_eleveldb_backend, [
                      {total_leveldb_mem_percent, 30},
                      {data_root, &quot;/opt/data/riak/leveldb&quot;}
                  ]},
                  {be_blocks, riak_kv_bitcask_backend, [
                      {data_root, &quot;/opt/data/riak/bitcask&quot;}
                  ]}
              ]}
  ]}
].

Any insight would be useful!

Thanks,
Ben

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>




</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16815.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16816">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16816">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16819.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16812.html">Unable to create anonymous user</a></span> <span class="sender italic">Ben Rudolph</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16813.html">Re: Unable to create anonymous user</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16818.html">Re: Unable to create anonymous user</a></span> <span class="sender italic">Ben Rudolph</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16815.html">Re: Unable to create anonymous user</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Unable to create anonymous user</span> <span class="sender italic">Shawn Debnath</span></li>
<li class="icons-email"><span class="subject"><a href="msg16819.html">Re: Unable to create anonymous user</a></span> <span class="sender italic">Ben Rudolph</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Unable to create anonymous user">
<input type="hidden" name="msgid" value="29505C57-8269-4E8A-8798-DECE0E25400A@debnath.net">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16816.html">
<input type="submit" value=" Shawn Debnath ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Unable+to+create+anonymous+user%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16815.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16819.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">29505C57-8269-4E8A-8798-DECE0E25400A@debnath.net</li>
</ul>
</div>
</body>
</html>
