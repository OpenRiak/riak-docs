<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Achieving 100% consitency</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#04500" id="c">
<link rel="index" href="maillist.html#04500" id="i">
<link rel="prev" href="msg04497.html" id="p">
<link rel="next" href="msg04501.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg04500.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Achieving+100%25+consitency%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Achieving 100% consitency</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jeremiah+Peschka%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jeremiah Peschka</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110829" rel="nofollow">Mon, 29 Aug 2011 06:41:47 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>When you write the data you can set w and dw values to the number of replicas 
(n) in your cluster. That will ensure that every node in Riak has the same 
data. </pre><pre>

Riak should be using a quorum read as well. Using a simple example of a three 
node cluster...

You write a chunk of data about a user, we'll call him 'lukas'. From your code, 
you perform PUT('lukas', some_value). That hits Node1 of your cluster. Node1 
says &quot;Ah, here is some data. I must share it with my friends!&quot; Node1 
immediately tells Node2 and Node3 about the interesting things that 'lukas' is 
doing. Node3 is already doing something else involving MapReduce, so it isn't 
able to respond immediately. Node2, however, is doing nothing and it 
immediately responds. Since we're using the defaults, (n/2) + 1 nodes have been 
able to successfully respond to the write request, Node1 sends a message back 
to your client saying &quot;OK! We got the data. KTHXBAI!&quot;

Assuming that your client does some kind of load balancing, you try to read 
some data through GET('lukas'). Your request goes to Node3. Node3, for whatever 
reason, doesn't have the right data. It has an older version of 'lukas'. But, 
Node3 won't send the data back just yet with the default read/write consistency 
values. Node3 asks everyone else for the data. Node1 sends back its copy of 
'lukas' first. Node3 takes one look at the information and says, &quot;Something's 
not right here, Node1 thinks 'lukas' looks like this and I think 'lukas' looks 
like that. I'd better wait for Node2.&quot; Node2 sends its copy of the data over. 
Node3 looks at Node2's data and says &quot;Node1 and Node2 agree. Clearly I've 
missed something.&quot; At this point, Node3 will correct its local data in a read 
repair operation and send the data back to the client.

In short, despite the vagaries of eventual consistency, consistent data 
eventually emerges from the system. 

There are a few other things to keep in mind.

1) When you issue a write to Riak, you can using a boolean property 
'return-body' to force Riak to give you the most current version of the record 
being saved to disk. Everything will come back - data, vector clocks, etags, 
everything. 
2) Clients (and proxies) may cache data in memory in an attempt to avoid server 
load. If you want up to the minute data, you need to make sure that your cache 
is used with some kind of mechanism that keeps the cache up to date as writes 
occur (some kind of write-through/write-behind/cache-aside cache).
---
Jeremiah Peschka - Founder, Brent Ozar PLF, LLC
Microsoft SQL Server MVP

On Aug 29, 2011, at 12:20 AM, Lukas Schulze wrote:

&gt; Hi,
&gt; 
&gt; thank you for your answers.
&gt; I know that Riak is designed for running on distributed servers.
&gt; But what's about adding lots of data and every tuple depends on another one?
&gt; I thought that having only 1 node and disabling replications could solve my 
&gt; problems of getting always the latest data from Riak.
&gt; 
&gt; Is there another way to achieve 100% consistency in a riak database after a 
&gt; very short time?
&gt; 
&gt; Best regards
&gt; Lukas
&gt; 
&gt; 
&gt; 
&gt; On Sat, Aug 27, 2011 at 5:43 PM, Ian Plosker &lt;i...@basho.com&gt; wrote:
&gt; Jonathan,
&gt; 
&gt; Excuse me, that last message should have been addressed to you.
&gt; 
&gt; Ian Plosker
&gt; Developer Advocate
&gt; Basho Technologies
&gt; 
&gt; 
&gt; On Aug 27, 2011, at 11:39 AM, Ian Plosker wrote:
&gt; 
&gt;&gt; Lukas,
&gt;&gt; 
&gt;&gt; Yes, even for dev you'd be best advised to develop and test your application 
&gt;&gt; with the same or similar number of nodes and n, r, and w settings as you 
&gt;&gt; would in production. It's good practice to develop applications in a 
&gt;&gt; dev/test environment that mirrors the production environment as much as is 
&gt;&gt; reasonable/feasible. You can run a single node cluster, but note that this 
&gt;&gt; isn't a configuration you'll see in a production.
&gt;&gt; 
&gt;&gt; Ian Plosker
&gt;&gt; Developer Advocate
&gt;&gt; Basho Technologies
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Aug 27, 2011, at 5:33 AM, Jonathan Langevin wrote:
&gt;&gt; 
&gt;&gt;&gt; Even for development-purposes only? Otherwise it seems data would be 
&gt;&gt;&gt; written n times to the same machine, which is needless in a dev environment 
&gt;&gt;&gt; with low storage specs...
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Jonathan Langevin
&gt;&gt;&gt; Systems Administrator
&gt;&gt;&gt; Loom Inc.
&gt;&gt;&gt; Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com - 
&gt;&gt;&gt; www.loomlearning.com - Skype: intel352
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Fri, Aug 26, 2011 at 5:01 PM, Ian Plosker &lt;i...@basho.com&gt; wrote:
&gt;&gt;&gt; Lukas,
&gt;&gt;&gt; 
&gt;&gt;&gt; Also, we don't advise that you run single node clusters. Riak is designed 
&gt;&gt;&gt; to be used in clusters of at least 3 nodes. You can run a multi-node 
&gt;&gt;&gt; cluster on a single development machine by downloading the Riak source, and 
&gt;&gt;&gt; running &quot;make devrel&quot;. Take a look at the Riak Fast Track 
&gt;&gt;&gt; (<a  rel="nofollow" href="http://wiki.basho.com/The-Riak-Fast-Track.html">http://wiki.basho.com/The-Riak-Fast-Track.html</a>) for more details.
&gt;&gt;&gt; 
&gt;&gt;&gt; Ian Plosker
&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt; Basho Technologies
&gt;&gt;&gt; 
&gt;&gt;&gt; On Aug 26, 2011, at 3:17 PM, Lukas Schulze wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I'm doing some simple tests with Riak and tried to build something like an 
&gt;&gt;&gt;&gt; index.
&gt;&gt;&gt;&gt; Therefore I created new buckets for some attributes like &quot;name&quot;, &quot;street&quot; 
&gt;&gt;&gt;&gt; and &quot;city&quot;.
&gt;&gt;&gt;&gt; One entry in the index-bucket &quot;name&quot; is for example &quot;Mueller&quot; and the 
&gt;&gt;&gt;&gt; value contains all user ids, formatted as an JSON string: 
&gt;&gt;&gt;&gt; &quot;{id:[1,5,8,13,2,7]}&quot;
&gt;&gt;&gt;&gt; The java objects are saved as JSON strings in a separate bucket &quot;users&quot;, 
&gt;&gt;&gt;&gt; the keys in this bucket are the user-ids, the values are the JSON strings.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; If I add 200 users via Java and the RiakPBC client every loop I fetch the 
&gt;&gt;&gt;&gt; index, add the new user id and store it again in Riak.
&gt;&gt;&gt;&gt; But java is too fast, so I receive an old version of the bucket.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Because I've only one node I set the n-value to 1, r = 1, w = 1 and dw = 1.
&gt;&gt;&gt;&gt; But I have to wait nearly 2 seconds to be mostly sure to get the correct 
&gt;&gt;&gt;&gt; response. (the computer isn't an high-end machine ;-) )
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Is it possible to be sure that the data will be saved permanently and I 
&gt;&gt;&gt;&gt; can continue adding users?
&gt;&gt;&gt;&gt; Are there any caching methods I can configure?
&gt;&gt;&gt;&gt; Can I set the default n-value to 1 so that every newly created bucket will 
&gt;&gt;&gt;&gt; have this value?
&gt;&gt;&gt;&gt; Does Riak have any kind of indexes or is it possible to implement it a 
&gt;&gt;&gt;&gt; better way?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; In my first version I saved all users in one bucket and iterated over all 
&gt;&gt;&gt;&gt; of them to find the correct one. But for every single request from the 
&gt;&gt;&gt;&gt; Java Service to Riak it took nearly 200ms. For a huge amount of entries 
&gt;&gt;&gt;&gt; (10,000) this isn't practible. Therefore I tried to implement my own 
&gt;&gt;&gt;&gt; indexes.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The main focus of my question is getting rid of the inconsistent reads.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thank you.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Best Regards
&gt;&gt;&gt;&gt; Lukas
&gt;&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg04497.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#04500">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#04500">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04501.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04479.html">Achieving 100% consitency</a></span> <span class="sender italic">Lukas Schulze</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04480.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li class="icons-email"><span class="subject"><a href="msg04482.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Ian Plosker</span></li>
<li class="icons-email"><span class="subject"><a href="msg04483.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Ian Plosker</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04488.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Jonathan Langevin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04490.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Ian Plosker</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04491.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Ian Plosker</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04498.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Lukas Schulze</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04497.html">Re: Achieving 100% consite...</a></span> <span class="sender italic">Lukas Schulze</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Achieving 100% consite...</span> <span class="sender italic">Jeremiah Peschka</span></li>
<li class="icons-email"><span class="subject"><a href="msg04501.html">Re: Achieving 100% consite...</a></span> <span class="sender italic">Russell Brown</span></li>
<li class="icons-email"><span class="subject"><a href="msg04502.html">Re: Achieving 100% consite...</a></span> <span class="sender italic">Russell Brown</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg04518.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Scott Lystig Fritchie</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04520.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Jonathan Langevin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04524.html">Re: Achieving 100% consitency</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04526.html">Re: Achieving 100% consite...</a></span> <span class="sender italic">Les Mikesell</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04527.html">Re: Achieving 100% con...</a></span> <span class="sender italic">Jonathan Langevin</span></li>
<li class="icons-email"><span class="subject"><a href="msg04528.html">Re: Achieving 100% con...</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Achieving 100% consitency">
<input type="hidden" name="msgid" value="C6740092-AD92-4A49-861D-AE108D81FA41@gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg04500.html">
<input type="submit" value=" Jeremiah Peschka ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Achieving+100%25+consitency%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg04497.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04501.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">C6740092-AD92-4A49-861D-AE108D81FA41@gmail.com</li>
</ul>
</div>
</body>
</html>
