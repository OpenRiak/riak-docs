<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak crashing on Map Reduce</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#11098" id="c">
<link rel="index" href="maillist.html#11098" id="i">
<link rel="prev" href="msg11097.html" id="p">
<link rel="next" href="msg11077.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg11098.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+crashing+on+Map+Reduce%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak crashing on Map Reduce</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Christian+Dahlqvist%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Christian Dahlqvist</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130517" rel="nofollow">Fri, 17 May 2013 02:10:40 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Kurt,

A Riak cluster can handle very large amounts of data, and 500 000 000 keys 
should not be a problem. Riak's MapReduce implementation is however not  
designed or meant to be used for this type of large bulk processing, so 
inserting all the data and then periodically performing MapReduce over the 
entire set will not work. You will therefore need to change your approach to 
how you process and query your data in order to make it work with Riak.</pre><pre>

I would recommend looking closely at how you need to be able to query your data 
and then perhaps consider performing periodic aggregations in different ways to 
support these query patterns. This would allow you to directly access data 
through keys, secondary indexes or run MapReduce on a smaller set of keys, 
which would most likely scale and perform much better. Depending on your data 
and requirements, there may also be other ways to tackle the problem.

If you could provide me with some example data and a description of how you 
need to be able to query this data and what type of information you are looking 
to get out of it, I am sure we can try helping you design a suitable data model 
and an efficient approach to process it.

If you are not comfortable sharing this type of information on the mailing 
list, feel free to email me directly.

Best regards,

Christian


On 17 May 2013, at 09:25, kurt campher &lt;campherku...@gmail.com&gt; wrote:

&gt; So just to provide a bit of context.
&gt; 
&gt; We want a datastore that can hold over 500 000 000 keys and will those keys 
&gt; will map reduced routinely. 
&gt; 
&gt; I would love to use Riak for this but the question is can it handle this 
&gt; amount of data (and possibly more) and can it be done cheaply?
&gt; 
&gt; What sort of hosting would be needed? RAM? CPU? etc...
&gt; 
&gt; Thanks for the help 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Wed, May 15, 2013 at 5:33 PM, Dmitri Zagidulin &lt;dzagidu...@basho.com&gt; 
&gt; wrote:
&gt; Kurt,
&gt; 
&gt; I'm not sure about the cause of the MapReduce crash (I suspect it's running 
&gt; out of resources of some kind, even with the increase of vm count and mem). 
&gt; One word of advice about the list keys timeout, though:
&gt; Be sure to use streaming list keys.
&gt; 
&gt; In Python, this would look something like:
&gt; for keylist in bucket.stream_keys():
&gt; 
&gt; 
&gt;     for key in keylist:
&gt;         # Do something with the key
&gt; 
&gt; 
&gt; This will at least avoid the timeout problem (though you may want to consider 
&gt; your use case here, and maybe use secondary index queries or search queries 
&gt; instead of listing all the keys in a bucket, since even a streaming list keys 
&gt; has to iterate over _all_ keys in a cluster).
&gt; 
&gt; Dmitri
&gt; 
&gt; 
&gt; On Wed, May 15, 2013 at 7:02 AM, kurt campher &lt;campherku...@gmail.com&gt; wrote:
&gt; Hi People
&gt; 
&gt; Im running Map Reduce on a bucket with more than 100 000 items.
&gt; 
&gt; The MR runs for 10 seconds then stops with this error in the logs:
&gt; @riak_pipe_vnode:new_worker:766 Pipe worker startup failed:fitting was gone 
&gt; before startup
&gt; 
&gt; And this errror in the Python shell:
&gt; Error running MapReduce operation. Headers: {'date': 'Tue, 14 May 2013 
&gt; 15:07:27 GMT', 'content-length': '623', 'content-type': 'application/json', 
&gt; 'http_code': 500, 'server': 'MochiWeb/1.1 WebMachine/1.9.0 (someone had 
&gt; painted it blue)'} Body: 
&gt; '{&quot;phase&quot;:0,&quot;error&quot;:&quot;[preflist_exhausted]&quot;,&quot;input&quot;:&quot;{ok,{r_object,&lt;&lt;\\&quot;real_raw_logs\\&quot;&gt;&gt;,&lt;&lt;\\&quot;8a4986cc235ec8690123677460ac05e6:2013-05-14
&gt;  
&gt; 12:11:08.178628:0.184912287858\\&quot;&gt;&gt;,[{r_content,{dict,6,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[[&lt;&lt;\\&quot;Links\\&quot;&gt;&gt;]],[],[],[],[],[],[],[],[[&lt;&lt;\\&quot;content-type\\&quot;&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\\&quot;X-Riak-VTag\\&quot;&gt;&gt;,49,89,48,122,98,99,66,53,120,86,120,50,90,67,101,51,115,120,79,85,65,79]],[[&lt;&lt;\\&quot;index\\&quot;&gt;&gt;]],[],[[&lt;&lt;\\&quot;X-Riak-Last-Modified\\&quot;&gt;&gt;|{1368,533468,242947}]],[],[...]}}},...}],...},...}&quot;,&quot;type&quot;:&quot;forward_preflist&quot;,&quot;stack&quot;:&quot;[]&quot;}'
&gt; 
&gt; Also, I cant list the keys on the bucket. A timeout error occurs.
&gt; 
&gt; 
&gt; I have Riak running on 2 nodes with 7 Gigs of RAM each.
&gt; Map Reduce runs fine over 2000 items.
&gt; I have increased the js_vm count multiple times.
&gt; Also increased the js_max_vm_mem to 2048
&gt; Also increased the Map Reduce query's timeout but never lasts longer than 10 
&gt; seconds
&gt; 
&gt; Thanks to anyone who looks at this
&gt; 
&gt; 
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg11097.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#11098">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#11098">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg11077.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg11071.html">Riak crashing on Map Reduce</a></span> <span class="sender italic">kurt campher</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11072.html">Re: Riak crashing on Map Reduce</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li class="icons-email"><span class="subject"><a href="msg11076.html">Re: Riak crashing on Map Reduce</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg11097.html">Re: Riak crashing on Map Reduce</a></span> <span class="sender italic">kurt campher</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak crashing on Map Reduce</span> <span class="sender italic">Christian Dahlqvist</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak crashing on Map Reduce">
<input type="hidden" name="msgid" value="D81F06B0-AB42-48E7-B55F-62C153582856@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg11098.html">
<input type="submit" value=" Christian Dahlqvist ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+crashing+on+Map+Reduce%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg11097.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg11077.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">D81F06B0-AB42-48E7-B55F-62C153582856@basho.com</li>
</ul>
</div>
</body>
</html>
