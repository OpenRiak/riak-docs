<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: MapReduce performance problem</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10296" id="c">
<link rel="index" href="maillist.html#10296" id="i">
<link rel="prev" href="msg10264.html" id="p">
<link rel="next" href="msg10360.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10296.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+MapReduce+performance+problem%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: MapReduce performance problem</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jeremiah+Peschka%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jeremiah Peschka</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130228" rel="nofollow">Thu, 28 Feb 2013 17:41:12 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I didn't want you to think that you've been forgotten, but I've been
swamped getting ready to head out of the country for 2 weeks on a company
trip. You're in good hands with the list, though.</pre><pre>

---
Jeremiah Peschka - Founder, Brent Ozar Unlimited
MCITP: SQL Server 2008, MVP
Cloudera Certified Developer for Apache Hadoop


On Tue, Feb 26, 2013 at 4:36 PM, Kevin Burton &lt;rkevinbur...@charter.net&gt;wrote:

&gt; I got the same error on an AWS instance (m1.xlarge) when using the
&gt; MapReduce version of list all keys.****
&gt;
&gt; ** **
&gt;
&gt; Query failed with Riak returned an error. Code '0'. Message:
&gt; {&quot;phase&quot;:0,&quot;error&quot;:&quot;[preflist_exhausted]&quot;,&quot;input&quot;:&quot;{ok,{r_object,&lt;&lt;\&quot;buyseasons-products\&quot;&gt;&gt;,&lt;&lt;\&quot;00113023\&quot;&gt;&gt;,[{r_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;\&quot;content-type\&quot;&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\&quot;X-Riak-VTag\&quot;&gt;&gt;,49,54,99,97,90,90,72,106,56,50,100,77,85,75,66,114,76,50,109,88,89,109]],[[&lt;&lt;\&quot;index\&quot;&gt;&gt;,{&lt;&lt;\&quot;active_bin\&quot;&gt;&gt;,&lt;&lt;\&quot;InactiveDiscontinued\&quot;&gt;&gt;},{&lt;&lt;\&quot;definition_bin\&quot;&gt;&gt;,&lt;&lt;\&quot;Costume\&quot;&gt;&gt;},{&lt;&lt;\&quot;department_bin\&quot;&gt;&gt;,&lt;&lt;\&quot;Adult
&gt; Costumes\&quot;&gt;&gt;},{&lt;&lt;\&quot;...\&quot;&gt;&gt;,...}]],...}}},...}],...},...}&quot;,&quot;type&quot;:&quot;forward_preflist&quot;,&quot;stack&quot;:&quot;[]&quot;}
&gt; – CommunicationError****
&gt;
&gt; ** **
&gt;
&gt; The ‘Department’ MapReduce with an AWS instance also returned three
&gt; ‘failed’ phases.****
&gt;
&gt; ** **
&gt;
&gt; Kevin****
&gt;
&gt; ** **
&gt;
&gt; *From:* riak-users [<a  rel="nofollow" href="mailto:riak-users-boun...@lists.basho.com">mailto:riak-users-boun...@lists.basho.com</a>] *On Behalf
&gt; Of *Jeremiah Peschka
&gt; *Sent:* Tuesday, February 26, 2013 3:18 PM
&gt;
&gt; *To:* riak-users
&gt; *Subject:* Re: MapReduce performance problem****
&gt;
&gt; ** **
&gt;
&gt; Responses inline.****
&gt;
&gt; ** **
&gt;
&gt; ---****
&gt;
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited****
&gt;
&gt; MCITP: SQL Server 2008, MVP****
&gt;
&gt; Cloudera Certified Developer for Apache Hadoop****
&gt;
&gt; ** **
&gt;
&gt; On Tue, Feb 26, 2013 at 12:26 PM, Kevin Burton &lt;rkevinbur...@charter.net&gt;
&gt; wrote:****
&gt;
&gt; Right. I know it is not ideal. I have been able to split the VM’s into
&gt; groups. So 2 of the 4 are running on separate hardware. Anything more I
&gt; just get the response ‘get real’. That being said I want to get the maximum
&gt; performance of the limited resources that I have. I have a separate
&gt; question for the group in trying to get basho_bench up and running (I get a
&gt; long string of errors). What do you need to know more about my environment
&gt; to “understand” it? I am new so I am probably asking the wrong questions so
&gt; please tell me what you are missing that might help diagnose the problem.*
&gt; ***
&gt;
&gt; ** **
&gt;
&gt; For troubleshooting any environment it's good to know relevant hardware
&gt; details about CPU speed, core count, amount of RAM, disks, network cards,
&gt; etc. A working basho_bench benchmark would help, too, because it will
&gt; provide an indicator of how your environment will perform with Riak as
&gt; opposed to how your business logic performs, as implemented, with Riak.***
&gt; *
&gt;
&gt; ** **
&gt;
&gt; For virtualization, it's also important to know how many other guests are
&gt; on the host, whether there are any CPU, memory, or network reservations in
&gt; place, and which version of virtualization you're running. Virtualization
&gt; makes performance tuning more complex, but not impossible. ****
&gt;
&gt;  ****
&gt;
&gt; I agree. I will use ListAllKeysFromIndex to get a list of keys for now.
&gt; The only reason that I included the m/r code is because of the error. If I
&gt; get another m/r job with similar output I need to know how to diagnose the
&gt; problem. I was using JavaScript m/r because I kind of understand
&gt; JavaScript. Is there a separate task to do Erlang m/r jobs.****
&gt;
&gt; Erlang phases can be added to a MapReduceQuery using MapErlang and
&gt; ReduceErlang. ****
&gt;
&gt; I assume that I will need to know Erlang. Any recommendations on how best
&gt; to know what I need to know about Erlang to write a m/r job. But before I
&gt; do that wouldn’t it be prudent to know that the source if the problem is
&gt; indeed JavaScript? How would I pinpoint that?****
&gt;
&gt; I think this has been answered on list. I'd search
&gt; <a  rel="nofollow" href="http://riak.markmail.org****">http://riak.markmail.org****</a>
&gt;
&gt; ** **
&gt;
&gt; Someone from Basho can probably handle this better than my handwaving that
&gt; using JavaScript involves an interpreter, type marshaling between Erlang
&gt; and JavaScript, and won't multi-thread like Erlang will.****
&gt;
&gt; These two m/r jobs are basically an example of using m/r that would be
&gt; typical for our application.  Just for sheer maintenance we wouldn’t want
&gt; to go down the path of maintaining a counter for all the fields that we
&gt; have. There could be departments, categories, celebrations, . . . Basically
&gt; a lot of them.  For all intents it is an ad hoc query. If that is one of
&gt; the limitations then we will have to note it and see if coping with this
&gt; limitation is too onerous.****
&gt;
&gt; ** **
&gt;
&gt; MR queries are going to scan all of your data on disk. If you have 5 nodes
&gt; that can read at ~100 MB/s and you have 100GB of data, how long will it
&gt; take for your ad hoc query to run? ****
&gt;
&gt; ** **
&gt;
&gt; Riak Search/Lucene/Yokozuna will be better options for ad hoc workloads
&gt; than MapReducing across the cluster.****
&gt;
&gt;  ****
&gt;
&gt; *From:* riak-users [<a  rel="nofollow" href="mailto:riak-users-boun...@lists.basho.com">mailto:riak-users-boun...@lists.basho.com</a>] *On Behalf
&gt; Of *Jeremiah Peschka
&gt; *Sent:* Tuesday, February 26, 2013 1:33 PM
&gt; *To:* riak-users
&gt; *Subject:* Re: MapReduce performance problem****
&gt;
&gt;  ****
&gt;
&gt; Before you go troubleshooting performance problems, I'd focus on getting
&gt; results out of basho_bench and getting a good understanding of your
&gt; environment. If you're running 4 guests with 1 vCPU each on the same VM
&gt; host with all guests sharing a single pool of disks, no amount of tuning
&gt; will solve that problem. Without an understanding of the operating
&gt; environment, we can't do much more than point at general best practices and
&gt; say &quot;these might help you, not sure, though.&quot;****
&gt;
&gt;  ****
&gt;
&gt; As far as your specifics - for the first query, if you're attempting to
&gt; get a list of keys, I still recommend using ListAllKeysFromIndex(string
&gt; Bucket). This will be pushed out as part of the IRiakClient interface in
&gt; the next day or two, and I'm sure the gods of OOP won't kill you for using
&gt; an actual RiakClient object instead of an IRiakClient interface between now
&gt; and then. Sending those results back directly from riak_kv is going to be
&gt; far faster than messing around with a JavaScript MapReduce job.****
&gt;
&gt;  ****
&gt;
&gt; Always keep in mind that MR jobs are not going to be the most efficient
&gt; way to perform any kind of ad hoc querying - they're great for large scale
&gt; data transformations but if you really want performance, you'll want to
&gt; write Erlang MR jobs. ****
&gt;
&gt;  ****
&gt;
&gt; If you need to maintain counts per department, a better approach will be
&gt; persisting counters and maintaining those counts via some kind of
&gt; caching/pre-aggregation mechanism, most likely outside of Riak because of
&gt; eventual consistency guarantees. Alex Siculars will eventually show up and
&gt; start chanting &quot;use redis&quot;; you'll be resistant at first, but his arguments
&gt; make a lot of sense. Riak does some things very well, maintaining
&gt; consistent counters isn't one of them... yet.****
&gt;
&gt;
&gt; ****
&gt;
&gt; ---****
&gt;
&gt; Jeremiah Peschka - Founder, Brent Ozar Unlimited****
&gt;
&gt; MCITP: SQL Server 2008, MVP****
&gt;
&gt; Cloudera Certified Developer for Apache Hadoop****
&gt;
&gt;  ****
&gt;
&gt; On Tue, Feb 26, 2013 at 10:52 AM, Kevin Burton &lt;rkevinbur...@charter.net&gt;
&gt; wrote:****
&gt;
&gt; I have a simple CorrugatedIron client that makes the following request:***
&gt; *
&gt;
&gt;  ****
&gt;
&gt;                 IRiakClient riakClient = cluster.CreateClient();****
&gt;
&gt;                 RiakBinIndexRangeInput bucketKeyInput = new
&gt; RiakBinIndexRangeInput(productBucketName, &quot;$key&quot;, &quot;00000000&quot;, &quot;99999999&quot;);
&gt; ****
&gt;
&gt;                 RiakMapReduceQuery query = new RiakMapReduceQuery()****
&gt;
&gt;                    .Inputs(bucketKeyInput)****
&gt;
&gt;                    .MapJs(m =&gt; m.Name(&quot;Riak.mapValuesJson&quot;).Keep(true));**
&gt; **
&gt;
&gt;                 RiakResult&lt;RiakMapReduceResult&gt; result =
&gt; riakClient.MapReduce(query);****
&gt;
&gt;  ****
&gt;
&gt; So as you can see this is a very basic range m/r query. But the result
&gt; comes back as:****
&gt;
&gt;  ****
&gt;
&gt; Riak returned an error. Code '0'. Message: timeout****
&gt;
&gt; CommunicationError****
&gt;
&gt;  ****
&gt;
&gt; Another type of m/r query I have****
&gt;
&gt;  ****
&gt;
&gt;                 IRiakClient riakClient = cluster.CreateClient();****
&gt;
&gt;                 var query = new RiakMapReduceQuery()****
&gt;
&gt;                     .Inputs(productBucketName)****
&gt;
&gt;                     .MapJs(m =&gt; m.Source(@&quot;function(v,d,a) {&quot; +****
&gt;
&gt;                         &quot;var p = JSON.parse(v.values[0].data);&quot; +****
&gt;
&gt;                         &quot;var r = [];&quot; +****
&gt;
&gt;                         &quot;d = escape(p.Department);&quot; +****
&gt;
&gt;                         &quot;if(d != '') {&quot; +****
&gt;
&gt;                         &quot;var o = {};&quot; +****
&gt;
&gt;                         &quot;o[d] = 1;&quot; +****
&gt;
&gt;                         &quot;r.push(o);&quot; +****
&gt;
&gt;                         &quot;}&quot; +****
&gt;
&gt;                         &quot;return r;&quot; +****
&gt;
&gt;                         &quot;}&quot;))****
&gt;
&gt;                     .ReduceJs(m =&gt; m.Source(@&quot;function(v,d,a) {&quot; +****
&gt;
&gt;                         &quot;var r = {};&quot; +****
&gt;
&gt;                         &quot;for(var i in v) {&quot; +****
&gt;
&gt;                         &quot;  for(var w in v[i]) {&quot; +****
&gt;
&gt;                         &quot;    if(w in r) r[w] += v[i][w];&quot; +****
&gt;
&gt;                         &quot;    else r[w] = v[i][w];&quot; +****
&gt;
&gt;                         &quot;  }&quot; +****
&gt;
&gt;                         &quot;}&quot; +****
&gt;
&gt;                         &quot;return [r];&quot; +****
&gt;
&gt;                         &quot;}&quot;)****
&gt;
&gt;                         .Keep(true));****
&gt;
&gt;  ****
&gt;
&gt; This returns but it takes far too long. I have about 60,000 items in my
&gt; bucket and this takes about 50-60 seconds to execute. The results seem
&gt; valid. For these types of m/r jobs what can I do on the server (or client)
&gt; to helo diagnose the problem.  I have basic tools like iostat and top to
&gt; give me data but some pointers on using the output of these tools might
&gt; help.****
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com****">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com****</a>
&gt;
&gt;  ****
&gt;
&gt; ** **
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10264.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10296">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10296">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10360.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10251.html">MapReduce performance problem</a></span> <span class="sender italic">Kevin Burton</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10252.html">Re: MapReduce performance problem</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10255.html">RE: MapReduce performance problem</a></span> <span class="sender italic">Kevin Burton</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10259.html">Re: MapReduce performance problem</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10260.html">RE: MapReduce performance problem</a></span> <span class="sender italic">Kevin Burton</span></li>
<li class="icons-email"><span class="subject"><a href="msg10264.html">RE: MapReduce performance problem</a></span> <span class="sender italic">Kevin Burton</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: MapReduce performance problem</span> <span class="sender italic">Jeremiah Peschka</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10360.html">RE: MapReduce performance problem</a></span> <span class="sender italic">Kevin Burton</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10386.html">Re: MapReduce performance problem</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10398.html">RE: MapReduce performance probl...</a></span> <span class="sender italic">Kevin Burton</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: MapReduce performance problem">
<input type="hidden" name="msgid" value="CACJEN2oFq1cEYxycjPQzYhrXeHzEakRrdDQ7vzY3vz5XLBNfYg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10296.html">
<input type="submit" value=" Jeremiah Peschka ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+MapReduce+performance+problem%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10264.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10360.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CACJEN2oFq1cEYxycjPQzYhrXeHzEakRrdDQ7vzY3vz5XLBNfYg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
