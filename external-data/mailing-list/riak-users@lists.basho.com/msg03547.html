<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Question: Object Not Saved After Save/Delete/Save</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03547" id="c">
<link rel="index" href="maillist.html#03547" id="i">
<link rel="prev" href="msg03546.html" id="p">
<link rel="next" href="msg03548.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03547.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Question%5C%3A+Object+Not+Saved+After+Save%5C%2FDelete%5C%2FSave%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Question: Object Not Saved After Save/Delete/Save</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Keith+Bennett%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Keith Bennett</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110603" rel="nofollow">Fri, 03 Jun 2011 15:08:30 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Aphyr &amp; Andrew -

Thanks for your responses.  I'm trying to wrap my head around the issues you 
raised, and I must confess it's difficult.  Anyway, some questions for you...</pre><pre>

On Jun 3, 2011, at 5:12 PM, Andrew Thompson wrote:

&gt; On Fri, Jun 03, 2011 at 02:00:23PM -0700, Aphyr wrote:
&gt;&gt; Riak can't use the vclock for conflict resolution on a fresh object,
&gt;&gt; i.e. one without a vclock. Deletes are writes. You should use get or
&gt;&gt; reload before writing to help Riak sequence your writes correctly.

If the caller doesn't have a handle to the RObject in the Ruby framework, or 
the metadata of an HTTP response, but is only accessing the data by bucket and 
key values, is there any way to use reload?  And if the object has been deleted 
is there any way to use get?

&gt;&gt; 
&gt;&gt; On top of this, Riak has some weirdness around very quick sequences
&gt;&gt; of deletes/writes due, IIRC, to deletes not being tagged with a
&gt;&gt; vector clock. I... think... this will be addressed in an upcoming
&gt;&gt; release.

I tried inserting a 20 second pause between each read/write, but there was no 
change in the behavior.  Should it be longer than that?

&gt;&gt; 
&gt; 
&gt; Ah, my favorite bug. This is indeed mostly solved on master by exposing
&gt; the vclocks for tombstones so they can be cleanly overwritten by the new
&gt; object rather than merged into a frankenobject that has the metadata of
&gt; the tombstone but the value of the new object (which is then subject to
&gt; real deletion).
&gt; 
&gt; So the fix for the issue was to add a new type of return value for a get
&gt; that finds a tombstone, {error, {deleted, Vclock}} instead of always
&gt; returning {error, notfound} on a true notfound or when a tombstone is
&gt; encountered.
&gt; 

That sounds like exactly what I need.  Can I simulate that fix in my Ruby code? 
  Any pointers about that? Any chance we could get that into the Ruby client?  
I'd be willing to put a little effort into that, but I don't really understand 
the issues well enough yet.


&gt; An example of how to safely delete for all 3 APIs can be found at
&gt; 
&gt; <a  rel="nofollow" href="https://gist.github.com/965376">https://gist.github.com/965376</a>
&gt; 
&gt; Note the new deletedvclock option. The REST API will always use this
&gt; option on gets and will return a X-Riak-Vclock header along with any 404
&gt; that is actually a tombstone.
&gt; 
&gt; Some further reading can be found here:
&gt; 
&gt; <a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=260">https://issues.basho.com/show_bug.cgi?id=260</a>
&gt; <a  rel="nofollow" href="https://issues.basho.com/show_bug.cgi?id=555">https://issues.basho.com/show_bug.cgi?id=555</a>
&gt; 
&gt; So, long story short; either upgrade to master and use the deletedvclock
&gt; option or avoid doing rapid put/delete/put cycles.

You're suggesting I use mercurial to pull down the HEAD and use that, right?

Thanks again,
Keith


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03546.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03547">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03547">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03548.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03543.html">Question: Object Not Saved After Save/Delete/Save</a></span> <span class="sender italic">Keith Bennett</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03544.html">Re: Question: Object Not Saved After Save/Delete/Save</a></span> <span class="sender italic">Aphyr</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03546.html">Re: Question: Object Not Saved After Save/Delete/...</a></span> <span class="sender italic">Andrew Thompson</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Question: Object Not Saved After Save/Del...</span> <span class="sender italic">Keith Bennett</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03548.html">Re: Question: Object Not Saved After Save...</a></span> <span class="sender italic">Andrew Thompson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03554.html">Re: Question: Object Not Saved After...</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03582.html">Re: Question: Object Not Saved A...</a></span> <span class="sender italic">Keith Bennett</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03584.html">Re: Question: Object Not Sav...</a></span> <span class="sender italic">Jared Morrow</span></li>
<li class="icons-email"><span class="subject"><a href="msg03585.html">Fixed!  Was, Re: Question: O...</a></span> <span class="sender italic">Keith Bennett</span></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg03555.html">Re: Question: Object Not Saved After Save...</a></span> <span class="sender italic">Andy Gross</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Question: Object Not Saved After Save/Delete/Save">
<input type="hidden" name="msgid" value="88808CEE-E21F-44F7-8981-FA191E876CCE@lmnsolutions.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03547.html">
<input type="submit" value=" Keith Bennett ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Question%5C%3A+Object+Not+Saved+After+Save%5C%2FDelete%5C%2FSave%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03546.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03548.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">88808CEE-E21F-44F7-8981-FA191E876CCE@lmnsolutions.com</li>
</ul>
</div>
</body>
</html>
