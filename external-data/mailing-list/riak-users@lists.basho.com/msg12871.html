<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Keys that won't disappear from indexes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd7.html#12871" id="c">
<link rel="index" href="mail7.html#12871" id="i">
<link rel="prev" href="msg12867.html" id="p">
<link rel="next" href="msg13153.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12871.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Keys+that+won%27t+disappear+from+indexes%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Keys that won't disappear from indexes</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Toby+Corkindale%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Toby Corkindale</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131106" rel="nofollow">Wed, 06 Nov 2013 18:14:43 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Evan,
Thanks -- that resulted in a list that looks like:
{ok,[&lt;&lt;128,0,0,0&gt;&gt;,
     &lt;&lt;128,1,0,0&gt;&gt;,
     &lt;&lt;128,2,0,0&gt;&gt;,
     &lt;&lt;128,3,0,0&gt;&gt;,
     &lt;&lt;128,4,0,0&gt;&gt;,
     &lt;&lt;128,5,0,0&gt;&gt;,
... etc ...</pre><pre>

</pre><tt>That confirms my suspicions that the Java client is mangling the keys 
</tt><tt>while processing them as unicode strings, because if I print out the 
</tt><tt>values of the characters of the string there, I get:
</tt><pre style="margin: 0em;">

65533,0,0,0
65533,1,0,0
65533,2,0,0
etc


On 06/11/13 15:57, Evan Vigil-McClanahan wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Since we're talking about indices:

you can attach to the console with `riak attach` (then detach with
control-d (1.3 and below) or control-c (1.4+) note that this is can
kill your node on older versions, so be careful to use the correct
one).  Then edit the below to match up with your query, and then paste
it in (note that all the period below are intentional and required):

{ok, C} = riak:local_client().
{ok, Query} = riak_index:to_index_query(&lt;&lt;&quot;fieldname_bin&quot;&gt;&gt;,
[&lt;&lt;&quot;begin_point&quot;&gt;&gt;, &lt;&lt;&quot;end_point&quot;&gt;&gt;]).
C:get_index(&lt;&lt;&quot;bucket_name&quot;&gt;&gt;, Query).

If you need to adjust the Query because of a typo or something, just
do f(Query). to unbind it.

fieldname_bin is the binary index or whatever you're searching for. If
you were using $key, your Query might look something like this:

(perfdev@127.0.0.1)17&gt; {ok, Query} =
riak_index:to_index_query(&lt;&lt;&quot;$key&quot;&gt;&gt;, [&lt;&lt;&quot;&quot;&gt;&gt;,
&lt;&lt;255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255&gt;&gt;]).
{ok,{range,&lt;&lt;&quot;$key&quot;&gt;&gt;,&lt;&lt;&gt;&gt;,&lt;&lt;&quot;ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ&quot;&gt;&gt;}}
(perfdev@127.0.0.1)20&gt; C:put(riak_object:new(&lt;&lt;&quot;test&quot;&gt;&gt;, &lt;&lt;&quot;b&quot;&gt;&gt;, &lt;&lt;&quot;c&quot;&gt;&gt;)).
ok
(perfdev@127.0.0.1)21&gt; C:get_index(&lt;&lt;&quot;test&quot;&gt;&gt;, Query).
{ok,[&lt;&lt;&quot;b&quot;&gt;&gt;]}

This should get you a list of keys in erlang binary format, which will
look something like &lt;&lt;&quot;asdasdasd&quot;&gt;&gt; or &lt;&lt;44,0,32,130&gt;&gt; if there are
unprintable characters in the string.


On Tue, Nov 5, 2013 at 4:40 PM, Toby Corkindale
&lt;toby.corkind...@strategicdata.com.au&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 06/11/13 11:30, Evan Vigil-McClanahan wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

You can replace int_to_bin with int_to_str to make it easier to debug
in the future, I suppose.  I am not sure how to get them to be fetched
as bytes, without may altering the client.

You could just attach to the console and run whatever listing command
you're running there, which would give you the answer as unfiltered
erlang binaries, which are easy to understand.
</pre></blockquote><pre style="margin: 0em;">


Ah, I'm really not familiar enough with Erlang and Riak to be doing that.
Which API applies to console commands? I'll take a look. (Is it just the
same as the Erlang client?)



</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Is this easily replicable on a new cluster?
</pre></blockquote><pre style="margin: 0em;">


I think it should be -- the only difference over default configuration is
that LevelDB is configured as the default backend.
Run basho_bench with the pbc-client test to generate the initial keys and
you should be set.


T

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Tue, Nov 5, 2013 at 4:17 PM, Toby Corkindale
&lt;toby.corkind...@strategicdata.com.au&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Hi Evan,
These keys were originally created by basho-bench, using:
{key_generator, {int_to_bin, {uniform_int, 10000}}}.

Of the 10k keys, it seems half could be removed, but not the other half.

Now I've tried storing keys with the same key as the un-deleteable ones,
waiting a minute, and then deleting them again.. this isn't seeming to
help!

I don't know if it's significant, but I'm working with the Java client
here
(protocol buffers). I note that the bad keys are basically just bytes,
not
actual ascii strings, and they do contain nulls.

Actually, here's something I just noticed -- the keys I'm getting from
the
index are repeating! It's the same 39 keys, repeated 128 times.

O.o

Are there any known bugs in the PBC interface when it comes to binary
keys?
I know the HTTP interface just crashes out completely.

I'm fetching the keys in a manner that returns strings; is there a way to
fetch them as bytes? Maybe that would work better; I'm wondering if the
client is attempting to convert the bytes into unicode strings and
dropping
invalid characters?


On 05/11/13 03:44, Evan Vigil-McClanahan wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">


Hi Toby.

It's possible, since they're stored separately, that the objects were
deleted but the indices were left in place because of some error (e.g.
the operation failed for some reason between the object removal and
the index removal).  One of the things on the feature list for the
next release is AAE of index values, which should take care of this
case.  This is really rare, but not unknown.  It'd be interesting to
know how you ended up with so many.

In the mean time, the only way I can think of to get rid of them
(other than deleting them from the console, which would require taking
nodes down and a lot of manual effort), would be to write another
value that would have the same index, then delete it, which should
normally succeed.

I'll ask around to see if there is anything that might work better.
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


</pre></blockquote></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12867.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd7.html#12871">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail7.html#12871">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg13153.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12818.html">Keys that won't disappear from indexes</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12831.html">Re: Keys that won't disappear from indexes</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12834.html">Re: Keys that won't disappear from indexes</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12862.html">Re: Keys that won't disappear from inde...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12863.html">Re: Keys that won't disappear from ...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12864.html">Re: Keys that won't disappear ...</a></span> <span class="sender italic">Toby Corkindale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12866.html">Re: Keys that won't disapp...</a></span> <span class="sender italic">Brian Roach</span></li>
<li class="icons-email"><span class="subject"><a href="msg12867.html">Re: Keys that won't disapp...</a></span> <span class="sender italic">Evan Vigil-McClanahan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Keys that won't di...</span> <span class="sender italic">Toby Corkindale</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg13153.html">Re: Keys that won't disappear from inde...</a></span> <span class="sender italic">Sean McKibben</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Keys that won't disappear from indexes">
<input type="hidden" name="msgid" value="527AF7AB.5060001@strategicdata.com.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12871.html">
<input type="submit" value=" Toby Corkindale ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Keys+that+won%27t+disappear+from+indexes%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12867.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg13153.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">527AF7AB.5060001@strategicdata.com.au</li>
</ul>
</div>
</body>
</html>
