<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: reduce headaches</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#01105" id="c">
<link rel="index" href="mail2.html#01105" id="i">
<link rel="prev" href="msg01100.html" id="p">
<link rel="next" href="msg01106.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg01105.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+reduce+headaches%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: reduce headaches</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22francisco+treacy%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">francisco treacy</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20100920" rel="nofollow">Mon, 20 Sep 2010 09:07:56 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>2010/9/19 Kevin Smith &lt;ksm...@basho.com&gt;:
&gt; 0) I know the MapReduce machinery isn't as user-friendly as it could be. We 
&gt; are making plans now on ways to dramatically improve things on this front in 
&gt; the nearish future. I hope to have more details to share soon. We've 
&gt; committed improvements to the error reporting logic on tip so if you have the 
&gt; ability to upgrade to tip you should get improved error messages.</pre><pre>

Thanks, Kevin, that's great news. Looking forward to hearing more.

&gt; 1) Reduce functions are currently called in two different ways. The first way 
&gt; is to invoke the reduce function with a list of items produced from the map 
&gt; phase. Internally the MapReduce machinery batches up data as it streams in 
&gt; from the map phase and sends the batches to the reduce phase.
&gt;
&gt; The second way to invoke a reduce function at the end of the reduce with the 
&gt; list of data produced via earlier reduce invocations. This is also referred 
&gt; to as &quot;re-reduce&quot;. Riak reduce functions always re-reduce. Re-reduction is a 
&gt; common source of problems as it tends to catch people off guard. However, 
&gt; your function looks like it should work. You could try wrapping the function 
&gt; body in a try/catch and using ejsLog to log the exception to a file. That 
&gt; should shed some light on what exactly if failing.

Yea, that was my understanding but indeed, it may have caught me off guard :)

Unfortunately I couldn't reproduce the problem with our sum function.
It works just fine now. What I am totally certain about is that I saw
it failing (logs are the proof) and by simply './riak restart'-ing the
problem went away. Hope not to experience something similar in
production!

&gt; 2) How are you reloading new Javascript functions? 'riak-admin js_reload' 
&gt; should cause all the Javascript VMs to restart and start from a clean slate. 
&gt; If that's not working correctly I'd be very interested in knowing that so I 
&gt; can fix it before our next release.

Good point, I am *not* using named functions so I imagine `riak-admin
js_reload` does not apply to my case (or does it - I never triggered
it)?  Every job I submit is comprised of anonymous functions (except
Riak built-ins, that is) -- I am developing plenty of ad-hoc queries
to be run once in a while on our production data.

The rest of the weirdness could have come from my side (possibly badly
coded reduce functions). Better error reporting, as well as guidelines
and gotchas when building reduces and advanced examples, would
definitely help. What I can say right now is that I'll be closely
following this matter, and come up asap with any issues I may
encounter.

Francisco


&gt;
&gt; On Sep 19, 2010, at 1:09 PM, francisco treacy wrote:
&gt;
&gt;&gt; So, I've had a weekend plagued of reduce function errors and general
&gt;&gt; weirdness, probably due to my ignorance on the subject.
&gt;&gt;
&gt;&gt; Functions seem to be cached, which makes total sense. But it happened
&gt;&gt; to me several times sending a *different* function yet Riak would
&gt;&gt; completely ignore it and keep on running an older version (i started
&gt;&gt; noticing when using ejsLog). Is there a way of disabling caching? Hope
&gt;&gt; i'm missing something big here cause that's super annoying.
&gt;&gt;
&gt;&gt; (I've also noticed strange behaviour when executing map/reduce jobs in
&gt;&gt; parallel and getting results mixed up... *sometimes* (possibly race
&gt;&gt; conditions) -- but first I want to make sure it's not the client. And
&gt;&gt; no, there's no global leakage.).
&gt;&gt;
&gt;&gt; Then... what's wrong with this reduce function? It used to run fine,
&gt;&gt; but now it doesn't anymore. Oh, wait - yes it does again now that I
&gt;&gt; restarted Riak:
&gt;&gt;
&gt;&gt; function(values) {
&gt;&gt;          return [
&gt;&gt;            values.reduce(function(acc, value) {
&gt;&gt;              return acc + (value.fleet || value || 0);
&gt;&gt;            }, 0)
&gt;&gt;          ];
&gt;&gt;        }
&gt;&gt;
&gt;&gt; What can explain this behaviour? ( * error logs attached)
&gt;&gt;
&gt;&gt;
&gt;&gt; I'm well aware of
&gt;&gt; <a  rel="nofollow" href="http://github.com/basho/riak_kv/blob/master/priv/mapred_builtins.js">http://github.com/basho/riak_kv/blob/master/priv/mapred_builtins.js</a>
&gt;&gt; and the few blog posts on the matter. Are there any docs in-between
&gt;&gt; the basic examples and the source code? (i will delve into it once I
&gt;&gt; get enough Erlang-fu, promise :)
&gt;&gt;
&gt;&gt; I mean, when and how reduces (and re-reduces) are invoked and what you
&gt;&gt; should expect will be fed to your function, how are they cached and
&gt;&gt; what should programmers know about, what can/can't be done, more
&gt;&gt; advanced examples (how do &quot;commutative, associative, and idempotent&quot;
&gt;&gt; functions reflect in practical terms), etc.
&gt;&gt;
&gt;&gt; I'd love to help with whatever I can (might be good material for a blog 
&gt;&gt; post).
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Francisco
&gt;&gt;
&gt;&gt; (*) These are the logs:
&gt;&gt;
&gt;&gt; =SUPERVISOR REPORT==== 19-Sep-2010::18:10:32 ===
&gt;&gt;     Supervisor: {local,luke_phase_sup}
&gt;&gt;     Context:    child_terminated
&gt;&gt;     Reason:     {error,failed_reduce}
&gt;&gt;     Offender:   [{pid,&lt;0.5424.22&gt;},
&gt;&gt;                  {name,undefined},
&gt;&gt;                  {mfa,
&gt;&gt;                   {luke_phase,start_link,
&gt;&gt;                    [riak_kv_reduce_phase,1,
&gt;&gt;                     [accumulate,converge],
&gt;&gt;                     undefined,&lt;0.5421.22&gt;,66000,
&gt;&gt;                     [{javascript,
&gt;&gt;                       {reduce,
&gt;&gt;                        {jsanon,
&gt;&gt;                         &lt;&lt;&quot;function (values) {\n          return [\n
&gt;&gt;          values.reduce(function(acc, value) {\n              return
&gt;&gt; acc + (value.fleet || value || 0);\n            }, 0)\n          ];\n
&gt;&gt;      }&quot;&gt;&gt;},
&gt;&gt;                        none,true}}]]}},
&gt;&gt;                  {restart_type,temporary},
&gt;&gt;                  {shutdown,brutal_kill},
&gt;&gt;                  {child_type,worker}]
&gt;&gt;
&gt;&gt;
&gt;&gt; =SUPERVISOR REPORT==== 19-Sep-2010::18:10:32 ===
&gt;&gt;     Supervisor: {local,luke_phase_sup}
&gt;&gt;     Context:    child_terminated
&gt;&gt;     Reason:     {error,failed_reduce}
&gt;&gt;     Offender:   [{pid,&lt;0.5425.22&gt;},
&gt;&gt;                  {name,undefined},
&gt;&gt;                  {mfa,
&gt;&gt;                   {luke_phase,start_link,
&gt;&gt;                    [riak_kv_reduce_phase,1,
&gt;&gt;                     [accumulate,converge],
&gt;&gt;                     undefined,&lt;0.5421.22&gt;,66000,
&gt;&gt;                     [{javascript,
&gt;&gt;                       {reduce,
&gt;&gt;                        {jsanon,
&gt;&gt;                         &lt;&lt;&quot;function (values) {\n          return [\n
&gt;&gt;          values.reduce(function(acc, value) {\n              return
&gt;&gt; acc + (value.fleet || value || 0);\n            }, 0)\n          ];\n
&gt;&gt;      }&quot;&gt;&gt;},
&gt;&gt;                        none,true}}]]}},
&gt;&gt;                  {restart_type,temporary},
&gt;&gt;                  {shutdown,brutal_kill},
&gt;&gt;                  {child_type,worker}]
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg01100.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#01105">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#01105">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg01106.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg01099.html">reduce headaches</a></span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01100.html">Re: reduce headaches</a></span> <span class="sender italic">Kevin Smith</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: reduce headaches</span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01106.html">Re: reduce headaches</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li class="icons-email"><span class="subject"><a href="msg01107.html">Re: reduce headaches</a></span> <span class="sender italic">Kevin Smith</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg01110.html">Re: reduce headaches</a></span> <span class="sender italic">francisco treacy</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: reduce headaches">
<input type="hidden" name="msgid" value="AANLkTinYB6omOJuJ61Qx9vxJHPwbHZgmxPKXb85x1s0k@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg01105.html">
<input type="submit" value=" francisco treacy ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+reduce+headaches%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg01100.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg01106.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">AANLkTinYB6omOJuJ61Qx9vxJHPwbHZgmxPKXb85x1s0k@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
