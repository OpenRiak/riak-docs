<!DOCTYPE html>
<html lang="en">
<head>
<title>get failures on consistent buckets</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16298" id="c">
<link rel="index" href="maillist.html#16298" id="i">
<link rel="prev" href="msg16290.html" id="p">
<link rel="next" href="msg16299.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16298.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22get+failures+on+consistent+buckets%22&amp;o=newest" rel="nofollow"><span itemprop="name">get failures on consistent buckets</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Gregg+Siegfried%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Gregg Siegfried</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20150716" rel="nofollow">Thu, 16 Jul 2015 04:30:08 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>
Hi, all.

We are in the testing phase of an application subsystem that uses Riak
2.1.1 and a bucket type with consistency on and n=5 (per Basho docs).</pre><pre>

Client side is .net using the Basho .net client.

As the testing volume has risen, we are encountering get failures that
seem to have a communication-related flavor.

Things like: ³CommunicationError: Unable to read data from the transport
connection: A connection attempt failed because the connected party did
not properly respond after a period of time, or established connection
failed because connected host has failed to respond²  Or
³CommunicationError: Riak returned an error. Code Œ0¹. Message timeout² or
even ³ClusterOffline: unable to access functioning Riak node².

The cluster itself is 5 nodes, 2.1.1, centos 6, front ended with haproxy.
The HA proxy stats with respect to retries, redispatch, errors, warning
are completely clean.
There are actually 2 haproxy nodes polling the riak nodes, set up with a
keepalived (HSRP) VIP, but there have been no failovers.

The only things in any of my ³crash² logs are:

2015-07-16 01:13:59 =CRASH REPORT====
  crasher:
    initial call: mochiweb_acceptor:init/3
    pid: &lt;0.4628.6768&gt;
    registered_name: []
    exception error:
{function_clause,[{webmachine_request,peer_from_peername,[{error,enotconn},
{webmachine_request,{wm_reqstate,#Port&lt;0.12171987&gt;,[],undefined,undefined,u
ndefined,{wm_reqdata,'GET',http,{1,0},&quot;defined_in_wm_req_srv_init&quot;,&quot;defined
_in_wm_req_srv_init&quot;,defined_on_call,defined_in_load_dispatch_data,&quot;/ping&quot;,
&quot;/ping&quot;,[],defined_in_load_dispatch_data,&quot;defined_in_load_dispatch_data&quot;,50
0,1073741824,67108864,[],[],{0,nil},not_fetched_yet,false,{0,nil},&lt;&lt;&gt;&gt;,foll
ow_request,undefined,undefined,[]},undefined,undefined,undefined}}],[{file,
&quot;src/webmachine_request.erl&quot;},{line,150}]},{webmachine_request,get_peer,1,[
{file,&quot;src/webmachine_request.erl&quot;},{line,124}]},{webmachine,new_request,2,
[{file,&quot;src/webmachine.erl&quot;},{line,69}]},{webmachine_mochiweb,loop,2,[{file
,&quot;src/webmachine_mochiweb.erl&quot;},{line,49}]},{mochiweb_http,headers,5,[{file
,&quot;src/mochiweb_http.erl&quot;},{line,96}]},{proc_lib,init_p_do_apply,3,[{file,&quot;p
roc_lib.erl&quot;},{line,239}]}]}
    ancestors: ['<a  rel="nofollow" href="http://0.0.0.0:8098_mochiweb">http://0.0.0.0:8098_mochiweb</a>',riak_api_sup,&lt;0.368.0&gt;]
    messages: []
    links: [&lt;0.374.0&gt;,#Port&lt;0.12171987&gt;]
    dictionary: []
    trap_exit: false
    status: running
    heap_size: 987
    stack_size: 27
    reductions: 1249
  neighbours:


And there are a number of these, over time, but all of the application
interaction with the cluster is via PB, not rest.

The client side is running inside an ASP.net application pool via IIS 7.5.
 All of the windows machines have had the TCP parameters around
TimedWaitDelay and MaxUserPort changed (30 or 60 and 65534 respectively)
to support the connection rate that the .net client generates.

Prior to going to consistent buckets, we did not see these.

We¹ve implemented Put retry logic in order to work around similar,
transient failures on the write side, which are more understandable due to
the way the consistency subsystem operates.  We were not expecting to have
to implement this type of retry on the get-side.

Any recommendations from the group as to how to start unraveling this one?
 A number of the status-related riak-admin commands do not function once
consistency has been used, which has limited my ability to peer too
closely into the nodes themselves.

The volume here is likely trivial compared to most of the use cases I¹m
reading about, but the data model is relatively complex, and the traffic
rate and object sizes quite variable.

Thank you for any insight.
Gregg Siegfried
Language Logic, LLC


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16290.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16298">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16298">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg16299.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">get failures on consistent buckets</span> <span class="sender italic">Gregg Siegfried</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16299.html">Re: get failures on consistent buckets</a></span> <span class="sender italic">Luke Bakken</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="get failures on consistent buckets">
<input type="hidden" name="msgid" value="D1CD0DAD.12C94E%gregg.siegfried@languagelogic.net">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16298.html">
<input type="submit" value=" Gregg Siegfried ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22get+failures+on+consistent+buckets%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16290.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg16299.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">D1CD0DAD.12C94E%gregg.siegfried@languagelogic.net</li>
</ul>
</div>
</body>
</html>
