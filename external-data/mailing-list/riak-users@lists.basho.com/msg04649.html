<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Python transports</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#04649" id="c">
<link rel="index" href="maillist.html#04649" id="i">
<link rel="prev" href="msg04632.html" id="p">
<link rel="next" href="msg04617.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg04649.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Python+transports%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Python transports</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Greg+Stein%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Greg Stein</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110910" rel="nofollow">Sat, 10 Sep 2011 16:39:15 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi all,

I've been putting more thought into this problem, particularly in
contrast to the &quot;client manages N transport [connections].&quot; I believe
that the latter is not very workable given the variance in underlying
transports. Not enough information is available to the client to
manage the connections properly without putting transport-specific
information into the client (eg. the difference between EPIPE and
ECONNREFUSED). I think it would be wrong to put connection-related
code into the client.</pre><pre>

Here are the three layers that I see, and the direction my branch takes:

1. client: responsible for a high-level API for applications. It maps
this API into the underlying transport primitives (as defined by
riak.transports.transport.RiakTransport).

2. transport: maps the primitives into the appropriately formatted
wire request(s), and handles the response(s).

3. connection manager (CM): handles multiple connections to multiple
hosts for use by the transport.


The CM creates connection objects that understand the protocol (e.g
HTTPConnecction), which is also an object that the transport
understands how to use. The connection objects can signal errors to
the CM for removal when (say) the server goes down or is otherwise
unavailable.

The client does need to be aware of host/port pairs, and pass those
into the transport for provision to the CM. (or possibly the client
creates the appropriate CM, and passes that to the transport). The
different types of CMs (connection type, connection policies/params
etc) imply that the client may be the one to create this, with the
right params. Otherwise, the transport would get a list of host/port
pairs and CM options, and the transport would create the CM with
connection objects appropriate to the transport.

To follow up with my original concern, and to show a concrete example:

In connection.py, we would create a subclass of HTTPConnection that
overrides the .connect() method. If the superclass raises
ECONNRefused, then the subclass would remove the host from the CM.

The subclass does not have to manage EPIPE since it knows that
HTTPConnection can already manage that itself (except for certain
types of variant-sized requests, such as needs to be done for Luwak
requests).

There is a Socket class in connection.py for managing bare sockets for
the protobuf connections. That needs to create a .send() method that
manages EPIPE in some way. It would also have logic for ECONNREFUSED
similar to our HTTPConnection subclass: remove the host from the
available set.

Long-running client applications need to monitor the state of the
ring, and propagate join/leave changes into the available host/port
pairs in the CM. If one server returns ECONNREFUSED and is removed
from the available set, but it is determined that is *transient*, then
the client would need to recognize that and put it back into the set.
I do not have an answer for how the system can know the problem was
transient, or how it recognizes the server is back. Possibly, the host
moves to an &quot;offline&quot; list, and the CM periodically pings it to see if
it is alive (again). If the client removes it (due to a detected ring
change), then it removes it from the offline list. Possibly after time
period T, it is removed from the offline list. I believe these are all
workable details.

Cheers,
-g

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg04632.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#04649">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#04649">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04617.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04612.html">Python transports</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04616.html">Re: Python transports</a></span> <span class="sender italic">Phil Stanhope</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04620.html">Re: Python transports</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04629.html">Re: Python transports</a></span> <span class="sender italic">Brett Hoerner</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04632.html">Re: Python transports</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Python transports</span> <span class="sender italic">Greg Stein</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg04617.html">Re: Python transports</a></span> <span class="sender italic">Russell Brown</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Python transports">
<input type="hidden" name="msgid" value="CABD8fLXx5Vw9xJEvbX_x1UpRcgcupW9Mya5ncQp_3vL-UDfTag@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg04649.html">
<input type="submit" value=" Greg Stein ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Python+transports%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg04632.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04617.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABD8fLXx5Vw9xJEvbX_x1UpRcgcupW9Mya5ncQp_3vL-UDfTag@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
