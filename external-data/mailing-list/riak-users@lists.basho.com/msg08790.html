<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak Memory Usage Constantly Growing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#08790" id="c">
<link rel="index" href="maillist.html#08790" id="i">
<link rel="prev" href="msg08789.html" id="p">
<link rel="next" href="msg08791.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg08790.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Memory+Usage+Constantly+Growing%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak Memory Usage Constantly Growing</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Shane+McEwan%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Shane McEwan</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20121002" rel="nofollow">Tue, 02 Oct 2012 08:51:21 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Thanks John and Kelly. It's nice to know we're not the only ones. :-)</pre><pre>

</pre><tt>As I said, we'll be upgrading to 1.2 in the coming weeks so it's good to 
</tt><tt>know that the memory issues might go away after that. It's not a 
</tt><tt>showstopper for us, more of a curiosity and concern it might develop 
</tt><tt>into something worse.
</tt><pre style="margin: 0em;">

</pre><tt>I'll persist with the etop and see if I can get it to run and will 
</tt><tt>report back.
</tt><pre style="margin: 0em;">

</pre><tt>We're still using key filters in our MapReduce functions but we plan to 
</tt><tt>move to 2i at the same time as upgrading to 1.2.
</tt><pre style="margin: 0em;">

</pre><tt>The word &quot;monitor&quot; doesn't appear in any of our logs for the last 5 
</tt><tt>days. Just lots of:
</tt><pre style="margin: 0em;">

</pre><tt>2012-10-02 00:10:47.869 [error] &lt;0.31890.1344&gt; gen_fsm &lt;0.31890.1344&gt; in 
</tt><tt>state wait_pipeline_shutdown terminated with reason: {sink_died,normal}
</tt><tt>2012-10-02 00:10:47.909 [error] &lt;0.31890.1344&gt; CRASH REPORT Process 
</tt><tt>&lt;0.31890.1344&gt; with 0 neighbours crashed with reason: {sink_died,normal}
</tt><tt>2012-10-02 00:10:47.981 [error] &lt;0.166.0&gt; Supervisor 
</tt><tt>riak_pipe_builder_sup had child undefined started with 
</tt><tt>{riak_pipe_builder,start_link,undefined} at &lt;0.31890.1344&gt; exit with 
</tt><tt>reason {sink_died,normal} in context child_terminated
</tt><pre style="margin: 0em;">

Thanks!

On 02/10/12 15:55, Kelly McLaughlin wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
John and Shane,

I have been looking into some memory issues lately and I would be very 
interested in more
information about your particular problems. If either of you are able to get 
some output
from etop using the -sort memory option when you are having elevated memory 
usage it
would be very helpful to see. I know that sometimes you get the connection_lost 
message
when trying to use etop, but I have found that sometimes if you keep trying it 
may succeed
after a few attempts.

Are either of you using MapReduce? I see that John is using 2I. Shane, do you 
also use 2I?
Finally, do you notice a lot of messages to the console or console log that 
have the either the
phrase 'monitor large_heap' or 'monitor long_gc'?

Kelly

On Oct 2, 2012, at 6:11 AM, &quot;John E. Vincent&quot; &lt;lusis.org+riak-us...@gmail.com&gt; 
wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
I would highly suggest you upgrade to 1.2 when possible. We were, up
until recently, running on 1.4 and seeing the same problems you
describe. Take a look at this graph:

<a  rel="nofollow" href="http://i.imgur.com/0RtsU.png">http://i.imgur.com/0RtsU.png</a>

That's just one of our nodes but all of them exhibited the same
behavior. The falloffs are where we had to bounce riak.

This is what one of our nodes looks like now and has looked like since
the upgrade:

<a  rel="nofollow" href="http://i.imgur.com/pm7Nk.png">http://i.imgur.com/pm7Nk.png</a>

The change was SO dramatic that I seriously though /stats was broken.
I've verified outside of Riak and inside. The memory usage change was
very positive. Evidently there's even still a memory leak.

We're heavy 2i users. No multi backend.

On Tue, Oct 2, 2012 at 4:08 AM, Shane McEwan &lt;sh...@mcewan.id.au&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
G'day!

Just recently we've noticed memory usage in our Riak cluster constantly
increasing.

The memory usage reported by the Riak stats &quot;memory_total&quot; parameter has
been less than 100MB for nearly a year but has recently increased to over
1GB.

If we restart the cluster memory usage usually returns back to what we would
call &quot;normal&quot; but after a week or so of stability the memory usage starts
gradually growing again. Sometimes after a growth spurt over a few days the
memory usage will plateau and be stable again for a week or two and then put
on another growth spurt. The memory usage starts increasing at the same
moment on all 4 nodes.

This graph [<a  rel="nofollow" href="http://imagebin.org/230614">http://imagebin.org/230614</a>] shows what I mean. The green shows
the memory usage as reported by &quot;memory_total&quot; (left-hand y-axis scale). The
red line shows the memory used by Riak's beam.smp process (right-hand y-axis
scale).

Also notice that the gradient of the recent growth seems to be increasing
compared to the memory increases we had in August.

We might have just assumed that the memory usage was normal Riak behaviour.
Perhaps we have just tipped over some sort of internal buffer or cache and
that causes some more memory to be allocated. However, whenever we notice
the memory usage increasing it always coincides with the &quot;riak-admin top&quot;
command failing to run.

We try to run &quot;riak-admin top&quot; to diagnose what is using the memory but it
returns: &quot;Output server crashed: connection_lost&quot;. If we restart the cluster
the top command works fine (but, of course, there's nothing interesting to
see after a restart!).

So our theory at the moment is that some sort of instability or race
condition is causing Riak to start consuming more and more memory. A side
effect of this instability is that the internal processes needed for running
the top command are not working correctly. The actual functionality of Riak
doesn't seem to be affected. Our application is running fine. We see a
slight increase in &quot;FSM Put&quot; times and CPU usage during the memory growth
phases but all other parameters we're monitoring on the system seem
unaffected.

There's nothing abnormal in the logs. We get a lot of &quot;riak_pipe_builder_sup
{sink_died,normal}&quot; messages but they can be ignored, apparently. The
cluster is under constant load so we would expect to see either gradual
memory increase or a steady state but not both. Erlang process count, open
file handles, etc are stable.

So I was wondering if anyone has seen similar behaviour before?
Is there anything else we can do to diagnose the problem?
I'm accessing the stats URL once per minute, could that have any side
effects?
We'll be upgrading to Riak 1.2 and new hardware in the next few weeks so
should we just ignore it and hope it goes away?
Any other ideas?
Or is this just normal?

Riak config:
4 VMware nodes
ring_creation_size, 256
n_val, 3
eleveldb backend:
  max_open_files, 20
  cache_size, 15728640
&quot;riak_kv_version&quot;:&quot;1.1.1&quot;,
&quot;riak_core_version&quot;:&quot;1.1.1&quot;,
&quot;stdlib_version&quot;:&quot;1.17.4&quot;,
&quot;kernel_version&quot;:&quot;2.14.4&quot;
Erlang R14B03 (erts-5.8.4)

Thanks!

Shane.




_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg08789.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#08790">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#08790">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg08791.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg08783.html">Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08784.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08785.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08788.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
<li class="icons-email"><span class="subject"><a href="msg08789.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak Memory Usage Constantly Growing</span> <span class="sender italic">Shane McEwan</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg08791.html">Re: Riak Memory Usage Constantly Growing</a></span> <span class="sender italic">John E. Vincent</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak Memory Usage Constantly Growing">
<input type="hidden" name="msgid" value="506B0D72.3000304@mcewan.id.au">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg08790.html">
<input type="submit" value=" Shane McEwan ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+Memory+Usage+Constantly+Growing%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg08789.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg08791.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">506B0D72.3000304@mcewan.id.au</li>
</ul>
</div>
</body>
</html>
