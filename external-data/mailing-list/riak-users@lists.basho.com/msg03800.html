<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Link Walking via Map Reduce</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03800" id="c">
<link rel="index" href="maillist.html#03800" id="i">
<link rel="prev" href="msg03797.html" id="p">
<link rel="next" href="msg03801.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03800.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Link+Walking+via+Map+Reduce%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Link Walking via Map Reduce</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Andrew+Berman%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Andrew Berman</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110623" rel="nofollow">Thu, 23 Jun 2011 08:15:04 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Mathias,

I thought Riak was content agnostic when it came to the data being
stored?  The map phase is not running Riak.mapValuesJson, so why is
the data itself going through the JSON parser?  The JSON value
returned by v with all the info is valid and I see the struct atom in
there so mochijson2 can parse it properly, but I'm not clear why
mochijson2 would be coughing at the data part.</pre><pre>

--Andrew

On Thu, Jun 23, 2011 at 5:32 AM, Mathias Meyer &lt;math...@basho.com&gt; wrote:
&gt; Andrew,
&gt;
&gt; you're indeed hitting a JSON encoding problem here. BERT is binary data, and 
&gt; won't make the JSON parser happy when trying to deserialize it, before 
&gt; handing it into the map phase. You have two options here, and none of them 
&gt; will involve JavaScript as the MapReduce language.
&gt;
&gt; 1.) Use the Protobuff API, use Erlang functions to return the value or object 
&gt; (e.g. riak_mapreduce:map_object_value or riak_kv_mapreduce:map_identity), and 
&gt; then run MapReduce queries with the content type 
&gt; 'application/x-erlang-binary'. However, you're constrained by client 
&gt; libraries here, e.g. Ruby and Python don't support this content type for 
&gt; MapReduce on the Protobuffs interface yet, so you'd either implement 
&gt; something custom, or resort to a client that does, riak-erlang-client comes 
&gt; to mind, though it was proven to be possible using the Java client too, 
&gt; thanks to Russell. See [1] and [2]
&gt;
&gt; 2.) Convert the result from BERT into a JSON-parseable structure inside an 
&gt; Erlang map function, before it's returned to the client.
&gt;
&gt; The second approach certainly is less restrictive in terms of API usage, but 
&gt; certainly involves some overhead inside of the MapReduce request itself, but 
&gt; is less prone to encoding/decoding issues with JSON.
&gt;
&gt; Mathias Meyer
&gt; Developer Advocate, Basho Technologies
&gt;
&gt; [1] 
&gt; <a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-June/004447.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-June/004447.html</a>
&gt; [2] 
&gt; <a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-June/004485.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-June/004485.html</a>
&gt;
&gt; On Donnerstag, 23. Juni 2011 at 07:59, Andrew Berman wrote:
&gt;
&gt;&gt; Hey Ryan,
&gt;&gt;
&gt;&gt; Here is the error from the sasl log. It looks like some sort of
&gt;&gt; encoding error. Any thoughts on how to fix this? I am storing the
&gt;&gt; data as BERT encoded binary and I set the content-type as
&gt;&gt; application/octet-stream.
&gt;&gt;
&gt;&gt; Thanks for your help!
&gt;&gt;
&gt;&gt; Andrew
&gt;&gt;
&gt;&gt; ERROR REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt; ** Generic server &lt;0.5996.21&gt; terminating
&gt;&gt; ** Last message in was {batch_dispatch,
&gt;&gt;  {map,
&gt;&gt; {jsanon,&lt;&lt;&quot;function(value) {return [value];}&quot;&gt;&gt;},
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;&quot;bucket&quot;&gt;&gt;,&lt;&lt;&quot;user&quot;&gt;&gt;},
&gt;&gt;  {&lt;&lt;&quot;key&quot;&gt;&gt;,&lt;&lt;&quot;LikiWUPJSFuxtrhCYpsPfg&quot;&gt;&gt;},
&gt;&gt;  {&lt;&lt;&quot;vclock&quot;&gt;&gt;,
&gt;&gt;
&gt;&gt; &lt;&lt;&quot;a85hYGBgzGDKBVIsLKaZdzOYEhnzWBmes6Yd58sCAA==&quot;&gt;&gt;},
&gt;&gt;  {&lt;&lt;&quot;values&quot;&gt;&gt;,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;&quot;metadata&quot;&gt;&gt;,
&gt;&gt; {struct,
&gt;&gt;  [{&lt;&lt;&quot;X-Riak-VTag&quot;&gt;&gt;,
&gt;&gt; &lt;&lt;&quot;1KnL9Dlma9Yg4eMhRuhwtx&quot;&gt;&gt;},
&gt;&gt; {&lt;&lt;&quot;X-Riak-Last-Modified&quot;&gt;&gt;,
&gt;&gt; &lt;&lt;&quot;Fri, 10 Jun 2011 03:05:11 GMT&quot;&gt;&gt;}]}},
&gt;&gt;  {&lt;&lt;&quot;data&quot;&gt;&gt;,
&gt;&gt;
&gt;&gt; &lt;&lt;131,108,0,0,0,18,104,2,100,0,6,114,...&gt;&gt;}]}]}]},
&gt;&gt; &lt;&lt;&quot;user&quot;&gt;&gt;,none]}}
&gt;&gt; ** When Server state == {state,&lt;0.143.0&gt;,riak_kv_js_map,#Port&lt;0.92614&gt;,true}
&gt;&gt; ** Reason for termination ==
&gt;&gt; ** {function_clause,[{js_driver,eval_js,
&gt;&gt;  [#Port&lt;0.92614&gt;,{error,bad_encoding},5000]},
&gt;&gt;  {riak_kv_js_vm,invoke_js,2},
&gt;&gt;  {riak_kv_js_vm,define_invoke_anon_js,3},
&gt;&gt;  {riak_kv_js_vm,handle_call,3},
&gt;&gt;  {gen_server,handle_msg,5},
&gt;&gt;  {proc_lib,init_p_do_apply,3}]}
&gt;&gt;
&gt;&gt; =CRASH REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt;  crasher:
&gt;&gt;  initial call: riak_kv_js_vm:init/1
&gt;&gt;  pid: &lt;0.5996.21&gt;
&gt;&gt;  registered_name: []
&gt;&gt;  exception exit:
&gt;&gt; {function_clause,[{js_driver,eval_js,[#Port&lt;0.92614&gt;,{error,bad_encoding},5000]},{riak_kv_js_vm,invoke_js,2},{riak_kv_js_vm,define_invoke_anon_js,3},{riak_kv_js_vm,handle_call,3},{gen_server,handle_msg,5},{proc_lib,init_p_do_apply,3}]}
&gt;&gt;  in function gen_server:terminate/6
&gt;&gt;  in call from proc_lib:init_p_do_apply/3
&gt;&gt;  ancestors: [riak_kv_js_sup,riak_kv_sup,&lt;0.128.0&gt;]
&gt;&gt;  messages: []
&gt;&gt;  links: [&lt;0.142.0&gt;,&lt;0.6009.21&gt;]
&gt;&gt;  dictionary: []
&gt;&gt;  trap_exit: false
&gt;&gt;  status: running
&gt;&gt;  heap_size: 4181
&gt;&gt;  stack_size: 24
&gt;&gt;  reductions: 2586
&gt;&gt;  neighbours:
&gt;&gt;  neighbour: 
&gt;&gt; [{pid,&lt;0.6009.21&gt;},{registered_name,[]},{initial_call,{riak_kv_mapper,init,[Argument__1]}},{current_function,{gen,do_call,4}},{ancestors,[riak_kv_mapper_sup,riak_kv_sup,&lt;0.128.0&gt;]},{messages,[]},{links,[&lt;0.5996.21&gt;,&lt;12337.6227.21&gt;,&lt;0.162.0&gt;]},{dictionary,[]},{trap_exit,false},{status,waiting},{heap_size,987},{stack_size,53},{reductions,1043}]
&gt;&gt; =SUPERVISOR REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt; Supervisor: {local,riak_kv_js_sup}
&gt;&gt; Context: child_terminated
&gt;&gt; Reason:
&gt;&gt; {function_clause,[{js_driver,eval_js,[#Port&lt;0.92614&gt;,{error,bad_encoding},5000]},{riak_kv_js_vm,invoke_js,2},{riak_kv_js_vm,define_invoke_anon_js,3},{riak_kv_js_vm,handle_call,3},{gen_server,handle_msg,5},{proc_lib,init_p_do_apply,3}]}
&gt;&gt; Offender:
&gt;&gt; [{pid,&lt;0.5996.21&gt;},{name,undefined},{mfargs,{riak_kv_js_vm,start_link,undefined}},{restart_type,temporary},{shutdown,2000},{child_type,worker}]
&gt;&gt;
&gt;&gt; On Wed, Jun 22, 2011 at 6:10 PM, Ryan Zezeski &lt;rzeze...@basho.com 
&gt;&gt; (<a  rel="nofollow" href="mailto:rzeze...@basho.com">mailto:rzeze...@basho.com</a>)&gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Andrew,
&gt;&gt; &gt; Maybe you could elaborate on the error? I tested this against master 
&gt;&gt; &gt; (commit below) just now with success.
&gt;&gt; &gt; 2b1a474f836d962fa035f48c05452e22fc6c2193 Change dependency to allow for 
&gt;&gt; &gt; R14B03 as well as R14B02
&gt;&gt; &gt; -Ryan
&gt;&gt; &gt; On Wed, Jun 22, 2011 at 7:03 PM, Andrew Berman &lt;rexx...@gmail.com 
&gt;&gt; &gt; (<a  rel="nofollow" href="mailto:rexx...@gmail.com">mailto:rexx...@gmail.com</a>)&gt; wrote:
&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt; Hello,
&gt;&gt; &gt; &gt; I'm having issues link walking using the Map Reduce link function. I am 
&gt;&gt; &gt; &gt; using HEAD from Git, so it's possible that's the issue, but here is what 
&gt;&gt; &gt; &gt; is happening.
&gt;&gt; &gt; &gt; I've got two buckets, user and user_email where user_email contains a 
&gt;&gt; &gt; &gt; link to the user.
&gt;&gt; &gt; &gt; When I run this:
&gt;&gt; &gt; &gt; {
&gt;&gt; &gt; &gt;  &quot;inputs&quot;: [
&gt;&gt; &gt; &gt;  [
&gt;&gt; &gt; &gt;  &quot;user_email&quot;,
&gt;&gt; &gt; &gt;  &quot;myem...@email.com (<a  rel="nofollow" href="mailto:myem...@email.com">mailto:myem...@email.com</a>)&quot;
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt;  ],
&gt;&gt; &gt; &gt;  &quot;query&quot;: [
&gt;&gt; &gt; &gt;  {
&gt;&gt; &gt; &gt;  &quot;link&quot;: {
&gt;&gt; &gt; &gt;  &quot;bucket&quot;: &quot;user&quot;,
&gt;&gt; &gt; &gt;  &quot;tag&quot;: &quot;user&quot;
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt; }
&gt;&gt; &gt; &gt; I only get [[&quot;user&quot;,&quot;LikiWUPJSFuxtrhCYpsPfg&quot;,&quot;user&quot;]] returned. The 
&gt;&gt; &gt; &gt; second I add a map function, even the simplest one (function(v) { [v] } 
&gt;&gt; &gt; &gt; I get a &quot;map_reduce error&quot;:
&gt;&gt; &gt; &gt; {
&gt;&gt; &gt; &gt;  &quot;inputs&quot;: [
&gt;&gt; &gt; &gt;  [
&gt;&gt; &gt; &gt;  &quot;user_email&quot;,
&gt;&gt; &gt; &gt;  &quot;myem...@email.com (<a  rel="nofollow" href="mailto:myem...@email.com">mailto:myem...@email.com</a>)&quot;
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt;  ],
&gt;&gt; &gt; &gt;  &quot;query&quot;: [
&gt;&gt; &gt; &gt;  {
&gt;&gt; &gt; &gt;  &quot;link&quot;: {&quot;bucket&quot;:&quot;user&quot;, &quot;tag&quot;:&quot;user&quot;}
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt; ,{
&gt;&gt; &gt; &gt;  &quot;map&quot;: {
&gt;&gt; &gt; &gt;  &quot;language&quot;: &quot;javascript&quot;,
&gt;&gt; &gt; &gt;  &quot;source&quot;: &quot;function(v) { return[v]; }&quot;
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt; }
&gt;&gt; &gt; &gt; Is this functionality broken? I am following what it says on the Wiki 
&gt;&gt; &gt; &gt; for the MapRed version of link walking. When I use HTTP link walking, it 
&gt;&gt; &gt; &gt; works correctly.
&gt;&gt; &gt; &gt; Thanks,
&gt;&gt; &gt; &gt; Andrew
&gt;&gt; &gt; &gt; _______________________________________________
&gt;&gt; &gt; &gt; riak-users mailing list
&gt;&gt; &gt; &gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt;&gt; &gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com (<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>)
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
&gt;

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03797.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03800">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03800">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03801.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg03789.html">Link Walking via Map Reduce</a></span> <span class="sender italic">Andrew Berman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03793.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03794.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Andrew Berman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03795.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Sylvain Niles</span></li>
<li class="icons-email"><span class="subject"><a href="msg03797.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Mathias Meyer</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Link Walking via Map Reduce</span> <span class="sender italic">Andrew Berman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03801.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03802.html">Re: Link Walking via Map Reduce</a></span> <span class="sender italic">Andrew Berman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03803.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Mathias Meyer</span></li>
<li class="icons-email"><span class="subject"><a href="msg03804.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Andrew Berman</span></li>
<li class="icons-email"><span class="subject"><a href="msg03805.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Jeremiah Peschka</span></li>
<li class="icons-email"><span class="subject"><a href="msg03807.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Russell Brown</span></li>
<li class="icons-email"><span class="subject"><a href="msg03809.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Andrew Berman</span></li>
<li class="icons-email"><span class="subject"><a href="msg03820.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Andrew Berman</span></li>
<li class="icons-email"><span class="subject"><a href="msg03822.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Andrew Berman</span></li>
<li class="icons-email"><span class="subject"><a href="msg03824.html">Re: Link Walking via Map Re...</a></span> <span class="sender italic">Andrew Berman</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Link Walking via Map Reduce">
<input type="hidden" name="msgid" value="BANLkTi=RWbOPOJzPj3fwz0BDFz31FNTS5A@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03800.html">
<input type="submit" value=" Andrew Berman ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Link+Walking+via+Map+Reduce%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03797.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03801.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">BANLkTi=RWbOPOJzPj3fwz0BDFz31FNTS5A@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
