<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Questions about ring size</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#10403" id="c">
<link rel="index" href="mail2.html#10403" id="i">
<link rel="prev" href="msg10372.html" id="p">
<link rel="next" href="msg10365.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10403.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Questions+about+ring+size%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Questions about ring size</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Jordan+West%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Jordan West</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130312" rel="nofollow">Tue, 12 Mar 2013 22:46:05 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Chris,

The setting is &quot;handoff_concurrency&quot; not &quot;max_concurrency&quot;. Some details
about the setting
can be found in the documentation [1] [2], however, it looks like we could
add a bit more
detail in places. The default value is 2.</pre><pre>

Regarding adding new nodes if you have the ability to test this in your
environment I would
suggest trying to add them all at once or in a few groups (using staged
clustering) because
this will result in less overall transfers. Instead you can adjust
handoff_concurrency on
different nodes to control the load on the cluster.

Adjusting the ring size of a live cluster is something we are working on. A
branch can be found
on GitHub [3]. Unfortunately it is unclear when this will land in Riak.

Cheers,
Jordan


[1]
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/references/Command-Line-Tools---riak-admin/#transfer-limit">http://docs.basho.com/riak/latest/references/Command-Line-Tools---riak-admin/#transfer-limit</a>
[2]
<a  rel="nofollow" href="http://docs.basho.com/riak/latest/references/Configuration-Files/#app-config">http://docs.basho.com/riak/latest/references/Configuration-Files/#app-config</a>
[3] <a  rel="nofollow" href="https://github.com/basho/riak_core/commits/jrw-dynamic-ring">https://github.com/basho/riak_core/commits/jrw-dynamic-ring</a>

On Mon, Mar 11, 2013 at 4:21 AM, Chris Read &lt;chris.r...@gmail.com&gt; wrote:

&gt; Thanks Mark...
&gt;
&gt;
&gt; On Sat, Mar 9, 2013 at 1:29 AM, Mark Phillips &lt;m...@basho.com&gt; wrote:
&gt;
&gt;&gt; Hi Chris,
&gt;&gt;
&gt;&gt; Thanks for the detailed write up. These are some great data points.
&gt;&gt;
&gt;&gt; We're doing some work right now to make large rings (where &quot;large&quot; =
&gt;&gt; more than 512 partitions) more efficient in terms of start and
&gt;&gt; convergence time, and handoff.
&gt;&gt;
&gt;&gt;
&gt; Good to hear.
&gt;
&gt;
&gt;&gt; First things first: since your test cluster has no data in it, adding
&gt;&gt; &quot;forced_ownership_handoff&quot; to your riak_core section of your
&gt;&gt; app.config and up'ing it to something higher than your ring size
&gt;&gt; should help hasten convergence. *This is only useful for the purposes
&gt;&gt; of testing and should not be done in production.* That would look like
&gt;&gt; this:
&gt;&gt;
&gt;&gt; {forced_ownership_handoff, 512}
&gt;&gt;
&gt;&gt;
&gt; I'm doing this to understand current production problems. If it should not
&gt; be done in production then I'm not interested :D
&gt;
&gt;
&gt;&gt; You could also increase the &quot;max_concurrency&quot; setting (which also has
&gt;&gt; to be added to the riak_core section in your app.config). This
&gt;&gt; defaults to &quot;2&quot;. You could also look at lowering the
&gt;&gt; &quot;vnode_management_timer&quot; from &quot;10000&quot; (10 seconds by default).
&gt;&gt;
&gt;&gt;
&gt; Can you point me at more documentation for &quot;max_concurrency&quot;? I've looked
&gt; at the code, and it's clear what &quot;vnode_management_timer&quot; does, but my
&gt; Elrang-foo is not good enough to be certain on the impacts of
&gt; &quot;max_concurrency&quot;. How does it interact with &quot;handoff_concurrency&quot; (if at
&gt; all) which we currently have at 8?
&gt;
&gt;
&gt;&gt; Back to the current limitations of Riak..
&gt;&gt;
&gt;&gt; A few members of the Basho eng team - primarily Joe Blomstedt - have
&gt;&gt; been hacking on the ring-relate code for the last week or so are
&gt;&gt; making some great progress. The improvements will be in the 1.4
&gt;&gt; release (though it is a few months out from being official). To quote
&gt;&gt; Joe from an internal email: &quot;in my current work-in-progress branch, I
&gt;&gt; successfully joined 4-nodes together using a 16384 ring yesterday.
&gt;&gt; Still took about 20 min, but working on bringing that down even
&gt;&gt; further today. Also, impact to cluster performance is worlds
&gt;&gt; different.&quot;
&gt;&gt;
&gt;&gt; So, we're well aware of the improvements that need to be made in the
&gt;&gt; arena and are working quickly to improve. I think Joe has plans to
&gt;&gt; share his working code with the list in the near future (via a GitHub
&gt;&gt; PR/Issue I suspect), so look out for that.
&gt;&gt;
&gt;&gt; In the interim, I would stick with a ring size of 512 or less for
&gt;&gt; productions clusters if you're not already live, and lean on some
&gt;&gt; beefier hardware to mitigate the current inefficiencies with large
&gt;&gt; rings until the code is purified.
&gt;&gt;
&gt;&gt;
&gt; We're already live with a ring size of 512, and we're pretty close to
&gt; 100TB of data in there and we're seeing handoff problems already which is
&gt; why I'm investigating this further. As for beefiness of hardware, we're
&gt; currently running dual 6 core Intel X5675 machines with 96G RAM with 10G
&gt; Ethernet links between nodes. We're not going to get beefier any time soon.
&gt;
&gt; We're currently growing the cluster from the 10 nodes we started with to
&gt; 20 to cope with the load, but it takes almost 3 days for handoff to a new
&gt; node to happen. We're doing it one by one instead of as a bulk add
&gt; operation because with almost 200G per partition the window of &quot;not found&quot;
&gt; errors between a new node taking the partition and completing transfer to
&gt; serve the data is already uncomfortably high.
&gt;
&gt;
&gt;
&gt;&gt; Let us know if you have any other questions. Thanks for your testing
&gt;&gt; and patience.
&gt;&gt;
&gt;
&gt; One more question I have is around changing the ring size on a running
&gt; cluster. Is it something that you're working on? While we're at less than
&gt; about 150TB of data in our cluster we can probably find a way to build a
&gt; second cluster and transfer the data over, but we expect to reach the stage
&gt; where we'll have over 500TB of data in riak, and at that stage we won't be
&gt; able to build a second cluster and don't want to be stuck with almost 1TB
&gt; of data per partition...
&gt;
&gt; Thanks,
&gt;
&gt; Chris
&gt;
&gt;
&gt;&gt;
&gt;&gt; Mark
&gt;&gt;
&gt;&gt;
&gt;&gt; On Fri, Mar 8, 2013 at 6:37 AM, Chris Read &lt;chris.r...@gmail.com&gt; wrote:
&gt;&gt; &gt; Greetings all...
&gt;&gt; &gt;
&gt;&gt; &gt; While I can find lots of documentation about what a ring is and how it's
&gt;&gt; &gt; using in Riak, I've found very little that's actually useful about
&gt;&gt; &gt; determining the right size for your system. The most useful formula I've
&gt;&gt; &gt; found so far has been the simple:
&gt;&gt; &gt;
&gt;&gt; &gt; ring size = 2 ^ (ceiling(log(max nodes * min partitions per node, 2)))
&gt;&gt; &gt;
&gt;&gt; &gt; Where the minimum recommended number of partitions per node is 10 (as
&gt;&gt; per
&gt;&gt; &gt;
&gt;&gt; <a  rel="nofollow" href="http://docs.basho.com/riak/latest/cookbooks/faqs/operations-faq/#is-it-possible-to-change-the-number-of-partitions">http://docs.basho.com/riak/latest/cookbooks/faqs/operations-faq/#is-it-possible-to-change-the-number-of-partitions</a>
&gt;&gt; ).
&gt;&gt; &gt;
&gt;&gt; &gt; Nothing tells me though what sane upper bound is for the amount of data
&gt;&gt; in a
&gt;&gt; &gt; partition, or the overhead inside the cluster of managing larger ring
&gt;&gt; sizes.
&gt;&gt; &gt; My gut feel though is that more than a couple of hundred gigabytes per
&gt;&gt; &gt; partition is getting a bit much.
&gt;&gt; &gt;
&gt;&gt; &gt; I've done some initial testing of ring sizes across a cluster of 9
&gt;&gt; physical
&gt;&gt; &gt; machines and have seen some concerning results. All the numbers below
&gt;&gt; are
&gt;&gt; &gt; done on the same hardware running Ubuntu 12.04 with Riak 1.3.0 (official
&gt;&gt; &gt; .deb release):
&gt;&gt; &gt;
&gt;&gt; &gt; Ring Size      |   512 |  1024 |    2048 |
&gt;&gt; &gt; Create Cluster | 01:53 | 05:41 | 0:12:58 |
&gt;&gt; &gt; Remove Node    | 04:01 | 10:31 | 0:31:13 |
&gt;&gt; &gt; Add Node       | 01:05 | 05:22 | 1:04:49 |
&gt;&gt; &gt;
&gt;&gt; &gt; All this is done with NO DATA in the cluster at all - so why does it
&gt;&gt; take
&gt;&gt; &gt; over an hour to add a new node when ring=2048?
&gt;&gt; &gt;
&gt;&gt; &gt; Does it have anything to do with the concerns raised on this thread:
&gt;&gt; &gt;
&gt;&gt; <a  rel="nofollow" href="https://groups.google.com/forum/?fromgroups=#!topic/nosql-databases/DZkgkgd9YnA">https://groups.google.com/forum/?fromgroups=#!topic/nosql-databases/DZkgkgd9YnA</a>
&gt;&gt; &gt;
&gt;&gt; &gt; Thanks,
&gt;&gt; &gt;
&gt;&gt; &gt; Chris
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; _______________________________________________
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt; &gt;
&gt;&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10372.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#10403">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#10403">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10365.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10364.html">Questions about ring size</a></span> <span class="sender italic">Chris Read</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10367.html">Re: Questions about ring size</a></span> <span class="sender italic">Mark Phillips</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10372.html">Re: Questions about ring size</a></span> <span class="sender italic">Chris Read</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Questions about ring size</span> <span class="sender italic">Jordan West</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Questions about ring size">
<input type="hidden" name="msgid" value="CANvRNdcFn=nPvYQhZris8-TfYnEu4JFXL-AxhK06GLreQ_f5YA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10403.html">
<input type="submit" value=" Jordan West ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Questions+about+ring+size%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10372.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10365.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CANvRNdcFn=nPvYQhZris8-TfYnEu4JFXL-AxhK06GLreQ_f5YA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
