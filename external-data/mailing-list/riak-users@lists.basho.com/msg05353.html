<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Severe problems when adding a new node</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#05353" id="c">
<link rel="index" href="maillist.html#05353" id="i">
<link rel="prev" href="msg05345.html" id="p">
<link rel="next" href="msg05355.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05353.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Severe+problems+when+adding+a+new+node%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Severe problems when adding a new node</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22John+Axel+Eriksson%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">John Axel Eriksson</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111028" rel="nofollow">Fri, 28 Oct 2011 16:03:35 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've got the utmost respect for developers such as yourselves(Basho) and we've 
had great success using Riak - we have been using it
in production since 0.11. We've had our share of problems with it during this 
whole time but none as big as this. I can't understand why
this wasn't posted somewhere using the blink tag and big red bold text. I mean 
if I try to fsck a mounted disk in use in Linux I get:</pre><pre>

&quot;WARNING!!!  The filesystem is mounted.   If you continue you ***WILL***
cause ***SEVERE*** filesystem damage.&quot;

I understand why I don't get a warning like that when trying to run &quot;riak-admin 
join r...@my.node.com&quot; on Riak 1.0.1 but something similar to
it happens.

It goes against the whole idea of Riak being an ops-dream, distributed, 
fault-tolerant system having a bug such as this without disclosing it
more openly than an entry in a bug tracking system. I don't want to be afraid 
of adding nodes to my cluster but that is the result of this bug and
the lack of communication of same bug. The 1.0.1 release should have been 
pulled in my opinion.

To sum it up, this was a nightmare for us, I didn't get much sleep last night 
and I woke up in hell. All that, corrupted data, downtime and lost customer
confidence could have been avoided by better communication.

I don't want to be too hard on you fine people of Basho and you provide a 
really great system in Riak and I understand what you're aiming for, but if
anything as bad as this ever happens in the future you might want to 
communicate it better and consider pulling the release.

Thanks,
John


28 okt 2011 kl. 17:51 skrev Kelly McLaughlin:

&gt; John,
&gt; 
&gt; It appears you've run into a race condition with adding and leaving nodes 
&gt; that's present in 1.0.1. The problem happens during handoff and can cause 
&gt; bitcask directories to be unexpectedly deleted. We have identified the issue 
&gt; and we are in the process of correcting it, testing, and generating a new 
&gt; point release containing the fix. In the meantime, we apologize for the 
&gt; inconvenience and irritation this has caused. 
&gt; 
&gt; Kelly
&gt; 
&gt; 
&gt; On Oct 28, 2011, at 9:14 AM, John Axel Eriksson wrote:
&gt; 
&gt;&gt; Last night we did two things. First we upgraded our entire cluster from 
&gt;&gt; riak-search 0.14.2 to 1.0.1. This process went
&gt;&gt; pretty well and the cluster was responding correctly after this was 
&gt;&gt; completed.
&gt;&gt; 
&gt;&gt; In our cluster we have around 40 000 files stored in Luwak (we also have 
&gt;&gt; about the same amount of keys, or more, in riak which is mostly
&gt;&gt; the metadata for the files in Luwak). The files are in sizes ranging from 
&gt;&gt; around 50K to  around 400MB, most of the files are pretty small though. I
&gt;&gt; think we're up to a total of around 30GB now.
&gt;&gt; 
&gt;&gt; Anyway, upon adding a new node to the now 1.0.1 cluster I saw the beam.smp 
&gt;&gt; processes on all the servers, including the new one, taking
&gt;&gt; up almost all available cpu. It stayed in this state for around an hour and 
&gt;&gt; the cluster was slow to respond and occasionally timed out. During the
&gt;&gt; process Riak crashed on random nodes from time to time and I had to restart 
&gt;&gt; it. After about an hour things settled down. I added this
&gt;&gt; new node to our load-balancer so it too could serve requests. When testing 
&gt;&gt; our apps against the cluster we still got lots of timeouts and something
&gt;&gt; seemed very very wrong.
&gt;&gt; 
&gt;&gt; After a while I did a &quot;riak-admin leave&quot; on the node that was added (kind of 
&gt;&gt; a panic move I guess). Around 20 minutes after I did this, the cluster 
&gt;&gt; started
&gt;&gt; responding correctly again. All was not well though - files seemed to be 
&gt;&gt; corrupted(not sure what percentage but could be 1 % or more). I have no idea 
&gt;&gt; how
&gt;&gt; that could happen but files that we had accessed before now contained 
&gt;&gt; garbage. I haven't thoroughly researched exactly WHAT garbage they contain 
&gt;&gt; but
&gt;&gt; they're not in a usable state anymore. Is this something that could happen 
&gt;&gt; under any circumstances in Riak?
&gt;&gt; 
&gt;&gt; I'm afraid of adding a node at all now since it resulted in downtime and 
&gt;&gt; corruption when I tried it. I checked and rechecked the configuration files 
&gt;&gt; and really - they're
&gt;&gt; the same on all the nodes (except for vm.args where they have different 
&gt;&gt; names of course). Has anyone ever seen anything like this? Could it somehow 
&gt;&gt; be related to
&gt;&gt; the fact that I did an upgrade from 0.14.2 to 1.0.1 and maybe an hour later 
&gt;&gt; added a new 1.0.1 node?
&gt;&gt; 
&gt;&gt; Thanks for any input!
&gt;&gt; 
&gt;&gt; John
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05345.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#05353">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05353">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05355.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg05343.html">Severe problems when adding a new node</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05344.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">Aphyr</span></li>
<li class="icons-email"><span class="subject"><a href="msg05345.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">Kelly McLaughlin</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Severe problems when adding a new node</span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05355.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">David Smith</span></li>
<li class="icons-email"><span class="subject"><a href="msg05470.html">Re: Severe problems when adding a new node</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05498.html">Re: Severe problems when adding a new ...</a></span> <span class="sender italic">John Axel Eriksson</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Severe problems when adding a new node">
<input type="hidden" name="msgid" value="344D66FC-FA5C-4F94-81E1-9388EAA9837D@insane.se">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05353.html">
<input type="submit" value=" John Axel Eriksson ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Severe+problems+when+adding+a+new+node%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05345.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05355.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">344D66FC-FA5C-4F94-81E1-9388EAA9837D@insane.se</li>
</ul>
</div>
</body>
</html>
