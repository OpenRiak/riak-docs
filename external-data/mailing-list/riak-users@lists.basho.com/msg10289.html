<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: MapReduce scalability</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10289" id="c">
<link rel="index" href="maillist.html#10289" id="i">
<link rel="prev" href="msg10285.html" id="p">
<link rel="next" href="msg10292.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10289.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+MapReduce+scalability%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: MapReduce scalability</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Rune+Skou+Larsen%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Rune Skou Larsen</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130228" rel="nofollow">Thu, 28 Feb 2013 09:04:07 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
A general comment on Riak's Reduce scalability.

</pre><tt>Map scales fine but Reduce doesn't. The single coordinating node does 
</tt><tt>the final reducing, so latency from reduces will not improve from adding 
</tt><tt>more nodes. MR jobs where lots of data is sent from map to reduce, will 
</tt><tt>also get the coordinating node in trouble holding it in memory.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>Pre-reduce to the rescue! Work done in reduce-phases can usually be at 
</tt><tt>least partly distributed. For instance counting, finding the highest 
</tt><tt>number or even sorting. Riak supports this by means of a pre-reduce 
</tt><tt>phase, which takes place on the same node as the map-function emitting 
</tt><tt>the values. The idea is, if each set of results sent to the coordinating 
</tt><tt>node is already pre-aggregated, you may be able to reduce inter-node 
</tt><tt>communication, work and/or memory usage of the coordinating node.
</tt><pre style="margin: 0em;">

</pre><tt>Example: Your map-phase emits a lot of numbers, and you want to find the 
</tt><tt>highest. Without pre-reduce, all values are sent to the coordinating 
</tt><tt>node - most over the network. With pre-reduce, 1 value is sent per 
</tt><tt>partition.
</tt><pre style="margin: 0em;">

</pre><tt>Prereduce has it limitations though. A common example being a map-phase 
</tt><tt>emitting {key, value}-pairs where for each key, you want to aggregate 
</tt><tt>the value.
</tt><tt>Example: Riak contains purchase orders, and you want to calculate the 
</tt><tt>average purchase amount based on zip-code. The map-function runs through 
</tt><tt>all orders and emits {zip-code, amount}. To distribute the aggregation, 
</tt><tt>you need a <a  rel="nofollow" href="http://en.wikipedia.org/wiki/MapReduce#Partition_function">http://en.wikipedia.org/wiki/MapReduce#Partition_function</a>, 
</tt><tt>like hadoop's shuffle phase. This is currently unsupported in Riak, but 
</tt><tt>definitely doable with Riak Pipe, so I hope it'll come soon :-)
</tt><pre style="margin: 0em;">


BR Rune

</pre><tt>BTW: Christian's reply is entirely accurate to my understanding, but 
</tt><tt>misses the pre-reduce stuff.
</tt><pre style="margin: 0em;">


Den 28-02-2013 16:17, Christian Dahlqvist skrev:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Bernard,

</pre><tt>The description in the documentation is entirely accurate and not at 
</tt><tt>all purely theoretical. Riak will automatically select a covering set 
</tt><tt>of vnodes/partitions that hold the data set required to complete the 
</tt><tt>job. All physical nodes may therefore net need to participate in the 
</tt><tt>job. When performing this selection, the coordinating node will take 
</tt><tt>into account any node outages.
</tt><pre style="margin: 0em;">

</pre><tt>Any map phases will then run on all of these vnodes and use the data 
</tt><tt>stored on each local partition. In order to make it as efficient as 
</tt><tt>possible, it will use only the versions of the data available locally 
</tt><tt>and will not perform a quorum read against all the replicas holding a 
</tt><tt>copy of that data as this would result in a lot of network traffic 
</tt><tt>when running large jobs. The outputs of any map phases are then sent 
</tt><tt>over to the coordinating node where any reduce phases would normally run.
</tt><pre style="margin: 0em;">

</pre><tt>As the input to the map phase only reads from one replica for every KV 
</tt><tt>pair, results can differ from run to run if all replicas are not in 
</tt><tt>sync. This likelihood of this happening should however be reduced with 
</tt><tt>the introduction of active anti-entropy in release 1.3 of Riak, but 
</tt><tt>will due to the eventually consistent nature of Riak never be 
</tt><tt>completely eliminated.
</tt><pre style="margin: 0em;">

</pre><tt>MapReduce is quite resilient to data issues as long as any map phase 
</tt><tt>functions used have been designed to handle notfounds and tombstones. 
</tt><tt>Nodes going down during a MapReduce job will however in many cases 
</tt><tt>cause it to fail.
</tt><pre style="margin: 0em;">

</pre><tt>Although it would technically be possible to create a map phase 
</tt><tt>function in Erlang that performs a quorum read using the internal Riak 
</tt><tt>client and then performs any processing based on this object instead 
</tt><tt>of the one passed in, this is strongly discouraged as it would add a 
</tt><tt>lot of additional network traffic and pose a significant risk of 
</tt><tt>overloading the cluster.
</tt><pre style="margin: 0em;">

Best regards,

Christian


</pre><tt>On 28 Feb 2013, at 13:53, Bernard Fouché &lt;bernard.fou...@kuantic.com 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:bernard.fou...@kuantic.com">mailto:bernard.fou...@kuantic.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Christian,

</pre><tt>At 
</tt><tt><a  rel="nofollow" href="http://docs.basho.com/riak/1.3.0/references/appendices/MapReduce-Implementation/">http://docs.basho.com/riak/1.3.0/references/appendices/MapReduce-Implementation/</a> 
</tt><tt>, one can read &quot;...any Riak node can also coordinate a MapReduce 
</tt><tt>query by sending a map-step evaluation request directly to the node 
</tt><tt>responsible for maintaining the input data. Map-step results are sent 
</tt><tt>back to the coordinating node, where reduce-step processing can 
</tt><tt>produce a unified result.&quot;.
</tt><pre style="margin: 0em;">

</pre><tt>What you wrote means that the above description is purely theoretical 
</tt><tt>since if there is any problem to get access to data in a node, then 
</tt><tt>the MR fails. We have also seen that deleting a key while doing a MR 
</tt><tt>just makes the MR to run forever so it makes me think that your 
</tt><tt>description is accurate and for the documentation to be correct it 
</tt><tt>seems that one must first be sure that all input data reading will 
</tt><tt>never trigger any kind of error processing, otherwise the MR job will 
</tt><tt>fail (or be stuck). Please correct me if I've misunderstood!
</tt><pre style="margin: 0em;">

</pre><tt>Now if I want to split processing of a list of keys in the cluster, 
</tt><tt>is there a way to know what node is supposed to have at least one 
</tt><tt>copy of a K/V ?
</tt><pre style="margin: 0em;">

</pre><tt>If so, we can setup our own kind of MR, by sending subset of keys to 
</tt><tt>nodes known to have at least one version of the K/V pair. Hence if 
</tt><tt>R==2, there will be one local read in the node receiving the subset 
</tt><tt>and only one more read in another node that holds a copy. Then this 
</tt><tt>distributed processing can handle read-repair, aggregate data and 
</tt><tt>send the result to the coordinating node.
</tt><pre style="margin: 0em;">

Best Regards,

        Bernard
Le 28/02/2013 10:32, Christian Dahlqvist a écrit :
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Boris,

</pre><tt>Apart from not scaling quite as well as straight K/V access, 
</tt><tt>emulating multiGET through MapReduce also has another significant 
</tt><tt>drawback. MapReduce has no concept of quorum reads, and only work on 
</tt><tt>a single copy of the data, which can be thought of basically as a 
</tt><tt>read with R=1 that does not trigger read-repair. It is therefore 
</tt><tt>possible that it can give inconsistent or incorrect results if all 
</tt><tt>replicas do not have the same data. It is worth noting that 
</tt><tt>MapReduce was designed as a way to efficiently spread compute work 
</tt><tt>across the cluster, and re-appropriating it for use with data 
</tt><tt>collection is not its designed purpose.
</tt><pre style="margin: 0em;">

</pre><tt>The recommended way to implement efficient multiget is to perform 
</tt><tt>normal GET operations in parallel. If you are retrieving 20 objects, 
</tt><tt>you don't necessarily need to do all 20 GETs in parallel, but could 
</tt><tt>set it up to use perhaps 3 or 4 connections. If you then pair this 
</tt><tt>with a connection pool that can grow and shrink in size (perhaps 
</tt><tt>between a minimum and a maximum value) as load requires, you should 
</tt><tt>be able to retrieve the objects in a reasonable time without 
</tt><tt>overloading the cluster.
</tt><pre style="margin: 0em;">

Best regards,

Christian


</pre><tt>On 27 Feb 2013, at 02:18, Boris Okner &lt;boris.ok...@gmail.com 
</tt><tt>&lt;<a  rel="nofollow" href="mailto:boris.ok...@gmail.com">mailto:boris.ok...@gmail.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Thanks Christian,

</pre><tt>The problem I'm trying to solve is to find the way to retrieve 
</tt><tt>values for limited number of keys with the best possible latency 
</tt><tt>(or maybe with decent latency which is balanced with decent 
</tt><tt>throughput). Let's say we have keys stored in some cache
</tt><tt>on top of Riak, and want to retrieve values, 20 at the time, to be 
</tt><tt>able to implement pagination. Another alternative to mapreduce 
</tt><tt>would to send multiple asynchronous gets, but then we'd have to 
</tt><tt>worry about connection pool being exhausted if there's too many 
</tt><tt>such &quot;page&quot; requests. So what would be the proper way to deal with 
</tt><tt>the situation when we need to emulate multiple key retrieval?
</tt><pre style="margin: 0em;">

</pre><tt>On Tue, Feb 26, 2013 at 1:57 AM, Christian Dahlqvist 
</tt><tt>&lt;christ...@basho.com &lt;<a  rel="nofollow" href="mailto:christ...@basho.com">mailto:christ...@basho.com</a>&gt;&gt; wrote:
</tt><pre style="margin: 0em;">

    Hi Boris,

    MapReduce is a very flexible and powerful way of querying Riak
    and allows processing to be performed locally where the data
    resides, which allows for efficient processing of larger data
    sets. A result of this is that every mapreduce job requires a
    covering set of vnodes (all vnodes that hold the data required
    for processing) to participate, meaning that it puts
    considerable more load on the system compared to straight K/V
    access and therefore does not scale quite as well. It is
    primarily designed for batch type processing over reasonably
    large amounts of data and scales well with increased data
    volumes as new nodes are added. We do however usually not
    recommended using it as an interface for realtime queries where
    low and predictable latencies are required and the concurrency
    level, and therefore load level on the cluster, can not be
    controlled.

    I am not sure I understand what you mean by the performance
    degrading with the number of nodes, unless you are strictly
    measuring latency rather than throughput. As the number of
    nodes increase, it gets more and more likely that multiple
    physical nodes will be involved in the job, which will add to
    the amount of communication and coordination required between
    the nodes, thereby increasing latency. Could you please explain
    in more detail what you are trying to achieve?

    Best regards,

    Christian


    On 25 Feb 2013, at 16:41, Boris Okner &lt;boris.ok...@gmail.com
    &lt;<a  rel="nofollow" href="mailto:boris.ok...@gmail.com">mailto:boris.ok...@gmail.com</a>&gt;&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
    Hello,

    I'm experimenting with 2 Riak 1.3.0 nodes (both are &quot;bare
    metal&quot;), and it looks like mapreduce performs better when one
    of the nodes is down. The mapreduce requests are running on
    20-key blocks. So am I doing something wrong, or is it an
    expected behaviour, i.e. mapreduce degrades with the the
    number of nodes increased? If the former, could
    you give me some pointers on how to set up it to get advantage
    of multiple nodes?

    Thanks in advance for your help,
    Boris
    _______________________________________________
    riak-users mailing list
    riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
    <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">



_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


--
sdfd

Best regards / Venlig hilsen

*Rune Skou Larsen*
NoSQL Team Lead
Trifork Public A/S
Margrethepladsen 4, 8000 Århus C, Denmark
Phone: +45 3160 2497    Skype: runeskoularsen   twitter: @RuneSkouLarsen

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10285.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10289">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10289">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10292.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10237.html">MapReduce scalability</a></span> <span class="sender italic">Boris Okner</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10241.html">Re: MapReduce scalability</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10266.html">Re: MapReduce scalability</a></span> <span class="sender italic">Boris Okner</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10283.html">Re: MapReduce scalability</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10284.html">Re: MapReduce scalability</a></span> <span class="sender italic">Bernard Fouché</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10285.html">Re: MapReduce scalability</a></span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: MapReduce scalability</span> <span class="sender italic">Rune Skou Larsen</span></li>
<li class="icons-email"><span class="subject"><a href="msg10292.html">Re: MapReduce scalability</a></span> <span class="sender italic">Bernard Fouché</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg10290.html">Re: MapReduce scalability</a></span> <span class="sender italic">Elias Levy</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: MapReduce scalability">
<input type="hidden" name="msgid" value="512F8DAD.2010301@trifork.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10289.html">
<input type="submit" value=" Rune Skou Larsen ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+MapReduce+scalability%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10285.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10292.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">512F8DAD.2010301@trifork.com</li>
</ul>
</div>
</body>
</html>
