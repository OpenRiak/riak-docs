<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Differences between riak_client and riak_kv_mrc_pipe MapReduce	when one node is down.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09936" id="c">
<link rel="index" href="maillist.html#09936" id="i">
<link rel="prev" href="msg09927.html" id="p">
<link rel="next" href="msg09937.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09936.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Differences+between+riak_client+and+riak_kv_mrc_pipe+MapReduce%09when+one+node+is+down.%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Differences between riak_client and riak_kv_mrc_pipe MapReduce	when one node is down.</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22gunin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">gunin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130131" rel="nofollow">Thu, 31 Jan 2013 03:09:40 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Sorry John. You don't understand my question.
1. One node(I mean physical(erlang) node) in cluster is down.
2. It was down when i'm start job,when perform job and after it. We power off 
this node. It's under repair. But we don't remove this node from cluster.
3. All data that must be processed available. On primary and fallback vnodes 
started on other physical(erlang) node. We don't need read repair for this 
data.(As you see old style MapReduce work fine,it's use luke module)
4. If something fail I want receive error,but actually last reduce phase  call 
this empty list,and after that return empty list. For example 4 times of 5 i'am 
receive good result that contains all data,
but 1 of 5 i'm receive empty result.
5. I don't see any vnode fails during MapReduce task.</pre><pre>

Thank you.

PS. I prepare simple test script later.

----- Исходное сообщение -----
От: &quot;John Daily&quot; &lt;jda...@basho.com&gt;
Кому: gu...@mail.mipt.ru
Копия: riak-users@lists.basho.com
Отправленные: Четверг, 31 Январь 2013 г 1:58:38
Тема: Re: Differences between riak_client and riak_kv_mrc_pipe MapReduce when 
one node is down.

Riak's MapReduce functionality cannot survive a node failure. If a vnode 
involved with a query fails while actively processing the request, the entire 
query will have to be re-run. The failed query should be automatically 
terminated, but you'll have to re-run the query yourself.

If you create queries using Riak Pipe (the technology layer beneath MapReduce), 
it is possible to create queries that can survive a vnode failure, but that is 
not a trivial exercise.

Regarding the empty result set you're seeing: one possibility is that a vnode 
has failed recently and has come back online without data. MapReduce will not 
currently trigger a read repair, but that problem should be resolved with the 
forthcoming Riak 1.3 release.

-John Daily
Technical Evangelist
Basho

On Jan 30, 2013, at 8:05 AM, gu...@mail.mipt.ru wrote:

&gt; We have 6 node riak cluster.I simple custom erlang application for custom 
&gt; MapReduce job.
&gt; 
&gt; We start MapReduce job using riak_kv_mrc_pipe pipe module,for example - 
&gt; 
&gt; Query = [{map, {modfun,Mod,MapFun},[do_prereduce,{from,1}], false},{reduce, 
&gt; {modfun,Mod,ReduceFun},[{reduce_phase_batch_size, 1000}], true}],
&gt; riak_kv_mrc_pipe:mapred({index,Bucket,Field,From,To},Query,Timeout).
&gt; 
&gt; But if one of the node down for along time. Response is unpredictable 
&gt; sometimes it's return {ok,GoodResultList}, but sometimes {ok,[]}(empty list).
&gt; We trace riak_kv and riak_pipe and found too problem:
&gt; 1. In riak_kv_pipe_index or in riak_kv_pipe_liskeys created fitting_spec this 
&gt; nval always is 1.
&gt; 2. Actual error is occurred in riak_pipe_vnode:remaining_preflist that retun 
&gt; empty PrefList for some Hash(#fitting_spec.nval is 1). It use 
&gt; riak_core_apl:get_primary_apl function.
&gt; 
&gt; But if we use old style map reduce,for example:
&gt;        {ok,C} = riak:local_client(),
&gt;        Me = self(),
&gt;        Query = [{map, {modfun,Mod,MapFun},[do_prereduce,{from,1}], 
&gt; false},{reduce, {modfun,Mod,ReduceFun},[{reduce_phase_batch_size, 1000}], 
&gt; true}],
&gt;       {ok, {ReqId,FlowPid}} = C:mapred_stream(Query,Me,Timeout),
&gt;       
&gt; {ok,_}=riak_kv_index_fsm_sup:start_index_fsm(zont_riak_connection:riak_node(),
&gt;  [{raw, ReqId,FlowPid}, [Bucket, none,{range,Field,From,To},Timeout,mapred]]),
&gt;       luke_flow:collect_output(ReqId, Timeout).
&gt; 
&gt; Query executed well. But problem is that do_prereduce and 
&gt; {reduce_phase_batch_size, 1000} is ignored,that why execution is slow.
&gt; 
&gt; 
&gt; Can you make some recommendation? May be riak_pipe_vnode:remaining_preflist 
&gt; we need use riak_core_apl:get_apl_ann or set #fitting_spec.nval to nval from 
&gt; out Bucket props?
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09927.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09936">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09936">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09937.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09920.html">Differences between riak_client and riak_kv_mrc_pipe MapReduce ...</a></span> <span class="sender italic">gunin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09927.html">Re: Differences between riak_client and riak_kv_mrc_pipe M...</a></span> <span class="sender italic">John Daily</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Differences between riak_client and riak_kv_mrc_pi...</span> <span class="sender italic">gunin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09937.html">Re: Differences between riak_client and riak_kv_mr...</a></span> <span class="sender italic">Bryan Fink</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09940.html">Re: Differences between riak_client and riak_k...</a></span> <span class="sender italic">gunin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09946.html">Re: Differences between riak_client and r...</a></span> <span class="sender italic">gunin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09950.html">Re: Differences between riak_client a...</a></span> <span class="sender italic">gunin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09952.html">Re: Differences between riak_clie...</a></span> <span class="sender italic">Bryan Fink</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Differences between riak_client and riak_kv_mrc_pipe MapReduce	when one node is down.">
<input type="hidden" name="msgid" value="c5031801-45b3-4706-af3d-42a0770de2b7@mail">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09936.html">
<input type="submit" value=" gunin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Differences+between+riak_client+and+riak_kv_mrc_pipe+MapReduce%09when+one+node+is+down.%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09927.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09937.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">c5031801-45b3-4706-af3d-42a0770de2b7@mail</li>
</ul>
</div>
</body>
</html>
