<!DOCTYPE html>
<html lang="en">
<head>
<title>Map/Red Function Cache Corruption?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#03919" id="c">
<link rel="index" href="maillist.html#03919" id="i">
<link rel="prev" href="msg03917.html" id="p">
<link rel="next" href="msg03925.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg03919.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Map%5C%2FRed+Function+Cache+Corruption%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Map/Red Function Cache Corruption?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Eric+Stevens%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Eric Stevens</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110702" rel="nofollow">Sat, 02 Jul 2011 05:40:33 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I've been struggling with this for a few days now.  I have a pair of related
Map/Reduce queries.  Executed individually they produce the expected
results, but when executed in parallel (simultaneous XHR calls from the
browser), their results tend to get mixed up with each other; I see values
from both mixed together in a single result.</pre><pre>

Once that corruption happens, even the calls executed individually can end
up with cross-pollinated results.  It seems to be related to the caching of
the anonymous javascript functions used, as adding a space to the function
declaration clears the issue up. Taking that space back out causes the
problem again.

I can confirm that the corruption can become persistent by using a line such
as (PHP client):
ejsLog('/tmp/mapred/reduce_&quot; . join('.', explode('\\', get_class($this))) .
&quot;.log', JSON.stringify(values));

After the corruption happens, if I clear the log path, execute just the one
map/red operation, I will see log entries appear for both classes (the class
name being encoded as part of the function declaration).  The problem seems
to happen for both map and reduce operations, though I have not specifically
noticed cross-contamination *between* map and reduce functions, just
map-for-map and reduce-for-reduce.

Adding this as the first line of the function declaration seems to solve the
problem, but this is obviously something intended to defeat caching, so I'm
sure there's a performance cost to this (note, just get_class($this) is not
sufficient, cross-contamination can still happen, each call needs to be *
unique* call-to-call, thus the mt_rand()).

&quot;//&quot;.get_class($this).'  '.mt_rand().&quot;

I noticed Francisco Treacy had this same problem back in September:
<a  rel="nofollow" href="http://riak-users.197444.n3.nabble.com/reduce-headaches-td1524860.html">http://riak-users.197444.n3.nabble.com/reduce-headaches-td1524860.html</a> but I
didn't see any resolution there.  Is there a potential longer term cost to
my cachebusting, such as memory exhaustion (i.e. is there any garbage
collection on the function cache)?

Any help would be sincerely appreciated!

-Eric
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg03917.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#03919">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#03919">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg03925.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Map/Red Function Cache Corruption?</span> <span class="sender italic">Eric Stevens</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03925.html">Re: Map/Red Function Cache Corruption?</a></span> <span class="sender italic">Mathias Meyer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg03949.html">Re: Map/Red Function Cache Corruption?</a></span> <span class="sender italic">Eric Stevens</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Map/Red Function Cache Corruption?">
<input type="hidden" name="msgid" value="CAORswtxW1gtFi0bOKedcjbJfTgtU_mQPk3mtqeaVBxEF_RHw0A@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg03919.html">
<input type="submit" value=" Eric Stevens ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Map%5C%2FRed+Function+Cache+Corruption%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg03917.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg03925.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAORswtxW1gtFi0bOKedcjbJfTgtU_mQPk3mtqeaVBxEF_RHw0A@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
