<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: v1.0.3 search merge index preventing partition handoff?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06414" id="c">
<link rel="index" href="maillist.html#06414" id="i">
<link rel="prev" href="msg06413.html" id="p">
<link rel="next" href="msg06427.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06414.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+v1.0.3+search+merge+index+preventing+partition+handoff%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: v1.0.3 search merge index preventing partition handoff?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kresten+Krab+Thorup%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kresten Krab Thorup</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120125" rel="nofollow">Wed, 25 Jan 2012 14:02:40 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi Ryan,

&gt;From the looks of the crash log, it seems that one of your merge index files 
&gt;may be corrupt (did you run out of disk space, or crash a node?)</pre><pre>

At any rate, what seems to be happening is that the search vnode is in the 
middle of a handoff (presumably to the new machine), and while it is doing a 
full scan of the merge index segment files to transfer data, it encounters a 
bad file.  This results in the crash log is that it tries to do 
binary_to_term(&lt;&lt;131,109,0,0,128,40,...&gt;&gt;) on a 46-byte binary; but the encoded 
stream says that the data length should be 128*16+40 bytes, i.e. 2088 bytes 
long.

So, something is too short, which I would guess could have happened because 
either the server crashed or ran out of disk.  From a casual inspection of the 
code, it doesn't look like merge indexes are resilient to a node crashing while 
it is writing to disk.

I don't know search intimately, but I have seen mention of problems before that 
were caused by &quot;bad indexes&quot;, and the resolution seems to be to delete the 
merge index files (the search index in your case 
/var/lib/riak/merge_index/159851741583067506678528028578343455274867621888), 
and then iterate over all values and re-write them.  Bummer.

Perhaps someone from Basho can chime in and tell us (A) if it seems plausible 
that the merge index segment files are indeed corrupt, and (B) if so, what is 
the right way to recover from that.

Kresten





On Jan 25, 2012, at 9:18 PM, Fisher, Ryan wrote:

Hello all,

We are hitting an issue with a riak 1.0.3 cluster when adding new nodes to the 
ring.  Specifically the handoff appears stuck and isn't making any progress.

I have read a number of the threads on here and realize handoff will take a 
while, and have also tried attaching to the console and doing a force_update 
along w/ force_handoffs.  However over 12 hours later the nodes haven't made 
any progress.  After digging through the log files it appears that the search 
merge_index could be my problem?  Possibly the compaction isn't occurring 
properly?

We are running a riak 1.0.3 cluster for a research project, where we are 
utilizing the python client for reads, writes, and queries of the cluster.  
Using a small data set of 20k keys things were humming along nicely.

We then started to ramp up the number of objects and ended up getting to around 
1M objects.  At this same time I added an additional node (w/ plans to expand 
to 8 nodes total).

However it appears that the partition handoff is stuck after performing the 
'join' command on the 5th node I was adding.

So currently it is a 4 + 1 node cluster with 4 gig of memory per node, am 
running the bitcask backend with 'search' enabled on some of the buckets.  
Specifically I am using the 'out of the box' JSON encoding schema by simply 
setting the mime-type to &quot;application/json&quot;, when I do the store from the 
python client.

I'm wondering if enabling search and using the default JSON schema was too much 
data to index?  Outside of increasing the linux file limit on the nodes, 
enabling 'search' (in the config file and w/ the pre-commit hook), and upping 
the ring_creation_size to 256 (before I started or added any nodes) there 
shouldn't be much else out of the ordinary going on.  This was an original 1.0 
riak cluster which I have been performing rolling upgrades on as the bug fix 
versions come out.  However currently all 4 + 1 nodes are 1.0.3

Here are the *I hope* relevant error logs?

Riak error log:
<a  rel="nofollow" href="http://pastebin.com/99cdPdCk">http://pastebin.com/99cdPdCk</a>

Riak crash log:
<a  rel="nofollow" href="http://pastebin.com/07FRZkf2">http://pastebin.com/07FRZkf2</a>

Riak erlang log:
<a  rel="nofollow" href="http://pastebin.com/DvdasWyR">http://pastebin.com/DvdasWyR</a>

Does anyone have any ideas on how to 'unstick' the partition handoff?  Or maybe 
the bigger question is indexing all of the incoming data (outside of the disk 
space requirements) a bad idea?  Perhaps I need to write a custom schema that 
limits what gets indexed?

I should mention that the search is a 'nice-to-have' but the data is structured 
in a way that we know the keys we need at lookup time (for the most part) and I 
can probably use m/r to query the restâ€¦ With that I'm wondering if it comes 
down to it can search be easily 'undone' on the cluster?  Maybe as simply as 
disabling the pre-commit hook, turning it off in the app.config and them 
deleting the riak/merge_index directories on each node?


Thanks,
ryan




&lt;smime.p7s&gt;_______________________________________________
riak-users mailing list
riak-users@lists.basho.com&lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>



Mobile: + 45 2343 4626 | Skype: krestenkrabthorup | Twitter: @drkrab
Trifork A/S  |  Margrethepladsen 4  | DK- 8000 Aarhus C |  Phone : +45 8732 
8787  |  www.trifork.com&lt;<a  rel="nofollow" href="http://www.trifork.com">http://www.trifork.com</a>&gt;





_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06413.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06414">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06414">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06427.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06413.html">v1.0.3 search merge index preventing partition handoff...</a></span> <span class="sender italic">Fisher, Ryan</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: v1.0.3 search merge index preventing partitio...</span> <span class="sender italic">Kresten Krab Thorup</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06427.html">Re: v1.0.3 search merge index preventing part...</a></span> <span class="sender italic">Ryan Fisher</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06434.html">Re: v1.0.3 search merge index preventing ...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06442.html">Re: v1.0.3 search merge index prevent...</a></span> <span class="sender italic">Ryan Fisher</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06473.html">Re: v1.0.3 search merge index pr...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06484.html">Re: v1.0.3 search merge inde...</a></span> <span class="sender italic">Ryan Fisher</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06496.html">Re: v1.0.3 search merge ...</a></span> <span class="sender italic">Ryan Zezeski</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: v1.0.3 search merge index preventing partition handoff?">
<input type="hidden" name="msgid" value="825FDF6F-52C2-47AF-AB8B-2374A3E15F91@trifork.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06414.html">
<input type="submit" value=" Kresten Krab Thorup ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+v1.0.3+search+merge+index+preventing+partition+handoff%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06413.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06427.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">825FDF6F-52C2-47AF-AB8B-2374A3E15F91@trifork.com</li>
</ul>
</div>
</body>
</html>
