<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Parameter Planning (eleveldb)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd3.html#09987" id="c">
<link rel="index" href="mail4.html#09987" id="i">
<link rel="prev" href="msg09986.html" id="p">
<link rel="next" href="msg09995.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09987.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Parameter+Planning+%5C%28eleveldb%5C%29%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Parameter Planning (eleveldb)</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ingo+Rockel%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ingo Rockel</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130205" rel="nofollow">Tue, 05 Feb 2013 06:19:28 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
I would choose a more even number, like, say 32768 ;)</pre><pre>

Ingo

Am 05.02.2013 14:10, schrieb Matthew Von-Maszewski:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
30,000:  So that you ever have to think about it again.

Matthew


On Feb 5, 2013, at 3:54, Simon Effenberg &lt;seffenb...@team.mobile.de&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hey Matthew,

thank you very much!

I know that the ulimit -n isn't only for normal file FD's but we'll
have probably not more than 4 client connections per server and with 6
servers in a cluster probably not so much (but correct me if I'm wrong)
interconnection links so I would use a bigger ulimit for sure but
30,000? :)

Cheers,
Simon

On Mon, 4 Feb 2013 08:47:21 -0500
Matthew Von-Maszewski &lt;matth...@basho.com&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
- file handles / ulimit -n:  Linux &quot;file handles&quot; are not just about open 
files.  The setting includes open network sockets too.  You do NOT want to set this close 
to your expected number of files.  You want to set it to a multiple of your expected 
files.  I use 30,000 or 60,000 depending upon the machine.  In fact, those high numbers 
are normal for heavy server activities.  Keep in mind that the base Linux settings have a 
laptop in mind.

- disk scheduler:  &quot;cfq&quot; is really bad for servers, great for laptops.  Whether you use &quot;noop&quot; or 
&quot;deadline&quot;, you are far better off than the Linux default.  I have never personally tested the difference 
between noop` and deadline.  Different people have told me they found each of them best for spinning hard drives.  
However, there seems to be more on-line discussion in recent months for using deadline for spinning and noop (plus 
other settings) for SSD drives.  Again, I feel your biggest gain is in not use &quot;cfq&quot;.  The rest is testing 
and tuning.



On Feb 4, 2013, at 2:18 AM, Simon Effenberg &lt;seffenb...@team.mobile.de&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Thanks again Matthew,

I think for now I can start with this. I'll have 256/6 partitions per
node and so if there is one dieing the others have to handle it better
so 256/5 per node multiplied by 92 is 4711 as ulimit setting, right?

One question coming into my mind, the Tips &amp; Tricks section talks about
the noop elevator/disk scheduler whereas this post:
<a  rel="nofollow" href="http://riak-users.197444.n3.nabble.com/Riak-performance-problems-when-LevelDB-database-grows-beyond-16GB-tp4025608p4025622.html">http://riak-users.197444.n3.nabble.com/Riak-performance-problems-when-LevelDB-database-grows-beyond-16GB-tp4025608p4025622.html</a>
is talking about deadline for spinning disks (what we will have). So
who is right or who is outdated?

Thanks again for your help!!

Cheers,
Simon

On Sun, 3 Feb 2013 17:55:38 -0500
Matthew Von-Maszewski &lt;matth...@basho.com&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
I will assume you use the default write buffer settings … cuz that is a whole 
different discussion and there are two settings not one (_min and _max).

The default min is 32M and the default max is 64M … so your value is 48M for 
the average_write_buffer_size.

Superbowl is about to start here, so I am not performing a detailed check of 
your math.  However, I can judge the 92 open files looks correct compared to 
similar systems.

What questions remain?

Matthew


On Feb 3, 2013, at 5:44 PM, Simon Effenberg &lt;seffenb...@team.mobile.de&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Matthew,

thanks a lot!

So now I have:

6 nodes each having 32GB RAM:

vnode_working_memory = 16GB / 256 / 6 (50% of RAM devided by ringsize
devided by nodes) = 390 MB

open_file_memory =
(max_open_files-10) * (
  184 + (104MB/2048) *
  (8 + ((16+14336)/2048 +1) *
  0.6
)

Now I'm missing the max_open_files .. how to calculate it?
I'm missing also average_write_buffer_size (see my question in Step 4).

If I would use the default values for average_write_buffer_size the
max_open_files could be calculated like:

memory/vnode = average_write_buffer_size + cache_size +
open_file_memory + 20 MB
&lt;=&gt; (memory/vnode) - 20 MB - cache_size - average_write_buffer_size =
  open_file_memory

so with the default values:

open_file_memory = 390MB - 20MB - 8MB - 45MB = 317MB

and now max_open_files would be

open_file_memory = (max_open_files-10) * (184 + (104MB/2048) * (8 + ((16
                 +14336)/2048 +1) * 0.6 )
&lt;=&gt; (max_open_files-10) = open_file_memory / (184 + (104MB/2048) * (8 +
                        ((16+14336)/2048 +1) * 0.6 )
&lt;=&gt; max_open_files = open_file_memory / (184 + (104MB/2048) * (8 +
                   ((16+14336)/2048 +1) * 0.6 ) + 10
&lt;=&gt; max_open_files = 317MB / (184+53248*(8+67.8)) + 10
&lt;=&gt; max_open_files = 317MB / 4036382.4 + 10
&lt;=&gt; max_open_files ~= 92

That would be the maximum amount of open files a server can handle
(per vnode), am I right? But now, is this enough? Or how to calculate
50% temporary server loss (3 of 6) and how is the count of keys/values
is taking into account? I'm somehow lost :(

Cheers
Simon

On Sun, 3 Feb 2013 16:12:25 -0500
Matthew Von-Maszewski &lt;matth...@basho.com&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
First:  Step 2 is talking about how many vnodes exist on a physical server.  If 
your ring size is 256, but you have 8 servers … then your vnode count for step 
2 is 32.

Second:  the 2048 is a constant forced by Google's leveldb implementation.  It 
is the portion of a file covered by a single bloom filter.  This calculation 
constant disappears with the upcoming 1.3 release.

Third:  yes there is a &quot;block_size&quot; parameter that is 4096.  Increase that only 
if you want to REDUCE the performance of the leveldb instance.  4096 is a very happy 
value.  We have customers and tests with 130K data values, all using 4096 block size.  
The block_size only governs the minimum written (aggregate size of small values that must 
be written as one unit at minimum).

Use 104Mbyte for your average sst file size.  It is &quot;good enough&quot;


I am not following the question stream for Step 4 and beyond.  Please state 
again.

Matthew




On Feb 3, 2013, at 3:44 PM, Simon Effenberg &lt;seffenb...@team.mobile.de&gt; wrote:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi,

I'm not sure if I understand this all well to calculate the memory
usage per file and other stuff.

The webpage tells me some steps but I'm completly unsure if I understand all 
parameters.

&quot;Step 1: Calculate Available Working Memory&quot;

taking the example:

leveldb_working_memory = 32G * (1 - .50) = 16G

&quot;Step 2: Calculate Working Memory per vnode&quot;

vnode_working_memory = leveldb_working_memory / vnode_count

vnode_count = 256

=&gt; vnode_working_memory = 16G / 256 = 64MB/vnode

also easy

&quot;Step 3: Estimate Memory Used by Open Files&quot;

open_file_memory =
(max_open_files-10) * (
  184 + (average_sst_filesize/2048) *
  (8 + ((average_key_size+average_value_size)/2048 +1) *
  0.6
)

so how do I know the average_sst_filesize (and what is this value exactly)
(and is 2048 for both /2048 true or 4096 in riak 1.2?) and how do I know
the max_open_files?


average_key_size could be 16byte (I have to ask someone but taking it for now)
average_value_size will be 14kbyte

so for now

open_file_memory =
(max_open_files-10) * (
  184 + (average_sst_filesize/2048) *
  (8 + ((16+14336)/2048 +1) *
  0.6
)

(side question: should I increase the block_size because of the big average 
value size?
and also should I leave the cache_size at the default value like it was 
recommended?)

&quot;Step 4: Calculate Average Write Buffer&quot;

should I increase these values or not? If only two are held in memory and I 
have, as an
example, 32GB or RAM like in this scenario, shouldn't I increase it to 
something else?

&quot;Step 5: Calculate vnode Memory Used&quot;

memory/vnode = average_write_buffer_size + cache_size + open_file_memory + 20 MB

So for now I miss almost all 3 values :(.

To get an Idea:

- 3 buckets
- overall ~ 343347732 keys (but only 2/3 have 14kbyte in average)


Thx for help!
Simon

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


--
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon:     + 49-(0)30-8109 - 7173
Fax:     + 49-(0)30-8109 - 7131

Mail:     seffenb...@team.mobile.de
Web:    www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


--
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon:     + 49-(0)30-8109 - 7173
Fax:     + 49-(0)30-8109 - 7131

Mail:     seffenb...@team.mobile.de
Web:    www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow
</pre></blockquote><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">


--
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon:     + 49-(0)30-8109 - 7173
Fax:     + 49-(0)30-8109 - 7131

Mail:     seffenb...@team.mobile.de
Web:    www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow
</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">


--
Software Architect

Blue Lion mobile GmbH
Tel. +49 (0) 221 788 797 14
Fax. +49 (0) 221 788 797 19
Mob. +49 (0) 176 24 87 30 89

ingo.roc...@bluelionmobile.com
&gt;&gt;&gt; qeep: Hefferwolf

www.bluelionmobile.com
www.qeep.net

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09986.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd3.html#09987">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail4.html#09987">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09995.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09972.html">Parameter Planning (eleveldb)</a></span> <span class="sender italic">Simon Effenberg</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09973.html">Re: Parameter Planning (eleveldb)</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09974.html">Re: Parameter Planning (eleveldb)</a></span> <span class="sender italic">Simon Effenberg</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09975.html">Re: Parameter Planning (eleveldb)</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09976.html">Re: Parameter Planning (eleveldb)</a></span> <span class="sender italic">Simon Effenberg</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09978.html">Re: Parameter Planning (elevel...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09984.html">Re: Parameter Planning (el...</a></span> <span class="sender italic">Simon Effenberg</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09985.html">Re: Parameter Planning...</a></span> <span class="sender italic">Matthew Von-Maszewski</span></li>
<li class="icons-email"><span class="subject"><a href="msg09986.html">Re: Parameter Planning...</a></span> <span class="sender italic">Shane McEwan</span></li>
<li class="icons-email tSliceCur"><span class="subject">Re: Parameter Planning...</span> <span class="sender italic">Ingo Rockel</span></li>
<li class="icons-email"><span class="subject"><a href="msg09995.html">Re: Parameter Planning...</a></span> <span class="sender italic">Simon Effenberg</span></li>
<li class="icons-email"><span class="subject"><a href="msg10589.html">Re: Parameter Planning...</a></span> <span class="sender italic">thefosk</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Parameter Planning (eleveldb)">
<input type="hidden" name="msgid" value="5111147B.9010605@bluelionmobile.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09987.html">
<input type="submit" value=" Ingo Rockel ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Parameter+Planning+%5C%28eleveldb%5C%29%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09986.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09995.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5111147B.9010605@bluelionmobile.com</li>
</ul>
</div>
</body>
</html>
