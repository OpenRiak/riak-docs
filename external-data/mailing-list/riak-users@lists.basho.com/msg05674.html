<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: simulating physical node crash</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd4.html#05674" id="c">
<link rel="index" href="maillist.html#05674" id="i">
<link rel="prev" href="msg05645.html" id="p">
<link rel="next" href="msg04878.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05674.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+simulating+physical+node+crash%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: simulating physical node crash</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Kelly+McLaughlin%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Kelly McLaughlin</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111118" rel="nofollow">Fri, 18 Nov 2011 15:51:34 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Francisco,

The problem you are experiencing is not due to search, but seems likely due to 
the way in which the nodes of your cluster have been assigned the partitions of 
the ring. If only one node has failed and you are getting that 
no_candidate_nodes error it means that the preference list of at least one of 
the mapreduce inputs is comprised entirely of partitions on that one downed 
node. In other words, the three replicas of some of your data have all ended up 
on the same physical node. This is an unusual circumstance so it would be good 
to examine the conents of your ring so we can verify this is the case. If you 
could use riak attach to get a console on one of your nodes and run the 
following command and put the output in a gist or paste bin, it will hopefully 
shed light on the problem.</pre><pre>

        io:format(&quot;~p~n&quot;, [riak_core_ring_manager:get_my_ring()]).

The problem Martin described is slightly different. The problem he observed 
appears to be that the erlang processes to handle the work of the map phase 
were dying. Since he described the cluster as being under heavy load when this 
happened I suspect it is related to hitting a resource limit in the erlang vm 
or the operating system. My suggestion in this case is to use riak 1.0.2 and 
the pipe mapreduce system. It is much more robust for clusters under heavy load 
and will provide a better experience. Hope that helps.

Kelly


On Nov 17, 2011, at 4:10 PM, francisco treacy wrote:

&gt; This morning one node went down (3-node 0.14 cluster) and I started getting 
&gt; the dreaded `no_candidate_nodes,exhausted_prefist` error posted earlier.
&gt; 
&gt; If 2 nodes are remaining, and I always use N=3 R=1 ... why is it failing? 
&gt; Something to do with my use of Search?
&gt; 
&gt; Thanks
&gt; Francisco
&gt; 
&gt; 
&gt; 2011/9/28 Martin Woods &lt;mw2...@gmail.com&gt;
&gt; Hi Francisco
&gt; 
&gt; I've seen the same error in a dev environment running on a single Riak node 
&gt; with an n_val of 1, so in my case it was nothing to do with a failing node. I 
&gt; wasn't running Riak Search either. I posted a question about it to this list 
&gt; a week or so ago but haven't seen a reply yet. 
&gt; 
&gt; So indeed, does anyone know what's causing this error and how we can avoid it?
&gt; 
&gt; Regards,
&gt; Martin. 
&gt; 
&gt; 
&gt; 
&gt; On 28 Sep 2011, at 20:39, francisco treacy &lt;francisco.tre...@gmail.com&gt; wrote:
&gt; 
&gt;&gt; Regarding (3) I found a Forcing Read Repair contrib function 
&gt;&gt; (<a  rel="nofollow" href="http://contrib.basho.com/bucket_inspector.html">http://contrib.basho.com/bucket_inspector.html</a>) which should help.
&gt;&gt; 
&gt;&gt; Otherwise for the m/r error, all of my buckets use default n_val and write 
&gt;&gt; quorum. Could it be that some data never reached that particular node in the 
&gt;&gt; cluster? That is, should've I used W=3?  During the failure, many assets 
&gt;&gt; were returning 404s which triggered read-repair (and were ok upon subsequent 
&gt;&gt; request), but no luck with the Map/Reduce function (it kept on failing).  
&gt;&gt; Could it have something to do with Riak Search?
&gt;&gt; 
&gt;&gt; Thanks,
&gt;&gt; 
&gt;&gt; Francisco
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 2011/9/26 francisco treacy &lt;francisco.tre...@gmail.com&gt;
&gt;&gt; Hi all,
&gt;&gt; 
&gt;&gt; I have a 3-node Riak cluster, and I am simulating the scenario of physical 
&gt;&gt; nodes crashing.
&gt;&gt; 
&gt;&gt; When 2 nodes go down, and I query the remaining one, it fails with:
&gt;&gt; 
&gt;&gt; {error,
&gt;&gt;     {exit,
&gt;&gt;         {{{error,
&gt;&gt;               {no_candidate_nodes,exhausted_prefist,
&gt;&gt;                   [{riak_kv_mapred_planner,claim_keys,3},
&gt;&gt;                    {riak_kv_map_phase,schedule_input,5},
&gt;&gt;                    {riak_kv_map_phase,handle_input,3},
&gt;&gt;                    {luke_phase,executing,3},
&gt;&gt;                    {gen_fsm,handle_msg,7},
&gt;&gt;                    {proc_lib,init_p_do_apply,3}],
&gt;&gt;                   []}},
&gt;&gt;           {gen_fsm,sync_send_event,
&gt;&gt;               [&lt;0.31566.2330&gt;,
&gt;&gt;                {inputs,
&gt;&gt; 
&gt;&gt; (...)
&gt;&gt; 
&gt;&gt; Here I'm doing a M/R, inputs being fed by Search.
&gt;&gt; 
&gt;&gt; (1) All of the involved buckets have N=3, and all involved requests R=1 (I 
&gt;&gt; don't really need quorum for this usecase)
&gt;&gt; 
&gt;&gt; Why is it failing? I'm sure i'm missing something basic here
&gt;&gt; 
&gt;&gt; (2) Probably worth noting, those 3 nodes are spread across *two* physical 
&gt;&gt; servers (1 on small one, 2 on beefier one). I've heard it is &quot;not a good 
&gt;&gt; idea&quot;, not sure why though. These two servers are definitely enough still 
&gt;&gt; for our current load; should I consider adding a third one?
&gt;&gt; 
&gt;&gt; (3) To overcome the aforementioned error, I added a new node to the cluster 
&gt;&gt; (installed on the small server). Now the setup looks like: 4 nodes = 2 on 
&gt;&gt; small server, 2 on beefier one.
&gt;&gt; 
&gt;&gt; When 2 nodes go down, this works.  Which brings me to another topic... could 
&gt;&gt; you point me to good strategies to &quot;pre-&quot; invoke read-repair? Is it up to 
&gt;&gt; clients to scan the keyspace forcing reads?  It's a disaster usability-wise 
&gt;&gt; when first users start getting 404s all over the place.
&gt;&gt; 
&gt;&gt; Francisco
&gt;&gt; 
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; 
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05645.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd4.html#05674">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05674">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04878.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04871.html">simulating physical node crash</a></span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04916.html">Re: simulating physical node crash</a></span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04918.html">Re: simulating physical node crash</a></span> <span class="sender italic">Martin Woods</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05645.html">Re: simulating physical node crash</a></span> <span class="sender italic">francisco treacy</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: simulating physical node crash</span> <span class="sender italic">Kelly McLaughlin</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: simulating physical node crash">
<input type="hidden" name="msgid" value="9725CC5B-4F9A-40E8-94FF-E2EA747A2A29@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05674.html">
<input type="submit" value=" Kelly McLaughlin ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+simulating+physical+node+crash%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05645.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04878.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">9725CC5B-4F9A-40E8-94FF-E2EA747A2A29@basho.com</li>
</ul>
</div>
</body>
</html>
