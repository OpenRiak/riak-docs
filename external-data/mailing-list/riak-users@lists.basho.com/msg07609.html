<!DOCTYPE html>
<html lang="en">
<head>
<title>How to prevent Riak crashes when out of memory?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07609" id="c">
<link rel="index" href="maillist.html#07609" id="i">
<link rel="prev" href="msg07607.html" id="p">
<link rel="next" href="msg07655.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07609.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22How+to+prevent+Riak+crashes+when+out+of+memory%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">How to prevent Riak crashes when out of memory?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Steve+Edwards%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Steve Edwards</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120604" rel="nofollow">Mon, 04 Jun 2012 13:52:24 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I have a cluster of riak nodes and one of them crashed because of a
failure to allocate memory.</pre><pre>

eheap_alloc: Cannot allocate 2850821240 bytes of memory

I restarted the node and it came up gracefully but all my clients
reported that it was offline until I restarted every single node in
the cluster.
How can I tell what was trying to allocate that memory so that I can
give it more memory?
When the node is running, it looks like its only using 8 out of 16G of memory.
Is there a configuration option somewhere that I can modify to
increase the amount of memory available to the node?
I've tweaked all the javascript vm settings but even when there are no
mapreduce calls, memory usage still tops out at 8G.
I should also mention that I am using riak_search


Here are some of the config settings:

ERL_MAX_ETS_TABLES 4800
{map_js_vm_count, 16 },
{reduce_js_vm_count, 6 },
{hook_js_vm_count, 8 },

{js_max_vm_mem, 16},
js_thread_stack, 16},
{segment_full_read_size,20},
{buffer_delayed_write_size,1024 },
{buffer_rollover_size, 4194304},
{max_compact_segments, 20}


Here is some more detail about the memory error from erl_crash.dump
=erl_crash_dump:0.1
Fri Jun  1 19:46:03 2012
Slogan: eheap_alloc: Cannot allocate 2850821240 bytes of memory (of
type &quot;heap&quot;).
System version: Erlang R14B03 (erts-5.8.4) [source] [64-bit] [smp:4:4]
[rq:4] [async-threads:64] [kernel-poll:true]
Compiled: Tue Sep  6 10:22:01 2011
Taints: crypto,bitcask_nifs
Atoms: 15614
=memory
total: 12474692688
processes: 6076294256
processes_used: 6076132696
system: 6398398432
atom: 1068865
atom_used: 1048912
binary: 402089120
code: 9947817
ets: 89367152

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07607.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07609">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07609">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07655.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">How to prevent Riak crashes when out of memory?</span> <span class="sender italic">Steve Edwards</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07655.html">Re: How to prevent Riak crashes when out of memory?</a></span> <span class="sender italic">Mark Phillips</span></li>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="How to prevent Riak crashes when out of memory?">
<input type="hidden" name="msgid" value="CAD_WVKiLyNrePiFimRVOVO26WEpm=pctv=COMp4xO-gW48TeVw@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07609.html">
<input type="submit" value=" Steve Edwards ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22How+to+prevent+Riak+crashes+when+out+of+memory%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07607.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07655.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAD_WVKiLyNrePiFimRVOVO26WEpm=pctv=COMp4xO-gW48TeVw@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
