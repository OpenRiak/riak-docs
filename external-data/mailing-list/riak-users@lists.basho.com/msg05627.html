<!DOCTYPE html>
<html lang="en">
<head>
<title>Fwd: Secondary Indexes - Feedback?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd2.html#05627" id="c">
<link rel="index" href="mail2.html#05627" id="i">
<link rel="prev" href="msg05615.html" id="p">
<link rel="next" href="msg05824.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05627.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Fwd%5C%3A+Secondary+Indexes+%5C-+Feedback%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Fwd: Secondary Indexes - Feedback?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Gordon+Tillman%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Gordon Tillman</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111117" rel="nofollow">Thu, 17 Nov 2011 06:45:26 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I forgot to CC the mailing list with this response.

--g</pre><pre>

From: Gordon Tillman &lt;gtill...@mezeo.com&gt;
Subject: Re: Secondary Indexes - Feedback?
Date: November 16, 2011 14:55:00 CST
To: Rusty Klophaus &lt;ru...@basho.com&gt;

On Nov 16, 2011, at 13:53 , Rusty Klophaus wrote:

&gt; Hi Gordon,
&gt; 
&gt; Thanks for your feedback! Some follow up questions below:
&gt; 
&gt; For example, with search I can specify something like this to generate my 
&gt; input to map-reduce:
&gt; 
&gt; p:foo AND t:bar  (give me all the objects whose parent &quot;p&quot; is foo and that 
&gt; hav tag &quot;t&quot; of bar).
&gt; 
&gt; So that would get fed to map-reduce where additional processing (think 
&gt; filtering, sorting, pagination) is done.
&gt; 
&gt; I can do the same thing with secondary indexes but would have to move some of 
&gt; that into map.  
&gt; 
&gt; So in this case I would use secondary indexes to grab all of the items whose 
&gt; parent &quot;p&quot; is &quot;foo&quot;.  This would generate the input phase and at that point I 
&gt; would have to use map to filter out all of the items that did not contain the 
&gt; tag &quot;t&quot;  of &quot;bar&quot;.
&gt; 
&gt; It is doable, but not as performant as I think it could be.
&gt; 
&gt; So to be clear, this is mainly about performance, not convenience? In other 
&gt; words, you don't mind writing your own map function, so long as it is fast?

That is correct, don't mind doing that at all.  We already have a bunch of M/R 
code and it's all in Erlang so it is pretty fast.  Here is where my comment 
about speed came from.  

Assume theoretical objects that have these fields: parent, tag, date, data.  
Stored in JSON.  Our goal is to retrieve all objects where parent=&quot;foo&quot;, 
tag=&quot;bar&quot;,  and date&lt;20111116 in a M/R job.  

(1) We could do this:  use &quot;input: bucket&quot; (full key listing), and do all of 
the filtering in a map phase.

(2) Conversely, if using search to index our data we could use search as the 
input phase:

&quot;parent:foo AND tag:bar AND date:[00000000 TO 20111115]

and you are pretty much done.

everything else is somewhere in between.  So when using secondary indexes we 
can pick one of those three fields to generate the input phase (say 
parent_bin=foo) and do the rest of the filtering in a map phase.

I am operating on the assumption that option (1) is the slowest and option (2) 
is the fastest, so that the solution using secondary indexes would fall 
somewhere in between.  I am probably over-simplifying but that is what 
motivated my remark with regards to speed.


&gt; Also, lets say that part 1 of the query is getting a list of keys where &quot;p&quot; 
&gt; == &quot;foo&quot;, part 2 is turning those keys into objects, and part 3 is filtering 
&gt; those objects. Are all parts too slow for your application, or is only a 
&gt; specific part of the query too slow?
&gt; 
&gt; Hope that makes sense, this is a nuanced point.

In the example above I would combine part 2 and 3 into one map phase.  I would 
extract a JSON representation of each object, something like this (assumption 
in this case of course is that allow mult = false for the bucket in question):

get_json({error,notfound}) -&gt;
    null;
get_json(RiakObject) -&gt;
    ObjMD = riak_object:get_metadata(RiakObject),
    case dict:find(&lt;&lt;&quot;content-type&quot;&gt;&gt;, ObjMD) of
        {ok, CtVal} -&gt;
            case CtVal of
                &quot;application/json&quot; -&gt;
                    mochijson2:decode(riak_object:get_value(RiakObject));
                _ -&gt;
                    null
            end;
        error -&gt;
            null
    end.

I would then check to see if the object meet all of the filter criteria.  If 
not, return [] else return whatever sub-set of the JSON data that was required. 
 Since there is no other map-phase following this one I don't have to return 
[[bucket, key]], I can just return the data.

So really, the only thing that would possibly result in slower performance 
would be that the initial set of objects generated during the input phase would 
be larger when using secondary indexes as opposed to using search.

&gt; 
&gt; -- 
&gt; Rusty Klophaus (@rustyio)
&gt; Basho Technologies, Inc.
&gt; www.basho.com
&gt; 

Honestly Rusty I don't think that is the biggest performance issue that I'm 
worried about.  I'm really interested in being able to implement distributed 
reduce phases (specifically to do a partial sort)  and then have that output 
handle by a final reduce phase that could perform an efficient merge sort  and 
stream results back to the client.  That would be really cool!

--g

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05615.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd2.html#05627">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail2.html#05627">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05824.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg05608.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Gordon Tillman</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05610.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Rusty Klophaus</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg05630.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Jim Adler</span></li>
<li class="icons-email"><span class="subject"><a href="msg05702.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Matt Ranney</span></li>
<li class="icons-email"><span class="subject"><a href="msg05703.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Fyodor Yarochkin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05813.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Greg Pascale</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg05611.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Paul Gross</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05612.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Alexander Sicular</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05613.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Paul Gross</span></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg05615.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Elias Levy</span></li>
<li class="icons-email tSliceCur"><span class="subject">Fwd: Secondary Indexes - Feedback?</span> <span class="sender italic">Gordon Tillman</span></li>
<li class="icons-email"><span class="subject"><a href="msg05824.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Elias Levy</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05839.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Greg Pascale</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05841.html">Re: Secondary Indexes - Feedback?</a></span> <span class="sender italic">Elias Levy</span></li>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Fwd: Secondary Indexes - Feedback?">
<input type="hidden" name="msgid" value="7A8688E9-88D6-4BBD-B7D8-B93DE55ADF05@mezeo.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05627.html">
<input type="submit" value=" Gordon Tillman ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Fwd%5C%3A+Secondary+Indexes+%5C-+Feedback%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05615.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05824.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">7A8688E9-88D6-4BBD-B7D8-B93DE55ADF05@mezeo.com</li>
</ul>
</div>
</body>
</html>
