<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Java Client with POJOs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="thrd7.html#12950" id="c">
<link rel="index" href="mail7.html#12950" id="i">
<link rel="prev" href="msg12949.html" id="p">
<link rel="next" href="msg12938.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg12950.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Java+Client+with+POJOs%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Java Client with POJOs</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Guido+Medina%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Guido Medina</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20131112" rel="nofollow">Tue, 12 Nov 2013 01:18:55 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Michael,

</pre><tt>I'm quite sure lately annotating the Riak key method was enabled at the 
</tt><tt>client but I'm not 100% of its usage yet (I haven't used it), in the 
</tt><tt>meantime for testing you can annotate the property with @RiakKey inside 
</tt><tt>your POJO, that should do, then just treat that property as any other 
</tt><tt>property (generate its getter and setter)
</tt><pre style="margin: 0em;"></pre><pre>

/public class Account {//

///*@RiakKey*/
//    private String accountId;//
//    ...//
//    ...//
//    ...//
//}/

HTH,

Guido.

On 11/11/13 22:06, Michael Guymon wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>So I had to add @JsonProperty(&quot;metadata&quot;) for the @RiakUsermeta to 
</tt><tt>appear in the serialized json being processed by the Reduce phase.  I 
</tt><tt>have been using &quot;ejsLog('/tmp/map_reduce.log', 
</tt><tt>JSON.stringify(values));&quot; to see what is being passed in.
</tt><pre style="margin: 0em;">

</pre><tt>One last question, the field with @RiakKey is always null. I added the 
</tt><tt>@JsonProperty(&quot;id&quot;) and it is null in the serialized json as well. Is 
</tt><tt>there a step I am missing in the store to populate the @RiakKey?
</tt><pre style="margin: 0em;">

thanks,
Michael

On 11/11/2013 04:12 PM, Brian Roach wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>If your mapping function you simply add a qualifier to detect 
</tt><tt>tombstones;
</tt><pre style="margin: 0em;">

if (values[i].metadata['X-Riak-Deleted'] == 'true')

- Roach

On Mon, Nov 11, 2013 at 1:59 PM, Michael Guymon
&lt;mich...@tobedevoured.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>Ahh, yes, now that makes sense. I see with @RiakUsermeta or 
</tt><tt>@RiakTombstone
</tt><tt>it is possible to filter the results of the MapReduce for 
</tt><tt>tombstones. Is it
</tt><pre style="margin: 0em;">
possible to add a phase to reduce the tombstones instead of manually
filtering the final result?

thanks,
Michael


On 11/11/2013 03:16 PM, Brian Roach wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Michael -

You have something stored in that bucket that isn't the JSON you're
expecting when you run your second map/reduce. As I mentioned, there's
nothing special about how the Java client works; it just serializes
the POJO instance using Jackson.

My suggestion would be using curl / your browser (or the Java client)
and seeing what that is; listing the keys and checking the contents.

I notice you're using the &quot;.withoutFetch()&quot; option when storing;
that's guaranteed to create a sibling if you have allow_multi=true set
in the bucket. If that's the case then that behavior is expected; both
versions are stored in Riak.

Also worth noting is that if you're recently deleted something
(explicitly via a delete operation) it's very likely to get a
tombstone pass to map/reduce.  If you're doing explicit deletes from
Riak you need to check the object metadata for the
&lt;&lt;&quot;X-Riak-Deleted&quot;&gt;&gt; header being true, and then ignore that object in
your map function.

- Roach


On Mon, Nov 11, 2013 at 12:46 PM, Michael Guymon
&lt;mich...@tobedevoured.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Roach,

</pre><tt>Thanks for taking a moment to give me a hand with this. Let me try 
</tt><tt>and be
</tt><pre style="margin: 0em;">
a
</pre><tt>bit more clear on what I am trying to figure out. My first steps 
</tt><tt>are a
</tt><pre style="margin: 0em;">
Class
Account:

public class Account implements Serializable {
      private String email;
}

Storing the account via

myBucket.store(&quot;key&quot;, account).withoutFetch().execute();

then retrieving it with a map reduce using JS, along the lines of:

var accounts = [];
for( i=0; i&lt;values.length;i++) {
    if ( values[i].email == 't...@test.net ) {
      accounts.push(values[i]);
    }
}
return accounts

works as expected.

Now I updated the Class Account to have the name property:

public class Account implements Serializable {
      private String name;
      private String email;
}

</pre><tt>and storing with data to the same bucket, for the same key and 
</tt><tt>attempting
</tt><pre style="margin: 0em;">
to
Map Reduce for &quot;name&quot; I get a

</pre><tt>{&quot;phase&quot;:1,&quot;error&quot;:&quot;[{&lt;&lt;\&quot;lineno\&quot;&gt;&gt;,1},{&lt;&lt;\&quot;message\&quot;&gt;&gt;,&lt;&lt;\&quot;TypeError: 
</tt><tt>
</tt><pre style="margin: 0em;">
values[i].name is

</pre><tt>undefined\&quot;&gt;&gt;},{&lt;&lt;\&quot;source\&quot;&gt;&gt;,&lt;&lt;\&quot;unknown\&quot;&gt;&gt;}]&quot;,&quot;input&quot;:null,&quot;type&quot;:null,&quot;stack&quot;:null}. 
</tt><tt>
</tt><pre style="margin: 0em;">

If I change the bucket to a new one, the Map Reduce runs successfully
without the above error.

This is Riak 1.4.2 running on Ubuntu 13.04

thanks,
Michael


On 11/11/2013 02:32 PM, Brian Roach wrote:

Hi Michael,

</pre><tt>I'm somewhat confused by your question; map/reduce doesn't really 
</tt><tt>have
</tt><pre style="margin: 0em;">
anything to do with your Java POJO/class.

When using the Riak Java client and storing a POJO, the default
converter (JSONConverter)  uses the Jackson JSON library and converts
the instance of your POJO into a JSON string and stores it in Riak.

If you change that POJO class and store more things, the resulting
JSON is obviously going to be different (in your case having an
additional field named &quot;minty&quot;).

When doing Map/Reduce, whatever JavaScript or Erlang functions you
provide are executing in Riak and being given the data stored in Riak
(the JSON you stored); they have no connection to Java.

Can you expand on  &quot;Now the map reduce fails for that the new
property&quot; with what exactly the problem is? It sounds like you have a
problem with your JavaScript or Erlang function(s).

Thanks!
- Roach


On Mon, Nov 11, 2013 at 12:07 PM, Michael Guymon
&lt;mich...@tobedevoured.com&gt; wrote:

Hello,

</pre><tt>I have a (hopefully dumb) question about working with the Java 
</tt><tt>client and
</tt><pre style="margin: 0em;">
POJOs. I justed started tinkering with Riak and have created a simple
Account POJO and happily crammed it into a bucket &quot;test1&quot; and mapped
reduced
it (hooray). The problem starts when I updated the Class for Account,
adding
</pre><tt>a new String property &quot;minty&quot;.  Now the map reduce fails for that 
</tt><tt>the new
</tt><pre style="margin: 0em;">
property in the bucket &quot;test1&quot;. Seems like the POJO is always being
</pre><tt>serialized  to the format of the older Account class. If I create 
</tt><tt>a new
</tt><pre style="margin: 0em;">
bucket, &quot;test2&quot;, and cram and reduce anew, everything works again.

</pre><tt>I have been grepping around the docs, but have not been able to 
</tt><tt>zero in
</tt><pre style="margin: 0em;">
on
</pre><tt>my issue. Am I doing something bone headed? Is it possible to 
</tt><tt>update a
</tt><pre style="margin: 0em;">
bucket to support a modified POJO class?

thanks,
Michael

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>


</pre></blockquote></blockquote></blockquote></blockquote><pre style="margin: 0em;">


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote><pre style="margin: 0em;">

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg12949.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="thrd7.html#12950">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="mail7.html#12950">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg12938.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg12934.html">Java Client with POJOs</a></span> <span class="sender italic">Michael Guymon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12935.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12936.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Michael Guymon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12940.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12944.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Michael Guymon</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12946.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg12949.html">Re: Java Client with POJOs</a></span> <span class="sender italic">Michael Guymon</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Java Client with POJOs</span> <span class="sender italic">Guido Medina</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Java Client with POJOs">
<input type="hidden" name="msgid" value="5281F21E.608@temetra.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg12950.html">
<input type="submit" value=" Guido Medina ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Java+Client+with+POJOs%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg12949.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg12938.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">5281F21E.608@temetra.com</li>
</ul>
</div>
</body>
</html>
