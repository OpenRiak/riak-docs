<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Problem with Vector Clocks - inconsistencies encountered in	cluster with shifted real local clocks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#16590" id="c">
<link rel="index" href="maillist.html#16590" id="i">
<link rel="prev" href="msg16589.html" id="p">
<link rel="next" href="#" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg16590.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Problem+with+Vector+Clocks+%5C-+inconsistencies+encountered+in%09cluster+with+shifted+real+local+clocks%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Problem with Vector Clocks - inconsistencies encountered in	cluster with shifted real local clocks</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Russell+Brown%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Russell Brown</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20151001" rel="nofollow">Thu, 01 Oct 2015 08:28:57 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>You can get that level of consistency from Riak if you use strong consistency. 
By default riak is eventually consistent.</pre><pre>

I might be missing something still, ‘cos I’ve still not had time to step 
through your example but it looks like nothing more than the case that if you 
use clocks to decide the highest timestamp, and some clock is incorrect, you 
get an incorrect result.

On 1 Oct 2015, at 16:23, Zuzana Zatrochova &lt;zatroch...@gmail.com&gt; wrote:

&gt; More likely not what I expected - I use the definition of the strongest 
&gt; consistency guarantees = linearizability (from source - 
&gt; <a  rel="nofollow" href="https://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf">https://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf</a>) 
&gt; 
&gt; or in other words if a user sends read request, the value obtained should be 
&gt; at least that of the last write acknowledged to any other user (or later 
&gt; write request) before the read request was sent to database.
&gt; 
&gt; 
&gt; 
&gt; On 1 October 2015 at 16:51, Russell Brown &lt;russell.br...@me.com&gt; wrote:
&gt; 
&gt; On 1 Oct 2015, at 15:45, Zuzana Zatrochova &lt;zatroch...@gmail.com&gt; wrote:
&gt; 
&gt; &gt; Thank you for fast reply,
&gt; &gt;
&gt; &gt; Could you please specify what do you mean by context sent by client?
&gt; 
&gt; When a client reads a value it gets an opaque context too, it must return 
&gt; this to riak when it performs an update. In the absence of a context an empty 
&gt; context is assumed.
&gt; 
&gt; &gt; Do you mean update on the existing object in database?
&gt; 
&gt; Yes.
&gt; 
&gt; &gt;
&gt; &gt; I see exactly that when allow_mult=false, only the highest timestamp value 
&gt; &gt; is stored.
&gt; &gt;
&gt; &gt; For me the results are unexpected because the client sees inconsistent 
&gt; &gt; values (not from the last write) but there are no partitions and quorum is 
&gt; &gt; set to the strongest consistency configurations. In the diagram, it is 
&gt; &gt; showed more clearly how shifted clocks generate inconsistent result.
&gt; 
&gt; Inconsistent as in non-deterministic, or just not what you expected?
&gt; 
&gt; &gt;
&gt; &gt; Thanks,
&gt; &gt; Zuzana
&gt; &gt;
&gt; &gt; On 1 October 2015 at 14:18, Russell Brown &lt;russell.br...@me.com&gt; wrote:
&gt; &gt; I need more time to examine the diagram, but this all looks as expected so 
&gt; &gt; far.
&gt; &gt;
&gt; &gt; If a client sends no context then it’s write will be a sibling of whatever 
&gt; &gt; is stored at the coordinator, as you rightly point out riak treats an 
&gt; &gt; incoming clock that is less than a local clock as a sibling.
&gt; &gt; If the coordinator is configured to not store siblings then the sibling 
&gt; &gt; value with the highest timestamp is stored, I recommend you run riak in 
&gt; &gt; either allow_mult=true or LWW=true, allow_mult=false, in my view, should 
&gt; &gt; not be default.
&gt; &gt; If two riak nodes do the above, and then replicate their values, the single 
&gt; &gt; value with the highest value is stored. Isn’t this what you are seeing? If 
&gt; &gt; you depend on time to pick the latest, and nodes’ clocks are out of sync 
&gt; &gt; this is the price.
&gt; &gt;
&gt; &gt; Is this what you are seeing? Are you seeing results you didn’t expect, or 
&gt; &gt; non-deterministic results? Or both?
&gt; &gt;
&gt; &gt; Regards
&gt; &gt;
&gt; &gt; Russell
&gt; &gt;
&gt; &gt; On 1 Oct 2015, at 12:58, Zuzana Zatrochova &lt;zatroch...@gmail.com&gt; wrote:
&gt; &gt;
&gt; &gt; &gt; Hi,
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; We are researching the client-centric consistency features of Riak 
&gt; &gt; &gt; database. We encountered a problem with vector clocks implementation. The 
&gt; &gt; &gt; vector clocks do not seem to work locally on a machine as expected. We 
&gt; &gt; &gt; would like you to confirm if the behavior is desired. First I will 
&gt; &gt; &gt; describe the environment of our experiments and then the problem will be 
&gt; &gt; &gt; presented.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Environment:
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;       • Our environment consists of six virtual machines
&gt; &gt; &gt;               • five machines in Riak cluster, each represent a single 
&gt; &gt; &gt; Riak node with Riak database
&gt; &gt; &gt;               • one machine with java application that simulates multiple 
&gt; &gt; &gt; clients communicating with Riak database
&gt; &gt; &gt;       • Machines are Virtualized VMs by VMware software and have slightly 
&gt; &gt; &gt; shifted time to each other (no more than 1 second)
&gt; &gt; &gt;       • We made experiments with versions riak-1.4.8 and riak-2.1.1. In 
&gt; &gt; &gt; riak-1.4.8 app_config contains vnode_vclocks = true  (default setting 
&gt; &gt; &gt; that was there when downloaded) in riak-2.1.1 we could not locate 
&gt; &gt; &gt; configuration for vnode vclocks either in advanced configurations in 
&gt; &gt; &gt; documentation or riak.conf so we assumed it also defaults to true and is 
&gt; &gt; &gt; no longer enabled to change
&gt; &gt; &gt;       • For each experiment we have 500 clients concurrently sending 
&gt; &gt; &gt; requests to random node from the cluster. There are 20000 requests per 
&gt; &gt; &gt; minute operating only on 20 different keys (load on single key is 16 
&gt; &gt; &gt; requests per second (read:write ration = 50:50).
&gt; &gt; &gt;       • For referenced issue we used quorums R = 1, W = 3; R = 2, W = 2 
&gt; &gt; &gt; and R =3 W = 1
&gt; &gt; &gt;       • All riak settings are default apart from IP settings and quorum 
&gt; &gt; &gt; settings. We added interceptors from riak_test module that don’t change 
&gt; &gt; &gt; the code and are implemented only for logging purposes (information about 
&gt; &gt; &gt; states of nodes), error.log is empty
&gt; &gt; &gt;
&gt; &gt; &gt; Problem:
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;       • It seems that Riak does not use vector clocks locally, only on 
&gt; &gt; &gt; global scale. When a data object is created on client side and sent to 
&gt; &gt; &gt; Riak database it does not have any vector clocks assigned (more precisely 
&gt; &gt; &gt; the function riak_object:vclock(UpdObj) = [] and local object: 
&gt; &gt; &gt; riak_object:vclock(LocalObj) returns the local VC for the local object. 
&gt; &gt; &gt; Therefore the function (in 2.1.1 but similar behavior is in 1.4.8) 
&gt; &gt; &gt; vclock:descends(NewObject, LocalObject) returns false for all my 
&gt; &gt; &gt; experiments with different quorums (Empty vector clocks cannot descend 
&gt; &gt; &gt; non empty vector clocks). The behavior leads to merge of contents = 
&gt; &gt; &gt; creation of siblings (or resolving the value according to the timestamp 
&gt; &gt; &gt; not vector clocks when siblings are not allowed – our configuration)
&gt; &gt; &gt;       • In our experiments when time on VMs is not synchronized up to 500 
&gt; &gt; &gt; milliseconds the situation from picture issue.png sent in attachment 
&gt; &gt; &gt; arises. Due to the fact that two objects with the same key are sent to 
&gt; &gt; &gt; two different coordinators and coordinators clocks are shifted the later 
&gt; &gt; &gt; object is assigned earlier timestamp as the object that was sent before. 
&gt; &gt; &gt; As the result of the vector clocks implementation in Riak, the later 
&gt; &gt; &gt; object is lost due to the merge of contents where later timestamp (wrong 
&gt; &gt; &gt; because of local clock shift) is evaluated as the latest.
&gt; &gt; &gt;
&gt; &gt; &gt; The question:
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Is this the Riak intended behavior? The problem is that even when quorum 
&gt; &gt; &gt; is set to prefer consistency and there are no partitions in the cluster 
&gt; &gt; &gt; there are still inconsistent requests seen from client perspective = any 
&gt; &gt; &gt; read must return the value of the latest finished write or later 
&gt; &gt; &gt; unfinished write request. (We did not use the strong_consistency feature 
&gt; &gt; &gt; of riak-2.1.1 version).
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Thank you,
&gt; &gt; &gt;
&gt; &gt; &gt; Zuzana
&gt; &gt; &gt;
&gt; &gt; &gt; &lt;issue.png&gt;_______________________________________________
&gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt; &gt;
&gt; &gt;
&gt; 
&gt; 


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg16589.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#16590">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#16590">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright buttondisabled" accesskey="n" href="#">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg16584.html">Re: Problem with Vector Clocks - inconsistencies encount...</a></span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16587.html">Re: Problem with Vector Clocks - inconsistencies en...</a></span> <span class="sender italic">Zuzana Zatrochova</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16588.html">Re: Problem with Vector Clocks - inconsistencie...</a></span> <span class="sender italic">Russell Brown</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg16589.html">Re: Problem with Vector Clocks - inconsiste...</a></span> <span class="sender italic">Zuzana Zatrochova</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Problem with Vector Clocks - incons...</span> <span class="sender italic">Russell Brown</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Problem with Vector Clocks - inconsistencies encountered in	cluster with shifted real local clocks">
<input type="hidden" name="msgid" value="BB9F79A9-7303-4B3B-AADE-0C6063A6DFD6@me.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg16590.html">
<input type="submit" value=" Russell Brown ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Problem+with+Vector+Clocks+%5C-+inconsistencies+encountered+in%09cluster+with+shifted+real+local+clocks%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg16589.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="#" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">BB9F79A9-7303-4B3B-AADE-0C6063A6DFD6@me.com</li>
</ul>
</div>
</body>
</html>
