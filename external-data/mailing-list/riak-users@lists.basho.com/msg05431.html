<!DOCTYPE html>
<html lang="en">
<head>
<title>key garbage collection</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#05431" id="c">
<link rel="index" href="maillist.html#05431" id="i">
<link rel="prev" href="msg05429.html" id="p">
<link rel="next" href="msg05432.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg05431.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22key+garbage+collection%22&amp;o=newest" rel="nofollow"><span itemprop="name">key garbage collection</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Justin+Karneges%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Justin Karneges</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20111102" rel="nofollow">Wed, 02 Nov 2011 23:39:31 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

In the &quot;atomically updating multiple keys&quot; thread I mentioned the issue of 
dirtying the database with orphan keys and thought that topic was worth 
starting a new thread.</pre><pre>

Say you have an operation that requires creating two keys, A and B, and you 
succeed in creating A but fail in creating B.  How do you delete A after the 
fact?  I have two ideas:

1) Run periodic MapReduce operations that do full db scans looking for garbage 
keys and deleting them (this seems really horrible, but I'll admit I'm new to 
distributed DBs and MapReduce).

2) Maintain cleanup logs that explicitly identify possibly offending keys, for 
optimized cleanup processing.

For the 2) case, here is a pattern I have considered:

cleanup_id = new_uuid() + &quot;_&quot; + timestamp_string
A_value_id = new_uuid()
B_value_id = new_uuid()
set /cleanup/{cleanup_id} key with data [A, A_value_id], [B, B_value_id]
set A key with metadata:
  value_id = A_value_id
  cleanup_id = cleanup_id
set B key with metadata:
  value_id = B_value_id
  cleanup_id = cleanup_id
delete /cleanup/{cleanup_id} key &lt;--- commit succeeds here
set A key to remove cleanup_id metadata
set B key to remove cleanup_id metadata

The rule is that when getting keys A or B, the read is only considered 
successful if either:

1) There is no cleanup_id metadata on the key.
2) There *is* cleanup_id metadata but no key exists with that name.

It is not strictly necessary to remove the cleanup_id metadata from the keys, 
but doing so will optimize reads (since there won't need to be a followup 
check for the cleanup key each time).  So it's okay if we fail to remove this 
metadata, it can be removed by some other client eventually.

So far so good.  Now for handling cleanup.  Periodically, we scan the 
&quot;cleanup&quot; bucket for keys to process.  Since keys only exist in this bucket at 
the moment of a write (they are deleted immediately afterwards), in practice 
there should hardly be any keys in here at any single point in time.  We're 
talking single digits here.  Much better than a full db scan to find garbage 
keys.  Also, the keys to process can be narrowed down by time (e.g. &gt; 5 
minutes ago) based on the key name.

For each old cleanup log, the processor would delete the keys listed in the 
cleanup information but *only if* the value_id for each key matches what is in 
the value_id metadata of the actual key.  This way if somebody else writes to 
the key in the meantime, we don't delete it.  Provided all deletes succeed (or 
skip) then the cleanup key itself is deleted.

I wonder if anyone else is doing something like this.  I also wonder if there 
is a flaw in this design.  Since the lack of the cleanup key can indicate a 
successful commit, I wonder if there might be a problem with eventual 
consistency whereby some other node sees A and B but not the cleanup key 
because it hasn't propagated yet, and therefore thinks the keys are valid when 
in reality they aren't.  Maybe causal consistency ensures this isn't a 
problem, since the cleanup key is written before A and B?

Justin

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg05429.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#05431">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#05431">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg05432.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">key garbage collection</span> <span class="sender italic">Justin Karneges</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05432.html">Re: key garbage collection</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05435.html">Re: key garbage collection</a></span> <span class="sender italic">Justin Karneges</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg05434.html">Re: key garbage collection</a></span> <span class="sender italic">Erik Søe Sørensen</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg05436.html">Re: key garbage collection</a></span> <span class="sender italic">Justin Karneges</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="key garbage collection">
<input type="hidden" name="msgid" value="201111022339.20324.justin@affinix.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg05431.html">
<input type="submit" value=" Justin Karneges ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22key+garbage+collection%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg05429.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg05432.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">201111022339.20324.justin@affinix.com</li>
</ul>
</div>
</body>
</html>
