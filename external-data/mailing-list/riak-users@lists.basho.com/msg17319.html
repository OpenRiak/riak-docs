<!DOCTYPE html>
<html lang="en">
<head>
<title>Precommit hook function - no error log - how to debug?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#17319" id="c">
<link rel="index" href="maillist.html#17319" id="i">
<link rel="prev" href="msg17312.html" id="p">
<link rel="next" href="msg17320.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg17319.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Precommit+hook+function+%5C-+no+error+log+%5C-+how+to+debug%5C%3F%22&amp;o=newest" rel="nofollow"><span itemprop="name">Precommit hook function - no error log - how to debug?</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Sanket+Agrawal%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Sanket Agrawal</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20160510" rel="nofollow">Tue, 10 May 2016 18:17:13 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I just set up a precommit hook function in dev environment (KV 2.1.4) which
doesn't seem to be triggering off at all. The object is being stored in the
bucket, but the precommit logic is not kicking off. I checked couple of
things as listed below but came up with no error - so, it is a
head-scratcher why precommit hook is not triggering:</pre><pre>

&gt; - Verify precommit is set in bucket properties - snippet from curl query
&gt; for bucket props below:
&gt; &quot;precommit&quot;:[{&quot;mod&quot;:&quot;precommit&quot;,&quot;fun&quot;:&quot;pre_uuid&quot;}]
&gt;
&gt; - check there is no error in logs
&gt;
&gt; - check riak-console for commit errors:
&gt; $ ./riak1/bin/riak-admin status|grep commit
&gt; postcommit_fail : 0
&gt; precommit_fail : 0
&gt;
&gt; - Run the precommit function manually on Riak console itself with a riak
&gt; object (that the hook failed to trigger on), and verify it works



Also, there is no sasl-error.log. &quot;sasl = on&quot; doesn't work in 2.1.4 because
it fails with bad_config error. So, I am assuming sasl logging is enabled
by default.

Here is what precommit function does:
- For the object (an immutable log append of JSON), calculate the location
of a LWW bucket, and update a easily calculated key with that JSON body. It
works fine from Riak console itself. Code below - we call pre_uuid in
precommit hook - both precommit.beam (where the function is) and
rutils.beam have been copied to the relevant location as set in riak
config, are accessible through Riak console and work fine if manually
executed on an object:

%% Preprocess JSON, and copy to a LWW bucket type
&gt; preprocessJ(RObj,B,Choplen) -&gt;
&gt;   Bn = {rutils:calcBLWWType(RObj),B}, %%this returns the location of LWW
&gt; bucket - works fine in riak console
&gt;   %% We store uuid map in &lt;username&gt; key - we take out timestamp of length
&gt; 32 including &quot;_&quot;
&gt;   K = riak_object:key(RObj),
&gt;   Kn = binary:part(K,0,byte_size(K) - Choplen),
&gt;   NObj =
&gt; riak_object:new(Bn,Kn,riak_object:get_value(RObj),riak_object:get_metadata(RObj)),
&gt;   {ok, C} = riak:local_client(),
&gt;   case C:put(NObj) of
&gt;     ok -&gt; RObj;
&gt;     _ -&gt; {fail,&lt;&lt;&quot;Error when trying to process in precommit hook&quot;&gt;&gt;}
&gt;   end.
&gt;
&gt; pre_uuid(RObj) -&gt; preprocessJ(RObj,&lt;&lt;&quot;uuid_latest&quot;&gt;&gt;,32).


Below is a manual execution from riak console of precommit function - first
we execute it to confirm it is returning the original object:

&gt; (riak1@127.0.0.1)5&gt; precommit:pre_uuid(O1).
&gt; {r_object,{&lt;&lt;&quot;test_kv_wo&quot;&gt;&gt;,&lt;&lt;&quot;uuid_log&quot;&gt;&gt;},
&gt;           &lt;&lt;&quot;ahmed_2016-05-10T20%3a47%3a47.346299Z&quot;&gt;&gt;,
&gt;           [{r_content,{dict,3,16,16,8,80,48,
&gt;
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;
&gt; {{[],[],[],[],[],[],[],[],[],[],[[...]|...],[],...}}},
&gt;
&gt; &lt;&lt;&quot;{\&quot;uname\&quot;:\&quot;ahmed\&quot;,\&quot;uuid\&quot;:\&quot;df8c10e0-381d-5f65-bf43-cb8b4cb806fc\&quot;,\&quot;timestamp\&quot;:\&quot;2016-05-&quot;...&gt;&gt;}],
&gt;           [{&lt;&lt;0&gt;&gt;,{1,63630132467}}],
&gt;           {dict,1,16,16,8,80,48,
&gt;                 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;                 {{[],[],[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;           undefined}


Now, we check if the object has been written to test_lww/uuid_latest bucket
type:

&gt; (riak1@127.0.0.1)6&gt;
&gt; C:get({&lt;&lt;&quot;test_lww&quot;&gt;&gt;,&lt;&lt;&quot;uuid_latest&quot;&gt;&gt;},&lt;&lt;&quot;ahmed&quot;&gt;&gt;).

{ok,{r_object,{&lt;&lt;&quot;hnm_fsm_lww&quot;&gt;&gt;,&lt;&lt;&quot;uuid_latest&quot;&gt;&gt;},
&gt;               &lt;&lt;&quot;ahmed&quot;&gt;&gt;,
&gt;               [{r_content,{dict,4,16,16,8,80,48,
&gt;                                 {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;                                 {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt;
&gt; &lt;&lt;&quot;{\&quot;uname\&quot;:\&quot;ahmed\&quot;,\&quot;uuid\&quot;:\&quot;df8c10e0-381d-5f65-bf43-cb8b4cb806fc\&quot;,\&quot;timestamp\&quot;:\&quot;&quot;...&gt;&gt;}],
&gt;               [{&lt;&lt;153,190,230,200,210,126,212,127,0,0,156,65&gt;&gt;,
&gt;                 {1,63630148036}}],
&gt;               {dict,1,16,16,8,80,48,
&gt;                     {[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;                     {{[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt;               undefined}}


Will appreciate pointer on how to debug precommit hook.
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg17312.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#17319">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#17319">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg17320.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email tSliceCur"><span class="subject">Precommit hook function - no error log - how to debug?</span> <span class="sender italic">Sanket Agrawal</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17320.html">Re: Precommit hook function - no error log - how to de...</a></span> <span class="sender italic">Sanket Agrawal</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17321.html">Re: Precommit hook function - no error log - how t...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17322.html">Re: Precommit hook function - no error log - h...</a></span> <span class="sender italic">Sanket Agrawal</span></li>
<li class="icons-email"><span class="subject"><a href="msg17323.html">Re: Precommit hook function - no error log - h...</a></span> <span class="sender italic">Douglas Rohrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17326.html">Re: Precommit hook function - no error log...</a></span> <span class="sender italic">Sanket Agrawal</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17329.html">Re: Precommit hook function - no erro...</a></span> <span class="sender italic">Douglas Rohrer</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17330.html">Re: Precommit hook function - no ...</a></span> <span class="sender italic">Sanket Agrawal</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg17333.html">Re: Precommit hook function -...</a></span> <span class="sender italic">Luke Bakken</span></li>
<li class="icons-email"><span class="subject"><a href="msg17334.html">Re: Precommit hook function -...</a></span> <span class="sender italic">Sanket Agrawal</span></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg17340.html">Re: Precommit hook function - no error log - how t...</a></span> <span class="sender italic">Luke Bakken</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Precommit hook function - no error log - how to debug?">
<input type="hidden" name="msgid" value="CALyR41r48owTaT1sSdwYFAFSDGUYGuQL8nxvPF1Oo0MZrpv_=g@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg17319.html">
<input type="submit" value=" Sanket Agrawal ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Precommit+hook+function+%5C-+no+error+log+%5C-+how+to+debug%5C%3F%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg17312.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg17320.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CALyR41r48owTaT1sSdwYFAFSDGUYGuQL8nxvPF1Oo0MZrpv_=g@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
