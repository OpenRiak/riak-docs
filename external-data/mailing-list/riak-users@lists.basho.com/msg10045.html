<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Nightly Prune</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#10045" id="c">
<link rel="index" href="maillist.html#10045" id="i">
<link rel="prev" href="msg10042.html" id="p">
<link rel="next" href="msg10046.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg10045.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Nightly+Prune%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Nightly Prune</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Christian+Dahlqvist%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Christian Dahlqvist</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130208" rel="nofollow">Fri, 08 Feb 2013 06:00:03 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Hi,

I would strongly advise against setting up a portion of your nodes with memory 
backend and using W=1 in order to speed up writes as you will run the risk of 
losing data, especially in failure scenarios where one of the nodes you rely on 
for writing to disk fails. As Riak manages spreading out replicas across the 
cluster, you could end up having portions of the data only stored in memory 
backends if you have a sufficiently large number of nodes configured this way.</pre><pre>

An alternate approach that may work for your case, at least if you have the 
date you want to base your pruning on somewhere in the key (which is something 
I would recommend), would be to use key filters 
(<a  rel="nofollow" href="http://docs.basho.com/riak/latest/cookbooks/Key-Filters/">http://docs.basho.com/riak/latest/cookbooks/Key-Filters/</a>) as input to a 
mapreduce job in order to delete the data. Using key filters is generally more 
efficient than performimg filtering in the map phase based on data as it 
operates on the key alone and do not require the object to be read from disk. 
It also does not require secondary indexes, which makes it possible to use with 
BitCask.

I have created a little mapreduce utility library 
(<a  rel="nofollow" href="https://github.com/whitenode/riak_mapreduce_utils">https://github.com/whitenode/riak_mapreduce_utils</a>) that among other things 
contain a map_delete function implemented in Erlang that ,as the name suggests, 
deletes records passed into it. This could be used together with the key filter 
to perform the delete. When using this, it is often a good idea to process only 
a subsets of the key space each time in order to spread the processing out and 
not overwhelm the cluster with deletes.

Best regards,

Christian


On 8 Feb 2013, at 09:36, Stephan Kepser &lt;stephan.kep...@codecentric.de&gt; wrote:

&gt; Hi Chad,
&gt; 
&gt; yes, you're right: the use of secondary indexes requires LevelDB  as backend. 
&gt; How much of an performance penalty this imposes to you I really don't know. 
&gt; I'd still consider the use of secondary indexes because it is an 
&gt; architecturally clean solution and hence simple to implement and maintain. If 
&gt; you experience performance issues you still have the option to scale out, 
&gt; i.e, use more nodes. 
&gt; 
&gt; There may yet be another option to speed up write operations, depending on 
&gt; your demands. You could use the memory backend for about a third of your 
&gt; nodes and set the write quorum to 1. This turns the memory-only nodes into 
&gt; something like a cache without any further need to administer this cache. On 
&gt; the other hand I have to say I'm not sure you can enforce that at least one 
&gt; replica of each data item goes to a node with LevelDB backend. 
&gt; 
&gt; Best,
&gt; 
&gt; Stephan 
&gt; 
&gt; 2013/2/7 Chad Engler &lt;chad.eng...@patlive.com&gt;
&gt; I'm writing the prune script in Node, and the dates are stored as int 
&gt; timestamps so that isn't an issue.
&gt; 
&gt;  
&gt; 
&gt; I was under the impression that secondary indexes only worked on the LevelDB 
&gt; backend, we have a solid write throughput (maybe 10ish writes per second) and 
&gt; very little read (aside from the prune). Would we see significant performance 
&gt; degradation by switching from Bitcask?
&gt; 
&gt;  
&gt; 
&gt; -Chad
&gt; 
&gt;  
&gt; 
&gt; From: riak-users [<a  rel="nofollow" href="mailto:riak-users-boun...@lists.basho.com">mailto:riak-users-boun...@lists.basho.com</a>] On Behalf Of 
&gt; Stephan Kepser
&gt; Sent: Thursday, February 07, 2013 1:50 PM
&gt; To: riak-users@lists.basho.com
&gt; Subject: Re: Nightly Prune
&gt; 
&gt;  
&gt; 
&gt; Hi Chad,
&gt; 
&gt; I recommend looking at secondary indexes. You can set up a secondary index 
&gt; with the relevant date from your entry. Note that there is no data type date, 
&gt; only string or integer. But you can easily convert a date into a string or an 
&gt; integer for your query purposes. Secondary indexes even provide you with a 
&gt; way to query for date ranges. And they are fast. So, I think they'd serve 
&gt; your purpose.
&gt; 
&gt; Best,
&gt; 
&gt; Stephan
&gt; 
&gt; -- 
&gt; Dr. Stephan Kepser | Senior IT-Consultant
&gt; 
&gt; codecentric AG | Merscheider Stra√üe 1 | 42699 Solingen | Deutschland
&gt; tel: +49 (0) 212.23362845 | fax: +49 (0) 212.23362879 | mobil: +49 (0) 
&gt; 151.52883635
&gt; www.codecentric.de | blog.codecentric.de | www.meettheexperts.de | 
&gt; www.more4fi.de
&gt; 
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg10042.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#10045">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#10045">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg10046.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg10032.html">Nightly Prune</a></span> <span class="sender italic">Chad Engler</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10033.html">RE: Nightly Prune</a></span> <span class="sender italic">Chad Engler</span></li>
<li class="icons-email"><span class="subject"><a href="msg10038.html">Re: Nightly Prune</a></span> <span class="sender italic">Stephan Kepser</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10039.html">RE: Nightly Prune</a></span> <span class="sender italic">Chad Engler</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10042.html">Re: Nightly Prune</a></span> <span class="sender italic">Stephan Kepser</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Nightly Prune</span> <span class="sender italic">Christian Dahlqvist</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg10046.html">RE: Nightly Prune</a></span> <span class="sender italic">Chad Engler</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Nightly Prune">
<input type="hidden" name="msgid" value="EF7181F6-E025-4A84-9C41-15B494DD043D@basho.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg10045.html">
<input type="submit" value=" Christian Dahlqvist ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Nightly+Prune%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg10042.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg10046.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">EF7181F6-E025-4A84-9C41-15B494DD043D@basho.com</li>
</ul>
</div>
</body>
</html>
