<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Riak newbie, need to know if I can switch from Cassandra for a	messageQueue For Erlang</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#07432" id="c">
<link rel="index" href="maillist.html#07432" id="i">
<link rel="prev" href="msg07412.html" id="p">
<link rel="next" href="msg07413.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg07432.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+newbie%2C+need+to+know+if+I+can+switch+from+Cassandra+for+a%09messageQueue+For+Erlang%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Riak newbie, need to know if I can switch from Cassandra for a	messageQueue For Erlang</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Eric+Moritz%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Eric Moritz</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120511" rel="nofollow">Fri, 11 May 2012 07:31:40 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I am guessing that in Cassandra that each user's mailbox has a single row
key and each message has a lexicographic or timestamp for a column key to
preserve order.</pre><pre>

This can be emulated by using a bucket name as the row key, something like
&quot;mailbox-{user-key}&quot; for the bucket and the lexicographic key for the
object key.  So a message's fully qualified URI in Riak would be something
like /buckets/mailbox-ericmoritz/2012-05-01T09:41:00.0324Z-0.0.0.29/

The message Id I generated is the message's timestamp as ISO-8601 with a
slugified reference() tacked on the end, this makes it unique and
lexicographically sortable.

To query the messages, you can add a secondary index for the user key on
the object.  You will have to sort the objects by key at query time.  If
sorting on reads is an issue, you can store a ordset() index under a
different bucket.  You'll have to turn off last write wins and do your
own conflict resolution, but resolving a set is as easy as ordsets:union().
 This ordset() is going to be much smaller and easier to manage than
keeping a sorted list of messages as a single document.  Granted you'll
have to pair it with a tombstone set for removing the messages from the
index document and worry about garbage collecting the delete items.

This technique may or may not end up performing worse than sorting on in
the mapred query so you'll have to benchmark it all yourself.

Since these queues are temporary, have you thought about using a persistent
messaging queue system?  I have not really explored how to set up a Highly
Available messaging queue like RabbitMQ, but it may be worth exploring for
you.

TL;DR You can do it in Riak, Cassandra may be better, a messaging queue
might be best.

Eric.

On Wed, May 9, 2012 at 4:25 PM, Morgan Segalis &lt;msega...@gmail.com&gt; wrote:

&gt; Hi Bogunov,
&gt;
&gt; Thank you for your fast answer.
&gt;
&gt; If I understand correctly your though, for every insert, I should retrieve
&gt; the list of message, append a new message and then store the list again ?
&gt; If it is, doesn't it performance eating ? retrieve a whole list (that can
&gt; be long if the user has not connected since a long time) append a new
&gt; message and store it ? there is 2 operations just for storing… Or is there
&gt; a way to append data directly on a key ?
&gt;
&gt; Best regards,
&gt;
&gt; Le 9 mai 2012 à 22:16, Bogunov a écrit :
&gt;
&gt; Hi, morgan.
&gt;
&gt;
&gt; - Store from 1 to X messages per registered user.
&gt;
&gt; Store all messages as one key.
&gt;
&gt; Get the number of stored messages per user. (may be stored on a variable)
&gt;
&gt; yes
&gt;
&gt;&gt; retrieve all messages from an user at once.
&gt;
&gt; get one key =)
&gt;
&gt;&gt; delete all messages from an user at once.
&gt;
&gt; delete one key
&gt;
&gt; delete all messages that are older than X months no matter the user
&gt;
&gt; you can store index entry like &quot;written in X, X1 month&quot; and find all users
&gt; who has old messages and truncate them
&gt;
&gt; Is it realistic to have a bucket per user ?
&gt; - bucket is prefix, for bucket you keep your default preferences: R/W/N,
&gt; post/pre-commit hooks, etc. Not much gain in doing so.
&gt;
&gt;
&gt;
&gt; On Wed, May 9, 2012 at 11:51 PM, Morgan Segalis &lt;msega...@gmail.com&gt;wrote:
&gt;
&gt;&gt; Hi everyone !
&gt;&gt;
&gt;&gt; I have followed with interest the riak evolution.
&gt;&gt;
&gt;&gt; I have a chat server written in Erlang from scratch with my own protocol.
&gt;&gt; Right now I'm using MySQL in order to store Users credentials and friend
&gt;&gt; list.
&gt;&gt;
&gt;&gt; I'm using Cassandra via thrift to store message that an offline user has
&gt;&gt; got, until the user retrieves it.
&gt;&gt;
&gt;&gt; My Cassandra data model, is quite simple, a Column Family, each row is an
&gt;&gt; user, each column is a message (title = timestamp for getting time ordered
&gt;&gt; data, value = message).
&gt;&gt;
&gt;&gt; The thing is, despite the fact that I'm happy with Cassandra performance
&gt;&gt; and TimeToLive feature, I would like to avoid the hassle of thrift to
&gt;&gt; update my code.
&gt;&gt;
&gt;&gt; Since Riak is (As I have seen on multiple website) the closer thing to
&gt;&gt; cassandra (but simpler).
&gt;&gt;
&gt;&gt; However Riak paradigm seems to be different somehow, with bucket which
&gt;&gt; I'm not yet familiar with.
&gt;&gt;
&gt;&gt; Before getting to know Riak better I would like to have some expert
&gt;&gt; opinion on the matter.
&gt;&gt;
&gt;&gt; I need to do several things :
&gt;&gt;
&gt;&gt; - Store from 1 to X messages per registered user.
&gt;&gt; - Get the number of stored messages per user. (may be stored on a
&gt;&gt; variable)
&gt;&gt; - retrieve all messages from an user at once.
&gt;&gt; - delete all messages from an user at once.
&gt;&gt; - delete all messages that are older than X months no matter the user
&gt;&gt;
&gt;&gt; I would really love your opinion on, is Riak fit my needs, and if so,
&gt;&gt; what would be the data model ?
&gt;&gt; Is it realistic to have a bucket per user ?
&gt;&gt;
&gt;&gt; Best regards,
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; email: bogu...@gmail.com
&gt; skype: i.bogunov
&gt; phone: +7 903 131 8499
&gt; Regards, Bogunov Ilya
&gt;
&gt;
&gt;
&gt;
&gt; _______________________________________________
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg07412.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#07432">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#07432">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg07413.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg07411.html">Riak newbie,	need to know if I can switch from Cassandra fo...</a></span> <span class="sender italic">Morgan Segalis</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg07412.html">Re: Riak newbie,	need to know if I can switch from Cas...</a></span> <span class="sender italic">Morgan Segalis</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Riak newbie, need to know if I can switch from...</span> <span class="sender italic">Eric Moritz</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Riak newbie, need to know if I can switch from Cassandra for a	messageQueue For Erlang">
<input type="hidden" name="msgid" value="CAB5B-GABBymBT=+9PqWEXREn_a0J3Gg8C0m87CONd-aV=_YzVA@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg07432.html">
<input type="submit" value=" Eric Moritz ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Riak+newbie%2C+need+to+know+if+I+can+switch+from+Cassandra+for+a%09messageQueue+For+Erlang%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg07412.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg07413.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAB5B-GABBymBT=+9PqWEXREn_a0J3Gg8C0m87CONd-aV=_YzVA@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
