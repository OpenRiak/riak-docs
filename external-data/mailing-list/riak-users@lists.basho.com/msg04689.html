<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Streaming video from Luwak to browsers not working so well</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#04689" id="c">
<link rel="index" href="maillist.html#04689" id="i">
<link rel="prev" href="msg04687.html" id="p">
<link rel="next" href="msg04690.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg04689.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Streaming+video+from+Luwak+to+browsers+not+working+so+well%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Streaming video from Luwak to browsers not working so well</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22John+Axel+Eriksson%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">John Axel Eriksson</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20110913" rel="nofollow">Tue, 13 Sep 2011 15:39:42 -0700</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>I have no idea why Safari won't work unfortunately. Perhaps it's the type of
range-requests it's doing - I know Safari is a bit special in this regard
(as are the iDevices). Is there at least a way, other than changing the
erlang code and recompiling, to get luwak to not gzip the response? Seems
that the browsers ask for it even though it won't work. Although the
browsers may be stupid - that's what I have to work with. Another idea I had
was that perhaps I could change the headers when proxying using node.js.</pre><pre>

(sorry for the dupe Sean - that got sent only to you).

On Tue, Sep 13, 2011 at 10:40 PM, Sean Cribbs &lt;s...@basho.com&gt; wrote:

&gt; John,
&gt;
&gt; If the browser negotiated a gzip response, the results when streaming would
&gt; be incorrect (or at least incompatible) if the response were ever larger
&gt; than a single chunk. Webmachine would send each chunk through the gzip
&gt; compressor individually, whereas browsers would expect the entire response
&gt; to be a single gzip blob (with a single header/checksum). At least, that's
&gt; why the gzip thing didn't work.  Not sure why Safari broke even when you
&gt; turned that off.
&gt;
&gt; On Tue, Sep 13, 2011 at 4:04 PM, John Axel Eriksson &lt;j...@insane.se&gt;wrote:
&gt;
&gt;&gt; First a little background:
&gt;&gt;
&gt;&gt; We've been putting videos in luwak without much trouble for quite a while
&gt;&gt; now, small and a little bigger (by bigger I mean around 6 or 7 megs).
&gt;&gt;
&gt;&gt; To stream these so far, we've basically done this:
&gt;&gt;
&gt;&gt; Get the web app to download the video over http from luwak and store on
&gt;&gt; local disk.
&gt;&gt; Get nginx, through an x-accel, to actually send it to the client (i.e the
&gt;&gt; browser).
&gt;&gt;
&gt;&gt; For various reasons this isn't really how we want to do it. There is one
&gt;&gt; big reason why we do this currently. We need all clients to authenticate
&gt;&gt; through
&gt;&gt; our rails-app. So we first tried to have rails send an x-accel to nginx
&gt;&gt; which would then proxy to luwak. This won't work because nginx doesn't
&gt;&gt; support
&gt;&gt; http 1.1, chunked encoding and all that jazz to backends at least (it's
&gt;&gt; 2011… why I just don't know).
&gt;&gt;
&gt;&gt; Anyway, for a while now we've thrown node.js into the mix(for other
&gt;&gt; reasons) and recently I started working on some code for node.js to
&gt;&gt; recognize
&gt;&gt; x-sendfile (similar to x-accel). I also made it do the same type of
&gt;&gt; proxying as nginx can do - but this time it does http 1.1. Unfortunately I
&gt;&gt; couldn't get it
&gt;&gt; to work. So I started investigating riak/luwak directly. Could we even
&gt;&gt; stream a video out of luwak directly? No we couldn't. So the problem goes
&gt;&gt; all the
&gt;&gt; way back to riak.
&gt;&gt;
&gt;&gt; Using Safari it won't stream more than a few seconds and then sound and
&gt;&gt; video stops (though the progress bar keeps moving).
&gt;&gt; Using Chrome and Firefox I could stream perhaps half the video before more
&gt;&gt; or less the same thing happened.
&gt;&gt;
&gt;&gt; I then cloned riak and removed one line in
&gt;&gt; deps/luwak/src/luwak_wm_file.erl, specifically line 363 -      {&quot;gzip&quot;,
&gt;&gt; fun(X) -&gt; zlib:gzip(X) end}]. So that the list
&gt;&gt; now only contains [{&quot;identity&quot;, fun(X) -&gt; X end}]. (Those are the
&gt;&gt; default_encodings). I will admit I didn't know exactly what I was doing.
&gt;&gt;
&gt;&gt; Built riak and did some more testing. The results were interesting.
&gt;&gt; Suddenly Chrome and Firefox would play the whole file through (a .webm).
&gt;&gt; Unfortunately Safari still did the same thing, i.e played 4 seconds and
&gt;&gt; then stopped video and sound (while still showing progress).
&gt;&gt;
&gt;&gt; I didn't try IE and quite frankly I'm afraid that one might just blow up
&gt;&gt; my computer…
&gt;&gt;
&gt;&gt; Anyway, I just wanted to ask the list if anyone ever tried the same thing
&gt;&gt; or if any of the good people at basho knows more than I do (which I suspect
&gt;&gt; they do :-).
&gt;&gt;
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; John
&gt;&gt; _______________________________________________
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; <a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
&gt;&gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs &lt;s...@basho.com&gt;
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; <a  rel="nofollow" href="http://www.basho.com/">http://www.basho.com/</a>
&gt;
&gt;
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg04687.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#04689">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#04689">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg04690.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg04686.html">Streaming video from Luwak to browsers not working so w...</a></span> <span class="sender italic">John Axel Eriksson</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg04687.html">Re: Streaming video from Luwak to browsers not wor...</a></span> <span class="sender italic">Sean Cribbs</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Streaming video from Luwak to browsers not...</span> <span class="sender italic">John Axel Eriksson</span></li>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Streaming video from Luwak to browsers not working so well">
<input type="hidden" name="msgid" value="CAMmJxtKTcMQD7P6vyDWq9qBmFkz_Zg2zgqnM5u-FRkLScNhi=g@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg04689.html">
<input type="submit" value=" John Axel Eriksson ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Streaming+video+from+Luwak+to+browsers+not+working+so+well%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg04687.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg04690.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CAMmJxtKTcMQD7P6vyDWq9qBmFkz_Zg2zgqnM5u-FRkLScNhi=g@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
