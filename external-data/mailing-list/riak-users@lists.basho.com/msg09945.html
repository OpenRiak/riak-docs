<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Strange Exception in java-client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#09945" id="c">
<link rel="index" href="maillist.html#09945" id="i">
<link rel="prev" href="msg09942.html" id="p">
<link rel="next" href="msg09968.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg09945.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Strange+Exception+in+java%5C-client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Strange Exception in java-client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Ingo+Rockel%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ingo Rockel</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20130131" rel="nofollow">Thu, 31 Jan 2013 09:37:17 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Brian,

</pre><tt>thanks for the suggestion but I already chose a different solution for 
</tt><tt>now, if these messages get deleted I just delete the links to the 
</tt><tt>message and mark the message as &quot;abandoned&quot; and available for reuse. So 
</tt><tt>I don't run into the conflict if I need to store the message again.
</tt><pre style="margin: 0em;"></pre><pre>

</pre><tt>I just started the replay again and let it run for a while to see if 
</tt><tt>this works for me.
</tt><pre style="margin: 0em;">

Thanks!

        Ingo

Am 31.01.2013 16:54, schrieb Brian Roach:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Ingo -

Unfortunately once you've got a sibling tombstone, things get a bit
tricky. It's not going away until you resolve them which when using
the JSONConverter in the Java client, you can't. Oddly enough, this is
the first time anyone has hit this.

I've got a couple ideas on how to address this properly but I need to
look at some things first.

In the meantime, what I'd suggest as a workaround is to copy and paste
the source for the JSONConverter into your own Converter&lt;T&gt; that
you'll pass to the StoreObject and modify it to return null:

<a  rel="nofollow" href="https://github.com/basho/riak-java-client/blob/master/src/main/java/com/basho/riak/client/convert/JSONConverter.java#L141">https://github.com/basho/riak-java-client/blob/master/src/main/java/com/basho/riak/client/convert/JSONConverter.java#L141</a>

Have it check to see if riakObject.getValue() returns null and if it
does ... return null. You'll also need to modify your ConflictResolver
to check for null as it iterates through the list of your POJOs that
gets passed to it and act accordingly. If there's only a tombstone,
just return null ... which means you will also need to modify your
Mutation&lt;T&gt; to handle a null being passed to it in the case of there
only being a tombstone.

In the end this may well be what I do but I think I have a slightly
more elegant solution that I want to look into.

I've got an errand I need to run this morning, but I'll get to work on
this as soon as I get back.

Thanks, and sorry for the trouble.
- Brian Roach


On Thu, Jan 31, 2013 at 3:56 AM, Ingo Rockel
&lt;ingo.roc...@bluelionmobile.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Brian,

thanks for the detailed explaination!

I had a look at an object which constantly fails to load even if retrying:

lftp :~&gt; cat &quot;<a  rel="nofollow" href="http://172.22.3.14:8091/riak/m/Um">http://172.22.3.14:8091/riak/m/Um</a>|18498012|4|0|18298081&quot;
---- Verbinde mit 172.22.3.14 (172.22.3.14) Port 8091
---&gt; GET /riak/m/Um|18498012|4|0|18298081 HTTP/1.1
---&gt; Host: 172.22.3.14:8091
---&gt; User-Agent: lftp/4.3.3
---&gt; Accept: */*
---&gt; Connection: keep-alive
---&gt;
&lt;--- HTTP/1.1 300 Multiple Choices
&lt;--- X-Riak-Vclock: a85hYGBgzGDKBVIcaZPWMQZyWttkMCWy5rEyXNhTd4ovCwA=
&lt;--- Vary: Accept, Accept-Encoding
&lt;--- Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&lt;--- Last-Modified: Thu, 31 Jan 2013 10:00:48 GMT
&lt;--- ETag: &quot;6PSreYIOL25KOpNyG0XPe7&quot;
&lt;--- Date: Thu, 31 Jan 2013 10:42:41 GMT
&lt;--- Content-Type: text/plain
&lt;--- Content-Length: 56
&lt;---
&lt;--* Siblings:
&lt;--* 50Uz9nvQWwOUBE6USi2gki
&lt;--* 1JsgLs3CE3k2mWsaCEiPp4
cat: Zugriff nicht m√∂glich: 300 Multiple Choices
(/riak/m/Um|18498012|4|0|18298081)
lftp :~&gt; cat
&quot;<a  rel="nofollow" href="http://172.22.3.14:8091/riak/m/Um">http://172.22.3.14:8091/riak/m/Um</a>|18498012|4|0|18298081?vtag=50Uz9nvQWwOUBE6USi2gki&quot;
---&gt; GET /riak/m/Um|18498012|4|0|18298081?vtag=50Uz9nvQWwOUBE6USi2gki
HTTP/1.1
---&gt; Host: 172.22.3.14:8091
---&gt; User-Agent: lftp/4.3.3
---&gt; Accept: */*
---&gt; Connection: keep-alive
---&gt;
&lt;--- HTTP/1.1 200 OK
&lt;--- X-Riak-Vclock: a85hYGBgzGDKBVIcaZPWMQZyWttkMCWy5rEyXNhTd4ovCwA=
&lt;--- Vary: Accept-Encoding
&lt;--- Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&lt;--- Link: &lt;/riak/m&gt;; rel=&quot;up&quot;
&lt;--- Last-Modified: Thu, 31 Jan 2013 09:57:38 GMT
&lt;--- ETag: &quot;50Uz9nvQWwOUBE6USi2gki&quot;
&lt;--- Date: Thu, 31 Jan 2013 10:42:49 GMT
&lt;--- Content-Type: application/octet-stream
&lt;--- Content-Length: 0
&lt;---
lftp :~&gt; cat
&quot;<a  rel="nofollow" href="http://172.22.3.14:8091/riak/m/Um">http://172.22.3.14:8091/riak/m/Um</a>|18498012|4|0|18298081?vtag=1JsgLs3CE3k2mWsaCEiPp4&quot;
---&gt; GET /riak/m/Um|18498012|4|0|18298081?vtag=1JsgLs3CE3k2mWsaCEiPp4
HTTP/1.1
---&gt; Host: 172.22.3.14:8091
---&gt; User-Agent: lftp/4.3.3
---&gt; Accept: */*
---&gt; Connection: keep-alive
---&gt;
&lt;--- HTTP/1.1 200 OK
&lt;--- X-Riak-Vclock: a85hYGBgzGDKBVIcaZPWMQZyWttkMCWy5rEyXNhTd4ovCwA=
&lt;--- Vary: Accept-Encoding
&lt;--- Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&lt;--- Link: &lt;/riak/m&gt;; rel=&quot;up&quot;
&lt;--- Last-Modified: Thu, 31 Jan 2013 10:00:48 GMT
&lt;--- ETag: &quot;1JsgLs3CE3k2mWsaCEiPp4&quot;
&lt;--- Date: Thu, 31 Jan 2013 10:43:01 GMT
&lt;--- Content-Type: application/json; charset=UTF-8
&lt;--- Content-Length: 114
&lt;---
{&quot;sortKey&quot;:1359626448000106,&quot;st&quot;:2,&quot;t&quot;:4,&quot;r&quot;:18498012,&quot;s&quot;:18298081,&quot;ct&quot;:1359626448000,&quot;rv&quot;:21215685,&quot;cv&quot;:1,&quot;su&quot;:0}

the object has two siblings, one the deleted empty &quot;tombstone&quot; and one with
the new data. And there's a gap auf 2:30min between both siblings. There's
no immediate write after the deletion. I logged the write operations and
this gap is there also. And the java client constantly fails to load this
object.

This objects are user notifications which are identified by their type (the
key) and can be updated frequently but the user also is allowed to delete a
single notification (which he did in this case).

Is there anything I can do to resolve this? A last write wins just for this
case? If I write a new notification to update the old one I don't care if
there's any deletion tombstone...

Ingo

Am 30.01.2013 22:42, schrieb Brian Roach:

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Ingo -

Riak is returning an object with no contents (which ends up being an
empty String passed to Jackson).

Unless you've somehow mangled the data yourself (which sounds unlikely
given the bit about the 404 from the command line; more on that in a
bit) what's happening is that you're encountering a tombstone; an
object that has been deleted via a delete operation but hasn't been
removed yet. This causes an &quot;empty&quot; object to be returned (the
tombstone) and causes Jackson to puke (HTTP will actually return this
as a 404 but if you look there's still a X-Riak-Vclock: header with a
vclock).

Probably the best description of how this works in Riak is a post by
Jon Meredith which can be found here:

<a  rel="nofollow" href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html">http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-October/006048.html</a>

Unfortunately this is something the Java client doesn't know what to
do with when using the default JSONConverter and your own POJOs. And
it's not as simple as &quot;just return null&quot; because of a case where a
tombstone could actually be a sibling and the client then needs to
resolve the conflict which is the next step in the process. It's
something I'm going to have to think about.

As you've discovered, when the tombstone isn't a sibling simply
retrying will often work because by then the delete has fully
completed and the tombstones have been removed from the Riak nodes.

Is there a reason you're rapidly doing a delete then a store (which
triggers that fetch)?

Thanks,
Brian Roach

On Wed, Jan 30, 2013 at 9:06 AM, Ingo Rockel
&lt;ingo.roc...@bluelionmobile.com&gt; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Hi Dmitri,

it doesn't happen in my code and it does happen while the riak-client
tries
to deserialize a fetched object from riak in a &quot;fetch-before-store&quot; (see
the
stack), I also get this error randomly while trying just to fetch an
object
from the database.

And if I try to fetch the object from the cmdline I just get a 404. So I
would expect the java-client just returns a null-result for this fetch
and
not to throw an exception.

All my objects are stored using the riak-java-client and the
json-serializer.

Ahh, just tested: if I retry it sometimes works, although most of the
time
still fails (haven't tried with a sleep so far).

Ingo

Am 30.01.2013 16:57, schrieb Dmitri Zagidulin:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">


Hi Ingo.

It's difficult to diagnose the exact reason without looking at your
code.
But that error is a JSON parser error. It gets thrown whenever the code
tries to parse an empty string as a json object.
The general-case solution is to validate your strings or input streams
that you're turning into JSON objects, or to catch an exception when
creating that object and deal with it accordingly.

But again, it's hard to say why it's happening exactly, in your case --
try to determine where in your code that's happening and think of ways
some input or result is empty, and check for that.

Dmitri



On Wed, Jan 30, 2013 at 10:44 AM, Ingo Rockel
&lt;ingo.roc...@bluelionmobile.com &lt;<a  rel="nofollow" href="mailto:ingo.roc...@bluelionmobile.com">mailto:ingo.roc...@bluelionmobile.com</a>&gt;&gt;

wrote:

      Hi,

      I wrote a java tool to convert part of our data from a
      mysql-database into riak. As this tool is running while our system
      is still up, it needs to replay all modifications done in the mysql
      database, during these modifications I sometimes get this exception
      from the riak client:

      com.basho.riak.client.convert.__ConversionException:

      java.io.EOFException: No content to map to Object due to end of
input
      com.basho.riak.client.convert.__ConversionException:

      java.io.EOFException: No content to map to Object due to end of
input
               at


com.basho.riak.client.convert.__JSONConverter.toDomain(__JSONConverter.java:167)
               at


com.basho.riak.client.__operations.FetchObject.__execute(FetchObject.java:110)
               at


com.basho.riak.client.__operations.StoreObject.__execute(StoreObject.java:112)
               at


com.bluelionmobile.qeep.__messaging.db.impl.__MessageKVImpl.__storeUniqueMessageDto(__MessageKVImpl.java:264)
               at


com.bluelionmobile.qeep.__messaging.db.impl.__MessageKVImpl.__createDataFromDTO(__MessageKVImpl.java:138)
               at


com.bluelionmobile.qeep.__messaging.db.impl.__MessageKVImpl.__updateDataFromDTO(__MessageKVImpl.java:205)
               at


com.bluelionmobile.qeep.__messaging.db.utils.Replay$__ReplayRunner.run(Replay.java:__243)
               at java.lang.Thread.run(Thread.__java:722)

      Caused by: java.io.EOFException: No content to map to Object due to
      end of input
               at


org.codehaus.jackson.map.__ObjectMapper._initForReading(__ObjectMapper.java:2775)
               at


org.codehaus.jackson.map.__ObjectMapper._readMapAndClose(__ObjectMapper.java:2718)
               at


org.codehaus.jackson.map.__ObjectMapper.readValue(__ObjectMapper.java:1863)
               at


com.basho.riak.client.convert.__JSONConverter.toDomain(__JSONConverter.java:156)

               ... 7 more

      it only happens once every few thousand updates and if I check the
      object from the cmdline I only get a 404.

      Any ideas what might cause this and how to fix/workaround it?

      Ingo


      _________________________________________________
      riak-users mailing list
      riak-users@lists.basho.com &lt;<a  rel="nofollow" href="mailto:riak-users@lists.basho.com">mailto:riak-users@lists.basho.com</a>&gt;

<a  rel="nofollow" href="http://lists.basho.com/__mailman/listinfo/riak-users___lists.basho.com">http://lists.basho.com/__mailman/listinfo/riak-users___lists.basho.com</a>

&lt;<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>&gt;





_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>

</pre></blockquote><pre style="margin: 0em;">


--
Software Architect

Blue Lion mobile GmbH
Tel. +49 (0) 221 788 797 14
Fax. +49 (0) 221 788 797 19
Mob. +49 (0) 176 24 87 30 89

ingo.roc...@bluelionmobile.com
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

qeep: Hefferwolf
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


www.bluelionmobile.com
www.qeep.net


_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre></blockquote></blockquote><pre style="margin: 0em;">



--
Software Architect

Blue Lion mobile GmbH
Tel. +49 (0) 221 788 797 14
Fax. +49 (0) 221 788 797 19
Mob. +49 (0) 176 24 87 30 89

ingo.roc...@bluelionmobile.com
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
qeep: Hefferwolf
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">

www.bluelionmobile.com
www.qeep.net
</pre></blockquote></blockquote><pre style="margin: 0em;">


--
Software Architect

Blue Lion mobile GmbH
Tel. +49 (0) 221 788 797 14
Fax. +49 (0) 221 788 797 19
Mob. +49 (0) 176 24 87 30 89

ingo.roc...@bluelionmobile.com
&gt;&gt;&gt; qeep: Hefferwolf

www.bluelionmobile.com
www.qeep.net

_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg09942.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#09945">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#09945">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg09968.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg09923.html">Strange Exception in java-client</a></span> <span class="sender italic">Ingo Rockel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09924.html">Re: Strange Exception in java-client</a></span> <span class="sender italic">Dmitri Zagidulin</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09925.html">Re: Strange Exception in java-client</a></span> <span class="sender italic">Ingo Rockel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09926.html">Re: Strange Exception in java-client</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09935.html">Re: Strange Exception in java-client</a></span> <span class="sender italic">Ingo Rockel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09942.html">Re: Strange Exception in java-clien...</a></span> <span class="sender italic">Brian Roach</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Strange Exception in java-c...</span> <span class="sender italic">Ingo Rockel</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg09968.html">Re: Strange Exception in ja...</a></span> <span class="sender italic">Brian Roach</span></li>
<li class="icons-email"><span class="subject"><a href="msg09988.html">Re: Strange Exception in ja...</a></span> <span class="sender italic">Ingo Rockel</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Strange Exception in java-client">
<input type="hidden" name="msgid" value="510AAB8A.3030808@bluelionmobile.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg09945.html">
<input type="submit" value=" Ingo Rockel ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Strange+Exception+in+java%5C-client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg09942.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg09968.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">510AAB8A.3030808@bluelionmobile.com</li>
</ul>
</div>
</body>
</html>
