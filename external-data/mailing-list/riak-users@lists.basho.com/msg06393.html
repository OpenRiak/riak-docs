<!DOCTYPE html>
<html lang="en">
<head>
<title>Re: Connection Pooling with the python-riak-client</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="contents" href="index.html#06393" id="c">
<link rel="index" href="maillist.html#06393" id="i">
<link rel="prev" href="msg06391.html" id="p">
<link rel="next" href="msg06345.html" id="n">
<link rel="canonical" href="https://www.mail-archive.com/riak-users@lists.basho.com/msg06393.html">
<link rel="stylesheet" href="/normalize.css" media="screen">
<link rel="stylesheet" href="/master.css" media="screen">

<!--[if lt IE 9]>
<link rel="stylesheet" href="/ie.css" media="screen">
<![endif]-->
</head>
<body>
<script language="javascript" type="text/javascript">
document.onkeydown = NavigateThrough;
function NavigateThrough (event)
{
  if (!document.getElementById) return;
  if (window.event) event = window.event;
  if (event.target.tagName == 'INPUT') return;
  if (event.ctrlKey || event.metaKey) return;
  var link = null;
  switch (event.keyCode ? event.keyCode : event.which ? event.which : null) {
    case 74:
    case 80:
      link = document.getElementById ('p');
      break;
    case 75:
    case 78:
      link = document.getElementById ('n');
      break;
    case 69:
      link = document.getElementById ('e');
      break;
    }
  if (link && link.href) document.location = link.href;
}
</script>
<div itemscope itemtype="http://schema.org/Article" class="container">
<div class="skipLink">
<a href="#nav">Skip to site navigation (Press enter)</a>
</div>
<div class="content" role="main">
<div class="msgHead">
<h1>
<span class="subject"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest" rel="nofollow"><span itemprop="name">Re: Connection Pooling with the python-riak-client</span></a></span>
</h1>
<p class="darkgray font13">
<span class="sender pipe"><a href="/search?l=riak-users@lists.basho.com&amp;q=from:%22Michael+Clemmons%22" rel="nofollow"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Michael Clemmons</span></span></a></span>
<span class="date"><a href="/search?l=riak-users@lists.basho.com&amp;q=date:20120124" rel="nofollow">Tue, 24 Jan 2012 15:23:10 -0800</a></span>
</p>
</div>
<div itemprop="articleBody" class="msgBody">
<!--X-Body-of-Message-->
<pre>Greg,
You were correct, its doing a lookup on initialization(something I'll have
to deal with next).  Here is a traceback(cut off at app code) when a bad
port is used:</pre><pre>

 File &quot;/home/mike/django/riak-python-client/riak/bucket.py&quot;, line 260, in
get
    return obj.reload(r)
  File &quot;/home/mike/django/riak-python-client/riak/riak_object.py&quot;, line
373, in reload
    Result = t.get(self, r, vtag)
  File &quot;/home/mike/django/riak-python-client/riak/transports/http.py&quot;, line
108, in get
    response = self.http_request('GET', url)
  File &quot;/home/mike/django/riak-python-client/riak/transports/http.py&quot;, line
467, in http_request
    conn.request(method, uri, body, headers)
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 955, in request
    self._send_request(method, url, body, headers)
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 989, in _send_request
    self.endheaders(body)
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 951, in endheaders
    self._send_output(message_body)
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 811, in _send_output
    self.send(msg)
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 773, in send
    self.connect()
  File &quot;/usr/lib/python2.7/httplib.py&quot;, line 754, in connect
    self.timeout, self.source_address)
  File &quot;/usr/lib/python2.7/socket.py&quot;, line 571, in create_connection
    raise err
socket.error: [Errno 111] Connection refused

So it works as expected, which is great.

Here is the fork with the hostports hack,
<a  rel="nofollow" href="https://github.com/glassresistor/riak-python-client/tree/feature/pooled_servers">https://github.com/glassresistor/riak-python-client/tree/feature/pooled_servers</a>
**just noticed some whitespace diffs, will rebase soon

Once I run the tests etc. I'll consider a pull request, its not impressive
but I doubt it would hurt.

Next step make the transport remove a connection and retry on failure.
Obviously how this aspect works is going to be really app dependent, so it
should be easily overridden I think subclassing a transport is completely
reasonable.  I don't know the best default but personally I prefer to
shuffle the list order at the cm level, connect to one, and use the
connections it returns as the new connection list.

I think one key thing is that it might be best for the connection manager
to keep track of previously failed connections but only connect to them
when a) data is indirectly returned from the previously failed node b) all
other connections have failed.  The goals are two fold 1) decrease the
connection time to that of a single node when possible, 2) increase the
liklyhood of a connection will succeed(since failures waste time).

On Tue, Jan 24, 2012 at 9:51 AM, Greg Stein &lt;gst...@gmail.com&gt; wrote:

&gt; On Tue, Jan 24, 2012 at 12:34, Michael Clemmons &lt;glassresis...@gmail.com&gt;
&gt; wrote:
&gt; &gt; Greg,
&gt; &gt; Your amazing thanks.  In my application its failing on the start of the
&gt; &gt; application, I do not believe while trying to do a request but its
&gt; possible
&gt; &gt; let me grok and get back to you with some trace backs.
&gt;
&gt; Sounds good. I just looked at the code and it &quot;should&quot; lazy-connect.
&gt; You shouldn't see any failures at setup time. Only when you make a
&gt; request and it tries to establish te connection.
&gt;
&gt; &gt; As far as Im aware to define more than one hostport with the client you
&gt; &gt; still have to hack the client.  Adding an optional hostports or servers
&gt; &gt; parameter would be simple.
&gt;
&gt; Yes. I was focusing on the lower-level code, and didn't hack
&gt; RiakClient's API. I'm thinking two things: add hostports, and a
&gt; start_monitor parameter (and code up the latter, of course).
&gt;
&gt; &gt; Being able to define the connection manager as a kwarg might be a good
&gt; &gt; option.  If the intent is to define the conextmanager by subclassing the
&gt; &gt; transport, things make more sense.
&gt;
&gt; There are a couple paths to take, at least. The current code says
&gt; &quot;subclass the transport and override the default_cm classvar&quot;. That is
&gt; sufficient, but maybe there is a better/clearer approach.
&gt;
&gt; &gt; I think for multiple nodes round robin
&gt; &gt; might be the most sane default for longterm or short term connections.
&gt;
&gt; It does imply that you'll distribute your request load across the
&gt; ring. If N clients are running, then this is important (otherwise, all
&gt; clients would just hit the first node in the config). There are
&gt; certainly more sophisticated algorithms possible, but the round-robin
&gt; used right now should work for most users.
&gt;
&gt; Note that if a particular request takes a while, the connection is NOT
&gt; in the ConnectionManager. That will ensure that you don't back up a
&gt; bunch of future requests behind a single, slow request. Only when the
&gt; (slow) request completes will the connection be returned to the CM for
&gt; usage by another request.
&gt;
&gt; &gt; Thanks again for replying, I'll see what happens when I try this with
&gt; &gt; multiple live nodes, and get back with more thoughts.
&gt;
&gt; Excellent!
&gt;
&gt; Cheers,
&gt; -g
&gt;



-- 
-Michael
</pre><pre>_______________________________________________
riak-users mailing list
riak-users@lists.basho.com
<a  rel="nofollow" href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com">http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com</a>
</pre>

</div>
<div class="msgButtons margintopdouble">
<ul class="overflow">
<li class="msgButtonItems"><a class="button buttonleft " accesskey="p" href="msg06391.html">Previous message</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="c" href="index.html#06393">View by thread</a></li>
<li class="msgButtonItems textaligncenter"><a class="button" accesskey="i" href="maillist.html#06393">View by date</a></li>
<li class="msgButtonItems textalignright"><a class="button buttonright " accesskey="n" href="msg06345.html">Next message</a></li>
</ul>
</div>
<a name="tslice"></a>
<div class="tSliceList margintopdouble">
<ul class="icons monospace">
<li class="icons-email"><span class="subject"><a href="msg06342.html">Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06343.html">Re: Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Shuhao Wu</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06344.html">Re: Connection Pooling with the python-riak-clie...</a></span> <span class="sender italic">Sean Cribbs</span></li>
</ul></li>
<li class="icons-email"><span class="subject"><a href="msg06383.html">Re: Connection Pooling with the python-riak-client</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06389.html">Re: Connection Pooling with the python-riak-clie...</a></span> <span class="sender italic">Michael Clemmons</span></li>
<li><ul>
<li class="icons-email"><span class="subject"><a href="msg06391.html">Re: Connection Pooling with the python-riak-...</a></span> <span class="sender italic">Greg Stein</span></li>
<li><ul>
<li class="icons-email tSliceCur"><span class="subject">Re: Connection Pooling with the python-r...</span> <span class="sender italic">Michael Clemmons</span></li>
</ul>
</ul>
</ul>
</ul>
</ul>
</div>
<div class="overflow msgActions margintopdouble">
<div class="msgReply" >
<h2>
					Reply via email to
</h2>
<form method="POST" action="/mailto.php">
<input type="hidden" name="subject" value="Re: Connection Pooling with the python-riak-client">
<input type="hidden" name="msgid" value="CABfaNM7wvx3pprh0EdbmM4-aBtTVv=AFdRHf34WjqAn5fEHOTg@mail.gmail.com">
<input type="hidden" name="relpath" value="riak-users@lists.basho.com/msg06393.html">
<input type="submit" value=" Michael Clemmons ">
</form>
</div>
</div>
</div>
<div class="aside" role="complementary">
<div class="logo">
<a href="/"><img src="/logo.png" width=247 height=88 alt="The Mail Archive"></a>
</div>
<form class="overflow" action="/search" method="get">
<input type="hidden" name="l" value="riak-users@lists.basho.com">
<label class="hidden" for="q">Search the site</label>
<input class="submittext" type="text" id="q" name="q" placeholder="Search riak-users">
<input class="submitbutton" name="submit" type="image" src="/submit.png" alt="Submit">
</form>
<div class="nav margintop" id="nav" role="navigation">
<ul class="icons font16">
<li class="icons-home"><a href="/">The Mail Archive home</a></li>
<li class="icons-list"><a href="/riak-users@lists.basho.com/">riak-users - all messages</a></li>
<li class="icons-about"><a href="/riak-users@lists.basho.com/info.html">riak-users - about the list</a></li>
<li class="icons-expand"><a href="/search?l=riak-users@lists.basho.com&amp;q=subject:%22Re%5C%3A+Connection+Pooling+with+the+python%5C-riak%5C-client%22&amp;o=newest&amp;f=1" title="e" id="e">Expand</a></li>
<li class="icons-prev"><a href="msg06391.html" title="p">Previous message</a></li>
<li class="icons-next"><a href="msg06345.html" title="n">Next message</a></li>
</ul>
</div>
<div class="listlogo margintopdouble">

</div>
<div class="margintopdouble">

</div>
</div>
</div>
<div class="footer" role="contentinfo">
<ul>
<li><a href="/">The Mail Archive home</a></li>
<li><a href="/faq.html#newlist">Add your mailing list</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/faq.html#support">Support</a></li>
<li><a href="/faq.html#privacy">Privacy</a></li>
<li class="darkgray">CABfaNM7wvx3pprh0EdbmM4-aBtTVv=AFdRHf34WjqAn5fEHOTg@mail.gmail.com</li>
</ul>
</div>
</body>
</html>
