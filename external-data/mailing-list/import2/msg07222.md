---
title: "Re: Constant vnode crashes after disk corruption"
description: ""
project: community
lastmod: 2012-04-18T03:27:03-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07222"
mailinglist_parent_id: "msg07221"
author_name: "Nico Meyer"
project_section: "mailinglistitem"
sent_date: 2012-04-18T03:27:03-07:00
---



Oh, I forgot to mention:

My workaround was to patch riak\_kv\_bitcask\_backend to map all errors to 
{error,not\_found}. Which begs the question if the 'get/3' function of 
any backend should ever return anything other than
{ok, Value, State} and {error, not\_found, State} if it isn't handled by 
riak\_kv\_vnode.


BTW: I think the -spec() for get/3 is wrong both in 
riak\_kv\_bitcask\_backend and riak\_kv\_eleveldb\_backend. It states a 
possible return value of the form '{ok, not\_found, state()}' for the 
not\_found case, instead of the actually returned form '{error, 
not\_found, state()}'


Cheers,
Nico

Am 18.04.2012 12:18, schrieb Nico Meyer:

Hello,

I just encountered a problem with one of our Riak nodes, which is 
caused by a bug in either the disk controller or the firmware of our 
SSD disks.
Anyway, the obvious symptom is, that all writes to the disks suddenly 
fail, which of course leads to truncated bitcask files. However, this 
time the files got corrupted in a way, that lead to CRC errors while 
fetching keys from bitcask. This in turn leads to a crash of the vnode 
everytime such a key is read. So the log is filled with these messages:


11:55:52.621 [error] CRASH REPORT Process <0.23175.3> with 0 
neighbours crashed with reason: no case clause matching 
{error,bad\_crc,{state,#Ref<0.0.0.196598>,"262613575457896618114724618378707105094425378816",[{async\_folds,true},[{vnode\_vclocks,false},{included\_applications,[]},{allow\_strfun,false},{reduce\_js\_vm\_count,6},{storage\_backend,riak\_kv\_bitcask\_backend},{legacy\_keylisting,false},{pb\_ip,"0.0.0.0"},{hook\_js\_vm\_count,2},{listkeys\_backpressure,false},{mapred\_name,"mapred"},{stats\_urlpath,"stats"},{legacy\_stats,true},{js\_thread\_stack,16},{riak\_kv\_stat,true},{add\_paths,[]},{http\_url\_encoding,on},{map\_js\_vm\_count,...},...],...],...}} 
in riak\_kv\_vnode:prepare\_put/3


Also those keys cannot be (over)written, since a put without 
last\_write\_wins set to true does a get first internally.
I think the cause of the error should be obvious to anyone familiar 
with the riak internals. Otherwise I can provide more information.


Cheers,
Nico




--
Senior Backend Developer
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

ADITION technologies AG
Schwarzwaldstrasse 78b
79117 Freiburg

http://www.adition.com

T +49 / (0)761 / 88147 - 30
F +49 / (0)761 / 88147 - 77
SUPPORT +49 / (0)1805 - ADITION

(Festnetzpreis 14 ct/min; Mobilfunkpreise maximal 42 ct/min)

Eingetragen beim Amtsgericht Düsseldorf unter HRB 54076
Vorstände: Andreas Kleiser, Jörg Klekamp, Tihomir Perkovic, Marcus Schlüter
Aufsichtsratsvorsitzender: Rechtsanwalt Daniel Raimer
UStIDNr.: DE 218 858 434


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

