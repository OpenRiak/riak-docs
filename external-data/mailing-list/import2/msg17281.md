---
title: "Re: Very slow acquisition time (99 percentile) while fast median times"
description: ""
project: community
lastmod: 2016-05-03T07:42:24-0700
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17281"
mailinglist_parent_id: "msg17275"
author_name: "Guillaume Boddaert"
project_section: "mailinglistitem"
sent_date: 2016-05-03T07:42:24-0700
---



Hi,

Sorry for the delay, I've spent a lot of time trying to understand if 
the problem was elsewhere.
I've simplified my infrastructure and got a simple layout that don't 
rely anymore on loadbalancer and also corrected some minor performance 
issue on my workers.


At the moment, i have up to 32 workers that are calling riak for writes, 
each of them are set to :

w=1
dw=0
timeout=1000
using protobuf
a timeouted attempt is rerun 180s later

From my application server perspective, 23% of the calls are rejected 
by timeout (75446 tries, 57564 success, 17578 timeout).


Here is a sample riak-admin stat for one of my 5 hosts:

node\_put\_fsm\_time\_100 : 999331
node\_put\_fsm\_time\_95 : 773682
node\_put\_fsm\_time\_99 : 959444
node\_put\_fsm\_time\_mean : 156242
node\_put\_fsm\_time\_median : 20235
vnode\_put\_fsm\_time\_100 : 5267527
vnode\_put\_fsm\_time\_95 : 2437457
vnode\_put\_fsm\_time\_99 : 4819538
vnode\_put\_fsm\_time\_mean : 175567
vnode\_put\_fsm\_time\_median : 6928

I am using leveldb, so i can't tune bitcask backend as suggested.

I've changed the vmdirty settings and enabled them:
admin@riak1:~$ sudo sysctl -a | grep dirtyvm.dirty\_background\_ratio = 0
vm.dirty\_background\_bytes = 209715200
vm.dirty\_ratio = 40
vm.dirty\_bytes = 0
vm.dirty\_writeback\_centisecs = 100
vm.dirty\_expire\_centisecs = 200

I've seen less idle time between writes, iostat is showing near constant 
writes between 20 and 500 kb/s, with some surges around 4000 kb/s. 
That's better, but not that great.


Here is the current configuration for my "activity\_fr" bucket type and 
"tweet" bucket:



admin@riak1:~$ http localhost:8098/types/activity\_fr/props
HTTP/1.1 200 OK
Content-Encoding: gzip
Content-Length: 314
Content-Type: application/json
Date: Tue, 03 May 2016 14:30:21 GMT
Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
Vary: Accept-Encoding
{
 "props": {
 "active": true,
 "allow\_mult": false,
 "basic\_quorum": false,
 "big\_vclock": 50,
 "chash\_keyfun": {
 "fun": "chash\_std\_keyfun",
 "mod": "riak\_core\_util"
 },
 "claimant": "r...@riak2.lighthouse-analytics.co",
 "dvv\_enabled": false,
 "dw": "quorum",
 "last\_write\_wins": true,
 "linkfun": {
 "fun": "mapreduce\_linkfun",
 "mod": "riak\_kv\_wm\_link\_walker"
 },
 "n\_val": 3,
 "notfound\_ok": true,
 "old\_vclock": 86400,
 "postcommit": [],
 "pr": 0,
 "precommit": [],
 "pw": 0,
 "r": "quorum",
 "rw": "quorum",
 "search\_index": "activity\_fr.20160422104506",
 "small\_vclock": 50,
 "w": "quorum",
 "young\_vclock": 20
 }
}

admin@riak1:~$ http localhost:8098/types/activity\_fr/buckets/tweet/props
HTTP/1.1 200 OK
Content-Encoding: gzip
Content-Length: 322
Content-Type: application/json
Date: Tue, 03 May 2016 14:30:02 GMT
Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
Vary: Accept-Encoding

{
 "props": {
 "active": true,
 "allow\_mult": false,
 "basic\_quorum": false,
 "big\_vclock": 50,
 "chash\_keyfun": {
 "fun": "chash\_std\_keyfun",
 "mod": "riak\_core\_util"
 },
 "claimant": "r...@riak2.lighthouse-analytics.co",
 "dvv\_enabled": false,
 "dw": "quorum",
 "last\_write\_wins": true,
 "linkfun": {
 "fun": "mapreduce\_linkfun",
 "mod": "riak\_kv\_wm\_link\_walker"
 },
 "n\_val": 3,
 "name": "tweet",
 "notfound\_ok": true,
 "old\_vclock": 86400,
 "postcommit": [],
 "pr": 0,
 "precommit": [],
 "pw": 0,
 "r": "quorum",
 "rw": "quorum",
 "search\_index": "activity\_fr.20160422104506",
 "small\_vclock": 50,
 "w": "quorum",
 "young\_vclock": 20
 }
}

I really don't know what to do. Can you help ?

Guillaume


On 02/05/2016 17:53, Luke Bakken wrote:

Guillaume -

Some colleagues had me carefully re-read those stats. You'll notice
that those "put" stats are only for consistent or write\_once
operations, so they don't apply to you.

Your read stats show objects well within Riak's recommended object size:

node\_get\_fsm\_objsize\_100 : 10916
node\_get\_fsm\_objsize\_95 : 7393
node\_get\_fsm\_objsize\_99 : 8845
node\_get\_fsm\_objsize\_mean : 4098
node\_get\_fsm\_objsize\_median : 3891

So that is not the issue.

Are you using Bitcask? If so, please apply these sysctl settings:

http://docs.basho.com/riak/kv/2.1.4/using/performance/#optional-i-o-settings

If you are using the default "vm.dirty\_\*" settings Linux will appear
to pause as it flushes disk buffers to the underlying device. The
settings in the document change this so that flushes happen more often
and asynchronously.

--
Luke Bakken
Engineer
lbak...@basho.com


On Mon, May 2, 2016 at 8:43 AM, Guillaume Boddaert
 wrote:

Here we go for a complete round of my hosts, all are objsize : 0

Here is a sample answer (headers only, that are followed by the full set of
JSON content) from the RIAK5 host

HTTP/1.1 200 OK
X-Riak-Vclock: a85hYGBgzGDKBVI8xTxKnGbpn7QYuPafyWBKZMxjZXjyYfYFviwA
Vary: Accept-Encoding
Server: MochiWeb/1.1 WebMachine/1.10.8 (that head fake, tho)
Link: ; rel="up"
Last-Modified: Mon, 02 May 2016 15:40:20 GMT
ETag: "2l2QODpewyBZQFqDnyEy3F"
Date: Mon, 02 May 2016 15:40:20 GMT
Content-Type: application/json
Content-Length: 10722

Below the riak-admin status output.


admin@riak1:~$ sudo riak-admin status | grep -e 'objsize' | grep 'put'
consistent\_put\_objsize\_100 : 0
consistent\_put\_objsize\_95 : 0
consistent\_put\_objsize\_99 : 0
consistent\_put\_objsize\_mean : 0
consistent\_put\_objsize\_median : 0
write\_once\_put\_objsize\_100 : 0
write\_once\_put\_objsize\_95 : 0
write\_once\_put\_objsize\_99 : 0
write\_once\_put\_objsize\_mean : 0
write\_once\_put\_objsize\_median : 0

admin@riak2:~$ sudo riak-admin status | grep -e 'objsize' | grep 'put'
consistent\_put\_objsize\_100 : 0
consistent\_put\_objsize\_95 : 0
consistent\_put\_objsize\_99 : 0
consistent\_put\_objsize\_mean : 0
consistent\_put\_objsize\_median : 0
write\_once\_put\_objsize\_100 : 0
write\_once\_put\_objsize\_95 : 0
write\_once\_put\_objsize\_99 : 0
write\_once\_put\_objsize\_mean : 0
write\_once\_put\_objsize\_median : 0

admin@riak3:~$ sudo riak-admin status | grep -e 'objsize' | grep 'put'
consistent\_put\_objsize\_100 : 0
consistent\_put\_objsize\_95 : 0
consistent\_put\_objsize\_99 : 0
consistent\_put\_objsize\_mean : 0
consistent\_put\_objsize\_median : 0
write\_once\_put\_objsize\_100 : 0
write\_once\_put\_objsize\_95 : 0
write\_once\_put\_objsize\_99 : 0
write\_once\_put\_objsize\_mean : 0
write\_once\_put\_objsize\_median : 0

admin@riak4:~$ sudo riak-admin status | grep -e 'objsize' | grep 'put'

consistent\_put\_objsize\_100 : 0
consistent\_put\_objsize\_95 : 0
consistent\_put\_objsize\_99 : 0
consistent\_put\_objsize\_mean : 0
consistent\_put\_objsize\_median : 0
write\_once\_put\_objsize\_100 : 0
write\_once\_put\_objsize\_95 : 0
write\_once\_put\_objsize\_99 : 0
write\_once\_put\_objsize\_mean : 0
write\_once\_put\_objsize\_median : 0

admin@riak5:~$ sudo riak-admin status | grep -e 'objsize' | grep 'put'

consistent\_put\_objsize\_100 : 0
consistent\_put\_objsize\_95 : 0
consistent\_put\_objsize\_99 : 0
consistent\_put\_objsize\_mean : 0
consistent\_put\_objsize\_median : 0
write\_once\_put\_objsize\_100 : 0
write\_once\_put\_objsize\_95 : 0
write\_once\_put\_objsize\_99 : 0
write\_once\_put\_objsize\_mean : 0
write\_once\_put\_objsize\_median : 0

On 02/05/2016 17:32, Luke Bakken wrote:

Could you please check the objsize stats on every Riak node? If they
are all zero then ... ????
--
Luke Bakken
Engineer
lbak...@basho.com



\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

