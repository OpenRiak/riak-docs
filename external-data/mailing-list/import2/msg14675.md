---
title: "Re: Problem with deleting keys"
description: ""
project: community
lastmod: 2014-08-15T13:50:50-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg14675"
author_name: "ja...@populi.co"
project_section: "mailinglistitem"
sent_date: 2014-08-15T13:50:50-07:00
---


Old thread, but we're still running into similar issues in 2014 (possibly due
to https://github.com/basho/riak\_kv/issues/311)

In case it helps anyone, here's a quick ruby script to crawl through and
remove the tombstones 

\*use at your own risk\* - you're not supposed to list all keys in production,
but for us the alternative was to have 560K tombstones sitting around taking
up space when we only needed ~3K active keys. Toss this in a monthly cron
job and there you go - also, if you needed the script to use less memory you
could alter the first curl request to: `curl
'localhost:8098/buckets/YOUR\_BUCKET\_HERE/keys?keys=stream >
/tmp/tmp\_file.json` and then parse the resulting JSON file one chunk at a
time.

Note that the ?pw=all≺=all&w=all&r=all is necessary (as per this thread).


riak\_tombstone\_cleanup.rb 
-----------------

require 'json'

puts "Getting list of riak keys"
keys = JSON.parse(`curl
'localhost:8098/buckets/YOUR\_BUCKET\_HERE/keys?keys=true'`)['keys']

puts "#{keys.count} keys loaded"

bad\_keys\_counter = 0
good\_keys\_counter = 0
keys.each do |key|
 result = `curl -I
'localhost:8098/buckets/YOUR\_BUCKET\_HERE/keys/#{key}?pw=all≺=all&w=all&r=all'
2>&1`

 if result['404 Object Not Found']
 bad\_keys\_counter += 1
 else
 good\_keys\_counter += 1
 end
 puts "Processed #{bad\_keys\_counter} bad key(s) and #{good\_keys\_counter}
good key(s)" if (bad\_keys\_counter + good\_keys\_counter) % 1000 == 0
end



--
View this message in context: 
http://riak-users.197444.n3.nabble.com/Problem-with-deleting-keys-tp3069985p4031578.html
Sent from the Riak Users mailing list archive at Nabble.com.

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

