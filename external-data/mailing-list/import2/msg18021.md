---
title: "Yokozuna's inconsistent query problem"
description: ""
project: community
lastmod: 2017-02-23T19:12:58-0800
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg18021"
author_name: "Witeman Zheng"
project_section: "mailinglistitem"
sent_date: 2017-02-23T19:12:58-0800
---


Hi,


I am having a 10 nodes of RiakKV 2.2.0, and turn on Riak Search(Yokozuna). 
Having about 3million records in one bucket with index, every record has about 
1k size.

Then when it is triggered a Yokozuna query for one specific id, sometimes 
return the record, sometimes return NOT FOUND, it is very weird.

FOUND case:
wt=json&q=\*:\*&rows=1000&start=0&sort=collect\_id\_l%20asc&fq=agent\_uid\_i:1191&fq=id\_l:2772439&indent=true"
{
 "responseHeader":{
 "status":0,
 "QTime":57,
 "params":{
 "10.100.205.80:8093":"\_yz\_pn:230 OR \_yz\_pn:200 OR \_yz\_pn:170 OR 
\_yz\_pn:140 OR \_yz\_pn:110 OR \_yz\_pn:80 OR \_yz\_pn:50 OR \_yz\_pn:20",
 "10.100.205.79:8093":"\_yz\_pn:239 OR \_yz\_pn:209 OR \_yz\_pn:179 OR 
\_yz\_pn:149 OR \_yz\_pn:119 OR \_yz\_pn:89 OR \_yz\_pn:59 OR \_yz\_pn:29",
 "indent":"true",
 "10.100.205.73:8093":"\_yz\_pn:233 OR \_yz\_pn:203 OR \_yz\_pn:173 OR 
\_yz\_pn:143 OR \_yz\_pn:113 OR \_yz\_pn:83 OR \_yz\_pn:53 OR \_yz\_pn:23",
 "start":"0",
 "sort":"collect\_id\_l asc",
 "fq":["agent\_uid\_i:1191",
 "id\_l:2772439"],
 "rows":"1000",
 "10.100.205.76:8093":"\_yz\_pn:236 OR \_yz\_pn:206 OR \_yz\_pn:176 OR 
\_yz\_pn:146 OR \_yz\_pn:116 OR \_yz\_pn:86 OR \_yz\_pn:56 OR \_yz\_pn:26",
 "q":"\*:\*",
 
"shards":"10.100.205.71:8093/internal\_solr/game\_data\_records\_index,10.100.205.72:8093/internal\_solr/game\_data\_records\_index,10.100.205.73:8093/internal\_solr/game\_data\_records\_index,10.100.205.74:8093/internal\_solr/game\_data\_records\_index,10.100.205.75:8093/internal\_solr/game\_data\_records\_index,10.100.205.76:8093/internal\_solr/game\_data\_records\_index,10.100.205.77:8093/internal\_solr/game\_data\_records\_index,10.100.205.78:8093/internal\_solr/game\_data\_records\_index,10.100.205.79:8093/internal\_solr/game\_data\_records\_index,10.100.205.80:8093/internal\_solr/game\_data\_records\_index",
 "10.100.205.71:8093":"\_yz\_pn:251 OR \_yz\_pn:221 OR \_yz\_pn:191 OR 
\_yz\_pn:161 OR \_yz\_pn:131 OR \_yz\_pn:101 OR \_yz\_pn:71 OR \_yz\_pn:41 OR \_yz\_pn:11",
 "10.100.205.74:8093":"\_yz\_pn:224 OR \_yz\_pn:194 OR \_yz\_pn:164 OR 
\_yz\_pn:134 OR \_yz\_pn:104 OR \_yz\_pn:74 OR \_yz\_pn:44 OR \_yz\_pn:14",
 "10.100.205.77:8093":"\_yz\_pn:227 OR \_yz\_pn:197 OR \_yz\_pn:167 OR 
\_yz\_pn:137 OR \_yz\_pn:107 OR \_yz\_pn:77 OR \_yz\_pn:47 OR \_yz\_pn:17",
 "10.100.205.78:8093":"\_yz\_pn:248 OR \_yz\_pn:218 OR \_yz\_pn:188 OR 
\_yz\_pn:158 OR \_yz\_pn:128 OR \_yz\_pn:98 OR \_yz\_pn:68 OR \_yz\_pn:38 OR \_yz\_pn:8",
 "10.100.205.75:8093":"\_yz\_pn:255 OR \_yz\_pn:245 OR \_yz\_pn:215 OR 
\_yz\_pn:185 OR \_yz\_pn:155 OR \_yz\_pn:125 OR \_yz\_pn:95 OR \_yz\_pn:65 OR \_yz\_pn:35 
OR \_yz\_pn:5",
 "wt":"json",
 "10.100.205.72:8093":"(\_yz\_pn:252 AND (\_yz\_fpn:252)) OR \_yz\_pn:242 OR 
\_yz\_pn:212 OR \_yz\_pn:182 OR \_yz\_pn:152 OR \_yz\_pn:122 OR \_yz\_pn:92 OR \_yz\_pn:62 
OR \_yz\_pn:32 OR \_yz\_pn:2"}},
 "response":{"numFound":1,"start":0,"docs":[
 {
 “some\_field\_1\_l":0,
 "some\_field\_2\_l":0,
 "some\_field\_3\_s":"[]",
 "some\_field\_4\_s":"[]",
 "some\_field\_5\_l":0,
 "some\_field\_6\_l":0,
 "some\_field\_7\_s":"[]",
 
"some\_field\_8\_s":"[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0],[11,0],[12,0],[13,0],[14,0],[15,0],[16,0],[17,0],[18,0],[19,0],[20,0]]",
 "collect\_id\_l":2765608,
 "some\_field\_9\_i":1191,
 "some\_field\_10\_i":1191,
 "some\_field\_11\_i":1,
 "some\_field\_12\_l":0,
 "some\_field\_13\_l":2000,
 "some\_field\_14\_l":764846,
 "some\_field\_15\_l":766846,
 "some\_field\_16\_i":57,
 "some\_field\_17\_i":1,
 "some\_field\_18\_s":"UTC\_-4",
 "some\_field\_19\_i":1487822270,
 "some\_field\_20\_s":"61.221.181.7",
 "some\_field\_21\_l":2869104,
 "some\_field\_22\_s":"[1,4,10,4,5,3,5,6,8,4,3,2,2,1,10]",
 "some\_field\_23\_i":20,
 "some\_field\_24\_i":1,
 "some\_field\_25\_i":1,
 "agent\_uid\_i":1191,
 "some\_field\_26\_l":2772439,
 "some\_field\_27\_i":100,
 "\_yz\_id":"1\*default\*data\_201702\*2772439\*203",
 "\_yz\_rk":"2772439",
 "\_yz\_rt":"default",
 "\_yz\_rb":"data\_201702"}]

 }}




NOTFOUND case:

wt=json&q=\*:\*&rows=1000&start=0&sort=collect\_id\_l%20asc&fq=agent\_uid\_i:1191&fq=id\_l:2772439&indent=true"
{
 "responseHeader":{
 "status":0,
 "QTime":62,
 "params":{
 "10.100.205.80:8093":"\_yz\_pn:240 OR \_yz\_pn:210 OR \_yz\_pn:180 OR 
\_yz\_pn:150 OR \_yz\_pn:120 OR \_yz\_pn:90 OR \_yz\_pn:60 OR \_yz\_pn:30",
 "10.100.205.79:8093":"\_yz\_pn:249 OR \_yz\_pn:219 OR \_yz\_pn:189 OR 
\_yz\_pn:159 OR \_yz\_pn:129 OR \_yz\_pn:99 OR \_yz\_pn:69 OR \_yz\_pn:39 OR \_yz\_pn:9",
 "indent":"true",
 "10.100.205.73:8093":"(\_yz\_pn:253 AND (\_yz\_fpn:253)) OR \_yz\_pn:243 OR 
\_yz\_pn:213 OR \_yz\_pn:183 OR \_yz\_pn:153 OR \_yz\_pn:123 OR \_yz\_pn:93 OR \_yz\_pn:63 
OR \_yz\_pn:33 OR \_yz\_pn:3",
 "start":"0",
 "sort":"collect\_id\_l asc",
 "fq":["agent\_uid\_i:1191",
 "id\_l:2772439"],
 "rows":"1000",
 "10.100.205.76:8093":"\_yz\_pn:256 OR \_yz\_pn:246 OR \_yz\_pn:216 OR 
\_yz\_pn:186 OR \_yz\_pn:156 OR \_yz\_pn:126 OR \_yz\_pn:96 OR \_yz\_pn:66 OR \_yz\_pn:36 
OR \_yz\_pn:6",
 "q":"\*:\*",
 
"shards":"10.100.205.71:8093/internal\_solr/game\_data\_records\_index,10.100.205.72:8093/internal\_solr/game\_data\_records\_index,10.100.205.73:8093/internal\_solr/game\_data\_records\_index,10.100.205.74:8093/internal\_solr/game\_data\_records\_index,10.100.205.75:8093/internal\_solr/game\_data\_records\_index,10.100.205.76:8093/internal\_solr/game\_data\_records\_index,10.100.205.77:8093/internal\_solr/game\_data\_records\_index,10.100.205.78:8093/internal\_solr/game\_data\_records\_index,10.100.205.79:8093/internal\_solr/game\_data\_records\_index,10.100.205.80:8093/internal\_solr/game\_data\_records\_index",
 "10.100.205.71:8093":"\_yz\_pn:231 OR \_yz\_pn:201 OR \_yz\_pn:171 OR 
\_yz\_pn:141 OR \_yz\_pn:111 OR \_yz\_pn:81 OR \_yz\_pn:51 OR \_yz\_pn:21",
 "10.100.205.74:8093":"\_yz\_pn:234 OR \_yz\_pn:204 OR \_yz\_pn:174 OR 
\_yz\_pn:144 OR \_yz\_pn:114 OR \_yz\_pn:84 OR \_yz\_pn:54 OR \_yz\_pn:24",
 "10.100.205.77:8093":"\_yz\_pn:237 OR \_yz\_pn:207 OR \_yz\_pn:177 OR 
\_yz\_pn:147 OR \_yz\_pn:117 OR \_yz\_pn:87 OR \_yz\_pn:57 OR \_yz\_pn:27",
 "10.100.205.78:8093":"\_yz\_pn:228 OR \_yz\_pn:198 OR \_yz\_pn:168 OR 
\_yz\_pn:138 OR \_yz\_pn:108 OR \_yz\_pn:78 OR \_yz\_pn:48 OR \_yz\_pn:18",
 "10.100.205.75:8093":"\_yz\_pn:225 OR \_yz\_pn:195 OR \_yz\_pn:165 OR 
\_yz\_pn:135 OR \_yz\_pn:105 OR \_yz\_pn:75 OR \_yz\_pn:45 OR \_yz\_pn:15",
 "wt":"json",
 "10.100.205.72:8093":"\_yz\_pn:252 OR \_yz\_pn:222 OR \_yz\_pn:192 OR 
\_yz\_pn:162 OR \_yz\_pn:132 OR \_yz\_pn:102 OR \_yz\_pn:72 OR \_yz\_pn:42 OR 
\_yz\_pn:12"}},
 "response":{"numFound":0,"start":0,"docs":[]
 }}


I can select this record from solr webapp from some of these 10 nodes. So this 
record should be indexed by solr. So I guessed the problem cause this is 
related with Yokozuna’s distributed shards, since one query would shard to 
every solr instance by Yokozuna, then Yokozuna would collect all the returns 
and reduce to a fix result, something like map-reduce mechanism.

So the problem here may underlay in map phase or reduce phase.

The default configuration of riak search applied in these 10 nodes.

Would anyone have some insight on how to fix this? By modified the 
configuration of search?


Best regards,
Witeman

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

