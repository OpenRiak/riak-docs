---
title: "Riak pre-commit hook crashing unexpectedly"
description: ""
project: community
lastmod: 2015-12-07T00:52:15-0800
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16846"
author_name: "David Rogers"
project_section: "mailinglistitem"
sent_date: 2015-12-07T00:52:15-0800
---



Hello,

I'm using riak {release,"riak","2.1.0","5.10.3",
 [{kernel,"2.16.3",
"$HOME/src/riak-2.1.1/rel/riak/lib/kernel-2.16.3"} ...}
on a cluster with 1 Linux 3.16.0-38 and 4 OSX machines.

I have installed the following pre-commit hook (see end of email) to 
validate protobuf-formatted values whose key should be the sha1-hash of 
part of their payload.


 props = 
{"props":{"allow\_mult":false,"basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dvv\_enabled":false,"dw":"quorum","last\_write\_wins":false,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"sil/code","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[{"mod":"validate\_hash","fun":"validate"}],"pw":0,"r":"quorum","rw":"quorum","small\_vclock":50,"w":"quorum","write\_once":false,"young\_vclock":20}})


I attached the failed data element. I'm using the riak-c-client to 
interface.


 Although almost everything I've added to the bucket this way has 
worked so far, a few (like the sample I sent) fail, with riak\_put 
returning only the unhelpful ERIAK\_SERVER\_ERROR ("An error was returned 
from the server"). This happens even though manually running the 
validation works fine. It is consistently reproducible on this input.


 In my attempt to track down the error, I added a test at the end of 
riak\_sync\_request (below) that will log all server errors. The only 
problem is that cfg->log\_fn is always NULL when riak\_log\_error is 
called, rather than what I set it to initially with 
riak\_config\_set\_logging! Gdb can't seem to catch any writes there, so 
maybe cfg gets incompletely copied somewhere?


 Anyway, I can get out the error message from the debugger.

riak\_sync\_request (rop\_target=rop\_target@entry=0x7fffffffe0b0, 
response=response@entry=0x7fffffffe130)

 at src/riak.c:81
81 riak\_log\_error(cxn, "%.\*s\n", (int)msg->len, msg->data);
(gdb) print msg->data
$13 = (riak\_uint8\_t \*) 0x670a40 
"{precommit\_fail,{hook\_crashed,{validate\_hash,validate,error,badarg}}}"


so the server error shows only that the precommit hook 
(validate\_hash:validate/1) crashes. Again, manually running doesn't 
crash it...


Questions:

 First, I don't understand why riak-c-client doesn't call the function 
I supplied to riak\_config\_set\_logging. Second, I don't know where to 
look for more details on why the pre-commit hook crashes only when I 
actually try to add this particular key/value. Can anyone spot a problem 
in its error handling or suggest a way to debug?


Note: I get slightly more info. when posting from curl,
$ curl -XPOST 
http://127.0.0.1:8098/types/default/buckets/sil%2Fcode/keys/$hash -H 
'Content-Type: application/octet-stream' --data-binary @"$hash"
500 Internal Server 
ErrorInternal Server Error
=====================

The server 
encountered an error while processing this request:  

```
{error,

    {error,badarg,
        [{erlang,iolist_to_binary,
             [{hook_crashed,{validate_hash,validate,error,badarg}}],
             []},
{wrq,append_to_response_body,2,[{file,"src/wrq.erl"},{line,215}]},
         {riak_kv_wm_object,handle_common_error,3,
             [{file,"src/riak_kv_wm_object.erl"},{line,1178}]},
         {webmachine_resource,resource_call,3,
             [{file,"src/webmachine_resource.erl"},{line,186}]},
         {webmachine_resource,do,3,
             [{file,"src/webmachine_resource.erl"},{line,142}]},
         {webmachine_decision_core,resource_call,1,
             [{file,"src/webmachine_decision_core.erl"},{line,48}]},
         {webmachine_decision_core,decision,1,
[{file,"src/webmachine_decision_core.erl"},{line,490}]},
         {webmachine_decision_core,handle_request,2,
[{file,"src/webmachine_decision_core.erl"},{line,33}]}]}}
```


---

mochiweb+webmachine 
web server




Sincerely,
~ David M. Rogers

signed.proto:
```
message sign {
 required bytes signer = 1;
 required uint32 dig\_alg = 2;
 required bytes sign = 3;
 required uint64 ctime = 4;
 optional uint32 flags = 5;

 optional bytes obj = 10;
}
```


validate\_hash.erl:
```
-module(validate\_hash).
-export([validate/1, ck\_hash/2, start/0]).
%-on\_load(load\_proto/0).

-author("David M. Rogers ").

%load\_proto() ->
% protobuffs\_compile:scan\_file("signed.proto").

validate(Object) ->
 try
 dict:is\_key(<<"X-Riak-Deleted">>, riak\_object:get\_metadata(Object)) of
 true -> Object;
 false -> correct\_hash(Object)
 catch
 error:Error ->
 {fail, "Invalid Commit: " ++ 
binary\_to\_list(list\_to\_binary(io\_lib:format("~p", [Error])))}

 end.

correct\_hash(Object) ->
 Msg = term\_to\_binary(riak\_object:get\_value(Object)),
 Hash = binary\_to\_list(riak\_object:key(Object)),
 case ck\_hash(Hash, Msg) of
 true -> Object;
 false -> {fail, "Invalid Commit: Bad hash value."}
 end.

%% Hash : string of 40 hex chars
%% Msg : protocol buffer sign message (signed.proto)
%% returns bool
ck\_hash(Hash, Msg) ->
 Obj = signed\_pb:decode\_sign(Msg), %% signed and sobject come from 
file naming

 Digest = crypto:hash(sha, element(7,Obj)),
 bin\_to\_hexstr(Digest) == Hash
 .

bin\_to\_hexstr(Bin) ->
 lists:flatten([io\_lib:format("~2.16.0b", [X]) ||
 X <- binary\_to\_list(Bin)]).

hexstr\_to\_bin(S) ->
 hexstr\_to\_bin(S, []).
hexstr\_to\_bin([], Acc) ->
 list\_to\_binary(lists:reverse(Acc));
hexstr\_to\_bin([X,Y|T], Acc) ->
 {ok, [V], []} = io\_lib:fread("~16u", [X,Y]),
 hexstr\_to\_bin(T, [V | Acc]).

start() ->
 Hash = "fc144f6728c994a10309a922d0fd9758b9999cc4",
 {ok, Msg} = file:read\_file(Hash),
 Ret = ck\_hash(Hash, Msg),
 io:fwrite( "Returned: ~p.~n", [Ret] ).
```




fc144f6728c994a10309a922d0fd9758b9999cc4
Description: Binary data
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

