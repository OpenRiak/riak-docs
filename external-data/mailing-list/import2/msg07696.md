---
title: "Riak Cluster Crash down on heavy load Benchmarking"
description: ""
project: community
lastmod: 2012-06-16T00:43:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07696"
author_name: "Amol Rajoba"
project_section: "mailinglistitem"
sent_date: 2012-06-16T00:43:15-07:00
---


Hi Guys,
I am evaluating Riak as Kay-Value storage where my requirement is to store
huge set of data(more than RAM), so Riak was setup with LevelDB as backend.

Clients were connected using protocol buffer api.
{pb\_backlog, 100000}, in app.config

Benchmarking involved 25 Agents doing put/store on single node for 100M
records.
It runs well till 3M but then complete cluster crashes with making all
nodes down.

Following are the System as well as Riak configurations with error & crash
logs

Please help to find what I am missing, I need to test riak & use it in
production as soon as possible.

Nodes: 2 (I know cluster of 5 is best but this is just test setup)
OS: Ubuntu 12.04 32bit
CPU: Core i3
RAM: 4GB
HDD: 500GB

app.config [changes only]

%% eLevelDB Config
 {eleveldb, [
 {data\_root, "/data/riak/leveldb"},
 {block\_size, 262144}, %%256k
 {cache\_size, 104857600}, %% 100MB - default cache size 8MB
per-partition
 {write\_buffer\_size, 524288000}, %% 500MB in bytes
 {write\_buffer\_size\_min, 524288000}, %% 500MB in bytes
 {write\_buffer\_size\_max, 524288000}, %% 500MB in bytes
 {max\_open\_files, 100} %% Maximum number of files open at
once per partition- Default: 20 - Minimum: 20
 ]},


vm.args [changes only]
## Enable kernel poll and a few async threads
+K true
+A 128


Bucket "riaktest" properties:

{"props":{"allow\_mult":false,"
basic\_quorum":false,"big\_vclock":50,"chash\_keyfun":{"mod":"riak\_core\_util","fun":"chash\_std\_keyfun"},"dw":"quorum","last\_write\_wins":true,"linkfun":{"mod":"riak\_kv\_wm\_link\_walker","fun":"mapreduce\_linkfun"},"n\_val":3,"name":"riaktest","notfound\_ok":true,"old\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":"one","rw":"one","small\_vclock":50,"w":"one","young\_vclock":20}}

relatime set in /etc/fstab on all drives

OS open files limit sysctl fs.file-max set to 800000


Following are the error.log, crash.log and console.log\* \*files\*

error.log\*
---------------
2012-06-15 19:09:31.777 [error] <0.20970.188> gen\_server <0.20970.188>
terminated with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.219 [error] <0.20970.188> CRASH REPORT Process
<0.20970.188> with 0 neighbours crashed with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.320 [error] <0.284.0> Supervisor riak\_kv\_pb\_socket\_sup
had child undefined started with {riak\_kv\_pb\_socket,start\_link,undefined}
at <0.20970.188> exit with reason
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
in context child\_terminated
2012-06-15 19:09:32.824 [error] <0.20974.188> gen\_server <0.20974.188>
terminated with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.972 [error] <0.20974.188> CRASH REPORT Process
<0.20974.188> with 0 neighbours crashed with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}

\*

Crash.log\*
--------------
2012-06-15 19:09:31 =ERROR REPORT====
\*\* Generic server <0.20970.188> terminating
\*\* Last message in was
{tcp,#Port<0.6076011>,[11|<<10,6,117,114,108,99,97,116,18,39,50,53,48,50,97,98,102,49,55,97,100,102,100,48,98,55,102,48,57,48,52,99,48,99,98,101,52,48,100,100,100,55,49,55,50,48,51,51,57,34,122,10,109,34,50,53,48,50,97,98,102,49,55,97,100,102,100,48,98,55,102,48,57,48,52,99,48,99,98,101,52,48,100,100,100,55,49,55,50,48,51,51,57,58,58,32,99,97,116,101,103,111,114,121,32,49,44,32,107,101,121,119,111,114,100,32,49,44,32,99,97,116,101,103,111,114,121,32,50,44,32,99,97,116,101,103,111,114,121,32,51,44,32,107,101,121,119,111,114,100,50,44,32,107,101,121,119,111,114,100,51,34,18,9,116,101,120,116,47,106,115,111,110,40,2,48,2,56,1>>]}
\*\* When Server state == {state,#Port<0.6076011>,{riak\_client,'
riak@10.90.15.198',undefined},undefined,undefined,<<0,0,0,0>>}
\*\* Reason for termination ==
\*\*
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32 =CRASH REPORT====
 crasher:
 initial call: gen:init\_it/6
 pid: <0.20970.188>
 registered\_name: []
 exception exit:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
 in function gen\_server2:terminate/6
 in call from proc\_lib:init\_p\_do\_apply/3
 ancestors: [riak\_kv\_pb\_socket\_sup,riak\_kv\_sup,<0.279.0>]
 messages: []
 links: [#Port<0.6076023>,<0.284.0>,#Port<0.6076011>]
 dictionary: []
 trap\_exit: false
 status: running
 heap\_size: 987
 stack\_size: 24
 reductions: 974
 neighbours:
2012-06-15 19:09:32 =SUPERVISOR REPORT====
 Supervisor: {local,riak\_kv\_pb\_socket\_sup}
 Context: child\_terminated
 Reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
 Offender:
[{pid,<0.20970.188>},{name,undefined},{mfargs,{riak\_kv\_pb\_socket,start\_link,undefined}},{restart\_type,temporary},{shutdown,brutal\_kill},{child\_type,worker}]

2012-06-15 19:09:32 =ERROR REPORT====
\*\* Generic server <0.20974.188> terminating
\*\* Last message in was
{tcp,#Port<0.6076015>,[11|<<10,6,117,114,108,99,97,116,18,39,50,53,48,50,97,98,102,49,55,97,100,102,100,48,98,55,102,48,57,48,52,99,48,99,98,101,52,48,100,100,100,55,49,49,50,48,51,57,57,34,122,10,109,34,50,53,48,50,97,98,102,49,55,97,100,102,100,48,98,55,102,48,57,48,52,99,48,99,98,101,52,48,100,100,100,55,49,49,50,48,51,57,57,58,58,32,99,97,116,101,103,111,114,121,32,49,44,32,107,101,121,119,111,114,100,32,49,44,32,99,97,116,101,103,111,114,121,32,50,44,32,99,97,116,101,103,111,114,121,32,51,44,32,107,101,121,119,111,114,100,50,44,32,107,101,121,119,111,114,100,51,34,18,9,116,101,120,116,47,106,115,111,110,40,2,48,2,56,1>>]}
\*\* When Server state == {state,#Port<0.6076015>,{riak\_client,'
riak@10.90.15.198',undefined},undefined,undefined,<<0,0,0,0>>}
\*\* Reason for termination ==
\*\*
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:33 =CRASH REPORT====
 crasher:
 initial call: gen:init\_it/6
 pid: <0.20974.188>
 registered\_name: []
 exception exit:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
 in function gen\_server2:terminate/6
 in call from proc\_lib:init\_p\_do\_apply/3
 ancestors: [riak\_kv\_pb\_socket\_sup,riak\_kv\_sup,<0.279.0>]
 messages: []
 links: [#Port<0.6076029>,<0.284.0>,#Port<0.6076015>]
 dictionary: []
 trap\_exit: false
 status: running
 heap\_size: 987
 stack\_size: 24
 reductions: 910
 neighbours:



\*Console.log\*
--------------------
2012-06-15 17:50:48.811 [info] <0.7.0> Application lager started on node '
riak@10.90.15.198'
2012-06-15 17:50:48.970 [info] <0.7.0> Application public\_key started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.003 [info] <0.7.0> Application ssl started on node '
riak@10.90.15.198'
2012-06-15 17:50:49.037 [info] <0.7.0> Application riak\_core started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.060 [info] <0.7.0> Application riak\_control started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.061 [info] <0.7.0> Application basho\_metrics started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.063 [info] <0.7.0> Application cluster\_info started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.072 [info] <0.7.0> Application merge\_index started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.083 [info] <0.180.0>@riak\_core:wait\_for\_service:416
Waiting for service riak\_pipe to start (0 seconds)
2012-06-15 17:50:49.110 [info] <0.249.0>@riak\_core:wait\_for\_application:396
Waiting for application riak\_pipe to start (0 seconds).
2012-06-15 17:50:49.111 [info] <0.7.0> Application riak\_pipe started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.145 [info] <0.7.0> Application inets started on node '
riak@10.90.15.198'
2012-06-15 17:50:49.151 [info] <0.7.0> Application mochiweb started on node
'riak@10.90.15.198'
2012-06-15 17:50:49.169 [info] <0.7.0> Application erlang\_js started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.176 [info] <0.7.0> Application luke started on node '
riak@10.90.15.198'
2012-06-15 17:50:49.197 [info] <0.283.0>@riak\_core:wait\_for\_service:416
Waiting for service riak\_kv to start (0 seconds)
2012-06-15 17:50:49.212 [info] <0.249.0>@riak\_core:wait\_for\_application:390
Wait complete for application riak\_pipe (0 seconds)
2012-06-15 17:50:49.285 [info] <0.180.0>@riak\_core:wait\_for\_service:410
Wait complete for service riak\_pipe (0 seconds)
2012-06-15 17:50:49.291 [info] <0.367.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.367.0>)
2012-06-15 17:50:49.296 [info] <0.368.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.368.0>)
2012-06-15 17:50:49.302 [info] <0.369.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.369.0>)
2012-06-15 17:50:49.307 [info] <0.370.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.370.0>)
2012-06-15 17:50:49.311 [info] <0.371.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.371.0>)
2012-06-15 17:50:49.316 [info] <0.372.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.372.0>)
2012-06-15 17:50:49.320 [info] <0.373.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.373.0>)
2012-06-15 17:50:49.324 [info] <0.374.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_map) host starting
(<0.374.0>)
2012-06-15 17:50:49.333 [info] <0.376.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.376.0>)
2012-06-15 17:50:49.341 [info] <0.377.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.377.0>)
2012-06-15 17:50:49.348 [info] <0.378.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.378.0>)
2012-06-15 17:50:49.354 [info] <0.379.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.379.0>)
2012-06-15 17:50:49.360 [info] <0.380.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.380.0>)
2012-06-15 17:50:49.366 [info] <0.381.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_reduce) host
starting (<0.381.0>)
2012-06-15 17:50:49.371 [info] <0.383.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_hook) host starting
(<0.383.0>)
2012-06-15 17:50:49.375 [info] <0.384.0>@riak\_kv\_js\_vm:init:76 Spidermonkey
VM (thread stack: 16MB, max heap: 8MB, pool: riak\_kv\_js\_hook) host starting
(<0.384.0>)
2012-06-15 17:50:49.395 [info] <0.7.0> Application bitcask started on node '
riak@10.90.15.198'
2012-06-15 17:50:49.567 [info] <0.463.0>@riak\_core:wait\_for\_application:396
Waiting for application riak\_kv to start (0 seconds).
2012-06-15 17:50:49.571 [info] <0.7.0> Application riak\_kv started on node '
riak@10.90.15.198'
2012-06-15 17:50:49.573 [info] <0.7.0> Application riak\_search started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.573 [info] <0.7.0> Application basho\_stats started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.584 [info] <0.7.0> Application runtime\_tools started on
node 'riak@10.90.15.198'
2012-06-15 17:50:49.669 [info] <0.463.0>@riak\_core:wait\_for\_application:390
Wait complete for application riak\_kv (0 seconds)
2012-06-15 17:50:54.871 [info] <0.283.0>@riak\_core:wait\_for\_service:410
Wait complete for service riak\_kv (4 seconds)
2012-06-15 18:26:48.764 [info] <0.42.0> alarm\_handler:
{set,{system\_memory\_high\_watermark,[]}}
2012-06-15 19:09:31.777 [error] <0.20970.188> gen\_server <0.20970.188>
terminated with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.219 [error] <0.20970.188> CRASH REPORT Process
<0.20970.188> with 0 neighbours crashed with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.320 [error] <0.284.0> Supervisor riak\_kv\_pb\_socket\_sup
had child undefined started with {riak\_kv\_pb\_socket,start\_link,undefined}
at <0.20970.188> exit with reason
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
in context child\_terminated
2012-06-15 19:09:32.824 [error] <0.20974.188> gen\_server <0.20974.188>
terminated with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}
2012-06-15 19:09:32.972 [error] <0.20974.188> CRASH REPORT Process
<0.20974.188> with 0 neighbours crashed with reason:
{mem\_error,[{zlib,call,3},{zlib,zip,1},{riak\_kv\_pb\_socket,process\_message,2},{riak\_kv\_pb\_socket,handle\_info,2},{gen\_server2,handle\_msg,7},{proc\_lib,init\_p\_do\_apply,3}]}


Thanks In Advance,
Amol Rajoba
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

