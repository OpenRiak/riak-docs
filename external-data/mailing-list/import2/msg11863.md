---
title: "Re: performance"
description: ""
project: community
lastmod: 2013-08-01T21:40:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg11863"
mailinglist_parent_id: "msg11861"
author_name: "Toby Corkindale"
project_section: "mailinglistitem"
sent_date: 2013-08-01T21:40:41-07:00
---



On 02/08/13 13:13, Jeremy Ong wrote:

What erlang version did you build with? How are you load balancing
between the nodes? What kind of disks are you using?



I don't think load-balancing or poor disks could cause performance to 
drop down to that 1/second rate.


I mean, even if you're using a single consumer SATA disk, and running up 
a bunch of virtual machines on a laptop, with no load balancing at all, 
then you still get much faster performance than 1/s.


T


On Thu, Aug 1, 2013 at 7:53 PM, Paul Ingalls  wrote:

FYI, 2 more nodes died with the end of the last test. Storm, which I'm
using to put data in, kills the topology a bit abruptly, perhaps the nodes
don't like a client going away like that?

log from one of the nodes:

2013-08-02 02:27:23 =ERROR REPORT====
Error in process <0.4959.0> on node 'riak@riak004' with exit value:
{badarg,[{riak\_core\_stat,vnodeq\_len,1,[{file,"src/riak\_core\_stat.erl"},{line,181}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[{file,"src/riak\_core\_stat.erl"},{line,172}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[...

2013-08-02 02:27:33 =ERROR REPORT====
Error in process <0.5055.0> on node 'riak@riak004' with exit value:
{badarg,[{riak\_core\_stat,vnodeq\_len,1,[{file,"src/riak\_core\_stat.erl"},{line,181}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[{file,"src/riak\_core\_stat.erl"},{line,172}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[...

2013-08-02 02:27:51 =ERROR REPORT====
Error in process <0.5228.0> on node 'riak@riak004' with exit value:
{badarg,[{riak\_core\_stat,vnodeq\_len,1,[{file,"src/riak\_core\_stat.erl"},{line,181}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[{file,"src/riak\_core\_stat.erl"},{line,172}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[...

and the log from the other node:

2013-08-02 00:09:39 =ERROR REPORT====
Error in process <0.4952.0> on node 'riak@riak007' with exit value:
{badarg,[{riak\_core\_stat,vnodeq\_len,1,[{file,"src/riak\_core\_stat.erl"},{line,181}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[{file,"src/riak\_core\_stat.erl"},{line,172}]},{riak\_core\_stat,'-vnodeq\_stats/0-lc$^0/1-0-',1,[...

2013-08-02 00:09:44 =ERROR REPORT====
\*\* State machine <0.2368.0> terminating
\*\* Last event in was unregistered
\*\* When State == active
\*\* Data ==
{state,114179815416476790484662877555959610910619729920,riak\_kv\_vnode,{deleted,{state,114179815416476790484662877555959610910619729920,riak\_kv\_eleveldb\_backend,{state,<<>>,"/mnt/datadrive/riak/data/leveldb/114179815416476790484662877555959610910619729920",[{create\_if\_missing,true},{max\_open\_files,128},{use\_bloomfilter,true},{write\_buffer\_size,58858594}],[{add\_paths,[]},{allow\_strfun,false},{anti\_entropy,{on,[]}},{anti\_entropy\_build\_limit,{1,3600000}},{anti\_entropy\_concurrency,2},{anti\_entropy\_data\_dir,"/mnt/datadrive/riak/data/anti\_entropy"},{anti\_entropy\_expire,604800000},{anti\_entropy\_leveldb\_opts,[{write\_buffer\_size,4194304},{max\_open\_files,20}]},{anti\_entropy\_tick,15000},{create\_if\_missing,true},{data\_root,"/mnt/datadrive/riak/data/leveldb"},{fsm\_limit,50000},{hook\_js\_vm\_count,2},{http\_url\_encoding,on},{included\_applications,[]},{js\_max\_vm\_mem,8},{js\_thread\_stack,16},{legacy\_stats,true},{listkeys\_backpressure,true},{map\_js\_vm\_count,8},{mapred\_2i\_pipe,true},{mapred\_name

,"mapred"
},{max\_open\_files,128},{object\_format,v1},{reduce\_js\_vm\_count,6},{stats\_urlpath,"stats"},{storage\_backend,riak\_kv\_eleveldb\_backend},{use\_bloomfilter,true},{vnode\_vclocks,true},{write\_buffer\_size,58858594}],[],[],[{fill\_cache,false}],true,false},{dict,0,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},undefined,3000,1000,100,100,true,true,undefined}},riak@riak003,none,undefined,undefined,undefined,{pool,riak\_kv\_worker,10,[]},undefined,107615}

\*\* Reason for termination =
\*\*
{badarg,[{eleveldb,close,[<<>>],[]},{riak\_kv\_eleveldb\_backend,stop,1,[{file,"src/riak\_kv\_eleveldb\_backend.erl"},{line,149}]},{riak\_kv\_vnode,terminate,2,[{file,"src/riak\_kv\_vnode.erl"},{line,836}]},{riak\_core\_vnode,terminate,3,[{file,"src/riak\_core\_vnode.erl"},{line,847}]},{gen\_fsm,terminate,7,[{file,"gen\_fsm.erl"},{line,586}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}
2013-08-02 00:09:44 =CRASH REPORT====
 crasher:
 initial call: riak\_core\_vnode:init/1
 pid: <0.2368.0>
 registered\_name: []
 exception exit:
{{badarg,[{eleveldb,close,[<<>>],[]},{riak\_kv\_eleveldb\_backend,stop,1,[{file,"src/riak\_kv\_eleveldb\_backend.erl"},{line,149}]},{riak\_kv\_vnode,terminate,2,[{file,"src/riak\_kv\_vnode.erl"},{line,836}]},{riak\_core\_vnode,terminate,3,[{file,"src/riak\_core\_vnode.erl"},{line,847}]},{gen\_fsm,terminate,7,[{file,"gen\_fsm.erl"},{line,586}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]},[{gen\_fsm,terminate,7,[{file,"gen\_fsm.erl"},{line,589}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}
 ancestors: [riak\_core\_vnode\_sup,riak\_core\_sup,<0.139.0>]
 messages: []
 links: [<0.142.0>]
 dictionary: [{random\_seed,{8115,23258,22987}}]
 trap\_exit: true
 status: running
 heap\_size: 196418
 stack\_size: 24
 reductions: 12124
 neighbours:
2013-08-02 00:09:44 =SUPERVISOR REPORT====
 Supervisor: {local,riak\_core\_vnode\_sup}
 Context: child\_terminated
 Reason:
{badarg,[{eleveldb,close,[<<>>],[]},{riak\_kv\_eleveldb\_backend,stop,1,[{file,"src/riak\_kv\_eleveldb\_backend.erl"},{line,149}]},{riak\_kv\_vnode,terminate,2,[{file,"src/riak\_kv\_vnode.erl"},{line,836}]},{riak\_core\_vnode,terminate,3,[{file,"src/riak\_core\_vnode.erl"},{line,847}]},{gen\_fsm,terminate,7,[{file,"gen\_fsm.erl"},{line,586}]},{proc\_lib,init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,227}]}]}
 Offender:
[{pid,<0.2368.0>},{name,undefined},{mfargs,{riak\_core\_vnode,start\_link,undefined}},{restart\_type,temporary},{shutdown,300000},{child\_type,worker}]



Paul Ingalls
Founder & CEO Fanzo
p...@fanzo.me
@paulingalls
http://www.linkedin.com/in/paulingalls



On Aug 1, 2013, at 7:49 PM, Paul Ingalls  wrote:

I should say that I build riak from the master branch on the git repository.
Perhaps that was a bad idea?

Paul Ingalls
Founder & CEO Fanzo
p...@fanzo.me
@paulingalls
http://www.linkedin.com/in/paulingalls



On Aug 1, 2013, at 7:47 PM, Paul Ingalls  wrote:

Thanks for the quick response Matthew!

I gave that a shot, and if anything the performance was worse. When I
picked 128 I ran through the calculations on this page:

http://docs.basho.com/riak/latest/ops/advanced/backends/leveldb/#Parameter-Planning

and thought that would work, but it sounds like I was quite a bit off from
what you have below.

Looking at risk control, the memory was staying pretty low, and watching top
the CPU was well in hand. iostat had very little of the CPU in iowait,
although it was writing a lot. I imagine, however, that this is missing a
lot of the details.

Any other ideas? I can't imagine one get/update/put cycle per second is the
best I can doâ€¦

Thanks!

Paul Ingalls
Founder & CEO Fanzo
p...@fanzo.me
@paulingalls
http://www.linkedin.com/in/paulingalls



On Aug 1, 2013, at 7:12 PM, Matthew Von-Maszewski 
wrote:

Try cutting your max open files in half. I am working from my iPad not my
workstation so my numbers are rough. Will get better ones to you in the
morning.

The math goes like this:

- vnode/partition heap usage is (4Mbytes \* (max\_open\_files -10)) + 8Mbyte
- you have 18 vnodes per server (multiply the above times 18)
- AAE (active anti-entropy is"on") so that adds (4Mbyte\* 10 + 8Mbyte) times
18 vnodes

The three lines above give the total memory leveldb will attempt to use per
server if your dataset is large enough to fill it.

Matthew



\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

