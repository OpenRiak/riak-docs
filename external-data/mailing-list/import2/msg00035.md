---
title: "Re: "all nodes failed" while using doc sample code"
description: ""
project: community
lastmod: 2010-04-14T02:30:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00035"
mailinglist_parent_id: "msg00034"
author_name: "Kevin Smith"
project_section: "mailinglistitem"
sent_date: 2010-04-14T02:30:41-07:00
---


Unfortunately you've run into some unintuitive behavior Erlang has with 
anonymous functions. When Erlang sends an anonymous function to a remote VM it 
sends a pointer to the function instead of the function itself. This means the 
code which creates the anonymous functions needs to be on the server-side 
codepath so the VM receiving the pointer can resolve it to runnable code. This 
dramatically reduces the utility of anonymous functions in map/reduce jobs, but 
it's a limitation of how Erlang handles these types of functions.

If you're just experimenting with the map/reduce API AND you have a single Riak 
server (no cluster) then you can get this to work by following these steps:

1) Start riak via 'bin/riak console'
2) Inside the console, obtain a Riak client instance like so: {ok, Client} = 
riak:local\_client()
3) Build and execute your map/reduce job inside the riak console

Alternatively, you'll need to define your map/reduce functions in a proper 
Erlang module and distribute it to all the Riak nodes and insure it's on the 
codepath. If you decide to go this route you can use Erlang's hot code loading 
to load updated versions of the functions without needing to reboot the Riak 
nodes.

--Kevin
On Apr 13, 2010, at 11:58 PM, ben six wrote:

> 
> on macos 10.6.3 using riak-0.9.1 following instructions at 
> https://wiki.basho.com/display/RIAK/Installing+on+Mac+OS+X
> install and test passed without issue.
> then tried the erland mapreduce example at 
> https://wiki.basho.com/display/RIAK/MapReduce#MapReduce-MapReduceviatheErlangAPI
> 
> ~/FromFtp/riak/riak-0.9.1/erts-5.7.5/bin/erl -name riakcli...@127.0.0.1 
> -setcookie riak -pa `pwd`/lib/riak-0.9.1.ez/riak-0.9.1/ebin
> Erlang R13B04 (erts-5.7.5) [source] [smp:2:2] [rq:2] [async-threads:0] [hipe] 
> [kernel-poll:false]
> 
> Eshell V5.7.5 (abort with ^G)
> (riakcli...@127.0.0.1)1> code:which(riak).
> "~/FromFtp/riak/riak-0.9.1/lib/riak-0.9.1.ez/riak-0.9.1/ebin/riak.beam"
> (riakcli...@127.0.0.1)2> {ok, Client} = riak:client\_connect('r...@127.0.0.1').
> {ok,{riak\_client,'r...@127.0.0.1',<<6,202,197,138>>}}
> (riakcli...@127.0.0.1)4> Count = fun(G, undefined, none) ->
> (riakcli...@127.0.0.1)4> [dict:from\_list([{I, 1} || I <- 
> riak\_object:get\_value(G)])]
> (riakcli...@127.0.0.1)4> end.
> #Fun
> (riakcli...@127.0.0.1)5> Merge = fun(Gcounts, none) ->
> (riakcli...@127.0.0.1)5> [lists:foldl(fun(G, Acc) ->
> (riakcli...@127.0.0.1)5> dict:merge(fun(\_, X, Y) 
> -> X+Y end,
> (riakcli...@127.0.0.1)5> G, Acc)
> (riakcli...@127.0.0.1)5> end,
> (riakcli...@127.0.0.1)5> dict:new(),
> (riakcli...@127.0.0.1)5> Gcounts)]
> (riakcli...@127.0.0.1)5> end.
> #Fun
> (riakcli...@127.0.0.1)6> {ok, [R]} = Client:mapred([{<<"groceries">>, 
> <<"mine">>},
> (riakcli...@127.0.0.1)6> {<<"groceries">>, 
> <<"yours">>}],
> (riakcli...@127.0.0.1)6> [{map, {qfun, Count}, 
> none, false},
> (riakcli...@127.0.0.1)6> {reduce, {qfun, 
> Merge}, none, true}]).
> \*\* exception error: no match of right hand side value "all nodes failed"
> 
> above happened when starting riak with console or plain ./bin/riak start 
> (riak's erl shell : Erlang R13B04 (erts-5.7.5) [source] [smp:2:2] [rq:2] 
> [async-threads:0] [hipe] [kernel-poll:false])
> 
> also error when using erlang shell (from port : Erlang R13B03 (erts-5.7.4) 
> [source] [64-bit] [smp:2:2] [rq:2] [async-threads:0] [hipe] 
> [kernel-poll:false]) :
> ::erl -name riakcli...@127.0.0.1 -setcookie riak -pa 
> `pwd`/lib/riak-0.9.1.ez/riak-0.9.1/ebin
> Erlang R13B03 (erts-5.7.4) [source] [64-bit] [smp:2:2] [rq:2] 
> [async-threads:0] [hipe] [kernel-poll:false]
> 
> Eshell V5.7.4 (abort with ^G)
> (riakcli...@127.0.0.1)1> code:which(riak).
> "~/FromFtp/riak/riak-0.9.1/lib/riak-0.9.1.ez/riak-0.9.1/ebin/riak.beam"
> (riakcli...@127.0.0.1)2> {ok, Client} = riak:client\_connect('r...@127.0.0.1').
> {ok,{riak\_client,'r...@127.0.0.1',<<4,181,78,207>>}}
> (riakcli...@127.0.0.1)4> Count = fun(G, undefined, none) ->
> (riakcli...@127.0.0.1)4> [dict:from\_list([{I, 1} || I <- 
> riak\_object:get\_value(G)])]
> (riakcli...@127.0.0.1)4> end.
> #Fun
> (riakcli...@127.0.0.1)5> Merge = fun(Gcounts, none) ->
> (riakcli...@127.0.0.1)5> [lists:foldl(fun(G, Acc) ->
> (riakcli...@127.0.0.1)5> dict:merge(fun(\_, X, Y) 
> -> X+Y end,
> (riakcli...@127.0.0.1)5> G, Acc)
> (riakcli...@127.0.0.1)5> end,
> (riakcli...@127.0.0.1)5> dict:new(),
> (riakcli...@127.0.0.1)5> Gcounts)]
> (riakcli...@127.0.0.1)5> end.
> #Fun
> (riakcli...@127.0.0.1)6> {ok, [R]} = Client:mapred([{<<"groceries">>, 
> <<"mine">>},
> (riakcli...@127.0.0.1)6> {<<"groceries">>, 
> <<"yours">>}],
> (riakcli...@127.0.0.1)6> [{map, {qfun, Count}, 
> none, false},
> (riakcli...@127.0.0.1)6> {reduce, {qfun, 
> Merge}, none, true}]).
> \*\* exception error: undefined function luke:new\_flow/5
> in function riak\_client:mapred\_stream/4
> in call from riak\_client:mapred/4
> 
> i used the default config files so the cookie is also consistant.
> new to this so not sure where to get from there.
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

