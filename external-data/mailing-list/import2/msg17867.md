---
title: "Re: Crash Log: yz_anti_entropy"
description: ""
project: community
lastmod: 2017-01-19T01:34:26-0800
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg17867"
mailinglist_parent_id: "msg17866"
author_name: "Magnus Kessler"
project_section: "mailinglistitem"
sent_date: 2017-01-19T01:34:26-0800
---


On 18 January 2017 at 20:36, Junk, Damion A  wrote:

> Hi All -
>
> I'm seeing some strange behavior on a dev server. Right now the riak kv
> 2.2.0 server has 9GB free Ram, and no keys/values stored in Riak at all.
> (I've been trying to figure out what's going on with the server, so I
> completely wiped /var/lib/riak and re-installed from packagecould). Ulimit
> -n is set appropriately as well.
>
> If I make the following changes to /etc/riak/riak.conf I get crash error
> messages:
>
> storage\_backend = leveldb
> search = on
>
> Turning search on with bitcask results in no such crash/error messages.
> When switching between bitcask/leveldb on this test instance, i'm wiping
> the /var/lib/riak directory each time.
>
> Not much is turning up in google, and there is definitely plenty of memory
> available for allocation.
>
>
> Just wondering if anyone else has seen this.
>
>
> Thanks!
>
>
> The error messages:
>
> (crash.log)
>
> 2017-01-18 15:27:23 =CRASH REPORT====
> crasher:
> initial call: yz\_index\_hashtree:init/1
> pid: <0.2356.0>
> registered\_name: []
> exception exit: {{{badmatch,{error,{db\_open,"IO error: lock
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}}},[{hashtree,new\_segment\_store,2,[{file,"src/
> hashtree.erl"},{line,725}]},{hashtree,new,2,[{file,"src/
> hashtree.erl"},{line,246}]},{yz\_index\_hashtree,do\_new\_tree,
> 3,[{file,"src/yz\_index\_hashtree.erl"},{line,377}]},{
> lists,foldl,3,[{file,"lists.erl"},{line,1248}]},{yz\_index\_
> hashtree,init\_trees,3,[{file,"src/yz\_index\_hashtree.erl"},{
> line,340}]},{yz\_index\_hashtree,init,1,[{file,"src/
> yz\_index\_hashtree.erl"},{line,191}]},{gen\_server,init\_it,6,[
> {file,"gen\_server.erl"},{line,304}]},{proc\_lib,init\_p\_do\_
> apply,3,[{file,"proc\_lib.erl"},{line,239}]}]},[{gen\_server,
> init\_it,6,[{file,"gen\_server.erl"},{line,328}]},{proc\_lib,
> init\_p\_do\_apply,3,[{file,"proc\_lib.erl"},{line,239}]}]}
> ancestors: [yz\_index\_hashtree\_sup,yz\_general\_sup,yz\_sup,<0.711.0>]
> messages: []
> links: [<0.2206.0>]
> dictionary: []
> trap\_exit: true
> status: running
> heap\_size: 1598
> stack\_size: 27
> reductions: 689
> neighbours:
> 2017-01-18 15:27:24 =SUPERVISOR REPORT====
> Supervisor: {local,yz\_index\_hashtree\_sup}
> Context: child\_terminated
> Reason: {{badmatch,{error,{db\_open,"IO error: lock
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}}},[{hashtree,new\_segment\_store,2,[{file,"src/
> hashtree.erl"},{line,725}]},{hashtree,new,2,[{file,"src/
> hashtree.erl"},{line,246}]},{yz\_index\_hashtree,do\_new\_tree,
> 3,[{file,"src/yz\_index\_hashtree.erl"},{line,377}]},{
> lists,foldl,3,[{file,"lists.erl"},{line,1248}]},{yz\_index\_
> hashtree,init\_trees,3,[{file,"src/yz\_index\_hashtree.erl"},{
> line,340}]},{yz\_index\_hashtree,init,1,[{file,"src/
> yz\_index\_hashtree.erl"},{line,191}]},{gen\_server,init\_it,6,[
> {file,"gen\_server.erl"},{line,304}]},{proc\_lib,init\_p\_do\_
> apply,3,[{file,"proc\_lib.erl"},{line,239}]}]}
> Offender: [{pid,<0.2356.0>},{name,ignored},{mfargs,{yz\_index\_
> hashtree,start\_link,undefined}},{restart\_type,temporary},{
> shutdown,5000},{child\_type,worker}]
>
>
>
> (console.log)
>
> 2017-01-18 15:35:39.100 [error] <0.3049.0> CRASH REPORT Process <0.3049.0>
> with 0 neighbours exited with reason: no match of right hand value
> {error,{db\_open,"IO error: lock /var/lib/riak/yz\_anti\_entropy/
> 639406966332270026714112114313373821099470487552/LOCK: Cannot allocate
> memory"}} in hashtree:new\_segment\_store/2 line 725 in gen\_server:init\_it/6
> line 328
> 2017-01-18 15:35:39.101 [error] <0.2206.0> Supervisor
> yz\_index\_hashtree\_sup had child ignored started with
> {yz\_index\_hashtree,start\_link,undefined} at <0.3049.0> exit with reason
> no match of right hand value {error,{db\_open,"IO error: lock
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}} in hashtree:new\_segment\_store/2 line 725 in
> context child\_terminated
> 2017-01-18 15:35:39.101 [info] 
> <0.3050.0>@riak\_core\_throttle:enable\_throttle:119
> Enabling throttle for yokozuna/aae\_throttle.
> 2017-01-18 15:35:39.101 [error] <0.3030.0> gen\_server yz\_entropy\_mgr
> terminated with reason: no match of right hand value
> {error,{{badmatch,{error,{db\_open,"IO error: lock
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}}},[{hashtree,new\_segment\_store,2,[{file,"src/
> hashtree.erl"},{line,725}]},{hashtree,new,2,[{file,"src/
> hashtree.erl"},{line,246}]},{yz\_index\_hashtree,do\_new\_tree,
> 3,[{file,"src/yz\_index\_hashtree.erl"},{line,377}]},{
> lists,foldl,3,[{file,"lists.erl"},{line,1248}]},{yz\_index\_
> hashtree,init\_trees,3,[{file,"src/yz\_index\_hashtree.erl"},{line,340}]},...]}}
> in yz\_entropy\_mgr:'-reload\_hashtrees/3-fun-0-'/2 line 371
> 2017-01-18 15:35:39.101 [error] <0.3030.0> CRASH REPORT Process
> yz\_entropy\_mgr with 0 neighbours exited with reason: no match of right hand
> value {error,{{badmatch,{error,{db\_open,"IO error: lock
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}}},[{hashtree,new\_segment\_store,2,[{file,"src/
> hashtree.erl"},{line,725}]},{hashtree,new,2,[{file,"src/
> hashtree.erl"},{line,246}]},{yz\_index\_hashtree,do\_new\_tree,
> 3,[{file,"src/yz\_index\_hashtree.erl"},{line,377}]},{
> lists,foldl,3,[{file,"lists.erl"},{line,1248}]},{yz\_index\_
> hashtree,init\_trees,3,[{file,"src/yz\_index\_hashtree.erl"},{line,340}]},...]}}
> in yz\_entropy\_mgr:'-reload\_hashtrees/3-fun-0-'/2 line 371 in
> gen\_server:terminate/6 line 744
> 2017-01-18 15:35:39.102 [error] <0.2010.0> Supervisor yz\_general\_sup had
> child yz\_entropy\_mgr started with yz\_entropy\_mgr:start\_link() at <0.3030.0>
> exit with reason no match of right hand value 
> {error,{{badmatch,{error,{db\_open,"IO
> error: lock 
> /var/lib/riak/yz\_anti\_entropy/639406966332270026714112114313373821099470487552/LOCK:
> Cannot allocate memory"}}},[{hashtree,new\_segment\_store,2,[{file,"src/
> hashtree.erl"},{line,725}]},{hashtree,new,2,[{file,"src/
> hashtree.erl"},{line,246}]},{yz\_index\_hashtree,do\_new\_tree,
> 3,[{file,"src/yz\_index\_hashtree.erl"},{line,377}]},{
> lists,foldl,3,[{file,"lists.erl"},{line,1248}]},{yz\_index\_
> hashtree,init\_trees,3,[{file,"src/yz\_index\_hashtree.erl"},{line,340}]},...]}}
> in yz\_entropy\_mgr:'-reload\_hashtrees/3-fun-0-'/2 line 371 in context
> child\_terminated
>

Hi Damion,

Let me first state that AAE always uses leveldb, regardless of the storage
backend chosen for Riak KV data. Could you please state how much physical
memory your Riak nodes have, and what you have configured for
"leveldb.maximum\_memory.percent" in "riak.conf"? Have you changed the
settings for "search.solr.jvm\_options", in particular the memory allocated
to Solr?

As a general rule, leveldb should have at least 350MB of memory available
per partition, and performance has been shown to increase with up to 2GB
(2.5 GB when also using Search and AAE) per partition. Please check that
you have enough memory available in your system.

Kind Regards,

Magnus

-- 
Magnus Kessler
Client Services Engineer
Basho Technologies Limited

Registered Office - 8 Lincolnâ€™s Inn Fields London WC2A 3BP Reg 07970431
\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

