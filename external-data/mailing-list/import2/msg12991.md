---
title: "Re: Degraded response times with massive increase in Erlang VM	process memory use"
description: ""
project: community
lastmod: 2013-11-15T02:17:52-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg12991"
mailinglist_parent_id: "msg12988"
author_name: "Dave Brady"
project_section: "mailinglistitem"
sent_date: 2013-11-15T02:17:52-08:00
---


Hi Russell,

Ha! You triggered my memory: someone recently mentioned they wanted to use the 
pagination capability.

I'll go bother them and find out what they did.

Thanks for the hint!

--
Dave Brady

----- Original Message -----
From: "Russell Brown" 
To: "Dave Brady" 
Cc: "Luke Bakken" , "riak-users" 
Sent: Jeudi 14 Novembre 2013 23:07:46
Subject: Re: Degraded response times with massive increase in Erlang VM process 
memory use

Hi Dave,

Are you sure that "No queries are running”?

The log you posted shows the index coverage fsm running as well as the 
streaming merge sort buffer.

My guess would be you have some (many?) 2i queries with large page\_size set on 
the results and a slow vnode causing all the results to be buffered in memory.

Can you check again that your regular workload doesn’t include a bunch of 2i 
queries with large result sets?

Cheers

Russell

On 14 Nov 2013, at 21:32, Dave Brady  wrote:

> Hi Luke,
> 
> Thanks for responding! I've been unavailable most of the day, hence my late 
> reply.
> 
> I'll gather up the those logs (tomorrow).
> 
> No queries are running, and no one has tried to getting the a key list. We 
> restarted our programs to clear any connections they had to the slow nodes 
> after disabling those nodes in haproxy.
> 
> One node has slowly, over the last five hours, started to head back to 
> normal. Peak usage is down to 5.2 GB.
> 
> The other node has gotten even worse. It's now ranging from 6.5 GB to 23 GB. 
> 
> --
> Dave Brady
> 
> From: "Luke Bakken" 
> To: "Dave Brady" 
> Cc: "riak-users" 
> Sent: Jeudi 14 Novembre 2013 18:14:43
> Subject: Re: Degraded response times with massive increase in Erlang VM 
> process memory use
> 
> Hi Dave,
> 
> A few people have chimed in to ask what kinds of queries are running / have 
> been run recently against this cluster - Map/Reduce, list keys, 2i?
> 
> --
> Luke Bakken
> CSE
> lbak...@basho.com
> 
> 
> On Thu, Nov 14, 2013 at 1:56 AM, Dave Brady  wrote:
> Hello Everyone,
> 
> Two of our five nodes seeing the 100% GET/PUT times (node\_[get | 
> put]\_fsm\_time\_100) increase to as high as 8 seconds, and looking at our 
> available metrics we see huge amounts memory being used by Erlang processes 
> (memory\_processed\_used).
> 
> We normally see Erlang processes use tens of MBs, and occasionally a few 
> hundred MBs for short periods. One node is now using between 5.2 GB to 18.5 
> GB. The other one is just little lower: 4 GB to 14 GB.
> 
> Our average object size is roughly 25 KB.
> 
> The logs on these two nodes have lots of:
> 
> 2013-11-14 09:26:03.961 [info] 
> <0.83.0>@riak\_core\_sysmon\_handler:handle\_event:92 monitor long\_gc 
> <0.19362.2932> 
> [{initial\_call,{riak\_core\_coverage\_fsm,init,1}},{almost\_current\_function,{sms,sms,1}},{message\_queue\_len,41}]
> 
> [{timeout,5356},{old\_heap\_block\_size,0},{heap\_block\_size,870001580},{mbuf\_size,0},{stack\_size,54},{old\_heap\_size,0},{heap\_size,336260414}]
> 2013-11-14 09:26:03.961 [info] 
> <0.83.0>@riak\_core\_sysmon\_handler:handle\_event:92 monitor large\_heap 
> <0.19362.2932> 
> [{initial\_call,{riak\_core\_coverage\_fsm,init,1}},{almost\_current\_function,{sms,sms,1}},{message\_queue\_len,41}]
> 
> [{old\_heap\_block\_size,0},{heap\_block\_size,870001580},{mbuf\_size,0},{stack\_size,54},{old\_heap\_size,0},{heap\_size,336260414}]
> 2013-11-14 09:26:03.968 [error] <0.3205.3273> CRASH REPORT Process 
> <0.3205.3273> with 0 neighbours crashed with reason: no function clause 
> matching webmachine\_request:peer\_from\_peername({error,enotconn}, 
> {webmachine\_request,{wm\_reqstate,#Port<0.38822194>,[],undefined,undefined,undefined,{wm\_reqdata,...},...}})
> line 150
> 
> Anyone seen this before?
> --
> Dave Brady
> 
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
> 
> 
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

