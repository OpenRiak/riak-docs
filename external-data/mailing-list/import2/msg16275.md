---
title: "Re: uWSGI + Riak connection issues"
description: ""
project: community
lastmod: 2015-07-06T09:56:59-0700
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg16275"
mailinglist_parent_id: "msg16274"
author_name: "tele"
project_section: "mailinglistitem"
sent_date: 2015-07-06T09:56:59-0700
---


Hi Luke,

Yes. I could not find the root cause of the issue but i managed a
workaround. I got it working by using before\_first\_request hook
in flask. By loading the keys there i can use more than one worker
without encountering the issue.

Here is the sample app:

import os, sys
from flask import Flask, request, Response, jsonify, g, url\_for,
make\_response, session import riak

app = Flask(\_\_name\_\_)
riak\_client = riak.RiakClient(host='127.0.0.1', pb\_port=10017,
protocol='pbc')

content\_keys = []

@app.before\_first\_request
def \_run\_on\_start():
 print 'Content bucket'
 content\_bucket =riak\_client.bucket\_type('content').bucket('content')

 print 'cache content keys'
 #content\_keys = content\_bucket.get\_keys() 
 for keys in content\_bucket.stream\_keys():
 for key in keys:
 content\_keys.append(key)


@app.route("/")
def myapp():
 print 'get bucket'
 user\_bucket = riak\_client.bucket\_type('user\_type').bucket('users')
 print 'Total content: %s' % len(content\_keys)
 print '####################### get user info from bucket'
 user\_info = user\_bucket.get('auser')
 return '', 200

if \_\_name\_\_ == '\_\_main\_\_':
 app.run(
 host="0.0.0.0",debug=False,
 port=int("5000")
 )


:tele


On Mon, 6 Jul 2015 08:49:59 -0700
Luke Bakken  wrote:

> Question at the bottom, thanks.
> 
> On Sat, Jun 20, 2015 at 1:10 PM, tele  wrote:
> > Hi All,
> >
> > This is going to be a long post but it explains exactly how to
> > reproduce the issue.
> 
> Code listing:
> 
> > print 'cache content keys'
> > content\_keys = []
> > #content\_keys = content\_bucket.get\_keys()
> > for keys in content\_bucket.stream\_keys():
> > for key in keys:
> > content\_keys.append(key)
> 
> Do you run into the same issue if you use get\_keys() rather than
> stream\_keys() ?
> 
> --
> Luke Bakken
> Engineer
> lbak...@basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

