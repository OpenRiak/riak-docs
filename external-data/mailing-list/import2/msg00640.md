---
title: "riak_multi_backend and bitcask"
description: ""
project: community
lastmod: 2010-06-23T10:45:58-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00640"
author_name: "Tamas Nagy"
project_section: "mailinglistitem"
sent_date: 2010-06-23T10:45:58-07:00
---


Hi,

I'm pretty new to the list (and riak) so please forgive my ignorance but I 
didn't manage to find a public bugtracker for riak. Hence I'm posting my 
problem here. (Bitbucket and Internet Explorer(using it not by choice) do not 
mix well. So that might be the problem why I didn't find it).

I've tried to use riak\_kv\_multi\_backend with one of the backends being the 
riak\_kv\_bitcask\_backend. This does not seem to work with riak-0.11.0. I checked 
tip as well, and I do not think it would work either. The problem boils to 
these few lines (code snippets from tip):

riak\_kv\_vnode:

handle\_info({Mod, Msg}, StateName, #state { mod = Mod } = StateData) ->
 Mod:handle\_info(StateData#state.modstate, Msg),
 {next\_state, StateName, StateData, ?TIMEOUT}.

riak\_kv\_bitcask\_backend:

start(Partition, \_Config) ->
 %% Schedule sync (if necessary)
 case application:get\_env(bitcask, sync\_strategy) of
 {ok, {seconds, Seconds}} ->
 SyncIntervalMs = timer:seconds(Seconds),
 erlang:send\_after(SyncIntervalMs, self(),
 {?MODULE, {sync, SyncIntervalMs}});
 \_ -> ok end,
 %% Schedule merge checks
 erlang:send\_after(?MERGE\_CHECK\_INTERVAL, self(), {?MODULE, merge\_check}),


riak\_kv\_multi\_backend:

handle\_info(State, Msg) ->
 F = fun(\_Name, Module, SubState) ->
 Module:handle\_info(SubState, Msg)
 end, [F(X) || X <- State#state.backends],
 ok.

If riak\_kv\_multi\_backend is configured in riak\_kv\_vnode the state's mod is 
riak\_kv\_multi\_backend but the messages scheduled in riak\_kv\_bitcask\_backend are 
going to have riak\_kv\_bitcask\_backend as their Mod tag.

With my limited understanding about the rest of the sytem it seems to me that 
adding this case to riak\_kv\_vnode would fix the problem:
handle\_info({Mod, Msg}, StateName, #state { mod = riak\_kv\_multi\_backend } = 
StateData) ->
 riak\_kv\_multi\_backend:handle\_info(StateData#state.modstate, Msg),
 {next\_state, StateName, StateData, ?TIMEOUT};

It is a bit wasteful because all the configured backends will get called with 
this message, but it is the best I can think of without leaking too much 
information about the specific backends into the generic code.

Modifying the handle\_info case would work as well however one check would need 
to disappear:

handle\_info({\_ModTag, Msg}, StateName, #state { mod = Mod } = StateData) ->
 Mod:handle\_info(StateData#state.modstate, Msg),
 {next\_state, StateName, StateData, ?TIMEOUT}.

There are a plethora of other ways to fix this like passing the Mod tag to 
riak\_kv\_multi\_backend so that it can filter based on it (this is probably my 
favourite as it is not wasteful and there aren't many code changes needed 
either):
riak\_kv\_vnode:
handle\_info({Mod, Msg}, StateName, #state { mod = riak\_kv\_multi\_backend } = 
StateData) ->
 riak\_kv\_multi\_backend:handle\_info(StateData#state.modstate, {Mod, Msg}),
 {next\_state, StateName, StateData, ?TIMEOUT};

riak\_kv\_multi\_backend:
handle\_info(State, {Mod, Msg}) ->
 F = fun(\_Name, Module, SubState) ->
 Module:handle\_info(SubState, Msg)
 end, [F(X) || X = {\_, Module, \_} <- State#state.backends, Module =:= 
Mod],
 ok.

Code is not tested, but should compile. :)

Regards,
 Tamas

-- 
Tamas Nagy
Erlang Solutions Ltd.
http://www.erlang-solutions.com
---------------------------------------------------

---------------------------------------------------

WE'VE CHANGED NAMES!

Since January 1st 2010 Erlang Training and Consulting Ltd. has become ERLANG 
SOLUTIONS LTD.

www.erlang-solutions.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

