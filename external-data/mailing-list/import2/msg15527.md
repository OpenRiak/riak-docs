---
title: "Re: adding nodes to cluster"
description: ""
project: community
lastmod: 2015-01-20T06:08:30-0800
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg15527"
mailinglist_parent_id: "msg15526"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2015-01-20T06:08:30-0800
---


FYI https://github.com/basho/riak/issues/667

I’ll get to work on it at once, we might be able to hit the 2.0.5 build date at 
the end of the week.

On 20 Jan 2015, at 14:04, Russell Brown  wrote:

> I’ll open a ticket for it. We changed the internal structure of both Maps and 
> Sets, and tested that they were backwards compatible, but clearly missed 
> something.
> 
> On 20 Jan 2015, at 13:54, Alexander Popov  wrote:
> 
>> Upgraded riak 2.0.2-> 2.0.4
>> trying to add nodes to cluster( was single node ) 
>> all new nodes located on another host, but multi-nodes installation from 
>> source
>> each new node have config settings tuned like 
>> 
>> nodename = riak1@10.0.0.28
>> platform\_data\_dir = /var/lib/riak1
>> listener.http.internal = 0.0.0.0:18098
>> listener.protobuf.internal = 0.0.0.0:18087
>> handoff.port = 18099
>> search.solr.port = 18093
>> search.solr.jmx\_port = 18985
>> search=on
>> 
>> after adding this nodes to cluster for long time was nothing was 
>> transferred for new nodes.
>> I was down this nodes and force-remove it from cluster.
>> 
>> After this strange things happens.
>> On new nodes:
>> Even after restart cleaning entire data dir and start again, in folder yz 
>> indexes somehow appears again. 
>> 
>> logs contains only 
>> 2015-01-20 13:15:04.815 [info] <0.352.0>@riak\_core:wait\_for\_service:483 Wait 
>> complete for service riak\_kv (10 seconds)
>> 2015-01-20 13:15:06.660 [info] <0.547.0>@yz\_index:local\_create:189 Created 
>> index contacts\_index with schema contacts
>> 2015-01-20 13:15:08.683 [info] <0.547.0>@yz\_index:local\_create:189 Created 
>> index users\_index with schema users
>> 
>> 
>> Main Node now have bunch of errors on start and periodically after:
>> 
>> 015-01-20 13:29:00.382 [error] <0.871.0>@riak\_core\_vnode:vnode\_command:348 
>> riak\_kv\_vnode command failed 
>> {{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_map,'-filter\_unique/4-fun-1-',4,[{file,"src/ria
>> k\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_dt\_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{l
>> ine,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"orddict.erl"},{line,170}]}]}
>> 2015-01-20 13:29:00.382 [error] <0.650.0>@riak\_core\_vnode:vnode\_command:348 
>> riak\_kv\_vnode command failed 
>> {{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_map,'-filter\_unique/4-fun-1-',4,[{file,"src/ria
>> k\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_dt\_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{l
>> ine,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"orddict.erl"},{line,170}]}]}
>> 2015-01-20 13:29:00.383 [error] <0.4520.0> gen\_fsm <0.4520.0> in state 
>> waiting\_local\_vnode terminated with reason: no case clause matching 
>> {vnode\_error,{{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_
>> map,'-filter\_unique/4-fun-1-',4,[{file,"src/riak\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_
>> dt\_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{line,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
>> in riak\_kv\_put\_fsm:waiting\_local\_vnode/2 line 5
>> 67
>> 2015-01-20 13:29:00.384 [error] <0.4520.0> CRASH REPORT Process <0.4520.0> 
>> with 0 neighbours exited with reason: no case clause matching 
>> {vnode\_error,{{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_ma
>> p,'-filter\_unique/4-fun-1-',4,[{file,"src/riak\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_dt
>> \_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{line,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
>> in riak\_kv\_put\_fsm:waiting\_local\_vnode/2 line 567
>> in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.384 [error] <0.4521.0> gen\_fsm <0.4521.0> in state 
>> waiting\_local\_vnode terminated with reason: no case clause matching 
>> {vnode\_error,{{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_
>> map,'-filter\_unique/4-fun-1-',4,[{file,"src/riak\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_
>> dt\_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{line,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
>> in riak\_kv\_put\_fsm:waiting\_local\_vnode/2 line 5
>> 67
>> 2015-01-20 13:29:00.384 [error] <0.4521.0> CRASH REPORT Process <0.4521.0> 
>> with 0 neighbours exited with reason: no case clause matching 
>> {vnode\_error,{{badrecord,dict},[{dict,filter\_dict,2,[{file,"dict.erl"},{line,464}]},{riak\_dt\_ma
>> p,'-filter\_unique/4-fun-1-',4,[{file,"src/riak\_dt\_map.erl"},{line,466}]},{sets,fold\_bucket,3,[{file,"sets.erl"},{line,313}]},{sets,fold\_seg,4,[{file,"sets.erl"},{line,309}]},{sets,fold\_segs,4,[{file,"sets.erl"},{line,305}]},{riak\_dt
>> \_map,merge,2,[{file,"src/riak\_dt\_map.erl"},{line,454}]},{riak\_kv\_crdt,'-merge\_value/2-fun-0-',5,[{file,"src/riak\_kv\_crdt.erl"},{line,204}]},{orddict,update,4,[{file,"or..."},...]}]}}
>> in riak\_kv\_put\_fsm:waiting\_local\_vnode/2 line 567
>> in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.385 [error] <0.871.0> gen\_fsm <0.871.0> in state active 
>> terminated with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.385 [error] <0.871.0> CRASH REPORT Process <0.871.0> 
>> with 1 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.385 [error] <0.167.0> Supervisor riak\_core\_vnode\_sup had 
>> child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
>> <0.871.0> exit with reason bad record dict in dict:filter\_dict/2 line 464 in 
>> context
>> child\_terminated
>> 2015-01-20 13:29:00.385 [error] <0.988.0> gen\_fsm <0.988.0> in state ready 
>> terminated with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.385 [error] <0.988.0> CRASH REPORT Process <0.988.0> 
>> with 10 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.385 [error] <0.650.0> gen\_fsm <0.650.0> in state active 
>> terminated with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.386 [error] <0.650.0> CRASH REPORT Process <0.650.0> 
>> with 1 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.386 [error] <0.989.0> Supervisor {<0.989.0>,poolboy\_sup} 
>> had child riak\_core\_vnode\_worker started with 
>> riak\_core\_vnode\_worker:start\_link([{worker\_module,riak\_core\_vnode\_worker},{worker\_args,[593735040165679310520
>> 246963290989976735222595584,...]},...]) at undefined exit with reason bad 
>> record dict in dict:filter\_dict/2 line 464 in context shutdown\_error
>> 2015-01-20 13:29:00.386 [error] <0.989.0> gen\_server <0.989.0> terminated 
>> with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.386 [error] <0.989.0> CRASH REPORT Process <0.989.0> 
>> with 0 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_server:terminate/6 line 744
>> 2015-01-20 13:29:00.386 [error] <0.167.0> Supervisor riak\_core\_vnode\_sup had 
>> child undefined started with {riak\_core\_vnode,start\_link,undefined} at 
>> <0.650.0> exit with reason bad record dict in dict:filter\_dict/2 line 464 in 
>> context
>> child\_terminated
>> 2015-01-20 13:29:00.386 [error] <0.696.0> gen\_fsm <0.696.0> in state ready 
>> terminated with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.386 [error] <0.696.0> CRASH REPORT Process <0.696.0> 
>> with 10 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_fsm:terminate/7 line 622
>> 2015-01-20 13:29:00.386 [error] <0.702.0> Supervisor {<0.702.0>,poolboy\_sup} 
>> had child riak\_core\_vnode\_worker started with 
>> riak\_core\_vnode\_worker:start\_link([{worker\_module,riak\_core\_vnode\_worker},{worker\_args,[228359630832953580969
>> 325755111919221821239459840,...]},...]) at undefined exit with reason bad 
>> record dict in dict:filter\_dict/2 line 464 in context shutdown\_error
>> 2015-01-20 13:29:00.386 [error] <0.702.0> gen\_server <0.702.0> terminated 
>> with reason: bad record dict in dict:filter\_dict/2 line 464
>> 2015-01-20 13:29:00.386 [error] <0.702.0> CRASH REPORT Process <0.702.0> 
>> with 0 neighbours exited with reason: bad record dict in dict:filter\_dict/2 
>> line 464 in gen\_server:terminate/6 line 744
>> 
>> 
>> 
>> any advice?
>> 
>> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
>> riak-users mailing list
>> riak-users@lists.basho.com
>> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com
> 
> 
> \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> riak-users mailing list
> riak-users@lists.basho.com
> http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com


\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\_lists.basho.com

