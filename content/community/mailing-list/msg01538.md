---
title: "Re: Understanding Riaks rebalancing and handoff behaviour"
description: ""
project: community
lastmod: 2010-11-15T00:32:55-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01538"
mailinglist_parent_id: "msg01528"
author_name: "Sven Riedel"
project_section: "mailinglistitem"
sent_date: 2010-11-15T00:32:55-08:00
---



On Nov 12, 2010, at 3:57 PM, Nico Meyer wrote:

&gt; Am Freitag, den 12.11.2010, 08:43 +0100 schrieb Sven Riedel:
&gt;&gt;&gt; 
&gt;&gt;&gt; It's not a problem right away. But since the replicated data is not
&gt;&gt;&gt; actively synchronized in the background the keys that were not copied
&gt;&gt;&gt; until the node dies have one less replica. That is until they are read
&gt;&gt;&gt; at least once, at which point read repair does replicate the key again.
&gt;&gt;&gt; So it depends on your setup and requirements, if this is acceptable or
&gt;&gt;&gt; not.
&gt;&gt; 
&gt;&gt; So if the relevant data isn't read in a while and two more nodes go down 
&gt;&gt; (with 
&gt;&gt; an n\\_val of 3), there is a chance that some data is lost.
&gt;&gt; 
&gt; 
&gt; Correct. This might be highly unlikely though.

I agree. But still good to know to be fully informed about the risks involved 
when choosing a small n\\_val with large, write-heavy datasets on few nodes :)

&gt; 
&gt;&gt;&gt; It kind of works anyway, but the vnodes are started and transfered
&gt;&gt;&gt; sequentially. Normally four partitions are transferred in parallel, so I
&gt;&gt;&gt; don't know if this is by design or by accident. The details are
&gt;&gt;&gt; convoluted enough to suspect the latter.
&gt;&gt;&gt; In any case this would also make also have the effect that those
&gt;&gt;&gt; partitions won't show up in the output of riak-admin transfers, since
&gt;&gt;&gt; only running vnodes are considered.
&gt;&gt; 
&gt;&gt; From what I saw in my case the number of handoffs were displayed correctly 
&gt;&gt; in the beginning, however the numbers didn't decrease (or change at all) as 
&gt;&gt; data got handed around.
&gt;&gt; 
&gt; 
&gt; If the node is not restarted, all vnodes are still running, so the
&gt; number would be correct. Most likely no handoffs were being done
&gt; anymore, because four of them crashed and the locks are not cleared in
&gt; this case. By default only four handoffs are allowed at the same time.
&gt; Have you looked in for the error messages I mentioned in your logs?

I just had a look and I see a slightly different exception: 
On riak01 (which had been sending out data, and subsequently shut down):

ERROR: "Handoff receiver for partition ~p exiting abnormally after processing 
~p objects: ~p\\n" - [ 0,
{ noproc, 
 {gen\\_fsm,
 sync\\_send\\_all\\_state\\_event,
 [&lt;0.24196.2404&gt;,
 {handoff\\_data, 
 &lt;&lt;...binary...&gt;&gt;
 },
 60000]}}]

Nothing interesting that I can see on the receiving end(s).


&gt; 
&gt; 
&gt;&gt;&gt; I should probably create a bug report for this, with my patch attached.
&gt;&gt;&gt; Stupid laziness!
&gt;&gt;&gt; 
&gt;&gt;&gt; After reading your original post again, I think almost all of the things
&gt;&gt;&gt; you saw can be explained by the bug that I mentioned in my first answer
&gt;&gt;&gt; (the ring status of removed nodes is not synchronized with the remaining
&gt;&gt;&gt; nodes). The problem obviously becomes worse if you remove several nodes
&gt;&gt;&gt; at a time.
&gt;&gt; 
&gt;&gt; Which means that I shouldn't just wait for riak-admin ringready to return 
&gt;&gt; TRUE, but for the data handoffs to have completed as well before changing 
&gt;&gt; the network topology again?
&gt;&gt; 
&gt; 
&gt; Yes. By using e.g. 'df' or listing the directories in your bitcask dir,
&gt; which should be empty if everything went well.
&gt; But with the two bugs that are still present it might never finish.
&gt; The workaround for this is quite involved at the moment.
&gt; I will try to create bug reports in the next few days.
&gt; 

I see, this wasn't clear to me. This was then probably what caused everything 
to get off track. 
I think I'll throw away the test cluster then and start over, this time not 
just waiting for ringready. Maybe this should be mentioned more prominently in 
the documentation alongside the description of riak-admin ringready. Having a 
"settled ring" implied to me that it's ok to proceed with topology changes :)
&gt; 

Regards,
Sven

------------------------------------------
Scoreloop AG, Brecherspitzstrasse 8, 81541 Munich, Germany, www.scoreloop.com
sven.rie...@scoreloop.com

Sitz der Gesellschaft: München, Registergericht: Amtsgericht München, HRB 
174805 
Vorstand: Dr. Marc Gumpinger (Vorsitzender), Dominik Westner, Christian van der 
Leeden, Vorsitzender des Aufsichtsrates: Olaf Jacobi 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

