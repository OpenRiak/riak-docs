---
title: "Re: Complete Riak failure."
description: ""
project: community
lastmod: 2010-08-09T07:07:10-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00854"
mailinglist_parent_id: "msg00853"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2010-08-09T07:07:10-07:00
---


The error you get means that too many sockets are opened
simultaneously. I guess there are two main possible reasons:

1. You are being spammed by someone
2. Your REST requests to Riak are somehow handled slower than new
requests come. So, the number of opened HTTP connections increase over
time and you start getting this message.

Some time ago I got exactly the same problem with YAWS (nothing
related to Riak though) and I decided to migrate to mochiweb and
optimized some of our server-side code to reduce the response delay.
And that helped.

On Mon, Aug 9, 2010 at 5:55 PM, Richard Heycock  wrote:
&gt; I've been running riak for about a month and I'm using it as a
&gt; persistent cache. Everything has been fine until tonight that is where
&gt; it appears to have had a catastrophic failure. Basically when I make a
&gt; request using the http interface I get a failure. I cannot be more
&gt; specific than that as there is no response code back; I think it's
&gt; getting a TCP reset ...
&gt;
&gt; ... That was about 10 minutes ago. When I tried to find out if I was
&gt; getting a TCP reset I restarted th program and everything was fine.
&gt;
&gt; Anyway most of the errors look like this:
&gt;
&gt;
&gt; =ERROR REPORT==== 9-Aug-2010::13:23:27 ===
&gt; {mochiweb\\_socket\\_server,256,{acceptor\\_error,{error,accept\\_failed}}}
&gt;
&gt; =ERROR REPORT==== 9-Aug-2010::13:23:27 ===
&gt;    application: mochiweb
&gt;    "Accept failed error"
&gt;    "{error,emfile}"
&gt;
&gt; And every so often I get:
&gt;
&gt; =ERROR REPORT==== 9-Aug-2010::13:23:56 ===
&gt; \\*\\* State machine &lt;0.17333.0&gt; terminating
&gt; \\*\\* Last event in was {riak\\_vnode\\_req\\_v1,
&gt;                      182687704666362864775460604089535377456991567872,
&gt;                      {fsm,undefined,&lt;0.17335.0&gt;},
&gt;                      {riak\\_kv\\_put\\_req\\_v1,
&gt;                       {&lt;&lt;"uris"&gt;&gt;,
&gt;                        &lt;&lt;"5ea5dc023dd73b5f711efde3d50b9e91da4c5027"&gt;&gt;},
&gt;                       {r\\_object,&lt;&lt;"uris"&gt;&gt;,
&gt;                        &lt;&lt;"5ea5dc023dd73b5f711efde3d50b9e91da4c5027"&gt;&gt;,
&gt;                        [{r\\_content,
&gt;                          {dict,5,16,16,8,80,48,
&gt;                           {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;                           {{[],[],
&gt;                             [[&lt;&lt;"Links"&gt;&gt;]],
&gt;                             [],[],[],[],[],[],[],
&gt;                             [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,
&gt;                               116,105,111,110,47,106,115,111,110],
&gt;                              [&lt;&lt;"X-Riak-VTag"&gt;&gt;,49,102,84,99,107,121,67,100,
&gt;                               81,67,83,85,102,67,102,118,68,55,80,50,82,118]],
&gt;                             [],[],
&gt;                             [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|
&gt;                               {1281,360236,222890}]],
&gt;                             [],
&gt;                             [[&lt;&lt;"X-Riak-Meta"&gt;&gt;]]}}},
&gt;                          
&gt; &lt;&lt;"{\\"uri\\":\\"http://feedproxy.google.com/~r/time/politics/~3/SGIQlFYkIy8/0,8599,2006898,00.html\\",\\"download\\_date\\":\\"20100809132314\\"}"&gt;&gt;}],
&gt;                        [{&lt;&lt;2,235,89,160&gt;&gt;,{1,63448579436}}],
&gt;                        {dict,1,16,16,8,80,48,
&gt;                         {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;                         {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
&gt;                           [[clean|true]],
&gt;                           []}}},
&gt;                        undefined},
&gt;                       118194806,63448579436,
&gt;                       [{returnbody,true}]}}
&gt; \\*\\* When State == active
&gt; \\*\\*      Data  == {state,182687704666362864775460604089535377456991567872,
&gt;                        riak\\_kv\\_vnode,
&gt;                        
&gt; {state,182687704666362864775460604089535377456991567872,
&gt;                               riak\\_kv\\_bitcask\\_backend,
&gt;                               {#Ref&lt;0.0.0.23192&gt;,
&gt;                                
&gt; "/var/lib/riak/bitcask/182687704666362864775460604089535377456991567872"},
&gt;                               [],false},
&gt;                        undefined,none}
&gt; \\*\\* Reason for termination =
&gt; \\*\\* {bad\\_return\\_value,{error,{write\\_locked,emfile}}}
&gt;
&gt;
&gt; I've put a full log here:
&gt;
&gt;    http://stuff.roughage.com.au/riak-failure.log.gz
&gt;
&gt; It's nearly midnight here and I going to bed but if anyone can shed any
&gt; light on this that'd cool.
&gt;
&gt; rgh
&gt;
&gt; --
&gt; +61 (0) 410 646 369
&gt; [e]:  ...@roughage.com.au
&gt; [im]: r...@jabber.org
&gt;
&gt; You're worried criminals will continue to penetrate into cyberspace, and
&gt; I'm worried complexity, poor design and mismanagement will be there to meet
&gt; them - Marcus Ranum
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
Best regards,
Dmitry Demeshchuk

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

