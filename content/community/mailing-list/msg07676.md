---
title: "Re: Erlang Client: get_update_metadata vs get_metadata"
description: ""
project: community
lastmod: 2012-06-13T00:25:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07676"
mailinglist_parent_id: "msg07673"
author_name: "Andrew Berman"
project_section: "mailinglistitem"
sent_date: 2012-06-13T00:25:26-07:00
---


Thanks guys,

I'm more inclined to have an API like get\\_original\\_metadata and
get\\_metadata. The get\\_metadata in this case always returns whatever
metadata is set on the object, new or original. In the current API, if
calling get\\_update\\_metadata will return the original metadata if there are
no changes, then I kinda fail to see a use case for the get\\_metadata call.
 Anyone?

Thanks again!

Andrew

On Tue, Jun 12, 2012 at 2:37 PM, Michael Radford  wrote:

&gt; Reid,
&gt;
&gt; I do understand why update\\_metadata exists. I guess what I'm
&gt; suggesting is a better default behavior, especially for users who
&gt; don't explicitly set any metadata values. (Or even if they do, for
&gt; when all the metadatas are equivalent.)
&gt;
&gt; I.e., something like this for riakc\\_obj:get\\_update\\_metadata:
&gt;
&gt; get\\_update\\_metadata(#riakc\\_obj{updatemetadata=UM}=Object) -&gt;
&gt; case UM of
&gt; undefined -&gt;
&gt; try
&gt; get\\_metadata(Object)
&gt; catch
&gt; throw:no\\_metadata -&gt;
&gt; dict:new();
&gt; throw:siblings -&gt;
&gt; default\\_resolve\\_metadatas(get\\_metadatas(Object))
&gt; end;
&gt; UM -&gt;
&gt; UM
&gt; end.
&gt;
&gt; default\\_resolve\\_metadatas(Ms = [M | \\_]) -&gt;
&gt; UniqueWritten = lists:usort([ [KV || KV = {K, \\_V} &lt;- dict:to\\_list(M),
&gt; K =/= ?MD\\_LASTMOD,
&gt; K =/= ?MD\\_INDEX
&gt; || M &lt;- Ms ]),
&gt; case UniqueWritten of
&gt; [\\_] -&gt; M;
&gt; [\\_, \\_ | \\_] -&gt; throw(siblings)
&gt; end.
&gt;
&gt; Mike
&gt;
&gt; On Tue, Jun 12, 2012 at 1:18 PM, Reid Draper  wrote:
&gt; &gt;
&gt; &gt; On Jun 12, 2012, at 2:56 PM, Michael Radford wrote:
&gt; &gt;
&gt; &gt;&gt; get\\_metadata returns the metadata that was read from riak. But if
&gt; &gt;&gt; allow\\_mult is true, and there is more than one sibling, then
&gt; &gt;&gt; get\\_metadata throws the exception 'siblings'. You have to call
&gt; &gt;&gt; get\\_metadatas to get a list with metadata for each sibling in that
&gt; &gt;&gt; case.
&gt; &gt;&gt;
&gt; &gt;&gt; get\\_update\\_metadata returns the metadata that is to be written for the
&gt; &gt;&gt; object (if you were to call riakc\\_pb\\_socket:put at that point). The
&gt; &gt;&gt; update metadata is either a single value set explicitly with
&gt; &gt;&gt; riakc\\_obj:update\\_metadata, or if none was set, and there is only one
&gt; &gt;&gt; sibling, then the default is the value of get\\_metadata.
&gt; &gt;&gt;
&gt; &gt;&gt; A related question: if I'm not using any user-specified metadata at
&gt; &gt;&gt; all, but I do have allow\\_mult turned on, then how do I choose which
&gt; &gt;&gt; metadata to write back to riak after resolving the conflict? Or could
&gt; &gt;&gt; I just call update\\_metadata with an empty dict in that case?
&gt; &gt; I'd recommend calling update\\_metadata with an empty dict. Be sure
&gt; &gt; to set the content\\_type as well.
&gt; &gt;&gt;
&gt; &gt;&gt; Right now, I have some conflict resolution code that uses the same
&gt; &gt;&gt; default strategy as mochimedia's statebox\\_riak library, which
&gt; &gt;&gt; arbitrarily chooses the first metadata. But this seems less than
&gt; &gt;&gt; ideal: everything in the metadata is coming from riak, and some of it
&gt; &gt;&gt; (e.g., last-modified timestamps) must be ignored when doing the
&gt; &gt;&gt; update. So it seems like riak should be able to resolve the "metadata
&gt; &gt;&gt; conflict" on its own: just prune all the metadata keys that aren't
&gt; &gt;&gt; actually written, and then if the resulting pruned metadatas are
&gt; &gt;&gt; identical, then there's no conflict. Or, if there is some reason why
&gt; &gt;&gt; the user should prefer one metadata over another, then the client
&gt; &gt;&gt; library should give the user some way to decide.
&gt; &gt; There are definitely cases where the user wants to choose one metadata
&gt; &gt; over another, or perhaps more commonly, "merge" them together, according
&gt; &gt; to some conflict resolution semantics. The client provides
&gt; `update\\_metadata`
&gt; &gt; for this reason. `select\\_sibling/2` can be used to choose a particular
&gt; {Metadata, Value}
&gt; &gt; pair as well.
&gt; &gt;&gt;
&gt; &gt;&gt; Mike
&gt; &gt;&gt;
&gt; &gt;&gt; On Tue, Jun 12, 2012 at 11:25 AM, Andrew Berman 
&gt; wrote:
&gt; &gt;&gt;&gt; Can someone explain the difference between the get\\_update\\_metadata and
&gt; &gt;&gt;&gt; get\\_metadata functions in the Erlang PB Client for Riak? It's very
&gt; &gt;&gt;&gt; confusing...
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thanks,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Andrew
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt;&gt; riak-users mailing list
&gt; &gt;&gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt;
&gt;
