---
title: "Re: java driver : lisKeys() returned also deleted keys"
description: ""
project: community
lastmod: 2010-11-20T11:34:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01585"
mailinglist_parent_id: "msg01584"
author_name: "Andy Gross"
project_section: "mailinglistitem"
sent_date: 2010-11-20T11:34:10-08:00
---


Hi Andrea,

Key deletion in Riak doesn't occur immediately in Riak - keys are first
marked with a tombstone marker and then reaped asynchronously. If you
insert a sleep between the delete() and keys() calls (try a few seconds) -
does the test pass?

- Andy


On Sat, Nov 20, 2010 at 10:02 AM, Andrea Campolonghi  wrote:

&gt; I am having this issues with the java driver :
&gt; https://github.com/krestenkrab/riak-java-pb-client
&gt;
&gt; After deleting a key the listKeys method still return it.
&gt; The following test case put and delete one simple key and fails when
&gt; counting the listKeys item.
&gt;
&gt; Any Suggestion?
&gt;
&gt; public class RiakCacheTest extends TestCase {
&gt;
&gt; private RiakClient rc;
&gt;
&gt; private String host = "172.16.194.134";
&gt;
&gt; private int port = 8087;
&gt;
&gt; private String bucket = "bucket";
&gt;
&gt; @Override
&gt;
&gt; protected void setUp() throws Exception {
&gt;
&gt; rc = new RiakClient(this.host,this.port);
&gt;
&gt; rc.setClientID(this.getClass().toString());
&gt;
&gt; }
&gt;
&gt; public void testRemove(){
&gt;
&gt; String key = "key";
&gt;
&gt; String value = "Andrea";
&gt;
&gt; RiakObject obj = new RiakObject(this.bucket, key, value);
&gt;
&gt; try{
&gt;
&gt; this.rc.store(obj);
&gt;
&gt; assertTrue(getValue(key).equals(value));
&gt;
&gt; assertEquals(keys().size(),1);
&gt;
&gt; this.rc.delete(this.bucket, key);
&gt;
&gt; assertNull(getValue(key));
&gt;
&gt; assertEquals(keys().size(),0);
&gt;
&gt; }catch(IOException e){
&gt;
&gt; e.printStackTrace();
&gt;
&gt; }
&gt;
&gt; }
&gt;
&gt; private String getValue(String key){
&gt;
&gt; String fetched = "";
&gt;
&gt; try{
&gt;
&gt; RiakObject[] ros = this.rc.fetch(this.bucket, key);
&gt;
&gt; for(RiakObject ro : ros){
&gt;
&gt; return ro.getValue().toStringUtf8();
&gt;
&gt; }
&gt;
&gt; }catch(IOException e){
&gt;
&gt; e.printStackTrace();
&gt;
&gt; }
&gt;
&gt; return null;
&gt;
&gt; }
&gt;
&gt;
&gt; private List keys() {
&gt;
&gt; ArrayList result = new ArrayList();
&gt;
&gt; ByteString bucket = ByteString.copyFromUtf8(this.bucket);
&gt;
&gt; try{
&gt;
&gt; KeySource keys = this.rc.listKeys(bucket);
&gt;
&gt; while(keys.hasNext()){
&gt;
&gt; String key = keys.next().toStringUtf8();
&gt;
&gt; result.add(key);
&gt;
&gt; }
&gt;
&gt; }catch(IOException e){
&gt;
&gt; e.printStackTrace();
&gt;
&gt; }
&gt;
&gt; return result;
&gt;
&gt; }
&gt;
&gt;
&gt; }
&gt;
&gt; --
&gt; Andrea Campolonghi
&gt;
&gt; Cell : +39 347 2298435
&gt; acampolon...@gmail.com
&gt; and...@andreacfm.com
&gt; http://www.andreacfm.com
&gt;
&gt; Railo Team
&gt; and...@getrailo.org
&gt; http://getrailo.org
&gt;
&gt;
&gt;

