---
title: "Re: broken links"
description: ""
project: community
lastmod: 2010-06-15T03:46:24-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00599"
mailinglist_parent_id: "msg00598"
author_name: "Kevin Smith"
project_section: "mailinglistitem"
sent_date: 2010-06-15T03:46:24-07:00
---


Francisco - 

You have perfect timing. This same question came up yesterday in #riak.

The core of the issue is Riak runs map functions on the node hosting the 
relevant data. In the case of a 'not found', there is no hosting node -- the 
data doesn't exist -- so the map function is never invoked for the missing 
entry. The 'not found' shows up in the reduce phase because reduce phases 
execute on the node coordinating the entire map/reduce job. Riak converts link 
walks into map phases which is why broken links also show up as 'not found' 
responses being passed to your reduce phase.

Riak.mapValuesJson contains filtering logic since it could be used in either 
map OR reduce phases. I'd recommend performing 'not found' filtering in your 
reduce phases since that'll be the first opportunity you have to deal with the 
missing data.

--Kevin
On Jun 15, 2010, at 4:30 AM, francisco treacy wrote:

&gt; Hi all,
&gt; 
&gt; I have a document with some broken links (i.e. that point to a
&gt; non-existent key), and want to apply a map/reduce there.
&gt; 
&gt; var map = function(v, k, args) { ejsLog("/tmp/mr", "hello from map");
&gt; return [{from: "map"}] }
&gt; 
&gt; db.link({ bucket: "highlights", keep: false })
&gt; .map({source: map})
&gt; .run([["user\\_chapters", id]])()
&gt; 
&gt; (That is, apply link+map to users\\_chapters/id)
&gt; 
&gt; Result: 
&gt; [{"not\\_found":{"bucket":"highlights","key":"f542e13e0b5cece1f637be384e685667"}}]
&gt; 
&gt; Makes sense because that is true. But why don't I get [{from: "map"}],
&gt; and why is nothing logged?
&gt; 
&gt; I presume it is just failing at the link phase, which then outputs no
&gt; keys for the following phases. The "not found" objects should be get
&gt; rid of at a node level, so I don't think they belong to a reduce
&gt; phase. Or is that the case?
&gt; 
&gt; (FWIW i got inspiration from Riak.mapValuesJson which seems to deal
&gt; with not\\_founds, but I never actually seem to reach the map phase).
&gt; 
&gt; What is the recommended approach to gracefully handle broken links? It
&gt; should be fairly easy to exclude not found results from the resulting
&gt; map/reduce array.
&gt; 
&gt; Francisco
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

