---
title: "Re: Riak performance problems when LevelDB database grows beyond 16GB"
description: ""
project: community
lastmod: 2012-11-21T08:01:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09362"
mailinglist_parent_id: "msg09361"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2012-11-21T08:01:23-08:00
---


map reduce is currently outside my skill set. I have forwarded the question to 
others on the team.

I have also asked the team if they can give me the key specifications used for 
auto delete in bitcask. Maybe, just maybe, I can slide the same logic into 
leveldb's compaction algorithm.

Matthew


On Nov 21, 2012, at 10:52 AM,  wrote:

&gt; ---------- Původní zpráva ----------
&gt;&gt; Od: Matthew Von-Maszewski 
&gt;&gt; Datum: 22. 10. 2012
&gt;&gt; Předmět: Re: Riak performance problems when LevelDB database grows beyond 
&gt;&gt; 16GB
&gt;&gt; Jan,
&gt;&gt; 
&gt;&gt; ...
&gt;&gt; The next question from me is whether the drive / disk array problems are 
&gt;&gt; your only problem at this point. The data in log\\_jan.txt looks ok until 
&gt;&gt; the failures start. I am willing to work more, but I need to better 
&gt;&gt; understand your next level of problems.
&gt;&gt; 
&gt;&gt; Matthew
&gt; 
&gt; Hi Matthew,
&gt; 
&gt; thanks again for helping me. It was actually bad RAM. It took me some time to 
&gt; convince the hosting provider since the problem did not show up in their 
&gt; hardware tests. :-/
&gt; 
&gt; I ran a 4 day test when the two bad nodes got fixed, and the original issue 
&gt; (that a Riak node got stuck) did not appear again.
&gt; 
&gt; There are however other problems which seem to be caused by my "misuse" of 
&gt; LevelDB for storing short-lived data (the data is valid only for 24 hours).
&gt; 
&gt; Here is the application throughput during a 4 days test with 5 Riak nodes:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka#5Riak\\_4d\\_edited.jpg
&gt; 
&gt; This graph shows memory use on a Riak node:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka/#MemNode3-edited.jpg
&gt; 
&gt; (Memory use on other nodes looks similar, but the OOM killed was not invoked 
&gt; there.)
&gt; 
&gt; And this graph shows disk space consumption on a Riak node:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace-4d-edited.jpg
&gt; 
&gt; The OOM condition which killed one Riak node (and slowed down the other ones) 
&gt; seems to be caused by the map-reduce jobs which 
&gt; periodically delete old data from the database. The entries are deleted with 
&gt; a mapred job querying the secondary index and using the reduce function 
&gt; published at http://contrib.basho.com/delete\\_keys.html .
&gt; 
&gt; I wish LevelDB could expire old entries in the same was as BitCask does. :-)
&gt; 
&gt; In an older 3 day test I had only 5 min timeout for the mapred jobs (a bug). 
&gt; It caused premature cancellation of the jobs deleting the old data - but the 
&gt; throughput was better:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka#4Riak\\_3d\\_8K\\_edited.jpg
&gt; 
&gt; The memory use looked reasonable as well:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka/#Memory-3d-edited.jpg
&gt; 
&gt; The disk use in this case was:
&gt; 
&gt; http://janevangelista.rajce.idnes.cz/nastenka#DiskSpace.jpg
&gt; 
&gt; The databases were cca 85 GB.
&gt; 
&gt; So the only problem now seems to be how to get rid of the old data. Any hints?
&gt; 
&gt; Thanks, Jan
