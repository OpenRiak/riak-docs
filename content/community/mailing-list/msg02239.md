---
title: "Map Function in Erlang with PBC"
description: ""
project: community
lastmod: 2011-02-09T05:22:38-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02239"
author_name: "Ryan Maclear"
project_section: "mailinglistitem"
sent_date: 2011-02-09T05:22:38-08:00
---


Hi,

I'm not sure if this is a riak or an erlang specific question. I'm guessing 
it's probably an erlang question.

I have the following erlang function in a module, mapreduce\\_play.erl (it's a 
silly skeleton function, but I'm just playing around):

get\\_objects(Server, Port, Bucket, FilterList) -&gt; 
 {ok, Client} = riakc\\_pb\\_socket:start(Server, Port),
 
 Input = {Bucket, [FilterList]},

 MapFun = fun(Object, \\_KeyData, \\_Args) -&gt;
 [Object]
 end,

 MapPhase = {map, {qfun, MapFun}, notused, true},
 Query = [MapPhase],
 riakc\\_pb\\_socket:mapred(Client, Input, Query).


If I copy the function body, line for line into the erlang shell, replacing 
values as I go along, the code works fine, and I get results back correctly.

However, If I call the function, in the same shell, I get the following error:

{error,&lt;&lt;"{error,\\n {error,undef,\\n 
[{#Fun,\\n 
[{r\\_object,&lt;&lt;\\"family\\"&gt;&gt;,&lt;&lt;"...&gt;&gt;}

This is not what I expected to happen. Has this got something to do with the 
nature of the anonymous function, one being defined in the shell and the other 
in a module? I've seen this link:

http://blog.inagist.com/link-map-reduce-in-riak-an-example-from-inagi

Which at the end of the post has the following :

"Of interest is the make\\_local\\_fun which creates a function reference which can 
be passed over to a remote node, without the remote node having a copy of this 
compiled code in its path"

So, why does passing the anonymous function defined in the shell work, but it 
fails when the anonymous function was defined inside a module?

Thanks,
Ryan

