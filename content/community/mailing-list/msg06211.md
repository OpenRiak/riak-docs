---
title: "Re: Adding a new machine to a three node cluster cause partition	handoff problems"
description: ""
project: community
lastmod: 2012-01-10T09:42:07-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06211"
mailinglist_parent_id: "msg06206"
author_name: "Joseph Blomstedt"
project_section: "mailinglistitem"
sent_date: 2012-01-10T09:42:07-08:00
---


Ivaylo,

It appears that handoff is stuck. This should not happen, and I have
filed a bug report to track this issue:
https://issues.basho.com/show\\_bug.cgi?id=1317

I believe I know the cause, and believe it is fixed in master leading
up to our next major release. I'll update the ticket with my findings
after I get a chance to investigate further, so feel free to follow
that ticket and add any additional details if you have them.

Now, to actually fix your cluster, I believe both of the following
options should work.

Option 1:
Restart r...@xxx.xxx.xxx.xxx'. In other words: 'riak stop', followed
by 'riak start'.

Option 2:
Connect to the Erlang console of r...@xxx.xxx.xxx.xxx' and manually
force handoff:
1. Connect to the console: riak attach
2: Copy/paste:
riak\\_core\\_ring\\_manager:force\\_update().
3: Copy/paste:
riak\\_core\\_vnode\\_manager:force\\_handoffs().
4. Exit the console without shutting down Riak: CTRL-D

Let me know if you still have trouble after trying these solutions.

Regards,
Joe

On Tue, Jan 10, 2012 at 9:13 AM, Ivaylo Panitchkov
 wrote:
&gt;
&gt; Hello All,
&gt;
&gt; We have a cluster of three machines (Debian 6.0, 4GB RAM,
&gt; riak\\_1.0.2-1\\_amd64.deb, n\\_val: 3) that serves an application for a while. As
&gt; we go to production soon added a fourth machine to the cluster (exactly the
&gt; same as the first three) yesterday. The partition handoff began in the late
&gt; afternoon and I had an impression that the transition will not take too long
&gt; as there are only few hundred IMPORTANT records in the storage for the
&gt; moment. Today in the morning checked the situation again and realized the
&gt; partition handoff still runs (or get stuck). The Ownership Handoff is still
&gt; the same since yesterday (at least 19 hours till now). Any suggestions to
&gt; fix the problem are welcome :-)
&gt;
&gt; REMARK: Replaced the IP addresses for security sake
&gt;
&gt;
&gt; # riak-admin ringready
&gt; Attempting to restart script through sudo -u riak
&gt; TRUE All nodes agree on the ring
&gt; ['r...@yyy.yyy.yyy.yyy','r...@xxx.xxx.xxx.xxx','r...@aaa.aaa.aaa.aaa','r...@bbb.bbb.bbb.bbb']
&gt;
&gt;
&gt; # riak-admin transfers
&gt; Attempting to restart script through sudo -u riak
&gt; 'r...@bbb.bbb.bbb.bbb' waiting to handoff 2 partitions
&gt; 'r...@aaa.aaa.aaa.aaa' waiting to handoff 2 partitions
&gt; 'r...@yyy.yyy.yyy.yyy' waiting to handoff 2 partitions
&gt;
&gt;
&gt; # riak-admin ring\\_status
&gt; Attempting to restart script through sudo -u riak
&gt; ================================== Claimant
&gt; ===================================
&gt; Claimant: 'r...@xxx.xxx.xxx.xxx'
&gt; Status: up
&gt; Ring Ready: true
&gt;
&gt; ============================== Ownership Handoff
&gt; ==============================
&gt; Owner: r...@xxx.xxx.xxx.xxx
&gt; Next Owner: r...@yyy.yyy.yyy.yyy
&gt;
&gt; Index: 548063113999088594326381812268606132370974703616
&gt; Waiting on: [riak\\_kv\\_vnode]
&gt; Complete: [riak\\_pipe\\_vnode]
&gt;
&gt; Index: 1370157784997721485815954530671515330927436759040
&gt; Waiting on: [riak\\_kv\\_vnode]
&gt; Complete: [riak\\_pipe\\_vnode]
&gt;
&gt; -------------------------------------------------------------------------------
&gt;
&gt; ============================== Unreachable Nodes
&gt; ==============================
&gt; All nodes are up and reachable
&gt;
&gt;
&gt; # riak-admin member\\_status
&gt; Attempting to restart script through sudo -u riak
&gt; ================================= Membership
&gt; ==================================
&gt; Status Ring Pending Node
&gt; -------------------------------------------------------------------------------
&gt; valid 21.9% 25.0% 'r...@yyy.yyy.yyy.yyy'
&gt; valid 28.1% 25.0% 'r...@xxx.xxx.xxx.xxx'
&gt; valid 25.0% 25.0% 'r...@aaa.aaa.aaa.aaa'
&gt; valid 25.0% 25.0% 'r...@bbb.bbb.bbb.bbb'
&gt; -------------------------------------------------------------------------------
&gt; Valid:4 / Leaving:0 / Exiting:0 / Joining:0 / Down:0
&gt;
&gt;
&gt; --
&gt; Ivaylo Panitchkov
&gt; Software developer
&gt; Hibernum Creations Inc.
&gt;
&gt; Ce courriel est confidentiel et peut aussi être protégé par la loi.Si vous
&gt; avez reçu ce courriel par erreur, veuillez nous en aviser immédiatement en y
&gt; répondant, puis supprimer ce message de votre système. Veuillez ne pas le
&gt; copier, l’utiliser pour quelque raison que ce soit ni divulguer son contenu
&gt; à quiconque.
&gt; This email is confidential and may also be legally privileged. If you have
&gt; received this email in error, please notify us immediately by reply email
&gt; and then delete this message from your system. Please do not copy it or use
&gt; it for any purpose or disclose its content.
&gt;
&gt;

-- 
Joseph Blomstedt 
Software Engineer
Basho Technologies, Inc.
http://www.basho.com/

