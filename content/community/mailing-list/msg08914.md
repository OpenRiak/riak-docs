---
title: "Re: Map Reduce and long queries -"
description: ""
project: community
lastmod: 2012-10-15T01:13:53-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08914"
mailinglist_parent_id: "msg08912"
author_name: "Olav Frengstad"
project_section: "mailinglistitem"
sent_date: 2012-10-15T01:13:53-07:00
---


&gt; The word everywhere is to avoid key filters. It effectively does a 
&gt; whole-bucket key-listing, and that starts to get seriously slow out past 100k 
&gt; items. Since you say test queries work I'll presume you've debugged your map 
&gt; and reduce on some queries where you manually add a set of keys. (Right?)

Just as a note, using the Erlang pb client you can use the key filters
for 2i queries if you include the riak\\_kv\\_mapred\\_filters module in
your client code path.

➜ riak-erlang-client git:(master) ✗ erl -pa ebin -pa deps/\\*/ebin -pa
~/src/riak/deps/riak\\_kv/ebin
Erlang R15B01 (erts-5.9.1) [source] [64-bit] [smp:2:2]
[async-threads:0] [hipe] [kernel-poll:false]

Eshell V5.9.1 (abort with ^G)
1&gt; O1 = riakc\\_obj:new(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"abc/def/1"&gt;&gt;, []),
1&gt; O2 = riakc\\_obj:new(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"abc/def/2"&gt;&gt;, []),
1&gt; O3 = riakc\\_obj:new(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"hij/klm/1"&gt;&gt;, []),
1&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),
1&gt; riakc\\_pb\\_socket:put(Pid, O1),riakc\\_pb\\_socket:put(Pid, O2),
riakc\\_pb\\_socket:put(Pid, O3).
ok
2&gt; Index = {index, &lt;&lt;"test"&gt;&gt;, &lt;&lt;"$key"&gt;&gt;, &lt;&lt;0&gt;&gt;, &lt;&lt;255&gt;&gt;},
2&gt; {ok, Filter} = riak\\_kv\\_mapred\\_filters:build\\_filter([[&lt;&lt;"ends\\_with"&gt;&gt;,"1"]]),
2&gt; MR = [
2&gt; { reduce
2&gt; , {qfun, fun(X, F) -&gt; lists:filter(fun({A, B}) -&gt; F(B) end, X) end}
2&gt; , riak\\_kv\\_mapred\\_filters:compose(Filter)
2&gt; , true}],
2&gt; riakc\\_pb\\_socket:mapred(Pid, Index, MR).
{ok,[{0,
 [{&lt;&lt;"test"&gt;&gt;,&lt;&lt;"hij/klm/1"&gt;&gt;},
 {&lt;&lt;"test"&gt;&gt;,&lt;&lt;"abc/def/1"&gt;&gt;}]}]}

Olav

2012/10/14, Adam Lindsay :
- Vis sitert tekst -
&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;

2012/10/14, Adam Lindsay :
&gt; Hi David,
&gt;
&gt; The word everywhere is to avoid key filters. It effectively does a
&gt; whole-bucket key-listing, and that starts to get seriously slow out past
&gt; 100k items. Since you say test queries work I'll presume you've debugged
&gt; your map and reduce on some queries where you manually add a set of keys.
&gt; (Right?)
&gt;
&gt; Since you're on LevelDB, it means you can use secondary indices ("2i") to
&gt; drive these queries.
&gt;
&gt; I don't have access to your filter\\_map, so I don't have access to how you
&gt; construct your keys, but if you have 2i turned on, then you get the first
&gt; key-field "for free" from 2i.
&gt;
&gt; Let's say, hypothetically, that your keys are constructed as:
&gt; keyprefix:::
&gt;
&gt; Well, you can then rewrite the query input as:
&gt;
&gt; def main():
&gt; client = riak.RiakClient(host=riak\\_host,
&gt; port=8087,transport\\_class=riak.transports.pbc.RiakPbcTransport)
&gt; query = client.index(
&gt; bucket,
&gt; '$key',
&gt; 'keyprefix:201210',
&gt; 'keyprefix:201210~')
&gt; query.map('''function(value, keyData, arg) { ... }''')
&gt; …
&gt;
&gt;
&gt;
&gt; That's fine as far as it goes, but it doesn't solve the problem of querying
&gt; country or campaign id, right?
&gt;
&gt; As a temporary measure, I'd suggest trying your key filters, cranking up the
&gt; timeout to something on the order of hours (I gave 5 minutes conservatively
&gt; and arbitrarily), and going ahead and running it for however long it takes.
&gt;
&gt;
&gt; If those queries do give good results, I'd suggest going ahead and
&gt; re-indexing your existing entries with 'country\\_bin' and 'campaign\\_bin'.
&gt; It's up to personal style whether you treat dates as int or bin.
&gt;
&gt; There are lots of tricks and further discussion on how best to get at every
&gt; corner of your data, but how does this strike you so far?
&gt; --
&gt; Adam Lindsay
&gt;
&gt;
&gt; On Sunday, 14 October 2012 at 12:57, David Montgomery wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; Below is my code for running a map reduce in python. I have a six
&gt;&gt; node cluster, 2 cores each with 4 gigs for ram. I am no load and
&gt;&gt; about 3 Mill keys and using leveldb with riak 1.2. Doing the below
&gt;&gt; is taking a terribly long time. Never finished and I dont even know
&gt;&gt; how I can check if it is even running other than the python script has
&gt;&gt; not timed out. I look at the number of executed mappers in stats and
&gt;&gt; it is flat lined when looking at Graphite. On test queries the below
&gt;&gt; works.
&gt;&gt;
&gt;&gt; So..how do I debug what is going on?
&gt;&gt;
&gt;&gt;
&gt;&gt; def main():
&gt;&gt; client =
&gt;&gt; riak.RiakClient(host=riak\\_host,port=8087,transport\\_class=riak.transports.pbc.RiakPbcTransport)
&gt;&gt; query = client.add(bucket)
&gt;&gt; filters = key\\_filter.tokenize(":", filter\\_map['date']) +
&gt;&gt; (key\\_filter.starts\\_with('201210'))
&gt;&gt; #& key\\_filter.tokenize(":", filter\\_map['country']).eq("US") \\
&gt;&gt; #& key\\_filter.tokenize(":", filter\\_map['campaign\\_id']).eq("t1") \\
&gt;&gt; query.add\\_key\\_filters(filters)
&gt;&gt;
&gt;&gt; query.map('''
&gt;&gt; function(value, keyData, arg) {
&gt;&gt; var data = Riak.mapValuesJson(value)[0];
&gt;&gt;
&gt;&gt; if(data['adx']=='gdn'){
&gt;&gt; var alt\\_key = data['hw'];
&gt;&gt; var obj = {};
&gt;&gt; obj[alt\\_key] = 1;
&gt;&gt; return [ obj ];
&gt;&gt; }else{
&gt;&gt; return [];
&gt;&gt; }
&gt;&gt;
&gt;&gt;
&gt;&gt; }''')
&gt;&gt;
&gt;&gt;
&gt;&gt; query.reduce('''
&gt;&gt; function(values, arg){
&gt;&gt; return [ values.reduce( function(acc, item) {
&gt;&gt; for (var state in item) {
&gt;&gt; if (acc[state])
&gt;&gt; acc[state] += item[state];
&gt;&gt; else
&gt;&gt; acc[state] = item[state];
&gt;&gt; }
&gt;&gt; return acc;
&gt;&gt; })];
&gt;&gt; }
&gt;&gt; ''')
&gt;&gt;
&gt;&gt; for result in query.run(timeout=300000):
&gt;&gt; print result
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

