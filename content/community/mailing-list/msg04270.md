---
title: "Re: High cpu usage on store() , small number of keys"
description: ""
project: community
lastmod: 2011-08-08T19:29:59-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04270"
mailinglist_parent_id: "msg04192"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2011-08-08T19:29:59-07:00
---


Tony,

Is it a constant 200% usage? On both nodes in the cluster? My first
thought, since your working with a small key-space, would be conflict
resolution or vclock explosion but you're spacing the writes out by 6s which
seems like more than enough time. Are all 10 writes happening at the same
time concurrently?

I would set your N=2 since you only have two machines, or add a 3rd node.

Perhaps there is some weird behavior in the cache backend, but I would be
surprised if that was it.

-Ryan

On Wed, Aug 3, 2011 at 11:31 AM, Tony Bussieres wrote:

&gt; I'm starting to play with Riak, so far I am very impressed with the
&gt; product.
&gt;
&gt; I want to use Riak as an highly available distributed cache.
&gt;
&gt; I've compiled Erlang R1304 from source (--with-ssl, --enable-smp-support,
&gt; --enable-kernel-poll)
&gt; I've compiled riak-0.14.2 from source
&gt; I use 2 nodes, they are running on two RHEL5 box . (2.6.18.8.el5 #1 SMP).
&gt; They are clustered.
&gt; I use HAProxy to load balance the request on the two nodes.
&gt;
&gt; I have a test bench that plays with 80 keys in one bucket (I use
&gt; riak\\_kv\\_cache\\_backend)
&gt; I use the java client (riak-client 0.14.1 fetched using a maven repo)
&gt;
&gt;
&gt; I have 10 clients that does something like this :
&gt; while(true) {
&gt; Fetch a key from the bucket
&gt; Sleep between 100 and 400ms
&gt; }
&gt;
&gt; I have also 10 servers that updates data in the keys every 6 seconds (80
&gt; keys)
&gt; conceptually they do something like this :
&gt; while (true) {
&gt; Fetch a key from the bucket
&gt; Update the data
&gt; Store the key in the bucket
&gt; Sleep 6000ms
&gt; }
&gt;
&gt; The number of clients have a little impact on the CPU usage of the nodes.
&gt; However when I start 10 servers, the CPU usage goes very high (I saw one of
&gt; the node going up to 200%)
&gt;
&gt; Is there something I should check or do to lower the CPU usage on the
&gt; nodes when I write keys to Riak?
&gt;
&gt; Thanks a lot!
&gt;
&gt; -tony
&gt;

