---
title: "Re: Logical operators in Ripple"
description: ""
project: community
lastmod: 2011-06-06T06:09:23-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03569"
mailinglist_parent_id: "msg03566"
author_name: "Jeremiah Peschka"
project_section: "mailinglistitem"
sent_date: 2011-06-06T06:09:23-07:00
---


Ah, yes, how right you are. I was clearly misremembering my earlier thread 
about key filter syntax and/or mouthwash consumption...

I ran this through the FilterBuilder and got the following for the filter:

[[:and, [[:tokenize, "-", 1], [:ends\\_with, "123"]]]]

Which caused me to remember that an MR job takes an array of 
predicates/transforms.

After a very tiny tweak, this works on my end:

results\\_3 = Riak::MapReduce.new(client).
add("test\\_bucket", [["and", [["tokenize", "-", 1], ["eq", "test"]],
 [["ends\\_with", "123"]]
]]). 
map("Riak.mapValuesJson", :keep =&gt; true).run

The FilterBuilder syntax I used follows, too:

filter { Riak::MapReduce::FilterBuilder.new }
filter.AND do
tokenize "-", 1 do
eq "test"
end

ends\\_with "123"
end 

--- 
Jeremiah Peschka
Founder, Brent Ozar PLF


On Sunday, June 5, 2011 at 9:24 PM, Ryan Caught wrote:

&gt; Not according to the docs. http://wiki.basho.com/Key-Filters.html
&gt; 
&gt; On Sun, Jun 5, 2011 at 8:48 PM, Jeremiah Peschka  (mailto:jeremiah.pesc...@gmail.com)&gt; wrote:
&gt; &gt; Shouldn't that last ends\\_with only be a single nested array, not a doubly 
&gt; &gt; nested array?
&gt; &gt; 
&gt; &gt; --- 
&gt; &gt; Jeremiah Peschka
&gt; &gt; Founder, Brent Ozar PLF
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Sunday, June 5, 2011 at 8:40 PM, Ryan Caught wrote:
&gt; &gt; 
&gt; &gt; &gt; Yeah, I did look at the spec. The first two results work fine, it's only 
&gt; &gt; &gt; the "and" based key filter that throws the error.
&gt; &gt; &gt; 
&gt; &gt; &gt; On Sun, Jun 5, 2011 at 8:30 PM, Jeremiah Peschka 
&gt; &gt; &gt;  wrote:
&gt; &gt; &gt; &gt; When in doubt, I always look at the spec. In this case: 
&gt; &gt; &gt; &gt; https://github.com/seancribbs/ripple/blob/master/riak-client/spec/riak/map\\_reduce/filter\\_builder\\_spec.rb
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; So you'll want to do something roughly like:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; filter { Riak::MapReduce::FilterBuilder.new }
&gt; &gt; &gt; &gt; filter.tokenize "-", "1" do
&gt; &gt; &gt; &gt; eq "test"
&gt; &gt; &gt; &gt; end
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; There's a really good chance that's wrong since I'm only looking at 
&gt; &gt; &gt; &gt; some Ruby in an editor and not testing against a running Riak cluster 
&gt; &gt; &gt; &gt; right now. Hopefully that sets you on the right track or else angries 
&gt; &gt; &gt; &gt; up someone who will correct me. 
&gt; &gt; &gt; &gt; --- 
&gt; &gt; &gt; &gt; Jeremiah Peschka
&gt; &gt; &gt; &gt; Founder, Brent Ozar PLF
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Sunday, June 5, 2011 at 7:46 PM, Ryan Caught wrote:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Hi,
&gt; &gt; &gt; &gt; &gt; I'm having a problem with Ripple and logical operator key filters. 
&gt; &gt; &gt; &gt; &gt; Has anyone managed to get "and" or "or" key filter combinations 
&gt; &gt; &gt; &gt; &gt; working?
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; When I run the following: 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; require 'ripple'
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; client = Riak::Client.new
&gt; &gt; &gt; &gt; &gt; bucket = client.bucket("test\\_bucket")
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; one = Riak::RObject.new(bucket, "test-123") 
&gt; &gt; &gt; &gt; &gt; one.content\\_type = "application/json"
&gt; &gt; &gt; &gt; &gt; one.data = '{"name": "test-123"}'
&gt; &gt; &gt; &gt; &gt; one.store
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; two = Riak::RObject.new(bucket, "test-456") 
&gt; &gt; &gt; &gt; &gt; two.content\\_type = "application/json"
&gt; &gt; &gt; &gt; &gt; two.data = '{"name": "test-456"}'
&gt; &gt; &gt; &gt; &gt; two.store
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; results\\_1 = Riak::MapReduce.new(client). 
&gt; &gt; &gt; &gt; &gt; add("visitors", [["tokenize", "-", 1], ["eq", "test"]]).
&gt; &gt; &gt; &gt; &gt; map("Riak.mapValuesJson", :keep =&gt; true).run
&gt; &gt; &gt; &gt; &gt; # Works as expected
&gt; &gt; &gt; &gt; &gt; p results\\_1
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; results\\_2 = Riak::MapReduce.new(client).
&gt; &gt; &gt; &gt; &gt; add("visitors", [["ends\\_with", "123"]]).
&gt; &gt; &gt; &gt; &gt; map("Riak.mapValuesJson", :keep =&gt; true).run
&gt; &gt; &gt; &gt; &gt; # Works as expected
&gt; &gt; &gt; &gt; &gt; p results\\_2
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; results\\_3 = Riak::MapReduce.new(client).
&gt; &gt; &gt; &gt; &gt; add("test\\_bucket", ["and", [["tokenize", "-", 1], ["eq", "test"]],
&gt; &gt; &gt; &gt; &gt; [["ends\\_with", "123"]]
&gt; &gt; &gt; &gt; &gt; ]). 
&gt; &gt; &gt; &gt; &gt; map("Riak.mapValuesJson", :keep =&gt; true).run
&gt; &gt; &gt; &gt; &gt; # Error
&gt; &gt; &gt; &gt; &gt; p results\\_3
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; This is what the error report says:
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; =ERROR REPORT==== 5-Jun-2011::19:42:34 ===
&gt; &gt; &gt; &gt; &gt; webmachine error: path="/mapred"
&gt; &gt; &gt; &gt; &gt; {error,{error,function\\_clause,
&gt; &gt; &gt; &gt; &gt; [{riak\\_client,build\\_exprs,
&gt; &gt; &gt; &gt; &gt; [[&lt;&lt;"and"&gt;&gt;,
&gt; &gt; &gt; &gt; &gt; [[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;"-"&gt;&gt;,1],
&gt; &gt; &gt; &gt; &gt; [&lt;&lt;"eq"&gt;&gt;,&lt;&lt;"test"&gt;&gt;]],
&gt; &gt; &gt; &gt; &gt; [[&lt;&lt;"ends\\_with"&gt;&gt;,&lt;&lt;"123"&gt;&gt;]]],
&gt; &gt; &gt; &gt; &gt; [],
&gt; &gt; &gt; &gt; &gt; {riak\\_client,'riak@127.0.0.1 
&gt; &gt; &gt; &gt; &gt; (mailto:riak@127.0.0.1)',&lt;&lt;6,82,5,153&gt;&gt;}]},
&gt; &gt; &gt; &gt; &gt; {riak\\_client,build\\_filter,2},
&gt; &gt; &gt; &gt; &gt; {riak\\_client,stream\\_list\\_keys,6},
&gt; &gt; &gt; &gt; &gt; {riak\\_client,mapred\\_bucket\\_stream,7},
&gt; &gt; &gt; &gt; &gt; {riak\\_client,mapred\\_bucket,6},
&gt; &gt; &gt; &gt; &gt; {riak\\_kv\\_wm\\_mapred,process\\_post,2},
&gt; &gt; &gt; &gt; &gt; {webmachine\\_resource,resource\\_call,3},
&gt; &gt; &gt; &gt; &gt; {webmachine\\_resource,do,3}]}}
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Any ideas? 
&gt; &gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; &gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; 
&gt; 

