---
title: "Re: Handoff stalled on 1.0.2 riak cluster"
description: ""
project: community
lastmod: 2012-06-04T00:11:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07602"
mailinglist_parent_id: "msg07599"
author_name: "John Axel Eriksson"
project_section: "mailinglistitem"
sent_date: 2012-06-04T00:11:04-07:00
---


Thanks Mark,

I think I've pinpointed the problem. When our cluster died because one node
became unresponsive we saw the rest of our cluster go down. The nodes
started crashing and did so even when restarted after about a minute
(something about neighbours crashed in the logs).

So in a panic I disabled riak search since we don't use it and I think I
saw some mention of it in the logs. Anyway, after a few hours we got things
running again, unfortunately we're not entirely sure - it might have been
running out of file descriptors. I then added a new node which never got
any data and the handoff was stalled. Nothing worked to get it to
"unstall"... until I remembered that I disabled riak search. As soon as I
enabled that again the cluster started behaving as expected. Exactly why
that was I don't know.

Also, how stable/unstable would you say Luwak is? We're depending heavily
on it, we know it's not supported anymore and we haven't yet found a good
replacement? Should we be worried about our data? We've got maybe 700-800
GB in the cluster, large files from 2MB to 700-800MB.

Best,
John

On Mon, Jun 4, 2012 at 4:43 AM, Mark Phillips  wrote:

&gt; Hi John,
&gt;
&gt; Assuming things aren't back to normal... A few things:
&gt;
&gt; Attach to any running node and run this:
&gt;
&gt; rpc:multicall([node() | nodes()], riak\\_core\\_vnode\\_manager, force\\_handoffs, 
&gt; []).
&gt;
&gt; This will attempt to force handoff. If this restarts handoff, you've got new 
&gt; issue that we'll need to track down. Please report back if this gets handoffs 
&gt; running again .
&gt;
&gt; Another possible fix:
&gt;
&gt; Take a look at https://github.com/basho/riak\\_core/pull/153
&gt;
&gt; This was fixed on 1.1, but it might be what's hitting you (though, 
&gt; admittedly, your issue does seem like a perfect match for the issue from the 
&gt; 1.0.2 release notes).
&gt;
&gt; If this is what's ailing you, there's a work-around here:
&gt; https://github.com/basho/riak\\_core/pull/153#issuecomment-4527706
&gt;
&gt; If neither of these work, let us know and we'll take a deeper look. 
&gt; Specifically:
&gt;
&gt; a) any log files you could send along would be helpful
&gt; b) the output of the following diagnostic:
&gt;
&gt; f(Members).
&gt; Members = riak\\_core\\_ring:all\\_members(element(2, 
&gt; riak\\_core\\_ring\\_manager:get\\_raw\\_ring())).
&gt; [{N, rpc:call(N, riak\\_core\\_handoff\\_manager, status, [])} || N &lt;- Members].
&gt;
&gt; Thanks, John.
&gt;
&gt; Mark
&gt;
&gt;
&gt;
&gt; On Sun, Jun 3, 2012 at 5:06 AM, John Axel Eriksson  wrote:
&gt;
&gt;&gt; Hi.
&gt;&gt;
&gt;&gt; We had an issue where one of the riak servers died (had to be force
&gt;&gt; removed from cluster). After we did that things got really bad and most
&gt;&gt; data was unreachable for hours. I added a new node to replace the old one
&gt;&gt; at one point as well - that never got any data and even now about a day
&gt;&gt; later it hasn't gotten any data.
&gt;&gt; What seems to be the issue now is that there are a few nodes are waiting
&gt;&gt; on handoff of 1 partition. When I look at ring\\_status I see this:
&gt;&gt;
&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt; ================================== Claimant
&gt;&gt; ===================================
&gt;&gt; Claimant: 'riak@r-001.x.x.x
&gt;&gt; Status: up
&gt;&gt; Ring Ready: true
&gt;&gt;
&gt;&gt; ============================== Ownership Handoff
&gt;&gt; ==============================
&gt;&gt; Owner: riak@r-004.x.x.x
&gt;&gt; Next Owner: riak@r-003.x.x.x
&gt;&gt;
&gt;&gt; Index: 930565495644285842450002452081070828921550798848
&gt;&gt; Waiting on: []
&gt;&gt; Complete: [riak\\_kv\\_vnode,riak\\_pipe\\_vnode,riak\\_search\\_vnode]
&gt;&gt;
&gt;&gt;
&gt;&gt; -------------------------------------------------------------------------------
&gt;&gt;
&gt;&gt; ============================== Unreachable Nodes
&gt;&gt; ==============================
&gt;&gt; All nodes are up and reachable
&gt;&gt;
&gt;&gt;
&gt;&gt; Ok, so it looks like the problem described in the Release Notes for 1.0.2
&gt;&gt; here https://github.com/basho/riak/blob/1.0.2-release/RELEASE-NOTES.org.
&gt;&gt; Unfortunately I've run that code (through riak attach) with no result.
&gt;&gt;
&gt;&gt; It's been in this state for 12 hours now I think. What can we do to fix
&gt;&gt; our cluster?
&gt;&gt;
&gt;&gt; I upgraded to 1.0.3 hoping it would fix our problems but that didn't
&gt;&gt; help. I cannot upgrade to 1.1.x because we mainly use Luwak for large
&gt;&gt; object support
&gt;&gt; and that's discontinued in 1.1.x as far as I know.
&gt;&gt;
&gt;&gt; Thanks for your help,
&gt;&gt; John
&gt;
