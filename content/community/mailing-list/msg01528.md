---
title: "Re: Understanding Riaks rebalancing and handoff behaviour"
description: ""
project: community
lastmod: 2010-11-12T06:58:12-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01528"
mailinglist_parent_id: "msg01527"
author_name: "Nico Meyer"
project_section: "mailinglistitem"
sent_date: 2010-11-12T06:58:12-08:00
---


Am Freitag, den 12.11.2010, 08:43 +0100 schrieb Sven Riedel:
&gt; &gt; 
&gt; &gt; It's not a problem right away. But since the replicated data is not
&gt; &gt; actively synchronized in the background the keys that were not copied
&gt; &gt; until the node dies have one less replica. That is until they are read
&gt; &gt; at least once, at which point read repair does replicate the key again.
&gt; &gt; So it depends on your setup and requirements, if this is acceptable or
&gt; &gt; not.
&gt; 
&gt; So if the relevant data isn't read in a while and two more nodes go down 
&gt; (with 
&gt; an n\\_val of 3), there is a chance that some data is lost.
&gt; 

Correct. This might be highly unlikely though.

&gt; &gt; 
&gt; &gt;&gt; 
&gt; &gt;&gt; So this still leaves me with some of my original questions open:
&gt; &gt;&gt;&gt;&gt; 
&gt; &gt;&gt;&gt;&gt; 1. What would normally trigger a rebalancing of the nodes? 
&gt; &gt;&gt;&gt;&gt; 2. Is there a way to manually trigger a rebalancing?
&gt; &gt;&gt;&gt;&gt; 3. Did I do anything wrong with the procedure described above to
&gt; &gt;&gt;&gt;&gt; be left in the current odd state by riak?
&gt; &gt;&gt; 
&gt; &gt; 
&gt; &gt; Every vnode, which is responsible for one partition, checks after 60
&gt; &gt; seconds of inactivity if its is residing one the node where it should
&gt; &gt; be, according to the ring state. If not, the data is send to the correct
&gt; &gt; node. So the rebalancing of data is triggered by rebalancing the
&gt; &gt; partitions among the nodes in the ring.
&gt; &gt; The ring is balanced during the gossiping of the ring state, which is
&gt; &gt; done by every node with another random node at every 0-60 (also
&gt; &gt; randomly) seconds.
&gt; &gt; In the worst case it could take some minutes before the ring stabilizes,
&gt; &gt; but its statistically likely to converge faster.
&gt; 
&gt; Ah, if the partition ownership changes, the data should get relocated 
&gt; straight away.
&gt; I had gossip put down only for immediate topology changes (which worked fine 
&gt; in my case, it just never got around to redistributing the data).
&gt; 
&gt; &gt; 
&gt; &gt; So there's is nothing to trigger manually really. One problem I see has
&gt; &gt; to do again with restarting a node, which still has data that should be
&gt; &gt; handed off to another node. Initially only the vnodes that are owned by
&gt; &gt; a node started, which by definition don't include the ones to be handed
&gt; &gt; off. But if the vnodes are never started, they won't perform the
&gt; &gt; handoff.
&gt; 
&gt; This sounds less confidence inspiring. On the off-chance that the node (or 
&gt; hardware) crashes between telling a node to leave the ring and the data 
&gt; handoff having been completed, you'll have more work on your hands than just 
&gt; restarting the node, and you have to know about this as well. This isn't a 
&gt; scenario that will happen often, but from the point of view of someone who 
&gt; wants the least amount of manual intervention when something goes wrong, I'd 
&gt; prefer resilience over performance.
&gt; 
As I mentioned in my next paragraph (not very clearly I must confess)
the handoff would eventually start, if not for the node watcher problem
I also mentioned in my first post. Scott Lystig Fritchie created a bug
report for this (https://issues.basho.com/show\\_bug.cgi?id=878). But this
problem only exists for nodes that are to be removed.
Other nodes might also need to handoff data, if some of their partitions
should be moved to another node. This happens also if you add a node.

The handoffs will eventually start, but it will take longer then normal.
At the start of the node and at every ring update a random vnode for a
parition not owned by the node is started, which might be empty, and
performs a handoff, which consequently might not have to do anything.
When the handoff finishes another random vnode is started (could be the
same vnode though).

Effectively all partitions in the ring are eventually tested, one after
another, and transferred if necessary. But how long it will take to
transfer all partitions is somewhat unpredictable because of the random
part. Also, only one at a time will be transferred, which might take
longer than usual.


&gt; &gt; It kind of works anyway, but the vnodes are started and transfered
&gt; &gt; sequentially. Normally four partitions are transferred in parallel, so I
&gt; &gt; don't know if this is by design or by accident. The details are
&gt; &gt; convoluted enough to suspect the latter.
&gt; &gt; In any case this would also make also have the effect that those
&gt; &gt; partitions won't show up in the output of riak-admin transfers, since
&gt; &gt; only running vnodes are considered.
&gt; 
&gt; From what I saw in my case the number of handoffs were displayed correctly in 
&gt; the beginning, however the numbers didn't decrease (or change at all) as data 
&gt; got handed around.
&gt; 

If the node is not restarted, all vnodes are still running, so the
number would be correct. Most likely no handoffs were being done
anymore, because four of them crashed and the locks are not cleared in
this case. By default only four handoffs are allowed at the same time.
Have you looked in for the error messages I mentioned in your logs?

&gt; &gt; 
&gt; &gt; I also forgot, that I patched another problem in my own version of riak,
&gt; &gt; which will prevent any further handoff of data after four of them failed
&gt; &gt; with an error or timeout. This probably happened in your case, if your A
&gt; &gt; nodes became unresponsive for 30 minutes (did the machine swap by the
&gt; &gt; way?).
&gt; 
&gt; A was up and responsive the entire time. No swapping; the machines don't have 
&gt; any swap space configured. However, they were rather weak in the IO 
&gt; department, so the load did rise to 10 and above on bulk inserts, and to 
&gt; around 6 during the handoffs IIRC (on a two core machine). One of the reasons 
&gt; I wanted to check things out on instances with more IO performance.
&gt; 

You wrote riak-admin status said the nodes were down, thats what I
meant. It means at least that the Erlang VM was unresponsive.

&gt; &gt; I should probably create a bug report for this, with my patch attached.
&gt; &gt; Stupid laziness!
&gt; &gt; 
&gt; &gt; After reading your original post again, I think almost all of the things
&gt; &gt; you saw can be explained by the bug that I mentioned in my first answer
&gt; &gt; (the ring status of removed nodes is not synchronized with the remaining
&gt; &gt; nodes). The problem obviously becomes worse if you remove several nodes
&gt; &gt; at a time.
&gt; 
&gt; Which means that I shouldn't just wait for riak-admin ringready to return 
&gt; TRUE, but for the data handoffs to have completed as well before changing the 
&gt; network topology again?
&gt; 

Yes. By using e.g. 'df' or listing the directories in your bitcask dir,
which should be empty if everything went well.
But with the two bugs that are still present it might never finish.
The workaround for this is quite involved at the moment.
I will try to create bug reports in the next few days.

&gt; Thanks for your answers, they have been enlightening.
&gt; 
&gt; Regards,
&gt; Sven
&gt; 
&gt; ------------------------------------------
&gt; Scoreloop AG, Brecherspitzstrasse 8, 81541 Munich, Germany, www.scoreloop.com
&gt; sven.rie...@scoreloop.com
&gt; 
&gt; Sitz der Gesellschaft: München, Registergericht: Amtsgericht München, HRB 
&gt; 174805 
&gt; Vorstand: Dr. Marc Gumpinger (Vorsitzender), Dominik Westner, Christian van 
&gt; der Leeden, Vorsitzender des Aufsichtsrates: Olaf Jacobi 
&gt; 

