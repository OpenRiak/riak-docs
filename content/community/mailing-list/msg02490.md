---
title: "Re: riaksearch sort, start, and rows"
description: ""
project: community
lastmod: 2011-02-28T08:41:40-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02490"
mailinglist_parent_id: "msg02489"
author_name: "Gary William Flake"
project_section: "mailinglistitem"
sent_date: 2011-02-28T08:41:40-08:00
---


FWIW, here's my workaround written for riak-js:

done = false;
db.addSearch('clips', q, opts)
 .map('Riak.mapValuesJson')
 .reduce('Riak.reduceSort', 'function(a,b){return a.ctime-b.ctime;}')
 .reduce('Riak.reduceSlice', [start,rows])
 .run(function(err, x) {
for (var i = 0, n = x.length; i &lt; n; i++) {
 console.log(i, x[i].title);
}
done = true;
 })




On Mon, Feb 28, 2011 at 5:35 AM, Rusty Klophaus  wrote:

&gt; Hi Gary,
&gt;
&gt; Yes, unfortunately, this is a bug. (Tracked here:
&gt; https://issues.basho.com/show\\_bug.cgi?id=867) We have not yet scheduled
&gt; the fix for this.
&gt;
&gt; Best,
&gt; Rusty
&gt;
&gt;
&gt; On Mon, Feb 28, 2011 at 1:25 AM, Gary William Flake wrote:
&gt;
&gt;&gt; Ack. I know what's happening with this. Riaksearch is sorting by
&gt;&gt; relevance, segmenting the results according to start and rows, and THEN
&gt;&gt; sorting by the sort key.
&gt;&gt;
&gt;&gt; Is this the intended behavior? If so, I am kind of surprised because the
&gt;&gt; post sort is easy for the caller to do without Riaksearch's help. What's
&gt;&gt; hard is the pre-sort.
&gt;&gt;
&gt;&gt; I suppose the work around is to get all of the results, then send the
&gt;&gt; result to map/reduce to correctly handle pre-sort, then filter by range.
&gt;&gt; However, before I do this, does anyone know if (a) this is considered
&gt;&gt; broken? and (b) if so, is this scheduled to be fixed?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; -- GWF
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Sun, Feb 27, 2011 at 10:17 PM, Gary William Flake wrote:
&gt;&gt;
&gt;&gt;&gt; While coding up a front-end to paginate over a set of search results, I
&gt;&gt;&gt; think I found a bug whereby the result set is incorrectly segmented as a
&gt;&gt;&gt; function of the sort key, the start index, and the row count. In the output
&gt;&gt;&gt; that follows, I am using the field ctime for sort order, and the value of
&gt;&gt;&gt; delta is simply the difference between subsequent ctime values (which I was
&gt;&gt;&gt; checking in order to debug what was happening).
&gt;&gt;&gt;
&gt;&gt;&gt; First, lets ask for just the first result:
&gt;&gt;&gt;
&gt;&gt;&gt; GET
&gt;&gt;&gt;&gt; /solr/clips/select?q=user%3Ad33af3cca29a43e63e8f6a52dfdd99a61f7b7906%20AND%20private%3A1&start=0&rows=1&wt=json&sort=ctime
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; title: weather flagler beach - Google Search
&gt;&gt;&gt;
&gt;&gt;&gt; ctime: 98701733411258
&gt;&gt;&gt;
&gt;&gt;&gt; delta: 0
&gt;&gt;&gt;
&gt;&gt;&gt; ----------
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Now, let's do the same query, but get the top three instead:
&gt;&gt;&gt;
&gt;&gt;&gt; GET
&gt;&gt;&gt;&gt; /solr/clips/select?q=user%3Ad33af3cca29a43e63e8f6a52dfdd99a61f7b7906%20AND%20private%3A1&start=0&rows=3&wt=json&sort=ctime
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; title: Amazon.com: knives
&gt;&gt;&gt;
&gt;&gt;&gt; ctime: 98701733349673
&gt;&gt;&gt;
&gt;&gt;&gt; delta: 0
&gt;&gt;&gt;
&gt;&gt;&gt; ----------
&gt;&gt;&gt;
&gt;&gt;&gt; title: weather flagler beach - Google Search
&gt;&gt;&gt;
&gt;&gt;&gt; ctime: 98701733411258
&gt;&gt;&gt;
&gt;&gt;&gt; delta: 61585
&gt;&gt;&gt;
&gt;&gt;&gt; ----------
&gt;&gt;&gt;
&gt;&gt;&gt; title: Bartholdi on spacefilling curves
&gt;&gt;&gt;
&gt;&gt;&gt; ctime: 98701733465867
&gt;&gt;&gt;
&gt;&gt;&gt; delta: 54609
&gt;&gt;&gt;
&gt;&gt;&gt; ----------
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Notice that we have a new 'top' result. Finally, let's get all of the
&gt;&gt;&gt; results by setting row to something large, but I'll only show the first
&gt;&gt;&gt; result because that's all you need to see:
&gt;&gt;&gt;
&gt;&gt;&gt; GET
&gt;&gt;&gt;&gt; /solr/clips/select?q=user%3Ad33af3cca29a43e63e8f6a52dfdd99a61f7b7906%20AND%20private%3A1&start=0&rows=1000&wt=json&sort=ctime
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; title: HTTP cookie - Wikipedia, the free encyclopedia
&gt;&gt;&gt;
&gt;&gt;&gt; ctime: 98701587317266
&gt;&gt;&gt;
&gt;&gt;&gt; delta: 0
&gt;&gt;&gt;
&gt;&gt;&gt; ----------
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; We now get a record that we haven't seen yet.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; I can confirm that when I get all of the results, they are in the
&gt;&gt;&gt; properly sorted order. I also believe that any of my smaller result sets
&gt;&gt;&gt; are also in proper sort order. However, it also appears that when I ask for
&gt;&gt;&gt; a specific number of row with a non-zero start start value, then the start
&gt;&gt;&gt; index is not handled correctly. FWIW, these results don't' have anything to
&gt;&gt;&gt; do with the client library because I reproduced them over the REST
&gt;&gt;&gt; interface.
&gt;&gt;&gt;
&gt;&gt;&gt; Any ideas?
&gt;&gt;&gt;
&gt;&gt;&gt; -- GWF
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

