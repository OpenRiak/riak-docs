---
title: "Re: Inconsistent map/reduce results"
description: ""
project: community
lastmod: 2011-03-31T13:18:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02815"
mailinglist_parent_id: "msg02812"
author_name: "Matthew Heitzenroder"
project_section: "mailinglistitem"
sent_date: 2011-03-31T13:18:26-07:00
---


setting the map\\_cache\\_size to 0 is workaround for bug
969.
If map\\_cache\\_size=0 alleviates the issue, then upgrading to 0.14.1 should
resolve the issue with the MapReduce cache.

On Thu, Mar 31, 2011 at 12:20 PM, Dan Reverri  wrote:

&gt; Hi Keith,
&gt;
&gt; The cache entry parameter name changed in 0.14 to "map\\_cache\\_size". Setting
&gt; this parameter to 0 will disable the cache.
&gt;
&gt; Regarding the empty MapReduce results, I'll try to reproduce the issue
&gt; locally and narrow down the cause.
&gt;
&gt; Thanks,
&gt; Dan
&gt;
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt;
&gt; On Tue, Mar 29, 2011 at 6:16 PM, Keith Dreibelbis wrote:
&gt;
&gt;&gt; Followup to this (somewhat old) thread...
&gt;&gt;
&gt;&gt; I had resolved my problem by putting the vnode\\_cache\\_entries=0 thing in
&gt;&gt; app.config, doing what Grant said. But sometime later it began failing
&gt;&gt; again. I was getting misses of 25%-50% on records that should have been
&gt;&gt; found by map reduce but weren't. At that point I tried Rohman's suggestion
&gt;&gt; of using a random seed, and that worked around the problem successfully.
&gt;&gt; But this isn't a very satisfying fix.
&gt;&gt;
&gt;&gt; So the vnode\\_cache\\_entries=0 thing doesn't really fix it after all? Is
&gt;&gt; there something else to put in the config that would make this work
&gt;&gt; properly, without the random seed hack? BTW since the original thread I
&gt;&gt; have upgraded from 0.13 to 0.14, and the bug is still there.
&gt;&gt;
&gt;&gt;
&gt;&gt; Keith
&gt;&gt;
&gt;&gt;
&gt;&gt; On Thu, Mar 10, 2011 at 6:56 PM, Antonio Rohman Fernandez &lt;
&gt;&gt; roh...@mahalostudio.com&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; if you want to avoid caching ( without configuration ), you can put some
&gt;&gt;&gt; random variable in your map or reduce or both... that does the trick for me
&gt;&gt;&gt; as the query will be always different:
&gt;&gt;&gt;
&gt;&gt;&gt; $seed = randomStringHere;
&gt;&gt;&gt;
&gt;&gt;&gt; {"map":{"language":"javascript","source":"function(v,k,a) {
&gt;&gt;&gt; seed='.$seed.'; x=Riak.mapValuesJson(v)[0]; return [v.values[0].data]; }"}
&gt;&gt;&gt;
&gt;&gt;&gt; Rohman
&gt;&gt;&gt;
&gt;&gt;&gt; On Thu, 10 Mar 2011 17:47:49 -0800, Keith Dreibelbis 
&gt;&gt;&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for the prompt response, Grant. I made the configuration change
&gt;&gt;&gt; you suggested, and it fixed my problem.
&gt;&gt;&gt; Some followup questions:
&gt;&gt;&gt; - is it possible to configure this dynamically on a per-bucket basis,
&gt;&gt;&gt; or just per-server like it is now?
&gt;&gt;&gt; - is this fixed in a newer version?
&gt;&gt;&gt;
&gt;&gt;&gt; On Thu, Mar 10, 2011 at 2:56 PM, Grant Schofield wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; There are currently some bugs in the mapreduce caching system. The best
&gt;&gt;&gt;&gt; thing to do would be to disable the feature, on 0.13 you can do this by
&gt;&gt;&gt;&gt; editing or adding the vnode\\_cache\\_entries to the riak\\_kv section of
&gt;&gt;&gt;&gt; your app.config. The entry would look like:
&gt;&gt;&gt;&gt; {vnode\\_cache\\_entries, 0},
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Grant Schofield
&gt;&gt;&gt;&gt; Developer Advocate
&gt;&gt;&gt;&gt; Basho Technologies
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Mar 10, 2011, at 4:16 PM, Keith Dreibelbis wrote:
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi riak-users,
&gt;&gt;&gt;&gt; I'm trying to do a map/reduce query from java on a 0.13 server, and get
&gt;&gt;&gt;&gt; inconsistent results. What I'm doing should be pretty simple. I'm hoping
&gt;&gt;&gt;&gt; someone will notice an obvious error in here, or have some insight:
&gt;&gt;&gt;&gt; This is an automated test. I'm doing a simple query where I'm trying
&gt;&gt;&gt;&gt; to get the keys for records with a certain field value. In SQL it would
&gt;&gt;&gt;&gt; look like "SELECT id FROM table WHERE age = '32'". In java I'm invoking it
&gt;&gt;&gt;&gt; like this:
&gt;&gt;&gt;&gt; MapReduceResponse r = riak.mapReduceOverBucket(getBucket())
&gt;&gt;&gt;&gt; .map(JavascriptFunction.anon(func), true)
&gt;&gt;&gt;&gt; .submit();
&gt;&gt;&gt;&gt; where riak is a RiakClient, getBucket() returns the name of the
&gt;&gt;&gt;&gt; bucket, and func is a string that looks like:
&gt;&gt;&gt;&gt; function(value, keyData, arg) {
&gt;&gt;&gt;&gt; var data = Riak.mapValuesJson(value)[0];
&gt;&gt;&gt;&gt; if(data.age == "32")
&gt;&gt;&gt;&gt; return [value.key];
&gt;&gt;&gt;&gt; else
&gt;&gt;&gt;&gt; return [];
&gt;&gt;&gt;&gt; }
&gt;&gt;&gt;&gt; No reduce phase. All entries in the example bucket are json and have
&gt;&gt;&gt;&gt; an age field. This initially works correctly, it gets back the matching
&gt;&gt;&gt;&gt; records as expected. It also works in curl. It's an automated test, so
&gt;&gt;&gt;&gt; each time I run this, it is using a different bucket. After about a dozen
&gt;&gt;&gt;&gt; queries, this starts to fail. It returns an empty result, when it should
&gt;&gt;&gt;&gt; have found records. It fails in curl at the same time.
&gt;&gt;&gt;&gt; I initially suspected this might have something to do with doing map
&gt;&gt;&gt;&gt; reduce too soon after writing, and the write not being available on all
&gt;&gt;&gt;&gt; nodes. However, I changed the bucket schema entries for w,r,rw,dw from
&gt;&gt;&gt;&gt; "quorum" to "all", and this still happens (is there another bucket setting 
&gt;&gt;&gt;&gt; I
&gt;&gt;&gt;&gt; missed?). In addition, I only have 3 nodes (I'm using the dev123 example),
&gt;&gt;&gt;&gt; and am running curl long enough afterwards.
&gt;&gt;&gt;&gt; Here's the strange part that makes me suspicious. If I make
&gt;&gt;&gt;&gt; insignificant changes to the query, for example change the double quotes to
&gt;&gt;&gt;&gt; single quotes, add whitespace or extra parentheses, etc, then it suddenly
&gt;&gt;&gt;&gt; works again. It will work on an existing bucket, and on subsequent tests,
&gt;&gt;&gt;&gt; but again only about a dozen times before it starts failing again. Same
&gt;&gt;&gt;&gt; behavior in curl. This makes me suspect that the server is doing some
&gt;&gt;&gt;&gt; incorrect caching around this js function, based on the function string.
&gt;&gt;&gt;&gt; Any explanation about what's going on?
&gt;&gt;&gt;&gt; Keith
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; [image: line][image: logo] 
&gt;&gt;&gt; \\*Antonio Rohman Fernandez\\*
&gt;&gt;&gt; CEO, Founder & Lead Engineer
&gt;&gt;&gt;
&gt;&gt;&gt; roh...@mahalostudio.com
&gt;&gt;&gt; \\*Projects\\*
&gt;&gt;&gt; MaruBatsu.es 
&gt;&gt;&gt;
&gt;&gt;&gt; PupCloud.com 
&gt;&gt;&gt; Wedding Album 
&gt;&gt;&gt; [image: line]
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

