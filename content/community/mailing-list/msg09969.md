---
title: "Re: about hash calculation in reference page at docs.basho.com"
description: ""
project: community
lastmod: 2013-02-03T08:17:35-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09969"
mailinglist_parent_id: "msg09912"
author_name: "Donald Yan"
project_section: "mailinglistitem"
sent_date: 2013-02-03T08:17:35-08:00
---


very clear explanation, Charlie. Thanks again! nice weekend.

-donald

On Tue, Jan 29, 2013 at 1:26 PM, Charlie Voiselle wrote:

&gt; Donald:
&gt;
&gt; Since the list of partitions can easily be segmented using a filter on 
&gt; partition values
&gt; that are greater than the hashed value, it makes for a simple determination 
&gt; of the ordered
&gt; preflist.
&gt;
&gt; For Example: Hash = 1045375627425331784151332358177649483819648417632
&gt;
&gt; Parition | P &gt; H | List |
&gt; ----------------------------------------------------+-------+-------+
&gt; 0 | False | B |
&gt; 182687704666362864775460604089535377456991567872 | False | B |
&gt; 365375409332725729550921208179070754913983135744 | False | B |
&gt; 548063113999088594326381812268606132370974703616 | False | B |
&gt; 730750818665451459101842416358141509827966271488 | False | B |
&gt; 913438523331814323877303020447676887284957839360 | False | B |
&gt; 1096126227998177188652763624537212264741949407232 | True | A |
&gt; 1278813932664540053428224228626747642198940975104 | True | A |
&gt; ----------------------------------------------------+-------+-------+
&gt;
&gt; Then so long as order is maintained, your sorted preflist is simply A ++ B.
&gt;
&gt; It would be a (if only slightly) more complex algorithm, requiring 
&gt; determination by
&gt; lookahead if you were in the correct partition, in order to have the 
&gt; partitions names be
&gt; starting values.
&gt;
&gt; To answer your second question, the partitions are named by dividing the 
&gt; integer keyspace
&gt; by the num partitions to create an incrementor[1]. This incrementor is used 
&gt; as the
&gt; stepping factor in a sequence from 0 to RINGTOP value -- 
&gt; `trunc(math:pow(2,160)-1)`.
&gt;
&gt; You can call these functions yourself in the `riak attach` as follows:
&gt;
&gt; (dev1@127.0.0.1)1&gt; Inc = chash:ring\\_increment(8).
&gt; 182687704666362864775460604089535377456991567872
&gt;
&gt; (dev1@127.0.0.1)2&gt; [{IndexAsInt} || IndexAsInt &lt;-lists:seq(0,( trunc( 
&gt; math:pow(2,160) -1)
&gt; -1),Inc)].
&gt; [{0},
&gt; {182687704666362864775460604089535377456991567872},
&gt; {365375409332725729550921208179070754913983135744},
&gt; {548063113999088594326381812268606132370974703616},
&gt; {730750818665451459101842416358141509827966271488},
&gt; {913438523331814323877303020447676887284957839360},
&gt; {1096126227998177188652763624537212264741949407232},
&gt; {1278813932664540053428224228626747642198940975104}]}
&gt;
&gt;
&gt;
&gt; Hope this helps!
&gt;
&gt; Charlie Voiselle
&gt;
&gt;
&gt; ---
&gt; [0] https://github.com/basho/riak\\_core/blob/master/src/chash.erl#L88
&gt; [1] https://github.com/basho/riak\\_core/blob/master/src/chash.erl#L162
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; On Jan 29, 2013, at 9:47 AM, Donald Yan  wrote:
&gt;
&gt; Hi Charlie,
&gt;
&gt; That really helps to clear the confusion. Thanks again!
&gt;
&gt; Then it comes to the next question :-) Just curious to know: is there a
&gt; special reason why using the end value as the partition's name? Normally,
&gt; most people I think would pick the beginning value as the partition's name
&gt; in common logic.
&gt;
&gt; And a second question related to the above question is how this end value
&gt; is picked: partition named "0" is actually ending with number 0, and so
&gt; forth for the other partitions. This is like the 160-bit space got
&gt; right-shifted one number relative to 0-started numbering system. Is there
&gt; a special reason for it in Riak, or simply want to use 1-started numbering
&gt; system.
&gt;
&gt;
&gt; wr, donald
&gt;
&gt; On Mon, Jan 28, 2013 at 3:21 PM, Charlie Voiselle wrote:
&gt;
&gt;&gt; Donald:
&gt;&gt;
&gt;&gt; Since we are traversing the ring in a clockwise fashion, the data is
&gt;&gt; written into the next partition you would run into moving forward. You can
&gt;&gt; see how the partitions are chosen in\\* \\*chash:ordered\\_from/2 at
&gt;&gt; https://github.com/basho/riak\\_core/blob/master/src/chash.erl#L138. The
&gt;&gt; preference list is built using the partitions that come after the hashed
&gt;&gt; value.
&gt;&gt;
&gt;&gt; If you consider the partition's name to be the end value that the
&gt;&gt; partition holds, the an object that hashes to
&gt;&gt; 1045375627425331784151332358177649483819648417632 being assigned to
&gt;&gt; 1096126227998177188652763624537212264741949407232 makes sense. That
&gt;&gt; partition would hold items that hash from
&gt;&gt; 913438523331814323877303020447676887284957839361 to
&gt;&gt; 1096126227998177188652763624537212264741949407232
&gt;&gt;
&gt;&gt;
&gt;&gt; Does this help?
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Charlie Voiselle
&gt;&gt;
&gt;&gt;
&gt;&gt; On Jan 24, 2013, at 12:05 AM, Donald Yan  wrote:
&gt;&gt;
&gt;&gt; Hi there,
&gt;&gt;
&gt;&gt; I'm reading this page at
&gt;&gt; http://docs.basho.com/riak/latest/references/appendices/concepts/Replication/#Understanding-replication-by-example
&gt;&gt; and
&gt;&gt; have a question about the example given in the page. I quote it here:
&gt;&gt; "
&gt;&gt;
&gt;&gt; The DocIdx hash is a 160 bit integer:
&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)5&gt; &lt;&gt; = DocIdx.
&gt;&gt; &lt;&lt;183,28,67,173,80,128,26,94,190,198,65,15,27,243,135,127,121,101,255,96&gt;&gt;
&gt;&gt; (dev1@127.0.0.1)6&gt; I.1045375627425331784151332358177649483819648417632
&gt;&gt;
&gt;&gt; The node looks up the hashed key in the ring which returns a list of
&gt;&gt; “preferred” partitions for the given key.
&gt;&gt;
&gt;&gt; (node1@127.0.0.1)&gt; Preflist = riak\\_core\\_ring:preflist(DocIdx, Ring).
&gt;&gt; [{1096126227998177188652763624537212264741949407232, 'dev1@127.0.0.1'},
&gt;&gt; {1278813932664540053428224228626747642198940975104, 'dev2@127.0.0.1'},
&gt;&gt; {0, 'dev1@127.0.0.1'},
&gt;&gt; {182687704666362864775460604089535377456991567872, 'dev2@127.0.0.1'},
&gt;&gt; {365375409332725729550921208179070754913983135744, 'dev3@127.0.0.1'},
&gt;&gt; {548063113999088594326381812268606132370974703616, 'dev1@127.0.0.1'},
&gt;&gt; {730750818665451459101842416358141509827966271488, 'dev2@127.0.0.1'},
&gt;&gt; {913438523331814323877303020447676887284957839360, 'dev3@127.0.0.1'}]
&gt;&gt;
&gt;&gt;
&gt;&gt; "
&gt;&gt;
&gt;&gt; I question is since the key is calculated as "
&gt;&gt; 1045375627425331784151332358177649483819648417632", shouldn't the prefer
&gt;&gt; list be like the following instead?
&gt;&gt; "
&gt;&gt; [{913438523331814323877303020447676887284957839360, 'dev3@127.0.0.1'},
&gt;&gt; {1096126227998177188652763624537212264741949407232, 'dev1@127.0.0.1'},
&gt;&gt; {1278813932664540053428224228626747642198940975104, 'dev2@127.0.0.1'},
&gt;&gt; {0, 'dev1@127.0.0.1'},
&gt;&gt; {182687704666362864775460604089535377456991567872, 'dev2@127.0.0.1'},
&gt;&gt; {365375409332725729550921208179070754913983135744, 'dev3@127.0.0.1'},
&gt;&gt; {548063113999088594326381812268606132370974703616, 'dev1@127.0.0.1'},
&gt;&gt; {730750818665451459101842416358141509827966271488, 'dev2@127.0.0.1'}]
&gt;&gt; "
&gt;&gt; because value "1045375627425331784151332358177649483819648417632" falls
&gt;&gt; between 913438523331814323877303020447676887284957839360 (partition 5)
&gt;&gt; and 1096126227998177188652763624537212264741949407232 (partition 6)?
&gt;&gt;
&gt;&gt; Please Riak experts help to clear my confusion here. Why partition 6, 7,
&gt;&gt; 0 are on the top 3 of the list?
&gt;&gt;
&gt;&gt; Appreciate in advance.
&gt;&gt;
&gt;&gt;
&gt;&gt; -donald
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
&gt;
