---
title: "Re: java driver : lisKeys() returned also deleted keys"
description: ""
project: community
lastmod: 2010-11-20T20:04:03-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01588"
mailinglist_parent_id: "msg01587"
author_name: "Jon Brisbin"
project_section: "mailinglistitem"
sent_date: 2010-11-20T20:04:03-08:00
---


FWIW- I've been working on Riak support for the spring-data project, which is 
Spring's NoSQL abstraction that will support a whole slew of NoSQL databases. 
I'm using it as the basis for the Grails Gorm support for Riak, which I'm also 
writing. It has support for getting and setting POJOs and whatnot using the 
Jackson JSON mapper. I've also included a fairly basic Map/Reduce abstraction.

This uses the Spring 3.0 RestTemplate abstraction rather than relying on a 
specific driver. It also uses the built-in conversion support for reading and 
writing JSON data and other types supported by the Spring 3.0.5 conversion 
mechanism.

I see you're using the PB driver, so none of this might apply to your case 
(we've talked about a good way to support both the REST API and the PB API in 
the same codebase but haven't decided on the best way to do that, if at all). 
It seems to be pretty easy to use and with the built-in support for ETag 
caching, it does make a difference in app performance.

https://github.com/SpringSource/spring-data-keyvalue


Thanks!

J. Brisbin
http://jbrisbin.com/


On Nov 20, 2010, at 2:28 PM, Andrea Campolonghi wrote:

&gt; Andy,
&gt; 
&gt; I am testing but the issue is that Riak really miss a valid java driver.
&gt; The one I am using is fine but has great issue of memory leaks ... sometimes 
&gt; driver hangs ( riak is not even getting the connection ).
&gt; 
&gt; I will restart my server test and try again ....
&gt; 
&gt; Andrea
&gt; 
&gt; 2010/11/20 Andrea Campolonghi 
&gt; Andy,
&gt; 
&gt; great to know.
&gt; So you know is there a way to get if this marker?
&gt; 
&gt; Andrea
&gt; 
&gt; 2010/11/20 Andy Gross 
&gt; 
&gt; 
&gt; Hi Andrea,
&gt; 
&gt; Key deletion in Riak doesn't occur immediately in Riak - keys are first 
&gt; marked with a tombstone marker and then reaped asynchronously. If you 
&gt; insert a sleep between the delete() and keys() calls (try a few seconds) - 
&gt; does the test pass?
&gt; 
&gt; - Andy
&gt; 
&gt; 
&gt; On Sat, Nov 20, 2010 at 10:02 AM, Andrea Campolonghi  
&gt; wrote:
&gt; I am having this issues with the java driver :
&gt; https://github.com/krestenkrab/riak-java-pb-client
&gt; 
&gt; After deleting a key the listKeys method still return it.
&gt; The following test case put and delete one simple key and fails when counting 
&gt; the listKeys item.
&gt; 
&gt; Any Suggestion?
&gt; 
&gt; public class RiakCacheTest extends TestCase {
&gt; 
&gt; 
&gt; private RiakClient rc;
&gt; 
&gt; private String host = "172.16.194.134";
&gt; 
&gt; private int port = 8087;
&gt; 
&gt; private String bucket = "bucket";
&gt; 
&gt; 
&gt; 
&gt; @Override
&gt; 
&gt; protected void setUp() throws Exception {
&gt; 
&gt; rc = new RiakClient(this.host,this.port);
&gt; 
&gt; rc.setClientID(this.getClass().toString());
&gt; 
&gt; }
&gt; 
&gt; 
&gt; 
&gt; public void testRemove(){
&gt; 
&gt; String key = "key";
&gt; 
&gt; String value = "Andrea";
&gt; 
&gt; 
&gt; RiakObject obj = new RiakObject(this.bucket, key, value);
&gt; 
&gt; 
&gt; try{
&gt; 
&gt; this.rc.store(obj);
&gt; 
&gt; assertTrue(getValue(key).equals(value));
&gt; 
&gt; assertEquals(keys().size(),1);
&gt; 
&gt; 
&gt; this.rc.delete(this.bucket, key);
&gt; 
&gt; assertNull(getValue(key));
&gt; 
&gt; assertEquals(keys().size(),0);
&gt; 
&gt; 
&gt; }catch(IOException e){
&gt; 
&gt; e.printStackTrace();
&gt; 
&gt; }
&gt; 
&gt; 
&gt; }
&gt; 
&gt; 
&gt; private String getValue(String key){
&gt; 
&gt; String fetched = "";
&gt; 
&gt; try{
&gt; 
&gt; RiakObject[] ros = this.rc.fetch(this.bucket, key);
&gt; 
&gt; for(RiakObject ro : ros){
&gt; 
&gt; return ro.getValue().toStringUtf8();
&gt; 
&gt; }
&gt; 
&gt; }catch(IOException e){
&gt; 
&gt; e.printStackTrace();
&gt; 
&gt; }
&gt; 
&gt; return null;
&gt; 
&gt; }
&gt; 
&gt; 
&gt; 
&gt; private List keys() {
&gt; 
&gt; ArrayList result = new ArrayList();
&gt; 
&gt; ByteString bucket = ByteString.copyFromUtf8(this.bucket);
&gt; 
&gt; 
&gt; try{
&gt; 
&gt; KeySource keys = this.rc.listKeys(bucket);
&gt; 
&gt; while(keys.hasNext()){
&gt; 
&gt; String key = keys.next().toStringUtf8();
&gt; 
&gt; result.add(key);
&gt; 
&gt; } 
&gt; 
&gt; }catch(IOException e){
&gt; 
&gt; e.printStackTrace();
&gt; 
&gt; }
&gt; 
&gt; return result;
&gt; 
&gt; }
&gt; 
&gt; 
&gt; 
&gt; }
&gt; 
&gt; 
&gt; -- 
&gt; Andrea Campolonghi
&gt; 
&gt; Cell : +39 347 2298435
&gt; acampolon...@gmail.com
&gt; and...@andreacfm.com
&gt; http://www.andreacfm.com
&gt; 
&gt; Railo Team
&gt; and...@getrailo.org
&gt; http://getrailo.org
&gt; 
&gt; 
&gt; 
 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Andrea Campolonghi
&gt; 
&gt; Cell : +39 347 2298435
&gt; acampolon...@gmail.com
&gt; and...@andreacfm.com
&gt; http://www.andreacfm.com
&gt; 
&gt; Railo Team
&gt; and...@getrailo.org
&gt; http://getrailo.org
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Andrea Campolonghi
&gt; 
&gt; Cell : +39 347 2298435
&gt; acampolon...@gmail.com
&gt; and...@andreacfm.com
&gt; http://www.andreacfm.com
&gt; 
&gt; Railo Team
&gt; and...@getrailo.org
&gt; http://getrailo.org
&gt; 
&gt; 

