---
title: "Re: Map Reduce and long queries -"
description: ""
project: community
lastmod: 2012-10-14T14:03:01-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08912"
mailinglist_parent_id: "msg08910"
author_name: "Adam Lindsay"
project_section: "mailinglistitem"
sent_date: 2012-10-14T14:03:01-07:00
---


Hi David, 

The word everywhere is to avoid key filters. It effectively does a whole-bucket 
key-listing, and that starts to get seriously slow out past 100k items. Since 
you say test queries work I'll presume you've debugged your map and reduce on 
some queries where you manually add a set of keys. (Right?) 

Since you're on LevelDB, it means you can use secondary indices ("2i") to drive 
these queries.

I don't have access to your filter\\_map, so I don't have access to how you 
construct your keys, but if you have 2i turned on, then you get the first 
key-field "for free" from 2i.

Let's say, hypothetically, that your keys are constructed as:
 keyprefix:::

Well, you can then rewrite the query input as:

def main():
 client = riak.RiakClient(host=riak\\_host,
 port=8087,transport\\_class=riak.transports.pbc.RiakPbcTransport)
 query = client.index(
 bucket, 
 '$key', 
 'keyprefix:201210', 
 'keyprefix:201210~')
 query.map('''function(value, keyData, arg) { ... }''')
 â€¦



That's fine as far as it goes, but it doesn't solve the problem of querying 
country or campaign id, right?

As a temporary measure, I'd suggest trying your key filters, cranking up the 
timeout to something on the order of hours (I gave 5 minutes conservatively and 
arbitrarily), and going ahead and running it for however long it takes.


If those queries do give good results, I'd suggest going ahead and re-indexing 
your existing entries with 'country\\_bin' and 'campaign\\_bin'. It's up to 
personal style whether you treat dates as int or bin.

There are lots of tricks and further discussion on how best to get at every 
corner of your data, but how does this strike you so far?
-- 
Adam Lindsay


On Sunday, 14 October 2012 at 12:57, David Montgomery wrote:

&gt; Hi,
&gt; 
&gt; Below is my code for running a map reduce in python. I have a six
&gt; node cluster, 2 cores each with 4 gigs for ram. I am no load and
&gt; about 3 Mill keys and using leveldb with riak 1.2. Doing the below
&gt; is taking a terribly long time. Never finished and I dont even know
&gt; how I can check if it is even running other than the python script has
&gt; not timed out. I look at the number of executed mappers in stats and
&gt; it is flat lined when looking at Graphite. On test queries the below
&gt; works.
&gt; 
&gt; So..how do I debug what is going on?
&gt; 
&gt; 
&gt; def main():
&gt; client = 
&gt; riak.RiakClient(host=riak\\_host,port=8087,transport\\_class=riak.transports.pbc.RiakPbcTransport)
&gt; query = client.add(bucket)
&gt; filters = key\\_filter.tokenize(":", filter\\_map['date']) +
&gt; (key\\_filter.starts\\_with('201210'))
&gt; #& key\\_filter.tokenize(":", filter\\_map['country']).eq("US") \\
&gt; #& key\\_filter.tokenize(":", filter\\_map['campaign\\_id']).eq("t1") \\
&gt; query.add\\_key\\_filters(filters)
&gt; 
&gt; query.map('''
&gt; function(value, keyData, arg) {
&gt; var data = Riak.mapValuesJson(value)[0];
&gt; 
&gt; if(data['adx']=='gdn'){
&gt; var alt\\_key = data['hw'];
&gt; var obj = {};
&gt; obj[alt\\_key] = 1;
&gt; return [ obj ];
&gt; }else{
&gt; return [];
&gt; }
&gt; 
&gt; 
&gt; }''')
&gt; 
&gt; 
&gt; query.reduce('''
&gt; function(values, arg){
&gt; return [ values.reduce( function(acc, item) {
&gt; for (var state in item) {
&gt; if (acc[state])
&gt; acc[state] += item[state];
&gt; else
&gt; acc[state] = item[state];
&gt; }
&gt; return acc;
&gt; })];
&gt; }
&gt; ''')
&gt; 
&gt; for result in query.run(timeout=300000):
&gt; print result
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

