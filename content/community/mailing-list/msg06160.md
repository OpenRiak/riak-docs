---
title: "Re: Weird (?) error while using riak erlang pb client's mapreduce"
description: ""
project: community
lastmod: 2012-01-06T12:13:50-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06160"
mailinglist_parent_id: "msg06159"
author_name: "Alin Popa"
project_section: "mailinglistitem"
sent_date: 2012-01-06T12:13:50-08:00
---


Hmmm, it seems that I've found why this is happening:

http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2011-February/003127.html

This problem was raised before and already solved, sorry for opening it
again :)

Alin

On Fri, Jan 6, 2012 at 9:51 PM, Alin Popa  wrote:

&gt; Hi Bryan,
&gt;
&gt; Thanks, it makes sense, indeed, I've done what you've suggested, to load
&gt; the code within riak (using add\\_paths) and everything worked fine. Still, I
&gt; have a couple dilemas regarding this:
&gt;
&gt; 1. Why is not complaining if using escript instead of compiling it as a
&gt; separate module (and no, I'm not loading the code within riak this time) ?
&gt;
&gt; \\*#!/usr/bin/env escript\\*
&gt; \\*
&gt; \\*
&gt; \\*main([]) -&gt;\\*
&gt; \\* code:add\\_patha("/Users/alin/riak-erlang-client/ebin"),\\*
&gt; \\* code:add\\_patha("/Users/alin/riak-erlang-client/deps/protobuffs/ebin"),\\*
&gt; \\* {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),\\*
&gt; \\* Fun = fun(Object, \\_KeyData, none) -&gt; [Object] end,\\*
&gt; \\* io:format("Result: ~n~p~n",[riakc\\_pb\\_socket:mapred(Pid,
&gt; {&lt;&lt;"test-bucket"&gt;&gt;,[]}, [{map, {qfun, Fun}, none, true}])]).\\*
&gt;
&gt; this might be an erlang thing ?
&gt;
&gt; 2. I remember that running exactly the same code in the past (~ 1 month
&gt; ago), worked with no special intervention like adding code paths to riak.
&gt; In fact, that's why I've raised this problem now, as it doesn't make any
&gt; sense. Noticed this behavior on both release version (1.0.2) and master
&gt; branch from github.
&gt;
&gt; Thanks,
&gt; Alin
&gt;
&gt;
&gt; On Fri, Jan 6, 2012 at 7:18 PM, Bryan Fink  wrote:
&gt;
&gt;&gt; On Fri, Jan 6, 2012 at 10:18 AM, Alin Popa  wrote:
&gt;&gt; &gt; and this is the code that I'm using for this:
&gt;&gt; &gt;
&gt;&gt; &gt; -module(simple\\_mapreduce).
&gt;&gt; &gt;
&gt;&gt; &gt; -compile(export\\_all).
&gt;&gt; &gt;
&gt;&gt; &gt; main(Pid) -&gt;
&gt;&gt; &gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),
&gt;&gt; &gt; Fun = fun(Object, \\_KeyData, none) -&gt; [Object] end,
&gt;&gt; &gt; riakc\\_pb\\_socket:mapred(Pid, {&lt;&lt;"small-bucket"&gt;&gt;,[]}, [{map, {qfun,
&gt;&gt; Count},
&gt;&gt; &gt; none, true}]).
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; It's a very simple usage, and according to the documentation, I haven't
&gt;&gt; &gt; missed anything here (I know I can use the modfun instead of qfun for
&gt;&gt; &gt; exactly this functionality, but it's just an example which throws).
&gt;&gt; &gt;
&gt;&gt; &gt; Also, for the master version of riak, I'm getting error as return value
&gt;&gt; of
&gt;&gt; &gt; calling mapred function on riakc\\_pb\\_socket:
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; {error,&lt;&lt;"{\\"phase\\":0,\\"error\\":\\"undef\\",\\"input\\":\\"{ok,{r\\_object,&lt;&lt;\\\\\\"small-bucket\\\\\\"&gt;&gt;,&lt;&lt;\\\\\\"some-magnific-key-44\\\\\\"&gt;&gt;,[{r\\_cont"...&gt;&gt;}
&gt;&gt; &gt;
&gt;&gt; &gt; Is there a way that I can understand what these logs means ?
&gt;&gt;
&gt;&gt; The clue is the "error:'undef'" field in the error message JSON you
&gt;&gt; received. Just like any undef error in an erlang program, it's
&gt;&gt; telling you the query tried to call a function that does not exist.
&gt;&gt;
&gt;&gt; The reason the function does not exist is that the Riak cluster does
&gt;&gt; not have access to your 'simple\\_mapreduce' module. Since the
&gt;&gt; anonymous function you are submitting was created in that module, Riak
&gt;&gt; needs to be able to load the same version of it in order to evaluate
&gt;&gt; the function. If you had used modfun instead, you would have received
&gt;&gt; an error complaining that the module was unavailable.
&gt;&gt;
&gt;&gt; To make your module available to Riak, point the 'add\\_paths' setting
&gt;&gt; in the riak\\_kv section of your app.config to the directory containing
&gt;&gt; your module's compiled beam file.
&gt;&gt;
&gt;&gt; http://wiki.basho.com/Configuration-Files.html#add\\_paths
&gt;&gt;
&gt;&gt; Also, be sure to reload the module on each riak cluster node (using
&gt;&gt; 'riak-admin erl\\_reload' on the command line) after making changes and
&gt;&gt; recompiling your module.
&gt;&gt;
&gt;&gt; Hope that helps,
&gt;&gt; Bryan
&gt;&gt;
&gt;
&gt;
