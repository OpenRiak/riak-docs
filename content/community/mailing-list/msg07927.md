---
title: "Re: ssl support?"
description: ""
project: community
lastmod: 2012-07-13T12:53:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07927"
mailinglist_parent_id: "msg07926"
author_name: "Chris Meiklejohn"
project_section: "mailinglistitem"
sent_date: 2012-07-13T12:53:42-07:00
---


Hi Michael,

Does either your cert/key file have two keys in it by chance? If so, one
of those is most likely an intermediary cert, which should be placed in
it's own file as outlined here (see intermediate authorities, cacertfile):

http://wiki.basho.com/Riak-Control.html

- Chris

Christopher Meiklejohn
Software Engineer
Basho Technologies, Inc.

On Fri, Jul 13, 2012 at 3:45 PM, Michael Johnson  wrote:

&gt; I've also gave this a try a bit ago using a legit cert from an ssl
&gt; provider with the same result. Are you also running on centos 6 using the
&gt; binaries provided from http://downloads.basho.com/riak/CURRENT/
&gt;
&gt; If I need to build my own packages from source, I can do that, but I'd
&gt; much prefer to use the pre-built binaries.
&gt;
&gt;
&gt; On Fri, Jul 13, 2012 at 11:41 AM, John E. Vincent &lt;
&gt; lusis.org+riak-us...@gmail.com&gt; wrote:
&gt;
&gt;&gt; SSL is working for me (for riak-control) using self-signed
&gt;&gt; certificates. However I've not yet tried it with an external client.
&gt;&gt;
&gt;&gt; On Fri, Jul 13, 2012 at 2:34 PM, Michael Johnson 
&gt;&gt; wrote:
&gt;&gt; &gt; I've been having problems getting riak to function via https and have
&gt;&gt; not
&gt;&gt; &gt; been able to find anything online that seems to help so far. I am
&gt;&gt; using a
&gt;&gt; &gt; self-signed certificate (which is one I generated specifically for this
&gt;&gt; &gt; testing, and thus could post as it will not be used for anything else)
&gt;&gt; and
&gt;&gt; &gt; have it stored as separate .crt and .key files. I've used open SSL to
&gt;&gt; &gt; verify the certificate and it appears to be all good. Here is what the
&gt;&gt; &gt; relevant bits of my app.config look like (I can post the rest as
&gt;&gt; needed, but
&gt;&gt; &gt; I'm trying to be consise):
&gt;&gt; &gt;
&gt;&gt; &gt; {http, [{"0.0.0.0", 8091}]},
&gt;&gt; &gt; {https, [{"0.0.0.0", 8092}]},
&gt;&gt; &gt; {ssl, [
&gt;&gt; &gt; {certfile, "/etc/riak/ssl.crt"},
&gt;&gt; &gt; {keyfile, "/etc/riak/ssl.key"}
&gt;&gt; &gt; ]},
&gt;&gt; &gt;
&gt;&gt; &gt; Starting riak does not generate any errors, and 'riak-admin test' works:
&gt;&gt; &gt; [root@riak01 riak]# riak-admin test
&gt;&gt; &gt; Attempting to restart script through sudo -u riak
&gt;&gt; &gt; Successfully completed 1 read/write cycle to '
&gt;&gt; r...@riak01.mediatemple.net'
&gt;&gt; &gt;
&gt;&gt; &gt; Manuallly querying riak via http also works fine:
&gt;&gt; &gt;
&gt;&gt; &gt; [root@riak01 riak]# curl -k -vvv
&gt;&gt; &gt; http://127.0.0.1:8091/riak/\\_\\_riak\\_client\\_test\\_\\_
&gt;&gt; &gt; \\* About to connect() to 127.0.0.1 port 8091 (#0)
&gt;&gt; &gt; \\* Trying 127.0.0.1... connected
&gt;&gt; &gt; \\* Connected to 127.0.0.1 (127.0.0.1) port 8091 (#0)
&gt;&gt; &gt;&gt; GET /riak/\\_\\_riak\\_client\\_test\\_\\_ HTTP/1.1
&gt;&gt; &gt;&gt; User-Agent: curl/7.19.7 (x86\\_64-redhat-linux-gnu) libcurl/7.19.7
&gt;&gt; &gt;&gt; NSS/3.13.1.0 zlib/1.2.3 libidn/1.18 libssh2/1.2.2
&gt;&gt; &gt;&gt; Host: 127.0.0.1:8091
&gt;&gt; &gt;&gt; Accept: \\*/\\*
&gt;&gt; &gt;&gt;
&gt;&gt; &gt; &lt; HTTP/1.1 200 OK
&gt;&gt; &gt; &lt; Vary: Accept-Encoding
&gt;&gt; &gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt;&gt; &gt; &lt; Date: Fri, 13 Jul 2012 18:03:13 GMT
&gt;&gt; &gt; &lt; Content-Type: application/json
&gt;&gt; &gt; &lt; Content-Length: 410
&gt;&gt; &gt; &lt;
&gt;&gt; &gt; \\* Connection #0 to host 127.0.0.1 left intact
&gt;&gt; &gt; \\* Closing connection #0
&gt;&gt; &gt;
&gt;&gt; {"props":{"name":"\\_\\_riak\\_client\\_test\\_\\_","allow\\_mult":false,"basic\\_quorum":false,"big\\_vclock":50,"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"dw":1,"last\\_write\\_wins":false,"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"n\\_val":1,"notfound\\_ok":true,"old\\_vclock":86400,"postcommit":[],"pr":0,"precommit":[],"pw":0,"r":1,"rw":1,"small\\_vclock":50,"w":1,"young\\_vclock":20}}
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; But the minute I try to connect via https I have problems:
&gt;&gt; &gt;
&gt;&gt; &gt; [root@riak01 riak]# curl -k -vvv
&gt;&gt; &gt; https://127.0.0.1:8092/riak/\\_\\_riak\\_client\\_test\\_\\_
&gt;&gt; &gt; \\* About to connect() to 127.0.0.1 port 8092 (#0)
&gt;&gt; &gt; \\* Trying 127.0.0.1... connected
&gt;&gt; &gt; \\* Connected to 127.0.0.1 (127.0.0.1) port 8092 (#0)
&gt;&gt; &gt; \\* Initializing NSS with certpath: sql:/etc/pki/nssdb
&gt;&gt; &gt; \\* warning: ignoring value of ssl.verifyhost
&gt;&gt; &gt; \\* NSS error -5938
&gt;&gt; &gt; \\* Closing connection #0
&gt;&gt; &gt; \\* SSL connect error
&gt;&gt; &gt; curl: (35) SSL connect error
&gt;&gt; &gt;
&gt;&gt; &gt; And I see the following in the logs:
&gt;&gt; &gt;
&gt;&gt; &gt; console.log:
&gt;&gt; &gt; 2012-07-13 11:05:52.023 [error] &lt;0.5313.0&gt; CRASH REPORT Process
&gt;&gt; &lt;0.5313.0&gt;
&gt;&gt; &gt; with 0 neighbours crashed with reason:
&gt;&gt; &gt; {ekeyfile,[{gen\\_fsm,init\\_it,6},{proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt; &gt; 2012-07-13 11:05:52.026 [error] &lt;0.134.0&gt; Supervisor ssl\\_connection\\_sup
&gt;&gt; had
&gt;&gt; &gt; child undefined started with {ssl\\_connection,start\\_link,undefined} at
&gt;&gt; &gt; &lt;0.5313.0&gt; exit with reason ekeyfile in context child\\_terminated
&gt;&gt; &gt; 2012-07-13 11:05:52.031 [error] &lt;0.139.0&gt; application: mochiweb, "Accept
&gt;&gt; &gt; failed error", "{error,ekeyfile}"
&gt;&gt; &gt; 2012-07-13 11:05:52.033 [error] &lt;0.139.0&gt; CRASH REPORT Process &lt;0.139.0&gt;
&gt;&gt; &gt; with 0 neighbours crashed with reason: {error,accept\\_failed}
&gt;&gt; &gt; 2012-07-13 11:05:52.035 [error] &lt;0.135.0&gt;
&gt;&gt; &gt; {mochiweb\\_socket\\_server,310,{acceptor\\_error,{error,accept\\_failed}}}
&gt;&gt; &gt;
&gt;&gt; &gt; crash.log:
&gt;&gt; &gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt;&gt; &gt;
&gt;&gt; [83,83,76,58,32,"1112",58,32,"error",58,"[]",32,"/etc/riak/ssl.key","\\n",32,32,[91,[[123,["ssl\\_connection",44,"init\\_private\\_key",44,"5"],125],44,10,"
&gt;&gt; &gt; ",[123,["ssl\\_connection",44,"ssl\\_init",44,"2"],125],44,10,"
&gt;&gt; &gt; ",[123,["ssl\\_connection",44,"init",44,"1"],125],44,10,"
&gt;&gt; &gt; ",[123,["gen\\_fsm",44,"init\\_it",44,"6"],125],44,10,"
&gt;&gt; &gt;
&gt;&gt; ",[123,["proc\\_lib",44,"init\\_p\\_do\\_apply",44,"3"],125]],93],"\\n"]2012-07-13
&gt;&gt; &gt; 11:05:52 =CRASH REPORT====
&gt;&gt; &gt; crasher:
&gt;&gt; &gt; initial call: ssl\\_connection:init/1
&gt;&gt; &gt; pid: &lt;0.5313.0&gt;
&gt;&gt; &gt; registered\\_name: []
&gt;&gt; &gt; exception exit: ekeyfile
&gt;&gt; &gt; in function gen\\_fsm:init\\_it/6
&gt;&gt; &gt; in call from proc\\_lib:init\\_p\\_do\\_apply/3
&gt;&gt; &gt; ancestors: [ssl\\_connection\\_sup,ssl\\_sup,&lt;0.130.0&gt;]
&gt;&gt; &gt; messages: []
&gt;&gt; &gt; links: [&lt;0.134.0&gt;]
&gt;&gt; &gt; dictionary: []
&gt;&gt; &gt; trap\\_exit: false
&gt;&gt; &gt; status: running
&gt;&gt; &gt; heap\\_size: 1597
&gt;&gt; &gt; stack\\_size: 24
&gt;&gt; &gt; reductions: 1185
&gt;&gt; &gt; neighbours:
&gt;&gt; &gt; 2012-07-13 11:05:52 =SUPERVISOR REPORT====
&gt;&gt; &gt; Supervisor: {local,ssl\\_connection\\_sup}
&gt;&gt; &gt; Context: child\\_terminated
&gt;&gt; &gt; Reason: ekeyfile
&gt;&gt; &gt; Offender:
&gt;&gt; &gt;
&gt;&gt; [{pid,&lt;0.5313.0&gt;},{name,undefined},{mfargs,{ssl\\_connection,start\\_link,undefined}},{restart\\_type,temporary},{shutdown,4000},{child\\_type,worker}]
&gt;&gt; &gt;
&gt;&gt; &gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt;&gt; &gt; [{application,mochiweb},"Accept failed
&gt;&gt; error","{error,ekeyfile}"]2012-07-13
&gt;&gt; &gt; 11:05:52 =CRASH REPORT====
&gt;&gt; &gt; crasher:
&gt;&gt; &gt; initial call: mochiweb\\_acceptor:init/3
&gt;&gt; &gt; pid: &lt;0.139.0&gt;
&gt;&gt; &gt; registered\\_name: []
&gt;&gt; &gt; exception exit: {error,accept\\_failed}
&gt;&gt; &gt; in function mochiweb\\_acceptor:init/3
&gt;&gt; &gt; in call from proc\\_lib:init\\_p\\_do\\_apply/3
&gt;&gt; &gt; ancestors: ['https\\_0.0.0.0:8092',riak\\_core\\_sup,&lt;0.88.0&gt;]
&gt;&gt; &gt; messages: []
&gt;&gt; &gt; links: [&lt;0.135.0&gt;,#Port&lt;0.5661&gt;]
&gt;&gt; &gt; dictionary: []
&gt;&gt; &gt; trap\\_exit: false
&gt;&gt; &gt; status: running
&gt;&gt; &gt; heap\\_size: 233
&gt;&gt; &gt; stack\\_size: 24
&gt;&gt; &gt; reductions: 818
&gt;&gt; &gt; neighbours:
&gt;&gt; &gt; 2012-07-13 11:05:52 =ERROR REPORT====
&gt;&gt; &gt; {mochiweb\\_socket\\_server,310,{acceptor\\_error,{error,accept\\_failed}}}
&gt;&gt; &gt;
&gt;&gt; &gt; erlang.log.1 and error.log (which are identical):
&gt;&gt; &gt; 11:05:52.018 [error] SSL: 1112: error:[] /etc/riak/ssl.key
&gt;&gt; &gt; [{ssl\\_connection,init\\_private\\_key,5},
&gt;&gt; &gt; {ssl\\_connection,ssl\\_init,2},
&gt;&gt; &gt; {ssl\\_connection,init,1},
&gt;&gt; &gt; {gen\\_fsm,init\\_it,6},
&gt;&gt; &gt; {proc\\_lib,init\\_p\\_do\\_apply,3}]
&gt;&gt; &gt;
&gt;&gt; &gt; 11:05:52.023 [error] CRASH REPORT Process &lt;0.5313.0&gt; with 0 neighbours
&gt;&gt; &gt; crashed with reason:
&gt;&gt; &gt; {ekeyfile,[{gen\\_fsm,init\\_it,6},{proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt; &gt; 11:05:52.026 [error] Supervisor ssl\\_connection\\_sup had child undefined
&gt;&gt; &gt; started with {ssl\\_connection,start\\_link,undefined} at &lt;0.5313.0&gt; exit
&gt;&gt; with
&gt;&gt; &gt; reason ekeyfile in context child\\_terminated
&gt;&gt; &gt; 11:05:52.031 [error] application: mochiweb, "Accept failed error",
&gt;&gt; &gt; "{error,ekeyfile}"
&gt;&gt; &gt; 11:05:52.033 [error] CRASH REPORT Process &lt;0.139.0&gt; with 0 neighbours
&gt;&gt; &gt; crashed with reason: {error,accept\\_failed}
&gt;&gt; &gt; 11:05:52.035 [error]
&gt;&gt; &gt; {mochiweb\\_socket\\_server,310,{acceptor\\_error,{error,accept\\_failed}}}
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; Everything I am finding says this means my key file is bad. However, as
&gt;&gt; &gt; previously mentioned, I've verified this with openssl:
&gt;&gt; &gt;
&gt;&gt; &gt; [root@riak01 riak]# openssl verify /etc/riak/ssl.crt
&gt;&gt; &gt; /etc/riak/ssl.crt: C = US, ST = California, L = Culver City, O = Default
&gt;&gt; &gt; Company Ltd, CN = example.com, emailAddress = ad...@example.com
&gt;&gt; &gt; error 18 at 0 depth lookup:self signed certificate
&gt;&gt; &gt; OK
&gt;&gt; &gt;
&gt;&gt; &gt; [root@riak01 riak]# ( openssl x509 -noout -modulus -in
&gt;&gt; /etc/riak/ssl.crt |
&gt;&gt; &gt; openssl md5; openssl rsa -noout -modulus -in /etc/riak/ssl.key |
&gt;&gt; openssl md5
&gt;&gt; &gt; ) | uniq
&gt;&gt; &gt; (stdin)= b3d4187d8472f2d0b73cf5597d5d65b8
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; I'm just really not sure what else to look at. Everything seems to be
&gt;&gt; fine
&gt;&gt; &gt; except for that fact it's not working. Does anybody have SSL working
&gt;&gt; with
&gt;&gt; &gt; self-signed certificate using the basho provided binary packages on
&gt;&gt; CentOS
&gt;&gt; &gt; 6.3? I'm beginning to thing that they might be the problem and I just
&gt;&gt; don't
&gt;&gt; &gt; know where to go from here.
&gt;&gt; &gt;
&gt;&gt; &gt; Any suggestions will be appreciated.
&gt;&gt; &gt;
&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt; riak-users mailing list
&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt; &gt;
&gt;&gt;
&gt;
&gt;

