---
title: "Re: Secondary Index ??"
description: ""
project: community
lastmod: 2011-10-06T03:02:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05068"
mailinglist_parent_id: "msg05067"
author_name: "Roland Karlsson"
project_section: "mailinglistitem"
sent_date: 2011-10-06T03:02:45-07:00
---


OK - I saw that in the code.

But - why do the identity function return a list containing
a bucket, key pair? Why not a tuple? If it returns a tuple,
then the output of e.g. get\\_index() could be used as an input
to a new mapreduce. Would that not be nice?

Or am I missing something?

/Roland


----- Original Message -----
From: "Russell Brown" 
To: "Roland Karlsson" 
Cc: riak-users@lists.basho.com
Sent: Thursday, October 6, 2011 11:38:51 AM
Subject: Re: Secondary Index ??

And this time, to the list as well :$
On 6 Oct 2011, at 10:22, Roland Karlsson wrote:

&gt; Maybe my question below was not clear enough.
&gt; 
&gt; I wonder why get\\_index() returns a list
&gt; of lists (containing bucket/key pairs), when mapred()
&gt; wants a list of tuples (containing bucket/key pairs).
&gt; Looks like an unnecessary conversion by the user too me.

When you call get\\_index from the riak-erlang-client you are in fact running an 
m/r operation. The input is an index query. The riak-erlang-client specifies a 
reduce phase of riak\\_kv\\_mapreduce:reduce\\_identity/2, so you get back the output 
from that (a list of [b,k] lists).

The Java client takes a different approach and has a reduce function that just 
returns the keys, in a list. This is to provide parity with the output of the 
HTTP API (which returns the JSON {"keys": ["k1", "k2"]})

If you wish, you can run an m/r job with an index input and subsequent 
map/reduce phases to ensure the output is the shape you want it to be. 
get\\_index() is just a convenience function for one such m/r job.

Cheers

Russell 

&gt; 
&gt; /Roland
&gt; 
&gt; 
&gt; 
&gt; 
&gt; ----- Original Message -----
&gt; From: "Roland Karlsson" 
&gt; To: riak-users@lists.basho.com
&gt; Sent: Wednesday, October 5, 2011 4:33:17 PM
&gt; Subject: Re: Secondary Index ??
&gt; 
&gt; Thanx - now it works!
&gt; 
&gt; Your explanations were very good.
&gt; 
&gt; I also found I had to change from bitcask to eleveldb.
&gt; 
&gt; I added one object with the same index and then I got the answer
&gt; 
&gt; {ok, [[&lt;&lt;"persons"&gt;&gt;,&lt;&lt;"kenny"&gt;&gt;],[&lt;&lt;"persons"&gt;&gt;,&lt;&lt;"bosse"&gt;&gt;]]}
&gt; 
&gt; Hmmm ... why is it a list in a list?
&gt; 
&gt; /Roland
&gt; 
&gt; 
&gt; 
&gt; 
&gt; ----- Original Message -----
&gt; From: "Russell Brown" 
&gt; To: "Roland Karlsson" 
&gt; Cc: riak-users@lists.basho.com
&gt; Sent: Wednesday, October 5, 2011 3:12:04 PM
&gt; Subject: Re: Secondary Index ??
&gt; 
&gt; 
&gt; On 5 Oct 2011, at 13:45, Roland Karlsson wrote:
&gt; 
&gt;&gt; Hi,
&gt;&gt; 
&gt;&gt; I might not look hard enough - but I cannot find how to use
&gt;&gt; the secondary indices from the riakc erlang client interface.
&gt;&gt; No example and no manual.
&gt; 
&gt; Ooops, we'll get on that.
&gt; 
&gt;&gt; 
&gt;&gt; I need a simple example how to write an indexed object
&gt;&gt; and also a simple example how to look it up via the index.
&gt;&gt; 
&gt;&gt; This is my own try to write and lookup an object
&gt;&gt; It does not work :)
&gt; 
&gt; Doesn't work crash or doesn't work, you get {ok, []} when you query the index?
&gt; 
&gt;&gt; 
&gt;&gt; ----------------------------------------------------------
&gt;&gt; write\\_index(Pid) -&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Bucket = &lt;&lt;"persons"&gt;&gt;,
&gt;&gt; Key = &lt;&lt;"bosse"&gt;&gt;,
&gt;&gt; Index = {&lt;&lt;"lives"&gt;&gt;, &lt;&lt;"sumatra"&gt;&gt;},
&gt; 
&gt; Indexes should have a suffix of either \\_bin for binary or \\_int for integer.
&gt; 
&gt;&gt; Obj = riakc\\_obj:new(Bucket, Key, &lt;&lt;"1949"&gt;&gt;),
&gt;&gt; Meta = dict:store(?MD\\_INDEX, Index, dict:new()),
&gt; 
&gt; Index should be a list. If it \\*was\\* in a list you would have got an error 
&gt; {error,&lt;&lt;"{precommit\\_fail,[{unknown\\_field\\_type,&lt;&lt;\\"lives\\"&gt;&gt;}]}"&gt;&gt;} on put. 
&gt; 
&gt;&gt; Obj2 = riakc\\_obj:update\\_metadata(Obj, Meta),
&gt;&gt; riakc\\_pb\\_socket:put(Pid, Obj2).
&gt;&gt; ----------------------------------------------------------
&gt;&gt; read\\_index(Pid) -&gt;
&gt;&gt; Bucket = &lt;&lt;"persons"&gt;&gt;,
&gt;&gt; Index = &lt;&lt;"lives"&gt;&gt;,
&gt; 
&gt; Again, the suffix. or you'll get 
&gt; {error,&lt;&lt;"{inputs,[{unknown\\_field\\_type,&lt;&lt;\\"lives\\"&gt;&gt;}]}"&gt;&gt;} when you do that 
&gt; get\\_index.
&gt; 
&gt;&gt; IndexKey = &lt;&lt;"sumatra"&gt;&gt;,
&gt;&gt; riakc\\_pb\\_socket:get\\_index(Pid, Bucket, Index, IndexKey). 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; ----------------------------------------------------------
&gt; 
&gt; Do \\_all\\_ that and I get {ok,[[&lt;&lt;"persons"&gt;&gt;,&lt;&lt;"bosse"&gt;&gt;]]} as the output from 
&gt; get\\_index.
&gt; 
&gt; We'll get those docs updated.
&gt; 
&gt; Cheers
&gt; 
&gt; Russell
&gt;&gt; 
&gt;&gt; 
&gt;&gt; /Roland
&gt;&gt; 
&gt; 
&gt; 
 
