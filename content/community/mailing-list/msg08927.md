---
title: "Re: Riak performance problems when LevelDB database grows beyond 16GB"
description: ""
project: community
lastmod: 2012-10-15T15:09:30-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08927"
mailinglist_parent_id: "msg08924"
author_name: "Eli Janssen"
project_section: "mailinglistitem"
sent_date: 2012-10-15T15:09:30-07:00
---


Anything in the system logs or dmesg?
With vm.swappiness set to the defaults, the oom-killer could be doing its job a 
bit too well.


On Oct 15, 2012, at 12:10 PM, jan.evangeli...@seznam.cz wrote:

&gt; Hi Evan,
&gt; 
&gt; regarding the swappiness and disk scheduling: these were set to default, I 
&gt; will correct it and run another test. 
&gt; 
&gt; The hosting provider sets the computer with software RAID1 over 2 physical 
&gt; disks, do you think it is useful with Riak?
&gt; 
&gt; BTW, I suspected that part of the problem could be caused by the hardware of 
&gt; the first node. So I ran another test over the weekend with the node 
&gt; replaced, and the result was slightly better: one of the nodes crashed after 
&gt; cca 22 hours when its DB reached 14G, but the other 3 nodes worked for 2.8 
&gt; days until the DB reached 40G (see 
&gt; http://janevangelista.rajce.idnes.cz/nastenka/#4Riak\\_2K\\_2.1RC2\\_3d\\_edited.jpg 
&gt; ). All the nodes crashed silently, there is nothing interesting in Riak logs.
&gt; 
&gt; Thanks, Jan
&gt; 
&gt; ---------- Původní zpráva ----------
&gt; Od: Evan Vigil-McClanahan 
&gt; Datum: 12. 10. 2012
&gt; Předmět: Re: Re: Riak performance problems when LevelDB database grows beyond 
&gt; 16GB
&gt; Hi there, Jan,
&gt; 
&gt; The lsof issue is that max\\_open\\_files is per backend, iirc, so if
&gt; you're maxed out you'll see vnode count \\* max\\_open\\_files.
&gt; 
&gt; I think on the second try, you may have set the cache too high. I'd
&gt; drop it back to 8 or 16 MB, and possibly up the open files a bit more,
&gt; but you don't seem to be running into contention at this point.
&gt; There's a RAM cost, so maybe just leave it where it is for now, unless
&gt; you have quite a lot of memory.
&gt; 
&gt; Another thing to check is that vm.swappiness is set to 0 and that your
&gt; disk scheduler is set to deadline for spinning disks and noop for
&gt; SSDs.
&gt; 
&gt; On Fri, Oct 12, 2012 at 5:02 AM, wrote:
&gt;&gt;&gt; Can you attach the eleveldb portion of your app.config file?
&gt;&gt;&gt; Configuration problems, especially max\\_open\\_files being too low, can
&gt;&gt;&gt; often cause issues like this.
&gt;&gt;&gt; 
&gt;&gt;&gt; If it isn't sensitive, the whole app.config and vm.args files are also
&gt;&gt;&gt; often helpful.
&gt;&gt; 
&gt;&gt; Hello Evan,
&gt;&gt; 
&gt;&gt; thanks for responding.
&gt;&gt; 
&gt;&gt; I originally had default LevelDB settings. When the node stalled, I changed 
&gt;&gt; it
&gt;&gt; to
&gt;&gt; 
&gt;&gt; {eleveldb, [
&gt;&gt; {data\\_root, "/home/riak/leveldb"},
&gt;&gt; {max\\_open\\_files, 132},
&gt;&gt; {cache\\_size, 377487360}
&gt;&gt; ]},
&gt;&gt; 
&gt;&gt; on all nodes and I restarted them all. The application started to run with
&gt;&gt; about 1000 requests/second, after about 1 minute it dropped to &lt;500
&gt;&gt; requests/second, and the node stalled again after 41 minutes. BTW according 
&gt;&gt; to
&gt;&gt; lsof(1) it had 267 open LevelDB files which is more than the 132 files limit
&gt;&gt; (??).
