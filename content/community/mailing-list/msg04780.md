---
title: "Re: Precommit Hook Difficulties"
description: ""
project: community
lastmod: 2011-09-19T11:44:25-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04780"
mailinglist_parent_id: "msg04779"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-09-19T11:44:25-07:00
---


Greg,

Your general approach looks good, and jives with my reading of the
riak\\_object module. Let us know if you still have problems with mochijson2.

Sean

On Mon, Sep 19, 2011 at 1:42 PM, Greg Pascale  wrote:

&gt; Scratch that - the issue doesn't actually manifest without the
&gt; decode/encode.
&gt;
&gt;
&gt; On Mon, Sep 19, 2011 at 10:47 AM, Greg Pascale  wrote:
&gt;
&gt;&gt; Actually it looks like I can remove the JSON decode/encode and I still see
&gt;&gt; the same issue. Just reading and writing the value is enough, so all I'm
&gt;&gt; doing now is
&gt;&gt;
&gt;&gt; \\*precommit(RiakObject) -&gt;\\*
&gt;&gt; \\* Value = riak\\_object:get\\_value(RiakObject),\\*
&gt;&gt; \\* riak\\_object:apply\\_updates(\\*
&gt;&gt; \\* riak\\_object:update\\_value(RiakObject, Value)).\\*
&gt;&gt;
&gt;&gt; I'm really baffled here. The only documentation I know of for this code is
&gt;&gt; at
&gt;&gt; http://basho.github.com/riak-erlang-client/riak-erlang-client/riakc\\_obj.html 
&gt;&gt; and
&gt;&gt; it really doesn't say much.
&gt;&gt;
&gt;&gt; -Greg
&gt;&gt; Clipboard
&gt;&gt;
&gt;&gt; On Sat, Sep 17, 2011 at 4:11 PM, Greg Pascale  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi,
&gt;&gt;&gt;
&gt;&gt;&gt; I'm trying to write a simple precommit hook to modify a JSON object by
&gt;&gt;&gt; removing certain fields. The simplest way to do this, I figure, is to decode
&gt;&gt;&gt; the object's value with mochijson2, remove the fields I don't want,
&gt;&gt;&gt; re-encode it, and update the value.
&gt;&gt;&gt;
&gt;&gt;&gt; What happens, though, is my object ends up somehow mangled. When I
&gt;&gt;&gt; inspect it via curl, it sort of looks like JSON, but characters like "{" and
&gt;&gt;&gt; ":" seem to be replaced with garbage.
&gt;&gt;&gt;
&gt;&gt;&gt; For example, what should read "hostname":"www.google.com" looks like \\*
&gt;&gt;&gt; hostnamea"ja:la"mwww.google.coma"j\\*
&gt;&gt;&gt;
&gt;&gt;&gt; To try to diagnose the issue, I reduced my hook to the simplest possible
&gt;&gt;&gt; case. I don't even modify the JSON, I just decode the object and re-encode
&gt;&gt;&gt; exactly the same value, but I still have the problem. The code is pasted
&gt;&gt;&gt; below
&gt;&gt;&gt;
&gt;&gt;&gt; \\*precommit(RiakObject) -&gt;\\*
&gt;&gt;&gt; \\* Value = riak\\_object:get\\_value(RiakObject),\\*
&gt;&gt;&gt; \\* {struct, TermList} = mochijson2:decode(Value),\\*
&gt;&gt;&gt; \\* riak\\_object:apply\\_updates(\\*
&gt;&gt;&gt; \\* riak\\_object:update\\_value(RiakObject, \\*
&gt;&gt;&gt; \\* mochijson2:encode({struct,
&gt;&gt;&gt; TermList}))).\\*
&gt;&gt;&gt;
&gt;&gt;&gt; Can anybody point out what I'm doing wrong?
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Greg
&gt;&gt;&gt; Clipboard  is 
&gt;&gt;&gt; hiring
&gt;&gt;&gt; !
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Greg
&gt;&gt; Clipboard  is hiring
&gt;&gt; !
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Greg
&gt; Clipboard  is hiring
&gt; !
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

