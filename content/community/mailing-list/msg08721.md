---
title: "Fwd: Reading with \"r = all\" always succeeds in Riak 1.2 even when one	of the primary nodes is down?"
description: ""
project: community
lastmod: 2012-09-26T21:11:18-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08721"
mailinglist_parent_id: "msg08718"
author_name: "Tatsuya Kawano"
project_section: "mailinglistitem"
sent_date: 2012-09-26T21:11:18-07:00
---


I forgot to cc to riak-users.

---------- Forwarded message ----------
From: Tatsuya Kawano 
Date: 2012/9/27
Subject: Re: Reading with "r = all" always succeeds in Riak 1.2 even
when one of the primary nodes is down?
To: Evan Vigil-McClanahan 


Thanks, Evan.

I tried pr=all and verified it failed as expected. I didn't know about
fallback vnode will actively repair objects (I think it's not
documented in Riak Wiki) but now I understand how it works.

- Tatsuya


2012/9/27 Evan Vigil-McClanahan :
&gt; Hi Tatsuya,
&gt;
&gt; Once the fallback ('secondary') vnode has started on another node,
&gt; r=all is going to work again. pr=all shouldn't, though.
&gt;
&gt; On Wed, Sep 26, 2012 at 2:51 PM, Tatsuya Kawano  wrote:
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; I'm having hard time to verify this behavior on the Riak wiki with my
&gt;&gt; Riak 1.2 test environment. Can anybody help me to figure out what is
&gt;&gt; happening?
&gt;&gt;
&gt;&gt;
&gt;&gt; http://wiki.basho.com/Eventual-Consistency.html#Failure-Scenarios
&gt;&gt;
&gt;&gt;&gt; Reading When One Primary Fails
&gt;&gt;&gt; ------------------------------
&gt;&gt;&gt;
&gt;&gt;&gt; 1. Data is written to a key with W=3
&gt;&gt;&gt; 2. One node goes down, it happens to be a primary for that key
&gt;&gt;&gt; 3. Data is read from that key with R=3
&gt;&gt;&gt; 4. Riak returns not\\_found on first request
&gt;&gt;&gt; 5. Read repair ensures data is replicated to a secondary node.
&gt;&gt;&gt; Read repair will always occur, regardless of the R value.
&gt;&gt;&gt; Even with an R of 2, read repair will kick in and ensure that
&gt;&gt;&gt; all nodes responsible for this particular data are consistent.
&gt;&gt;&gt; 6. Subsequent reads return correct value with R=3, two values
&gt;&gt;&gt; coming from primary and one from secondary nodes
&gt;&gt;
&gt;&gt;
&gt;&gt; At the first read (step 4), Riak should return not\\_found, but it
&gt;&gt; actually retuns the correct value. I wonder when read repair will kick
&gt;&gt; in in Riak 1.2. (even before the first read?)
&gt;&gt;
&gt;&gt;
&gt;&gt; I followed the screencast "Tuning CAP Controls in Riak" on this page.
&gt;&gt; http://wiki.basho.com/Tunable-CAP-Controls-in-Riak.html
&gt;&gt;
&gt;&gt; I used riak\\_core\\_ring:preflist/2 to ensure that I had took down one of
&gt;&gt; the correct primary nodes for the key.
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Tatsuya
&gt;&gt;
&gt;&gt; --
&gt;&gt; Tatsuya Kawano (Mr.)
&gt;&gt; Tokyo, Japan

