---
title: "Re: Riak connection pool silent disconnection"
description: ""
project: community
lastmod: 2012-10-11T10:26:31-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08885"
mailinglist_parent_id: "msg08877"
author_name: "Mike Oxford"
project_section: "mailinglistitem"
sent_date: 2012-10-11T10:26:31-07:00
---


I think the key may lie here.... ",{checkout,false,5000}"

Are you releasing your connections back to the pool? Is your throughput
greater than the system can handle due to limited connection pool sizes?
 What is your ulimit set to (ulimit -n) ... maybe you're running out of
FD's?

-mox

On Wed, Oct 10, 2012 at 10:31 PM, Mikhail Kuznetsov &lt;
kuznetsov.m...@gmail.com&gt; wrote:

&gt; I got nasty problem in production. We make connection pool with official
&gt; erlang pb client. Everything works fine. To organize pool we use hottub (we
&gt; try several,but that is simplest). Each connection used at least once in
&gt; 3-5 minutes(production is not full loaded now).
&gt;
&gt; After several days riak server disconnect us. But socket process doesn't
&gt; die, on any request it answers {error, disconnected}. So far I wrote pool
&gt; workers checker, if it is\\_connected(Pid) return not true, we kill worker
&gt; and pool create new one. I fired it every ten minutes. But it didn't help.
&gt; It return true, but then I am making request I get {error, disconnected}.
&gt; Only solution that work so far is pool full reinit if some worker return
&gt; {error, disconnected}. It is very barbaric and may crash whole app.
&gt;
&gt; When I checked server logs I found many errors like this two: 2012-09-20
&gt; 00:10:10.976 [error] &lt;0.803.0&gt;@riak\\_core\\_vnode:handle\\_info:510
&gt; 296867520082839655260123481645494988367611297792 riak\\_kv\\_vnode worker pool
&gt; crashed
&gt; {timeout,{gen\\_server,call,[&lt;0.819.0&gt;,{work,&lt;0.806.0&gt;,{fold,#Fun,#Fun},{raw,59205031,&lt;0.28969.11&gt;}}]}}
&gt; 2012-09-20 00:10:10.976 [error] &lt;0.862.0&gt;@riak\\_core\\_vnode:handle\\_info:510
&gt; 365375409332725729550921208179070754913983135744 riak\\_kv\\_vnode worker pool
&gt; crashed
&gt; {timeout,{gen\\_fsm,sync\\_send\\_event,[&lt;0.866.0&gt;,{checkout,false,5000},5000]}}
&gt;
&gt; I guess that is real problem, but I think client connection should at
&gt; least log something, get connection problem failures list or die. I got
&gt; is\\_connected(Pid) = true
&gt;
&gt; How are you organizing connection pools which work 24/7? How you check
&gt; pool workers or refresh them?
&gt;
&gt;
&gt;

