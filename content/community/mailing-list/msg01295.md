---
title: "Re: Question on the symptoms of Ticket 260"
description: ""
project: community
lastmod: 2010-10-14T16:04:44-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01295"
mailinglist_parent_id: "msg01290"
author_name: "scott clasen"
project_section: "mailinglistitem"
sent_date: 2010-10-14T16:04:44-07:00
---


Hi Dan-

Here is a test case, strangely it passes the first time that is run
then fails all subsequent runs....running it would require
scala,scalatest,the riak-java-pb-client and the protobuf jars.

My guess is that it is vector clock related at this point, but looking
through the code to the riak-java-pb-client, there is no way to set
the vector clock when creating a new RiakObject or set a new value on
a RiakObject retrieved from the server.


--SNIP--
import com.trifork.riak.{RiakClient, RequestMeta, RiakObject}
import org.scalatest.matchers.ShouldMatchers
import org.scalatest.Spec


class RiakConsistencyTest extends Spec with ShouldMatchers {
 describe("the consistency issue I see") {
 it("is demonstrated by the failure of the following tests") {
 val riakClient = new RiakClient("localhost");
 import com.google.protobuf.ByteString.\\_
 val maps = copyFromUtf8("Maps")
 val key = copyFromUtf8("key");
 val otherkey = copyFromUtf8("otherkey")
 val value = copyFromUtf8("value")
 val x = copyFromUtf8("x")
 val quorum = 0xfffffffd
 val meta = new RequestMeta().w(quorum).dw(quorum)
 riakClient.store(new RiakObject(maps, key, otherkey), meta)
 riakClient.store(new RiakObject(maps, otherkey, value), meta)
 riakClient.fetch(maps, key, quorum)(0).getValue.toStringUtf8
should be (otherkey.toStringUtf8)
 riakClient.fetch(maps, otherkey)(0).getValue.toStringUtf8 should
be(value.toStringUtf8)
 riakClient.delete(maps, otherkey)
 riakClient.store(new RiakObject(maps, key, x), meta)
 riakClient.fetch(maps, otherkey, quorum).size should be(0)
 riakClient.fetch(maps, key, quorum)(0).getValue.toStringUtf8
should be (x.toStringUtf8) //Fails here
 }
 }

}

--SNIP--
"otherkey" was not equal to "x"
org.scalatest.TestFailedException: "otherkey" was not equal to "x"
 at 
org.scalatest.matchers.Matchers$class.newTestFailedException(Matchers.scala:148)
 at 
RiakConsistencyTest.newTestFailedException(RiakConsistencyTest.scala:6)
 at 
org.scalatest.matchers.ShouldMatchers$ShouldMethodHelper$.shouldMatcher(ShouldMatchers.scala:871)
 at 
org.scalatest.matchers.ShouldMatchers$StringShouldWrapper.should(ShouldMatchers.scala:1081)
 at 
RiakConsistencyTest$$anonfun$1$$anonfun$apply$mcV$sp$1.apply$mcV$sp(RiakConsistencyTest.scala:25)
 at 
RiakConsistencyTest$$anonfun$1$$anonfun$apply$mcV$sp$1.apply(RiakConsistencyTest.scala:8)
 at 
RiakConsistencyTest$$anonfun$1$$anonfun$apply$mcV$sp$1.apply(RiakConsistencyTest.scala:8)
 at org.scalatest.Spec$$anon$2.apply(Spec.scala:1388)

On Thu, Oct 14, 2010 at 10:11 AM, Scott Clasen  wrote:
&gt; Hi Dan-
&gt; It is a single client, with no other clients connected to riak.
&gt; It is really deletes that seem to be missed/lagging, and deletes don't take
&gt; a vector clock?
&gt; Pseudocode is something like this...all keys and values are raw bytes
&gt; wrapped in protobuf bytestring
&gt; Store(bucket,key,value)
&gt; Store(bucket,key2,key)
&gt; Fetch(bucket,key) // properly returns value
&gt; Delete(bucket,key)
&gt; Delete(bucket,key2)
&gt; Fetch(bucket,key) //properly returns null
&gt; Store(bucket,key,value)
&gt; Store(bucket,key2,key)
&gt; Fetch(bucket,key) // properly returns value
&gt; Delete(bucket,key)
&gt; Delete(bucket,key2)
&gt; Fetch(bucket,key) // !!!incorrectly returns value instead of null
&gt; The correct value is returned if I have breakpoints set that effectively
&gt; give some wait time between the last delete and fetch.
&gt;
&gt; I will code up a simplified test case tonight, maybe it will reveal an error
&gt; on my side.
&gt; Thanks
&gt; Sent from my iPhone
&gt; On Oct 13, 2010, at 9:21 PM, Dan Reverri  wrote:
&gt;
&gt; Hi SC,
&gt; If a single client is writing to a single key with read and write quorums
&gt; your reads should reflect your writes. Are other clients updating the same
&gt; key concurrently? Are you updating the values with the correct vclock? Would
&gt; it be possible to provide a minimal test case that reproduces the issue?
&gt; Thanks,
&gt; Dan
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt; On Wed, Oct 13, 2010 at 5:07 PM, scott clasen 
&gt; wrote:
&gt;&gt;
&gt;&gt; Hi-
&gt;&gt;
&gt;&gt;    I am writing a Riak backend for Akka's persistent data structures,
&gt;&gt; and am running into what looks like behavior similar to what is
&gt;&gt; mentioned in this ticket.
&gt;&gt;
&gt;&gt; https://issues.basho.com/show\\_bug.cgi?id=260  which says---&gt;
&gt;&gt;
&gt;&gt; In cases where objects are rapidly updated and deleted, unpredictable
&gt;&gt; behavior
&gt;&gt; seems to occur due to race conditions.  Exposing tombstones to the client
&gt;&gt; when
&gt;&gt; allow\\_mult is true would allow resolution of the conflict that is normally
&gt;&gt; hidden from the user. This will require the client who is interested in
&gt;&gt; resolving delete+update conflicts to submit the vclock when performing the
&gt;&gt; delete.
&gt;&gt;
&gt;&gt; This is on a single riak instance 0.13.0, on OS X, installed via 'brew
&gt;&gt; install riak', w
&gt;&gt;
&gt;&gt; The behavior I am seeing is in a single threaded test that rapidly
&gt;&gt; inserts, updates and deletes the value for a single key in a single
&gt;&gt; bucket.
&gt;&gt;
&gt;&gt; This is using the protobuf interface, via the riak-java-pb-client.
&gt;&gt; All reads use quorum, and all writes use quorum and durableWrite
&gt;&gt; quorum as well.
&gt;&gt;
&gt;&gt; Running the tests outside the debugger cause test failures because the
&gt;&gt; reads are not seeing the latest write/delete
&gt;&gt;
&gt;&gt; When I run the tests in debug mode, with breakpoints set to watch the
&gt;&gt; values returned from riak, the tests pass.
&gt;&gt;
&gt;&gt; This makes me think there is some race condition like the one
&gt;&gt; mentioned in ticket 260 occurring. Although it could certainly be user
&gt;&gt; error  ;).
&gt;&gt;
&gt;&gt; Other than the default config, I have tried fiddling with
&gt;&gt; last\\_write\\_wins and allow\\_multi but no combination of those seem to
&gt;&gt; help.
&gt;&gt;
&gt;&gt; Is there anything I am missing, or any configuration or code that can
&gt;&gt; give me a consistent view?
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt; SC
&gt;
&gt;

