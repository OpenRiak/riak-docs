---
title: "Re: What ever happened to delete support for post-commit hooks?"
description: ""
project: community
lastmod: 2012-09-18T12:26:17-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08586"
mailinglist_parent_id: "msg08580"
author_name: "David Goehrig"
project_section: "mailinglistitem"
sent_date: 2012-09-18T12:26:17-07:00
---


I discovered what the behavior change is and it was subtleâ€¦

Suppose you populated a value in the bucket:

 curl -X PUT http://localhost:8098/riak/test/foobar -d '{"foo":"bar"}'

In the 0.14.0 release if you did a curl -X DELETE 
http://localhost:8098/riak/test/foobar you could do:

 ObjectJSON = riak\\_object:get\\_value(Object),
 O = mochijson2:decode(ObjectJSON),

you would get ObjectJSON with the contents of the deleted object:

 ObjectJSON = &lt;&lt;"{"foo":"bar"}"&gt;&gt;
 O = {struct,[{&lt;&lt;"foo"&gt;&gt;,&lt;&lt;"bar"&gt;&gt;}]}

In 1.2, if you did the same thing, however, you'd get the following:

 ObjectJSON = &lt;&lt;&gt;&gt;

And mochijson2:decode will blow up trying to decode the empty object

 \\*\\* exception error: no match of right hand side value any
 in function mochijson2:tokenize/2 (src/mochijson2.erl, line 556)
 in call from mochijson2:decode1/2 (src/mochijson2.erl, line 312)
 in call from mochijson2:json\\_decode/2 (src/mochijson2.erl, line 
307)

So while the documentation is technically true, the behavior on the post-commit 
hook changed substantially in the case of DELETE.

In our hook's case, this change was very significant as we were inspecting the 
contents of the deleted object to update cache objects in other buckets.

It definitely makes life more difficult not knowing the contents of the deleted 
object :)

Dave

On Sep 18, 2012, at 1:16 AM, Jon Meredith wrote:

&gt; That's odd. It should still be firing. 
&gt; 
&gt; Are you seeing any increase in the postcommit\\_fail stats? It may spew a lot 
&gt; of logging at you, but you could enable debug logging to see if it is being 
&gt; fired or not.
&gt; 
&gt; lager:set\\_loglevel(lager\\_file\\_backend, "console.log", debug).
&gt; 
&gt; To reset back to info
&gt; 
&gt; lager:set\\_loglevel(lager\\_file\\_backend, "console.log", info).
&gt; 
&gt; Please let us know what you find.
&gt; 
&gt; Jon.
&gt; 
&gt; On Mon, Sep 17, 2012 at 12:52 PM, David Goehrig  
&gt; wrote:
&gt; Many moons ago (circa 0.14.0) when you did a curl -X DELETE to a riak bucket 
&gt; with a post commit hook it would be invoked and you could use the 
&gt; X-Riak-Deleted tag to process the file. I have just such a post commit hook 
&gt; running on on a 0.14.0 build. 
&gt; 
&gt; We recently looked at upgrading to 1.2, but discovered that our post commit 
&gt; hooks were no longer being fired at all on DELETE, only POST and PUT. 
&gt; Looking through the offending bits of the code, it looks like the entire hook 
&gt; invocation subsystem was rewritten since 0.14.0, but the documentation wiki: 
&gt; http://wiki.basho.com/Commit-Hooks.html#Post-Commit-Hooks
&gt; 
&gt; Still states that:
&gt; 
&gt; As with pre-commit hooks, deletes are considered writes so post-commit hook 
&gt; functions will need to inspect object metadata for the presence of 
&gt; X-Riak-Deleted to determine when a delete has occurred. 
&gt; 
&gt; Any idea why this would no longer be true?
&gt; 
&gt; Dave
&gt; 
 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Jon Meredith
&gt; Platform Engineering Manager
&gt; Basho Technologies, Inc.
&gt; jmered...@basho.com
&gt; 

