---
title: "Re: Riak crashing with {lucene_parse,\"syntax error before: \"AND\"\"}"
description: ""
project: community
lastmod: 2011-11-09T14:55:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05524"
mailinglist_parent_id: "msg05457"
author_name: "Spike Gronim"
project_section: "mailinglistitem"
sent_date: 2011-11-09T14:55:10-08:00
---

One of my Riak servers died again. I think the previously linked crash report 
was not what made it die. Now no erlang OS processes are running on the machine 
at all. This cluster is entirely idle except I am running search queries on it. 
The other 3 servers are up and happy. Here are some log messages:

https://gist.github.com/e92f8d32538a0057890b

On Nov 7, 2011, at 11:35 AM, Ryan Zezeski wrote:

Hi Spike,

After decoding your msg it looks like your query is simply 'AND'. The parser 
barfs at this as it expects terms on both sides of the AND and this causes the 
the listener for that particular connection to go down. No other connections 
should be affected. Since the query is parsed on the server there's not a 
whole lot you can do if a malformed query is sent. If these are generated/user 
input queries then perhaps you could create a black list (in your application) 
for common bad queries that come in. Also, if your client supports connection 
pooling that would help too.

-Ryan

On Mon, Nov 7, 2011 at 1:04 PM, Spike Gronim 
&gt; wrote:
Hello,

My Riak servers are misbehaving when users enter invalid queries. The 
gen\\_server erlang process for the PB transport dies but the overall OS level 
process is still alive. I am exclusively using PB to access Riak, so everything 
grinds to a halt. I plan to work around this by writing a Riak nanny that 
verifies that somebody is listening on the PB port every 60s, but I think that 
this is actually a bug in Riak. I have tried to find other references to this 
bug in the mailing list archive and bugzilla but haven't found any. If this is 
really a bug I will write up a more detailed repro in bugzilla. Thanks.


Crash report: https://gist.github.com/82eaaa8fa8a994999872

Spike Gronim
sp...@wavii.com


Spike Gronim
sp...@wavii.com

