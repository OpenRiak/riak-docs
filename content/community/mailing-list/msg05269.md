---
title: "Re: Key Filter Timeout"
description: ""
project: community
lastmod: 2011-10-24T07:52:24-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05269"
author_name: "Mark Steele"
project_section: "mailinglistitem"
sent_date: 2011-10-24T07:52:24-07:00
---


It was a pretty simple benchmark test using a custom built protocol buffer 
client, so I wouldn't put too much faith in it.

As far as performance, my client was able to retrieve keys at a rate of about 
120 thousand keys per second from the key listing operation. The key listing 
performance was constant, my testing went from 1 million keys stored to 60 
million with very little variation in throughput. 

I guess the mantra is: Test test test test with your app, YMMV

Cheers,

Mark


On Monday 24 October 2011 07:37:47 Jim Adler wrote:
&gt; Yes, using 1.0.1 with LevelDB. I moved to it from Bitcask in the hopes of 
&gt; better performance.
&gt; 
&gt; Good to hear about your 60M key use-case. Can you share any key access 
&gt; performance numbers?
&gt; 
&gt; Jim
&gt; 
&gt; On Oct 24, 2011, at 7:23 AM, Mark Steele  wrote:
&gt; 
&gt; &gt; Just curious Kyle, you using the 1.0 series?
&gt; &gt; 
&gt; &gt; I've done some informal testing on a 3 node 1.0 cluster and key listing was 
&gt; &gt; working just peachy on 60 million keys using bitcask as the backend.
&gt; &gt; 
&gt; &gt; Cheers,
&gt; &gt; 
&gt; &gt; Mark
&gt; &gt; 
&gt; &gt; On Sunday 23 October 2011 12:26:35 Aphyr wrote:
&gt; &gt;&gt; On 10/23/2011 12:11 PM, Jim Adler wrote:
&gt; &gt;&gt;&gt; I will be loosening the key filter criterion after I get the basics
&gt; &gt;&gt;&gt; working, which I thought would be a simple equality check. 8M keys
&gt; &gt;&gt;&gt; isn't really a large data set, is it? I thought that keys were stored
&gt; &gt;&gt;&gt; in memory and key filters just operated on those memory keys and not
&gt; &gt;&gt;&gt; data.
&gt; &gt;&gt;&gt; 
&gt; &gt;&gt;&gt; Jim
&gt; &gt;&gt; 
&gt; &gt;&gt; That's about where we started seeing timeouts in list-keys. Around 25
&gt; &gt;&gt; million keys, list-keys started to take down the cluster. (6 nodes, 1024
&gt; &gt;&gt; partitions). You may not encounter these problems, but were I in your
&gt; &gt;&gt; position and planning to grow... I would prepare to stop using key
&gt; &gt;&gt; filters, bucket listing, and key listing early.
&gt; &gt;&gt; 
&gt; &gt;&gt; Our current strategy is to store the keys in Redis, and synchronize them
&gt; &gt;&gt; with post-commit hooks and a process that reads over bitcask. With
&gt; &gt;&gt; ionice 3, it's fairly low-impact. https://github.com/aphyr/bitcask-ruby
&gt; &gt;&gt; may be useful.
&gt; &gt;&gt; 
&gt; &gt;&gt; --Kyle
&gt; &gt;&gt; 
&gt; &gt;&gt; # Simplified code, extracted from our bitcask scanner:
&gt; &gt;&gt; def run
&gt; &gt;&gt; `renice 10 #{Process.pid}`
&gt; &gt;&gt; `ionice -c 3 -p #{Process.pid}`
&gt; &gt;&gt; 
&gt; &gt;&gt; begin
&gt; &gt;&gt; bitcasks\\_dir = '/var/lib/riak/bitcask'
&gt; &gt;&gt; dirs = Dir.entries(bitcasks\\_dir).select do |dir|
&gt; &gt;&gt; dir =~ /^\\d+$/
&gt; &gt;&gt; end.map do |dir|
&gt; &gt;&gt; File.join(bitcasks\\_dir, dir)
&gt; &gt;&gt; end
&gt; &gt;&gt; 
&gt; &gt;&gt; dirs.each do |dir|
&gt; &gt;&gt; scan dir
&gt; &gt;&gt; GC.start
&gt; &gt;&gt; end
&gt; &gt;&gt; log.info "Completed run"
&gt; &gt;&gt; rescue =&gt; e
&gt; &gt;&gt; log.error "#{e}\\n#{e.backtrace.join "\\n"}"
&gt; &gt;&gt; sleep 10
&gt; &gt;&gt; end
&gt; &gt;&gt; end
&gt; &gt;&gt; end
&gt; &gt;&gt; 
&gt; &gt;&gt; def scan(dir)
&gt; &gt;&gt; log.info "Loading #{dir}"
&gt; &gt;&gt; b = Bitcask.new dir
&gt; &gt;&gt; b.load
&gt; &gt;&gt; 
&gt; &gt;&gt; log.info "Updating #{dir}"
&gt; &gt;&gt; b.keydir.each do |key, e|
&gt; &gt;&gt; bucket, key = BERT.decode(key).map { |x|
&gt; &gt;&gt; Rack::Utils.unescape x
&gt; &gt;&gt; }
&gt; &gt;&gt; # Handle determines what to do with this particular bucket/key
&gt; &gt;&gt; # combo; e.g. insert into redis.
&gt; &gt;&gt; handle bucket, key, e
&gt; &gt;&gt; end
&gt; &gt;&gt; end
&gt; &gt;&gt; 
&gt; &gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt;&gt; riak-users mailing list
&gt; &gt;&gt; riak-users@lists.basho.com
&gt; &gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; 

