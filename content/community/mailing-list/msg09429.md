---
title: "Re: Riak search query timeout issues with 1.2.1 stable"
description: ""
project: community
lastmod: 2012-12-05T06:39:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09429"
mailinglist_parent_id: "msg09428"
author_name: "Abhinav Singh"
project_section: "mailinglistitem"
sent_date: 2012-12-05T06:39:10-08:00
---


To add a missing information to this question:

The query never timeout if we remove "AND tags:(message)" part from it 
i.e. a simple query like the one below always succeed. 

/select?wt=json&q=to:733d5cb23129734585af7b9fe16b1bbc5daa5b5c

However, as soon as we add AND operator to the query, it starts to timeout.
Also we observed, if there are no documents in the bucket, timeout never 
happens even with AND operator,
but as soon as we add even a single document in the bucket, query starts timing 
out.

Also, we observed that a simple query lookup over tags only is still timing out:

/select?wt=json&q=tags:message ---&gt; gives us the following response:

The server encountered an error while processing this request:
{error,
 {error,
 {case\\_clause,
 {{badfun,#Fun},
 [{mi\\_server,iterate,6,[{file,"src/mi\\_server.erl"},{line,657}]},
 {mi\\_server,lookup,8,[{file,"src/mi\\_server.erl"},{line,632}]}]}},
 [{riak\\_search\\_client,search\\_doc,8,
 [{file,"src/riak\\_search\\_client.erl"},{line,165}]},
 {riak\\_search\\_utils,run\\_query,7,
 [{file,"src/riak\\_search\\_utils.erl"},{line,283}]},
 {riak\\_solr\\_searcher\\_wm,to\\_json,2,
 [{file,"src/riak\\_solr\\_searcher\\_wm.erl"},{line,120}]},
 {webmachine\\_resource,resource\\_call,3,
 [{file,"src/webmachine\\_resource.erl"},{line,169}]},
 {webmachine\\_resource,do,3,
 [{file,"src/webmachine\\_resource.erl"},{line,128}]},
 {webmachine\\_decision\\_core,resource\\_call,1,
 [{file,"src/webmachine\\_decision\\_core.erl"},{line,48}]},
 {webmachine\\_decision\\_core,decision,1,
 [{file,"src/webmachine\\_decision\\_core.erl"},{line,532}]},
 {webmachine\\_decision\\_core,handle\\_request,2,
 [{file,"src/webmachine\\_decision\\_core.erl"},{line,33}]}]}}
Any help or pointers in the right direction will be greatly appreciated.
--
Abhinav Singh
http://abhinavsingh.com/

On 05-Dec-2012, at 6:40 PM, Abhinav Singh  wrote:

&gt; Hello Everyone,
&gt; 
&gt; We are facing an issue where search queries works fine on my local dev box 
&gt; (which have riak-1.2.1rc2 installed).
&gt; However same queries timeout on our production boxes (which have riak-1.2.1 
&gt; installed):
&gt; 
&gt; QUERY:
&gt; /select?wt=json&q=to:733d5cb23129734585af7b9fe16b1bbc5daa5b5c AND 
&gt; tags:(message)
&gt; 
&gt; RESPONSE:
&gt; {error,{error,{case\\_clause,timeout},
&gt; [{riak\\_search\\_client,search\\_doc,8},
&gt; {riak\\_search\\_utils,run\\_query,7},
&gt; {riak\\_solr\\_searcher\\_wm,to\\_json,2},
&gt; {webmachine\\_resource,resource\\_call,3},
&gt; {webmachine\\_resource,do,3},
&gt; {webmachine\\_decision\\_core,resource\\_call,1},
&gt; {webmachine\\_decision\\_core,decision,1},
&gt; {webmachine\\_decision\\_core,handle\\_request,2}]}}
&gt; Here are the logs as seen inside riak error.log file:
&gt; 
&gt; 2012-12-05 14:49:59.777 [error] &lt;0.1035.0&gt;@mi\\_server:handle\\_info:524 
&gt; lookup/range failure: 
&gt; {{badfun,#Fun},[{mi\\_server,iterate,6},{mi\\_server,lookup,8}]}
&gt; 2012-12-05 14:49:59.777 [error] emulator Error in process &lt;0.17345.11&gt; on 
&gt; node 'riak@172.17.3.82' with exit value: 
&gt; {{badfun,#Fun},[{mi\\_server,iterate,6},{mi\\_server,lookup,8}]}
&gt; 2012-12-05 14:50:58.321 [error] &lt;0.15946.11&gt; webmachine error: 
&gt; path="/solr/ejabberd\\_doc/select"
&gt; {error,{error,{case\\_clause,timeout},[{riak\\_search\\_client,search\\_doc,8},{riak\\_search\\_utils,run\\_query,7},{riak\\_solr\\_searcher\\_wm,to\\_json,2},{webmachine\\_resource,resource\\_call,3},{webmachine\\_resource,do,3},{webmachine\\_decision\\_core,resource\\_call,1},{webmachine\\_decision\\_core,decision,1},{webmachine\\_decision\\_core,handle\\_request,2}]}}
&gt; 
&gt; This query does succeed sometimes (1-5%), but fails most of the times.
&gt; I want to know if the above logs indicate towards a particular error with our 
&gt; riak cluster?
&gt; 
&gt; Since this query has never failed on my local development box, 
&gt; I suspect either it has to do with something that changed between 1.2.1rc2 
&gt; and 1.2.1-stable release or something that is related to our production riak 
&gt; cluster.
&gt; 
&gt; Feedback and help is greatly appreciated. Thanks in advance.
&gt; 
&gt; --
&gt; Abhinav Singh
&gt; http://abhinavsingh.com/

