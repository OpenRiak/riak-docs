---
title: "Re: Link walking with a java client"
description: ""
project: community
lastmod: 2012-05-27T06:20:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07545"
author_name: "Deepak Balasubramanyam"
project_section: "mailinglistitem"
sent_date: 2012-05-27T06:20:16-07:00
---


This looks like a bug. The code to walk links via a HTTP client
works perfectly. The same code fails when the PB client is used. The POJO
attached in this email reproduces the problem.

I searched the email archives and existing issues and found no trace of
this problem. Please run the POJO by swapping the clients returned from the
getClient() method to reproduce the problem. I can create a bug report once
someone from the dev team confirms this really is a bug.

Riak client pom:
 
com.basho.riak
riak-client
1.0.5


Riak server version - 1.1.2. Built from source.
4 nodes running on 1 machine. OS - Linux mint.

On Sun, May 27, 2012 at 10:05 AM, Deepak Balasubramanyam &lt;
deepak.b...@gmail.com&gt; wrote:

&gt; Hi,
&gt;
&gt; I have a cluster that contains 2 buckets. A bucket named 'usersMine'
&gt; contains the key 'user2', which is linked to several keys (about 10) under
&gt; a bucket named userPreferences. The relationship exists under the name
&gt; 'myPref'. A user and a preference have String values.
&gt;
&gt; I can successfully traverse the link over HTTP using the following URL -
&gt;
&gt; curl -v localhost:8091/riak/usersMine/user2/\\_,myPref,1
&gt;
&gt; ------------------------ ------------------------ ------------------------
&gt; &gt; User-Agent: curl/7.21.6 (i686-pc-linux-gnu) libcurl/7.21.6
&gt; OpenSSL/1.0.0e zlib/1.2.3.4 libidn/1.22 librtmp/2.3
&gt; &gt; Host: localhost:8091
&gt; &gt; Accept: \\*/\\*
&gt; &gt;
&gt; &lt; HTTP/1.1 200 OK
&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt; &lt; Expires: Sun, 27 May 2012 04:12:39 GMT
&gt; &lt; Date: Sun, 27 May 2012 04:02:39 GMT
&gt; &lt; Content-Type: multipart/mixed; boundary=IYGfKNqjGdco9ddfyjRP1Utzfi2
&gt; &lt; Content-Length: 3271
&gt; &lt;
&gt;
&gt; --IYGfKNqjGdco9ddfyjRP1Utzfi2
&gt; Content-Type: multipart/mixed; boundary=3YVES0x2tFnUDOdTzfn1OGS6uMt
&gt;
&gt; --3YVES0x2tFnUDOdTzfn1OGS6uMt
&gt; X-Riak-Vclock: a85hYGBgzGDKBVIcMRuuc/nvy7mSwZTImMfKUKpodpIvCwA=
&gt; Location: /riak/userPreferences/preference3004
&gt; Content-Type: text/plain; charset=UTF-8
&gt; Link: ; rel="up"
&gt; Etag: 5GucnGSk4TjQc8BO1eNLyI
&gt; Last-Modified: Sun, 27 May 2012 03:54:29 GMT
&gt;
&gt; junk
&gt;
&gt; &lt;&lt; ------------------------ Truncated ------------------------ &gt;&gt;
&gt; junk
&gt; --3YVES0x2tFnUDOdTzfn1OGS6uMt--
&gt;
&gt; --IYGfKNqjGdco9ddfyjRP1Utzfi2--
&gt; ------------------------ ------------------------ ------------------------
&gt;
&gt; However when I use the java client to walk the link, I get a
&gt; ClassCastException.
&gt;
&gt; ------------------------ ------------------------ ------------------------
&gt; Java code:
&gt; ------------------------ ------------------------ ------------------------
&gt; private void getAllLinks()
&gt; {
&gt; String user="user2";
&gt; IRiakClient riakClient = null;
&gt; try
&gt; {
&gt; long past = System.currentTimeMillis();
&gt; riakClient = RiakFactory.pbcClient("localhost",8081);
&gt; Bucket userBucket =
&gt; riakClient.fetchBucket("usersMine").execute();
&gt; DefaultRiakObject user1 =(DefaultRiakObject)
&gt; userBucket.fetch(user).execute();
&gt; List links = user1.getLinks();
&gt; System.out.println(links.size());
&gt; WalkResult execute =
&gt; riakClient.walk(user1).addStep("userPreferences", "myPref",true).execute();
&gt; Iterator iterator = execute.iterator();
&gt; while(iterator.hasNext())
&gt; {
&gt; Object next = iterator.next();
&gt; System.out.println(next);
&gt; }
&gt; long now = System.currentTimeMillis();
&gt; System.out.println("Retrieval in " + (now-past) + " ms");
&gt; }
&gt; catch (Exception e)
&gt; {
&gt; e.printStackTrace();
&gt; }
&gt; finally
&gt; {
&gt; if(riakClient != null)
&gt; {
&gt; riakClient.shutdown();
&gt; }
&gt; }
&gt; }
&gt;
&gt; ------------------------ ------------------------ ------------------------
&gt; Stack:
&gt; ------------------------ ------------------------ ------------------------
&gt; java.lang.ClassCastException: java.lang.String cannot be cast to
&gt; java.util.List
&gt; at
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.linkWalkSecondPhase(PBClientAdapter.java:380)
&gt; at
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.linkWalk(PBClientAdapter.java:325)
&gt; at com.basho.riak.client.query.LinkWalk.execute(LinkWalk.java:63)
&gt; at com.chatterbox.persistence.riak.RiakTest.getAllLinks(RiakTest.java:81)
&gt; at com.chatterbox.persistence.riak.RiakTest.main(RiakTest.java:25)
&gt; ------------------------ ------------------------ ------------------------
&gt;
&gt; At line 380 on PBClientAdapter, an enhanced for loop attempts to iterate
&gt; over a Collection&gt; while the actual value is a List.
&gt; This causes the exception. The value of the variable 'step' at the time of
&gt; the exception is [userPreferences, preference3000, myPref].
&gt;
&gt; Am i doing something wrong ? The java code retrieves links in a fashion
&gt; that is similar to the HTTP retrieval, so I am puzzled by the ClassCast.
&gt;
&gt; Thanks
&gt; Deepak
&gt;


RiakTest.java
Description: Binary data
