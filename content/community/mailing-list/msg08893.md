---
title: "Re: Re: Riak performance problems when LevelDB database grows beyond 16GB"
description: ""
project: community
lastmod: 2012-10-12T05:02:45-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08893"
mailinglist_parent_id: "msg08887"
author_name: "Jan.Evangelista"
project_section: "mailinglistitem"
sent_date: 2012-10-12T05:02:45-07:00
---


&gt; Can you attach the eleveldb portion of your app.config file?
&gt; Configuration problems, especially max\\_open\\_files being too low, can
&gt; often cause issues like this.
&gt;
&gt; If it isn't sensitive, the whole app.config and vm.args files are also
&gt; often helpful.

Hello Evan,

thanks for responding.

I originally had default LevelDB settings. When the node stalled, I changed it
 to

 {eleveldb, [
 {data\\_root, "/home/riak/leveldb"},
 {max\\_open\\_files, 132},
 {cache\\_size, 377487360}
 ]},

on all nodes and I restarted them all. The application started to run with 
about 1000 requests/second, after about 1 minute it dropped to &lt;500 
requests/second, and the node stalled again after 41 minutes. BTW according to
 lsof(1) it had 267 open LevelDB files which is more than the 132 files limit 
(??).

Here is the configuration (with comments removed to work around 40 KB message 
limit on the Riak users list).

/etc/riak/vm.args:

-name riak@172.16.0.2
-setcookie riak\\_0627f0bc6c9
+K true
+A 64
+W w
-env ERL\\_MAX\\_PORTS 4096
-env ERL\\_FULLSWEEP\\_AFTER 0
-env ERL\\_CRASH\\_DUMP /var/log/riak/erl\\_crash.dump
-env ERL\\_MAX\\_ETS\\_TABLES 8192

/etc/riak/app.config:

[
 {riak\\_api, [
 {pb\\_ip, "172.16.0.2" },
 {pb\\_port, 8087 }
 ]},
 {riak\\_core, [
 {ring\\_state\\_dir, "/var/lib/riak/ring"},
 %{ring\\_creation\\_size, 64},
 {http, [ {"127.0.0.1", 8098 } ]},
 %{https, [{ "127.0.0.1", 8098 }]},
 %{ssl, [
 % {certfile, "/etc/riak/cert.pem"},
 % {keyfile, "/etc/riak/key.pem"}
 % ]},
 {handoff\\_port, 8099 },
 %{handoff\\_ssl\\_options, [{certfile, "/tmp/erlserver.pem"}]},
 {dtrace\\_support, false},
 {platform\\_bin\\_dir, "/usr/sbin"},
 {platform\\_data\\_dir, "/var/lib/riak"},
 {platform\\_etc\\_dir, "/etc/riak"},
 {platform\\_lib\\_dir, "/usr/lib/riak/lib"},
 {platform\\_log\\_dir, "/var/log/riak"}
 ]},
 {riak\\_kv, [
 {add\\_paths, 
["/usr/local/share/riak-mapred/riak-1.2.0/deps/greylisting/ebin/"]},
 {storage\\_backend, riak\\_kv\\_eleveldb\\_backend},
 %{raw\\_name, "riak"},
 {mapred\\_name, "mapred"},
 {mapred\\_system, pipe},
 {mapred\\_2i\\_pipe, true},
 {map\\_js\\_vm\\_count, 8 },
 {reduce\\_js\\_vm\\_count, 6 },
 {hook\\_js\\_vm\\_count, 2 },
 {js\\_max\\_vm\\_mem, 8},
 {js\\_thread\\_stack, 16},
 %{js\\_source\\_dir, "/tmp/js\\_source"},
 {http\\_url\\_encoding, on},
 {vnode\\_vclocks, true},
 {legacy\\_keylisting, false},
 {listkeys\\_backpressure, true}
 ]},
 {riak\\_search, [
 {enabled, false}
 ]},
 {merge\\_index, [
 {data\\_root, "/var/lib/riak/merge\\_index"},
 {buffer\\_rollover\\_size, 1048576},
 {max\\_compact\\_segments, 20}
 ]},
 {bitcask, [
 {data\\_root, "/var/lib/riak/bitcask"}
 ]},
 {eleveldb, [
 {data\\_root, "/home/riak/leveldb"},
 {max\\_open\\_files, 132},
 {cache\\_size, 377487360}
 ]},
 {lager, [
 {handlers, [
 {lager\\_console\\_backend, info},
 {lager\\_file\\_backend, [
 {"/var/log/riak/error.log", error, 10485760, "$D0", 5},
 {"/var/log/riak/console.log", info, 10485760, "$D0", 5}
 ]}
 ]},
 {crash\\_log, "/var/log/riak/crash.log"},
 {crash\\_log\\_msg\\_size, 65536},
 {crash\\_log\\_size, 10485760},
 {crash\\_log\\_date, "$D0"},
 {crash\\_log\\_count, 5},
 {error\\_logger\\_redirect, true}
 ]},
 {riak\\_sysmon, [
 {process\\_limit, 30},
 {port\\_limit, 2},
 {gc\\_ms\\_limit, 100},
 {heap\\_word\\_limit, 40111000},
 {busy\\_port, true},
 {busy\\_dist\\_port, true}
 ]},
 {sasl, [
 {sasl\\_error\\_logger, false}
 ]},
 {riak\\_control, [
 {enabled, false},
 {auth, userlist},
 {userlist, [{"user", "pass"}
 ]},
 {admin, true}
 ]}
].

Thanks.
--
Jan

