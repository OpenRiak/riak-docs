---
title: "Re: Join a Riak-1.0 node to a Riak-0.14 cluster"
description: ""
project: community
lastmod: 2011-10-24T12:05:36-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05275"
mailinglist_parent_id: "msg05273"
author_name: "Mark Smith"
project_section: "mailinglistitem"
sent_date: 2011-10-24T12:05:36-07:00
---


Important: Removing/leaving a node from the cluster does NOT automatically 
replicate the data that was on that node to get back up to your desired 
replication level. 

Right now, the suggested method for doing that involves invoking a read on all 
of the keys that were on that node. This forces a read-repair which will cause 
the data to replicate out to nodes that are still alive and in the cluster. 
Something like this:
Do a list-keys on the node you intend to remove, save this file.
Remove the node to be decommissioned.
Add a new node.
Issue a read on every key from the list you created.


However, the list-keys method in 1.0 is not complete if you have lost a node. 
It requires all nodes to be up and running. Effectively, there is no way right 
now to guarantee your replication level on your data in case of a node 
failure/unexpected removal.

This is supposed to be addressed in 1.1:

 https://issues.basho.com/show\\_bug.cgi?id=991

Also, fwiw, this information came out of a ticket Bump had with Basho to try to 
understand this better. I may be misquoting, and if so, I hope Sean or someone 
will step in and correct me. :)


-- 
Mark Smith // m...@bu.mp
Operations Lead


On Monday, October 24, 2011 at 10:06 AM, Tomer Naor wrote:

&gt; 
&gt; Well, it caused us some problems…
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; The situation is as follows:
&gt; 
&gt; 
&gt; we have a production cluster with five 0.14 nodes and which we want to 
&gt; replace with three new Riak 1.0.1 servers.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; This is what we did:
&gt; 
&gt; 
&gt; 1. join each of the 1.0 nodes to the 0.14 cluster.
&gt; 
&gt; 
&gt; 2. after that all the three 1.0 nodes were part of the ring members and 
&gt; handoff was over we did ‘admin-riak leave’ on one of the 0.14 nodes 
&gt; (eventually we’ll need to leave them all).
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; The problem is that it looks like not all the data from the 0.14 node were 
&gt; handoff in the leaving process and it seems like we’ve lost some data.
&gt; 
&gt; 
&gt; (Don’t know if it’s matter but the bitcask of the 0.14 node that we tried to 
&gt; ‘riak-admin leave’ was reduced from 120GB to 55GB)
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; Another problem that we noticed is that the basic get api not always returned 
&gt; a consistent response, it sometimes returned the required data and sometimes 
&gt; returned 404 status code.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; what is the best/right/safe way to do it without losing data and without 
&gt; experience significant downtime as a result of the join and leave process.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; Thanks,
&gt; 
&gt; 
&gt; Tomer.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; From: Sean Cribbs [mailto:s...@basho.com] 
&gt; Sent: Wednesday, October 12, 2011 14:37
&gt; To: Tomer Naor
&gt; Cc: riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; Subject: Re: Join a Riak-1.0 node to a Riak-0.14 cluster
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; It is possible but requires a slight modification from the directions in 
&gt; http://wiki.basho.com/Rolling-Upgrades.html. When adding the new 1.0 node, 
&gt; make sure these settings are in the 'riak\\_kv' section of its app.config:
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; {legacy\\_keylisting, true},
&gt; {mapred\\_system, legacy},
&gt; {vnode\\_vclocks, false}
&gt; 
&gt; This will ensure that it does not try to use functionality that is 
&gt; unavailable on the 0.14.2 nodes.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Wed, Oct 12, 2011 at 6:30 AM, Tomer Naor  (mailto:to...@conduit.com)&gt; wrote:
&gt; 
&gt; 
&gt; Hi,
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; Is it possible to join a Riak-1.0 node (not from rolling upgrade - new server 
&gt; with fresh 1.0.0 installation) to a cluster with Riak-0.14 nodes without any 
&gt; unexpected problems?
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; Thanks,
&gt; 
&gt; 
&gt; Tomer.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Sean Cribbs 
&gt; 
&gt; 
&gt; Developer Advocate
&gt; 
&gt; 
&gt; 
&gt; Basho Technologies, Inc.
&gt; 
&gt; 
&gt; 
&gt; http://www.basho.com/
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

