---
title: "Re: Why is the data lost in luwak"
description: ""
project: community
lastmod: 2011-12-07T21:05:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05890"
mailinglist_parent_id: "msg05881"
author_name: "vuleetu"
project_section: "mailinglistitem"
sent_date: 2011-12-07T21:05:57-08:00
---


On Wed, Dec 7, 2011 at 11:56 PM, Kelly McLaughlin  wrote:
&gt;
&gt; Fisher,
&gt;
&gt; In the cases where you see file size discrepancies, are you able to retrieve 
&gt; those files intact from riak? Having a node in the cluster with an unstable 
&gt; network connection should not cause data loss because replicas should be 
&gt; saved to other nodes in your cluster, but it may cause some issues with being 
&gt; able to properly access those files via luwak. The chances of data being lost 
&gt; when a riak node goes down is dependent on what you mean by the node going 
&gt; down. In most cases, the replicas will take care of it, but in the case that 
&gt; multiple machines in your cluster fail, you should be familiar with the sync 
&gt; strategies for the backend you are using. For example, you can read about the 
&gt; bitcask sync strategies here: http://wiki.basho.com/Bitcask.html.
&gt;
&gt; Kelly

Kelly,

We are only able to retrieve the data in Riak that it reports it has
(from luwak\\_file:length()), but it does not match what we attempted to
put into Riak.  I brought up the network questions only as a theory,
otherwise I don't know any reason why we are having this problem.  It
is affecting about 0.0012% of the files we are putting into Riak (via
luwak), and without any way of determining if a write operation was
successful we don't know how to resolve this problem.

We tried calling luwak\\_put\\_stream:flush() before to "guarantee" that
our data would write because in the docs for luwak\\_put\\_stream:send()
it's a little misleading about what it does, but on buffer block sizes
&lt; 1000000 the flush() does not do what we expected at all:

RiakNode = 'riak@127.0.0.1'.
{ok, Riak} = riak:client\\_connect(RiakNode).
{ok, RiakFile} = luwak\\_file:create(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;, dict:new()).
Ps = luwak\\_put\\_stream:start(Riak, RiakFile, 0, 1000000).
luwak\\_put\\_stream:send(Ps, &lt;&lt;"1234"&gt;&gt;).
luwak\\_put\\_stream:flush(Ps).
{ok, RiakFile2} = luwak\\_file:get(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;).
luwak\\_file:length(Riak, RiakFile2).      %% Length is 4
luwak\\_put\\_stream:send(Ps, &lt;&lt;"56789"&gt;&gt;).
luwak\\_put\\_stream:flush(Ps).
{ok, RiakFile3} = luwak\\_file:get(Riak, &lt;&lt;"testabc22yeah3"&gt;&gt;).
luwak\\_file:length(Riak, RiakFile3).  %% Length is 13, but we would
have expected 9
luwak\\_io:get\\_range(Riak, RiakFile3, 0, 13). %% [&lt;&lt;"1234"&gt;&gt;,&lt;&lt;"123456789"&gt;&gt;]

&gt;From the documentation though it says: "If you want guarantees that
your write is actually written then you need to call flush/1 on the
put stream."

So besides that, is there any way to actually tell if the node
received the write request?

Thanks,

Fisher


&gt;
&gt;
&gt;
&gt; On Dec 5, 2011, at 12:56 AM, vuleetu wrote:
&gt;
&gt; Hi, all
&gt;
&gt;      I am working on a storage system which receives data from the client and 
&gt; stores it to luwak. The server also records the file size of that file which 
&gt; is uploaded successfully to the database, but i found it is not the same size 
&gt; as the data in luwak even after several days, so that is not a consistency 
&gt; problem.
&gt;
&gt;    The following is the main process:
&gt;
&gt;    1) check if file exists already
&gt;       luwak\\_file:exists()
&gt;
&gt;    2) if it doesn't exist, will use luwak\\_file:create to create one, or else 
&gt; will use luwak\\_file:get to get that file handle,
&gt;
&gt;    3) use the last offset which is recorded in database, and the create put 
&gt; stream
&gt;       luwak\\_put\\_stream:start(Riak, RiakFile, Offset, ?STREAM\\_PUT\\_TTL)
&gt;
&gt;    4) receive data from client, and write to put stream created above
&gt;       gen\\_tcp: recv()
&gt;       luwak\\_put\\_stream:send(PutStream, Binary)
&gt;
&gt;    Is there any possibility that data is lost because one of the riak node's 
&gt; network is not stable? Because i found when i call luwak\\_put\\_stream:put(), it 
&gt; just send message contain the data to one process, so i dont know if data is 
&gt; lost or sent successfully. Even if I call flush, it is still a request 
&gt; message to that process. Is there any function to tell me if the write was 
&gt; successful or not? What about if that riak node goes down in the middle of 
&gt; writing data to luwak, what would happen, will it cause the data to be lost?
&gt;
&gt;
&gt; Thanks,
&gt; Fisher
