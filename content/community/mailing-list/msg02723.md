---
title: "Re: Multiple disks"
description: ""
project: community
lastmod: 2011-03-23T15:50:47-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02723"
mailinglist_parent_id: "msg02706"
author_name: "Greg Nelson"
project_section: "mailinglistitem"
sent_date: 2011-03-23T15:50:47-07:00
---


Hi Joe,

With a few hours of investigation today, your patch is looking promising. Maybe 
you can give some more detail on what you did in your experiments a few months 
ago?

What I did was set up a Ubuntu VM with three loopback file systems. Then built 
Riak 0.14.1 with your patch, configured as you described to spread across the 
three disks. I ran a single node, and it correctly spread partitions across the 
disks.

I then corrupted the file system on one of the disks (by zeroing out the loop 
device), and did some more GETs and PUTs against Riak. In the logs it looks 
like the vnode processes that had bitcasks on that disk died, as expected, and 
the other vnodes continued to operate.

I need to do a bit more investigation with more than one node, but given how 
well it handled this scenario, it seems like we're on the right track.

Oh, one thing I noticed is that while Riak starts up, if there's a bad disk 
then it will shutdown (the whole node), at this line:

https://github.com/jtuple/riak\\_kv/blob/jdb-multi-dirs/src/riak\\_kv\\_bitcask\\_backend.erl#L103

That makes sense, but I'm wondering if it's possible to let the node start 
since some of its vnodes would be able to open their bitcasks just fine. I 
wonder if it's as simple as removing that line?

Greg
On Tuesday, March 22, 2011 at 9:54 AM, Joseph Blomstedt wrote:
You're forgetting how awesome riak actually is. Given how riak is
&gt; implemented, my patches should work without any operational headaches
&gt; at all. Let me explain.
&gt; 
&gt; First, there was the one issue from yesterday. My initial patch didn't
&gt; reuse the same partition bitcask on the same node. I've fixed that in
&gt; a newer commit:
&gt; https://github.com/jtuple/riak\\_kv/commit/de6b83a4fb53c25b1013f31b8c4172cc40de73ed
&gt; 
&gt; Now, about how this all works in operation.
&gt; 
&gt; Let's consider a simple scenario under normal riak. The key concept
&gt; here is to realize that riak's vnodes are completely independent, and
&gt; that failure and partition ownership changes are handled through
&gt; handoff alone.
&gt; 
&gt; Let's say we have an 8-partition ring with 3 riak nodes:
&gt; n1 owns partitions 1,4,7
&gt; n2 owns partitions 2,5,8
&gt; n3 owns partitions 3,6
&gt; ie: Ring = (0/n1, 1/n2, 2/n3, 3/n1, 4/n2, 5/n3, 6/n1, 7/n2, 8/n3)
&gt; 
&gt; Each node runs an independent vnode for each partition it owns, and
&gt; each vnode will setup it's own bitcask:
&gt; 
&gt; vnode 0/1: {n1-root}/data/bitcask/1
&gt; vnode 0/4: {n1-root}/data/bitcask/4
&gt; ...
&gt; vnode 2/2: {n2-root}/data/bitcask/2
&gt; ...
&gt; vnode 3/6: {n3-root}/data/bitcask/6
&gt; 
&gt; Reads/writes are routed to the appropriate vnodes and to the
&gt; appropriate bitcasks. Under failure, hinted handoff comes into play.
&gt; 
&gt; Let's have a write to preflist [1,2,3] while n2 is down/split. Since
&gt; n2 is down, riak will send the write meant for partition 2 to another
&gt; node, let's say n3. n3 will spawn a new vnode for partition 2 which is
&gt; initially empty:
&gt; 
&gt; vnode 3/2: {n3-root}/data/bitcask/2
&gt; 
&gt; and, write the incoming write to the new bitcask.
&gt; 
&gt; Later, when n2 rejoins, n3 will eventually engage in handoff, and send
&gt; all (k,v) in its data/bitcask/2 to n2, which writes them into its
&gt; data/bitcask/2. After handing off data, n3 will shutdown it's 3/2
&gt; vnode and delete the bitcask directory {n3-root}/data/bitcask/2.
&gt; 
&gt; Under node rebalancing / ownership changes, a similar event occurs.
&gt; For example, if a new node n4 takes ownership of partition 4, then n1
&gt; will handoff it's data to n4 and then shutdown its vnode and delete
&gt; its {n1-root}/data/bitcask/4.
&gt; 
&gt; If you take the above scenario, and change all the directories of the form:
&gt; {NODE-root}/data/bitcask/P
&gt; to:
&gt; /mnt/DISK-N/NODE/bitcask/P
&gt; 
&gt; and allow DISK-N to be any randomly chosen directory in /mnt, then the
&gt; scenario plays out exactly the same provided that riak always selects
&gt; the same DISK-N for a given P on a given node (across nodes doesn't
&gt; matter, vnodes are independent). My new commit handles this. A simple
&gt; configuration could be:
&gt; 
&gt; n1-vars.config:
&gt; {bitcask\\_data\\_root, {random, ["/mnt/bitcask/disk1/n1",
&gt; "/mnt/bitcask/disk2/n1", "/mnt/bitcask/disk3/n1"]}}
&gt; n2-vars.config:
&gt; {bitcask\\_data\\_root, {random, ["/mnt/bitcask/disk1/n2",
&gt; "/mnt/bitcask/disk2/n2", "/mnt/bitcask/disk3/n2"]}}
&gt; (...etc...)
&gt; 
&gt; There is no inherent need for symlinks, or needing to pre-create any
&gt; initial links per partition index. riak already creates and deletes
&gt; partition bitcask directories on demand. If a disk fails, then all
&gt; vnodes with bitcasks on that disk fail in the same manner as a disk
&gt; failure under normal riak. Standard read repair, handoff, and node
&gt; replacement apply.
&gt; 
&gt; -Joe
&gt; 
&gt; On Tue, Mar 22, 2011 at 9:53 AM, Alexander Sicular  wrote:
&gt; &gt; Ya, my original message just highlighted the standard 0,1,5 that most
&gt; &gt; people/hardware should know/be able to support. There are better options and
&gt; &gt; 10 would be one of them.
&gt; &gt; 
&gt; &gt; 
&gt; &gt; @siculars on twitter
&gt; &gt; http://siculars.posterous.com
&gt; &gt; Sent from my iPhone
&gt; &gt; On Mar 22, 2011, at 8:43, Ryan Zezeski  wrote:
&gt; &gt; 
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Tue, Mar 22, 2011 at 10:01 AM, Alexander Sicular 
&gt; &gt; wrote:
&gt; &gt; &gt; 
&gt; &gt; &gt; Save your ops dudes the headache and just use raid 5 and be done with it.
&gt; &gt; 
&gt; &gt; Depending on the number of disks available I might even argue running
&gt; &gt; software RAID 10 for better throughput and less chance of data loss (as long
&gt; &gt; as you can afford to cut your avail storage in half on every machine). It's
&gt; &gt; not too hard to setup on modern Linux distros (mdadm); at least I was doing
&gt; &gt; it 5 years ago and I'm no sys admin.
&gt; &gt; -Ryan
&gt; 
 
