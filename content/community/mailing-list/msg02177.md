---
title: "Re: Riak Cluster Setup on EC2"
description: ""
project: community
lastmod: 2011-02-02T12:10:27-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02177"
mailinglist_parent_id: "msg02174"
author_name: "Ryan Maclear"
project_section: "mailinglistitem"
sent_date: 2011-02-02T12:10:27-08:00
---


Hi All,

In my past experiences with distributed Erlang on systems I've put together, 
the first thing I check when two nodes cannot ping each other is whether the 
erlang cookie is the same on both nodes (and sometimes an erlang hosts file is 
needed).

I know in the dev setup of riak (3 nodes - dev1, dev2, dev3 all on 127.0.0.1) 
the cookie is in the etc/vm.args file, but I'm not sure whether this is the 
case in production deployments, or whether the cookie in the user's home 
directory is used. 

Just thought that might be something to look at as well.

Cheers,
Ryan

On 02 Feb 2011, at 7:57 PM, Jon Meredith wrote:

&gt; Hey,
&gt; 
&gt; So that shows distributed erlang is not working, next step is to work out 
&gt; why. The erlang emulator (beam) uses ports for distributed erlang in 
&gt; addition to the ones riak uses.
&gt; 
&gt; You can see which ports using the erlang port mapper. It sits on a well 
&gt; known port and sets up all the other connection. Run 'empd -names' from the 
&gt; commandline to see what is set up. Here is my machine with 3 dev nodes all 
&gt; running at the same time. You'll probably just have 'name riak' on yours. 
&gt; 
&gt; $ epmd -names
&gt; epmd: up and running on port 4369 with data:
&gt; name dev3 at port 56668
&gt; name dev2 at port 56657
&gt; name dev1 at port 56647
&gt; 
&gt; Check you can see the empd port from both sides and the distributed erlang 
&gt; port (that's what Sean was talking about with the chef recipe).
&gt; 
&gt; Jon
&gt; 
&gt; On Wed, Feb 2, 2011 at 10:49 AM, Abhishek Kona  
&gt; wrote:
&gt; Hi.
&gt; 
&gt; Sorry about that, 
&gt; I am getting "pang" as a reply. 
&gt; 
&gt; But is this a network issue?
&gt; As I said before I can telnet on to the machines on the Riak ports.
&gt; 
&gt; What can be the issues?
&gt; 
&gt; Again ,Thanks for all the quick help
&gt; 
&gt; -Abhishek Kona
&gt; 
&gt; 
&gt; On 02/02/11 10:33 PM, Jon Meredith wrote:
&gt;&gt; Hi Abhishek,
&gt;&gt; 
&gt;&gt; It looks like distributed erlang isn't working between the nodes so the join 
&gt;&gt; fails.
&gt;&gt; 
&gt;&gt; You can test it by bringing the nodes up in console mode and executing
&gt;&gt; 
&gt;&gt; $ riak console
&gt;&gt; [some logging status messages]
&gt;&gt; Eshell V5.7.5 (abort with ^G)
&gt;&gt; (dev2@127.0.0.1)1&gt; net\\_adm:ping('dev1@127.0.0.1').
&gt;&gt; pong
&gt;&gt; (dev2@127.0.0.1)3&gt; q(). 
&gt;&gt; ok
&gt;&gt; 
&gt;&gt; Make sure you switch the node names for your own and run the test in both 
&gt;&gt; directions. If the node is unreachable it will return pang instead 
&gt;&gt; of ping.
&gt;&gt; 
&gt;&gt; --Jon
&gt;&gt; Senior Software Engineer
&gt;&gt; Basho Technologies
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Wed, Feb 2, 2011 at 9:04 AM, Abhishek Kona  
&gt;&gt; wrote:
&gt;&gt; On 02/02/11 8:38 PM, Sean Cribbs wrote: 
&gt;&gt;&gt; Abhishek, 
&gt;&gt;&gt; 
&gt;&gt;&gt; First, make sure all of your nodes are in the same security group. 
&gt;&gt; Yes, both the machines are on the same security group ( which has only the 
&gt;&gt; ports 8098, 8099, 8087). 
&gt;&gt;&gt; Second, check that your OS doesn't have an additional firewall installed 
&gt;&gt;&gt; (iptables, for example). 
&gt;&gt; I can telnet into the Riak ports from each of the machines, so firewall does 
&gt;&gt; not seem to be the issue. 
&gt;&gt;&gt; Third, you might consider doing what the Chef recipe for Riak does and 
&gt;&gt;&gt; limit the ports that Erlang uses for distributed communication. Adding a 
&gt;&gt;&gt; section to app.config like the below will limit the port range: 
&gt;&gt;&gt; 
&gt;&gt;&gt; {kernel, [ 
&gt;&gt;&gt; {inet\\_dist\\_listen\\_min, 6000}, 
&gt;&gt;&gt; {inet\\_dist\\_listen\\_max, 7999} 
&gt;&gt;&gt; ]} 
&gt;&gt;&gt; 
&gt;&gt;&gt; You'll need to stop Riak, kill the "epmd" process, and then start Riak up 
&gt;&gt;&gt; again for this change to take effect. Make sure those ports are also open 
&gt;&gt;&gt; in your security group and any software firewall you have. 
&gt;&gt;&gt; 
&gt;&gt; Tried with these changes as well, but still get the same message. Anything 
&gt;&gt; else, I can try?. 
&gt;&gt; Thanks for the help. 
&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt; Developer Advocate 
&gt;&gt;&gt; Basho Technologies, Inc. 
&gt;&gt;&gt; http://basho.com/ 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Feb 2, 2011, at 8:47 AM, Abhishek Kona wrote: 
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Hi folks 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I am trying to set up a Riak cluster on EC2. 
&gt;&gt;&gt;&gt; Each time I issue a command : 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; $ sudo riak-admin join riak@10.130.149.253 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; It fails : 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Attempting to restart script through sudo -u riak 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Node riak@10.130.149.253 is not reachable! 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Netstat on both the machines says the ports are running fine. 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; netstat -na | egrep '(8087|8098|8099)' 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; tcp 0 0 0.0.0.0:8098 0.0.0.0:\\* LISTEN 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; tcp 0 0 0.0.0.0:8099 0.0.0.0:\\* LISTEN 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; tcp 0 0 0.0.0.0:8087 0.0.0.0:\\* LISTEN 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I can telnet to all the ports from each of the machine. 
&gt;&gt;&gt;&gt; I have been pulling my hair for long but of no avail. 
&gt;&gt;&gt;&gt; Can any one look and tell me what I am doing wrong. 
&gt;&gt;&gt;&gt; Are there any debug logs where I can look at what is going wrong? 
&gt;&gt;&gt;&gt; Is there any EC2 specific trick (like using public hostnames). 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I am attaching my app.cfg file for reference. 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Thanks 
&gt;&gt;&gt;&gt; -Abhishek Kona 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_ 
&gt;&gt;&gt;&gt; riak-users mailing list 
&gt;&gt;&gt;&gt; riak-users@lists.basho.com 
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 

