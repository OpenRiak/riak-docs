---
title: "Re: Strategies for testing against Riak"
description: ""
project: community
lastmod: 2012-09-16T14:18:20-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08554"
mailinglist_parent_id: "msg08553"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2012-09-16T14:18:20-07:00
---


Happy to help!

Sean Cribbs

On Sep 16, 2012, at 3:14 PM, Brad Heller  wrote:

&gt; Hey Sean,
&gt; 
&gt; Just wanted to say thanks for all this info, sorry it's a bit late. I was 
&gt; able to get this up and running and it's been significantly more performant 
&gt; and reliable than our previous solution!
&gt; 
&gt; Cheers,
&gt; Brad
&gt; 
&gt; On Sep 9, 2012, at 10:08 AM, Sean Cribbs  wrote:
&gt; 
&gt;&gt; Brad,
&gt;&gt; 
&gt;&gt; :root should be where you want the test node generated to. In a Rails
&gt;&gt; project this is typically tmp/riak\\_test\\_server.
&gt;&gt; :source should point to the directory where the 'riak' control script
&gt;&gt; lives in your local install. On Linux this is usually /usr/sbin, on
&gt;&gt; Mac/Homebrew it might be /usr/local/bin.
&gt;&gt; 
&gt;&gt; Using the same binaries but a different configuration is \\*exactly\\*
&gt;&gt; what the Riak::TestServer does (these go for Riak::Node as well, which
&gt;&gt; generates non-test nodes). #create will create a new directory on the
&gt;&gt; filesystem (pointed to by :root) which contains bin/ etc/ data/ log/
&gt;&gt; ring/ and possibly some other directories. It will write your
&gt;&gt; specified configuration to etc/app.config and etc/vm.args, using
&gt;&gt; defaults that include memory-only backends for KV and Search and point
&gt;&gt; the appropriate directories to the new root. It will also modify the
&gt;&gt; riak & riak-admin scripts to point to the new root and write them to
&gt;&gt; bin/. All of this happens without copying the Riak code or Erlang
&gt;&gt; runtime into the new location.
&gt;&gt; 
&gt;&gt; The other interesting and useful feature, aside from isolating the new
&gt;&gt; Riak node to the generated directory, is the Console and the
&gt;&gt; memory-backends that were specifically written for usage in
&gt;&gt; test-suites. Riak::TestServer#drop will open a console (just like
&gt;&gt; "riak attach") and run a command in the Riak node that makes it drop
&gt;&gt; all data in RAM, which gives you a clean slate for each test/example.
&gt;&gt; 
&gt;&gt; There is one bug in the generation process currently, which is that
&gt;&gt; you must have started the normal installation at least once. I hope to
&gt;&gt; resolve this bug in the future.
&gt;&gt; 
&gt;&gt; On Sat, Sep 8, 2012 at 6:42 PM, Brad Heller  wrote:
&gt;&gt;&gt; Hey Sean,
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks for the suggestion. I've spent a few hours trying to get this up and
&gt;&gt;&gt; running and I'm having a bit of a hard time. Is there any documentation
&gt;&gt;&gt; around Riak::TestServer?
&gt;&gt;&gt; 
&gt;&gt;&gt; What are the configuration values for :source and :root supposed to be
&gt;&gt;&gt; exactly? As I understand it, :root should be something like
&gt;&gt;&gt; /path/to/riak/bin and source should be something like /path/to/riak. Is that
&gt;&gt;&gt; correct? Also, how does Riak:: TestServer#create behave exactly?
&gt;&gt;&gt; 
&gt;&gt;&gt; In our dev environments we have a Riak configuration that includes config
&gt;&gt;&gt; files and binaries that our dev's can just git clone so they can get started
&gt;&gt;&gt; quickly. It is very similar to what the following docs outline only with
&gt;&gt;&gt; three nodes instead of one:
&gt;&gt;&gt; https://wiki.basho.com/Building-a-Development-Environment.html
&gt;&gt;&gt; 
&gt;&gt;&gt; What I'd really like to set up is a way for Riak::TestServer to use the same
&gt;&gt;&gt; binaries as our dev riak config, but a different configuration (app.config,
&gt;&gt;&gt; vm.args, etc.). Is this possible? Alternatively, we could stick a copy of
&gt;&gt;&gt; the Riak binaries directly in the repo that is using Ripple to make it a bit
&gt;&gt;&gt; more standalone.
&gt;&gt;&gt; 
&gt;&gt;&gt; What is the configuration you were anticipating when you wrote the
&gt;&gt;&gt; Riak::TestServer class?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Brad Heller
&gt;&gt;&gt; 
&gt;&gt;&gt; On Sep 7, 2012, at 5:02 AM, Sean Cribbs  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; If it's only for your test suite, use a local memory-only node via the
&gt;&gt;&gt; Ripple::TestServer. If you configure it correctly (there's a bundled
&gt;&gt;&gt; Rails generator that helps), it will delete all the contents of Riak
&gt;&gt;&gt; in one fell-swoop after or before each test/example.
&gt;&gt;&gt; 
&gt;&gt;&gt; On Fri, Sep 7, 2012 at 2:49 AM, Brad Heller  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Hey all,
&gt;&gt;&gt; 
&gt;&gt;&gt; So we're rolling out Riak more and more and so far, so good. In fact we're
&gt;&gt;&gt; starting to accumulate a pretty sizable test suite of our data access layer.
&gt;&gt;&gt; To support this we've written some code that helps clean out buckets between
&gt;&gt;&gt; test runs. We're using Ruby (ripple + ruby-risk-client, obviously) so we
&gt;&gt;&gt; just monkey patch the bucket object and detect if it was used or not.
&gt;&gt;&gt; 
&gt;&gt;&gt; If it was used during a test, we iterate over all the keys and delete each
&gt;&gt;&gt; one. We're cognizant of the risks in doing this for large clusters, but in
&gt;&gt;&gt; our test enviro the number of documents per test is pretty small and the
&gt;&gt;&gt; operations themselves are quite fast.
&gt;&gt;&gt; 
&gt;&gt;&gt; The problem we're having, though, is that when we run the full suite (or a
&gt;&gt;&gt; large subset of the suite) all at once the churn in Riak seems to be so
&gt;&gt;&gt; quick that sometimes Riak isn't quite in the state that we expect it to be
&gt;&gt;&gt; in when the test runs! For instance, we have a test that checks that the
&gt;&gt;&gt; right number of linked documents are created when a given object is saved.
&gt;&gt;&gt; If we run the test by itself everything works fine--the expectation that 10
&gt;&gt;&gt; documents are created indeed checks out. If we run this test as part of a
&gt;&gt;&gt; large suite of tests, the expectation fails and sometimes 11 documents or 12
&gt;&gt;&gt; documents appear (we check by counting the keys in the linked bucket).
&gt;&gt;&gt; 
&gt;&gt;&gt; I would think that this has something to do with Riak's eventually
&gt;&gt;&gt; consistent delete operation, but wanted to tap in to the brain trust: Is
&gt;&gt;&gt; there any tuning we can do in test to prevent this?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; 
&gt;&gt;&gt; Brad Heller | Engineering Lead | Cloudability.com | 541-231-1514 | Skype:
&gt;&gt;&gt; brad.heller | @bradhe | @cloudability
&gt;&gt;&gt; 
&gt;&gt;&gt; We're hiring! http://cloudability.com/jobs
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; --
&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt; Software Engineer
&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Sean Cribbs 
&gt;&gt; Software Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://basho.com/
&gt; 

