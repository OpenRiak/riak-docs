---
title: "Re: Riak Memory Usage Constantly Growing"
description: ""
project: community
lastmod: 2012-10-02T05:12:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08784"
mailinglist_parent_id: "msg08783"
author_name: "John E. Vincent"
project_section: "mailinglistitem"
sent_date: 2012-10-02T05:12:16-07:00
---


I would highly suggest you upgrade to 1.2 when possible. We were, up
until recently, running on 1.4 and seeing the same problems you
describe. Take a look at this graph:

http://i.imgur.com/0RtsU.png

That's just one of our nodes but all of them exhibited the same
behavior. The falloffs are where we had to bounce riak.

This is what one of our nodes looks like now and has looked like since
the upgrade:

http://i.imgur.com/pm7Nk.png

The change was SO dramatic that I seriously though /stats was broken.
I've verified outside of Riak and inside. The memory usage change was
very positive. Evidently there's even still a memory leak.

We're heavy 2i users. No multi backend.

On Tue, Oct 2, 2012 at 4:08 AM, Shane McEwan  wrote:
&gt; G'day!
&gt;
&gt; Just recently we've noticed memory usage in our Riak cluster constantly
&gt; increasing.
&gt;
&gt; The memory usage reported by the Riak stats "memory\\_total" parameter has
&gt; been less than 100MB for nearly a year but has recently increased to over
&gt; 1GB.
&gt;
&gt; If we restart the cluster memory usage usually returns back to what we would
&gt; call "normal" but after a week or so of stability the memory usage starts
&gt; gradually growing again. Sometimes after a growth spurt over a few days the
&gt; memory usage will plateau and be stable again for a week or two and then put
&gt; on another growth spurt. The memory usage starts increasing at the same
&gt; moment on all 4 nodes.
&gt;
&gt; This graph [http://imagebin.org/230614] shows what I mean. The green shows
&gt; the memory usage as reported by "memory\\_total" (left-hand y-axis scale). The
&gt; red line shows the memory used by Riak's beam.smp process (right-hand y-axis
&gt; scale).
&gt;
&gt; Also notice that the gradient of the recent growth seems to be increasing
&gt; compared to the memory increases we had in August.
&gt;
&gt; We might have just assumed that the memory usage was normal Riak behaviour.
&gt; Perhaps we have just tipped over some sort of internal buffer or cache and
&gt; that causes some more memory to be allocated. However, whenever we notice
&gt; the memory usage increasing it always coincides with the "riak-admin top"
&gt; command failing to run.
&gt;
&gt; We try to run "riak-admin top" to diagnose what is using the memory but it
&gt; returns: "Output server crashed: connection\\_lost". If we restart the cluster
&gt; the top command works fine (but, of course, there's nothing interesting to
&gt; see after a restart!).
&gt;
&gt; So our theory at the moment is that some sort of instability or race
&gt; condition is causing Riak to start consuming more and more memory. A side
&gt; effect of this instability is that the internal processes needed for running
&gt; the top command are not working correctly. The actual functionality of Riak
&gt; doesn't seem to be affected. Our application is running fine. We see a
&gt; slight increase in "FSM Put" times and CPU usage during the memory growth
&gt; phases but all other parameters we're monitoring on the system seem
&gt; unaffected.
&gt;
&gt; There's nothing abnormal in the logs. We get a lot of "riak\\_pipe\\_builder\\_sup
&gt; {sink\\_died,normal}" messages but they can be ignored, apparently. The
&gt; cluster is under constant load so we would expect to see either gradual
&gt; memory increase or a steady state but not both. Erlang process count, open
&gt; file handles, etc are stable.
&gt;
&gt; So I was wondering if anyone has seen similar behaviour before?
&gt; Is there anything else we can do to diagnose the problem?
&gt; I'm accessing the stats URL once per minute, could that have any side
&gt; effects?
&gt; We'll be upgrading to Riak 1.2 and new hardware in the next few weeks so
&gt; should we just ignore it and hope it goes away?
&gt; Any other ideas?
&gt; Or is this just normal?
&gt;
&gt; Riak config:
&gt; 4 VMware nodes
&gt; ring\\_creation\\_size, 256
&gt; n\\_val, 3
&gt; eleveldb backend:
&gt; max\\_open\\_files, 20
&gt; cache\\_size, 15728640
&gt; "riak\\_kv\\_version":"1.1.1",
&gt; "riak\\_core\\_version":"1.1.1",
&gt; "stdlib\\_version":"1.17.4",
&gt; "kernel\\_version":"2.14.4"
&gt; Erlang R14B03 (erts-5.8.4)
&gt;
&gt; Thanks!
&gt;
&gt; Shane.
&gt;
&gt;
&gt;
&gt;

