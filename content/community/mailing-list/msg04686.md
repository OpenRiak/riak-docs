---
title: "Streaming video from Luwak to browsers not working so well"
description: ""
project: community
lastmod: 2011-09-13T13:04:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04686"
author_name: "John Axel Eriksson"
project_section: "mailinglistitem"
sent_date: 2011-09-13T13:04:16-07:00
---


First a little background:

We've been putting videos in luwak without much trouble for quite a while now, 
small and a little bigger (by bigger I mean around 6 or 7 megs).

To stream these so far, we've basically done this:

Get the web app to download the video over http from luwak and store on local 
disk.
Get nginx, through an x-accel, to actually send it to the client (i.e the 
browser).

For various reasons this isn't really how we want to do it. There is one big 
reason why we do this currently. We need all clients to authenticate through
our rails-app. So we first tried to have rails send an x-accel to nginx which 
would then proxy to luwak. This won't work because nginx doesn't support
http 1.1, chunked encoding and all that jazz to backends at least (it's 2011… 
why I just don't know).

Anyway, for a while now we've thrown node.js into the mix(for other reasons) 
and recently I started working on some code for node.js to recognize
x-sendfile (similar to x-accel). I also made it do the same type of proxying as 
nginx can do - but this time it does http 1.1. Unfortunately I couldn't get it
to work. So I started investigating riak/luwak directly. Could we even stream a 
video out of luwak directly? No we couldn't. So the problem goes all the
way back to riak.

Using Safari it won't stream more than a few seconds and then sound and video 
stops (though the progress bar keeps moving).
Using Chrome and Firefox I could stream perhaps half the video before more or 
less the same thing happened.

I then cloned riak and removed one line in deps/luwak/src/luwak\\_wm\\_file.erl, 
specifically line 363 - {"gzip", fun(X) -&gt; zlib:gzip(X) end}]. So that the 
list
now only contains [{"identity", fun(X) -&gt; X end}]. (Those are the 
default\\_encodings). I will admit I didn't know exactly what I was doing.

Built riak and did some more testing. The results were interesting. Suddenly 
Chrome and Firefox would play the whole file through (a .webm).
Unfortunately Safari still did the same thing, i.e played 4 seconds and then 
stopped video and sound (while still showing progress).

I didn't try IE and quite frankly I'm afraid that one might just blow up my 
computer…

Anyway, I just wanted to ask the list if anyone ever tried the same thing or if 
any of the good people at basho knows more than I do (which I suspect
they do :-).


Thanks,
John
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

