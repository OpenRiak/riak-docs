---
title: "Re: Using protobuf client in Java"
description: ""
project: community
lastmod: 2010-04-19T15:09:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00079"
mailinglist_parent_id: "msg00078"
author_name: "Matthew Pflueger"
project_section: "mailinglistitem"
sent_date: 2010-04-19T15:09:28-07:00
---


Thanks Jon! That was exactly my problem... Quick note on your
example, msgLen should be msgLen-1 because you already read the
msgCode byte which is included in the msgLen...


--Matthew



On Mon, Apr 19, 2010 at 17:46, Jon Meredith  wrote:
&gt; Hi Matthew,
&gt;
&gt; When you read the serverInfoResp you need to read the header to find the
&gt; length of the response message. The header is 5-bytes - 4-bytes of length
&gt; and 1-byte of message code. You should just use the parseFrom calls - not
&gt; the parseFromDelimited ones.
&gt;
&gt; Please excuse my java - I haven't done any in a long time (a quick googling
&gt; couldn't find what to use for ntohl)
&gt;
&gt;    byte[] hdr = in.readRawBytes(5);
&gt;    int msgLen = (hdr[0] &lt;&lt; 24) + (hdr[1] &lt;&lt; 16) + (hdr[2] &lt;&lt; 8) + hdr[3]; //
&gt; ntohl
&gt;    byte msgCode = hdr[4];
&gt;    byte[] resp = in.readRawBytes(msgLen);
&gt;    RpbGetServerInfoResp serverInfoResp =
&gt; RpbGetServerInfoResp.parseFrom(resp)
&gt;
&gt; Jon
&gt;
&gt;
&gt; On 4/19/10 3:33 PM, Matthew Pflueger wrote:
&gt;&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; I’m having issues using the protobuf stuff.  Writing/reading bytes
&gt;&gt; directly to/from the socket works but using the protoc generated Java
&gt;&gt; message builders either gives me nothing useful back or throws invalid
&gt;&gt; protocol exceptions.  I’ve never used the protobuf stuff before so
&gt;&gt; maybe I’m doing something stupid...
&gt;&gt;
&gt;&gt; First I modified the riakclient.proto file inserting a package
&gt;&gt; declaration: option java\\_package = "";
&gt;&gt;
&gt;&gt;         protoc -I=. --java\\_out=./src riakclient.proto
&gt;&gt;
&gt;&gt;         //ping
&gt;&gt;         out.writeRawBytes(new byte[] {0, 0, 0, 1, 1});
&gt;&gt;         out.flush();
&gt;&gt;
&gt;&gt;         //pong {0, 0, 0, 1, 2}
&gt;&gt;         byte[] bytes = in.readRawBytes(5);
&gt;&gt;         assert bytes[4] == 2;
&gt;&gt;
&gt;&gt;         //get server info
&gt;&gt;         out.writeRawBytes(new byte[] {0, 0, 0, 1, 7});
&gt;&gt;         out.flush();
&gt;&gt;
&gt;&gt;         RpbGetServerInfoResp serverInfoResp =
&gt;&gt; RpbGetServerInfoResp.parseDelimitedFrom(socket.getInputStream());
&gt;&gt;         System.out.println("Connected to: " +
&gt;&gt; serverInfoResp.getNode().toStringUtf8());//toString());
&gt;&gt;
&gt;&gt; parseDelimitedFrom doesn't throw an error but I get nothing back...
&gt;&gt; Using parseFrom I get an error...  Any help would be appreciated...
&gt;&gt;
&gt;&gt; --Matthew
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

