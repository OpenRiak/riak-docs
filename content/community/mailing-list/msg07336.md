---
title: "Re: Upgrade to 1.1.2 problems"
description: ""
project: community
lastmod: 2012-04-27T11:40:11-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07336"
mailinglist_parent_id: "msg07330"
author_name: "Phil Sorber"
project_section: "mailinglistitem"
sent_date: 2012-04-27T11:40:11-07:00
---


Joe,

Confirmed that was the problem. Made that change and the rolling
upgrade went smoothly. Thanks for your help!

On Thu, Apr 26, 2012 at 10:18 AM, Phil Sorber  wrote:
&gt; Joe,
&gt;
&gt; I think you hit the nail on the head. We install from your released
&gt; deb's, but we deploy via chef and have the config generated from a
&gt; template. I am going to set up another test this morning and I will
&gt; let you know how it goes.
&gt;
&gt; Thanks.
&gt;
&gt; On Wed, Apr 25, 2012 at 7:38 PM, Joseph Blomstedt  wrote:
&gt;&gt; Phil,
&gt;&gt;
&gt;&gt; Given the following lines,
&gt;&gt;
&gt;&gt;&gt;         {reason,
&gt;&gt;&gt;          {{badmatch,{'EXIT',noproc}},
&gt;&gt;&gt;           [{riak\\_core\\_vnode\\_proxy,call,2},
&gt;&gt;
&gt;&gt; I'm inclined to think this is an issue with the new vnode routing
&gt;&gt; layer introduced in Riak 1.1. On your Riak 1.1.2 node, make sure your
&gt;&gt; app.config does not contain {legacy\\_vnode\\_routing, false} in the
&gt;&gt; riak\\_core section. If it does, either delete the line or change it to
&gt;&gt; false. If this was the issue, you should set it back to false after
&gt;&gt; upgrading the rest of your cluster.
&gt;&gt;
&gt;&gt; Also, if this turns out to be the issue, could you please let me know
&gt;&gt; how you performed the upgrade? Our official packages are supposed to
&gt;&gt; be designed so that they retain your old app.config file when
&gt;&gt; installed over an existing Riak installation (and thus, this line
&gt;&gt; would have been missing from the 1.0.3 config). It would be useful to
&gt;&gt; know if you used an official package and the app.config was
&gt;&gt; overwritten, or if you manually setup your app.config and simply
&gt;&gt; missed this option.
&gt;&gt;
&gt;&gt; On the plus side, the next release of Riak should include built-in
&gt;&gt; capability negotiation that should remove the need for users to have
&gt;&gt; to manually deal with legacy, mapred, listkeys, etc settings during an
&gt;&gt; upgrade.
&gt;&gt;
&gt;&gt; -Joe
&gt;&gt;
&gt;&gt; On Wed, Apr 25, 2012 at 2:05 PM, Phil Sorber  wrote:
&gt;&gt;&gt; We have a 4 node riak 1.0.0 cluster running in production that we want
&gt;&gt;&gt; to upgrade to 1.1.2. We set up a test environment that closely mimic's
&gt;&gt;&gt; the production one. As close as we possibly can with ec2 hosts. First
&gt;&gt;&gt; attempt to jump from 1.0.0 -&gt; 1.1.2 failed. We took into account the
&gt;&gt;&gt; mapred\\_system issue and the listkeys\\_backpressure issue. We decided to
&gt;&gt;&gt; try 1.0.0 -&gt; 1.0.3 since that would involve the mapred\\_system issue
&gt;&gt;&gt; only. That upgrade worked. We then tried to upgrade 1.0.3 -&gt; 1.1.2 and
&gt;&gt;&gt; had similar problems. Details below.
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; # riak-admin transfers
&gt;&gt;&gt; Attempting to restart script through sudo -u riak
&gt;&gt;&gt; 'riak@50.16.31.226' waiting to handoff 14 partitions
&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; Sometimes this would show as many as 48 transfers. Always from the
&gt;&gt;&gt; node that we upgraded. It would eventually show no transfers left. The
&gt;&gt;&gt; upgrade from 1.0.0 -&gt; 1.0.3 didn't do this.
&gt;&gt;&gt;
&gt;&gt;&gt; We tested a link walking query that is similar to what we run in
&gt;&gt;&gt; production. On 2 of the 3 nodes still running 1.0.3 it worked fine. On
&gt;&gt;&gt; the 3rd node, this happened:
&gt;&gt;&gt;
&gt;&gt;&gt; Curl run on 1.0.3 node:
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; curl -v http://localhost:8098/riak/email\\_address/riakupgr...@gmail.com/\\_,\\_,1
&gt;&gt;&gt; \\* About to connect() to localhost port 8098 (#0)
&gt;&gt;&gt; \\*   Trying 127.0.0.1... connected
&gt;&gt;&gt; \\* Connected to localhost (127.0.0.1) port 8098 (#0)
&gt;&gt;&gt;&gt; GET /riak/email\\_address/riakupgr...@gmail.com/\\_,\\_,1 HTTP/1.1
&gt;&gt;&gt;&gt; User-Agent: curl/7.19.7 (x86\\_64-pc-linux-gnu) libcurl/7.19.7 
&gt;&gt;&gt;&gt; OpenSSL/0.9.8k zlib/1.2.3.3 libidn/1.15
&gt;&gt;&gt;&gt; Host: localhost:8098
&gt;&gt;&gt;&gt; Accept: \\*/\\*
&gt;&gt;&gt;&gt;
&gt;&gt;&gt; &lt; HTTP/1.1 500 Internal Server Error
&gt;&gt;&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt;&gt;&gt; &lt; Expires: Wed, 25 Apr 2012 20:55:30 GMT
&gt;&gt;&gt; &lt; Date: Wed, 25 Apr 2012 20:45:30 GMT
&gt;&gt;&gt; &lt; Content-Type: text/html
&gt;&gt;&gt; &lt; Content-Length: 2068
&gt;&gt;&gt; &lt;
&gt;&gt;&gt; 500 Internal Server
&gt;&gt;&gt; ErrorInternal Server Error
=====================

The server
&gt;&gt;&gt; encountered an error while processing this request:  

```
{error,
&gt;&gt;&gt;  {error,
&gt;&gt;&gt;  {badmatch,
&gt;&gt;&gt;   {eoi,[],
&gt;&gt;&gt;    [{{reduce,0},
&gt;&gt;&gt;      {trace,
&gt;&gt;&gt;       [error],
&gt;&gt;&gt;       {error,
&gt;&gt;&gt;        [{module,riak_kv_w_reduce},
&gt;&gt;&gt;         {partition,1438665674247607560106752257205091097473808596992},
&gt;&gt;&gt;         {details,
&gt;&gt;&gt;          [{fitting,
&gt;&gt;&gt;            {fitting,&lt;0.848.0&gt;,#Ref&lt;0.0.0.5472&gt;,
&gt;&gt;&gt;             #Fun,1}},
&gt;&gt;&gt;           {name,{reduce,0}},
&gt;&gt;&gt;           {module,riak\\_kv\\_w\\_reduce},
&gt;&gt;&gt;           {arg,{rct,#Fun,none}},
&gt;&gt;&gt;           {output,
&gt;&gt;&gt;            {fitting,&lt;0.847.0&gt;,#Ref&lt;0.0.0.5472&gt;,
&gt;&gt;&gt;             #Fun,
&gt;&gt;&gt;             #Fun}},
&gt;&gt;&gt;           {options,
&gt;&gt;&gt;            [{sink,{fitting,&lt;0.119.0&gt;,#Ref&lt;0.0.0.5472&gt;,sink,undefined}},
&gt;&gt;&gt;             {log,sink},
&gt;&gt;&gt;             {trace,
&gt;&gt;&gt;              {set,1,16,16,8,80,48,
&gt;&gt;&gt;               {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;&gt;&gt;               {{[],[],[error],[],[],[],[],[],[],[],[],[],[],[],[],[]}}}}]},
&gt;&gt;&gt;           {q\\_limit,64}]},
&gt;&gt;&gt;         {reason,
&gt;&gt;&gt;          {{badmatch,{'EXIT',noproc}},
&gt;&gt;&gt;           [{riak\\_core\\_vnode\\_proxy,call,2},
&gt;&gt;&gt;            {riak\\_pipe\\_vnode,queue\\_work\\_send,4},
&gt;&gt;&gt;            {riak\\_pipe\\_vnode,queue\\_work\\_erracc,6},
&gt;&gt;&gt;            {riak\\_kv\\_w\\_reduce,'-done/1-lc$^0/1-0-',3},
&gt;&gt;&gt;            {riak\\_kv\\_w\\_reduce,done,1},
&gt;&gt;&gt;            {riak\\_pipe\\_vnode\\_worker,wait\\_for\\_input,2},
&gt;&gt;&gt;            {gen\\_fsm,handle\\_msg,7},
&gt;&gt;&gt;            {proc\\_lib,init\\_p\\_do\\_apply,3}]}},
&gt;&gt;&gt;         {state,{working,done}}]}}}]}},
&gt;&gt;&gt;  [{riak\\_kv\\_mrc\\_pipe,collect\\_outputs,3},
&gt;&gt;&gt;   {riak\\_kv\\_wm\\_link\\_walker,execute\\_segment,3},
&gt;&gt;&gt;   {riak\\_kv\\_wm\\_link\\_walker,execute\\_query,3},
&gt;&gt;&gt;   {riak\\_kv\\_wm\\_link\\_walker,to\\_multipart\\_mixed,2},
&gt;&gt;&gt;   {webmachine\\_resource,resource\\_call,3},
&gt;&gt;&gt;   {webmachine\\_resource,do,3},
&gt;&gt;&gt;   {webmachine\\_decision\\_core,resource\\_call,1},
&gt;&gt;&gt;   
&gt;&gt;&gt; {webmachine\\_decision\\_core,decision,1}]}}
```


---

mochiweb+webmachine
&gt;&gt;&gt; web server&gt;&gt; \\* Closing connection #0
&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; After that, this appeared in the error.log on that node:
&gt;&gt;&gt;
&gt;&gt;&gt; error.log on 1.0.3 node:
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; 2012-04-25 20:45:30.373 [error] &lt;0.119.0&gt; webmachine error:
&gt;&gt;&gt; path="/riak/email\\_address/riakupgr...@gmail.com/\\_,\\_,1"
&gt;&gt;&gt; {error,{error,{badmatch,{eoi,[],[{{reduce,0},{trace,[error],{error,[{module,riak\\_kv\\_w\\_reduce},{partition,1438665674247607560106752257205091097473808596992},{details,[{fitting,{fitting,&lt;0.848.0&gt;,#Ref&lt;0.0.0.5472&gt;,#Fun,1}},{name,{reduce,0}},{module,riak\\_kv\\_w\\_reduce},{arg,{rct,#Fun,none}},{output,{fitting,&lt;0.847.0&gt;,#Ref&lt;0.0.0.5472&gt;,#Fun,#Fun}},{options,[{sink,{fitting,&lt;0.119.0&gt;,#Ref&lt;0.0.0.5472&gt;,sink,undefined}},{log,sink},{trace,{set,1,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[error],[],[],[],[],[],[],[],[],[],[],[],[],[]}}}}]},{q\\_limit,64}]},{reason,{{badmatch,{'EXIT',noproc}},[{riak\\_core\\_vnode\\_proxy,call,2},{riak\\_pipe\\_vnode,queue\\_work\\_send,4},{riak\\_pipe\\_vnode,queue\\_work\\_erracc,6},{riak\\_kv\\_w\\_reduce,'-done/1-lc$^0/1-0-',3},{riak\\_kv\\_w\\_reduce,done,1},{riak\\_pipe\\_vnode\\_worker,wait\\_for\\_input,2},{gen\\_fsm,handle\\_msg,7},{proc\\_lib,init\\_p\\_do\\_apply,3}]}},{state,{working,done}}]}}}]}},[{riak\\_kv\\_mrc\\_pipe,collect\\_outputs,3},{riak\\_kv\\_wm\\_link\\_walker,execute\\_segment,3},{riak\\_kv\\_wm\\_link\\_walker,execute\\_query,3},{riak\\_kv\\_wm\\_link\\_walker,to\\_multipart\\_mixed,2},{webmachine\\_resource,resource\\_call,3},{webmachine\\_resource,do,3},{webmachine\\_decision\\_core,resource\\_call,1},{webmachine\\_decision\\_core,decision,1}]}}
&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; And this was in the error.log on the 1.1.2 node:
&gt;&gt;&gt;
&gt;&gt;&gt; error.log on 1.1.2 node:
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; 2012-04-25 20:45:30.234 [error] &lt;0.1710.0&gt; gen\\_fsm &lt;0.1710.0&gt; in state
&gt;&gt;&gt; wait\\_for\\_input terminated with reason: no match of right hand value
&gt;&gt;&gt; {'EXIT',noproc} in riak\\_core\\_vnode\\_proxy:call/2
&gt;&gt;&gt; 2012-04-25 20:45:30.243 [error] &lt;0.1710.0&gt; CRASH REPORT Process
&gt;&gt;&gt; &lt;0.1710.0&gt; with 0 neighbours crashed with reason: no match of right
&gt;&gt;&gt; hand value {'EXIT',noproc} in riak\\_core\\_vnode\\_proxy:call/2
&gt;&gt;&gt; 2012-04-25 20:45:30.245 [error] &lt;0.331.0&gt; Supervisor
&gt;&gt;&gt; riak\\_pipe\\_vnode\\_worker\\_sup had child undefined started with
&gt;&gt;&gt; {riak\\_pipe\\_vnode\\_worker,start\\_link,undefined} at &lt;0.1710.0&gt; exit with
&gt;&gt;&gt; reason no match of right hand value {'EXIT',noproc} in
&gt;&gt;&gt; riak\\_core\\_vnode\\_proxy:call/2 in context child\\_terminated
&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; On the 1.1.2 node, running the same curl, it returned a 404 after a
&gt;&gt;&gt; long timeout:
&gt;&gt;&gt;
&gt;&gt;&gt; Curl run on the 1.1.2 node:
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; curl -v http://localhost:8098/riak/email\\_address/riakupgr...@gmail.com/\\_,\\_,1
&gt;&gt;&gt; \\* About to connect() to localhost port 8098 (#0)
&gt;&gt;&gt; \\*   Trying 127.0.0.1... connected
&gt;&gt;&gt; \\* Connected to localhost (127.0.0.1) port 8098 (#0)
&gt;&gt;&gt;&gt; GET /riak/email\\_address/riakupgr...@gmail.com/\\_,\\_,1 HTTP/1.1
&gt;&gt;&gt;&gt; User-Agent: curl/7.19.7 (x86\\_64-pc-linux-gnu) libcurl/7.19.7 
&gt;&gt;&gt;&gt; OpenSSL/0.9.8k zlib/1.2.3.3 libidn/1.15
&gt;&gt;&gt;&gt; Host: localhost:8098
&gt;&gt;&gt;&gt; Accept: \\*/\\*
&gt;&gt;&gt;&gt;
&gt;&gt;&gt; &lt; HTTP/1.1 404 Object Not Found
&gt;&gt;&gt; &lt; Server: MochiWeb/1.1 WebMachine/1.9.0 (someone had painted it blue)
&gt;&gt;&gt; &lt; Date: Wed, 25 Apr 2012 20:49:40 GMT
&gt;&gt;&gt; &lt; Content-Type: text/html
&gt;&gt;&gt; &lt; Content-Length: 193
&gt;&gt;&gt; &lt;
&gt;&gt;&gt; \\* Connection #0 to host localhost left intact
&gt;&gt;&gt; \\* Closing connection #0
&gt;&gt;&gt; 404 Not FoundNot
&gt;&gt;&gt; Found
=============

The requested document was not found on this
&gt;&gt;&gt; server.

---

mochiweb+webmachine web
&gt;&gt;&gt; server


&gt;&gt;&gt; --
&gt;&gt;&gt;
&gt;&gt;&gt; There was nothing more in any error logs after this. Also pulling up
&gt;&gt;&gt; direct keys fails on this node. Riak is installed from the debian
&gt;&gt;&gt; packages. I can send you whatever other info is neccesary. We tried
&gt;&gt;&gt; many different combinations, but I think this one is the most correct
&gt;&gt;&gt; and produced the most useful error messages. Any help is appreciated.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks.
&gt;&gt;&gt;

&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Joseph Blomstedt 
&gt;&gt; Software Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://www.basho.com/

