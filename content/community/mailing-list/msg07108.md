---
title: "Re: slow mapred_search key lookups for single terms"
description: ""
project: community
lastmod: 2012-04-02T11:34:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07108"
mailinglist_parent_id: "msg07104"
author_name: "Michael Radford"
project_section: "mailinglistitem"
sent_date: 2012-04-02T11:34:05-07:00
---


I modified the pb client code to print the elapsed time when it
receives the first map-reduce result (in the function
wait\\_for\\_mapred), and tried to run a more apples-to-apples comparison
of the same map-reduce job via the local client and the pb client
connecting to 127.0.0.1.

In a nutshell, the majority of the extra delay from the pb client
occurs before it receives the first result (e.g., 6 out of 7 seconds).
(It's still troubling that it takes another second to receive the rest
of the results when reading from localhost, but maybe I can avoid that
by calling a different reduce phase that somehow packages my results
into a single message?)

Next, it seems like I should try instrumenting the server side of the
protobufs interface with timing...any pointers on the best place(s) to
do that would be appreciated.

Here is the function I used with the pb client to localhost, and the results:
TP =
 fun (Bucket, Query) -&gt;
 {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),
 Inputs = {modfun, riak\\_search, mapred\\_search, [Bucket, Query]},
 Phases =
 [ {reduce,
 {modfun, riak\\_kv\\_mapreduce, reduce\\_identity},
 [{reduce\\_phase\\_only\\_1, true}],
 true} ],
 {MuSec, {ok, [{0, Results}]}} =
 timer:tc (fun () -&gt; riakc\\_pb\\_socket:mapred(Pid, Inputs, Phases) end),
 riakc\\_pb\\_socket:stop (Pid),
 io:format(user, "~b results, ~f sec~n", [length(Results), MuSec/1000000])
 end.

3&gt; TP(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
first M-R result in 5848490 musec
14378 results, 7.235226 sec
ok
4&gt; TP(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
first M-R result in 5978044 musec
14378 results, 7.423933 sec
ok
5&gt; TP(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
first M-R result in 1219112 musec
14378 results, 2.563079 sec
ok
6&gt; TP(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
first M-R result in 6017087 musec
14378 results, 7.326352 sec
ok
7&gt; TP(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
first M-R result in 9546654 musec
24046 results, 13.561474 sec
ok
8&gt; TP(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
first M-R result in 1878109 musec
24047 results, 5.188646 sec
ok
9&gt;
9&gt; TP(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
first M-R result in 9724651 musec
24047 results, 12.692941 sec
ok
10&gt; TP(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
first M-R result in 9627592 musec
24047 results, 12.769256 sec
ok

And here is the function I used for the local client, and the results:
TL =
 fun (Bucket, Query) -&gt;
 {ok, Client} = riak:local\\_client(),
 Inputs = {modfun, riak\\_search, mapred\\_search, [Bucket, Query]},
 Phases =
 [ {reduce,
 {modfun, riak\\_kv\\_mapreduce, reduce\\_identity},
 [{reduce\\_phase\\_only\\_1, true}],
 true} ],
 {MuSec, {ok, Results}} =
 timer:tc(fun () -&gt; Client:mapred(Inputs, Phases) end),
 io:format(user, "~b results, ~f sec~n", [length(Results), MuSec/1000000])
 end.

(riak@10.174.223.37)27&gt; TL(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
14340 results, 0.106422 sec
ok
(riak@10.174.223.37)28&gt; TL(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
14340 results, 0.102255 sec
ok
(riak@10.174.223.37)29&gt; TL(Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
14340 results, 0.099877 sec
ok
(riak@10.174.223.37)30&gt; TL(Bucket,&lt;&lt;"full\\_text:blue"&gt;&gt;).
25017 results, 0.210381 sec
ok
(riak@10.174.223.37)31&gt; TL(Bucket,&lt;&lt;"full\\_text:blue"&gt;&gt;).
25017 results, 0.200112 sec
ok
(riak@10.174.223.37)32&gt; TL(Bucket,&lt;&lt;"full\\_text:blue"&gt;&gt;).
25018 results, 0.207553 sec
ok
(riak@10.174.223.37)33&gt; TL(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
23945 results, 0.173061 sec
ok
(riak@10.174.223.37)34&gt; TL(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
23945 results, 0.191595 sec
ok
(riak@10.174.223.37)35&gt; TL(Bucket,&lt;&lt;"full\\_text:green"&gt;&gt;).
23945 results, 0.177821 sec
ok

Mike

On Mon, Apr 2, 2012 at 8:46 AM, Michael Radford  wrote:
&gt; Hi Ryan,
&gt;
&gt; This is getting interesting: the same queries when executed using
&gt; local clients from 'riak attach' are taking only 100-250 ms.
&gt;
&gt; However, I just tried the same test I was running remotely on Saturday
&gt; on one of the machines in the Riak cluster, using the protobufs client
&gt; to connect to 127.0.0.1, and it's still taking 6-7 seconds per query.
&gt; (Still with an occasional dip down to 2-3 seconds).
&gt;
&gt; These machines are on Amazon EC2, so I have little control over the
&gt; network layout. But that includes the 4 Riak boxes, so if their
&gt; inter-node communication was suffering from similar issues I would
&gt; have expected to see it affecting other map-reduce queries. (We're
&gt; running lots of multi-key lookups via map-reduce that return thousands
&gt; of objects in a few ms, much larger than the keys returned from these
&gt; searches.)
&gt;
&gt; And again, there is a huge difference between the same query using the
&gt; local client (200 ms), and using the protobufs client from the exact
&gt; same Riak machine connecting to localhost (6-7 sec but occasionally
&gt; 2-3 sec).
&gt;
&gt; Mike
&gt;
&gt; On Mon, Apr 2, 2012 at 7:44 AM, Ryan Zezeski  wrote:
&gt;&gt; Hi Michael, you'll find my responses inline...
&gt;&gt;
&gt;&gt; On Sat, Mar 31, 2012 at 5:04 PM, Michael Radford  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; I'm seeing very slow performance from Riak search even when querying
&gt;&gt;&gt; single terms, and I'd appreciate any advice on how to get insight into
&gt;&gt;&gt; where the time is going.
&gt;&gt;&gt;
&gt;&gt;&gt; Right now, I'm using this function to time queries with the Erlang pb
&gt;&gt;&gt; client:
&gt;&gt;&gt;
&gt;&gt;&gt; TS =
&gt;&gt;&gt;  fun (Pid, Bucket, Query) -&gt;
&gt;&gt;&gt;    T0 = now(),
&gt;&gt;&gt;    {ok, Results} = riakc\\_pb\\_socket:search(Pid, Bucket, Query),
&gt;&gt;&gt;    MuSec = timer:now\\_diff(now(), T0),
&gt;&gt;&gt;    io:format(user, "~b results, ~f sec~n", [length(Results),
&gt;&gt;&gt; MuSec/1000000])
&gt;&gt;&gt;  end.
&gt;&gt;
&gt;&gt;
&gt;&gt; Just an FYI, you should checkout `timer:tc`.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; The bucket I'm querying currently has ~300k keys total (each 16
&gt;&gt;&gt; bytes). (The whole cluster has maybe 1.5M entries in about a dozen
&gt;&gt;&gt; buckets. It's running 1.0.2, 4 nodes on 4 8-core c1.xlarge EC2
&gt;&gt;&gt; instances.)
&gt;&gt;&gt;
&gt;&gt;&gt; For single-term queries that return 10k+ keys, I'm routinely seeing
&gt;&gt;&gt; times above 6 seconds to run the above function. Intermittently,
&gt;&gt;&gt; however, I'll see the same queries take only 2 seconds:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt;&gt; 12574 results, 6.094149 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt;&gt; 12574 results, 1.938894 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt;&gt; 12574 results, 1.981492 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt;&gt;&gt; 12574 results, 6.120589 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt;&gt; 13461 results, 6.572473 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt;&gt; 13461 results, 6.626049 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt;&gt;&gt; 13461 results, 2.155847 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt;
&gt;&gt;&gt; Queries with fewer results are still slow, but not quite as slow as 6
&gt;&gt;&gt; seconds:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt;&gt; 6446 results, 2.831806 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt;&gt; 6446 results, 3.037162 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt;&gt;&gt; 6447 results, 0.780944 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt;
&gt;&gt;&gt; And queries with no matches only take a few milliseconds:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:blorf"&gt;&gt;).
&gt;&gt;&gt; 0 results, 0.003269 sec
&gt;&gt;&gt; ok
&gt;&gt;&gt;
&gt;&gt;&gt; During the slow queries, none of the 4 machines seems to be fully
&gt;&gt;&gt; taxing even one cpu, or doing almost any disk i/o.
&gt;&gt;
&gt;&gt;
&gt;&gt; What does intra/inter network look like?
&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; As far as I can tell from looking at the riak\\_kv/riak\\_search source,
&gt;&gt;&gt; my query should only be hitting the index and streaming back the keys,
&gt;&gt;&gt; not trying to read every document from disk or sort by score. Is that
&gt;&gt;&gt; correct?
&gt;&gt;
&gt;&gt;
&gt;&gt; It will not read the documents at all but it will sort on score.  Currently
&gt;&gt; there is no way to disable sorting.
&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Assuming that's the case, I can't imagine why it takes so long to look
&gt;&gt;&gt; up 10k keys from the index for a single term, or why the times seem to
&gt;&gt;&gt; be bimodal (which seems like a big clue). Any pointers welcome!
&gt;&gt;
&gt;&gt;
&gt;&gt; Where is your client sitting in regards to your cluster?  Is it in the local
&gt;&gt; network?  Could you try attaching to one of your riak nodes, running the
&gt;&gt; query there and compare results?
&gt;&gt;
&gt;&gt; e.g.
&gt;&gt;
&gt;&gt; riak attach
&gt;&gt;
&gt;&gt;&gt; search:search(Bucket, Query).
&gt;&gt;
&gt;&gt; -Ryan
&gt;&gt;

