---
title: "Re: \"Dead\" files in bitcask or something"
description: ""
project: community
lastmod: 2010-08-17T08:59:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00906"
mailinglist_parent_id: "msg00904"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2010-08-17T08:59:15-07:00
---


We've been running Riak at production for 3 weeks and database just
kept growing. Even more time for our test server. Well, it was an
older Riak, 0.12.0.

I've been running 0.12.1 for several hours and still no compaction though...

On Tue, Aug 17, 2010 at 7:54 PM, Alexander Sicular  wrote:
&gt; Bitcask is a write only log (wol) that eats disk (by keeping all updates)
&gt; until a compaction phase that reclaims disk at some defined interval.
&gt;
&gt; -Alexander
&gt;
&gt;
&gt; @siculars on twitter
&gt; http://siculars.posterous.com
&gt;
&gt; Sent from my iPhone
&gt;
&gt; On Aug 17, 2010, at 11:27, Dmitry Demeshchuk  wrote:
&gt;
&gt;&gt; Greetings.
&gt;&gt;
&gt;&gt; This problem has already been discussed in IRC a bit.
&gt;&gt;
&gt;&gt; I use Riak 0.12.1 (have been using 0.12.0 but then updated to the
&gt;&gt; latest version and got the same problem) with bitcask storage.
&gt;&gt;
&gt;&gt; All Riak settings are default, i.e., all buckets are
&gt;&gt; default-configured (allow\\_mult=false), replication is 3x. Currently
&gt;&gt; Riak is run at a single machine. This problem is reproduced on
&gt;&gt; different machines with different Riak clusters brought up.
&gt;&gt;
&gt;&gt; Though the total database records size doesn't grow, update operations
&gt;&gt; (I'll describe them in details later) make the total size of the
&gt;&gt; "data/bitcask" folder. For example, I made a database backup on our
&gt;&gt; test server and the backup size was 2.5MB. But the size of the
&gt;&gt; "data/bitcask" folder was 17GB!
&gt;&gt;
&gt;&gt; Careful investigation showed that the entire database size on the disk
&gt;&gt; is performed when Riak update operation is performed, even when the
&gt;&gt; value during update was exactly the same.
&gt;&gt;
&gt;&gt; The update operation is like this:
&gt;&gt;
&gt;&gt; RiakObject = RiakClient:get(Bucket, Key, 1),
&gt;&gt; OldValue = riak\\_object:get\\_value(RiakObject),
&gt;&gt; NewValue = do\\_something(),
&gt;&gt; NewRiakObject = riak\\_object:update\\_value(RiakObject, NewValue),
&gt;&gt; RiakClient:put(NewRiakObject, 1).
&gt;&gt;
&gt;&gt; And it appeared that even if I make NewValue exactly the same as
&gt;&gt; OldValue, this update operation increases the database size of the
&gt;&gt; disk. Still, the entire size of this Riak object is the same.
&gt;&gt;
&gt;&gt; I thought that maybe I could do something wrong with data operating,
&gt;&gt; and there's some data I miss. But, again, backup file is very small,
&gt;&gt; much smaller then the disk space occupied by database.
&gt;&gt;
&gt;&gt; If I do list\\_buckets or list\\_keys, these operations work desperately
&gt;&gt; slow but finally they return the right values, without any garbage.
&gt;&gt; Values of the Riak objects are okay as well.
&gt;&gt;
&gt;&gt; When I had a look at data files, it appeared that \\*.bitcask.data are
&gt;&gt; the files that keep growing.
&gt;&gt;
&gt;&gt; That's all I found for now.
&gt;&gt;
&gt;&gt; Any clues?
&gt;&gt;
&gt;&gt; --
&gt;&gt; Best regards,
&gt;&gt; Dmitry Demeshchuk
&gt;

-- 
Best regards,
Dmitry Demeshchuk

