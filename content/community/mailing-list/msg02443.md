---
title: "Re: Java HTTP Client running out of FD's"
description: ""
project: community
lastmod: 2011-02-24T08:53:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02443"
mailinglist_parent_id: "msg02442"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2011-02-24T08:53:57-08:00
---


Thanks for getting back to me.

On Thu, 2011-02-24 at 21:13 +0530, Abhishek Kona wrote:

&gt; &gt; I'm wondering if you're sharing the same RiakClient between all threads
&gt; &gt; or if each thread creates a RiakClient?
&gt; &gt;
&gt; Each thread has a RiakClient.

RiakClient uses Apache HttpClient's MultiThreadedConnectionManager so
you could create a single RiakClient and share it among your threads
instead.

&gt; &gt; I'm also wondering what your RiakConfig.setMaxConnections setting is?
&gt; &gt; (And which client version you have?)
&gt; &gt;
&gt; This is not set, can I know what is the behavior in this case.

This is how many concurrent connections HttpClient can create. So for
your 64 threads you could create a RiakConfig with 
 riakConfig.setMaxConnections(64); 


&gt; The client I am using is 0.9.1

The version you are using will limit the maximum connections per host to
2, you can get the latest from

http://github.com/basho/riak-java-client 

Or if you need to stick with your current version you can pass an
HttpClient instance configured for 64 connections to your RiakConfig (eg
https://gist.github.com/842356)

&gt; &gt; Is it possible to see the test code, maybe?
&gt; I will try to post some snippets by tomorrow.

Cool, thanks. http://gist.github.com would be handy.

&gt; &gt;&gt;&gt; Also, just to sanity check, are you running against a Riak node on the
&gt; &gt;&gt;&gt; same box?
&gt; &gt;&gt;&gt;
&gt; &gt;&gt; The riak node was on the same box.
&gt; &gt; http://wiki.basho.com/Open-Files-Limit.html says
&gt; &gt;
&gt; &gt; "Riak can consume a large number of open file handles during normal
&gt; &gt; operation."
&gt; &gt;
&gt; &gt; Since your client and server are on the same machine, have you used lsof
&gt; &gt; to check how many FDs Java (vs Riak itself) has and what state they are
&gt; &gt; in, especially if any are hanging around after your test code has run?
&gt; &gt;
&gt; I do not have the lsof count. I will post it as soon as I run into the 
&gt; same situation again.

Appreciate it.

&gt; &gt; Sorry for the barrage of questions.
&gt; Thanks to you for looking into this.
&gt; 
&gt; -Abhishek Kona

