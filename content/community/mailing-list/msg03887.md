---
title: "Re: riak_core data handoff/rebalance"
description: ""
project: community
lastmod: 2011-06-30T14:39:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03887"
mailinglist_parent_id: "msg03886"
author_name: "Joel Meyer"
project_section: "mailinglistitem"
sent_date: 2011-06-30T14:39:41-07:00
---


On Thu, Jun 30, 2011 at 2:27 PM, Joseph Blomstedt &lt;
joseph.blomst...@gmail.com&gt; wrote:

&gt; The code you're looking for is the "should\\_handoff" fun in
&gt; riak\\_core\\_vnode.erl:
&gt;
&gt; https://github.com/basho/riak\\_core/blob/riak\\_core-0.14.2/src/riak\\_core\\_vnode.erl


Thanks, Joe - much appreciated.

Joel


&gt; There is a timer in the vnodes that fires periodically, and the vnode
&gt; will check it's current ring to determine if it is still the owner for
&gt; the index it represents. If it's not the current owner, the vnode
&gt; initiates handoff to the current owner. This design allows handoff to
&gt; occur both due to ring changes (join/leave) as well as for hinted
&gt; handoff (eg. when a write destined for a node was sent to a secondary
&gt; node during a temporary partition/downtime, and is later handed off to
&gt; the real node).
&gt;
&gt; -Joe
&gt;
&gt; On Thu, Jun 30, 2011 at 3:04 PM, Joel Meyer  wrote:
&gt; &gt; I'm trying to understand when and how data handoff between nodes is
&gt; &gt; triggered in riak\\_core. I was under the impression that data would be
&gt; &gt; shuffled when a new node joined the cluster or an existing node left the
&gt; &gt; cluster, but maybe that's not the case? It looks like joining a cluster
&gt; is
&gt; &gt; accomplished by gossiping your ring with a node in the cluster that you
&gt; wish
&gt; &gt; to join (riak\\_core\\_gossip:send\\_ring(NodeInCluster, node())). Looking
&gt; through
&gt; &gt; the code I don't see anywhere that a partitions data is transferred once
&gt; an
&gt; &gt; updated ring is agreed upon. Leaving a cluster seems to be handled
&gt; &gt; similarly, but I don't see any handoff triggered in this case either. I
&gt; must
&gt; &gt; be missing something obvious? I'm looking at tag riak\\_core-0.14.2.
&gt; &gt; Thanks,
&gt; &gt; Joel
&gt; &gt;
&gt; &gt;
&gt;
