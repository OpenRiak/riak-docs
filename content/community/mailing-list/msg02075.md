---
title: "riak_kv_multi_backend + custom backend"
description: ""
project: community
lastmod: 2011-01-23T09:38:01-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02075"
author_name: "Anthony Molinaro"
project_section: "mailinglistitem"
sent_date: 2011-01-23T09:38:01-08:00
---

Hi,

 So I wanted to play around with creating a custom backend, and using
the multi backend, but I am having problems getting anything to work.

Here's what I tried so far

in app.config

 {storage\\_backend, riak\\_kv\\_multi\\_backend},
 {multi\\_backend\\_default, bitcask},
 {multi\\_backend,
 [ {bitcask, riak\\_kv\\_bitcask\\_backend,
 [{data\\_root, "/var/lib/riak/bitcask"}]},
 {dets, riak\\_kv\\_dets\\_backend,
 [{riak\\_kv\\_dets\\_backend\\_root, "/var/lib/riak/dets"}]},
 {ets, riak\\_kv\\_ets\\_backend, []},
 {fs, riak\\_kv\\_fs\\_backend,
 [{riak\\_kv\\_fs\\_backend\\_root, "/var/lib/riak/fs"}]},
 {cache, riak\\_kv\\_cache\\_backend,
 [ {riak\\_kv\\_cache\\_backend\\_memory, 100},
 {riak\\_kv\\_cache\\_backend\\_ttl, 600},
 {riak\\_kv\\_cache\\_backend\\_max\\_ttl, 3600}
 ]},
 {my\\_backend, my\\_backend, []}
 ]},

Then I restart, open a shell and do the following

1&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087).
{ok,&lt;0.68.0&gt;}
2&gt; riakc\\_pb\\_socket:set\\_bucket(Pid, &lt;&lt;"b"&gt;&gt;, [{backend, my\\_backend}]).
ok
3&gt; riakc\\_pb\\_socket:get\\_bucket(Pid,&lt;&lt;"b"&gt;&gt;).
{ok,[{n\\_val,3},{allow\\_mult,false}]}

So I didn't see my backend there, thus tried the REST API

&gt; curl 'http://127.0.0.1:8098/riak/b' ; echo 
{"props":{"name":"b","n\\_val":3,"allow\\_mult":false,"last\\_write\\_wins":false,"precommit":[],"postcommit":[],"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"old\\_vclock":86400,"young\\_vclock":20,"big\\_vclock":50,"small\\_vclock":10,"r":"quorum","w":"quorum","dw":"quorum","rw":"quorum"}}

It's not there either. So I try to set it with REST

&gt; curl -X PUT -H "Content-Type: application/json" -d 
&gt; '{"props":{"backend":"my\\_backend"}}' http://127.0.0.1:8098/riak/b

Which works, in that now I have

&gt; curl 'http://127.0.0.1:8098/riak/b' ; 
&gt; echo{"props":{"backend":"my\\_backend","name":"b","n\\_val":3,"allow\\_mult":false,"last\\_write\\_wins":false,"precommit":[],"postcommit":[],"chash\\_keyfun":{"mod":"riak\\_core\\_util","fun":"chash\\_std\\_keyfun"},"linkfun":{"mod":"riak\\_kv\\_wm\\_link\\_walker","fun":"mapreduce\\_linkfun"},"old\\_vclock":86400,"young\\_vclock":20,"big\\_vclock":50,"small\\_vclock":10,"r":"quorum","w":"quorum","dw":"quorum","rw":"quorum"}}

However, in the shell I still get

4&gt; riakc\\_pb\\_socket:get\\_bucket(Pid,&lt;&lt;"b"&gt;&gt;).
{ok,[{n\\_val,3},{allow\\_mult,false}]}

Also, if I attempt to put something I get

5&gt; riakc\\_pb\\_socket:put(Pid, riakc\\_obj:new (&lt;&lt;"b"&gt;&gt;, &lt;&lt;"c"&gt;&gt;, &lt;&lt;"d"&gt;&gt;)).

=ERROR REPORT==== 19-Jan-2011::02:21:04 ===
\\*\\* Generic server &lt;0.68.0&gt; terminating 
\\*\\* Last message in was {req\\_timeout,#Ref&lt;0.0.0.186&gt;}
\\*\\* When Server state == {state,"127.0.0.1",8087,false,false,undefined,
 undefined,
 {[],[]},
 1,[],infinity,100}
\\*\\* Reason for termination == 
\\*\\* disconnected
\\*\\* exception exit: disconnected

=CRASH REPORT==== 19-Jan-2011::02:21:04 ===
 crasher:
 initial call: riakc\\_pb\\_socket:init/1
 pid: &lt;0.68.0&gt;
 registered\\_name: []
 exception exit: disconnected
 in function gen\\_server:terminate/6
 ancestors: [&lt;0.65.0&gt;]
 messages: [{tcp,#Port&lt;0.816&gt;,
 [0|&lt;&lt;10,7,116,105,109,101,111,117,116,16,1&gt;&gt;]}]
 links: [&lt;0.65.0&gt;]
 dictionary: []
 trap\\_exit: false
 status: running
 heap\\_size: 987
 stack\\_size: 24
 reductions: 1541
 neighbours:
 neighbour: [{pid,&lt;0.65.0&gt;},
 {registered\\_name,[]},
 {initial\\_call,{erlang,apply,2}},
 {current\\_function,{gen,do\\_call,4}},
 {ancestors,[]},
 {messages,[{#Ref&lt;0.0.0.185&gt;,{error,timeout}}]},
 {links,[&lt;0.25.0&gt;,&lt;0.68.0&gt;]},
 {dictionary,[]},
 {trap\\_exit,false},
 {status,runnable},
 {heap\\_size,1597},
 {stack\\_size,38},
 {reductions,17388}]

And the attached sasl log which has many errors. So I'm trying to figure out
whether the problem is configuration, or a bug or what, and wondering if any
one else has gotten a custom backend, or multi backend to work?

I'm using 0.14 on Centos 5, using the basho RPM.

Thanks,

-Anthony

-- 
------------------------------------------------------------------------
Anthony Molinaro 

=ERROR REPORT==== 19-Jan-2011::02:20:04 ===
\\*\\* State machine &lt;0.232.0&gt; terminating 
\\*\\* Last event in was {riak\\_vnode\\_req\\_v1,
 296867520082839655260123481645494988367611297792,
 {fsm,undefined,&lt;0.6356.0&gt;},
 {riak\\_kv\\_put\\_req\\_v1,
 {&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;},
 {r\\_object,&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;,
 [{r\\_content,
 {dict,2,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,52,116,101,83,99,116,51,84,
 86,105,48,76,50,118,49,90,88,86,82,55,53,78]],
 [],[],
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|
 {1295,432404,650963}]],
 [],[]}}},
 &lt;&lt;"d"&gt;&gt;}],
 [{&lt;&lt;4,137,66,204&gt;&gt;,{1,63462651604}}],
 {dict,1,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 [[clean|true]],
 []}}},
 undefined},
 38769885,63462651604,[]}}
\\*\\* When State == active
\\*\\* Data == {state,296867520082839655260123481645494988367611297792,
 riak\\_kv\\_vnode,
 {state,296867520082839655260123481645494988367611297792,
 riak\\_kv\\_multi\\_backend,
 {state,
 [{bitcask,riak\\_kv\\_bitcask\\_backend,
 {#Ref&lt;0.0.0.700&gt;,
 
"/var/lib/riak/bitcask/296867520082839655260123481645494988367611297792"}},
 {dets,riak\\_kv\\_dets\\_backend,
 {state,
 
'296867520082839655260123481645494988367611297792',
 
"/var/lib/riak/dets/296867520082839655260123481645494988367611297792"}},
 {ets,riak\\_kv\\_ets\\_backend,&lt;0.235.0&gt;},
 {fs,riak\\_kv\\_fs\\_backend,
 {state,
 
"/var/lib/riak/fs/296867520082839655260123481645494988367611297792"}},
 {cache,riak\\_kv\\_cache\\_backend,&lt;0.236.0&gt;},
 {my\\_backend,my\\_backend,{}}],
 bitcask},
 {dict,0,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 []}}},
 false},
 undefined,none,60000}
\\*\\* Reason for termination = 
\\*\\* {bad\\_return\\_value,
 {riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}

=CRASH REPORT==== 19-Jan-2011::02:20:04 ===
 crasher:
 initial call: riak\\_core\\_vnode:init/1
 pid: &lt;0.232.0&gt;
 registered\\_name: []
 exception exit: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 in function gen\\_fsm:terminate/7
 in call from proc\\_lib:init\\_p\\_do\\_apply/3
 ancestors: [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]
 messages: []
 links: [&lt;0.235.0&gt;,&lt;0.236.0&gt;,&lt;0.103.0&gt;]
 dictionary: []
 trap\\_exit: true
 status: running
 heap\\_size: 233
 stack\\_size: 24
 reductions: 29591
 neighbours:
 neighbour: 
[{pid,&lt;0.236.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_cache\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.232.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.232.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,40}]
 neighbour: 
[{pid,&lt;0.235.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_ets\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.232.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.232.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,135}]

=SUPERVISOR REPORT==== 19-Jan-2011::02:20:04 ===
 Supervisor: {local,riak\\_core\\_vnode\\_sup}
 Context: child\\_terminated
 Reason: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 Offender: 
[{pid,&lt;0.232.0&gt;},{name,undefined},{mfa,{riak\\_core\\_vnode,start\\_link,[riak\\_kv\\_vnode,296867520082839655260123481645494988367611297792]}},{restart\\_type,temporary},{shutdown,brutal\\_kill},{child\\_type,worker}]


=ERROR REPORT==== 19-Jan-2011::02:20:04 ===
\\*\\* State machine &lt;0.242.0&gt; terminating 
\\*\\* Last event in was {riak\\_vnode\\_req\\_v1,
 342539446249430371453988632667878832731859189760,
 {fsm,undefined,&lt;0.6356.0&gt;},
 {riak\\_kv\\_put\\_req\\_v1,
 {&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;},
 {r\\_object,&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;,
 [{r\\_content,
 {dict,2,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,52,116,101,83,99,116,51,84,
 86,105,48,76,50,118,49,90,88,86,82,55,53,78]],
 [],[],
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|
 {1295,432404,650963}]],
 [],[]}}},
 &lt;&lt;"d"&gt;&gt;}],
 [{&lt;&lt;4,137,66,204&gt;&gt;,{1,63462651604}}],
 {dict,1,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 [[clean|true]],
 []}}},
 undefined},
 38769885,63462651604,[]}}
\\*\\* When State == active
\\*\\* Data == {state,342539446249430371453988632667878832731859189760,
 riak\\_kv\\_vnode,
 {state,342539446249430371453988632667878832731859189760,
 riak\\_kv\\_multi\\_backend,
 {state,
 [{bitcask,riak\\_kv\\_bitcask\\_backend,
 {#Ref&lt;0.0.0.750&gt;,
 
"/var/lib/riak/bitcask/342539446249430371453988632667878832731859189760"}},
 {dets,riak\\_kv\\_dets\\_backend,
 {state,
 
'342539446249430371453988632667878832731859189760',
 
"/var/lib/riak/dets/342539446249430371453988632667878832731859189760"}},
 {ets,riak\\_kv\\_ets\\_backend,&lt;0.245.0&gt;},
 {fs,riak\\_kv\\_fs\\_backend,
 {state,
 
"/var/lib/riak/fs/342539446249430371453988632667878832731859189760"}},
 {cache,riak\\_kv\\_cache\\_backend,&lt;0.246.0&gt;},
 {my\\_backend,my\\_backend,{}}],
 bitcask},
 {dict,0,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 []}}},
 false},
 undefined,none,60000}
\\*\\* Reason for termination = 
\\*\\* {bad\\_return\\_value,
 {riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}

=CRASH REPORT==== 19-Jan-2011::02:20:04 ===
 crasher:
 initial call: riak\\_core\\_vnode:init/1
 pid: &lt;0.242.0&gt;
 registered\\_name: []
 exception exit: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 in function gen\\_fsm:terminate/7
 in call from proc\\_lib:init\\_p\\_do\\_apply/3
 ancestors: [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]
 messages: []
 links: [&lt;0.245.0&gt;,&lt;0.246.0&gt;,&lt;0.103.0&gt;]
 dictionary: []
 trap\\_exit: true
 status: running
 heap\\_size: 233
 stack\\_size: 24
 reductions: 29365
 neighbours:
 neighbour: 
[{pid,&lt;0.246.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_cache\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.242.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.242.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,40}]
 neighbour: 
[{pid,&lt;0.245.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_ets\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.242.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.242.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,135}]

=SUPERVISOR REPORT==== 19-Jan-2011::02:20:04 ===
 Supervisor: {local,riak\\_core\\_vnode\\_sup}
 Context: child\\_terminated
 Reason: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 Offender: 
[{pid,&lt;0.242.0&gt;},{name,undefined},{mfa,{riak\\_core\\_vnode,start\\_link,[riak\\_kv\\_vnode,342539446249430371453988632667878832731859189760]}},{restart\\_type,temporary},{shutdown,brutal\\_kill},{child\\_type,worker}]


=ERROR REPORT==== 19-Jan-2011::02:20:04 ===
\\*\\* State machine &lt;0.237.0&gt; terminating 
\\*\\* Last event in was {riak\\_vnode\\_req\\_v1,
 319703483166135013357056057156686910549735243776,
 {fsm,undefined,&lt;0.6356.0&gt;},
 {riak\\_kv\\_put\\_req\\_v1,
 {&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;},
 {r\\_object,&lt;&lt;"b"&gt;&gt;,&lt;&lt;"c"&gt;&gt;,
 [{r\\_content,
 {dict,2,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],
 [[&lt;&lt;"X-Riak-VTag"&gt;&gt;,52,116,101,83,99,116,51,84,
 86,105,48,76,50,118,49,90,88,86,82,55,53,78]],
 [],[],
 [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|
 {1295,432404,650963}]],
 [],[]}}},
 &lt;&lt;"d"&gt;&gt;}],
 [{&lt;&lt;4,137,66,204&gt;&gt;,{1,63462651604}}],
 {dict,1,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 [[clean|true]],
 []}}},
 undefined},
 38769885,63462651604,[]}}
\\*\\* When State == active
\\*\\* Data == {state,319703483166135013357056057156686910549735243776,
 riak\\_kv\\_vnode,
 {state,319703483166135013357056057156686910549735243776,
 riak\\_kv\\_multi\\_backend,
 {state,
 [{bitcask,riak\\_kv\\_bitcask\\_backend,
 {#Ref&lt;0.0.0.725&gt;,
 
"/var/lib/riak/bitcask/319703483166135013357056057156686910549735243776"}},
 {dets,riak\\_kv\\_dets\\_backend,
 {state,
 
'319703483166135013357056057156686910549735243776',
 
"/var/lib/riak/dets/319703483166135013357056057156686910549735243776"}},
 {ets,riak\\_kv\\_ets\\_backend,&lt;0.240.0&gt;},
 {fs,riak\\_kv\\_fs\\_backend,
 {state,
 
"/var/lib/riak/fs/319703483166135013357056057156686910549735243776"}},
 {cache,riak\\_kv\\_cache\\_backend,&lt;0.241.0&gt;},
 {my\\_backend,my\\_backend,{}}],
 bitcask},
 {dict,0,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
 {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],
 []}}},
 false},
 undefined,none,60000}
\\*\\* Reason for termination = 
\\*\\* {bad\\_return\\_value,
 {riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}

=CRASH REPORT==== 19-Jan-2011::02:20:04 ===
 crasher:
 initial call: riak\\_core\\_vnode:init/1
 pid: &lt;0.237.0&gt;
 registered\\_name: []
 exception exit: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 in function gen\\_fsm:terminate/7
 in call from proc\\_lib:init\\_p\\_do\\_apply/3
 ancestors: [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]
 messages: []
 links: [&lt;0.240.0&gt;,&lt;0.241.0&gt;,&lt;0.103.0&gt;]
 dictionary: []
 trap\\_exit: true
 status: running
 heap\\_size: 233
 stack\\_size: 24
 reductions: 29611
 neighbours:
 neighbour: 
[{pid,&lt;0.241.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_cache\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.237.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.237.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,40}]
 neighbour: 
[{pid,&lt;0.240.0&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_ets\\_backend,init,[Argument\\_\\_1]}},{current\\_function,{gen\\_server,loop,6}},{ancestors,[&lt;0.237.0&gt;,riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.101.0&gt;]},{messages,[]},{links,[&lt;0.237.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,233},{stack\\_size,9},{reductions,135}]

=SUPERVISOR REPORT==== 19-Jan-2011::02:20:04 ===
 Supervisor: {local,riak\\_core\\_vnode\\_sup}
 Context: child\\_terminated
 Reason: 
{bad\\_return\\_value,{riak\\_kv\\_multi\\_backend,undefined\\_backend,&lt;&lt;"my\\_backend"&gt;&gt;}}
 Offender: 
[{pid,&lt;0.237.0&gt;},{name,undefined},{mfa,{riak\\_core\\_vnode,start\\_link,[riak\\_kv\\_vnode,319703483166135013357056057156686910549735243776]}},{restart\\_type,temporary},{shutdown,brutal\\_kill},{child\\_type,worker}]

