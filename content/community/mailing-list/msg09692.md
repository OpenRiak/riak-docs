---
title: "Re: vclock, vtag, entity tag"
description: ""
project: community
lastmod: 2012-12-28T05:33:51-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09692"
mailinglist_parent_id: "msg09688"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2012-12-28T05:33:51-08:00
---


Let me clarify a bit:

1) There is only one vclock in a response, but at one time prior to
you requesting the key, the vclock of individual replicas were
divergent, which results in the siblings.
2) The ETag is related to the "vtag" but is not exactly the same.
Reading the riak\\_kv source gives us this function:

generate\\_etag(RD, Ctx) -&gt;
 case select\\_doc(Ctx) of
 {MD, \\_} -&gt;
 {dict:fetch(?MD\\_VTAG, MD), RD, Ctx};
 multiple\\_choices -&gt;
 {ok, Doc} = Ctx#ctx.doc,
 &lt;&gt; =
crypto:md5(term\\_to\\_binary(riak\\_object:vclock(Doc))),
 {riak\\_core\\_util:integer\\_to\\_list(ETag, 62), RD, Ctx}
 end.

Also at 
https://github.com/basho/riak\\_kv/blob/master/src/riak\\_kv\\_wm\\_object.erl#L861

What that means is, when there is a single item (either when you have
selected the vtag from a list, or when there are no siblings), the
internal "MD\\_VTAG" metadata is given as the ETag, i.e. the first
clause of the case statement. When there are multiple choices, i.e.
all siblings are listed by vtag or presented in full, then the ETag is
an MD5 hash of the vclock, i.e. the second clause of the case
statement.

Over Protocol Buffers, the same applies, the 'vtag' field is extracted
from the metadata from each sibling. However, there is no top-level
ETag per se, but the encoded vector clock is used for conditional
requests.

On Thu, Dec 27, 2012 at 9:15 PM, Shuhao Wu  wrote:
&gt; Then what exactly is etag/vtag.
&gt;
&gt; Shuhao
&gt;
&gt; On Dec 27, 2012 7:16 PM, "Pavan Venkatesh"  wrote:
&gt;&gt;
&gt;&gt; With 2 siblings, you'll still have 1 vector clock (no matter if its
&gt;&gt; through http or protobuf).
&gt;&gt; Each sibling will have the same vector clock.
&gt;&gt;
&gt;&gt; Pavan
&gt;&gt;
&gt;&gt; From: Shuhao Wu 
&gt;&gt; Date: Thursday, December 27, 2012 2:22 PM
&gt;&gt; To: Pavan Venkatesh 
&gt;&gt; Cc: 
&gt;&gt; Subject: Re: vclock, vtag, entity tag
&gt;&gt;
&gt;&gt; Wait. So with 2 siblings, I should get 2 different vclock and 2 etags from
&gt;&gt; http.
&gt;&gt;
&gt;&gt; But the specification from pbc tells me it will only return 1 vclock and 2
&gt;&gt; vtags
&gt;&gt;
&gt;&gt; Shuhao
&gt;&gt; Sent from my phone.
&gt;&gt;
&gt;&gt; On 2012-12-27 5:19 PM, "Pavan Venkatesh"  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Shuhao,
&gt;&gt;&gt;
&gt;&gt;&gt; Lets say, two clients update the same object at the same time (through
&gt;&gt;&gt; http or protobuf),then a sibling is created, but with the same vector
&gt;&gt;&gt; clock.They merge into single object with one vector clock, but these
&gt;&gt;&gt; siblings live in the same object.
&gt;&gt;&gt; User intervention is required and one can pick the correct value and
&gt;&gt;&gt; issue
&gt;&gt;&gt; a put request with that vector clock in order to resolve the conflict.
&gt;&gt;&gt; Hope this helps.
&gt;&gt;&gt;
&gt;&gt;&gt; Pavan
&gt;&gt;&gt;
&gt;&gt;&gt; On 12/25/12 10:08 PM, "Shuhao"  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;Hi,
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;I'm just browsing through the API documentations for Riak and I just
&gt;&gt;&gt; &gt;noticed a couple of things that's pretty confusing:
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;It's my understanding that with the HTTP fetch request, each
&gt;&gt;&gt; &gt;object/sibling returned will have its own vclock in the form of the HTTP
&gt;&gt;&gt; &gt;header `X-Riak-Vclock` and an entity tag under the header `ETag`. There
&gt;&gt;&gt; &gt;is also a vtag url parameter specified by the HTTP fetch request which I
&gt;&gt;&gt; &gt;assume fetches specific sibling with that entity tag. [1]
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;[1]:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; &gt;http://docs.basho.com/riak/latest/references/apis/http/HTTP-Fetch-Object/
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;However, the protobuf client will return a list of siblings but only
&gt;&gt;&gt; &gt;with 1 vclock with `optional bytes vclock = 2;` for all the siblings
&gt;&gt;&gt; &gt;returned under `content`. For each sibling, there will be a `vtag`
&gt;&gt;&gt; &gt;attribute, which I assume is the entity tag as specified in the HTTP
&gt;&gt;&gt; &gt;document. [2]
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;[2]:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; &gt;http://docs.basho.com/riak/latest/references/apis/protocol-buffers/PBC-Fet
&gt;&gt;&gt; &gt;ch
&gt;&gt;&gt; &gt;-Object/
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;So the confusion is that why is it that in the HTTP request, each
&gt;&gt;&gt; &gt;sibling has its own vclock and entity tag/vtag while in the PBC request,
&gt;&gt;&gt; &gt;the entire response only has 1 vclock and each object has its own
&gt;&gt;&gt; &gt;vtag/entity tag. I'm not too sure if my understanding is complete.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;Thanks,
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;Shuhao
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; &gt;riak-users mailing list
&gt;&gt;&gt; &gt;riak-users@lists.basho.com
&gt;&gt;&gt; &gt;http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; &gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;



-- 
Sean Cribbs 
Software Engineer
Basho Technologies, Inc.
http://basho.com/

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

