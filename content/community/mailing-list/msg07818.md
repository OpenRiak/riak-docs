---
title: "Re: Throughput issue contd. On Joyend Riak Smartmachine"
description: ""
project: community
lastmod: 2012-06-27T06:41:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07818"
mailinglist_parent_id: "msg07809"
author_name: "Reid Draper"
project_section: "mailinglistitem"
sent_date: 2012-06-27T06:41:42-07:00
---

On Jun 27, 2012, at 8:41 AM, Yousuf Fauzan wrote:

&gt; So I created an array of clients using the following code
&gt; 
&gt; Clients = [riak.RiakClient(e, port=8087, 
&gt; transport\\_class=riak.RiakPbcTransport) for e in NODES]

Sounds like you're bringing your concurrency back down to 3 (because you have 
three nodes). Give
something like 10 connections \\_per\\_ node a try, so 30 connections.

&gt; 
&gt; After this I assigned each thread a particular id ranging from 0 to Number of 
&gt; Nodes
&gt; 
&gt; So each thread now communicates with a single node.
&gt; 
&gt; Even after this, I am getting &lt;100 writes/sec
&gt; 
&gt; 
&gt; On Wed, Jun 27, 2012 at 5:35 PM, Yousuf Fauzan  wrote:
&gt; Oh! I think that may be an issue with my code then.
&gt; 
&gt; Let me make some changes and get back to you.
&gt; 
&gt; 
&gt; On Wed, Jun 27, 2012 at 5:25 PM, Reid Draper  wrote:
&gt; 
&gt; On Jun 27, 2012, at 7:48 AM, Yousuf Fauzan wrote:
&gt; 
&gt;&gt; This is great.
&gt;&gt; 
&gt;&gt; I was loading data using Python. My code would spawn 10 threads and put data 
&gt;&gt; in a queue. All threads would read data from this queue.
&gt;&gt; However, all threads were hitting the same server/load balancer.
&gt;&gt; 
&gt;&gt; I tried a different setup too. Where I spawned processes with each process 
&gt;&gt; having its own queue. In this case too, all processes were hitting the same 
&gt;&gt; server.
&gt;&gt; 
&gt;&gt; I just now made a change to my code. So now I have 10 threads randomly 
&gt;&gt; selecting a node and storing data in it.
&gt;&gt; Again, I am getting around 50 writes/sec
&gt; 
&gt; When the threads randomly pick a node, do they create a new connection to it, 
&gt; or do they pull the connection from
&gt; a pool? As you saw with the throughput difference between curl and python, 
&gt; persistent connections make
&gt; big difference.
&gt; 
&gt;&gt; 
&gt;&gt; Could there be something wrong with the way I have written my loader script?
&gt;&gt; 
&gt;&gt; On Wed, Jun 27, 2012 at 5:10 PM, Russell Brown  wrote:
&gt;&gt; 
&gt;&gt; On 27 Jun 2012, at 12:36, Yousuf Fauzan wrote:
&gt;&gt; 
&gt;&gt;&gt; So I changed concurrency to 10 and put all the IPs of the nodes in basho 
&gt;&gt;&gt; bench config.
&gt;&gt;&gt; Throughput is now around 1500.
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; I guess you can now try 5 or 15 concurrent workers and see which is optimal 
&gt;&gt; for that set up to get a good feel for the sizing of any connection pools 
&gt;&gt; for your application.
&gt;&gt; 
&gt;&gt; You can also see how adding nodes and adding workers effects your results to 
&gt;&gt; help you size the cluster you need for your expected usage.
&gt;&gt; 
&gt;&gt; Cheers
&gt;&gt; 
&gt;&gt; Russell
&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Wed, Jun 27, 2012 at 4:40 PM, Russell Brown  
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; On 27 Jun 2012, at 12:09, Yousuf Fauzan wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I used examples/riakc\\_pb.config
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {mode, max}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {duration, 10}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {concurrent, 1}.
&gt;&gt;&gt; 
&gt;&gt;&gt; Try upping this. On my local 3 node cluster with 8gb ram and an old, cheap 
&gt;&gt;&gt; quad core per box I'd set concurrency to 10 workers.
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {driver, basho\\_bench\\_driver\\_riakc\\_pb}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {key\\_generator, {int\\_to\\_bin, {uniform\\_int, 10000}}}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {value\\_generator, {fixed\\_bin, 10000}}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {riakc\\_pb\\_ips, [{}]}.
&gt;&gt;&gt; 
&gt;&gt;&gt; I add all the IPs here, one entry per node.
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {riakc\\_pb\\_replies, 1}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; {operations, [{get, 1}, {update, 1}]}.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Wed, Jun 27, 2012 at 4:37 PM, Russell Brown  
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On 27 Jun 2012, at 12:05, Yousuf Fauzan wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I did use basho bench on my clusters. It should throughput of around 150
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Could you share the config you used, please?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Wed, Jun 27, 2012 at 4:24 PM, Russell Brown  
&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On 27 Jun 2012, at 11:50, Yousuf Fauzan wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Its not about the difference in throughput in the two approaches I took. 
&gt;&gt;&gt;&gt;&gt;&gt; Rather, the issue is that even 200 writes/sec is a bit on the lower side.
&gt;&gt;&gt;&gt;&gt;&gt; I could be doing something wrong with the configuration because people 
&gt;&gt;&gt;&gt;&gt;&gt; are reporting throughputs of 2-3k ops/sec
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; If anyone here could guide me in setting up a cluster which would give 
&gt;&gt;&gt;&gt;&gt;&gt; such kind of throughput.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; To get the kind of throughput I use multiple threads / workers. Have you 
&gt;&gt;&gt;&gt;&gt; looked at basho\\_bench[1], it is a simple, reliable tool to benchmark Riak 
&gt;&gt;&gt;&gt;&gt; clusters?
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Cheers
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Russell
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; [1] Basho Bench - https://github.com/basho/basho\\_bench and 
&gt;&gt;&gt;&gt;&gt; http://wiki.basho.com/Benchmarking.html
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Thanks,
&gt;&gt;&gt;&gt;&gt;&gt; Yousuf
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Wed, Jun 27, 2012 at 4:02 PM, Eric Anderson  
&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; On Jun 27, 2012, at 5:13 AM, Yousuf Fauzan  
&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I setup a 3 machine riak SM cluster. Each machine used 4GB Ram and riak 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; OpenSource SmartMachine Image.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Afterwards I tried loading data by following two methods
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1. Bash script
&gt;&gt;&gt;&gt;&gt;&gt;&gt; #!/bin/bash
&gt;&gt;&gt;&gt;&gt;&gt;&gt; echo $(date)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; for (( c=1; c&lt;=1000; c++ ))
&gt;&gt;&gt;&gt;&gt;&gt;&gt; do
&gt;&gt;&gt;&gt;&gt;&gt;&gt; curl -s -d 'this is a test' -H "Content-Type: text/plain" 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://127.0.0.1:8098/buckets/test/keys
&gt;&gt;&gt;&gt;&gt;&gt;&gt; done
&gt;&gt;&gt;&gt;&gt;&gt;&gt; echo $(date)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2. Python Riak Client
&gt;&gt;&gt;&gt;&gt;&gt;&gt; c=riak.RiakClient("10.112.2.185") 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b=c.bucket("test")
&gt;&gt;&gt;&gt;&gt;&gt;&gt; for i in xrange(10000):o=b.new(str(i), str(i)).store()
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; For case 1, throughput was 25 writes/sec
&gt;&gt;&gt;&gt;&gt;&gt;&gt; For case 2, throughput was 200 writes/sec
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Maybe I am making a fundamental mistake somewhere. I tried the above 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; two scripts on EC2 clusters too and still got the same performance.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Please, someone help
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; The major difference between these two is the first is executing a 
&gt;&gt;&gt;&gt;&gt;&gt; binary, which has to basically create everything (connection, payload, 
&gt;&gt;&gt;&gt;&gt;&gt; etc) every time through the loop. The second does not - it creates the 
&gt;&gt;&gt;&gt;&gt;&gt; client once, then iterates over it keeping the same client and 
&gt;&gt;&gt;&gt;&gt;&gt; presumably the same connection as well. That makes a huge difference.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; I would not use curl to do performance testing. What you probably want 
&gt;&gt;&gt;&gt;&gt;&gt; is something like your python script that will work on many 
&gt;&gt;&gt;&gt;&gt;&gt; threads/processes at once (or fire them up many times).
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Eric Anderson
&gt;&gt;&gt;&gt;&gt;&gt; Co-Founder
&gt;&gt;&gt;&gt;&gt;&gt; CopperEgg
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 

