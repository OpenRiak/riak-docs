---
title: "Re: Issues with MapReduce in Riak 1.1.0"
description: ""
project: community
lastmod: 2012-02-27T19:53:08-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06772"
mailinglist_parent_id: "msg06735"
author_name: "Jon Meredith"
project_section: "mailinglistitem"
sent_date: 2012-02-27T19:53:08-08:00
---


Yes, a mixed cluster of 1.0.x and 1.1.0 would be affected for the first and
third issues. If you aren't using javascript MapReduce you won't be
affected by the second issue on either.

For all interested parties, we've made progress on the first two issues
(mixed clusters and javascript leak) and have reviewed/merged fixes onto
the 1.1 branch ready for a 1.1.1 release. We are still reviewing fixes for
the third issue (keylisting continues after cancel) and hope to have it
wrapped up soon so we can provide a point release.

Jon.

On Fri, Feb 24, 2012 at 6:03 PM, Michael Clemmons
wrote:

&gt; I think I know the answer to this but would using a mix of 1.0.X and 1.1.0
&gt; together cause the same MapReduce issue?
&gt;
&gt; On Fri, Feb 24, 2012 at 4:56 PM, Jon Meredith  wrote:
&gt;
&gt;&gt; Issues have been reported by users and customers with the MapReduce
&gt;&gt; subsystem in Riak 1.1.0.
&gt;&gt;
&gt;&gt; 1) MapReduce fails in clusters that contain both 1.1.0 and older nodes
&gt;&gt; 2) Javascript MapReduce jobs leak Javascript VMs under some failure
&gt;&gt; conditions.
&gt;&gt; 3) Keylisting continues after bucket MapReduce is cancelled/timeout
&gt;&gt;
&gt;&gt; We are actively investigating these issues to be resolved in an
&gt;&gt; upcoming point release. We will update the individual issue
&gt;&gt; trackers as we make progress.
&gt;&gt;
&gt;&gt; = Issue: MapReduce fails in clusters that contain both 1.1.0 and older
&gt;&gt; nodes =
&gt;&gt;
&gt;&gt; Description:
&gt;&gt;
&gt;&gt; The 1.1.0 release has enhancements to the way requests are
&gt;&gt; routed between nodes. It includes a legacy mode for use while
&gt;&gt; clusters are being upgraded, using the original routing used in
&gt;&gt; the 1.0 series and before. Code required to support legacy
&gt;&gt; routing for MapReduce requests was omitted.
&gt;&gt;
&gt;&gt; What version of Riak is affected?
&gt;&gt;
&gt;&gt; Open Source and Enterprise versions of Riak 1.1.0 are affected.
&gt;&gt;
&gt;&gt; Are all users affected?
&gt;&gt;
&gt;&gt; This issue only arises during a rolling upgrade. Users will be
&gt;&gt; unable to issue MapReduce jobs while there remains 1.0.x or
&gt;&gt; 0.14.x nodes in the cluster.
&gt;&gt;
&gt;&gt; Users that are not using MapReduce, or who have clusters
&gt;&gt; containing only 1.1.0 nodes are unaffected.
&gt;&gt;
&gt;&gt; Can I safely upgrade to 1.1.0 if I am not using MapReduce?
&gt;&gt;
&gt;&gt; Yes
&gt;&gt;
&gt;&gt; Issue Tracker:
&gt;&gt;
&gt;&gt; https://github.com/basho/riak\\_core/issues/144
&gt;&gt;
&gt;&gt; = Issue: Javascript MapReduce jobs leak Javascript VMs under some failure
&gt;&gt; conditions =
&gt;&gt;
&gt;&gt; Description:
&gt;&gt;
&gt;&gt; Javascript MapReduce uses a pool of Javascript virtual machines
&gt;&gt; inside Riak. There are some edge cases where MapReduce jobs are
&gt;&gt; cancelled (due to timeouts/dropped connections) where the VMs
&gt;&gt; are not returned to the pool. Eventually all Javascript VMs in
&gt;&gt; the pool can become exhausted so that no further Javascript
&gt;&gt; MapReduce jobs can run until the node is restarted.
&gt;&gt;
&gt;&gt; What version of Riak is affected?
&gt;&gt;
&gt;&gt; Open Source and Enterprise versions of Riak 1.0.x and 1.1.0 are
&gt;&gt; affected.
&gt;&gt;
&gt;&gt; Are all users affected?
&gt;&gt;
&gt;&gt; Only users using Javascript MapReduce are affected.
&gt;&gt;
&gt;&gt; Can I safely upgrade to 1.1.0 if I am not using Javascript MapReduce?
&gt;&gt;
&gt;&gt; Yes.
&gt;&gt;
&gt;&gt; Issue Tracker:
&gt;&gt;
&gt;&gt; https://github.com/basho/riak\\_kv/issues/287
&gt;&gt;
&gt;&gt; = Issue: Keylisting continues after bucket MapReduce is cancelled/timeout
&gt;&gt; =
&gt;&gt;
&gt;&gt; Description:
&gt;&gt;
&gt;&gt; If MapReduce against a bucket is cancelled (timeout or dropped
&gt;&gt; client connection) the listkeys feeding the objects from the
&gt;&gt; bucket continues to run and generates a large number of error
&gt;&gt; messages:
&gt;&gt;
&gt;&gt; "Pipe worker startup failed:fitting was gone before startup"
&gt;&gt;
&gt;&gt; Additionally, these running listkey jobs continue to tie up
&gt;&gt; resources that would otherwise be capable of running other
&gt;&gt; MapReduce queries. If enough listkey jobs end up in this state,
&gt;&gt; subsequent MapReduce queries will be unable to complete and
&gt;&gt; will timeout. In the worst case, all MapReduce queries
&gt;&gt; submitted will timeout until the running listkeys eventually
&gt;&gt; terminate and the cluster recovers.
&gt;&gt;
&gt;&gt; What version of Riak is affected?
&gt;&gt;
&gt;&gt; Riak 1.0.x and 1.1.0 are both affected. The listkeys
&gt;&gt; back-pressure mechanism added in 1.1.0 has increased the
&gt;&gt; recovery time from the issue.
&gt;&gt;
&gt;&gt; Are all users affected?
&gt;&gt;
&gt;&gt; This affects users that are seeing frequent timeouts with
&gt;&gt; bucket MapReduce.
&gt;&gt;
&gt;&gt; Can I safely upgrade to 1.1.0 if I am not using MapReduce?
&gt;&gt;
&gt;&gt; Yes.
&gt;&gt;
&gt;&gt; Issue Tracker
&gt;&gt;
&gt;&gt; https://github.com/basho/riak\\_kv/issues/293
&gt;&gt;
&gt;&gt; --
&gt;&gt; Jon Meredith
&gt;&gt; Platform Engineering Manager
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; jmered...@basho.com
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; -Michael
&gt;
&gt;


-- 
Jon Meredith
Platform Engineering Manager
Basho Technologies, Inc.
jmered...@basho.com
