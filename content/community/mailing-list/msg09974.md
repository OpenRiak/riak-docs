---
title: "Re: Parameter Planning (eleveldb)"
description: ""
project: community
lastmod: 2013-02-03T14:45:04-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09974"
mailinglist_parent_id: "msg09973"
author_name: "Simon Effenberg"
project_section: "mailinglistitem"
sent_date: 2013-02-03T14:45:04-08:00
---


Hi Matthew,

thanks a lot!

So now I have:

6 nodes each having 32GB RAM:

vnode\\_working\\_memory = 16GB / 256 / 6 (50% of RAM devided by ringsize
devided by nodes) = 390 MB

open\\_file\\_memory =
 (max\\_open\\_files-10) \\* (
 184 + (104MB/2048) \\*
 (8 + ((16+14336)/2048 +1) \\*
 0.6
 )

Now I'm missing the max\\_open\\_files .. how to calculate it?
I'm missing also average\\_write\\_buffer\\_size (see my question in Step 4).

If I would use the default values for average\\_write\\_buffer\\_size the
max\\_open\\_files could be calculated like:

memory/vnode = average\\_write\\_buffer\\_size + cache\\_size +
open\\_file\\_memory + 20 MB
&lt;=&gt; (memory/vnode) - 20 MB - cache\\_size - average\\_write\\_buffer\\_size =
 open\\_file\\_memory

so with the default values:

open\\_file\\_memory = 390MB - 20MB - 8MB - 45MB = 317MB

and now max\\_open\\_files would be

open\\_file\\_memory = (max\\_open\\_files-10) \\* (184 + (104MB/2048) \\* (8 + ((16
 +14336)/2048 +1) \\* 0.6 )
&lt;=&gt; (max\\_open\\_files-10) = open\\_file\\_memory / (184 + (104MB/2048) \\* (8 +
 ((16+14336)/2048 +1) \\* 0.6 )
&lt;=&gt; max\\_open\\_files = open\\_file\\_memory / (184 + (104MB/2048) \\* (8 +
 ((16+14336)/2048 +1) \\* 0.6 ) + 10
&lt;=&gt; max\\_open\\_files = 317MB / (184+53248\\*(8+67.8)) + 10
&lt;=&gt; max\\_open\\_files = 317MB / 4036382.4 + 10
&lt;=&gt; max\\_open\\_files ~= 92

That would be the maximum amount of open files a server can handle
(per vnode), am I right? But now, is this enough? Or how to calculate
50% temporary server loss (3 of 6) and how is the count of keys/values
is taking into account? I'm somehow lost :(

Cheers
Simon

On Sun, 3 Feb 2013 16:12:25 -0500
Matthew Von-Maszewski  wrote:

&gt; First: Step 2 is talking about how many vnodes exist on a physical server. 
&gt; If your ring size is 256, but you have 8 servers … then your vnode count for 
&gt; step 2 is 32.
&gt; 
&gt; Second: the 2048 is a constant forced by Google's leveldb implementation. 
&gt; It is the portion of a file covered by a single bloom filter. This 
&gt; calculation constant disappears with the upcoming 1.3 release.
&gt; 
&gt; Third: yes there is a "block\\_size" parameter that is 4096. Increase that 
&gt; only if you want to REDUCE the performance of the leveldb instance. 4096 is 
&gt; a very happy value. We have customers and tests with 130K data values, all 
&gt; using 4096 block size. The block\\_size only governs the minimum written 
&gt; (aggregate size of small values that must be written as one unit at minimum).
&gt; 
&gt; Use 104Mbyte for your average sst file size. It is "good enough"
&gt; 
&gt; 
&gt; I am not following the question stream for Step 4 and beyond. Please state 
&gt; again.
&gt; 
&gt; Matthew
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Feb 3, 2013, at 3:44 PM, Simon Effenberg  wrote:
&gt; 
&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; I'm not sure if I understand this all well to calculate the memory
&gt; &gt; usage per file and other stuff.
&gt; &gt; 
&gt; &gt; The webpage tells me some steps but I'm completly unsure if I understand 
&gt; &gt; all parameters.
&gt; &gt; 
&gt; &gt; "Step 1: Calculate Available Working Memory"
&gt; &gt; 
&gt; &gt; taking the example:
&gt; &gt; 
&gt; &gt; leveldb\\_working\\_memory = 32G \\* (1 - .50) = 16G
&gt; &gt; 
&gt; &gt; "Step 2: Calculate Working Memory per vnode"
&gt; &gt; 
&gt; &gt; vnode\\_working\\_memory = leveldb\\_working\\_memory / vnode\\_count
&gt; &gt; 
&gt; &gt; vnode\\_count = 256
&gt; &gt; 
&gt; &gt; =&gt; vnode\\_working\\_memory = 16G / 256 = 64MB/vnode
&gt; &gt; 
&gt; &gt; also easy
&gt; &gt; 
&gt; &gt; "Step 3: Estimate Memory Used by Open Files"
&gt; &gt; 
&gt; &gt; open\\_file\\_memory =
&gt; &gt; (max\\_open\\_files-10) \\* (
&gt; &gt; 184 + (average\\_sst\\_filesize/2048) \\*
&gt; &gt; (8 + ((average\\_key\\_size+average\\_value\\_size)/2048 +1) \\*
&gt; &gt; 0.6
&gt; &gt; )
&gt; &gt; 
&gt; &gt; so how do I know the average\\_sst\\_filesize (and what is this value exactly)
&gt; &gt; (and is 2048 for both /2048 true or 4096 in riak 1.2?) and how do I know
&gt; &gt; the max\\_open\\_files?
&gt; &gt; 
&gt; &gt; 
&gt; &gt; average\\_key\\_size could be 16byte (I have to ask someone but taking it for 
&gt; &gt; now)
&gt; &gt; average\\_value\\_size will be 14kbyte 
&gt; &gt; 
&gt; &gt; so for now
&gt; &gt; 
&gt; &gt; open\\_file\\_memory =
&gt; &gt; (max\\_open\\_files-10) \\* (
&gt; &gt; 184 + (average\\_sst\\_filesize/2048) \\*
&gt; &gt; (8 + ((16+14336)/2048 +1) \\*
&gt; &gt; 0.6
&gt; &gt; )
&gt; &gt; 
&gt; &gt; (side question: should I increase the block\\_size because of the big average 
&gt; &gt; value size?
&gt; &gt; and also should I leave the cache\\_size at the default value like it was 
&gt; &gt; recommended?)
&gt; &gt; 
&gt; &gt; "Step 4: Calculate Average Write Buffer"
&gt; &gt; 
&gt; &gt; should I increase these values or not? If only two are held in memory and I 
&gt; &gt; have, as an
&gt; &gt; example, 32GB or RAM like in this scenario, shouldn't I increase it to 
&gt; &gt; something else?
&gt; &gt; 
&gt; &gt; "Step 5: Calculate vnode Memory Used"
&gt; &gt; 
&gt; &gt; memory/vnode = average\\_write\\_buffer\\_size + cache\\_size + open\\_file\\_memory + 
&gt; &gt; 20 MB
&gt; &gt; 
&gt; &gt; So for now I miss almost all 3 values :(.
&gt; &gt; 
&gt; &gt; To get an Idea:
&gt; &gt; 
&gt; &gt; - 3 buckets
&gt; &gt; - overall ~ 343347732 keys (but only 2/3 have 14kbyte in average)
&gt; &gt; 
&gt; &gt; 
&gt; &gt; Thx for help!
&gt; &gt; Simon
&gt; &gt; 
&gt; 


-- 
Simon Effenberg | Site Ops Engineer | mobile.international GmbH
Fon: + 49-(0)30-8109 - 7173
Fax: + 49-(0)30-8109 - 7131

Mail: seffenb...@team.mobile.de
Web: www.mobile.de

Marktplatz 1 | 14532 Europarc Dreilinden | Germany


Geschäftsführer: Malte Krüger
HRB Nr.: 18517 P, Amtsgericht Potsdam
Sitz der Gesellschaft: Kleinmachnow 

