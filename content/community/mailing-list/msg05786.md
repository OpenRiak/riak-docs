---
title: "Re: Multiple keys to fetch in a Java client"
description: ""
project: community
lastmod: 2011-11-29T06:56:50-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05786"
mailinglist_parent_id: "msg05785"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2011-11-29T06:56:50-08:00
---


Oh, you replied already.

Please can you use a gist or pastebin for larger blocks of code? They're much 
easier to read.

On 29 Nov 2011, at 14:49, suresh chandran wrote:

&gt; Hi Russel,
&gt; 
&gt; After your mail, I altered the code as
&gt; 
&gt; public static boolean fetchAll(String bucket, Collection keys,
&gt; StringBuilder response)
&gt; {
&gt; Iterator valuesIter = keys.iterator();
&gt; try
&gt; {
&gt; IRiakClient iriakClient = 
&gt; RiakFactory.httpClient("http://127.0.0.1:8091/riak";);
&gt; BucketKeyMapReduce reduce = iriakClient.mapReduce();
&gt; while (valuesIter.hasNext())
&gt; {
&gt; String value = valuesIter.next();
&gt; reduce.addInput(bucket, value);
&gt; }
&gt; reduce.addMapPhase(new NamedJSFunction("Riak.mapValuesJson"));
&gt; MapReduceResult result = reduce.execute();
&gt; }
&gt; ...
&gt; }
&gt; 
&gt; But I get the below exception.
&gt; 
&gt; com.basho.riak.client.RiakException: java.io.IOException: 
&gt; {"lineno":477,"message":"JSON.parse","source":"unknown"}

Looks like Riak's mapValuesJson js function is throwing an error parsing your 
data.

&gt; [INFO] [11/29/11 9:42 AM] [akka:event-driven:dispatcher:global-9] 
&gt; [GetMaster] Error getting data in TEST // \\*\\*\\*\\*\\*\\* TEST is the bucket name 
&gt; that I use.\\*\\*\\*\\*\\*\\*\\*
&gt; at com.basho.riak.client.query.MapReduce.execute(MapReduce.java:81)
&gt; at com.persistence.RiakConnector.fetchAll(RiakConnector.java:125)// \\*\\*\\*\\*\\*\\*\\* 
&gt; line number points to reduce.execute() method \\*\\*\\*\\*\\*\\*\\*\\*\\*
&gt; 
&gt; Thanks
&gt; Suresh C Nair
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; From: suresh chandran 
&gt; To: Russell Brown  
&gt; Cc: "riak-users@lists.basho.com"  
&gt; Sent: Tuesday, November 29, 2011 9:38 AM
&gt; Subject: Re: Multiple keys to fetch in a Java client
&gt; 
&gt; 
&gt; Hi Russel,
&gt; 
&gt; I am using a static method to get the values, which is like
&gt; public static boolean fetchAll(String bucket, Collection keys,
&gt; StringBuilder response)
&gt; {
&gt; PBClientConfig conf = new PBClientConfig.Builder()
&gt; .withHost("127.0.0.1")
&gt; .withPort(8091)
&gt; .build();
&gt; try
&gt; {
&gt; 
&gt; IRiakClient iriakClient = RiakFactory.newClient(conf);
&gt; BucketKeyMapReduce reduce = iriakClient.mapReduce();
&gt; while (valuesIter.hasNext())
&gt; {
&gt; String value = valuesIter.next();
&gt; reduce.addInput(bucket, value);
&gt; }
&gt; MapReduceResult result = reduce.execute();
&gt; .... // code to send the result to caller 
&gt; }....
&gt; I am sending only 6 strings in the collection. Whether I pass the name space 
&gt; or not, i get the below exception.
&gt; 
&gt; java.lang.OutOfMemoryError: Java heap space
&gt; at com.basho.riak.pbc.RiakConnection.receive(RiakConnection.java:82)
&gt; at 
&gt; com.basho.riak.pbc.MapReduceResponseSource.get\\_next\\_response(MapReduceResponseSource.java:86)
&gt; at 
&gt; com.basho.riak.pbc.MapReduceResponseSource.(MapReduceResponseSource.java:47)
&gt; at com.basho.riak.pbc.RiakClient.mapReduce(RiakClient.java:588)
&gt; at com.basho.riak.pbc.RiakClient.mapReduce(RiakClient.java:572)
&gt; at 
&gt; com.basho.riak.client.raw.pbc.PBClientAdapter.mapReduce(PBClientAdapter.java:413)
&gt; at com.basho.riak.client.query.MapReduce.execute(MapReduce.java:77)
&gt; 
&gt; I am using the Http RiakClient and assumed that is to be used. I shall use 
&gt; the IRiakClient here on. the IRiakClient I use is from the path 
&gt; basho-riak-java-client-5f8359c/target/riak-client-1.0.2-SNAPSHOT.jar . javap 
&gt; shows the versions as 
&gt; 
&gt; public interface com.basho.riak.client.IRiakClient
&gt; SourceFile: "IRiakClient.java"
&gt; minor version: 0
&gt; major version: 50
&gt; 
&gt; public class com.basho.riak.client.RiakFactory extends java.lang.Object
&gt; 
&gt; SourceFile: "RiakFactory.java"
&gt; minor version: 0
&gt; major version: 50
&gt; 
&gt; Let me know if you need anything in specific.
&gt; 
&gt; Thanks
&gt; Suresh C Nair
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; From: Russell Brown 
&gt; To: suresh chandran  
&gt; Cc: "riak-users@lists.basho.com"  
&gt; Sent: Tuesday, November 29, 2011 8:05 AM
&gt; Subject: Re: Multiple keys to fetch in a Java client
&gt; 
&gt; 
&gt; Hi Suresh,
&gt; 
&gt; 
&gt; 
&gt; On 29 Nov 2011, at 12:10, suresh chandran wrote:
&gt; 
&gt; Thanks Russel for the reply .
&gt;&gt; 
&gt;&gt; 
&gt;&gt; After going through all the APIs I too reached the same opinion. 
&gt;&gt; 1)Simultaneous multiple fetch and 2)MapReduce. However, simultaneous access 
&gt;&gt; would make the fetch very slower and it doesnt look efficient ( since there 
&gt;&gt; are threads spawned for each key and fetching say, 10K records might be an 
&gt;&gt; over head) let me know if I miss something here and that I shoudl not be 
&gt;&gt; concerned. My worry is not the procedure to spawn so many worker threads, 
&gt;&gt; but the number of connections they open and close and the performance 
&gt;&gt; overhead, thereby
&gt;&gt; 
&gt; 
&gt; Right, 10k is probably too many keys to fetch in parallel. Though you 
&gt; wouldn't open and close 10k connections since there is a connection pool, and 
&gt; you can set an upper bound on it when you configure your client (more on that 
&gt; below.) But you could easily use a producer/consumer set up to fetch many 
&gt; objects in parallel. It depends on what you are fetching the data for, how 
&gt; often, and what you're going to do with it.
&gt; 
&gt; 
&gt;&gt; 
&gt;&gt; I tried the map reduce in similar way that you mentioned. For weird reasons, 
&gt;&gt; it throws Java Heap memory exception and dies.
&gt;&gt; MapReduceResult result = client.mapReduce() .addInput("goog","2010-01-04") 
&gt;&gt; .addInput("goog","2010-01-05") .addInput("goog","2010-01-06") 
&gt;&gt; .addInput("goog","2010-01-07") .addInput("goog","2010-01-08") 
&gt;&gt; .addMapPhase(new NamedJSFunction("Riak.mapValuesJson"), true) .execute();
&gt;&gt; 
&gt;&gt; 
&gt;&gt; I used the same format as above mentioned in 
&gt;&gt; https://github.com/basho/riak-java-client page. I tried with and without the 
&gt;&gt; addMapPhase method, but in vain. Am I missing something here? Is there a 
&gt;&gt; prerequisite to use this code?
&gt;&gt; 
&gt; 
&gt; Curious. The code above is part of the integration test suite, it is run 
&gt; every time we build and doesn't usually throw an OOM exception. Did you call 
&gt; \\*addInput\\* 10k time in a loop before executing the map/reduce (can I see a 
&gt; snippet of code maybe, in a gist or pastebin, ideally)? Can I have a stack 
&gt; trace (a gist or pastebin is best for this also, please)? What version of the 
&gt; client did you use?
&gt; 
&gt; 
&gt;&gt; I also see that the
&gt; above methods works only for IRiakClient. Until now I have been using 
&gt; RiakClient.
&gt; 
&gt; Which one? Which version etc? There are two classes called RiakClient (both 
&gt; legacy classes (one PB, one HTTP)), you can use them, but they are likely 
&gt; going to deprecated and removed in future versions. I recommend IRiakClient 
&gt; interface.
&gt; 
&gt; Only to access these methods. I am using IRiakClient. Does that have any 
&gt; significance? way to access/ configure IRiakClient/ Mapreduce. 
&gt; 
&gt; Like a lot of Java libraries you configure/acquire a client through a 
&gt; factory. There is an example in the README on the repo home page 
&gt; (https://github.com/basho/riak-java-client) under the heading 
&gt; \\*Configuration\\*, it is lower down that page. Maybe the README needs 
&gt; re-organising a bit.
&gt; 
&gt; This is the only place I need the map reduce, 
&gt;&gt; and throughout my code, i just store and fetch key values. 
&gt; 
&gt;&gt; 
&gt;&gt; I dont seem to get the answers in the forums or documents. If there are 
&gt;&gt; any,can you please point? Thanks again.
&gt; 
&gt; The README, the integration tests, and this mailing list are the current best 
&gt; sources of help. I would like to spend some time writing some more detailed 
&gt; documentation and tutorials (ha, actually, \\_no\\_, I wouldn't, but I really 
&gt; \\*should\\*!)
&gt; 
&gt; Hopefully that helps, and if you get me that stack trace I'll try and figure 
&gt; out what is going on with the map/reduce error.
&gt; 
&gt; Cheers
&gt; 
&gt; Russell
&gt; 
&gt; 
&gt;&gt; 
&gt;&gt; Suresh C Nair 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; From: Russell Brown 
&gt;&gt; To: suresh chandran  
&gt;&gt; Cc: "riak-users@lists.basho.com"  
&gt;&gt; Sent: Monday, November 28, 2011 7:14 PM
&gt;&gt; Subject: Re: Multiple keys to fetch in a Java client
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On 28 Nov 2011, at 20:16, suresh chandran wrote:
&gt;&gt; 
&gt;&gt; May be I can make my statement clear :) I store my devices values in buckets 
&gt;&gt; named after OS (say windows/ linux) with the device id's as keys. I want to 
&gt;&gt; get the devices for a list of device ids . From what I see, the fetch API 
&gt;&gt; signature takes in bucket name and key. (Client.fetch("windows", "D1"). Is 
&gt;&gt; there a way where I can get Client.fetch("windows", ?
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; There is no multi-fetch from Riak right now. You can either fetch your 
&gt;&gt; individual keys (serially on in parallel) or run a Map/Reduce. In most case 
&gt;&gt; the Map/Reduce will be slower (though the API is simpler, I suppose.)
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Use IRiakClient.mapReduce().addInput(bucket, key).addInput(bucket, 
&gt;&gt; key2)…(repeat!) I guess this is ripe for a convenience method that takes (as 
&gt;&gt; you suggest) addInputs(bucket, Collection keys), so I'll add that to 
&gt;&gt; the features list.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Or just fetch all your keys using fetch. 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; I guess it would be possible to add a bulk fetch API to the Riak Java Client 
&gt;&gt; that spawns a configurable number of threads to fetch a bunch of keys in 
&gt;&gt; parallel, but right now that is left as an exercise for the reader :)
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Cheers
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Russell
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt;&gt; Thanks
&gt;&gt;&gt; Suresh C Nair
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; From: suresh chandran 
&gt;&gt;&gt; To: "riak-users@lists.basho.com"  
&gt;&gt;&gt; Sent: Monday, November 28, 2011 2:53 PM
&gt;&gt;&gt; Subject: Multiple keys to fetch in a Java client
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; HI,
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; I am storing values of a devices under a particular OS. I want to fetch the 
&gt;&gt;&gt; list of all vallues, based on the key list. What I see if that, I can fetch 
&gt;&gt;&gt; the value one by one using the FETCH. Am using the HttpClient in Java. How 
&gt;&gt;&gt; do I go about this? Assume I am tryign to reach the same behavior like 
&gt;&gt;&gt; query that has "CONTAINS(key1, key2...). Is there a way to do this? or we 
&gt;&gt;&gt; can fetch the values only one by one. I do see that Map-reduce, makes use 
&gt;&gt;&gt; of the list fo keys, but am not sure if it is applicable in my case, as it 
&gt;&gt;&gt; ia simple fetch with collection of / list of keys.
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks
&gt;&gt;&gt; Suresh C Nair

&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
&gt; 
&gt; 
 
