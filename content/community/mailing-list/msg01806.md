---
title: "Caching of anonymous javascript reduce phase results"
description: ""
project: community
lastmod: 2010-12-16T10:43:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01806"
author_name: "Johnathan Loggie"
project_section: "mailinglistitem"
sent_date: 2010-12-16T10:43:23-08:00
---


Hiya,

I¹m seeing a problem where when running a map reduce on some newly created
data that Riak will return [] for the final reduce phase.

 Riak::MapReduce.new(client).
 add(self.class.bucket\\_name, self.key).
 link(:tag =&gt; "batches",:keep =&gt; false).
 link(:tag =&gt; "objects",:keep =&gt; false).
 map("function(v) { return [v]; }", :keep =&gt; false).
 reduce("function(valueList, arg)
 {
 return [valueList.reduce(
 function(acc, value)
 {
 if (value.not\\_found) return acc;
 return acc.concat(value);
 }, [] )];
 }", :keep =&gt; true)

When setting keep to true on the map phase I can see that the objects are
there as the input to the reduce phase.
Now here¹s the weird part

1 If I add a line like  // #{rand} #{Time.now}  to the reduce phase, it
will work

2 If I wait a while (read several minutes) between writing the data and
running the unmodified reduce phase code it will work.

So it looks like Riak is perhaps using a cached result for the reduce phase,
which would make no sense as the inputs to the whole map reduce job are
different (as I said they are for newly created documents).

I¹ve fixed the issue for now using the solution shown in point 1 above but
am I correct in thinking that this is a bug?

Thanks

Johnno

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

