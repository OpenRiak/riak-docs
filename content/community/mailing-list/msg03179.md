---
title: "Re: Riak shutdown during heavy load testing"
description: ""
project: community
lastmod: 2011-05-02T05:02:48-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03179"
mailinglist_parent_id: "msg03165"
author_name: "Wilson Tuladhar"
project_section: "mailinglistitem"
sent_date: 2011-05-02T05:02:48-07:00
---


Hi Dan,
And thanks for the reply. But if we want to get all the keys from the bucket
then is there any other way to do that?? I am using Erlang client.

//Wilson

On Mon, May 2, 2011 at 6:42 AM, Dan Reverri  wrote:

&gt; The error message you posted indicates the list keys operation is timing
&gt; out. The list keys operation is an expensive operation and should only be
&gt; used during development or for diagnostic purposes. It should not be used
&gt; during a load test.
&gt;
&gt; Thanks,
&gt; Dan
&gt;
&gt; Daniel Reverri
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; d...@basho.com
&gt;
&gt;
&gt;
&gt; On Fri, Apr 29, 2011 at 5:57 AM, Wilson Tuladhar 
&gt; wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; Here the error that get logged into sasl-error.log file.
&gt;&gt;
&gt;&gt; =ERROR REPORT==== 29-Apr-2011::14:45:37 ===
&gt;&gt; \\*\\* State machine &lt;0.3117.0&gt; terminating
&gt;&gt; \\*\\* Last event in was timeout
&gt;&gt; \\*\\* When State == initialize
&gt;&gt; \\*\\* Data ==
&gt;&gt; {state,&lt;0.3101.0&gt;,plain,&lt;&lt;&gt;&gt;,undefined,undefined,undefined,
&gt;&gt; undefined,&lt;&lt;"Games"&gt;&gt;,
&gt;&gt; {&lt;&lt;"Games"&gt;&gt;,[]},
&gt;&gt; 60000,69622590,
&gt;&gt; {chstate,'riaksearch@127.0.0.1',
&gt;&gt; [{'riaksearch@127.0.0.1',{4,63470357906}}],
&gt;&gt; {64,
&gt;&gt; [{0,'riaksearch@127.0.0.1'},
&gt;&gt; {22835963083295358096932575511191922182123945984,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {45671926166590716193865151022383844364247891968,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {68507889249886074290797726533575766546371837952,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {91343852333181432387730302044767688728495783936,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {114179815416476790484662877555959610910619729920,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {137015778499772148581595453067151533092743675904,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {159851741583067506678528028578343455274867621888,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {182687704666362864775460604089535377456991567872,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {205523667749658222872393179600727299639115513856,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {228359630832953580969325755111919221821239459840,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {251195593916248939066258330623111144003363405824,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {274031556999544297163190906134303066185487351808,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {296867520082839655260123481645494988367611297792,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {319703483166135013357056057156686910549735243776,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {342539446249430371453988632667878832731859189760,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {365375409332725729550921208179070754913983135744,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {388211372416021087647853783690262677096107081728,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {411047335499316445744786359201454599278231027712,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {433883298582611803841718934712646521460354973696,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {456719261665907161938651510223838443642478919680,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {479555224749202520035584085735030365824602865664,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {502391187832497878132516661246222288006726811648,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {525227150915793236229449236757414210188850757632,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {548063113999088594326381812268606132370974703616,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {570899077082383952423314387779798054553098649600,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {593735040165679310520246963290989976735222595584,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {616571003248974668617179538802181898917346541568,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {639406966332270026714112114313373821099470487552,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {662242929415565384811044689824565743281594433536,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {685078892498860742907977265335757665463718379520,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {707914855582156101004909840846949587645842325504,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {730750818665451459101842416358141509827966271488,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {753586781748746817198774991869333432010090217472,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {776422744832042175295707567380525354192214163456,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {799258707915337533392640142891717276374338109440,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {822094670998632891489572718402909198556462055424,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {844930634081928249586505293914101120738586001408,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {867766597165223607683437869425293042920709947392,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {890602560248518965780370444936484965102833893376,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {913438523331814323877303020447676887284957839360,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {936274486415109681974235595958868809467081785344,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {959110449498405040071168171470060731649205731328,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {981946412581700398168100746981252653831329677312,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1004782375664995756265033322492444576013453623296,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1027618338748291114361965898003636498195577569280,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1050454301831586472458898473514828420377701515264,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1073290264914881830555831049026020342559825461248,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1096126227998177188652763624537212264741949407232,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1118962191081472546749696200048404186924073353216,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1141798154164767904846628775559596109106197299200,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1164634117248063262943561351070788031288321245184,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1187470080331358621040493926581979953470445191168,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1210306043414653979137426502093171875652569137152,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1233142006497949337234359077604363797834693083136,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1255977969581244695331291653115555720016817029120,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1278813932664540053428224228626747642198940975104,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1301649895747835411525156804137939564381064921088,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1324485858831130769622089379649131486563188867072,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1347321821914426127719021955160323408745312813056,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1370157784997721485815954530671515330927436759040,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1392993748081016843912887106182707253109560705024,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1415829711164312202009819681693899175291684651008,
&gt;&gt; 'riaksearch@127.0.0.1'},
&gt;&gt; {1438665674247607560106752257205091097473808596992,
&gt;&gt; 'riaksearch@127.0.0.1'}]},
&gt;&gt; {dict,4,16,16,8,80,48,
&gt;&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;&gt; {{[],[],[],[],
&gt;&gt; [[{bucket,&lt;&lt;"Games"&gt;&gt;}|
&gt;&gt; {meta\\_entry,
&gt;&gt; [{name,&lt;&lt;"Games"&gt;&gt;},
&gt;&gt; {n\\_val,3},
&gt;&gt; {allow\\_mult,false},
&gt;&gt; {last\\_write\\_wins,false},
&gt;&gt; {precommit,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"mod"&gt;&gt;,&lt;&lt;"riak\\_search\\_kv\\_hook"&gt;&gt;},
&gt;&gt; {&lt;&lt;"fun"&gt;&gt;,&lt;&lt;"precommit"&gt;&gt;}]}]},
&gt;&gt; {postcommit,[]},
&gt;&gt;
&gt;&gt; {chash\\_keyfun,{riak\\_core\\_util,chash\\_std\\_keyfun}},
&gt;&gt; {linkfun,
&gt;&gt;
&gt;&gt; {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}},
&gt;&gt; {old\\_vclock,86400},
&gt;&gt; {young\\_vclock,20},
&gt;&gt; {big\\_vclock,50},
&gt;&gt; {small\\_vclock,10},
&gt;&gt; {r,quorum},
&gt;&gt; {w,quorum},
&gt;&gt; {dw,quorum},
&gt;&gt; {rw,quorum}],
&gt;&gt; 63470357892}]],
&gt;&gt; [],[],
&gt;&gt; [[{bucket,&lt;&lt;"User"&gt;&gt;}|
&gt;&gt; {meta\\_entry,
&gt;&gt; [{name,&lt;&lt;"User"&gt;&gt;},
&gt;&gt; {n\\_val,3},
&gt;&gt; {allow\\_mult,false},
&gt;&gt; {last\\_write\\_wins,false},
&gt;&gt; {precommit,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"mod"&gt;&gt;,&lt;&lt;"riak\\_search\\_kv\\_hook"&gt;&gt;},
&gt;&gt; {&lt;&lt;"fun"&gt;&gt;,&lt;&lt;"precommit"&gt;&gt;}]}]},
&gt;&gt; {postcommit,[]},
&gt;&gt;
&gt;&gt; {chash\\_keyfun,{riak\\_core\\_util,chash\\_std\\_keyfun}},
&gt;&gt; {linkfun,
&gt;&gt;
&gt;&gt; {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}},
&gt;&gt; {old\\_vclock,86400},
&gt;&gt; {young\\_vclock,20},
&gt;&gt; {big\\_vclock,50},
&gt;&gt; {small\\_vclock,10},
&gt;&gt; {r,quorum},
&gt;&gt; {w,quorum},
&gt;&gt; {dw,quorum},
&gt;&gt; {rw,quorum}],
&gt;&gt; 63470357885}],
&gt;&gt; [{bucket,&lt;&lt;"Game\\_instances"&gt;&gt;}|
&gt;&gt; {meta\\_entry,
&gt;&gt; [{name,&lt;&lt;"Game\\_instances"&gt;&gt;},
&gt;&gt; {n\\_val,3},
&gt;&gt; {allow\\_mult,false},
&gt;&gt; {last\\_write\\_wins,false},
&gt;&gt; {precommit,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"mod"&gt;&gt;,&lt;&lt;"riak\\_search\\_kv\\_hook"&gt;&gt;},
&gt;&gt; {&lt;&lt;"fun"&gt;&gt;,&lt;&lt;"precommit"&gt;&gt;}]}]},
&gt;&gt; {postcommit,[]},
&gt;&gt;
&gt;&gt; {chash\\_keyfun,{riak\\_core\\_util,chash\\_std\\_keyfun}},
&gt;&gt; {linkfun,
&gt;&gt;
&gt;&gt; {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}},
&gt;&gt; {old\\_vclock,86400},
&gt;&gt; {young\\_vclock,20},
&gt;&gt; {big\\_vclock,50},
&gt;&gt; {small\\_vclock,10},
&gt;&gt; {r,quorum},
&gt;&gt; {w,quorum},
&gt;&gt; {dw,quorum},
&gt;&gt; {rw,quorum}],
&gt;&gt; 63470357900}]],
&gt;&gt; [],[],[],[],[],[],[],
&gt;&gt; [[{bucket,&lt;&lt;"Game\\_instances\\_run"&gt;&gt;}|
&gt;&gt; {meta\\_entry,
&gt;&gt; [{name,&lt;&lt;"Game\\_instances\\_run"&gt;&gt;},
&gt;&gt; {n\\_val,3},
&gt;&gt; {allow\\_mult,false},
&gt;&gt; {last\\_write\\_wins,false},
&gt;&gt; {precommit,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"mod"&gt;&gt;,&lt;&lt;"riak\\_search\\_kv\\_hook"&gt;&gt;},
&gt;&gt; {&lt;&lt;"fun"&gt;&gt;,&lt;&lt;"precommit"&gt;&gt;}]}]},
&gt;&gt; {postcommit,[]},
&gt;&gt;
&gt;&gt; {chash\\_keyfun,{riak\\_core\\_util,chash\\_std\\_keyfun}},
&gt;&gt; {linkfun,
&gt;&gt;
&gt;&gt; {modfun,riak\\_kv\\_wm\\_link\\_walker,mapreduce\\_linkfun}},
&gt;&gt; {old\\_vclock,86400},
&gt;&gt; {young\\_vclock,20},
&gt;&gt; {big\\_vclock,50},
&gt;&gt; {small\\_vclock,10},
&gt;&gt; {r,quorum},
&gt;&gt; {w,quorum},
&gt;&gt; {dw,quorum},
&gt;&gt; {rw,quorum}],
&gt;&gt; 63470357906}]]}}}},
&gt;&gt; undefined}
&gt;&gt; \\*\\* Reason for termination =
&gt;&gt; \\*\\* {timeout,{gen\\_server,call,
&gt;&gt; [{riak\\_kv\\_keylister\\_master,'riaksearch@127.0.0.1
&gt;&gt; '},
&gt;&gt;
&gt;&gt; {start\\_kl,69622590,&lt;0.3117.0&gt;,{&lt;&lt;"Games"&gt;&gt;,[]}}]}}
&gt;&gt;
&gt;&gt; =CRASH REPORT==== 29-Apr-2011::14:45:38 ===
&gt;&gt; crasher:
&gt;&gt; initial call: riak\\_kv\\_keys\\_fsm:init/1
&gt;&gt; pid: &lt;0.3117.0&gt;
&gt;&gt; registered\\_name: []
&gt;&gt; exception exit: {timeout,{gen\\_server,call,[{riak\\_kv\\_keylister\\_master,
&gt;&gt; riaksearch@127.0.0.1},{start\\_kl,69622590,&lt;0.3117.0&gt;,{&lt;&lt;"Games"&gt;&gt;,[]}}]}}
&gt;&gt; in function gen\\_fsm:terminate/7
&gt;&gt; in call from proc\\_lib:init\\_p\\_do\\_apply/3
&gt;&gt; ancestors: [&lt;0.3110.0&gt;]
&gt;&gt; messages: []
&gt;&gt; links: []
&gt;&gt; dictionary: []
&gt;&gt; trap\\_exit: true
&gt;&gt; status: running
&gt;&gt; heap\\_size: 610
&gt;&gt; stack\\_size: 24
&gt;&gt; reductions: 9906
&gt;&gt; neighbours:
&gt;&gt;
&gt;&gt;
&gt;&gt; And the functions that i have made are
&gt;&gt; %% gets all the keys in the bucket
&gt;&gt; get\\_bucket\\_keys(Bucket) -&gt;
&gt;&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),
&gt;&gt; {ok, List} = riakc\\_pb\\_socket:list\\_keys(Pid, Bucket,infinity),
&gt;&gt; riakc\\_pb\\_socket:stop(Pid),
&gt;&gt; {ok,lists:foldr(fun(Key, Acc) -&gt;
&gt;&gt; [binary\\_to\\_list(Key)|Acc]
&gt;&gt; end, [], List)}.
&gt;&gt;
&gt;&gt; %% select the Key and get the values to return
&gt;&gt; select(DB, Key, Values\\_to\\_return) -&gt;
&gt;&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("127.0.0.1", 8087),
&gt;&gt; Ret =
&gt;&gt; case riakc\\_pb\\_socket:get(Pid, list\\_to\\_binary(DB),
&gt;&gt; list\\_to\\_binary(Key)) of
&gt;&gt; {ok, FromDBObject} -&gt;
&gt;&gt; Val = to\\_list(binary\\_to\\_term(riakc\\_obj:get\\_value(FromDBObject))),
&gt;&gt; riakc\\_pb\\_socket:stop(Pid),
&gt;&gt; Return =
&gt;&gt; lists:foldr(
&gt;&gt; fun(Key\\_for\\_return, Acc)-&gt;
&gt;&gt; case proplists:get\\_value(Key\\_for\\_return, Val) of
&gt;&gt; undefined -&gt; Acc;
&gt;&gt; Sth -&gt; [{Key\\_for\\_return,Sth} | Acc]
&gt;&gt; end
&gt;&gt; end, [], Values\\_to\\_return),
&gt;&gt; {ok, Return};
&gt;&gt; {error, Msg} -&gt;
&gt;&gt; {error, Msg}
&gt;&gt; end,
&gt;&gt; Ret.
&gt;&gt;
&gt;&gt; And I do the following to get all the keys in the bucket and then find
&gt;&gt; some field from that key and return the value.
&gt;&gt; {ok, Key\\_list} = db\\_api:get\\_bucket\\_keys("Games"),
&gt;&gt; lists:foldl(
&gt;&gt; fun(Key, Acc) -&gt;
&gt;&gt; case db\\_api:select("Games", Key, ["game\\_name"]) of
&gt;&gt; {ok, []} -&gt;
&gt;&gt; Acc;
&gt;&gt; {ok, List} -&gt; [[{"game\\_id", Key} | List]|Acc]
&gt;&gt; end
&gt;&gt; end,[], Key\\_list).
&gt;&gt;
&gt;&gt;
&gt;&gt; It works for like around 2-3 seconds then it starts to timeout and
&gt;&gt; eventually crash..
&gt;&gt;
&gt;&gt; //Wilson
&gt;&gt;
&gt;&gt;
&gt;&gt; On Fri, Apr 29, 2011 at 2:01 PM, Rusty Klophaus  wrote:
&gt;&gt;
&gt;&gt;&gt; Hi Wilson,
&gt;&gt;&gt;
&gt;&gt;&gt; Do you see any errors or otherwise abnormal looking messages in the logs?
&gt;&gt;&gt; That will help diagnose the issue.
&gt;&gt;&gt;
&gt;&gt;&gt; The max requests per second depends very much on your hardware, size of
&gt;&gt;&gt; data, and read/write patterns.
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Rusty
&gt;&gt;&gt;
&gt;&gt;&gt; On Fri, Apr 29, 2011 at 6:44 AM, Wilson Tuladhar &lt;
&gt;&gt;&gt; mailwilson...@gmail.com&gt; wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; I am using riaksearch with erlang client and i have made an API that
&gt;&gt;&gt;&gt; does for the select, insert and other such stuffs. I have built an web
&gt;&gt;&gt;&gt; application on top of it and everything works fine when i do the manual
&gt;&gt;&gt;&gt; testing.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; But now when i am using the automated load testing through Tsung by
&gt;&gt;&gt;&gt; sending 100 req/sec, the riak shuts down after few seconds. Does anybody
&gt;&gt;&gt;&gt; know why this is happening or how much requests can riak handle in a 
&gt;&gt;&gt;&gt; second.
&gt;&gt;&gt;&gt; I am using only single node currently.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; //Wilson
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;
