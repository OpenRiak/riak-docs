---
title: "Re: slow mapred_search key lookups for single terms"
description: ""
project: community
lastmod: 2012-04-02T07:44:22-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07103"
mailinglist_parent_id: "msg07101"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2012-04-02T07:44:22-07:00
---


Hi Michael, you'll find my responses inline...

On Sat, Mar 31, 2012 at 5:04 PM, Michael Radford  wrote:

&gt; I'm seeing very slow performance from Riak search even when querying
&gt; single terms, and I'd appreciate any advice on how to get insight into
&gt; where the time is going.
&gt;
&gt; Right now, I'm using this function to time queries with the Erlang pb
&gt; client:
&gt;
&gt; TS =
&gt; fun (Pid, Bucket, Query) -&gt;
&gt; T0 = now(),
&gt; {ok, Results} = riakc\\_pb\\_socket:search(Pid, Bucket, Query),
&gt; MuSec = timer:now\\_diff(now(), T0),
&gt; io:format(user, "~b results, ~f sec~n", [length(Results),
&gt; MuSec/1000000])
&gt; end.
&gt;

Just an FYI, you should checkout `timer:tc`.

&gt;
&gt; The bucket I'm querying currently has ~300k keys total (each 16
&gt; bytes). (The whole cluster has maybe 1.5M entries in about a dozen
&gt; buckets. It's running 1.0.2, 4 nodes on 4 8-core c1.xlarge EC2
&gt; instances.)
&gt;
&gt; For single-term queries that return 10k+ keys, I'm routinely seeing
&gt; times above 6 seconds to run the above function. Intermittently,
&gt; however, I'll see the same queries take only 2 seconds:
&gt;
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt; 12574 results, 6.094149 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt; 12574 results, 1.938894 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt; 12574 results, 1.981492 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:flower"&gt;&gt;).
&gt; 12574 results, 6.120589 sec
&gt; ok
&gt;
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt; 13461 results, 6.572473 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt; 13461 results, 6.626049 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:red"&gt;&gt;).
&gt; 13461 results, 2.155847 sec
&gt; ok
&gt;
&gt; Queries with fewer results are still slow, but not quite as slow as 6
&gt; seconds:
&gt;
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt; 6446 results, 2.831806 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt; 6446 results, 3.037162 sec
&gt; ok
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:ring"&gt;&gt;).
&gt; 6447 results, 0.780944 sec
&gt; ok
&gt;
&gt; And queries with no matches only take a few milliseconds:
&gt;
&gt; &gt; TS(Pid,Bucket,&lt;&lt;"full\\_text:blorf"&gt;&gt;).
&gt; 0 results, 0.003269 sec
&gt; ok
&gt;
&gt; During the slow queries, none of the 4 machines seems to be fully
&gt; taxing even one cpu, or doing almost any disk i/o.
&gt;

What does intra/inter network look like?


&gt;
&gt; As far as I can tell from looking at the riak\\_kv/riak\\_search source,
&gt; my query should only be hitting the index and streaming back the keys,
&gt; not trying to read every document from disk or sort by score. Is that
&gt; correct?
&gt;

It will not read the documents at all but it will sort on score. Currently
there is no way to disable sorting.


&gt;
&gt; Assuming that's the case, I can't imagine why it takes so long to look
&gt; up 10k keys from the index for a single term, or why the times seem to
&gt; be bimodal (which seems like a big clue). Any pointers welcome!
&gt;

Where is your client sitting in regards to your cluster? Is it in the
local network? Could you try attaching to one of your riak nodes, running
the query there and compare results?

e.g.

riak attach

&gt; search:search(Bucket, Query).

-Ryan
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

