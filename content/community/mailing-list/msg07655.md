---
title: "Re: How to prevent Riak crashes when out of memory?"
description: ""
project: community
lastmod: 2012-06-10T14:25:41-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07655"
mailinglist_parent_id: "msg07609"
author_name: "Mark Phillips"
project_section: "mailinglistitem"
sent_date: 2012-06-10T14:25:41-07:00
---


Hi Steve,

There's a pull request open to fix this:

https://github.com/basho/erlang\\_js/pull/19

(h/t to Michael Santos for submitting the fix!)

We are in the process of reviewing the patch. The code for Riak 1.2 is
being finalized as we speak and I'm hopeful that it'll make it in.

Mark

On Mon, Jun 4, 2012 at 4:52 PM, Steve Edwards  wrote:

&gt; I have a cluster of riak nodes and one of them crashed because of a
&gt; failure to allocate memory.
&gt;
&gt; eheap\\_alloc: Cannot allocate 2850821240 bytes of memory
&gt;
&gt; I restarted the node and it came up gracefully but all my clients
&gt; reported that it was offline until I restarted every single node in
&gt; the cluster.
&gt; How can I tell what was trying to allocate that memory so that I can
&gt; give it more memory?
&gt; When the node is running, it looks like its only using 8 out of 16G of
&gt; memory.
&gt; Is there a configuration option somewhere that I can modify to
&gt; increase the amount of memory available to the node?
&gt; I've tweaked all the javascript vm settings but even when there are no
&gt; mapreduce calls, memory usage still tops out at 8G.
&gt; I should also mention that I am using riak\\_search
&gt;
&gt;
&gt; Here are some of the config settings:
&gt;
&gt; ERL\\_MAX\\_ETS\\_TABLES 4800
&gt; {map\\_js\\_vm\\_count, 16 },
&gt; {reduce\\_js\\_vm\\_count, 6 },
&gt; {hook\\_js\\_vm\\_count, 8 },
&gt;
&gt; {js\\_max\\_vm\\_mem, 16},
&gt; js\\_thread\\_stack, 16},
&gt; {segment\\_full\\_read\\_size,20},
&gt; {buffer\\_delayed\\_write\\_size,1024 },
&gt; {buffer\\_rollover\\_size, 4194304},
&gt; {max\\_compact\\_segments, 20}
&gt;
&gt;
&gt; Here is some more detail about the memory error from erl\\_crash.dump
&gt; =erl\\_crash\\_dump:0.1
&gt; Fri Jun 1 19:46:03 2012
&gt; Slogan: eheap\\_alloc: Cannot allocate 2850821240 bytes of memory (of
&gt; type "heap").
&gt; System version: Erlang R14B03 (erts-5.8.4) [source] [64-bit] [smp:4:4]
&gt; [rq:4] [async-threads:64] [kernel-poll:true]
&gt; Compiled: Tue Sep 6 10:22:01 2011
&gt; Taints: crypto,bitcask\\_nifs
&gt; Atoms: 15614
&gt; =memory
&gt; total: 12474692688
&gt; processes: 6076294256
&gt; processes\\_used: 6076132696
&gt; system: 6398398432
&gt; atom: 1068865
&gt; atom\\_used: 1048912
&gt; binary: 402089120
&gt; code: 9947817
&gt; ets: 89367152
&gt;

