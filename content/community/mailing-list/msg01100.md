---
title: "Re: reduce headaches"
description: ""
project: community
lastmod: 2010-09-19T14:15:27-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01100"
mailinglist_parent_id: "msg01099"
author_name: "Kevin Smith"
project_section: "mailinglistitem"
sent_date: 2010-09-19T14:15:27-07:00
---


Francisco --

0) I know the MapReduce machinery isn't as user-friendly as it could be. We are 
making plans now on ways to dramatically improve things on this front in the 
nearish future. I hope to have more details to share soon. We've committed 
improvements to the error reporting logic on tip so if you have the ability to 
upgrade to tip you should get improved error messages.

1) Reduce functions are currently called in two different ways. The first way 
is to invoke the reduce function with a list of items produced from the map 
phase. Internally the MapReduce machinery batches up data as it streams in from 
the map phase and sends the batches to the reduce phase.

The second way to invoke a reduce function at the end of the reduce with the 
list of data produced via earlier reduce invocations. This is also referred to 
as "re-reduce". Riak reduce functions always re-reduce. Re-reduction is a 
common source of problems as it tends to catch people off guard. However, your 
function looks like it should work. You could try wrapping the function body in 
a try/catch and using ejsLog to log the exception to a file. That should shed 
some light on what exactly if failing.

2) How are you reloading new Javascript functions? 'riak-admin js\\_reload' 
should cause all the Javascript VMs to restart and start from a clean slate. If 
that's not working correctly I'd be very interested in knowing that so I can 
fix it before our next release.

--Kevin

On Sep 19, 2010, at 1:09 PM, francisco treacy wrote:

&gt; So, I've had a weekend plagued of reduce function errors and general
&gt; weirdness, probably due to my ignorance on the subject.
&gt; 
&gt; Functions seem to be cached, which makes total sense. But it happened
&gt; to me several times sending a \\*different\\* function yet Riak would
&gt; completely ignore it and keep on running an older version (i started
&gt; noticing when using ejsLog). Is there a way of disabling caching? Hope
&gt; i'm missing something big here cause that's super annoying.
&gt; 
&gt; (I've also noticed strange behaviour when executing map/reduce jobs in
&gt; parallel and getting results mixed up... \\*sometimes\\* (possibly race
&gt; conditions) -- but first I want to make sure it's not the client. And
&gt; no, there's no global leakage.).
&gt; 
&gt; Then... what's wrong with this reduce function? It used to run fine,
&gt; but now it doesn't anymore. Oh, wait - yes it does again now that I
&gt; restarted Riak:
&gt; 
&gt; function(values) {
&gt; return [
&gt; values.reduce(function(acc, value) {
&gt; return acc + (value.fleet || value || 0);
&gt; }, 0)
&gt; ];
&gt; }
&gt; 
&gt; What can explain this behaviour? ( \\* error logs attached)
&gt; 
&gt; 
&gt; I'm well aware of
&gt; http://github.com/basho/riak\\_kv/blob/master/priv/mapred\\_builtins.js
&gt; and the few blog posts on the matter. Are there any docs in-between
&gt; the basic examples and the source code? (i will delve into it once I
&gt; get enough Erlang-fu, promise :)
&gt; 
&gt; I mean, when and how reduces (and re-reduces) are invoked and what you
&gt; should expect will be fed to your function, how are they cached and
&gt; what should programmers know about, what can/can't be done, more
&gt; advanced examples (how do "commutative, associative, and idempotent"
&gt; functions reflect in practical terms), etc.
&gt; 
&gt; I'd love to help with whatever I can (might be good material for a blog post).
&gt; 
&gt; Thanks,
&gt; Francisco
&gt; 
&gt; (\\*) These are the logs:
&gt; 
&gt; =SUPERVISOR REPORT==== 19-Sep-2010::18:10:32 ===
&gt; Supervisor: {local,luke\\_phase\\_sup}
&gt; Context: child\\_terminated
&gt; Reason: {error,failed\\_reduce}
&gt; Offender: [{pid,&lt;0.5424.22&gt;},
&gt; {name,undefined},
&gt; {mfa,
&gt; {luke\\_phase,start\\_link,
&gt; [riak\\_kv\\_reduce\\_phase,1,
&gt; [accumulate,converge],
&gt; undefined,&lt;0.5421.22&gt;,66000,
&gt; [{javascript,
&gt; {reduce,
&gt; {jsanon,
&gt; &lt;&lt;"function (values) {\\n return [\\n
&gt; values.reduce(function(acc, value) {\\n return
&gt; acc + (value.fleet || value || 0);\\n }, 0)\\n ];\\n
&gt; }"&gt;&gt;},
&gt; none,true}}]]}},
&gt; {restart\\_type,temporary},
&gt; {shutdown,brutal\\_kill},
&gt; {child\\_type,worker}]
&gt; 
&gt; 
&gt; =SUPERVISOR REPORT==== 19-Sep-2010::18:10:32 ===
&gt; Supervisor: {local,luke\\_phase\\_sup}
&gt; Context: child\\_terminated
&gt; Reason: {error,failed\\_reduce}
&gt; Offender: [{pid,&lt;0.5425.22&gt;},
&gt; {name,undefined},
&gt; {mfa,
&gt; {luke\\_phase,start\\_link,
&gt; [riak\\_kv\\_reduce\\_phase,1,
&gt; [accumulate,converge],
&gt; undefined,&lt;0.5421.22&gt;,66000,
&gt; [{javascript,
&gt; {reduce,
&gt; {jsanon,
&gt; &lt;&lt;"function (values) {\\n return [\\n
&gt; values.reduce(function(acc, value) {\\n return
&gt; acc + (value.fleet || value || 0);\\n }, 0)\\n ];\\n
&gt; }"&gt;&gt;},
&gt; none,true}}]]}},
&gt; {restart\\_type,temporary},
&gt; {shutdown,brutal\\_kill},
&gt; {child\\_type,worker}]
&gt; 
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

