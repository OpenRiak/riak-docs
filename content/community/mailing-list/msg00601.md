---
title: "Re: broken links"
description: ""
project: community
lastmod: 2010-06-15T06:14:14-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00601"
mailinglist_parent_id: "msg00599"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2010-06-15T06:14:14-07:00
---


Thanks Kevin. Makes sense.

For the record, this is how I have it now:

var reduce = function(v) {
 return v.filter(function(n) { return !n.not\\_found })
}

db.link({ bucket: "highlights", keep: false })
 .map({name: 'Riak.mapValuesJson'})
 .reduce({source: reduce})
 .run([["user\\_chapters", id]])()



2010/6/15 Kevin Smith :
&gt; Francisco -
&gt;
&gt; You have perfect timing. This same question came up yesterday in #riak.
&gt;
&gt; The core of the issue is Riak runs map functions on the node hosting the 
&gt; relevant data. In the case of a 'not found', there is no hosting node -- the 
&gt; data doesn't exist -- so the map function is never invoked for the missing 
&gt; entry. The 'not found' shows up in the reduce phase because reduce phases 
&gt; execute on the node coordinating the entire map/reduce job. Riak converts 
&gt; link walks into map phases which is why broken links also show up as 'not 
&gt; found' responses being passed to your reduce phase.
&gt;
&gt; Riak.mapValuesJson contains filtering logic since it could be used in either 
&gt; map OR reduce phases. I'd recommend performing 'not found' filtering in your 
&gt; reduce phases since that'll be the first opportunity you have to deal with 
&gt; the missing data.
&gt;
&gt; --Kevin
&gt; On Jun 15, 2010, at 4:30 AM, francisco treacy wrote:
&gt;
&gt;&gt; Hi all,
&gt;&gt;
&gt;&gt; I have a document with some broken links (i.e. that point to a
&gt;&gt; non-existent key), and want to apply a map/reduce there.
&gt;&gt;
&gt;&gt; var map = function(v, k, args) { ejsLog("/tmp/mr", "hello from map");
&gt;&gt; return [{from: "map"}] }
&gt;&gt;
&gt;&gt;  db.link({ bucket: "highlights", keep: false })
&gt;&gt;    .map({source: map})
&gt;&gt;    .run([["user\\_chapters", id]])()
&gt;&gt;
&gt;&gt; (That is, apply link+map to users\\_chapters/id)
&gt;&gt;
&gt;&gt; Result: 
&gt;&gt; [{"not\\_found":{"bucket":"highlights","key":"f542e13e0b5cece1f637be384e685667"}}]
&gt;&gt;
&gt;&gt; Makes sense because that is true. But why don't I get [{from: "map"}],
&gt;&gt; and why is nothing logged?
&gt;&gt;
&gt;&gt; I presume it is just failing at the link phase, which then outputs no
&gt;&gt; keys for the following phases. The "not found" objects should be get
&gt;&gt; rid of at a node level, so I don't think they belong to a reduce
&gt;&gt; phase. Or is that the case?
&gt;&gt;
&gt;&gt; (FWIW i got inspiration from Riak.mapValuesJson which seems to deal
&gt;&gt; with not\\_founds, but I never actually seem to reach the map phase).
&gt;&gt;
&gt;&gt; What is the recommended approach to gracefully handle broken links? It
&gt;&gt; should be fairly easy to exclude not found results from the resulting
&gt;&gt; map/reduce array.
&gt;&gt;
&gt;&gt; Francisco
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

