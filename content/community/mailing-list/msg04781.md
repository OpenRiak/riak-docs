---
title: "Re: Precommit Hook Difficulties"
description: ""
project: community
lastmod: 2011-09-19T12:44:35-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04781"
mailinglist_parent_id: "msg04780"
author_name: "Greg Pascale"
project_section: "mailinglistitem"
sent_date: 2011-09-19T12:44:35-07:00
---


Thanks,

I was able to work around the issue by using regexes to do string replacement, 
thereby avoiding decoding and encoding JSON, but it would be nice to know what 
was going wrong here.

-Greg
Clipboard

On Sep 19, 2011, at 11:44 AM, Sean Cribbs wrote:

&gt; Greg,
&gt; 
&gt; Your general approach looks good, and jives with my reading of the 
&gt; riak\\_object module. Let us know if you still have problems with mochijson2.
&gt; 
&gt; Sean
&gt; 
&gt; On Mon, Sep 19, 2011 at 1:42 PM, Greg Pascale  wrote:
&gt; Scratch that - the issue doesn't actually manifest without the decode/encode.
&gt; 
&gt; 
&gt; On Mon, Sep 19, 2011 at 10:47 AM, Greg Pascale  wrote:
&gt; Actually it looks like I can remove the JSON decode/encode and I still see 
&gt; the same issue. Just reading and writing the value is enough, so all I'm 
&gt; doing now is
&gt; 
&gt; precommit(RiakObject) -&gt;
&gt; Value = riak\\_object:get\\_value(RiakObject),
&gt; riak\\_object:apply\\_updates(
&gt; riak\\_object:update\\_value(RiakObject, Value)).
&gt; 
&gt; I'm really baffled here. The only documentation I know of for this code is at 
&gt; http://basho.github.com/riak-erlang-client/riak-erlang-client/riakc\\_obj.html 
&gt; and it really doesn't say much.
&gt; 
&gt; -Greg
&gt; Clipboard
&gt; 
&gt; On Sat, Sep 17, 2011 at 4:11 PM, Greg Pascale  wrote:
&gt; Hi,
&gt; 
&gt; I'm trying to write a simple precommit hook to modify a JSON object by 
&gt; removing certain fields. The simplest way to do this, I figure, is to decode 
&gt; the object's value with mochijson2, remove the fields I don't want, re-encode 
&gt; it, and update the value.
&gt; 
&gt; What happens, though, is my object ends up somehow mangled. When I inspect it 
&gt; via curl, it sort of looks like JSON, but characters like "{" and ":" seem to 
&gt; be replaced with garbage.
&gt; 
&gt; For example, what should read "hostname":"www.google.com" looks like 
&gt; hostnamea"ja:la"mwww.google.coma"j
&gt; 
&gt; To try to diagnose the issue, I reduced my hook to the simplest possible 
&gt; case. I don't even modify the JSON, I just decode the object and re-encode 
&gt; exactly the same value, but I still have the problem. The code is pasted below
&gt; 
&gt; precommit(RiakObject) -&gt;
&gt; Value = riak\\_object:get\\_value(RiakObject),
&gt; {struct, TermList} = mochijson2:decode(Value),
&gt; riak\\_object:apply\\_updates(
&gt; riak\\_object:update\\_value(RiakObject, 
&gt; mochijson2:encode({struct, TermList}))).
&gt; 
&gt; Can anybody point out what I'm doing wrong?
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Greg
&gt; Clipboard is hiring!
&gt; 
&gt; 
 
&gt; 

