---
title: "Re: Inconsistent data when a node goes down"
description: ""
project: community
lastmod: 2011-02-28T12:48:21-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02492"
mailinglist_parent_id: "msg02491"
author_name: "Alexander Sicular"
project_section: "mailinglistitem"
sent_date: 2011-02-28T12:48:21-08:00
---


I think it has to do with how the vnodes are partitioned against your
physical nodes. You really need a minimum of three physical nodes (or
virtual machines) to deploy and or do any failure testing.

-Alexander

On Mon, Feb 28, 2011 at 13:29, Luca Spiller  wrote:
&gt; Hi all,
&gt;
&gt; I've come across some issues while testing what happens when failures happen
&gt; on our system, for example a machine failing. One of the (slightly scary)
&gt; issues I have come across is for a short while when a Riak node goes down,
&gt; data that is read from another node isn't always consistent. I have written
&gt; a small test script to demonstrate this issue:
&gt;
&gt; https://gist.github.com/847749
&gt; Halfway through I switch off a node; here are the results:
&gt;
&gt; Deleted 0
&gt; Wrote 100 454551
&gt; 1298916758: 100 454551
&gt; 1298916759: 100 454551
&gt; 1298916760: 100 454551
&gt; 1298916761: 100 454551
&gt; 1298916762: 100 454551
&gt; 1298916762: 100 454551
&gt; 1298916763: 100 454551
&gt; 1298916764: 100 454551  (Shutdown around here)
&gt; 1298916765: 100 454551
&gt; 1298916766: 99 460532
&gt; 1298916767: 91 412241
&gt; 1298916768: 100 454551
&gt; 1298916769: 100 454551
&gt; 1298916770: 100 454551
&gt; 1298916771: 100 454551
&gt; 1298916772: 100 454551
&gt; 1298916773: 100 454551
&gt; 1298916774: 100 454551
&gt; 1298916775: 100 454551
&gt; 1298916776: 100 454551
&gt; 1298916777: 100 454551
&gt; ^C1298916777: 100 454551
&gt; Deleted 100
&gt;
&gt; Slightly more scary is that it appears to sometimes read old (deleted) data:
&gt;
&gt; Deleted 0
&gt; Wrote 100 495792
&gt; 1298916784: 100 495792
&gt; 1298916785: 100 495792
&gt; 1298916786: 100 495792
&gt; 1298916786: 100 495792  (Shutdown around here)
&gt; 1298916787: 100 495792
&gt; 1298916788: 100 487322
&gt; 1298916789: 100 495792
&gt; 1298916790: 100 495792
&gt; 1298916791: 100 495792
&gt; 1298916792: 100 495792
&gt; 1298916793: 100 495792
&gt; 1298916794: 100 495792
&gt; 1298916795: 100 495792
&gt; ^C1298916796: 100 495792
&gt; 1298916797: 100 495792
&gt; Deleted 100
&gt;
&gt; This is using the Ripple library (0.8.3) talking directly to the local node,
&gt; however I believe the same problem is happening when using the Erlang PBC
&gt; library. This problem seems to be exacerbated when there are larger amounts
&gt; of data being stored in Riak, and the eventual consistency takes longer to
&gt; occur.
&gt; I am quite puzzled as to why this is happening, I could kind of understand
&gt; if data went missing, but the eventual consistency is what puzzles me, I
&gt; only have two nodes, so why does the data eventually sort itself out?
&gt; Secondly why does this still happen even with W and DW set to 3
&gt; (I originally had the script using the default values, but thought I would
&gt; try this)?
&gt; Both of the nodes are running Riak 0.14.0, here are the relavent configs:
&gt; https://gist.github.com/847756
&gt; Apologies if I am just doing something stupid, it has been a rather long day
&gt; :)
&gt; Regards,
&gt; Luca Spiller
