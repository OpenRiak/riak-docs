---
title: "Re: \"exception exit: disconnected\" when reading old 0.13.0 riak data	with protobuf client"
description: ""
project: community
lastmod: 2012-09-24T11:43:34-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08674"
mailinglist_parent_id: "msg08673"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2012-09-24T11:43:34-07:00
---


Yeah, it's a known issue for old Riak versions. We've been using this patch
until the upgrade: https://gist.github.com/3777546 Note that you should
patch both Riak and client modules.

Speaking of riakclient\\_pb.erl, I'm not completely sure, but guess it's
generated by protobuffs from a PB spec.

On Mon, Sep 24, 2012 at 10:37 PM, Yuri Lukyanov  wrote:

&gt; Hi,
&gt;
&gt; I have a cluster with old 0.13.0 riak nodes installed. Erlang native API
&gt; client is used to get/put data to/from the cluster.
&gt; Now I'm trying to start using protobuf client (riakc\\_pb\\_socket). The
&gt; problem is that the pb client can't read data saved with old native
&gt; riak\\_client.
&gt; Steps to reproduce:
&gt;
&gt; 1&gt; {ok, C} = riak:client\\_connect('riak@localhost').
&gt; {ok,{riak\\_client,riak@localhost,&lt;&lt;4,81,114,138&gt;&gt;}}
&gt; 2&gt; C:put(riak\\_object:new(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"key"&gt;&gt;, {1, 2})).
&gt; ok
&gt; 3&gt; C:get(&lt;&lt;"test"&gt;&gt;, &lt;&lt;"key"&gt;&gt;).
&gt; {ok,{r\\_object,&lt;&lt;"test"&gt;&gt;,&lt;&lt;"key"&gt;&gt;,
&gt; [{r\\_content,{dict,2,16,16,8,80,48,
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt; {{[],[],[],[],[],[],[],[],[],[],...}}},
&gt; {1,2}}],
&gt; [{&lt;&lt;106,124,17,114,80,92,14,183&gt;&gt;,{1,63515448872}},
&gt; {&lt;&lt;7,141,174,80&gt;&gt;,{1,63515448872}},
&gt; {&lt;&lt;131,98,4,179,111,197&gt;&gt;,{1,63515729078}},
&gt; {&lt;&lt;5,81,122,124&gt;&gt;,{1,63515729078}},
&gt; {&lt;&lt;4,81,114,138&gt;&gt;,{1,63515729568}},
&gt; {&lt;&lt;131,98,3,57,103,94&gt;&gt;,{1,63515729568}}],
&gt; {dict,1,16,16,8,80,48,
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt; {{[],[],[],[],[],[],[],[],[],[],[],...}}},
&gt; undefined}}
&gt; 4&gt; {ok, Pid} = riakc\\_pb\\_socket:start\\_link("localhost", 8087).
&gt; {ok,&lt;0.13770.0&gt;}
&gt; 5&gt; riakc\\_pb\\_socket:get(Pid, &lt;&lt;"test"&gt;&gt;, &lt;&lt;"key"&gt;&gt;).
&gt; \\*\\* exception exit: disconnected
&gt;
&gt; On erlang node, the following error occurs:
&gt;
&gt; =ERROR REPORT==== 24-Sep-2012::22:12:48 ===
&gt; \\*\\* Generic server &lt;0.4086.41&gt; terminating
&gt; \\*\\* Last message in was {tcp,#Port&lt;0.96519&gt;,
&gt; [9|&lt;&lt;10,4,116,101,115,116,18,3,107,101,121&gt;&gt;]}
&gt; \\*\\* When Server state == {state,#Port&lt;0.96519&gt;,
&gt; {riak\\_client,riak@localhost
&gt; ,&lt;&lt;3,139,240,244&gt;&gt;},
&gt; undefined,undefined}
&gt; \\*\\* Reason for termination ==
&gt; \\*\\* {function\\_clause,[{riakclient\\_pb,encode,[1,{1,2}]},
&gt; {riakclient\\_pb,pack,5},
&gt; {riakclient\\_pb,iolist,2},
&gt; {riakclient\\_pb,encode,2},
&gt; {riakclient\\_pb,pack,5},
&gt; {riakclient\\_pb,pack,5},
&gt; {riakclient\\_pb,iolist,2},
&gt; {riakc\\_pb,encode,1}]}
&gt;
&gt;
&gt; I suppose that it is somehow connected with the fact that the value is
&gt; passed as an erlang term, not as clear binary data ({1, 2} vs
&gt; term\\_to\\_binary({1, 2})).
&gt;
&gt; Is there something I can do about that? Btw, where can I
&gt; find riakclient\\_pb.erl source code?
&gt;

-- 
Best regards,
Dmitry Demeshchuk
