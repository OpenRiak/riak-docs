---
title: "Re: Delta updates using pre-commit hooks"
description: ""
project: community
lastmod: 2012-01-16T06:31:10-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06288"
mailinglist_parent_id: "msg06285"
author_name: "Mark Steele"
project_section: "mailinglistitem"
sent_date: 2012-01-16T06:31:10-08:00
---


I for one would love to see a CRDT-like interface in Riak...

Cheers,

Mark Steele, CISSP, CSM
Bering Media Inc.


On Sat, Jan 14, 2012 at 1:03 PM, Ryan Zezeski  wrote:

&gt; Marek,
&gt;
&gt; You're definitely butting up against the limits of Riak's data model here.
&gt; It sounds like you are looking for something like Redis? E.g. add element
&gt; E to set S. You could probably use statebox [1] and pull some tricks in
&gt; the precommit hook to determine if the incoming client object is the
&gt; initial object or a delta but you would still need to perform a read in the
&gt; hook to get the box, apply the delta, and then return that object from the
&gt; hook. As you said this happens on the coordinator and there is no easy way
&gt; to guarantee this op applies local to the data off the top of my head. At
&gt; least a precommit hook would prevent streaming the object to/from the
&gt; client.
&gt;
&gt; I think what you really want is native support for different data models
&gt; on top of Riak. Internally, we've played around with a CRDT [2] interface
&gt; on top of Riak where instead of sending objects you send operations. This
&gt; is analogous to how Redis works (although the underlying implementation is
&gt; very different given Riak's distributed nature). The trick with a new data
&gt; model is making sure it scales and making sure we understand its
&gt; consistency model.
&gt;
&gt; Riak's pedigree is the key-value model. I'm sure you could hack something
&gt; together on top of Riak's KV model with precommit hooks but you will be
&gt; swimming upstream. That said, we're always looking at new models that
&gt; would compliment our existing key-value model.
&gt;
&gt; -Ryan
&gt;
&gt; [1]: https://github.com/mochi/statebox
&gt;
&gt; [2]: http://hal.archives-ouvertes.fr/inria-00555588/
&gt;
&gt; On Wed, Jan 4, 2012 at 10:11 AM, Marek Zawirski wrote:
&gt;
&gt;&gt; Hi,
&gt;&gt;
&gt;&gt; we are trying use Riak as a storage layer for experimental
&gt;&gt; higher-level data types updated by clients, using a set of
&gt;&gt; well-defined operations. To this end, each data type instance is
&gt;&gt; stored under a single key. One problem with this approach is that
&gt;&gt; after client modifies even a small piece of the data structure, it
&gt;&gt; needs to write (and transfer) the whole data structure back to Riak.
&gt;&gt; We are looking for a way to reduce this overhead by sending just a
&gt;&gt; delta operation, preferably without partitioning the data structure to
&gt;&gt; several keys.
&gt;&gt;
&gt;&gt; One approach we thought about is to perform operations on Riak-side
&gt;&gt; using pre-commit hooks or similar technique. I.e. reconstruct the new
&gt;&gt; value on Riak using original old value + delta send by client. The
&gt;&gt; operations (deltas) we are talking about have necessary properties to
&gt;&gt; ensure convergence. Still, it seems there a couple technical issues
&gt;&gt; involved, we are looking how to solve them:
&gt;&gt; 1) pre-commit API seems to only offer access to the object value
&gt;&gt; passed by client during write and not the old value; I wonder - am I
&gt;&gt; able to read the value from the store in pre-commit hook? In
&gt;&gt; particular, the value previously read by the client writing,
&gt;&gt; identified by version vector?
&gt;&gt; 2) pre-commit hooks are executed on the coordinator node; is there an
&gt;&gt; easy way in Riak to apply operations at data nodes instead?
&gt;&gt;
&gt;&gt; Thanks for any info that can help addressing these issues.
&gt;&gt;
&gt;&gt; Regards,
&gt;&gt; Marek Zawirski
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

