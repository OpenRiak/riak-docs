---
title: "Re: Keys aren't deleted"
description: ""
project: community
lastmod: 2011-09-01T06:59:51-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04557"
mailinglist_parent_id: "msg04553"
author_name: "Tony Bussieres"
project_section: "mailinglistitem"
sent_date: 2011-09-01T06:59:51-07:00
---


Hi,

I hope this script will help someone. (attached)

It reads all buckets and for each bucket it gets the keys and read all the
entries.
Could be potentially useful after the restart of a node.

-tony



On Thu, Sep 1, 2011 at 9:22 AM, Sean Cribbs  wrote:

&gt; You will need to do so manually. Riak currently has no active anti-entropy
&gt; (expect the EDS product which has a kind of it in the long-haul
&gt; replication).
&gt;
&gt;
&gt; On Thu, Sep 1, 2011 at 9:20 AM, Tony Bussieres wrote:
&gt;
&gt;&gt; Hi Andrew,
&gt;&gt;
&gt;&gt; Can we automatically, after restarting a node, read-repair all entries
&gt;&gt; using the command line?
&gt;&gt; Or we have to read all keys individually so they become consistent?
&gt;&gt;
&gt;&gt; -tony
&gt;&gt;
&gt;&gt;
&gt;&gt; On Wed, Aug 31, 2011 at 5:27 PM, Andrew Thompson wrote:
&gt;&gt;
&gt;&gt;&gt; On Wed, Aug 31, 2011 at 05:11:16PM -0400, Tony Bussieres wrote:
&gt;&gt;&gt; &gt; Hi,
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; We have a cluster of two nodes.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; We add keys to a bucket :
&gt;&gt;&gt; &gt; curl -v -X PUT -d '{"prop":"val"}' -H "Content-Type: application/json"
&gt;&gt;&gt; &gt; http://riak/store/jdTestBucket/key1?w=1
&gt;&gt;&gt; &gt; curl -v -X PUT -d '{"prop":"val"}' -H "Content-Type: application/json"
&gt;&gt;&gt; &gt; http://riak/store/jdTestBucket/key2?w=1
&gt;&gt;&gt; &gt; curl -v -X PUT -d '{"prop":"val"}' -H "Content-Type: application/json"
&gt;&gt;&gt; &gt; http://riak/store/jdTestBucket/key3?w=1
&gt;&gt;&gt; &gt; curl -v -X PUT -d '{"prop":"val"}' -H "Content-Type: application/json"
&gt;&gt;&gt; &gt; http://riak/store/jdTestBucket/key4?w=1
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; We shut down one node.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; We delete the keys:
&gt;&gt;&gt; &gt; curl -v -X DELETE http://riak/store/jdTestBucket/key1?w=1
&gt;&gt;&gt; &gt; curl -v -X DELETE http://riak/store/jdTestBucket/key2?w=1
&gt;&gt;&gt; &gt; curl -v -X DELETE http://riak/store/jdTestBucket/key3?w=1
&gt;&gt;&gt; &gt; curl -v -X DELETE http://riak/store/jdTestBucket/key4?w=1
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; We list the keys :
&gt;&gt;&gt; &gt; curl -i http://riak/store/jdTestBucket?keys=true\\&props=false
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; All keys are listed.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; Is it normal?
&gt;&gt;&gt; &gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Yes, keys are only deleted when all the values are tombstones and all
&gt;&gt;&gt; the nodes are up. In theory bringing the other node back up and
&gt;&gt;&gt; re-reading the keys will read-repair the keys on the node that was down
&gt;&gt;&gt; to be tombstones and then hopefully they'll be removed.
&gt;&gt;&gt;
&gt;&gt;&gt; However, deletes are flaky on 0.14. Things should be a little better in
&gt;&gt;&gt; 1.0.
&gt;&gt;&gt;
&gt;&gt;&gt; Andrew
&gt;&gt;&gt;
&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt;


read\\_repair.sh
Description: Bourne shell script
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

