---
title: "Re: \"Failed to compact\" in RiakSearch"
description: ""
project: community
lastmod: 2011-04-15T07:40:39-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03057"
mailinglist_parent_id: "msg03056"
author_name: "Rusty Klophaus"
project_section: "mailinglistitem"
sent_date: 2011-04-15T07:40:39-07:00
---


Hi Morten,

It looks like at least one of the offending fields is "photos\\_value", which,
as you said, should be skipped according to your schema. This makes me think
that either the schema isn't set correctly, or that one or more nodes is
caching an old value of the schema.

Can you try running "search-cmd show-schema INDEXNAME" on each node to
verify that the schema is set correctly? Also, you can run "search-cmd
clear-schema-cache" to clear the schema cache across all nodes.

Also, the number of segments is \\*way\\* higher than it should be, and this is
the reason for the "too many DB tables" error. It appears that these
problems are linked, the compaction errors are preventing the system from
combining segments, leading to a large number of segments, so solving one
problem should solve the other.

Best,
Rusty

On Fri, Apr 15, 2011 at 4:27 AM, Morten Siebuhr  wrote:

&gt; Hi Rusty,
&gt;
&gt; On Thu, Apr 14, 2011 at 8:00 PM, Rusty Klophaus  wrote:
&gt; &gt; Hi Morten,
&gt; &gt; Thanks for sending the log files. I was able to figure out, at least
&gt; &gt; partially, what's going on here.
&gt;
&gt; Fantastic - thanks!
&gt;
&gt; &gt; The "Failed to compact" message is a result of trying to index a token
&gt; &gt; that's greater than 32kb in size. (The index storage engine, called
&gt; &gt; merge\\_index, assumes tokens sizes smaller than 32kb.) I was able to
&gt; decode
&gt; &gt; part of the term in question by pulling data from the log file, and it
&gt; looks
&gt; &gt; like you may be indexing HTML with base64 encoded inline images, ie: ![]() &gt; src="data:image/jpeg;base64,iVBORw0KG..."&gt; The inline image is being
&gt; treated
&gt; &gt; as a single token, and it's greater than 32kb.
&gt;
&gt; That's odd - in the search schema, I asked it to ignore everything
&gt; besides a few specific fields:
&gt;
&gt; {
&gt; schema,
&gt; [
&gt; {version, "0.1"},
&gt; {default\\_field, "\\_owner"},
&gt; {n\\_val, 1}
&gt; ],
&gt; [
&gt; %% Don't parse \\_id and \\_owner, just treat it as single token
&gt; {field, [
&gt; {name, "id"},
&gt; {required, true},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; noop\\_analyzer\\_factory}}
&gt; ]},
&gt; {field, [
&gt; {name, "\\_owner"},
&gt; {required, true},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; noop\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Parse Name fields for full-text indexing
&gt; {field, [
&gt; {name, "displayName"},
&gt; {aliases, ["nickname", "preferredUsername",
&gt; "name\\_formatted",
&gt; "name\\_displayName"]},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; standard\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; {field, [
&gt; {name, "emails\\_value"},
&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt; standard\\_analyzer\\_factory}}
&gt; ]},
&gt;
&gt; %% Add modification dates
&gt; {field, [
&gt; {name, "published"},
&gt; {aliases, ["updated"]},
&gt; {type, date}
&gt; ]},
&gt;
&gt; %% Skip all else...
&gt; {dynamic\\_field, [
&gt; {name, "\\*"},
&gt; {skip, true}
&gt; ]}
&gt; ]
&gt; }.
&gt;
&gt; (We're indexing Portable Contacts, where the user images reside in a
&gt; 'image'-field.)
&gt;
&gt; &gt; The short term workaround is to either:
&gt; &gt; 1) Preprocess your data to avoid this situation.
&gt; &gt; 2) Or, create a custom analyzer that limits the size of terms
&gt; &gt; (See http://wiki.basho.com/Riak-Search---Schema.html for more
&gt; information
&gt; &gt; about analyzers and custom analyzers.)
&gt; &gt; The long term solution is for us to increase the maximum token size in
&gt; &gt; merge\\_index. I've filed a bugzilla issue for this, trackable
&gt; &gt; here: https://issues.basho.com/show\\_bug.cgi?id=1069
&gt; &gt; Still investigating the "Too many db tables" error. This is being caused
&gt; by
&gt; &gt; the system opening too many ETS tables. It \\*may\\* be related to the
&gt; &gt; compaction error described above, but I'm not sure.
&gt; &gt; Search (specifically merge\\_index) uses ETS tables heavily, and the number
&gt; of
&gt; &gt; tables is affected by a few different factors. Can you send me some more
&gt; &gt; information to help debug, specifically:
&gt; &gt;
&gt; &gt; How many partitions (vnodes) are in your cluster? (If you haven't changed
&gt; &gt; any settings, then the default is 64.)
&gt;
&gt; It's 64 (no defaults changed at all).
&gt;
&gt; &gt; How many machines are in your cluster?
&gt;
&gt; Four.
&gt;
&gt; &gt; How many segments are on the node where you are seeing these errors?
&gt; &gt; (Run: "find DATAPATH/merge\\_index/\\*/\\*.data | wc -l", replacing DATAPATH
&gt; with
&gt; &gt; the path to your Riak data directory for that node.)
&gt;
&gt; foreach srv ( nosql1 nosql2 nosql4 nosql5 )
&gt; echo -n "$srv "; ssh $srv sh -c 'find
&gt; /var/lib/riaksearch/merge\\_index/\\*/\\*.data | wc -l'
&gt; end
&gt; nosql1 32434
&gt; nosql2 14170
&gt; nosql4 15480
&gt; nosql5 13501
&gt;
&gt; (nosql1 is the one the error log is lifted from - but the errors
&gt; seemed to come of all of the servers.)
&gt;
&gt; &gt; Approximately how much data are you loading (# Docs and # MB), and how
&gt; &gt; quickly are you trying to load it?
&gt;
&gt; ~17m records, weighing in just shy of four GB.
&gt;
&gt; While I didn't do the loading, I believe we did it with 25 concurrent
&gt; threads, using the four machines in round-robin fashion.
&gt;
&gt; /Siebuhr
&gt;
