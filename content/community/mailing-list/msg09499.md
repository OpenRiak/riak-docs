---
title: "Re: problem counting items with MapReduce"
description: ""
project: community
lastmod: 2012-12-10T08:16:45-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09499"
author_name: "Bryan Fink"
project_section: "mailinglistitem"
sent_date: 2012-12-10T08:16:45-08:00
---


On Sat, Dec 8, 2012 at 6:11 AM, Antonio Rohman Fernandez &lt;
roh...@mahalostudio.com&gt; wrote:

&gt; \\*\\*
&gt;
&gt; QUERY:
&gt;
&gt; {
&gt; "inputs":{"bucket":"sales","index":"sex\\_bin","key":"male"},
&gt; "query":[
&gt; {"map": {"language":"javascript","source":"function(v,k,a) { var m =
&gt; v.values[0].data.match(\\"1981\\"); if (m != null) { return [v.key]; } else {
&gt; return []; }}"}},
&gt; {"reduce":{"language":"javascript","source":"function(v,a) { return v;
&gt; }"}},
&gt; {"reduce":{"language":"javascript","source":"function(v,a) { return
&gt; [v.length]; }"}}
&gt; ]
&gt; }
&gt;
&gt; RESPONSE: ( wrong... counting the length of the array gives [2] instead of
&gt; [101]
&gt; [2]
&gt;

Hi, Rohman. This is working as expected. If it returned a different result
on Riak 0.14, it was only by accident. The outputs from the first reduce
phase do not arrive at the second reduce phase as one unit, but instead
arrive a few at a time.

You can force that second reduce phase to wait for all inputs before
processing by adding '"arg":{"reduce\\_phase\\_only\\_1":true}' to the phase's
definition[1], like so:

 {"reduce":{"language":"javascript","source":"function(v,a) { return
[v.length]; }","arg":{"reduce\\_phase\\_only\\_1":true}}}

Alternatively, you could replace both of those reduce phases with a single
phase calling the built in riak\\_kv\\_mapreduce:reduce\\_count\\_inputs/2, like so:


{"reduce":{"language":"erlang","module":"riak\\_kv\\_mapreduce","function":"reduce\\_count\\_inputs"}}

This builtin is able to handle reduce work as it becomes available, instead
of waiting for the whole batch.

Hope that helps,
Bryan

[1] "Batch Size"
http://docs.basho.com/riak/latest/references/appendices/MapReduce-Implementation/
