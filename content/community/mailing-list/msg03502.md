---
title: "Re: haproxy and protobuffers working example?"
description: ""
project: community
lastmod: 2011-05-31T09:13:44-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03502"
mailinglist_parent_id: "msg03501"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-05-31T09:13:44-07:00
---


Actually, I think it should be part of the wiki, and have opened an issue to 
that effect. https://github.com/basho/riak\\_wiki/issues/106

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On May 31, 2011, at 12:05 PM, Mark Phillips wrote:

&gt; Hey Bob,
&gt; 
&gt; Any objections if I clean this up and add it to the "Other" section of
&gt; Riak Function Contrib? It's clearly not a function, but I think others
&gt; would find this useful (as Scott did) as a point of reference.
&gt; 
&gt; http://contrib.basho.com/other-functions.html
&gt; 
&gt; Let me know and I'll throw together a pull request for your review.
&gt; 
&gt; Mark
&gt; 
&gt; On Mon, May 30, 2011 at 4:55 PM, Bob Feldbauer  
&gt; wrote:
&gt;&gt; Your haproxy.cfg looks fine, but since you asked, here's the my haproxy.cfg
&gt;&gt; for Riak use:
&gt;&gt; 
&gt;&gt; global
&gt;&gt; user haproxy
&gt;&gt; group haproxy
&gt;&gt; daemon
&gt;&gt; maxconn 100000
&gt;&gt; 
&gt;&gt; defaults
&gt;&gt; log global
&gt;&gt; mode tcp
&gt;&gt; option tcplog
&gt;&gt; option dontlognull
&gt;&gt; balance leastconn
&gt;&gt; clitimeout 60000
&gt;&gt; srvtimeout 60000
&gt;&gt; contimeout 5000
&gt;&gt; retries 3
&gt;&gt; option redispatch
&gt;&gt; option contstats
&gt;&gt; stats enable
&gt;&gt; 
&gt;&gt; listen riak 192.168.1.1:8087
&gt;&gt; server riak1 riak1:8087 weight 1 maxconn 1000
&gt;&gt; server riak2 riak2:8087 weight 1 maxconn 1000
&gt;&gt; server riak3 riak3:8087 weight 1 maxconn 1000
&gt;&gt; 
&gt;&gt; 
&gt;&gt; Good luck!
&gt;&gt; 
&gt;&gt; - Bob Feldbauer
&gt;&gt; 
&gt;&gt; On 5/30/2011 7:11 PM, Scott M. Likens wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt; Hey,
&gt;&gt;&gt; 
&gt;&gt;&gt; So I thought I had a working haproxy configuration with protobuffers (It
&gt;&gt;&gt; worked once upon a time, but no longer) so I was wondering if anyone had any
&gt;&gt;&gt; working examples?
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; irb(main):001:0&gt; client = Riak::Client.new(:protocol =&gt; "pbc")
&gt;&gt;&gt; =&gt; #
&gt;&gt;&gt; irb(main):002:0&gt; client.ping
&gt;&gt;&gt; Riak::ProtobuffsFailedRequest: Expected success from Riak but received
&gt;&gt;&gt; server\\_error. Unexpected EOF on PBC socket
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; irb(main):008:0&gt; client2=Riak::Client.new(:protocol =&gt; "pbc", :host =&gt;
&gt;&gt;&gt; "10.170.121.116")
&gt;&gt;&gt; =&gt; #
&gt;&gt;&gt; irb(main):009:0&gt; client2.ping
&gt;&gt;&gt; =&gt; true
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; If I remove all the servers except for 1 connects but still doesn't really
&gt;&gt;&gt; work, below is my haproxy configuration I hope it helps.
&gt;&gt;&gt; 
&gt;&gt;&gt; listen riak\\_pbc :8087
&gt;&gt;&gt; mode tcp
&gt;&gt;&gt; server app-0 ip-10-170-121-116.us-west-1.compute.internal:8087 check
&gt;&gt;&gt; inter 5000 fastinter 1000 fall 1 weight 50
&gt;&gt;&gt; server app-1 ip-10-171-43-226.us-west-1.compute.internal:8087 check
&gt;&gt;&gt; inter 5000 fastinter 1000 fall 1 weight 50
&gt;&gt;&gt; server app-2 ip-10-170-142-202.us-west-1.compute.internal:8087 check
&gt;&gt;&gt; inter 5000 fastinter 1000 fall 1 weight 50
&gt;&gt;&gt; 
&gt;&gt;&gt; Actual full haproxy erb chef template can be found here
&gt;&gt;&gt; https://github.com/damm/ey-riak/blob/master/templates/default/haproxy.cfg.erb
&gt;&gt;&gt; (if you see anything I should turn off for http please let me know and be
&gt;&gt;&gt; gentle)
&gt;&gt; 
&gt;&gt; 
&gt; 
