---
title: "Re: 2i performance questions"
description: ""
project: community
lastmod: 2012-06-18T07:27:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07702"
mailinglist_parent_id: "msg07693"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2012-06-18T07:27:04-07:00
---


Hi Tom, response inline.

On Thu, Jun 14, 2012 at 3:29 PM, Tom Burdick  wrote:

&gt;
&gt; retrieve\\_by\\_client(Db, Key) when is\\_binary(Key) -&gt;
&gt;    {ok, BKeys} = riakc\\_pb\\_socket:get\\_index(Db, ?bucket,
&gt; &lt;&lt;"client\\_id\\_bin"&gt;&gt;, Key),
&gt;    lists:map(fun([\\_Bucket, Key0]) -&gt;
&gt;        Key0
&gt;    end, BKeys).
&gt;
&gt; What I've noticed while benchmarking the put is that that is actually
&gt; quite fast and I can do that
&gt; at a pretty high rate even on my devrel setup, like 1000 puts/sec.
&gt;
&gt; However when doing retrieve\\_by\\_client at most I've seen 20
&gt; get\\_indexes/sec with latencies all over the place from a few
&gt; milliseconds up to a few seconds.

I notice you're using the Erlang PB client. This is the client we
recommend but a current shortfall of it re 2i is that it unnecessarily
uses map/reduce to collate the results.

Bryan Find recently made some changes to Pipe, the system behind
map/reduce, that should improve latencies for queries that match
"larger" result sets. How large I'm not sure, but the larger the
result set the more of an improvement you'll see is what I'm told.

Sean Cribbs recently made some change to our protobuffs server that
will allow direct querying of 2i without the use of map/reduce. IMO
this should greatly reduce your latencies. However, the various
clients still need to be modified to take advantage of this. I defer
to Sean on when that might be done.

In the meantime you could try changing your query code to use the HTTP
interface and see if that brings you better latency.

Oh, I just remember, Matthew Von-Maszewski has made some amazing
strides in our branch of leveldb in terms of
latency/throughput/robustness and that should result in trickle-down
improvements as well.

All these changes, with the exception of the client modifications,
should be coming with our next release, 1.2.

&gt;
&gt; I'm tempted to fire up fprof on Client:get\\_index just to see whats up
&gt; but I'm a bit scared at what I might see there :-)

Feel free to fprof, my guess is most of the time will be spent in
map/reduce related code. The other place 2i spends a majority of it's
time is sext decoding.

-Z

