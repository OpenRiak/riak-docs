---
title: "Re: 'not found' after join"
description: ""
project: community
lastmod: 2011-05-05T07:40:52-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03231"
mailinglist_parent_id: "msg03228"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2011-05-05T07:40:52-07:00
---


Hi Greg,

You're right, the current situation for handoff is not optimal. We are
aware of these shortcomings and are working on solutions. That said, there
may be some knobs you can turn to minimize the amount of time you spend in
handoff.

Since you are using a ring size of 2048 you are possibly testing the limits
of certain subsystems inside Riak. I'm not saying it shouldn't work, just
that many things in Riak were probably coded with an expectation of a
smaller ring size.

1. For example, riak\\_core has a `handoff\\_concurrency` setting that
determines how many vnodes can concurrently handoff on a given node. By
default this is set to 4. That's going to take a while with your 2048
vnodes and all :)

2. Also, by default, riak\\_core sets the `vnode\\_inactivity\\_timeout` to 60s.
 That means that the vnode must be inactive for 60s before it will begin
handoff. You could try lowering this to expedite handoff.

3. \\_Do not\\_ make constant calls to `riak-admin transfers`. Every time you
call this you are resetting the vnode activity and stalling handoff. I
know, I know, how could anyone possibly be expected to know that? Along
with everything else, it's something we plan to address.

In summary, you could try adding the following to your app.config and adjust
accordingly. And keep in mind not to hit `riak-admin transfers` too often
to give the vnodes a chance to handoff.

[
%% Riak Core Config
 {riak\\_core, [
 ...
 %% settings to adjust handoff latency/throughput
 {handoff\\_concurrency, N},
 {vnode\\_inactivity\\_timeout, M},
 ....
 ]},
 ...
].

HTH,
-Ryan

On Thu, May 5, 2011 at 2:18 AM, Greg Nelson  wrote:

&gt; I just added node #5 to our cluster, and once again the experience during
&gt; the subsequent 60-minute handoff period was pretty awful! I just don't
&gt; understand why this would be expected behavior while adding a node. There
&gt; doesn't seem to be any realistic way to join a node to an online cluster.
&gt; As far as I'm concerned this is a \\*huge\\* defect in Riak.
&gt;
&gt; Read-repair didn't seem to kick in immediately for data. My application
&gt; was configured to retry GETs (with a few seconds of backoff), and still got
&gt; 404s. I manually requested an object repeatedly for over 20 minutes until
&gt; finally getting a result.
&gt;
&gt; I think bug #992 (https://issues.basho.com/show\\_bug.cgi?id=992) describes
&gt; the defect, but I'm wondering if there is more to it than this? Especially
&gt; since read-repair didn't quite seem to work.
&gt;
&gt; Could what Daniel describes on that bug ("Only return not found when all
&gt; vnodes have reported not found (or error)") be implemented as a configurable
&gt; option? Maybe something one could kick in when a node joins until all
&gt; handoffs are complete?
&gt;
&gt; What we can do to remedy this before I add node #6, #7, etc. We're storing
&gt; huge amounts of data, which means that a) we'll be adding nodes often, and
&gt; b) the amount of data handoff will be large, which means long periods of
&gt; handoff where we don't want to have downtime.
&gt;
&gt; Greg
&gt;
&gt; On Tuesday, May 3, 2011 at 2:30 AM, Nico Meyer wrote:
&gt;
&gt; Hi everyone,
&gt;
&gt; I just want to note that I observed similar behaviour with a somewhat
&gt; larger clusters of 10 or so nodes. I first noticed that handoff activity
&gt; after node join (or leave for that matter) involved a lot more
&gt; partitions than I would have expected. By comparing the old and the new
&gt; ring file, I found out that more than 80 percent of partitions had to be
&gt; moved to another node.
&gt; My naive expectation was that joining a node to a cluster of size X
&gt; would result in roughly ring\\_creation\\_size/(X+1) partitions to be handed
&gt; off, which would also be the minimum if one expects a balanced cluster
&gt; afterwards.
&gt; Furthermore it would in theory be possible to move partitions in such a
&gt; way that at least one partition from each preflist stays on the same
&gt; node. Maybe for X&gt;N it should even be possible to guarantee this for a
&gt; basic quorum of each preflist, eliminating the notfound problem
&gt; completely, but I am not sure about that.
&gt;
&gt; I may be able to provide some ring files to analyze this behaviour if
&gt; someone from basho is interested.
&gt;
&gt; Cheer Nico
&gt;
&gt; Am Montag, den 02.05.2011, 23:14 -0400 schrieb Ryan Zezeski:
&gt;
&gt; Greg,
&gt;
&gt;
&gt; Your expectations are fair, just because you added a node doesn't mean
&gt; Riak should return notfounds. Unfortunately, we aren't quite there
&gt; yet. This is a side effect of how Riak currently implements handoff
&gt; in that it immediately updates/gossips the ring causing
&gt; many partitions to handoff immediately. If a request comes in that
&gt; relies on these partitions then it will get a notfound and perform
&gt; read repair. You're situation is multiplied by the fact that you are
&gt; going from 3 nodes to 4. More vnode shuffling occurs because of the
&gt; small cluster size.
&gt;
&gt;
&gt; We're well aware of this and have it on our radar for improvement in a
&gt; future release.
&gt;
&gt;
&gt; All this said, you data will be eventually consistent. That is, all
&gt; your data will eventually be handed off and things will work as
&gt; normal. It's only during the handoff that you \\_may\\_ encounter
&gt; notfounds. In this case it would be best to add a new node to your
&gt; cluster at lowest load times and if you can spare additional hardware
&gt; a few more nodes to start with is an even easier option.
&gt;
&gt;
&gt; -Ryan
&gt;
&gt; On Mon, May 2, 2011 at 9:48 PM, Greg Nelson 
&gt; wrote:
&gt; Hello riak users!
&gt;
&gt;
&gt; I have a 4 node cluster that started out as 3 nodes.
&gt; ring\\_creation\\_size = 2048, target\\_n\\_val is default (4), and
&gt; all buckets have n\\_val = 3.
&gt;
&gt;
&gt; When I joined the 4th node, for a few minutes some GETs were
&gt; returning 'not found' for data that was already in riak.
&gt; Eventually the data was returned, due to read repair I would
&gt; assume. Is this expected? It seems that 'not found' and read
&gt; repairs should only happen when something goes wrong, like a
&gt; node goes down. Not when adding a node to the cluster, which
&gt; is supposed to be part of normal operation!
&gt;
&gt;
&gt; Any help or insight is appreciated!
&gt;
&gt;
&gt; Greg
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

