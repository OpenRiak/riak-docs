---
title: "Re: Riak and host names"
description: ""
project: community
lastmod: 2013-01-07T14:01:13-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09749"
mailinglist_parent_id: "msg09743"
author_name: "Matt Black"
project_section: "mailinglistitem"
sent_date: 2013-01-07T14:01:13-08:00
---


Thanks for this Charlie.

I'm running a production Riak cluster on AWS which runs constantly, and
I've been wondering how I might be able to easliy stop and start AWS nodes
for a testing and benchmarking cluster (to save on cost).

By using the 'riaknode1.priv' hostname method you describe, would I be able
to stop and then restart a whole cluster of nodes at once? (As described by
Deepak, AWS assigns new IPs when a VM starts).

Thanks
Matt


On 8 January 2013 01:31, Charlie Voiselle  wrote:

&gt; Deepak:
&gt;
&gt; When you name a node in app.config with -name it has to have a '.' in it,
&gt; like r...@hostname.net As you have surmised, you can get around that if
&gt; you use the -sname argument instead.
&gt;
&gt; They have to be done consistently. In your example, had you used the
&gt; -sname argument, `riak@riaknode1` would work. Making a host entry
&gt; `riaknode1.priv` that points to the local address would work with the -name
&gt; argument.
&gt;
&gt; The inportant thing about -name and -sname is that they can't mix within a
&gt; cluster.
&gt;
&gt; Cluster replace is designed to replace a node with a new one and transfer
&gt; all the partitions. You can cheat and use it to rename a node though.
&gt;
&gt; The process to do this would look like the following:
&gt;
&gt; - Stop the node to rename with `riak stop`
&gt; - Mark it 'down' \\*from another node in the cluster \\*using `riak-admin
&gt; down «old nodename».
&gt; - Rename the node in vm.args.
&gt; - Delete the ring directory.
&gt; - Start the node with `riak start`.
&gt; - It will come up as a single instance which you can verify with
&gt; `riak-admin member-status`.
&gt; - Join the node to the cluster with `riak-admin cluster join «cluster
&gt; nodename» `
&gt; - Set it to replace the old instance of itself with `riak-admin
&gt; cluster replace «old nodename» «new nodename»
&gt; - Plan the changes with `riak-admin cluster plan`
&gt; - Commit the changes with `riak-admin cluster commit`
&gt;
&gt;
&gt; As you can see, this is a very large effort, so best to use hostnames that
&gt; aren't moving around. Apologies for you getting this twice, Deepak. I
&gt; failed to reply to the list as well.
&gt;
&gt; Hope this makes sense...
&gt; Charlie
&gt; On Jan 1, 2013, at 2:43 PM, Deepak Balasubramanyam 
&gt; wrote:
&gt;
&gt; I took the AWS EC2 riak image for a spin today. I have a query regarding
&gt; riak nodes and how they behave when the machine reboots.
&gt;
&gt; When an EC2 instance reboots, the internal ip / internal DNS / external
&gt; DNS change. This renders the app.config and -name argument on vm.args
&gt; incorrect. I was exploring solutions to deal with this problem.
&gt;
&gt; \\*1. Preventive measures\\*
&gt;
&gt; Someone on this thread dated May 
&gt; 2011
&gt; suggested
&gt; using host file entries that point to the local internal IP address. That
&gt; does not seem to work. Riak fails with the following error when I add a new
&gt; entry to /etc/hosts and configure vm.args with -name riak@riaknode1
&gt;
&gt; Hostname riaknode1 is illegal
&gt;
&gt; I confirmed that riaknode1 pings correctly before starting riak. I guess
&gt; erlang tries to match the hostname of the system resulting in this failure
&gt; ? Can anyone throw some light on this ?
&gt;
&gt; \\*2. Use -sname\\*
&gt;
&gt; Is starting the erlang VM with the sname flag an option if it will help
&gt; prevent the 'illegal hostname' error ?
&gt; Disclaimer: My knowledge of erlang is close to zilch, so sorry if that
&gt; option sounded like something you could dismiss easily :)
&gt;
&gt; \\*3. Use cluster replace
&gt; \\*
&gt;
&gt; a. I understand that the IPs in app.config and vm.args can be replaced
&gt; with the correct IP on a restart and using a subsequent 'cluster replace'
&gt; command will do. Will executing the 'cluster plan' and 'cluster commit'
&gt; commands now produce network chatter ?
&gt;
&gt; b . What happens if 2 nodes go down and one was joined with the other.
&gt; They both have 2 different IP addresses on restart. How will 'cluster
&gt; replace' work now ?
&gt;
&gt; Do let me know your thoughts.
&gt;
&gt; Thanks
&gt; -Deepak
