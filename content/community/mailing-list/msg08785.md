---
title: "Re: Riak Memory Usage Constantly Growing"
description: ""
project: community
lastmod: 2012-10-02T07:55:28-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08785"
mailinglist_parent_id: "msg08784"
author_name: "Kelly McLaughlin"
project_section: "mailinglistitem"
sent_date: 2012-10-02T07:55:28-07:00
---


John and Shane,

I have been looking into some memory issues lately and I would be very 
interested in more
information about your particular problems. If either of you are able to get 
some output 
from etop using the -sort memory option when you are having elevated memory 
usage it 
would be very helpful to see. I know that sometimes you get the connection\\_lost 
message 
when trying to use etop, but I have found that sometimes if you keep trying it 
may succeed 
after a few attempts. 

Are either of you using MapReduce? I see that John is using 2I. Shane, do you 
also use 2I?
Finally, do you notice a lot of messages to the console or console log that 
have the either the 
phrase 'monitor large\\_heap' or 'monitor long\\_gc'?

Kelly

On Oct 2, 2012, at 6:11 AM, "John E. Vincent"  
wrote:

&gt; I would highly suggest you upgrade to 1.2 when possible. We were, up
&gt; until recently, running on 1.4 and seeing the same problems you
&gt; describe. Take a look at this graph:
&gt; 
&gt; http://i.imgur.com/0RtsU.png
&gt; 
&gt; That's just one of our nodes but all of them exhibited the same
&gt; behavior. The falloffs are where we had to bounce riak.
&gt; 
&gt; This is what one of our nodes looks like now and has looked like since
&gt; the upgrade:
&gt; 
&gt; http://i.imgur.com/pm7Nk.png
&gt; 
&gt; The change was SO dramatic that I seriously though /stats was broken.
&gt; I've verified outside of Riak and inside. The memory usage change was
&gt; very positive. Evidently there's even still a memory leak.
&gt; 
&gt; We're heavy 2i users. No multi backend.
&gt; 
&gt; On Tue, Oct 2, 2012 at 4:08 AM, Shane McEwan  wrote:
&gt;&gt; G'day!
&gt;&gt; 
&gt;&gt; Just recently we've noticed memory usage in our Riak cluster constantly
&gt;&gt; increasing.
&gt;&gt; 
&gt;&gt; The memory usage reported by the Riak stats "memory\\_total" parameter has
&gt;&gt; been less than 100MB for nearly a year but has recently increased to over
&gt;&gt; 1GB.
&gt;&gt; 
&gt;&gt; If we restart the cluster memory usage usually returns back to what we would
&gt;&gt; call "normal" but after a week or so of stability the memory usage starts
&gt;&gt; gradually growing again. Sometimes after a growth spurt over a few days the
&gt;&gt; memory usage will plateau and be stable again for a week or two and then put
&gt;&gt; on another growth spurt. The memory usage starts increasing at the same
&gt;&gt; moment on all 4 nodes.
&gt;&gt; 
&gt;&gt; This graph [http://imagebin.org/230614] shows what I mean. The green shows
&gt;&gt; the memory usage as reported by "memory\\_total" (left-hand y-axis scale). The
&gt;&gt; red line shows the memory used by Riak's beam.smp process (right-hand y-axis
&gt;&gt; scale).
&gt;&gt; 
&gt;&gt; Also notice that the gradient of the recent growth seems to be increasing
&gt;&gt; compared to the memory increases we had in August.
&gt;&gt; 
&gt;&gt; We might have just assumed that the memory usage was normal Riak behaviour.
&gt;&gt; Perhaps we have just tipped over some sort of internal buffer or cache and
&gt;&gt; that causes some more memory to be allocated. However, whenever we notice
&gt;&gt; the memory usage increasing it always coincides with the "riak-admin top"
&gt;&gt; command failing to run.
&gt;&gt; 
&gt;&gt; We try to run "riak-admin top" to diagnose what is using the memory but it
&gt;&gt; returns: "Output server crashed: connection\\_lost". If we restart the cluster
&gt;&gt; the top command works fine (but, of course, there's nothing interesting to
&gt;&gt; see after a restart!).
&gt;&gt; 
&gt;&gt; So our theory at the moment is that some sort of instability or race
&gt;&gt; condition is causing Riak to start consuming more and more memory. A side
&gt;&gt; effect of this instability is that the internal processes needed for running
&gt;&gt; the top command are not working correctly. The actual functionality of Riak
&gt;&gt; doesn't seem to be affected. Our application is running fine. We see a
&gt;&gt; slight increase in "FSM Put" times and CPU usage during the memory growth
&gt;&gt; phases but all other parameters we're monitoring on the system seem
&gt;&gt; unaffected.
&gt;&gt; 
&gt;&gt; There's nothing abnormal in the logs. We get a lot of "riak\\_pipe\\_builder\\_sup
&gt;&gt; {sink\\_died,normal}" messages but they can be ignored, apparently. The
&gt;&gt; cluster is under constant load so we would expect to see either gradual
&gt;&gt; memory increase or a steady state but not both. Erlang process count, open
&gt;&gt; file handles, etc are stable.
&gt;&gt; 
&gt;&gt; So I was wondering if anyone has seen similar behaviour before?
&gt;&gt; Is there anything else we can do to diagnose the problem?
&gt;&gt; I'm accessing the stats URL once per minute, could that have any side
&gt;&gt; effects?
&gt;&gt; We'll be upgrading to Riak 1.2 and new hardware in the next few weeks so
&gt;&gt; should we just ignore it and hope it goes away?
&gt;&gt; Any other ideas?
&gt;&gt; Or is this just normal?
&gt;&gt; 
&gt;&gt; Riak config:
&gt;&gt; 4 VMware nodes
&gt;&gt; ring\\_creation\\_size, 256
&gt;&gt; n\\_val, 3
&gt;&gt; eleveldb backend:
&gt;&gt; max\\_open\\_files, 20
&gt;&gt; cache\\_size, 15728640
&gt;&gt; "riak\\_kv\\_version":"1.1.1",
&gt;&gt; "riak\\_core\\_version":"1.1.1",
&gt;&gt; "stdlib\\_version":"1.17.4",
&gt;&gt; "kernel\\_version":"2.14.4"
&gt;&gt; Erlang R14B03 (erts-5.8.4)
&gt;&gt; 
&gt;&gt; Thanks!
&gt;&gt; 
&gt;&gt; Shane.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt; 
