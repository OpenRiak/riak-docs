---
title: "Re: Node cannot join"
description: ""
project: community
lastmod: 2012-08-21T07:17:40-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08339"
mailinglist_parent_id: "msg08338"
author_name: "Shane McEwan"
project_section: "mailinglistitem"
sent_date: 2012-08-21T07:17:40-07:00
---

Speaking of joining clusters . . .

I'm in the middle of writing a CFEngine promise to automatically install 
Riak, configure it and join a cluster.


Is it best to have all nodes issue a 'riak-admin cluster join' command 
before a single node issues the final 'riak-admin cluster commit' 
command? (Potentially hard to do with CFEngine) Or is it OK to have each 
node issue its own 'join' and 'commit' commands? (Reasonably easy)


Or is it a bad idea to build the cluster automatically and I should 
really be doing it manually?


Secondly, is there a riak-admin command or status value that 
definitively says "This node is part of a cluster" (even if all other 
nodes in the cluster are down) so that CFEngine knows not to re-issue 
the cluster join command a second time?


Thanks!

On 21/08/12 14:36, Ryan Zezeski wrote:

Daniel,

Cluster operations (invoked by `riak-admin cluster`) are now
multi-phase. Instead of calling an operation and it taking effect
immediately you need to stage your changes, view your changes, and then
commit them. E.g.

riak-admin cluster join blah

riak-admin cluster plan

riak-admin cluster commit

There is an `-f` option to keep the old behavior but we recommend
against this. Staged clustering was put in place to keep users from
hurting their clusters and to make multiple changes more efficient.

-Z

On Tue, Aug 21, 2012 at 9:28 AM, Daniel Iwan &gt; wrote:

 Hi

 In my setup everything worked fine until I upgraded to riak 1.2
 (although this may be a coincidence)
 Nodes are installed from scratch with changes only to db backend (I'm
 using eLevelDB)
 and names.
 For some reason node cannot join to another.
 What am I doing wrong?

 I'm using Ubuntu 10.04 but I've seen the same behaviour on Ubuntu 12.04
 I may miss openssl dependency. I don't know if that matters


 user@node2:~$ riak-admin cluster join riak@10.173.240.1
 
 Attempting to restart script through sudo -H -u riak
 Success: staged join request for 'riak@10.173.240.2
 ' to 'riak@10.173.240.1
 '


 user@node1:~$ riak-admin member-status
 Attempting to restart script through sudo -H -u riak
 ================================= Membership
 ==================================
 Status Ring Pending Node
 
-------------------------------------------------------------------------------
 joining 0.0% -- 'riak@10.173.240.2
 '
 valid 100.0% -- 'riak@10.173.240.1
 '
 
-------------------------------------------------------------------------------

 Valid:1 / Leaving:0 / Exiting:0 / Joining:1 / Down:0
 user@node1:~$
 user@node1:~$ riak-admin transfers

 Attempting to restart script through sudo -H -u riak
 No transfers active

 Active Transfers:

 user@node1:~$

 riak-admin status
 Attempting to restart script through sudo -H -u riak
 1-minute stats for 'riak@10.173.240.1 '
 -------------------------------------------
 vnode\\_gets : 0
 vnode\\_gets\\_total : 0
 vnode\\_puts : 0
 vnode\\_puts\\_total : 0
 vnode\\_index\\_reads : 0
 vnode\\_index\\_reads\\_total : 0
 vnode\\_index\\_writes : 0
 vnode\\_index\\_writes\\_total : 0
 vnode\\_index\\_writes\\_postings : 0
 vnode\\_index\\_writes\\_postings\\_total : 0
 vnode\\_index\\_deletes : 0
 vnode\\_index\\_deletes\\_total : 0
 vnode\\_index\\_deletes\\_postings : 0
 vnode\\_index\\_deletes\\_postings\\_total : 0
 node\\_gets : 0
 node\\_gets\\_total : 0
 node\\_get\\_fsm\\_siblings\\_mean : 0
 node\\_get\\_fsm\\_siblings\\_median : 0
 node\\_get\\_fsm\\_siblings\\_95 : 0
 node\\_get\\_fsm\\_siblings\\_99 : 0
 node\\_get\\_fsm\\_siblings\\_100 : 0
 node\\_get\\_fsm\\_objsize\\_mean : 0
 node\\_get\\_fsm\\_objsize\\_median : 0
 node\\_get\\_fsm\\_objsize\\_95 : 0
 node\\_get\\_fsm\\_objsize\\_99 : 0
 node\\_get\\_fsm\\_objsize\\_100 : 0
 node\\_get\\_fsm\\_time\\_mean : 0
 node\\_get\\_fsm\\_time\\_median : 0
 node\\_get\\_fsm\\_time\\_95 : 0
 node\\_get\\_fsm\\_time\\_99 : 0
 node\\_get\\_fsm\\_time\\_100 : 0
 node\\_puts : 0
 node\\_puts\\_total : 0
 node\\_put\\_fsm\\_time\\_mean : 0
 node\\_put\\_fsm\\_time\\_median : 0
 node\\_put\\_fsm\\_time\\_95 : 0
 node\\_put\\_fsm\\_time\\_99 : 0
 node\\_put\\_fsm\\_time\\_100 : 0
 read\\_repairs : 0
 read\\_repairs\\_total : 0
 coord\\_redirs\\_total : 0
 executing\\_mappers : 0
 precommit\\_fail : 0
 postcommit\\_fail : 0
 pbc\\_active : 0
 pbc\\_connects : 0
 pbc\\_connects\\_total : 0
 cpu\\_nprocs : 340
 cpu\\_avg1 : 182
 cpu\\_avg5 : 136
 cpu\\_avg15 : 92
 mem\\_total : 4154609664
 mem\\_allocated : 1475477504
 disk : [{"/",54417668,2},
 {"/dev",2024188,1},
 {"/dev/shm",2028616,0},
 {"/var/run",2028616,1},
 {"/var/lock",2028616,0},
 {"/lib/init/rw",2028616,0},
 {"/var/lib/ureadahead/debugfs",54417668,2},
 {"/media/ARRAY1",10739982336,1},
 {"/boot",186663,22}]
 nodename : 'riak@10.173.240.1 '
 connected\\_nodes : ['riak@10.173.240.2 ']
 sys\\_driver\\_version : &lt;&lt;"2.0"&gt;&gt;
 sys\\_global\\_heaps\\_size : 0
 sys\\_heap\\_type : private
 sys\\_logical\\_processors : 4
 sys\\_otp\\_release : &lt;&lt;"R15B01"&gt;&gt;
 sys\\_process\\_count : 1392
 sys\\_smp\\_support : true
 sys\\_system\\_version : &lt;&lt;"Erlang R15B01 (erts-5.9.1) [source] [64-bit]
 [smp:4:4] [async-threads:64] [kernel-poll:true]"&gt;&gt;
 sys\\_system\\_architecture : &lt;&lt;"x86\\_64-unknown-linux-gnu"&gt;&gt;
 sys\\_threads\\_enabled : true
 sys\\_thread\\_pool\\_size : 64
 sys\\_wordsize : 8
 ring\\_members : ['riak@10.173.240.1
 ','riak@10.173.240.2
 ']
 ring\\_num\\_partitions : 64
 ring\\_ownership : &lt;&lt;"[{'riak@10.173.240.1
 ',64}]"&gt;&gt;
 ring\\_creation\\_size : 64
 storage\\_backend : riak\\_kv\\_eleveldb\\_backend
 erlydtl\\_version : &lt;&lt;"0.7.0"&gt;&gt;
 riak\\_control\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 cluster\\_info\\_version : &lt;&lt;"1.2.2"&gt;&gt;
 riak\\_api\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 riak\\_search\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 merge\\_index\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 riak\\_kv\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 riak\\_pipe\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 riak\\_core\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 lager\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 syntax\\_tools\\_version : &lt;&lt;"1.6.8"&gt;&gt;
 compiler\\_version : &lt;&lt;"4.8.1"&gt;&gt;
 bitcask\\_version : &lt;&lt;"1.5.1"&gt;&gt;
 basho\\_stats\\_version : &lt;&lt;"1.0.2"&gt;&gt;
 luke\\_version : &lt;&lt;"0.2.5"&gt;&gt;
 webmachine\\_version : &lt;&lt;"1.9.2"&gt;&gt;
 mochiweb\\_version : &lt;&lt;"1.5.1"&gt;&gt;
 inets\\_version : &lt;&lt;"5.9"&gt;&gt;
 erlang\\_js\\_version : &lt;&lt;"1.2.0"&gt;&gt;
 runtime\\_tools\\_version : &lt;&lt;"1.8.8"&gt;&gt;
 os\\_mon\\_version : &lt;&lt;"2.2.9"&gt;&gt;
 riak\\_sysmon\\_version : &lt;&lt;"1.1.2"&gt;&gt;
 ssl\\_version : &lt;&lt;"5.0.1"&gt;&gt;
 public\\_key\\_version : &lt;&lt;"0.15"&gt;&gt;
 crypto\\_version : &lt;&lt;"2.1"&gt;&gt;
 sasl\\_version : &lt;&lt;"2.2.1"&gt;&gt;
 stdlib\\_version : &lt;&lt;"1.18.1"&gt;&gt;
 kernel\\_version : &lt;&lt;"2.15.1"&gt;&gt;
 memory\\_total : 26853928
 memory\\_processes : 6744452
 memory\\_processes\\_used : 6744438
 memory\\_system : 20109476
 memory\\_atom : 429569
 memory\\_atom\\_used : 406875
 memory\\_binary : 58504
 memory\\_code : 9277444
 memory\\_ets : 774080


 D.
