---
title: "Re: Parameter Planning (eleveldb)"
description: ""
project: community
lastmod: 2013-02-05T05:11:20-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09985"
mailinglist_parent_id: "msg09984"
author_name: "Matthew Von-Maszewski"
project_section: "mailinglistitem"
sent_date: 2013-02-05T05:11:20-08:00
---


30,000: So that you ever have to think about it again.

Matthew


On Feb 5, 2013, at 3:54, Simon Effenberg  wrote:

&gt; Hey Matthew,
&gt; 
&gt; thank you very much!
&gt; 
&gt; I know that the ulimit -n isn't only for normal file FD's but we'll
&gt; have probably not more than 4 client connections per server and with 6
&gt; servers in a cluster probably not so much (but correct me if I'm wrong)
&gt; interconnection links so I would use a bigger ulimit for sure but
&gt; 30,000? :)
&gt; 
&gt; Cheers,
&gt; Simon
&gt; 
&gt; On Mon, 4 Feb 2013 08:47:21 -0500
&gt; Matthew Von-Maszewski  wrote:
&gt; 
&gt;&gt; - file handles / ulimit -n: Linux "file handles" are not just about open 
&gt;&gt; files. The setting includes open network sockets too. You do NOT want to 
&gt;&gt; set this close to your expected number of files. You want to set it to a 
&gt;&gt; multiple of your expected files. I use 30,000 or 60,000 depending upon the 
&gt;&gt; machine. In fact, those high numbers are normal for heavy server 
&gt;&gt; activities. Keep in mind that the base Linux settings have a laptop in mind.
&gt;&gt; 
&gt;&gt; - disk scheduler: "cfq" is really bad for servers, great for laptops. 
&gt;&gt; Whether you use "noop" or "deadline", you are far better off than the Linux 
&gt;&gt; default. I have never personally tested the difference between noop` and 
&gt;&gt; deadline. Different people have told me they found each of them best for 
&gt;&gt; spinning hard drives. However, there seems to be more on-line discussion in 
&gt;&gt; recent months for using deadline for spinning and noop (plus other settings) 
&gt;&gt; for SSD drives. Again, I feel your biggest gain is in not use "cfq". The 
&gt;&gt; rest is testing and tuning.
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Feb 4, 2013, at 2:18 AM, Simon Effenberg  
&gt;&gt; wrote:
&gt;&gt; 
&gt;&gt;&gt; Thanks again Matthew,
&gt;&gt;&gt; 
&gt;&gt;&gt; I think for now I can start with this. I'll have 256/6 partitions per
&gt;&gt;&gt; node and so if there is one dieing the others have to handle it better
&gt;&gt;&gt; so 256/5 per node multiplied by 92 is 4711 as ulimit setting, right?
&gt;&gt;&gt; 
&gt;&gt;&gt; One question coming into my mind, the Tips & Tricks section talks about
&gt;&gt;&gt; the noop elevator/disk scheduler whereas this post:
&gt;&gt;&gt; http://riak-users.197444.n3.nabble.com/Riak-performance-problems-when-LevelDB-database-grows-beyond-16GB-tp4025608p4025622.html
&gt;&gt;&gt; is talking about deadline for spinning disks (what we will have). So
&gt;&gt;&gt; who is right or who is outdated?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks again for your help!!
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers,
&gt;&gt;&gt; Simon
&gt;&gt;&gt; 
&gt;&gt;&gt; On Sun, 3 Feb 2013 17:55:38 -0500
&gt;&gt;&gt; Matthew Von-Maszewski  wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I will assume you use the default write buffer settings … cuz that is a 
&gt;&gt;&gt;&gt; whole different discussion and there are two settings not one (\\_min and 
&gt;&gt;&gt;&gt; \\_max).
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; The default min is 32M and the default max is 64M … so your value is 48M 
&gt;&gt;&gt;&gt; for the average\\_write\\_buffer\\_size.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Superbowl is about to start here, so I am not performing a detailed check 
&gt;&gt;&gt;&gt; of your math. However, I can judge the 92 open files looks correct 
&gt;&gt;&gt;&gt; compared to similar systems.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; What questions remain?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Matthew
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On Feb 3, 2013, at 5:44 PM, Simon Effenberg  
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Hi Matthew,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; thanks a lot!
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; So now I have:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 6 nodes each having 32GB RAM:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; vnode\\_working\\_memory = 16GB / 256 / 6 (50% of RAM devided by ringsize
&gt;&gt;&gt;&gt;&gt; devided by nodes) = 390 MB
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory =
&gt;&gt;&gt;&gt;&gt; (max\\_open\\_files-10) \\* (
&gt;&gt;&gt;&gt;&gt; 184 + (104MB/2048) \\*
&gt;&gt;&gt;&gt;&gt; (8 + ((16+14336)/2048 +1) \\*
&gt;&gt;&gt;&gt;&gt; 0.6
&gt;&gt;&gt;&gt;&gt; )
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Now I'm missing the max\\_open\\_files .. how to calculate it?
&gt;&gt;&gt;&gt;&gt; I'm missing also average\\_write\\_buffer\\_size (see my question in Step 4).
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; If I would use the default values for average\\_write\\_buffer\\_size the
&gt;&gt;&gt;&gt;&gt; max\\_open\\_files could be calculated like:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; memory/vnode = average\\_write\\_buffer\\_size + cache\\_size +
&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory + 20 MB
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; (memory/vnode) - 20 MB - cache\\_size - average\\_write\\_buffer\\_size =
&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; so with the default values:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory = 390MB - 20MB - 8MB - 45MB = 317MB
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; and now max\\_open\\_files would be
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory = (max\\_open\\_files-10) \\* (184 + (104MB/2048) \\* (8 + ((16
&gt;&gt;&gt;&gt;&gt; +14336)/2048 +1) \\* 0.6 )
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; (max\\_open\\_files-10) = open\\_file\\_memory / (184 + (104MB/2048) \\* (8 +
&gt;&gt;&gt;&gt;&gt; ((16+14336)/2048 +1) \\* 0.6 )
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; max\\_open\\_files = open\\_file\\_memory / (184 + (104MB/2048) \\* (8 +
&gt;&gt;&gt;&gt;&gt; ((16+14336)/2048 +1) \\* 0.6 ) + 10
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; max\\_open\\_files = 317MB / (184+53248\\*(8+67.8)) + 10
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; max\\_open\\_files = 317MB / 4036382.4 + 10
&gt;&gt;&gt;&gt;&gt; &lt;=&gt; max\\_open\\_files ~= 92
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; That would be the maximum amount of open files a server can handle
&gt;&gt;&gt;&gt;&gt; (per vnode), am I right? But now, is this enough? Or how to calculate
&gt;&gt;&gt;&gt;&gt; 50% temporary server loss (3 of 6) and how is the count of keys/values
&gt;&gt;&gt;&gt;&gt; is taking into account? I'm somehow lost :(
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Cheers
&gt;&gt;&gt;&gt;&gt; Simon
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Sun, 3 Feb 2013 16:12:25 -0500
&gt;&gt;&gt;&gt;&gt; Matthew Von-Maszewski  wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; First: Step 2 is talking about how many vnodes exist on a physical 
&gt;&gt;&gt;&gt;&gt;&gt; server. If your ring size is 256, but you have 8 servers … then your 
&gt;&gt;&gt;&gt;&gt;&gt; vnode count for step 2 is 32.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Second: the 2048 is a constant forced by Google's leveldb 
&gt;&gt;&gt;&gt;&gt;&gt; implementation. It is the portion of a file covered by a single bloom 
&gt;&gt;&gt;&gt;&gt;&gt; filter. This calculation constant disappears with the upcoming 1.3 
&gt;&gt;&gt;&gt;&gt;&gt; release.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Third: yes there is a "block\\_size" parameter that is 4096. Increase 
&gt;&gt;&gt;&gt;&gt;&gt; that only if you want to REDUCE the performance of the leveldb instance. 
&gt;&gt;&gt;&gt;&gt;&gt; 4096 is a very happy value. We have customers and tests with 130K data 
&gt;&gt;&gt;&gt;&gt;&gt; values, all using 4096 block size. The block\\_size only governs the 
&gt;&gt;&gt;&gt;&gt;&gt; minimum written (aggregate size of small values that must be written as 
&gt;&gt;&gt;&gt;&gt;&gt; one unit at minimum).
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Use 104Mbyte for your average sst file size. It is "good enough"
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; I am not following the question stream for Step 4 and beyond. Please 
&gt;&gt;&gt;&gt;&gt;&gt; state again.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Matthew
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Feb 3, 2013, at 3:44 PM, Simon Effenberg  
&gt;&gt;&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I'm not sure if I understand this all well to calculate the memory
&gt;&gt;&gt;&gt;&gt;&gt;&gt; usage per file and other stuff.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; The webpage tells me some steps but I'm completly unsure if I 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; understand all parameters.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; "Step 1: Calculate Available Working Memory"
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; taking the example:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; leveldb\\_working\\_memory = 32G \\* (1 - .50) = 16G
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; "Step 2: Calculate Working Memory per vnode"
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; vnode\\_working\\_memory = leveldb\\_working\\_memory / vnode\\_count
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; vnode\\_count = 256
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; =&gt; vnode\\_working\\_memory = 16G / 256 = 64MB/vnode
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; also easy
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; "Step 3: Estimate Memory Used by Open Files"
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory =
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (max\\_open\\_files-10) \\* (
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 184 + (average\\_sst\\_filesize/2048) \\*
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (8 + ((average\\_key\\_size+average\\_value\\_size)/2048 +1) \\*
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 0.6
&gt;&gt;&gt;&gt;&gt;&gt;&gt; )
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; so how do I know the average\\_sst\\_filesize (and what is this value 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; exactly)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (and is 2048 for both /2048 true or 4096 in riak 1.2?) and how do I know
&gt;&gt;&gt;&gt;&gt;&gt;&gt; the max\\_open\\_files?
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; average\\_key\\_size could be 16byte (I have to ask someone but taking it 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; for now)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; average\\_value\\_size will be 14kbyte 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; so for now
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory =
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (max\\_open\\_files-10) \\* (
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 184 + (average\\_sst\\_filesize/2048) \\*
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (8 + ((16+14336)/2048 +1) \\*
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 0.6
&gt;&gt;&gt;&gt;&gt;&gt;&gt; )
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; (side question: should I increase the block\\_size because of the big 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; average value size?
&gt;&gt;&gt;&gt;&gt;&gt;&gt; and also should I leave the cache\\_size at the default value like it was 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; recommended?)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; "Step 4: Calculate Average Write Buffer"
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; should I increase these values or not? If only two are held in memory 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; and I have, as an
&gt;&gt;&gt;&gt;&gt;&gt;&gt; example, 32GB or RAM like in this scenario, shouldn't I increase it to 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; something else?
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; "Step 5: Calculate vnode Memory Used"
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; memory/vnode = average\\_write\\_buffer\\_size + cache\\_size + 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; open\\_file\\_memory + 20 MB
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; So for now I miss almost all 3 values :(.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; To get an Idea:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; - 3 buckets
&gt;&gt;&gt;&gt;&gt;&gt;&gt; - overall ~ 343347732 keys (but only 2/3 have 14kbyte in average)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Thx for help!
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Simon
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt;&gt;&gt;&gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt;&gt;&gt;&gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Mail: seffenb...@team.mobile.de
&gt;&gt;&gt;&gt;&gt; Web: www.mobile.de
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Geschäftsführer: Malte Krüger
&gt;&gt;&gt;&gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt;&gt;&gt;&gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; -- 
&gt;&gt;&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt;&gt;&gt; Fon: + 49-(0)30-8109 - 7173
&gt;&gt;&gt; Fax: + 49-(0)30-8109 - 7131
&gt;&gt;&gt; 
&gt;&gt;&gt; Mail: seffenb...@team.mobile.de
&gt;&gt;&gt; Web: www.mobile.de
&gt;&gt;&gt; 
&gt;&gt;&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; Geschäftsführer: Malte Krüger
&gt;&gt;&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt;&gt;&gt; Sitz der Gesellschaft: Kleinmachnow 
&gt;&gt; 
&gt; 
&gt; 
&gt; -- 
&gt; Simon Effenberg | Site Ops Engineer | mobile.international GmbH
&gt; Fon: + 49-(0)30-8109 - 7173
&gt; Fax: + 49-(0)30-8109 - 7131
&gt; 
&gt; Mail: seffenb...@team.mobile.de
&gt; Web: www.mobile.de
&gt; 
&gt; Marktplatz 1 | 14532 Europarc Dreilinden | Germany
&gt; 
&gt; 
&gt; Geschäftsführer: Malte Krüger
&gt; HRB Nr.: 18517 P, Amtsgericht Potsdam
&gt; Sitz der Gesellschaft: Kleinmachnow 

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

