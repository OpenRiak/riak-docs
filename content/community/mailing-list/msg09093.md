---
title: "Re: Issue with clustering Riak nodes on CentOS servers."
description: ""
project: community
lastmod: 2012-10-30T15:36:21-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09093"
mailinglist_parent_id: "msg09085"
author_name: "Bryan Hughes"
project_section: "mailinglistitem"
sent_date: 2012-10-30T15:36:21-07:00
---

Hi James,

We have a 5 node cluster running in production with no problems on 
CentOS. We have each node isolated on a private lan. Our application 
server has two interfaces, one to the outside world with a very 
restricted firewall, and the second connected to the private lan with 
the 5 nodes.


Assuming you set the node names accordingly and followed:

http://docs.basho.com/riak/latest/cookbooks/Basic-Cluster-Setup/

One thing to check would your firewall, which is by default on with CentOS.

&gt;sudo service iptables status

If you have your 4 nodes on a private lan, or perhaps well protected 
behind a firewall as an internal deployment, then it is relatively 
straight forward. You can just turn off your firewall on the 4 machines.


If your machines are not on a isolated private lan and are exposed to 
the internet, or just need to be protected behind a firewall, you will 
need to do the following.


http://docs.basho.com/riak/1.2.0/cookbooks/Network-Security-and-Firewall-Configurations/

First, in your app.config, you will need to add the following at the top 
level (same as riak.core). You can pick whatever min and max range you 
want - here I arbitrarily chosen 4 ports:


{ kernel, [
 {inet\\_dist\\_listen\\_min, 7010},
 {inet\\_dist\\_listen\\_max, 7014}
 ]},

Next, on each or our riak nodes, you will need to edit your iptables. I 
tend to edit them manually using sudo.


&gt; sudo vi /etc/sysconfig/iptables (and add the following to 
RH-Firewall-1-INPUT just above the icmp-host-prohibited)


-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 4369 
-j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 8087 
-j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 8099 
-j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 
7010:7014 -j ACCEPT


&gt; sudo service iptables restart

After doing this on all the nodes, they should all be visible to each 
other. If you wanted to lock down your firewall even further, you can 
specify a range of IP addresses.


Finally, on the machine that your erlang application or Riak client, you 
will need to do the following:


sudo vi /etc/sysconf/iptable (and add the following to 
RH-Firewall-1-INPUT just above the icmp-host-prohibited)


-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 8098 
-j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 8087 
-j ACCEPT


&gt; sudo service iptables restart


Hope this helps...
Bryan


On 10/30/12 11:39 AM, SWEENEY, JAMES wrote:

Hello, I am attempting to create a 4 node riak installation on 4 separate 
CentOS servers. Installation of Riak went well. We have run simple tests 
like riak ping, sudo curl \\-v http://127.0.0.1:8098/riak/test, ect, and 
everything seems fine with the riak servers, they all start up with no errors. 
 We used the default ports in the app.config files. Ie: epmd listener: 
TCP:4369
handoff\\_port listener: TCP:8099
web\\_port: TCP:8098
pb\\_port: TCP:8087

We have updated all ip addresses in the config files as instructed on the riak 
site. Also, we have verified by telnet that the ports are all open and that I 
can telnet between the riak servers. Still after all of that, when I try to 
do a cluster command I get the following response:


[root@essd-riak-test-server ~]# riak-admin cluster join riak@10.1.78.9
Attempting to restart script through sudo -H -u riak
Node riak@10.1.78.9 is not reachable!
[root@essd-riak-test-server ~]#

I have been stuck on this issue for quite a while and tried everything I found 
on the riak web site to resolve this. Any help you could offer would greatly 
be appreciated. Thanks in advance.

Sincerely,

James Sweeney


--

Bryan Hughes
CTO and Founder / \\*Go Factory\\*
(415) 515-7916
http://www.go-factory.net

/"Art is never finished, only abandoned. - Leonardo da Vinci"/
