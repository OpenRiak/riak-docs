---
title: "Cluster Client retries"
description: ""
project: community
lastmod: 2012-10-16T03:51:59-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08931"
mailinglist_parent_id: "msg08929"
author_name: "Brian Roach"
project_section: "mailinglistitem"
sent_date: 2012-10-16T03:51:59-07:00
---


The Java ClusterClient uses a very simple round-robin and downed nodes
are not removed from the rotation. In addition, it uses a global index
that gets incremented on every operation/retry from the client
threads.

Especially with 3 nodes and any amount of load it is likely a single
thread will end up retrying the same downed node and then fail the
operation.

The best solution currently is to use HAProxy or another load
balancer. This is something we aim to improve as we further develop
the Java client.

Thanks!
Brian Roach

On Tue, Oct 16, 2012 at 2:31 AM, Philippe Guillebert
 wrote:
&gt; Hi list,
&gt;
&gt; We have a cluster of three Riak 0.14.2 nodes in production and quite happy
&gt; with it. I'm planning the upgrade to 1.2.0 and while testing it, I wondered
&gt; about how a client should behave during a rolling upgrade (1 node is down
&gt; for maintenance but the cluster is working).
&gt;
&gt; My expectations for a client is, if a given node is down the client will try
&gt; on another node of the cluster to "hide" the maintenance to the upper layers
&gt; of my application.
&gt;
&gt; I tried with Clojure client Welle (internally it uses a PBClusterClient) and
&gt; it didn't work. As soon as I stop a Riak node, the client throws Connection
&gt; Refused exceptions (instead of retrying elsewhere).
&gt; Our Java client library (uses PBClusterClient) has the same problem.
&gt;
&gt; So I realized here that if I restart a node (for maintenance) on my live
&gt; cluster, my app breaks ?!?
&gt;
&gt; I tried googling but there is a lot of contradictory opinions out there :
&gt;
&gt; On the wiki
&gt; https://github.com/basho/riak-java-client/wiki/ClientFactory#wiki-example3
&gt; it says I should use another class of client :
&gt;
&gt; IRiakClient myPbClient = RiakFactory.newClient(myPbClusterConfig);
&gt;
&gt; Will this client retry correctly ? Does this mean the Welle developers used
&gt; the "wrong" client ?
&gt;
&gt;
&gt; This message on the list states that PBClusterClient should work as I expect
&gt; :
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2012-March/007949.html
&gt; but this message states that ClusterClient is not working as expected :
&gt; http://comments.gmane.org/gmane.comp.db.riak.user/8680
&gt;
&gt;
&gt; Can you help me keep my sanity here ? Thank you !
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt; Philippe
&gt;
&gt;
&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; riak-users mailing list
&gt; riak-users@lists.basho.com
&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

