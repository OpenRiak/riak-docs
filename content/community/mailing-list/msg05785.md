---
title: "Re: Multiple keys to fetch in a Java client"
description: ""
project: community
lastmod: 2011-11-29T06:49:42-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05785"
mailinglist_parent_id: "msg05784"
author_name: "suresh chandran"
project_section: "mailinglistitem"
sent_date: 2011-11-29T06:49:42-08:00
---


Hi Russel,

After your mail, I altered the code as

 public static boolean fetchAll(String bucket, Collection keys,
StringBuilder response)
{
Iterator valuesIter = keys.iterator();
try
{
IRiakClient iriakClient = RiakFactory.httpClient("http://127.0.0.1:8091/riak";);
BucketKeyMapReduce reduce = iriakClient.mapReduce();
while (valuesIter.hasNext())
{
String value = valuesIter.next();
reduce.addInput(bucket, value);
}
reduce.addMapPhase(new NamedJSFunction("Riak.mapValuesJson"));
MapReduceResult result =  reduce.execute();
}
...
}

But I get the below exception.
 
com.basho.riak.client.RiakException: java.io.IOException: 
{"lineno":477,"message":"JSON.parse","source":"unknown"}
[INFO]    [11/29/11 9:42 AM] [akka:event-driven:dispatcher:global-9] 
[GetMaster] Error getting data in TEST  // \\*\\*\\*\\*\\*\\* TEST is the bucket name that 
I use.\\*\\*\\*\\*\\*\\*\\*
at com.basho.riak.client.query.MapReduce.execute(MapReduce.java:81)
at com.persistence.RiakConnector.fetchAll(RiakConnector.java:125)// \\*\\*\\*\\*\\*\\*\\* 
line number points to reduce.execute() method \\*\\*\\*\\*\\*\\*\\*\\*\\*

Thanks
Suresh C Nair

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
From: suresh chandran 
To: Russell Brown  
Cc: "riak-users@lists.basho.com"  
Sent: Tuesday, November 29, 2011 9:38 AM
Subject: Re: Multiple keys to fetch in a Java client


Hi Russel,

I am using a static method to get the values, which is like
public static boolean fetchAll(String bucket, Collection keys,
StringBuilder response)
{
PBClientConfig conf = new PBClientConfig.Builder()
        .withHost("127.0.0.1")
         .withPort(8091)
       .build();
try
{

IRiakClient iriakClient = RiakFactory.newClient(conf);
BucketKeyMapReduce reduce = iriakClient.mapReduce();
while (valuesIter.hasNext())
{
String value = valuesIter.next();
reduce.addInput(bucket, value);
}
MapReduceResult result = reduce.execute();
.... // code to send the result to caller 
}....
I am sending only 6 strings in the collection. Whether I pass the name space or 
not, i get the below exception.

java.lang.OutOfMemoryError: Java heap space
at com.basho.riak.pbc.RiakConnection.receive(RiakConnection.java:82)
at 
com.basho.riak.pbc.MapReduceResponseSource.get\\_next\\_response(MapReduceResponseSource.java:86)
at 
com.basho.riak.pbc.MapReduceResponseSource.(MapReduceResponseSource.java:47)
at com.basho.riak.pbc.RiakClient.mapReduce(RiakClient.java:588)
at com.basho.riak.pbc.RiakClient.mapReduce(RiakClient.java:572)
at 
com.basho.riak.client.raw.pbc.PBClientAdapter.mapReduce(PBClientAdapter.java:413)
at com.basho.riak.client.query.MapReduce.execute(MapReduce.java:77)

I am using the Http RiakClient and assumed that is to be used. I shall use the 
IRiakClient here on. the IRiakClient I use is from the 
path basho-riak-java-client-5f8359c/target/riak-client-1.0.2-SNAPSHOT.jar . 
javap shows the versions as 

public interface com.basho.riak.client.IRiakClient
  SourceFile: "IRiakClient.java"
  minor version: 0
  major version: 50

public class com.basho.riak.client.RiakFactory extends java.lang.Object

  SourceFile: "RiakFactory.java"
  minor version: 0
  major version: 50

Let me know if you need anything in specific.

Thanks
Suresh C Nair

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
From: Russell Brown 
To: suresh chandran  
Cc: "riak-users@lists.basho.com"  
Sent: Tuesday, November 29, 2011 8:05 AM
Subject: Re: Multiple keys to fetch in a Java client


Hi Suresh,

On 29 Nov 2011, at 12:10, suresh chandran wrote:

Thanks Russel for the reply .
&gt;
&gt;
&gt;After going through all the APIs I too reached the same opinion. 
&gt;1)Simultaneous multiple fetch and 2)MapReduce. However, simultaneous access 
&gt;would make the fetch very slower and it doesnt look efficient ( since there 
&gt;are threads spawned for each key and fetching say, 10K records might be an 
&gt;over head) let me know if I miss something here and that I shoudl not be 
&gt;concerned. My worry is not the procedure to spawn so many worker threads, but 
&gt;the number of connections they open and close and the performance overhead, 
&gt;thereby
&gt;

Right, 10k is probably too many keys to fetch in parallel. Though you wouldn't 
open and close 10k connections since there is a connection pool, and you can 
set an upper bound on it when you configure your client (more on that below.) 
But you could easily use a producer/consumer set up to fetch many objects in 
parallel. It depends on what you are fetching the data for, how often, and what 
you're going to do with it.


&gt;
&gt;I tried the map reduce in similar way that you mentioned. For weird reasons, 
&gt;it throws Java Heap memory exception and dies.
&gt;MapReduceResult result = client.mapReduce() .addInput("goog","2010-01-04") 
&gt;.addInput("goog","2010-01-05") .addInput("goog","2010-01-06") 
&gt;.addInput("goog","2010-01-07") .addInput("goog","2010-01-08") .addMapPhase(new 
&gt;NamedJSFunction("Riak.mapValuesJson"), true) .execute();
&gt;
&gt;
&gt;I used the same format as above mentioned in 
&gt;https://github.com/basho/riak-java-client page. I tried with and without the 
&gt;addMapPhase method, but in vain. Am I missing something here? Is there a 
&gt;prerequisite to use this code?
&gt;

Curious. The code above is part of the integration test suite, it is run every 
time we build and doesn't usually throw an OOM exception. Did you call 
\\*addInput\\* 10k time in a loop before executing the map/reduce (can I see a 
snippet of code maybe, in a gist or pastebin, ideally)? Can I have a stack 
trace (a gist or pastebin is best for this also, please)? What version of the 
client did you use?


&gt;I also see that the
above methods works only for IRiakClient. Until now I have been using 
RiakClient.

Which one? Which version etc? There are two classes called RiakClient (both 
legacy classes (one PB, one HTTP)), you can use them, but they are likely going 
to deprecated and removed in future versions. I recommend IRiakClient interface.

Only to access these methods. I am using IRiakClient. Does that have any 
significance? way to access/ configure IRiakClient/ Mapreduce. 

Like a lot of Java libraries you configure/acquire a client through a factory. 
There is an example in the README on the repo home page 
(https://github.com/basho/riak-java-client) under the heading \\*Configuration\\*, 
it is lower down that page. Maybe the README needs re-organising a bit.

This is the only place I need the map reduce, 
&gt;and throughout my code, i just store and fetch key values.  

&gt;
&gt;I dont seem to get the answers in the forums or documents. If there are 
&gt;any,can you please point? Thanks again.

The README, the integration tests, and this mailing list are the current best 
sources of help. I would like to spend some time writing some more detailed 
documentation and tutorials (ha, actually, \\_no\\_, I wouldn't, but I really 
\\*should\\*!)

Hopefully that helps, and if you get me that stack trace I'll try and figure 
out what is going on with the map/reduce error.

Cheers

Russell


&gt;
&gt;Suresh C Nair  
&gt;
&gt;
&gt;
&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; From: Russell Brown 
&gt;To: suresh chandran  
&gt;Cc: "riak-users@lists.basho.com"  
&gt;Sent: Monday, November 28, 2011 7:14 PM
&gt;Subject: Re: Multiple keys to fetch in a Java client
&gt; 
&gt;
&gt;
&gt;
&gt;On 28 Nov 2011, at 20:16, suresh chandran wrote:
&gt;
&gt;May be I can make my statement clear :) I store my devices values in buckets 
&gt;named after OS (say windows/ linux) with the device id's as keys. I want to 
&gt;get  the devices  for a list of device ids . From what I see, the fetch API 
&gt;signature takes in bucket name and key. (Client.fetch("windows", "D1"). Is 
&gt;there a way where I can get Client.fetch("windows", ?
&gt;&gt;
&gt;
&gt;
&gt;There is no multi-fetch from Riak right now. You can either fetch your 
&gt;individual keys (serially on in parallel) or run a Map/Reduce. In most case 
&gt;the Map/Reduce will be slower (though the API is simpler, I suppose.)
&gt;
&gt;
&gt;Use IRiakClient.mapReduce().addInput(bucket, key).addInput(bucket, 
&gt;key2)…(repeat!) I guess this is ripe for a convenience method that takes (as 
&gt;you suggest) addInputs(bucket, Collection keys), so I'll add that to 
&gt;the features list.
&gt;
&gt;
&gt;Or just fetch all your keys using fetch. 
&gt;
&gt;
&gt;I guess it would be possible to add a bulk fetch API to the Riak Java Client 
&gt;that spawns a configurable number of threads to fetch a bunch of keys in 
&gt;parallel, but right now that is left as an exercise for the reader :)
&gt;
&gt;
&gt;Cheers
&gt;
&gt;
&gt;Russell
&gt;
&gt;
&gt;
&gt;
&gt;&gt;Thanks
&gt;&gt;Suresh C Nair
&gt;&gt;
&gt;&gt;
&gt;&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; From: suresh chandran 
&gt;&gt;To: "riak-users@lists.basho.com"  
&gt;&gt;Sent: Monday, November 28, 2011 2:53 PM
&gt;&gt;Subject: Multiple keys to fetch in a Java client
&gt;&gt; 
&gt;&gt;
&gt;&gt;HI,
&gt;&gt;
&gt;&gt;
&gt;&gt;I am storing values of a devices under a particular OS. I want to fetch the 
&gt;&gt;list of all vallues, based on the key list. What I see if that, I can fetch 
&gt;&gt;the value one by one using the FETCH. Am using the HttpClient in Java. How do 
&gt;&gt;I go about this? Assume I am tryign to reach the same behavior like query 
&gt;&gt;that has "CONTAINS(key1, key2...). Is there a way to do this? or we can fetch 
&gt;&gt;the values only one by one. I do see that Map-reduce, makes use of the list 
&gt;&gt;fo keys, but am not sure if it is applicable in my case, as it ia simple 
&gt;&gt;fetch with collection of / list of keys.
&gt;&gt;
&gt;&gt;
&gt;&gt;Thanks
&gt;&gt;Suresh C Nair
&gt;&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;riak-users mailing list
&gt;&gt;riak-users@lists.basho.com
&gt;&gt;http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt;\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;riak-users mailing list
&gt;&gt;riak-users@lists.basho.com
&gt;&gt;http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;
