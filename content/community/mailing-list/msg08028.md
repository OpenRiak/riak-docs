---
title: "Unable to force remove a node that got stuck while leaving the cluster"
description: ""
project: community
lastmod: 2012-07-23T03:09:26-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08028"
author_name: "Erik Hoogeveen"
project_section: "mailinglistitem"
sent_date: 2012-07-23T03:09:26-07:00
---


Since about a week we run a 16 node Riak cluster. We use Riak 1.1.2 with 
Bitcask 1.5.1 as storage backend. We run this on Debian 6.0.5 Linux 
2.6.38-bpo.2-amd64 and Erland R14B04. 

When we started using this setup we hit the jackpot right away. The disk in one 
of the nodes started causing problems quite soon. So we told that machine to 
leave the riak cluster.

Unfortunately the handoff had still not completed 12 hours later. In the logs 
we saw:

2012-07-13 00:05:34.526 [info] 
&lt;0.29522.7&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:83 Starting handoff of 
partition riak\\_kv\\_vnode 348248437020254210978221776545676813277390176256 from 
'riak@10.53.1.20' to 'riak@10.53.1.15'
2012-07-13 00:06:11.272 [error] 
&lt;0.29522.7&gt;@riak\\_core\\_handoff\\_sender:start\\_fold:119 Handoff of partition 
riak\\_kv\\_vnode 348248437020254210978221776545676813277390176256 from 
'riak@10.53.1.20' to 'riak@10.53.1.15' failed because &lt;0.29523.7&gt; died with 
reason 
{{badmatch,{error,{bad\\_crc,&lt;&lt;&gt;&gt;,435787301}}},[{riak\\_core\\_handoff\\_sender,'-start\\_fold/5-fun-1-',9}]}
2012-07-13 00:06:11.272 [error] emulator Error in process &lt;0.29523.7&gt; on node 
'riak@10.53.1.20' with exit value: {{badmatch,{error,{bad\\_crc,&lt;&lt;0 
bytes&gt;&gt;,435787301}}},[{riak\\_core\\_handoff\\_sender,'-start\\_fold/5-fun-1-',9}]}

Over and over and over again. This is understandable since the disk had a bad 
sector. But once stuck in this situation it's quite hard to get Riak unstuck..

We tried to stop the broken node, it wouldn't want to stop nicely so we killed 
it with brute force.
Then we tried to run "riak-admin force-remove" from one of the other nodes to 
let everybody else know the broken node wouldn't be coming back anytime soon.

Unfortunately it just told us:

Failed: "riak10" is not a member of the cluster.

And the cluster status showed that the broken node was still in state leaving.

Eventually the only way we got it to leave completely was by wiping all the 
data on the broken node, letting it rejoin and then issue a force-remove, which 
was only possible after it had received all it's data again.
I would say that the force-remove should remove a node from the cluster 
regardless the state it's in and it would have far less impact on the other 
nodes than to go through the whole rejoin process first.

Anyhow we're back in business. But I thought maybe this can be improved so I 
thought it would be good to let you know.

Kind regards,
Erik Hoogeveen




\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

