---
title: "Re: atomically updating multiple keys"
description: ""
project: community
lastmod: 2011-10-31T13:57:29-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05396"
mailinglist_parent_id: "msg05393"
author_name: "Justin Karneges"
project_section: "mailinglistitem"
sent_date: 2011-10-31T13:57:29-07:00
---


Oh, I didn't realize Riak had any client tracking. Does that work with the 
HTTP interface too?

If N=3, R=2, W=2, and client A writes something, how would client B not 
immediately see the latest data? A won't get an acknowledgement until two 
nodes are written to, and B would end up reading from at least one of those 
nodes.

On Monday, October 31, 2011 01:39:02 PM Sean Cribbs wrote:
&gt; No, (P)R+(P)W &gt; N guarantees that you read from an overlapping set of what
&gt; you just wrote \\*from the same client\\*. It does not guarantee any kind of
&gt; immediate consistency. However, what Riak \\*does\\* provide is some capacity
&gt; for your data to approach consistency over time, through vector clocks,
&gt; read-repair and hinted handoff.
&gt; 
&gt; On Mon, Oct 31, 2011 at 4:20 PM, Justin Karneges  wrote:
&gt; &gt; As I understand it, if R + W &gt; N then the DB is immediately consistent
&gt; &gt; rather
&gt; &gt; than eventually consistent, correct? Do the allow\\_mult and
&gt; &gt; last\\_write\\_wins settings have any effect when R + W &gt; N?
&gt; &gt; 
&gt; &gt; On Saturday, October 29, 2011 11:18:10 AM Reid Draper wrote:
&gt; &gt; &gt; It sounds like your specific needs \\_might\\_ be possible with application
&gt; &gt; &gt; logic, but be aware that Riak is an eventually consistent database.
&gt; &gt; &gt; There are many subtleties to this type of coordination. You will need
&gt; &gt; &gt; read-your-writes consistency, which means R + W &gt; N. I would recommend
&gt; &gt; 
&gt; &gt; the
&gt; &gt; 
&gt; &gt; &gt; following resources:
&gt; &gt; &gt; 
&gt; &gt; &gt; http://wiki.basho.com/Eventual-Consistency.html
&gt; &gt; &gt; http://www.allthingsdistributed.com/2008/12/eventually\\_consistent.html
&gt; &gt; &gt; 
&gt; &gt; &gt; Terminology-wise, you should also know that there is no way to
&gt; &gt; &gt; atomically update more than one replica (much less multiple keys) in
&gt; &gt; &gt; Riak. This is
&gt; &gt; 
&gt; &gt; one
&gt; &gt; 
&gt; &gt; &gt; of the tradeoffs for high availability in a distributed system.
&gt; &gt; &gt; 
&gt; &gt; &gt; On Sat, Oct 29, 2011 at 1:46 PM, Jeremiah Peschka &lt;
&gt; &gt; &gt; 
&gt; &gt; &gt; jeremiah.pesc...@gmail.com&gt; wrote:
&gt; &gt; &gt; &gt; I'm just assuming that my implementation might be naive.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; As far as the tedious label goes, as your application's functionality
&gt; &gt; &gt; &gt; grows in complexity, you may find it tedious to manage the complexity
&gt; &gt; 
&gt; &gt; of
&gt; &gt; 
&gt; &gt; &gt; &gt; manually handling transactional rollback in a distributed system.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Managing relationships using links has some maintenance overhead in
&gt; &gt; 
&gt; &gt; Riak
&gt; &gt; 
&gt; &gt; &gt; &gt; because of the nature of handling this sort of situation.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; But, all in all, it's probably not terrible as long as you decrease
&gt; &gt; &gt; &gt; the number of relationships in the application by saving related
&gt; &gt; &gt; &gt; objects within the same collection.
&gt; &gt; &gt; &gt; ---
&gt; &gt; &gt; &gt; Jeremiah Peschka - Founder, Brent Ozar PLF, LLC
&gt; &gt; &gt; &gt; Microsoft SQL Server MVP
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Oct 29, 2011, at 10:32 AM, Justin Karneges wrote:
&gt; &gt; &gt; &gt; &gt; On Saturday, October 29, 2011 08:42:52 AM Jeremiah Peschka wrote:
&gt; &gt; &gt; &gt; &gt;&gt; 1) Use an RDBMS. Since you're here, I'm guessing that you're
&gt; &gt; &gt; &gt; &gt;&gt; already
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; using
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;&gt; Riak or else that Riak has qualities that you want for your
&gt; &gt; &gt; &gt; &gt;&gt; application.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Right. This is early on in the app's lifetime and the data storage
&gt; &gt; 
&gt; &gt; is
&gt; &gt; 
&gt; &gt; &gt; &gt; not
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; terribly complicated. I just need some parent/child relationships
&gt; &gt; 
&gt; &gt; and
&gt; &gt; 
&gt; &gt; &gt; &gt; when I
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; saw the Links feature I figured this was an expected usage of Riak.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;&gt; 2) As Alex suggests, you can implement this in your application.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Yes, this I am ready for. As I understand it, using Riak
&gt; &gt; 
&gt; &gt; successfully
&gt; &gt; 
&gt; &gt; &gt; &gt; &gt; generally means designing your application with its limitations in
&gt; &gt; &gt; &gt; &gt; mind.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; So,
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; let's go write some funky app code!
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;&gt; This could also be difficult: the application must be aware of
&gt; &gt; &gt; &gt; &gt;&gt; activity
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; going
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;&gt; on with objects in your database AND be able to roll them back. In
&gt; &gt; &gt; &gt; &gt;&gt; pseudocode you'd do this:
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; orig = Riak.get('whatevs')
&gt; &gt; &gt; &gt; &gt;&gt; child = new Child(orig)
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; if Riak.put(child)
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; if !Riak.link(orig, child)
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; Riak.delete(child)
&gt; &gt; &gt; &gt; &gt;&gt; // error up the stack
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; else
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; // we don't care, the child didn't save. error up the stack
&gt; &gt; &gt; &gt; &gt;&gt; 
&gt; &gt; &gt; &gt; &gt;&gt; This is probably naive and is definitely tedious, even if you do
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; implement
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;&gt; your own application layer to handle read/write operations.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; See, to me, this looks exactly like what you're supposed to do. 
&gt; &gt; &gt; &gt; &gt; How
&gt; &gt; 
&gt; &gt; is
&gt; &gt; 
&gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; naive and tedious? I would assume that everyone writing a serious
&gt; &gt; 
&gt; &gt; app
&gt; &gt; 
&gt; &gt; &gt; &gt; with
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Riak has to do things like this.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Justin
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; &gt; &gt; riak-users mailing list
&gt; &gt; &gt; &gt; riak-users@lists.basho.com
&gt; &gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; &gt; 
&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt; &gt; riak-users mailing list
&gt; &gt; riak-users@lists.basho.com
&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

