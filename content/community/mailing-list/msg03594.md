---
title: "Re: Correct way to use pbc/mapreduce to do multiget where keys and	bucket names are binary values?"
description: ""
project: community
lastmod: 2011-06-07T07:58:49-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03594"
mailinglist_parent_id: "msg03556"
author_name: "Russell Brown"
project_section: "mailinglistitem"
sent_date: 2011-06-07T07:58:49-07:00
---

On 7 Jun 2011, at 15:29, Jacques wrote:

&gt; Have you had any success with reading the server response?

Yes. Sorry I didn't post a reply. 

It was trivial (but fraught, see below), I just used the OtpInputStream to 
deserialize the byte array returned from pbc.MapReduceResponse.

Like:

 ByteString bs = resp.getContent();
 OtpInputStream is = new OtpInputStream(bs.toByteArray());
 OtpErlangObject result = is.read\\_any();
 // and then all sorts of looping, sniffing types, unpacking etc
 

Caveats: 

You have a pain unpacking any reasonably complex result.
The ETF specification drops this doozy about "strings": 
http://www.erlang.org/doc/apps/erts/erl\\_ext\\_dist.html#id85596. My first test 
actually returned a list of [0,1,2,3...200] and Jinterface helpfully turned 
that into a string for me.

That aside it is certainly feasible to use Jinterface to serialize/deserialize 
Map/Reduce jobs/results.

Cheers

Russell

&gt; 
&gt; Thanks,
&gt; Jacques
&gt; 
&gt; On Sat, Jun 4, 2011 at 1:19 PM, Russell Brown  wrote:
&gt; 
&gt; On 4 Jun 2011, at 18:22, Jacques wrote:
&gt; 
&gt;&gt; I like the sound of option 3 also. I'll have a look at it this weekend and 
&gt;&gt; get back to you.
&gt;&gt; 
&gt;&gt; Awesome! Thanks. If you can give me a point in the right direction 
&gt;&gt; regarding the correct typing approach and what not, I'm up for giving it a 
&gt;&gt; shot as well.
&gt; 
&gt; Ok, I have a half working hack. It isn't pretty 'cos the Jinterface API is 
&gt; verbose. I've hacked the pbc.MapReduceBuilder to encode the job as 
&gt; "application/x-erlang-binary" and submit that, but really this code should be 
&gt; in a separate class, maybe using the output from MapReduceBuilder.getJSON() 
&gt; as input. That way you can get the feature without patching the client.
&gt; 
&gt; What I haven't done is decode the response from Riak yet. If you want a 
&gt; pointer here is a gist of the (unclean) hack. It could use a lot of work, but 
&gt; it proves the concept:
&gt; 
&gt; https://gist.github.com/1008293
&gt; 
&gt; The gist is just the diff so you can apply it as a patch to 
&gt; src/main/java/com/basho/riak/pbc/mapreduce/MapReduceBuilder.java if you want 
&gt; to play with it. 
&gt; 
&gt; You'll have to add Jinterface to your pom too.
&gt; 
&gt; 
&gt; 
&gt; org.erlang.otp
&gt; jinterface
&gt; 1.5.4
&gt; 
&gt; 
&gt; I think it is best to put the result decoding outside the library too. I'm 
&gt; going to hack up a poc for that now, but I thought I'd post what I have thus 
&gt; far.
&gt; 
&gt; Cheers
&gt; 
&gt; Russell
&gt; 
&gt;&gt; 
&gt;&gt; Thanks again,
&gt;&gt; Jacques
&gt; 

