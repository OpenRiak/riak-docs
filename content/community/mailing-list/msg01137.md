---
title: "Re: [PATCH] Adapt to R14 changes with compat macros"
description: ""
project: community
lastmod: 2010-09-24T10:23:39-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01137"
mailinglist_parent_id: "msg01122"
author_name: "David Smith"
project_section: "mailinglistitem"
sent_date: 2010-09-24T10:23:39-07:00
---


Thanks, Tuncer. I've applied this to skerl.

D.

On Fri, Sep 24, 2010 at 2:55 AM, Tuncer Ayaz  wrote:
&gt; # HG changeset patch
&gt; # User Tuncer Ayaz 
&gt; # Date 1285318146 -7200
&gt; # Node ID 2a512594f4eb50d69aaf9443ec58d68480d62544
&gt; # Parent  2cbd7361b5c946d6b5bb2ab0be4cbc28d7867f2a
&gt; Adapt to R14 changes with compat macros
&gt;
&gt; Pull in erl\\_nif\\_compat.h as found in ebloom.
&gt;
&gt; diff -r 2cbd7361b5c9 -r 2a512594f4eb c\\_src/erl\\_nif\\_compat.h
&gt; --- /dev/null   Thu Jan 01 00:00:00 1970 +0000
&gt; +++ b/c\\_src/erl\\_nif\\_compat.h    Fri Sep 24 10:49:06 2010 +0200
&gt; @@ -0,0 +1,48 @@
&gt; +#ifndef ERL\\_NIF\\_COMPAT\\_H\\_
&gt; +#define ERL\\_NIF\\_COMPAT\\_H\\_
&gt; +
&gt; +#ifdef \\_\\_cplusplus
&gt; +extern "C" {
&gt; +#endif /\\* \\_\\_cplusplus \\*/
&gt; +
&gt; +#include "erl\\_nif.h"
&gt; +
&gt; +#if ERL\\_NIF\\_MAJOR\\_VERSION == 1 && ERL\\_NIF\\_MINOR\\_VERSION == 0
&gt; +
&gt; +#define enif\\_open\\_resource\\_type\\_compat enif\\_open\\_resource\\_type
&gt; +#define enif\\_alloc\\_resource\\_compat enif\\_alloc\\_resource
&gt; +#define enif\\_release\\_resource\\_compat enif\\_release\\_resource
&gt; +#define enif\\_alloc\\_binary\\_compat enif\\_alloc\\_binary
&gt; +#define enif\\_alloc\\_compat enif\\_alloc
&gt; +#define enif\\_free\\_compat enif\\_free
&gt; +#endif /\\* R13B04 \\*/
&gt; +
&gt; +#if ERL\\_NIF\\_MAJOR\\_VERSION == 2 && ERL\\_NIF\\_MINOR\\_VERSION == 0
&gt; +
&gt; +#define enif\\_open\\_resource\\_type\\_compat(E, N, D, F, T) \\
&gt; +    enif\\_open\\_resource\\_type(E, NULL, N, D, F, T)
&gt; +
&gt; +#define enif\\_alloc\\_resource\\_compat(E, T, S) \\
&gt; +    enif\\_alloc\\_resource(T, S)
&gt; +
&gt; +#define enif\\_release\\_resource\\_compat(E, H) \\
&gt; +    enif\\_release\\_resource(H)
&gt; +
&gt; +#define enif\\_alloc\\_binary\\_compat(E, S, B) \\
&gt; +    enif\\_alloc\\_binary(S, B)
&gt; +
&gt; +#define enif\\_alloc\\_compat(E, S) \\
&gt; +    enif\\_alloc(S)
&gt; +
&gt; +#define enif\\_free\\_compat(E, P) \\
&gt; +    enif\\_free(P)
&gt; +
&gt; +#endif /\\* R14 \\*/
&gt; +
&gt; +
&gt; +
&gt; +#ifdef \\_\\_cplusplus
&gt; +}
&gt; +#endif /\\* \\_\\_cplusplus \\*/
&gt; +
&gt; +#endif /\\* ERL\\_NIF\\_COMPAT\\_H\\_ \\*/
&gt; diff -r 2cbd7361b5c9 -r 2a512594f4eb c\\_src/skerl\\_nifs.c
&gt; --- a/c\\_src/skerl\\_nifs.c        Tue Sep 21 15:46:20 2010 -0700
&gt; +++ b/c\\_src/skerl\\_nifs.c        Fri Sep 24 10:49:06 2010 +0200
&gt; @@ -1,5 +1,6 @@
&gt;
&gt;  #include "erl\\_nif.h"
&gt; +#include "erl\\_nif\\_compat.h"
&gt;  #include "skein\\_api.h"
&gt;  #include 
&gt;
&gt; @@ -31,7 +32,7 @@
&gt;
&gt;  int load(ErlNifEnv\\* env, void \\*\\* priv\\_data, ERL\\_NIF\\_TERM load\\_info)
&gt;  {
&gt; -  skein\\_hashstate = enif\\_open\\_resource\\_type(env, "hashstate", NULL, 
&gt; ERL\\_NIF\\_RT\\_CREATE, NULL);
&gt; +  skein\\_hashstate = enif\\_open\\_resource\\_type\\_compat(env, "hashstate", NULL, 
&gt; ERL\\_NIF\\_RT\\_CREATE, NULL);
&gt;   return 0;
&gt;  }
&gt;
&gt; @@ -42,14 +43,14 @@
&gt;     if(!enif\\_get\\_int(env, argv[0], &bits))
&gt;         return enif\\_make\\_badarg(env);
&gt;
&gt; -    hashState \\*state = (hashState\\*) enif\\_alloc\\_resource(env, 
&gt; skein\\_hashstate, sizeof(hashState));
&gt; +    hashState \\*state = (hashState\\*) enif\\_alloc\\_resource\\_compat(env, 
&gt; skein\\_hashstate, sizeof(hashState));
&gt;     HashReturn r = Init(state, bits);
&gt;     if (r == SUCCESS) {
&gt;         hash\\_state\\_term = enif\\_make\\_resource(env, state);
&gt; -        enif\\_release\\_resource(env, state);
&gt; +        enif\\_release\\_resource\\_compat(env, state);
&gt;         return enif\\_make\\_tuple2(env, enif\\_make\\_atom(env, "ok"), 
&gt; hash\\_state\\_term);
&gt;     } else {
&gt; -        enif\\_release\\_resource(env, state);
&gt; +        enif\\_release\\_resource\\_compat(env, state);
&gt;         return enif\\_make\\_tuple2(env, enif\\_make\\_atom(env, "error"), 
&gt; enif\\_make\\_atom(env, "fail"));
&gt;     }
&gt;  }
&gt; @@ -75,7 +76,7 @@
&gt;     enif\\_get\\_resource(env, argv[0], skein\\_hashstate, (void\\*\\*)&state);
&gt;
&gt;     ErlNifBinary out;
&gt; -    enif\\_alloc\\_binary(env, (size\\_t)(state-&gt;statebits/8), &out);
&gt; +    enif\\_alloc\\_binary\\_compat(env, (size\\_t)(state-&gt;statebits/8), &out);
&gt;
&gt;     HashReturn r = Final(state, (BitSequence \\*)out.data);
&gt;     if (r == SUCCESS) {
&gt; @@ -92,7 +93,7 @@
&gt;
&gt;     ErlNifBinary bin, out;
&gt;     enif\\_inspect\\_binary(env, argv[1], &bin);
&gt; -    enif\\_alloc\\_binary(env, (size\\_t)(bits/8), &out);
&gt; +    enif\\_alloc\\_binary\\_compat(env, (size\\_t)(bits/8), &out);
&gt;
&gt;     HashReturn r = Hash(bits, (BitSequence \\*)(bin.data), bin.size \\* 8, 
&gt; (BitSequence \\*)out.data);
&gt;     if (r == SUCCESS) {
&gt;
