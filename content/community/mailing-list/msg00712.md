---
title: "Re: Bitcask & Innostore Benchmark @ EC2"
description: ""
project: community
lastmod: 2010-07-12T06:03:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00712"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2010-07-12T06:03:16-07:00
---


James,

One thing you might try is lowering the concurrency rate. "max" mode at even 
5-10 workers is enough to saturate most networks (the most I've ever run has 
been 15). Whether that is an accurate representation of your production load 
is another story entirely, and an "exercise for the reader".

Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://basho.com/

On Jul 11, 2010, at 11:52 PM, James Sadler wrote:

&gt; Hi All,
&gt; 
&gt; I've been benchmarking Riak using basho\\_bench on an EC2 m1.large
&gt; instance and also running locally on my iMac inside VirtualBox to
&gt; assess performance of the Bitcask and Innostore backends
&gt; 
&gt; The test configuration looks like this:
&gt; 
&gt; {mode, max}.
&gt; {duration, 10}.
&gt; {concurrent, 50}.
&gt; {driver, basho\\_bench\\_driver\\_http\\_raw}.
&gt; {code\\_paths, ["deps/stats",
&gt; "deps/ibrowse"]}.
&gt; %% a composite key composed of 4 IDs, each of which is a 16 char hex string,
&gt; %% specific to our data model.
&gt; {key\\_generator, {random\\_dynamo\\_style\\_string, 35000}}.
&gt; {value\\_generator, {fixed\\_bin, 1000}}.
&gt; {operations, [{get, 1}, {update, 2}]}.
&gt; {http\\_raw\\_ips, ["127.0.0.1"]}.
&gt; 
&gt; Also, to generate the 'random\\_dynamo\\_style\\_string', I made the
&gt; following changes to the bash\\_bench source:
&gt; 
&gt; diff --git a/src/basho\\_bench\\_keygen.erl b/src/basho\\_bench\\_keygen.erl
&gt; index 4849bbe..639e90b 100644
&gt; --- a/src/basho\\_bench\\_keygen.erl
&gt; +++ b/src/basho\\_bench\\_keygen.erl
&gt; @@ -54,6 +54,13 @@ new({pareto\\_int, MaxKey}, \\_Id) -&gt;
&gt; new({pareto\\_int\\_bin, MaxKey}, \\_Id) -&gt;
&gt; Pareto = pareto(trunc(MaxKey \\* 0.2), ?PARETO\\_SHAPE),
&gt; fun() -&gt; &lt;&lt;(Pareto()):32/native&gt;&gt; end;
&gt; +new({random\\_dynamo\\_style\\_string, MaxKey}, \\_Id) -&gt;
&gt; + fun() -&gt; lists:concat([
&gt; + get\\_random\\_string(16, "0123456789abcdef"), "-",
&gt; + get\\_random\\_string(16, "0123456789abcdef"), "-",
&gt; + get\\_random\\_string(16, "0123456789abcdef"), "-",
&gt; + get\\_random\\_string(16, "0123456789abcdef")])
&gt; + end;
&gt; new(Other, \\_Id) -&gt;
&gt; ?FAIL\\_MSG("Unsupported key generator requested: ~p\\n", [Other]).
&gt; 
&gt; @@ -74,10 +81,17 @@ dimension({pareto\\_int, \\_}) -&gt;
&gt; 0.0;
&gt; dimension({pareto\\_int\\_bin, \\_}) -&gt;
&gt; 0.0;
&gt; +dimension({random\\_dynamo\\_style\\_string, MaxKey}) -&gt;
&gt; + 0.0;
&gt; dimension(Other) -&gt;
&gt; ?FAIL\\_MSG("Unsupported key generator dimension requested: ~p\\n", [Other]).
&gt; 
&gt; -
&gt; +get\\_random\\_string(Length, AllowedChars) -&gt;
&gt; + lists:foldl(fun(\\_, Acc) -&gt;
&gt; + [lists:nth(random:uniform(length(AllowedChars)),
&gt; + AllowedChars)]
&gt; + ++ Acc
&gt; + end, [], lists:seq(1, Length)).
&gt; 
&gt; 
&gt; %% ====================================================================
&gt; 
&gt; 
&gt; As of now, I've only been running the benchmark with a 'cluster' of
&gt; one single Riak node, and I have benchmarked with bitcask and
&gt; innostore backends on the latest version of Riak (0.11.0-1344) and
&gt; innostore (1.0.0-88) on Ubuntu Lucid. I have also been running the
&gt; basho\\_bench on the same host as the Riak node.
&gt; 
&gt; The benchmarks are showing very high get and update latencies in the
&gt; 95th percentile and beyond when using Innostore as the backend.
&gt; Bitcask performance is much better.
&gt; 
&gt; While running the benchmarks, I had an iostat process reporting IO
&gt; every 1 second. It clearly showed heavy writes during the benchmark,
&gt; but practically zero reads. I expect that this was because of the
&gt; disk cache. What I found very surprising was that the latencies for
&gt; innostore gets during the benchmark were very high, even though the
&gt; disk was not being hit for reads at all. This was reproducible on
&gt; both EC2 and on a local VM on my iMac.
&gt; 
&gt; Observations:
&gt; 
&gt; ## Innostore backend
&gt; 
&gt; - Latencies for innostore are high across the board. Even for reads,
&gt; \\_\\_when iostat is reporting that no reads are hitting the disk\\_\\_.
&gt; 
&gt; - 95th percentile read/write latencies are up to 1500/2000 millis.
&gt; 
&gt; - 99th percentile reads/writes are up to 2000/4000 millis.
&gt; 
&gt; - The difference between update and get latency is small.
&gt; 
&gt; - There are some failed (timeouts) updates/gets in log file produced
&gt; by basho\\_bench
&gt; 
&gt; - Throughput with innostore backend is 150-200 req/sec
&gt; 
&gt; - Mounting the filesystem with noatime doesn't seem to make much of a
&gt; difference.
&gt; 
&gt; - Getting values from disk cache has huge latency (iostat reporting no
&gt; reads on the device). This is somewhat bizarre.
&gt; 
&gt; ## Bitcask backend
&gt; 
&gt; - There are zero errors in the log produced by bash\\_bench (no timeouts
&gt; like with innostore)
&gt; 
&gt; - Throughput is much higher: 620 req/sec
&gt; 
&gt; - The 99.9th percentile latencies are 200ms for writes, and for reads 100ms
&gt; 
&gt; - The 95th percentile latencies are 160ms for writes and 60ms for reads
&gt; 
&gt; - Mean & median latencies are 115ms for writes and 20ms for reads.
&gt; 
&gt; Summary charts from basho\\_bench are attached.
&gt; 
&gt; 
&gt; NOTE:
&gt; 
&gt; I haven't included benchmark results from my own local VM. FWIW, I
&gt; observed the approximately same characteristics in the EC2 and local
&gt; benchmarks.
&gt; 
&gt; In summary, it looks like there are significant performance issues
&gt; with Innostore in terms of throughput and latency. Latency is the
&gt; biggest issue for our ad serving product at Lexer, so it looks like
&gt; we'll be using Bitcask in production.
&gt; 
&gt; Hopefully these results will be useful to others.
&gt; 
&gt; Also, given our large key size of 67 characters, combined with the
&gt; Bitcask's padding and storage layout, how many keys should we be able
&gt; to manager per node per GB?
&gt; 
&gt; Looking forward to any comments.
&gt; 
&gt; Thanks.
&gt; 
&gt; -- 
&gt; James
