---
title: "Re: Upgrading 0.14.2 cluster to 1.2"
description: ""
project: community
lastmod: 2012-08-13T03:24:39-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08275"
mailinglist_parent_id: "msg08238"
author_name: "Sebastian Cohnen"
project_section: "mailinglistitem"
sent_date: 2012-08-13T03:24:39-07:00
---


Hey Joe,

the upgrade itself appears to be fine on stage. But I think I might have an 
issue with the capability negotiation.

Server A thinks, that Server B is a legacy node. Server B thinks the same of 
Server A.

On Server A (running riak-admin member\\_status):

(legacy) 50.0% -- 'riak@SERVER\\_B'
valid 50.0% -- 'riak@SERVER\\_A'

and on Server B:

valid 50.0% -- 'riak@SERVER\\_B'
(legacy) 50.0% -- 'riak@SERVER\\_A'


riak-admin transfers does not work properly too. Each node thinks that the 
other node is down.

riak-admin ring\\_status just prints a: "Currently in legacy gossip mode."


Restarting the nodes did not have an effect. Any ideas?


Best

Sebastian


On 09.08.2012, at 23:14, Sebastian Cohnen  wrote:

&gt; Hey Joe,
&gt; 
&gt; thanks for your detailed description of the problem.
&gt; 
&gt; I already assumed that this is not necessarily an indicator for problems. I 
&gt; just wanted to make sure I'm not missing anything important. ring\\_status just 
&gt; tells me "Currently in legacy gossip mode.", but member\\_status looks very 
&gt; informative.
&gt; 
&gt; It's getting a bit too late (I'm on CEST) to continue to work on the 
&gt; migration testing, but I'll continue tomorrow.
&gt; 
&gt; 
&gt; Thanks again for your help!
&gt; 
&gt; Sebastian
&gt; 
&gt; On 09.08.2012, at 22:47, Joseph Blomstedt  wrote:
&gt; 
&gt;&gt; Yes, this makes sense unfortunately. 'riak-admin transfers' isn't
&gt;&gt; going to work for you in a mixed 0.14.2 and 1.2 cluster.
&gt;&gt; 
&gt;&gt; Between 0.14.2 and 1.0, the entire cluster system was revamped. One
&gt;&gt; consequence of this change was that 'riak-admin transfers' would only
&gt;&gt; work on the 1.0+ nodes in the cluster, not any of the 0.14.2 nodes. At
&gt;&gt; the time, this wasn't a major issue because you could just use the
&gt;&gt; command on the right nodes and get the information you needed until
&gt;&gt; all nodes were eventually upgraded.
&gt;&gt; 
&gt;&gt; For Riak 1.2, 'riak-admin transfers' has been changed again. This
&gt;&gt; time, in a mixed cluster 'riak-admin transfers' only works on the
&gt;&gt; older nodes, not the Riak 1.2 nodes. For example, in a mixed 1.1 and
&gt;&gt; 1.2 cluster, you can only use riak-admin transfers on the 1.1 nodes
&gt;&gt; until all have been upgraded.
&gt;&gt; 
&gt;&gt; Unfortunately, the combination doesn't work out well for you in this
&gt;&gt; case. Riak 0.14.2 transfers fails if there are any 1.0+ nodes in the
&gt;&gt; cluster, and Riak 1.2 transfers fails if there are any &lt;1.2 nodes in
&gt;&gt; the cluster. Both are true, and therefore neither versions of Riak
&gt;&gt; can properly give you transfer information.
&gt;&gt; 
&gt;&gt; Of course, the lack of being able to monitor transfers doesn't mean
&gt;&gt; things aren't actually working. Running 'riak-admin member\\_status' and
&gt;&gt; 'riak-admin ring\\_status' on the newer nodes should provide enough
&gt;&gt; detail about what's going on to see if your cluster is moving along.
&gt;&gt; 
&gt;&gt; Regards,
&gt;&gt; Joe
&gt;&gt; 
&gt;&gt; 
&gt;&gt; On Thu, Aug 9, 2012 at 1:25 PM, Sebastian Cohnen
&gt;&gt;  wrote:
&gt;&gt;&gt; I forgot to mention, that I also ran 
&gt;&gt;&gt; "riak\\_core\\_node\\_watcher:service\\_up(riak\\_pipe, self())." on the 0.14.2 node 
&gt;&gt;&gt; (got that from here: http://wiki.basho.com/Rolling-Upgrades.html)
&gt;&gt;&gt; 
&gt;&gt;&gt; On 09.08.2012, at 22:16, Sebastian Cohnen  
&gt;&gt;&gt; wrote:
&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Hey all,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; looks like I'm already stuck :-/
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I'm trying to test the upgrade on a stage cluster (with 2 nodes). What I 
&gt;&gt;&gt;&gt; did so far:
&gt;&gt;&gt;&gt; \\* downloaded 1.2
&gt;&gt;&gt;&gt; \\* stopped riak
&gt;&gt;&gt;&gt; \\* backup /var/lib/riak/ring and /etc/riak
&gt;&gt;&gt;&gt; \\* installed 1.2
&gt;&gt;&gt;&gt; \\* changed app.config and vm.args (just node name, ring creation size, 
&gt;&gt;&gt;&gt; config for our multi-backends)
&gt;&gt;&gt;&gt; \\* started riak again
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; riak-admin status looked fine, ring membership is fine, both nodes answer 
&gt;&gt;&gt;&gt; requests. As hinted by Jon, I attached to riak console and run 
&gt;&gt;&gt;&gt; riak\\_core\\_capability:all(). As far as I can tell, everything looks okay 
&gt;&gt;&gt;&gt; here too.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; What is not working is: riak-admin transfers. It is not working on both 
&gt;&gt;&gt;&gt; nodes. For the state situation this is not a big deal, for production this 
&gt;&gt;&gt;&gt; would be a potential problem.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I've pasted the output of "riak\\_core\\_capability:all()." and command output 
&gt;&gt;&gt;&gt; of riak-admin transfers here: https://gist.github.com/3307714
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Is there anything I can do about that?
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Best
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Sebastian
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; PS: What's interesting is that I think that I saw a similar behavior while 
&gt;&gt;&gt;&gt; trying to upgrade to 1.1.4 a few days ago. I have to double check that 
&gt;&gt;&gt;&gt; though.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On 09.08.2012, at 14:08, Sebastian Cohnen  
&gt;&gt;&gt;&gt; wrote:
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I'm actually thinking about taking the risk. We only have a small 3-node 
&gt;&gt;&gt;&gt;&gt; cluster with ~50GB of data with relatively little traffic (and we don't 
&gt;&gt;&gt;&gt;&gt; have any 2i, nor do we use search or MR).
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; I'll backup the data files, the ring state and everything else I find and 
&gt;&gt;&gt;&gt;&gt; give it a try. If anything strange happens, we roll back and do the 
&gt;&gt;&gt;&gt;&gt; additional 1.1.4 step.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; Thanks for the information and help so far!
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On 08.08.2012, at 19:57, Jon Meredith  wrote:
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Only test coverage. We didn't run direct testing to 0.14.2 - we also 
&gt;&gt;&gt;&gt;&gt;&gt; deliberately made the decision not to remove some older code that would 
&gt;&gt;&gt;&gt;&gt;&gt; have broken 0.14 upgrades until the next major release.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; It all depends on your risk tolerance - we didn't make any file format 
&gt;&gt;&gt;&gt;&gt;&gt; changes to bitcask so your data should be safe. If you wanted to try 
&gt;&gt;&gt;&gt;&gt;&gt; it, I would take a backup of the ring directory in case you had to 
&gt;&gt;&gt;&gt;&gt;&gt; downgrade the node again for any reason.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On the newly upgraded node you could run riak\\_core\\_capability:all(). on 
&gt;&gt;&gt;&gt;&gt;&gt; the riak console, that would double-check that the settings matched the 
&gt;&gt;&gt;&gt;&gt;&gt; required rolling upgrade settings, and make sure you do a diff of your 
&gt;&gt;&gt;&gt;&gt;&gt; app.config/vm.args against the new package to check there aren't any 
&gt;&gt;&gt;&gt;&gt;&gt; settings missing.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Jon.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On Wed, Aug 8, 2012 at 11:39 AM, Sebastian Cohnen 
&gt;&gt;&gt;&gt;&gt;&gt;  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; I'm curious, are there any special reasons for your recommendation?
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; On 08.08.2012, at 19:38, Jon Meredith  wrote:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; I would recommend going 0.14.2 -&gt; 1.1.4 -&gt; 1.2, making sure you follow 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; the pre-1.0 upgrade instructions on 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://wiki.basho.com/Rolling-Upgrades.html
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Once you do the upgrade from 1.2, the capabilities system will kick in 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; and the old legacy settings mentioned in the rolling upgrade will no 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; longer be used (if you need to you can override them with the new 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; capability override mechanism).
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Jon.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On Wed, Aug 8, 2012 at 10:23 AM, Nathan Wilken  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Is an intermediate upgrade recommended? 0.14.2 --&gt; 1.0/1.1 --&gt; 1.2?
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; From: riak-users-boun...@lists.basho.com 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; [riak-users-boun...@lists.basho.com] on behalf of Sean Cribbs 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; [s...@basho.com]
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Sent: Wednesday, August 08, 2012 6:35 AM
&gt;&gt;&gt;&gt;&gt;&gt;&gt; To: Sebastian Cohnen
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Cc: riak-users@lists.basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Subject: Re: Upgrading 0.14.2 cluster to 1.2
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Sebastian,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; While it might work, we did not specifically test upgrades from 0.14.2, 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; only 1.0 and 1.1.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; On Wed, Aug 8, 2012 at 7:08 AM, Sebastian Cohnen 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;  wrote:
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Hey list,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; is it a good idea to upgrade a small (3 node) cluster straight to 1.2 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; from 0.14.2. Especially with riak's 1.2 capabilities negotiation, it 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; feels like the upgrade process should be much simpler now? We don't do 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; any M/R jobs currently and we are only using bitcask right now.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Best
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Sebastian
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Software Engineer
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Jon Meredith
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Platform Engineering Manager
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; jmered...@basho.com
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt;&gt;&gt; Jon Meredith
&gt;&gt;&gt;&gt;&gt;&gt; Platform Engineering Manager
&gt;&gt;&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt;&gt;&gt; jmered...@basho.com
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; -- 
&gt;&gt; Joseph Blomstedt 
&gt;&gt; Senior Software Engineer
&gt;&gt; Basho Technologies, Inc.
&gt;&gt; http://www.basho.com/
&gt; 
