---
title: "Re: doubt about encoding in map/reduce"
description: ""
project: community
lastmod: 2010-06-06T15:06:14-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00510"
mailinglist_parent_id: "msg00509"
author_name: "francisco treacy"
project_section: "mailinglistitem"
sent_date: 2010-06-06T15:06:14-07:00
---


Thanks Grant and Kevin, I'll wait for Riak 0.11.


2010/6/6 Kevin Smith :
&gt; Francisco -
&gt;
&gt; A potential fix for this bug is the latest version of erlang\\_js. erlang\\_js 
&gt; wasn't calling JS\\_CStringsAreUTF8() in the Spidermonkey API. This causes all 
&gt; kinds of interesting string mangling to occur and can trigger bad\\_encoding 
&gt; errors as well. You can either checkout the latest erlang\\_js and replace your 
&gt; existing version with the new copy or you can wait on Riak 0.11 and pick it 
&gt; up then.
&gt;
&gt; --Kevin
&gt; On Jun 6, 2010, at 12:23 PM, francisco treacy wrote:
&gt;
&gt;&gt; I get {"error":"bad\\_encoding"} from map/reduce when I use non-ASCII 
&gt;&gt; characters:
&gt;&gt;
&gt;&gt; ftreacy @ ~
&gt;&gt; =&gt;  curl -X PUT http://127.0.0.1:8098/riak/test/bug -H "Content-Type:
&gt;&gt; application/json" -d @-
&gt;&gt; {"city":"Buenos Aires"}
&gt;&gt; ^D
&gt;&gt;
&gt;&gt; ftreacy @ ~
&gt;&gt; =&gt;  curl -X POST http://localhost:8098/mapred -H "Content-Type:
&gt;&gt; application/json" -d @-
&gt;&gt; {"inputs":"test",
&gt;&gt; "query":[{"map":{"language":"javascript",
&gt;&gt;                  "source":"function(value, keyData, arg) { var data =
&gt;&gt; Riak.mapValuesJson(value)[0]; return [data]; }",
&gt;&gt;                  "keep":true}}]
&gt;&gt; }
&gt;&gt; [{"city":"Buenos Aires"}]
&gt;&gt;
&gt;&gt; ftreacy @ ~
&gt;&gt; =&gt;  curl -X PUT http://127.0.0.1:8098/riak/test/bug -H "Content-Type:
&gt;&gt; application/json" -d @-
&gt;&gt; {"city":"København"}
&gt;&gt; ^D
&gt;&gt;
&gt;&gt; ftreacy @ ~
&gt;&gt; =&gt;  curl http://127.0.0.1:8098/riak/test/bug
&gt;&gt; {"city":"København"}
&gt;&gt;
&gt;&gt; ftreacy @ ~
&gt;&gt; =&gt;  curl -X POST http://localhost:8098/mapred -H "Content-Type:
&gt;&gt; application/json" -d @-
&gt;&gt; {"inputs":"test",
&gt;&gt; "query":[{"map":{"language":"javascript",
&gt;&gt;                  "source":"function(value, keyData, arg) { var data =
&gt;&gt; Riak.mapValuesJson(value)[0]; return [data]; }",
&gt;&gt;                  "keep":true}}]
&gt;&gt; }
&gt;&gt; {"error":"bad\\_encoding"}
&gt;&gt;
&gt;&gt;
&gt;&gt; Should I escape UTF-8, or is this a bug? (Same behaviour using riak-js).
&gt;&gt;
&gt;&gt; "bug" is the only key in the "test" bucket. Using Riak 0.10.1 on Snow 
&gt;&gt; Leopard.
&gt;&gt;
&gt;&gt; Francisco
&gt;
&gt;

