---
title: "Re: 0.14 and search schema"
description: ""
project: community
lastmod: 2011-02-22T12:38:24-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg02408"
mailinglist_parent_id: "msg02396"
author_name: "Rusty Klophaus"
project_section: "mailinglistitem"
sent_date: 2011-02-22T12:38:24-08:00
---


Hi Gary,

Sorry to hear you are having troubles. Hopefully I can help. Please see my
responses inline below.

Best,
Rusty

On Mon, Feb 21, 2011 at 1:56 AM, Gary William Flake  wrote:

&gt; I've been pulling my hair out over new behaviors with search-schema,
&gt; and I am wondering if I've been simply doing it wrong. Here's the
&gt; issue: search-schema seem extremely brittle compared to the rest of
&gt; the system in that one misstep requires that you effectively blow away
&gt; your whole DB and try again. Some specific examples:
&gt;
&gt; 1. Defaults don't seem to mean anything now in that if you add a new
&gt; field to what you are storing, then riak will throw up on insert
&gt; because the field isn't in the schema.
&gt;

Just to make sure we're on the same page, the "default\\_field" schema is only
used to tell the system what field to use for searching if no field is
specified, or what field to use for indexing if you index a "Content-Type:
text/plain" document. It's the dynamic fields that allow you to add new
fields to your schema.

If you display the schema by running "./bin/search-cmd show\\_schema
BUCKETNAME", then you should see the following as the last field:

 {dynamic\\_field, [
 {name, "\\*"},
 {type, string},
 {analyzer\\_factory, {erlang, text\\_analyzers,
whitespace\\_analyzer\\_factory}}
 ]}

This should catch any unknown fields and index them as a whitespace
separated string. If you don't see this, or if you \\*do\\* see this but are
still getting errors, can you send the results of the show\\_bucket command
plus the error messages to me?


&gt;
&gt; 2. But if you add the new field to the schema, then it breaks all of
&gt; your old records (e.g., they can't be deleted until you change the
&gt; schema back or turn off hooks).
&gt;

Hrm... this shouldn't be the case except for certain edge cases where you
\\*change\\* the type of field from string to integer and then try to view the
results via the Solr interface. New fields should be fine. Can you send me
the errors messages? If time permits a minimal failing test case would be
extremely helpful.


&gt;
&gt; 3. The semantics are non-intuitive (at least to me). I had thought
&gt; that {skip, true} would mean "this is data that I want but don't index
&gt; over it". Instead, it appears to mean "riak will not index it, and if
&gt; you do a search, we will not provide this field value in the results
&gt; even though it exists".
&gt;

You're right, and this is a bug. The system should return the original
field. This is now tracked at https://issues.basho.com/show\\_bug.cgi?id=1014


&gt;
&gt; 4. To make it even more challenging, on ubuntu "search-cmd set-schema
&gt; ..." ignores the last argument. It seems to expect the schema to
&gt; already exist in /var/lib/riak/scripts and I found that if I
&gt; forcefully move and chmod the schema, then I can get it to stick.
&gt;

Is it only chopping off the last argument on a "set-schema" command, or is
it doing this for all commands? Can you send me the command you are running
and the error message?

The command should be:

# search-cmd set-schema bucket filename


&gt; 5. But, BTW, /var/lib/riak doesn't exist as part of 0.14's deb
&gt; package, so you better know to add it yourself.
&gt;

Riak Search should have a /var/lib/riaksearch directory, not a /var/lib/riak
directory (or are you experiencing this problem in Riak KV?)


&gt;
&gt;
&gt; Anyhow, am I doing something wrong? Or is how it is supposed to be?
&gt; Does anyone have any tricks for working around this brittleness?
&gt;
&gt; Thanks,
&gt; -- GWF
&gt;
&gt; PS - here's a trick that may help you. Define a field called "future"
&gt; and make set up the standard analyzer in the search schema. Then,
&gt; when you are tempted to add a new field, don't. Instead, force your
&gt; new "field:val" bits into future instead. This way, you can get away
&gt; with not having to change the schema nor do you need to add a new
&gt; field. I am hoping that this trick will help me keep a riak instance
&gt; stable long enough to work through migration issues for when I do need
&gt; to change the schema.
&gt;

Hrm... this is not recommended behavior. You should be able to add fields to
your documents using either named fields (if you know the field names in
advance) or dynamic fields (using wildcard-style names). Let's get to the
bottom of this! :)


&gt;

