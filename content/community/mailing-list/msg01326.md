---
title: "Re: File descriptor leaks?"
description: ""
project: community
lastmod: 2010-10-18T20:08:00-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01326"
mailinglist_parent_id: "msg01320"
author_name: "Dmitry Demeshchuk"
project_section: "mailinglistitem"
sent_date: 2010-10-18T20:08:00-07:00
---


Hi, Justin.

We are using 0.12.1.

I thought it could be caused by our version of OTP (we had been using
R14A) so I downgraded to R13B04. It didn't help though.

Unfortunately, there's nothing interesting in logs, neither in Riak's
nor in ours. I think that most likely there are some web requests that
hang for some reason. Moreover, since we haven't been getting this
problem before the last week I guess there's some problem in my own
code that I have released recently.

However, for now I got some more urgent tasks to finish so I just
added a cron job that restarts Riak every hour. Guess I'll have to
handle this problem in a week or so on.

Anyway, thanks for getting in touch. As soon as I have time to
investigate the problem I'll let you know the result.

On Mon, Oct 18, 2010 at 6:11 PM, Justin Sheehy  wrote:
&gt; Hi, Dmitry.
&gt;
&gt; What version of Riak are you using?  And is there anything interesting
&gt; in the error logs?
&gt;
&gt; -Justin
&gt;
&gt;
&gt;
&gt;
&gt; On Thu, Oct 14, 2010 at 7:53 AM, Dmitry Demeshchuk  
&gt; wrote:
&gt;&gt; A small update. I've just encountered the same problem. Just about 3-4
&gt;&gt; hours have passed.
&gt;&gt;
&gt;&gt; lsof | wc -l showed only about 2k descriptors for all users. That's
&gt;&gt; even more weird as the 32k descriptors limit is per user. So, we
&gt;&gt; haven't reached the limit so far.
&gt;&gt;
&gt;&gt; On Thu, Oct 14, 2010 at 3:48 PM, Dmitry Demeshchuk  
&gt;&gt; wrote:
&gt;&gt;&gt; Greetings.
&gt;&gt;&gt;
&gt;&gt;&gt; We have recently started to get the emfile errors. ulimit -n is 32767.
&gt;&gt;&gt; Restarting Riak helps for several hours and then we run out of
&gt;&gt;&gt; descriptors again.
&gt;&gt;&gt;
&gt;&gt;&gt; Some time later after restart I performed lsof and found the following
&gt;&gt;&gt; descriptors:
&gt;&gt;&gt;
&gt;&gt;&gt; kondemand   154       root  cwd   unknown
&gt;&gt;&gt; /proc/154/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root  rtd   unknown
&gt;&gt;&gt; /proc/154/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root  txt   unknown
&gt;&gt;&gt; /proc/154/exe (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root NOFD
&gt;&gt;&gt; /proc/154/fd (opendir: Permission denied)
&gt;&gt;&gt; kondemand   155       root  cwd   unknown
&gt;&gt;&gt; /proc/155/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root  cwd   unknown
&gt;&gt;&gt; /proc/154/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root  rtd   unknown
&gt;&gt;&gt; /proc/154/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root  txt   unknown
&gt;&gt;&gt; /proc/154/exe (readlink: Permission denied)
&gt;&gt;&gt; kondemand   154       root NOFD
&gt;&gt;&gt; /proc/154/fd (opendir: Permission denied)
&gt;&gt;&gt; kondemand   155       root  cwd   unknown
&gt;&gt;&gt; /proc/155/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   155       root  rtd   unknown
&gt;&gt;&gt; /proc/155/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   155       root  txt   unknown
&gt;&gt;&gt; /proc/155/exe (readlink: Permission denied)
&gt;&gt;&gt; kondemand   155       root NOFD
&gt;&gt;&gt; /proc/155/fd (opendir: Permission denied)
&gt;&gt;&gt; kondemand   156       root  cwd   unknown
&gt;&gt;&gt; /proc/156/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   156       root  rtd   unknown
&gt;&gt;&gt; /proc/156/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   156       root  txt   unknown
&gt;&gt;&gt; /proc/156/exe (readlink: Permission denied)
&gt;&gt;&gt; kondemand   156       root NOFD
&gt;&gt;&gt; /proc/156/fd (opendir: Permission denied)
&gt;&gt;&gt; kondemand   157       root  cwd   unknown
&gt;&gt;&gt; /proc/157/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   157       root  rtd   unknown
&gt;&gt;&gt; /proc/157/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   157       root  txt   unknown
&gt;&gt;&gt; /proc/157/exe (readlink: Permission denied)
&gt;&gt;&gt; kondemand   157       root NOFD
&gt;&gt;&gt; /proc/157/fd (opendir: Permission denied)
&gt;&gt;&gt; kondemand   158       root  cwd   unknown
&gt;&gt;&gt; /proc/158/cwd (readlink: Permission denied)
&gt;&gt;&gt; kondemand   158       root  rtd   unknown
&gt;&gt;&gt; /proc/158/root (readlink: Permission denied)
&gt;&gt;&gt; kondemand   158       root  txt   unknown
&gt;&gt;&gt; /proc/158/exe (readlink: Permission denied)
&gt;&gt;&gt;
&gt;&gt;&gt; Also, the following couple of descriptors is opened several times at
&gt;&gt;&gt; the same time:
&gt;&gt;&gt;
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0   256316   1179925
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_CTYPE
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       54   1179926
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_NUMERIC
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0     2454   1179927
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_TIME
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0   966938   1179928
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_COLLATE
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0      286   1179929
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_MONETARY
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       52   1179930
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_MESSAGES/SYS\\_LC\\_MESSAGES
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       34   1179931
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_PAPER
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       77   1179932
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_NAME
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0      155   1179933
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_ADDRESS
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       59   1179934
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_TELEPHONE
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0       23   1179935
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_MEASUREMENT
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0    26048    917676
&gt;&gt;&gt; /usr/lib/gconv/gconv-modules.cache
&gt;&gt;&gt; bash      20176        dem  mem       REG     252,0      373   1179936
&gt;&gt;&gt; /usr/lib/locale/en\\_US.utf8/LC\\_IDENTIFICATION
&gt;&gt;&gt;
&gt;&gt;&gt; Version of Riak is 0.12.1. There was a similar problem once and the
&gt;&gt;&gt; user was advised to make sure to use 0.12.1
&gt;&gt;&gt;
&gt;&gt;&gt; Any ideas?
&gt;&gt;&gt;
&gt;&gt;&gt; --
&gt;&gt;&gt; Best regards,
&gt;&gt;&gt; Dmitry Demeshchuk
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; --
&gt;&gt; Best regards,
&gt;&gt; Dmitry Demeshchuk

&gt;

-- 
Best regards,
Dmitry Demeshchuk

