---
title: "Re: Deleting items from search index increases disk usage"
description: ""
project: community
lastmod: 2012-11-02T10:10:05-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09164"
mailinglist_parent_id: "msg09105"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2012-11-02T10:10:05-07:00
---


Jeremy,

On Fri, Nov 2, 2012 at 12:31 PM, Jeremy Raymond  wrote:

&gt; I cycled through the compaction on another node. Again after 3 rounds
&gt; compaction has stopped. On one node the merge index is 26 GB on the other
&gt; 21 GB. So it looks like I've hit the 5 segment compaction no-op condition
&gt; on both nodes.


I concur. This condition seems arbitrary to me and I'm not sure if there
is a good reason for it to exist. But it's there and the only way we could
remove it for you is to hot-load a new beam.


&gt; What would account for the difference in merge\\_index size? Shouldn't these
&gt; be relatively the same? There must still be tombstones in there...
&gt;

Riak Search uses term-based partitioning. It could be that you have some
terms that are more frequent than others which would account for some of
the difference.


&gt;
&gt; On my production cluster the merge\\_index is ~44GB. I estimate that
&gt; approximately 90 - 95% of the index data belongs to the bucket I no longer
&gt; want indexed. Manually deleting items from the index then manually
&gt; triggering compaction doesn't look like it will scale. Will this workflow
&gt; work to re-build the search index. I need to keep the cluster available for
&gt; writes while doing this:
&gt;
&gt; 1. In a rolling fashion, disable Riak Search one node at a time.
&gt; 2. Delete the contents of the merge\\_index on each node.
&gt; 3. In a rolling fashion, re-enable Riak Search on each node.
&gt; 4. Reindex the items to be included in the search index.
&gt;

No, instead of disabling Riak Search you'll want to take the nodes down one
at a time, remove the merge index data, restart. After doing this for all
nodes then re-index your data.


&gt;
&gt; This should do the trick right? Do I need to disable search before
&gt; clearing out the merge\\_index folders or would disabling the search index on
&gt; the buckets via search-cmd be enough (and then re-enabling) before
&gt; re-indexing?
&gt;

Again, don't bother disabling search. The key is to take the nodes down
because merge index caches stuff in memory.

Actually, I thought of another way to achieve the same result without
taking the nodes down. If you have a non-production cluster to test this
on that would be a good precaution. I'm 99% sure this should work without
issue.

1. Make sure no indexes are incoming, do this either at your client or
uninstall all search hooks

For each node:

2. Get a list of the MI Pids like in the manual compaction example
3. For each MI Pid call merge\\_index:drop(MIPid)
3a. Verify the data files were removed on disk

After performing steps 2 & 3 on each node:

4. Re-write the objects you want indexed (of course remember to re-install
the hooks if you removed them in step 1)

-Z
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

