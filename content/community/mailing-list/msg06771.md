---
title: "Re: Python Client Thread Safe?"
description: ""
project: community
lastmod: 2012-02-27T19:52:25-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06771"
mailinglist_parent_id: "msg06770"
author_name: "Jim Adler"
project_section: "mailinglistitem"
sent_date: 2012-02-27T19:52:25-08:00
---


Greg,

Thanks for the comments. I'll do some tests along the lines of what you
suggest.

FWIW, I'm using Riak 1.0.3.

Jim

On 2/27/12 7:46 PM, "Greg Stein"  wrote:

&gt;]
&gt;X-pstn-settings: 3 (1.0000:0.1000) s cv GT3 gt2 gt1 r p m c
&gt;X-pstn-addresses: from  [db-null]
&gt;
&gt;To clarify my thread-sharing comments: those are with respect to the
&gt;unreleased client. And I've checked: the Bucket objects are sharable,
&gt;too. Obviously, not if multiple threads are calling competing .set\\_r()
&gt;or somesuch on the client or bucket. The short answer is share Client
&gt;and Bucket objects to get access to Objects, and keep those
&gt;per-thread.
&gt;
&gt;The underlying transport will manage multiple connections,
&gt;persistently, in a thread-safe manner.
&gt;
&gt;(and I'm unclear on threading issues for the 1.3.0 python client)
&gt;
&gt;Cheers,
&gt;-g
&gt;
&gt;On Mon, Feb 27, 2012 at 22:37, Greg Stein  wrote:
&gt;&gt; IIRC, that error was seen when connecting to Riak 0.14.0. What version
&gt;&gt;of
&gt;&gt; Riak are you connecting to?
&gt;&gt;
&gt;&gt; I might also suggest using the current, unreleased Python client from
&gt;&gt;the
&gt;&gt; master branch on GitHub. It has much better support for threads and
&gt;&gt; persistent connections. Just don't use variant client\\_id values and PB
&gt;&gt; connections (switch to Riak 1.1 and ignore client\\_id).
&gt;&gt;
&gt;&gt; One Client can be shared across threads, but not Objects. I don't recall
&gt;&gt; whether Buckets can be shared.
&gt;&gt;
&gt;&gt; Cheers,
&gt;&gt; -g
&gt;&gt;
&gt;&gt; On Feb 26, 2012 2:39 PM, "Jim Adler"  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; I'm getting the following error while using protocol buffers
&gt;&gt;&gt; (RiakPbcTransport) with more than one thread (stack trace below):
&gt;&gt;&gt;
&gt;&gt;&gt; Socket returned short packet length 0 - expected 4'
&gt;&gt;&gt;
&gt;&gt;&gt; I'm using the 1.3.0 Python client on Mac and Ubuntu 11.04 and have seen
&gt;&gt;&gt; the same error on both OS's. A single-thread works fine as does the
&gt;&gt;&gt; RiakHttpTransport.
&gt;&gt;&gt;
&gt;&gt;&gt; Anyone have this problem?
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks,
&gt;&gt;&gt; Jim
&gt;&gt;&gt;
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/bucket.py", line
&gt;&gt;&gt;260,
&gt;&gt;&gt; in get
&gt;&gt;&gt; return obj.reload(r)
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/riak\\_object.py",
&gt;&gt;&gt;line
&gt;&gt;&gt; 373, in reload
&gt;&gt;&gt; Result = t.get(self, r, vtag)
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/transports/pbc.py",
&gt;&gt;&gt; line 195, in get
&gt;&gt;&gt; msg\\_code, resp = self.send\\_msg(MSG\\_CODE\\_GET\\_REQ, req, None)
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/transports/pbc.py",
&gt;&gt;&gt; line 387, in send\\_msg
&gt;&gt;&gt; return self.recv\\_msg(conn, expect)
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/transports/pbc.py",
&gt;&gt;&gt; line 413, in recv\\_msg
&gt;&gt;&gt; self.recv\\_pkt(conn)
&gt;&gt;&gt; File
&gt;&gt;&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt;"/usr/local/Cellar/python/2.7.2/Frameworks/Python.framework/Versions/2.7
&gt;&gt;&gt;/li
&gt;&gt;&gt; b/python2.7/site-packages/riak-1.3.0-py2.7.egg/riak/transports/pbc.py",
&gt;&gt;&gt; line 460, in recv\\_pkt
&gt;&gt;&gt; len(nmsglen))
&gt;&gt;&gt; RiakError: 'Socket returned short packet length 0 - expected 4'
&gt;&gt;&gt;
&gt;&gt;&gt;

