---
title: "Re: Intermittent MapReduce crashes (reserve_vm)"
description: ""
project: community
lastmod: 2012-04-27T22:38:25-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07342"
mailinglist_parent_id: "msg07329"
author_name: "Brian Conway"
project_section: "mailinglistitem"
sent_date: 2012-04-27T22:38:25-07:00
---


Any ideas? Using JS for MapReduce, I'm currently unable to do anything
except trivial tasks without these crashes, so I must be doing
something wrong. I'm fine with slow results (it is virtualized on
commodity hardware, after all), but intermittent VM errors don't seem
right. Thanks in advance.

Brian Conway

On Thu, Apr 26, 2012 at 12:23 AM, Brian Conway  wrote:
&gt; I have a test cluster of 3 nodes running locally (virtualized), with
&gt; default configuration + eleveldb. The nodes have plenty of ram and
&gt; never hit swap. I've already bumped up the JS VM count (8 -&gt; 24) after
&gt; getting preflist\\_exhausted errors, and I now get the follow
&gt; intermittently when posting to /mapred:
&gt;
&gt; $ curl -X POST http://10.236.174.131:8098/mapred -H "Content-Type:
&gt; application/json" -d @volume.js
&gt; {"phase":3,"error":"{noproc,{gen\\_server,call,[riak\\_kv\\_js\\_map,{reserve\\_vm,&lt;11534.1650.0&gt;},infinity]}}","input":"{ok,{r\\_object,&lt;&lt;\\"vol\\"&gt;&gt;,&lt;&lt;\\"6724\\_2012-01-21\\_18\\"&gt;&gt;,[{r\\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;\\"content-type\\"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;\\"X-Riak-VTag\\"&gt;&gt;,52,68,111,85,117,98,80,99,106,114,79,106,71,115,107,118,85,67,88,117,68,107]],[[&lt;&lt;\\"index\\"&gt;&gt;]],[],[[&lt;&lt;\\"X-Riak-Last-Modified\\"&gt;&gt;|{1335,385687,399828}]],[],[]}}},&lt;&lt;\\"{\\"dlid\\":
&gt; \\"1\\", \\"rate\\": \\"0.08\\", \\"cnid\\":
&gt; \\"...\\"&gt;&gt;}],...},...}","type":"exit","stack":"[{gen\\_server,call,3},{riak\\_kv\\_js\\_manager,blocking\\_dispatch,4},{riak\\_kv\\_mrc\\_map,map\\_js,3},{riak\\_kv\\_mrc\\_map,process,3},{riak\\_pipe\\_vnode\\_worker,process\\_input,3},{riak\\_pipe\\_vnode\\_worker,wait\\_for\\_input,2},{gen\\_fsm,handle\\_msg,7},{proc\\_lib,init\\_p\\_do\\_apply,3}]"}
&gt;
&gt; This only seems to happen every two or three attempts, the rest
&gt; complete successfully. Doing the same with Python and protocol buffers
&gt; also gives inconsistent results. Those attempts sometimes work and
&gt; sometimes throws off errors that are either the same as above, or like
&gt; these (may be unrelated):
&gt;
&gt; ...
&gt;  File 
&gt; "/home/bconway/scratch/riakenv/lib/python2.6/site-packages/riak/transports/pbc.py",
&gt; line 535, in recv\\_pkt
&gt;    % len(nmsglen))
&gt; riak.RiakError: 'Socket returned short packet length 3 - expected 4'
&gt;
&gt; ...
&gt;  File 
&gt; "/home/bconway/scratch/riakenv/lib/python2.6/site-packages/riak/transports/pbc.py",
&gt; line 535, in recv\\_pkt
&gt;    % len(nmsglen))
&gt; riak.RiakError: 'Socket returned short packet length 1 - expected 4'
&gt;
&gt; The MapReduce itself is wide but fairly simple: 10 user bucket-key
&gt; pairs, a few layers of links, and dump the final data:
&gt;
&gt; $ cat volume.js
&gt; {"inputs":[["user","1672\\_2012-01"],["user","2672\\_2012-01"],["user","3672\\_2012-01"],["user","4672\\_2012-01"],["user","5672\\_2012-01"],["user","6672\\_2012-01"],["user","672\\_2012-01"],["user","6723\\_2012-01"],["user","6724\\_2012-01"],["user","6725\\_2012-01"]],
&gt;  "query":[{"link":{"tag":"day"}},
&gt;          {"link":{"tag":"usage"}},
&gt;          {"link":{"tag":"contact"}},
&gt;          {"map":{
&gt;              "language":"javascript",
&gt;              "name":"Riak.mapValuesJson"
&gt;          }}
&gt;         ]
&gt; }
&gt;
&gt; The logs are fairly chatty, let me know what else I should add:
&gt;
&gt; \\*\\* Reason for termination ==
&gt; \\*\\* 
&gt; {{{badmatch,[]},[{riak\\_kv\\_js\\_manager,needs\\_reload,2},{riak\\_kv\\_js\\_manager,handle\\_call,3},{gen\\_server,handle\\_msg,5},{proc\\_lib,init\\_p\\_do\\_apply,3}]},{gen\\_server,call,[riak\\_kv\\_js\\_map,{mark\\_idle,&lt;0.1756.0&gt;},infinity]}}
&gt; 2012-04-26 00:18:18 =CRASH REPORT====
&gt;  crasher:
&gt;    initial call: riak\\_kv\\_js\\_vm:init/1
&gt;    pid: &lt;0.1756.0&gt;
&gt;    registered\\_name: []
&gt;    exception exit:
&gt; {{{badmatch,[]},[{riak\\_kv\\_js\\_manager,needs\\_reload,2},{riak\\_kv\\_js\\_manager,handle\\_call,3},{gen\\_server,handle\\_msg,5},{proc\\_lib,init\\_p\\_do\\_apply,3}]},{gen\\_server,call,[riak\\_kv\\_js\\_map,{mark\\_idle,&lt;0.1756.0&gt;},infinity]}}
&gt;      in function  gen\\_server:terminate/6
&gt;      in call from proc\\_lib:init\\_p\\_do\\_apply/3
&gt;    ancestors: [riak\\_kv\\_js\\_sup,riak\\_kv\\_sup,&lt;0.256.0&gt;]
&gt;    messages: 
&gt; [{'DOWN',#Ref&lt;0.0.0.149247&gt;,process,&lt;0.1753.0&gt;,{timeout,{gen\\_server,call,[&lt;0.1764.0&gt;,{checkout\\_to,&lt;0.2736.0&gt;},1000]}}}]
&gt;    links: [&lt;0.275.0&gt;]
&gt;    dictionary: []
&gt;    trap\\_exit: false
&gt;    status: running
&gt;    heap\\_size: 1597
&gt;    stack\\_size: 24
&gt;    reductions: 627539
&gt;  neighbours:
&gt;
&gt; Thanks for any help.
&gt;
&gt; Brian Conway

