---
title: "Re: Deleting items from search index increases disk usage"
description: ""
project: community
lastmod: 2012-11-05T10:06:58-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09203"
mailinglist_parent_id: "msg09105"
author_name: "Jeremy Raymond"
project_section: "mailinglistitem"
sent_date: 2012-11-05T10:06:58-08:00
---


I gave this approach a try on the test cluster and it worked. I disabled
search on all buckets. Then dropped the merge index on each node via the MI
Pid. This freed up the space (it didn't remove all the subfolders in the
merge\\_index but the disk usage went down to a few hundred K). Then I
reindex the items I wished to be searchable after re-enabling search on the
buckets.

--
Jeremy


On Fri, Nov 2, 2012 at 1:09 PM, Ryan Zezeski  wrote:

&gt; Jeremy,
&gt;
&gt; On Fri, Nov 2, 2012 at 12:31 PM, Jeremy Raymond wrote:
&gt;
&gt;&gt; I cycled through the compaction on another node. Again after 3 rounds
&gt;&gt; compaction has stopped. On one node the merge index is 26 GB on the other
&gt;&gt; 21 GB. So it looks like I've hit the 5 segment compaction no-op condition
&gt;&gt; on both nodes.
&gt;
&gt;
&gt; I concur. This condition seems arbitrary to me and I'm not sure if there
&gt; is a good reason for it to exist. But it's there and the only way we could
&gt; remove it for you is to hot-load a new beam.
&gt;
&gt;
&gt;&gt; What would account for the difference in merge\\_index size? Shouldn't
&gt;&gt; these be relatively the same? There must still be tombstones in there...
&gt;&gt;
&gt;
&gt; Riak Search uses term-based partitioning. It could be that you have some
&gt; terms that are more frequent than others which would account for some of
&gt; the difference.
&gt;
&gt;
&gt;&gt;
&gt;&gt; On my production cluster the merge\\_index is ~44GB. I estimate that
&gt;&gt; approximately 90 - 95% of the index data belongs to the bucket I no longer
&gt;&gt; want indexed. Manually deleting items from the index then manually
&gt;&gt; triggering compaction doesn't look like it will scale. Will this workflow
&gt;&gt; work to re-build the search index. I need to keep the cluster available for
&gt;&gt; writes while doing this:
&gt;&gt;
&gt;&gt; 1. In a rolling fashion, disable Riak Search one node at a time.
&gt;&gt; 2. Delete the contents of the merge\\_index on each node.
&gt;&gt; 3. In a rolling fashion, re-enable Riak Search on each node.
&gt;&gt; 4. Reindex the items to be included in the search index.
&gt;&gt;
&gt;
&gt; No, instead of disabling Riak Search you'll want to take the nodes down
&gt; one at a time, remove the merge index data, restart. After doing this for
&gt; all nodes then re-index your data.
&gt;
&gt;
&gt;&gt;
&gt;&gt; This should do the trick right? Do I need to disable search before
&gt;&gt; clearing out the merge\\_index folders or would disabling the search index on
&gt;&gt; the buckets via search-cmd be enough (and then re-enabling) before
&gt;&gt; re-indexing?
&gt;&gt;
&gt;
&gt; Again, don't bother disabling search. The key is to take the nodes down
&gt; because merge index caches stuff in memory.
&gt;
&gt; Actually, I thought of another way to achieve the same result without
&gt; taking the nodes down. If you have a non-production cluster to test this
&gt; on that would be a good precaution. I'm 99% sure this should work without
&gt; issue.
&gt;
&gt; 1. Make sure no indexes are incoming, do this either at your client or
&gt; uninstall all search hooks
&gt;
&gt; For each node:
&gt;
&gt; 2. Get a list of the MI Pids like in the manual compaction example
&gt; 3. For each MI Pid call merge\\_index:drop(MIPid)
&gt; 3a. Verify the data files were removed on disk
&gt;
&gt; After performing steps 2 & 3 on each node:
&gt;
&gt; 4. Re-write the objects you want indexed (of course remember to re-install
&gt; the hooks if you removed them in step 1)
&gt;
&gt; -Z
&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

