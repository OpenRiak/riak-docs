---
title: "Re: 2i query, weird null results, java pbclient"
description: ""
project: community
lastmod: 2011-10-25T10:55:19-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05309"
mailinglist_parent_id: "msg05300"
author_name: "Alexander Robbins"
project_section: "mailinglistitem"
sent_date: 2011-10-25T10:55:19-07:00
---


Actually, I'm going to look into switching from the RawClient to a normal
client. That should make this easier.

On Tue, Oct 25, 2011 at 12:48 PM, Alexander Robbins &lt;
a...@languagecomputer.com&gt; wrote:

&gt; That code snippet isn't working because I've got a RawClient instance and
&gt; its mapReduce method wants a MapReduceSpec. I ran into this problem while
&gt; trying to use search also. I ended up making a search object and then
&gt; serializing it to json and providing it to the MapReduceSpec constructor,
&gt; then passing the resulting MapReduceSpec into the mapReduce method on
&gt; RawClient. Is there a better way? I considered just using String.format to
&gt; put the variables into a handwritten json string and using that to
&gt; instantiate the MapReduceSpec.
&gt;
&gt; Thanks!
&gt; Alex
&gt;
&gt; My gross method of making a MapReduceSpec:
&gt; final Map mapReduceObject = new HashMap Object&gt;();
&gt; final Map inputs = new HashMap();
&gt; final List query = new ArrayList();
&gt; final List searchTerms = new ArrayList();
&gt; searchTerms.add(bucket);
&gt; searchTerms.add(terms);
&gt; inputs.put("module", "riak\\_search");
&gt; inputs.put("function", "mapred\\_search");
&gt; inputs.put("arg", searchTerms);
&gt; final Map reduce = new HashMap();
&gt; reduce.put("language", "erlang");
&gt; reduce.put("module", "riak\\_kv\\_mapreduce");
&gt; reduce.put("function", "reduce\\_identity");
&gt; final Map&gt; map1 = new
&gt; HashMap&gt;();
&gt; map1.put("reduce", reduce);
&gt; query.add(map1);
&gt; mapReduceObject.put("inputs", inputs);
&gt; mapReduceObject.put("query", query);
&gt; final MapReduceSpec spec = new MapReduceSpec(new
&gt; Gson().toJson(mapReduceObject));
&gt;
&gt;
&gt;
&gt; On Tue, Oct 25, 2011 at 10:43 AM, Russell Brown wrote:
&gt;
&gt;&gt;
&gt;&gt; On 25 Oct 2011, at 16:09, Alexander Robbins wrote:
&gt;&gt;
&gt;&gt; The M/R job over the http api seems to be working to me.
&gt;&gt;
&gt;&gt; curl -X POST http://192.168.1.39:8098/mapred -H "Content-Type:
&gt;&gt; application/json" -d @query.json
&gt;&gt;
&gt;&gt; query.json:
&gt;&gt; {"inputs":{"bucket":"mentions","index":"docUID\\_bin","key":"5b9d1a6250dbd3e77ff004a12d06958745ee32844ad4aa668001bbe69b5efcf8"},"query":[{"reduce":{"language":"erlang","module":"riak\\_kv\\_mapreduce","function":"reduce\\_identity","arg":"{reduce\\_phase\\_only\\_1,
&gt;&gt; true}"}}]}
&gt;&gt;
&gt;&gt; Results:
&gt;&gt;
&gt;&gt; [["mentions","1907d031c88b8df2fc5128114615133d4184cedaea55964c3cee0ef9fe566f13"],["mentions","1bb5ce4aba0bf240698876530948c807d50e6f04a7358b7514c756dd295775ae"],["mentions","1f5f8f78951c6842ad6bcc96e3839ca8240b71372d2ab4826411fdfc84fedeb1"],["mentions","330856dabfa3a1c5b9ca8051686d8d7f387a23c795493a4e8f33d84861756d4f"],["mentions","338fffb9740b2f0c50b2da52a73b4861be318868082db3748eb95a47654981bd"],["mentions","5eef2b9cd6f7faf34548c9700069527287574690ab3dabf4c4f186753ffc5417"],["mentions","7ec9217a7a87c9e43a94170bb1ab8c13566233823ef6f77ef9c455a289c4bdf8"],["mentions","a588d7f0fb413d52a895a5d7e7fcfc966e9a56c42456e7821d2e5fa93b5671ba"],["mentions","aaacde92acf2c61abf9a4104f263283aed6233da08efb6ebbf13f83dfcfa1e7c"]]
&gt;&gt;
&gt;&gt; Looks good to me. It has an extra "mentions" term, but I think the java
&gt;&gt; client explicitly drops that when converting the m/r results.
&gt;&gt;
&gt;&gt;
&gt;&gt; That is what I think the culprit is (dropping the bucket from the return.)
&gt;&gt; Thanks for helping track it down. I'm going to spend some time trying to
&gt;&gt; recreate it so I can fix it. I've opened a bugzilla ticket for it here
&gt;&gt; https://issues.basho.com/show\\_bug.cgi?id=1262
&gt;&gt;
&gt;&gt; Thanks again, hope to have something for you soon. In the meantime, a work
&gt;&gt; around would be to use an M/R job from the PB client like this (it is a bit
&gt;&gt; more verbose, sorry)
&gt;&gt;
&gt;&gt; // get your PB client as before
&gt;&gt; IndexQuery q = new BinValueQuery(BinIndex.named("docUID"), "mentions",
&gt;&gt; "5b9d1a6250dbd3e77ff004a12d06958745ee32844ad4aa668001bbe69b5efcf8");
&gt;&gt; MapReduceResult result =
&gt;&gt; client.mapReduce(q).addReducePhase(NamedErlangFunction.REDUCE\\_IDENTITY, 
&gt;&gt; "{reduce\\_phase\\_only\\_1,
&gt;&gt; true}").execute();
&gt;&gt; Collection r = result.getResult(String[].class);
&gt;&gt;
&gt;&gt; This will get you a collection of two tuples where the first element is
&gt;&gt; the bucket and the second the key.
&gt;&gt;
&gt;&gt; Let me know if that works for you in the interim.
&gt;&gt;
&gt;&gt; Cheers
&gt;&gt;
&gt;&gt; Russell
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; Alex
&gt;&gt;
&gt;&gt; On Tue, Oct 25, 2011 at 9:12 AM, Russell Brown wrote:
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

