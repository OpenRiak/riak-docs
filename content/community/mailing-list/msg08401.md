---
title: "Re: Bad MapReduce job brings the Riak to a screeching halt?"
description: ""
project: community
lastmod: 2012-08-29T23:29:42-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08401"
mailinglist_parent_id: "msg08400"
author_name: "Alexander Sicular"
project_section: "mailinglistitem"
sent_date: 2012-08-29T23:29:42-07:00
---


With three instances running you should definitely bump it up. Try "ulimit -n 
16384" (or more) in a terminal and then start your three instances from that 
terminal. Rerun your tests. 


@siculars
http://siculars.posterous.com

Sent from my iRotaryPhone

On Aug 30, 2012, at 2:10, Brad Heller  wrote:

&gt; Interesting. 
&gt; 
&gt; $ ulimit -n
&gt; 2560
&gt; 
&gt; I remember seeing something in the documentation about this…I also see Riak 
&gt; returning HTTP 405's every now and then when it's under load. Perhaps related?
&gt; 
&gt; On Aug 29, 2012, at 8:43 PM, Alexander Sicular  wrote:
&gt; 
&gt;&gt; What's your "ulimit -n" ?
&gt;&gt; 
&gt;&gt; I think you ran out of fd's. I cite the "io error: lock" mumbo jumbo. 
&gt;&gt; 
&gt;&gt; -Alexander
&gt;&gt; 
&gt;&gt; @siculars
&gt;&gt; http://siculars.posterous.com
&gt;&gt; 
&gt;&gt; Sent from my iRotaryPhone
&gt;&gt; 
&gt;&gt; On Aug 29, 2012, at 23:07, Brad Heller  wrote:
&gt;&gt; 
&gt;&gt;&gt; Hello Riak world,
&gt;&gt;&gt; 
&gt;&gt;&gt; I've been experimenting with migrating some of our OLAP data in to Riak 
&gt;&gt;&gt; recently. I'm still learning about the…particulars…of Riak, so apologies is 
&gt;&gt;&gt; the solution to this is obvious or this is an overt n00b question.
&gt;&gt;&gt; 
&gt;&gt;&gt; I'm developing on a three-ring Riak cluster on my machine (OSX 10.8.1). I'm 
&gt;&gt;&gt; primarily using Ruby + Ripple but I've done a lot exploration with Curl 
&gt;&gt;&gt; too. I'm also using Rekon as a way to peek in to data I'm storing.
&gt;&gt;&gt; 
&gt;&gt;&gt; The issue I'm facing: I tried to run an improperly-formatted MapReduce job 
&gt;&gt;&gt; against a bucket with about 45k keys in it and it seemed to crash Riak. 
&gt;&gt;&gt; Here's the job itself:
&gt;&gt;&gt; 
&gt;&gt;&gt; 1.9.3p194 :065 &gt; puts job.to\\_json
&gt;&gt;&gt; {"inputs":{"bucket":"raw\\_statistics","key\\_filters":[["starts\\_with","some\\_string"],["and",[[["tokenize",":",4]],[["between",1345197700,1345697700,true]]]]]},"query":[{"map":{"language":"javascript","keep":true,"name":"Riak.mapValuesJson"}}]}
&gt;&gt;&gt; 
&gt;&gt;&gt; I would expect about 2.5k matches to the map. Here's the output from one of 
&gt;&gt;&gt; the vnodes' error.log
&gt;&gt;&gt; 
&gt;&gt;&gt; 2012-08-29 19:27:52.908 [error] &lt;0.420.0&gt;@riak\\_pipe\\_vnode:new\\_worker:766 
&gt;&gt;&gt; Pipe worker startup failed:fitting was gone before startup
&gt;&gt;&gt; 2012-08-29 19:45:41.739 [error] &lt;0.959.0&gt; gen\\_fsm &lt;0.959.0&gt; in state active 
&gt;&gt;&gt; terminated with reason: no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 
&gt;&gt;&gt; 2012-08-29 19:45:41.773 [error] &lt;0.594.0&gt; gen\\_fsm &lt;0.594.0&gt; in state active 
&gt;&gt;&gt; terminated with reason: no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 
&gt;&gt;&gt; 2012-08-29 19:45:41.778 [error] &lt;0.594.0&gt; CRASH REPORT Process &lt;0.594.0&gt; 
&gt;&gt;&gt; with 1 neighbours exited with reason: no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 in 
&gt;&gt;&gt; gen\\_fsm:terminate/7 line 611 
&gt;&gt;&gt; 2012-08-29 19:45:41.785 [error] &lt;0.23924.70&gt;@riak\\_kv\\_vnode:init:265 Failed 
&gt;&gt;&gt; to start riak\\_kv\\_multi\\_backend Reason: 
&gt;&gt;&gt; [{riak\\_kv\\_eleveldb\\_backend,{db\\_open,"IO error: lock 
&gt;&gt;&gt; ../../tmp/riak/instance1/leveldb/0/LOCK: Resource temporarily 
&gt;&gt;&gt; unavailable"}}]
&gt;&gt;&gt; 2012-08-29 19:45:41.814 [error] &lt;0.141.0&gt; Supervisor riak\\_core\\_vnode\\_sup 
&gt;&gt;&gt; had child undefined started with {riak\\_core\\_vnode,start\\_link,undefined} at 
&gt;&gt;&gt; &lt;0.594.0&gt; exit with reason no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 in context 
&gt;&gt;&gt; child\\_terminated
&gt;&gt;&gt; 2012-08-29 19:45:41.818 [error] &lt;0.959.0&gt; CRASH REPORT Process &lt;0.959.0&gt; 
&gt;&gt;&gt; with 1 neighbours exited with reason: no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 in 
&gt;&gt;&gt; gen\\_fsm:terminate/7 line 611 
&gt;&gt;&gt; 2012-08-29 19:45:41.822 [error] &lt;0.141.0&gt; Supervisor riak\\_core\\_vnode\\_sup 
&gt;&gt;&gt; had child undefined started with {riak\\_core\\_vnode,start\\_link,undefined} at 
&gt;&gt;&gt; &lt;0.959.0&gt; exit with reason no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 in context 
&gt;&gt;&gt; child\\_terminated
&gt;&gt;&gt; 2012-08-29 19:45:41.943 [error] &lt;0.962.0&gt; gen\\_fsm &lt;0.962.0&gt; in state ready 
&gt;&gt;&gt; terminated with reason: no match of right hand value 
&gt;&gt;&gt; {error,{bad\\_filter,[&lt;&lt;"tokenize"&gt;&gt;,&lt;&lt;":"&gt;&gt;,4]}} in 
&gt;&gt;&gt; riak\\_kv\\_mapred\\_filters:'-logical\\_and/1-fun-0-'/1 line 176 
&gt;&gt;&gt; 
&gt;&gt;&gt; For what it's worth the format of my key is as follows (if anyone has any 
&gt;&gt;&gt; suggestions on a smarter way to format these, I'm all ears).
&gt;&gt;&gt; 
&gt;&gt;&gt; :::&gt;&gt; in seconds&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt; So my question is: Why did this completely kill Riak? This makes me pretty 
&gt;&gt;&gt; nervous--a bug in our app has the potential to bring down the ring! Is 
&gt;&gt;&gt; there anything we can do to protect against this?
&gt;&gt;&gt; 
&gt;&gt;&gt; And a bonus question: What is a reasonable way to query this? I can't 
&gt;&gt;&gt; maintain links as there will potentially be hundreds of thousands of these 
&gt;&gt;&gt; objects to query over (each one is pretty small). Is this a good candidate 
&gt;&gt;&gt; for a compound secondary index?
&gt;&gt;&gt; 
&gt;&gt;&gt; Thanks for any help.
&gt;&gt;&gt; 
&gt;&gt;&gt; Cheers,
&gt;&gt;&gt; 
&gt;&gt;&gt; Brad Heller | Engineering Lead | Cloudability.com | 541-231-1514 | Skype: 
&gt;&gt;&gt; brad.heller | @bradhe | @cloudability
&gt;&gt;&gt; 
&gt;&gt;&gt; We're hiring! http://cloudability.com/jobs
&gt;&gt;&gt; 
&gt; 
