---
title: "Re: Link Walking via Map Reduce"
description: ""
project: community
lastmod: 2011-06-23T08:15:04-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03800"
mailinglist_parent_id: "msg03797"
author_name: "Andrew Berman"
project_section: "mailinglistitem"
sent_date: 2011-06-23T08:15:04-07:00
---


Mathias,

I thought Riak was content agnostic when it came to the data being
stored? The map phase is not running Riak.mapValuesJson, so why is
the data itself going through the JSON parser? The JSON value
returned by v with all the info is valid and I see the struct atom in
there so mochijson2 can parse it properly, but I'm not clear why
mochijson2 would be coughing at the data part.

--Andrew

On Thu, Jun 23, 2011 at 5:32 AM, Mathias Meyer  wrote:
&gt; Andrew,
&gt;
&gt; you're indeed hitting a JSON encoding problem here. BERT is binary data, and 
&gt; won't make the JSON parser happy when trying to deserialize it, before 
&gt; handing it into the map phase. You have two options here, and none of them 
&gt; will involve JavaScript as the MapReduce language.
&gt;
&gt; 1.) Use the Protobuff API, use Erlang functions to return the value or object 
&gt; (e.g. riak\\_mapreduce:map\\_object\\_value or riak\\_kv\\_mapreduce:map\\_identity), and 
&gt; then run MapReduce queries with the content type 
&gt; 'application/x-erlang-binary'. However, you're constrained by client 
&gt; libraries here, e.g. Ruby and Python don't support this content type for 
&gt; MapReduce on the Protobuffs interface yet, so you'd either implement 
&gt; something custom, or resort to a client that does, riak-erlang-client comes 
&gt; to mind, though it was proven to be possible using the Java client too, 
&gt; thanks to Russell. See [1] and [2]
&gt;
&gt; 2.) Convert the result from BERT into a JSON-parseable structure inside an 
&gt; Erlang map function, before it's returned to the client.
&gt;
&gt; The second approach certainly is less restrictive in terms of API usage, but 
&gt; certainly involves some overhead inside of the MapReduce request itself, but 
&gt; is less prone to encoding/decoding issues with JSON.
&gt;
&gt; Mathias Meyer
&gt; Developer Advocate, Basho Technologies
&gt;
&gt; [1] 
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2011-June/004447.html
&gt; [2] 
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2011-June/004485.html
&gt;
&gt; On Donnerstag, 23. Juni 2011 at 07:59, Andrew Berman wrote:
&gt;
&gt;&gt; Hey Ryan,
&gt;&gt;
&gt;&gt; Here is the error from the sasl log. It looks like some sort of
&gt;&gt; encoding error. Any thoughts on how to fix this? I am storing the
&gt;&gt; data as BERT encoded binary and I set the content-type as
&gt;&gt; application/octet-stream.
&gt;&gt;
&gt;&gt; Thanks for your help!
&gt;&gt;
&gt;&gt; Andrew
&gt;&gt;
&gt;&gt; ERROR REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt; \\*\\* Generic server &lt;0.5996.21&gt; terminating
&gt;&gt; \\*\\* Last message in was {batch\\_dispatch,
&gt;&gt;  {map,
&gt;&gt; {jsanon,&lt;&lt;"function(value) {return [value];}"&gt;&gt;},
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"bucket"&gt;&gt;,&lt;&lt;"user"&gt;&gt;},
&gt;&gt;  {&lt;&lt;"key"&gt;&gt;,&lt;&lt;"LikiWUPJSFuxtrhCYpsPfg"&gt;&gt;},
&gt;&gt;  {&lt;&lt;"vclock"&gt;&gt;,
&gt;&gt;
&gt;&gt; &lt;&lt;"a85hYGBgzGDKBVIsLKaZdzOYEhnzWBmes6Yd58sCAA=="&gt;&gt;},
&gt;&gt;  {&lt;&lt;"values"&gt;&gt;,
&gt;&gt; [{struct,
&gt;&gt; [{&lt;&lt;"metadata"&gt;&gt;,
&gt;&gt; {struct,
&gt;&gt;  [{&lt;&lt;"X-Riak-VTag"&gt;&gt;,
&gt;&gt; &lt;&lt;"1KnL9Dlma9Yg4eMhRuhwtx"&gt;&gt;},
&gt;&gt; {&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;,
&gt;&gt; &lt;&lt;"Fri, 10 Jun 2011 03:05:11 GMT"&gt;&gt;}]}},
&gt;&gt;  {&lt;&lt;"data"&gt;&gt;,
&gt;&gt;
&gt;&gt; &lt;&lt;131,108,0,0,0,18,104,2,100,0,6,114,...&gt;&gt;}]}]}]},
&gt;&gt; &lt;&lt;"user"&gt;&gt;,none]}}
&gt;&gt; \\*\\* When Server state == {state,&lt;0.143.0&gt;,riak\\_kv\\_js\\_map,#Port&lt;0.92614&gt;,true}
&gt;&gt; \\*\\* Reason for termination ==
&gt;&gt; \\*\\* {function\\_clause,[{js\\_driver,eval\\_js,
&gt;&gt;  [#Port&lt;0.92614&gt;,{error,bad\\_encoding},5000]},
&gt;&gt;  {riak\\_kv\\_js\\_vm,invoke\\_js,2},
&gt;&gt;  {riak\\_kv\\_js\\_vm,define\\_invoke\\_anon\\_js,3},
&gt;&gt;  {riak\\_kv\\_js\\_vm,handle\\_call,3},
&gt;&gt;  {gen\\_server,handle\\_msg,5},
&gt;&gt;  {proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt;
&gt;&gt; =CRASH REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt;  crasher:
&gt;&gt;  initial call: riak\\_kv\\_js\\_vm:init/1
&gt;&gt;  pid: &lt;0.5996.21&gt;
&gt;&gt;  registered\\_name: []
&gt;&gt;  exception exit:
&gt;&gt; {function\\_clause,[{js\\_driver,eval\\_js,[#Port&lt;0.92614&gt;,{error,bad\\_encoding},5000]},{riak\\_kv\\_js\\_vm,invoke\\_js,2},{riak\\_kv\\_js\\_vm,define\\_invoke\\_anon\\_js,3},{riak\\_kv\\_js\\_vm,handle\\_call,3},{gen\\_server,handle\\_msg,5},{proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt;  in function gen\\_server:terminate/6
&gt;&gt;  in call from proc\\_lib:init\\_p\\_do\\_apply/3
&gt;&gt;  ancestors: [riak\\_kv\\_js\\_sup,riak\\_kv\\_sup,&lt;0.128.0&gt;]
&gt;&gt;  messages: []
&gt;&gt;  links: [&lt;0.142.0&gt;,&lt;0.6009.21&gt;]
&gt;&gt;  dictionary: []
&gt;&gt;  trap\\_exit: false
&gt;&gt;  status: running
&gt;&gt;  heap\\_size: 4181
&gt;&gt;  stack\\_size: 24
&gt;&gt;  reductions: 2586
&gt;&gt;  neighbours:
&gt;&gt;  neighbour: 
&gt;&gt; [{pid,&lt;0.6009.21&gt;},{registered\\_name,[]},{initial\\_call,{riak\\_kv\\_mapper,init,[Argument\\_\\_1]}},{current\\_function,{gen,do\\_call,4}},{ancestors,[riak\\_kv\\_mapper\\_sup,riak\\_kv\\_sup,&lt;0.128.0&gt;]},{messages,[]},{links,[&lt;0.5996.21&gt;,&lt;12337.6227.21&gt;,&lt;0.162.0&gt;]},{dictionary,[]},{trap\\_exit,false},{status,waiting},{heap\\_size,987},{stack\\_size,53},{reductions,1043}]
&gt;&gt; =SUPERVISOR REPORT==== 9-Jun-2011::21:37:05 ===
&gt;&gt; Supervisor: {local,riak\\_kv\\_js\\_sup}
&gt;&gt; Context: child\\_terminated
&gt;&gt; Reason:
&gt;&gt; {function\\_clause,[{js\\_driver,eval\\_js,[#Port&lt;0.92614&gt;,{error,bad\\_encoding},5000]},{riak\\_kv\\_js\\_vm,invoke\\_js,2},{riak\\_kv\\_js\\_vm,define\\_invoke\\_anon\\_js,3},{riak\\_kv\\_js\\_vm,handle\\_call,3},{gen\\_server,handle\\_msg,5},{proc\\_lib,init\\_p\\_do\\_apply,3}]}
&gt;&gt; Offender:
&gt;&gt; [{pid,&lt;0.5996.21&gt;},{name,undefined},{mfargs,{riak\\_kv\\_js\\_vm,start\\_link,undefined}},{restart\\_type,temporary},{shutdown,2000},{child\\_type,worker}]
&gt;&gt;
&gt;&gt; On Wed, Jun 22, 2011 at 6:10 PM, Ryan Zezeski &gt; (mailto:rzeze...@basho.com)&gt; wrote:
&gt;&gt; &gt;
&gt;&gt; &gt; Andrew,
&gt;&gt; &gt; Maybe you could elaborate on the error? I tested this against master 
&gt;&gt; &gt; (commit below) just now with success.
&gt;&gt; &gt; 2b1a474f836d962fa035f48c05452e22fc6c2193 Change dependency to allow for 
&gt;&gt; &gt; R14B03 as well as R14B02
&gt;&gt; &gt; -Ryan
&gt;&gt; &gt; On Wed, Jun 22, 2011 at 7:03 PM, Andrew Berman &gt; &gt; (mailto:rexx...@gmail.com)&gt; wrote:
&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt; Hello,
&gt;&gt; &gt; &gt; I'm having issues link walking using the Map Reduce link function. I am 
&gt;&gt; &gt; &gt; using HEAD from Git, so it's possible that's the issue, but here is what 
&gt;&gt; &gt; &gt; is happening.
&gt;&gt; &gt; &gt; I've got two buckets, user and user\\_email where user\\_email contains a 
&gt;&gt; &gt; &gt; link to the user.
&gt;&gt; &gt; &gt; When I run this:
&gt;&gt; &gt; &gt; {
&gt;&gt; &gt; &gt;  "inputs": [
&gt;&gt; &gt; &gt;  [
&gt;&gt; &gt; &gt;  "user\\_email",
&gt;&gt; &gt; &gt;  "myem...@email.com (mailto:myem...@email.com)"
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt;  ],
&gt;&gt; &gt; &gt;  "query": [
&gt;&gt; &gt; &gt;  {
&gt;&gt; &gt; &gt;  "link": {
&gt;&gt; &gt; &gt;  "bucket": "user",
&gt;&gt; &gt; &gt;  "tag": "user"
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt; }
&gt;&gt; &gt; &gt; I only get [["user","LikiWUPJSFuxtrhCYpsPfg","user"]] returned. The 
&gt;&gt; &gt; &gt; second I add a map function, even the simplest one (function(v) { [v] } 
&gt;&gt; &gt; &gt; I get a "map\\_reduce error":
&gt;&gt; &gt; &gt; {
&gt;&gt; &gt; &gt;  "inputs": [
&gt;&gt; &gt; &gt;  [
&gt;&gt; &gt; &gt;  "user\\_email",
&gt;&gt; &gt; &gt;  "myem...@email.com (mailto:myem...@email.com)"
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt;  ],
&gt;&gt; &gt; &gt;  "query": [
&gt;&gt; &gt; &gt;  {
&gt;&gt; &gt; &gt;  "link": {"bucket":"user", "tag":"user"}
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt; ,{
&gt;&gt; &gt; &gt;  "map": {
&gt;&gt; &gt; &gt;  "language": "javascript",
&gt;&gt; &gt; &gt;  "source": "function(v) { return[v]; }"
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  }
&gt;&gt; &gt; &gt;  ]
&gt;&gt; &gt; &gt; }
&gt;&gt; &gt; &gt; Is this functionality broken? I am following what it says on the Wiki 
&gt;&gt; &gt; &gt; for the MapRed version of link walking. When I use HTTP link walking, it 
&gt;&gt; &gt; &gt; works correctly.
&gt;&gt; &gt; &gt; Thanks,
&gt;&gt; &gt; &gt; Andrew
&gt;&gt; &gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; &gt; &gt; riak-users mailing list
&gt;&gt; &gt; &gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt; &gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;
&gt;
&gt;

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

