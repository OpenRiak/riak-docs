---
title: "RE: Secondary Index Map and reduce order and performance"
description: ""
project: community
lastmod: 2011-11-30T13:38:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05822"
mailinglist_parent_id: "msg05820"
author_name: "Sajithkumar Kizhakkiniyil"
project_section: "mailinglistitem"
sent_date: 2011-11-30T13:38:57-08:00
---


In my testing I did get the same result. My scenario is simple I created 200 
keys with the same 2i key/value and retrieved it.

Regards
Sajith


From: Alexander Sicular [mailto:sicul...@gmail.com]
Sent: Wednesday, November 30, 2011 1:32 PM
To: Sajithkumar Kizhakkiniyil
Cc: riak-users@lists.basho.com
Subject: Re: Secondary Index Map and reduce order and performance

Do you get the \\*same\\* results in both cases?

-Alexander Sicular

@siculars
http://siculars.posterous.com

On Nov 30, 2011, at 4:28 PM, Sajithkumar Kizhakkiniyil wrote:


Hello
Probably my understanding of M/R might be wrong. But I am getting drastic 
performance difference when running secondary index query on PB with map and 
reduce function in different order.
If my understanding is correct a reduce phase with 
riak\\_kv\\_mapreduce.reduce\\_identity is needed for secondary index query. I added 
one map phase to get the value instead of the key

But if I send the reduce before the map as you see in the map reduce payload 
JSON the values are return much faster than the other way. In my test it 251 ms 
vs 700ms. Anyone can explain this behavior.

Reduce before map (Faster)
-------
{"inputs":{"index":"PERFTEST\\_INDEX\\_NAME\\_bin","bucket":"\\_ITEST\\_SI\\_BUCKET","key":"PERFTEST\\_INDEX\\_VALUE"},"query":[{"reduce":{"arg":"{reduce\\_phase\\_only\\_1,
 
true}","module":"riak\\_kv\\_mapreduce","language":"erlang","keep":false,"function":"reduce\\_identity"}},{"map":{"source":"function(value,keyData,arg){
 return [value.values[0].data]; }","language":"javascript","keep":true}}]}

Map before reduce (Slower)
--------------
{"inputs":{"index":"PERFTEST\\_INDEX\\_NAME\\_bin","bucket":"\\_ITEST\\_SI\\_BUCKET","key":"PERFTEST\\_INDEX\\_VALUE"},"query":[{"map":{"source":"function(value,keyData,arg){
 return [value.values[0].data]; 
}","language":"javascript","keep":true}},{"reduce":{"arg":"{reduce\\_phase\\_only\\_1,
 
true}","module":"riak\\_kv\\_mapreduce","language":"erlang","keep":false,"function":"reduce\\_identity"}}]}


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
This message is private and confidential. If you have received it in error, 
please notify the sender and remove it from your system.


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
This message is private and confidential. If you have received it in error, 
please notify the sender and remove it from your system.

