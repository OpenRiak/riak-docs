---
title: "Map Reduce and long queries -"
description: ""
project: community
lastmod: 2012-10-14T04:57:32-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08910"
author_name: "David Montgomery"
project_section: "mailinglistitem"
sent_date: 2012-10-14T04:57:32-07:00
---


Hi,

Below is my code for running a map reduce in python. I have a six
node cluster, 2 cores each with 4 gigs for ram. I am no load and
about 3 Mill keys and using leveldb with riak 1.2. Doing the below
is taking a terribly long time. Never finished and I dont even know
how I can check if it is even running other than the python script has
not timed out. I look at the number of executed mappers in stats and
it is flat lined when looking at Graphite. On test queries the below
works.

So..how do I debug what is going on?


def main():
 client = 
riak.RiakClient(host=riak\\_host,port=8087,transport\\_class=riak.transports.pbc.RiakPbcTransport)
 query = client.add(bucket)
 filters = key\\_filter.tokenize(":", filter\\_map['date']) +
(key\\_filter.starts\\_with('201210'))
 #& key\\_filter.tokenize(":", filter\\_map['country']).eq("US") \\
 #& key\\_filter.tokenize(":", filter\\_map['campaign\\_id']).eq("t1") \\
 query.add\\_key\\_filters(filters)

 query.map('''
 function(value, keyData, arg) {
 var data = Riak.mapValuesJson(value)[0];

 if(data['adx']=='gdn'){
 var alt\\_key = data['hw'];
 var obj = {};
 obj[alt\\_key] = 1;
 return [ obj ];
 }else{
 return [];
 }


 }''')


 query.reduce('''
 function(values, arg){
 return [ values.reduce( function(acc, item) {
 for (var state in item) {
 if (acc[state])
 acc[state] += item[state];
 else
 acc[state] = item[state];
 }
 return acc;
 })];
 }
 ''')

 for result in query.run(timeout=300000):
 print result

