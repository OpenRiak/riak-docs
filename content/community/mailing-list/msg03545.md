---
title: "Re: Interesting sawtooth increasing CPU usage on lightly-used Riak	cluster on EC2 micro instances. Is this expected?"
description: ""
project: community
lastmod: 2011-06-03T14:11:37-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg03545"
mailinglist_parent_id: "msg03495"
author_name: "Mark Phillips"
project_section: "mailinglistitem"
sent_date: 2011-06-03T14:11:37-07:00
---


Hi Eamonn,

Without having the chance to think too hard about this, here is what
might be going on:

There was an issue with 0.14.0 related to the "/stats" resource
leading to increased CPU usage over time.[1] This is fixed in the
latest release of version.

Couple that with the fact that you're running EC2 Micros on unbuntu
10.04, and that might just explain the increased CPU usage.

Your best bet is to probably upgrade to 0.14.2 (if you haven't
already) and see if that doesn't mollify or even eliminate the issue.

Hope that helps.

Mark

1 - https://issues.basho.com/show\\_bug.cgi?id=971


On Mon, May 30, 2011 at 10:52 AM, Eamonn  wrote:
&gt; I have a cluster of six Riak nodes that has been operating for a few months
&gt; on Amazon EC2.   Because this is a development deployment with very light
&gt; usage currently, I have used cheap "micro" instances.
&gt;
&gt; I am using  riak\\_0.14.0-1\\_amd64.deb with no changes to the default
&gt; app.config except to modify the IP addresses.
&gt;
&gt; If you look at the graph of CPU usage for these instances over the last two
&gt; weeks
&gt;  http://eamonn.org/riak/riak-cluster-cpu.png
&gt; you see an interesting pattern.
&gt;
&gt; Each node gradually increases its CPU over about two days and then suddenly
&gt; drops down slightly, forming a saw-tooth pattern.  From an initial low
&gt; average CPU several months ago, the CPU usage has now slowly risen.   It now
&gt; seems to have reached an equilibrium, with three of the nodes at 50% and
&gt; three at 60%.
&gt;
&gt; Most of this usage happens when the cluster is not being used externally.
&gt;  The little spikes you see on the graph are probably the actual external
&gt; access via the REST API.
&gt;
&gt; I assume this activity is caused by the continuous "gossip" between the
&gt; nodes.  Perhaps the different equilibrium CPU percentages are related to
&gt; which share of the data items each node has.  Is the sawtooth pattern
&gt; showing some kind of garbage collection?
&gt;
&gt; The Riak cluster does seem to work correctly with reasonable latency, at
&gt; least under low load.  (I have not yet done load-testing).
&gt;
&gt; Is this pattern expected?   Is it a sign of some problem with my
&gt; configuration?  Any suggestions for how to tune the cluster to run better on
&gt; EC2 micro instances?  Any suggestions of what metrics to use to decide when
&gt; to dynamically scale the cluster by spinning up nodes or spinning them down?
&gt;
&gt; Thanks,
&gt; \\_\\_
&gt; Eamonn O'Brien-Strain
&gt; HP Labs
&gt;
