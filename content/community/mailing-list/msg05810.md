---
title: "Re: Unexpected issue w/ m/r Riak.reduceSlice"
description: ""
project: community
lastmod: 2011-11-30T07:47:31-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05810"
mailinglist_parent_id: "msg05795"
author_name: "Jonathan Langevin"
project_section: "mailinglistitem"
sent_date: 2011-11-30T07:47:31-08:00
---


Based on a quite helpful tip from Sean via another thread, here's my
working solution :-)
It was indeed an issue with how batches were being processed, so running
the reduce phase as run-once, fixes the issue.

{
 "inputs":"demo\\_3\\_Course",
 "query":[
 {
 "map":{
 "keep":true,
 "language":"javascript",
 "arg":null,
 "source":"function(value){return [value.key];}"
 }
 },
 {
 "reduce":{
 "keep":true,
 "language":"javascript",
 "arg":{"sort":"function(a,b){
 if (a &lt; b) {
 return -1;
 } else if (a === b) {
 return 0;
 } else if (a &gt; b) {
 return 1;
 }
 }","slice":[80,85],"reduce\\_phase\\_only\\_1":true},
 "source":"function(values,arg){return
Riak.reduceSlice(Riak.reduceSort(values,arg[\\"sort\\"]),arg[\\"slice\\"]);}"
 }
 }
 ]
}
\\*


 
 Jonathan Langevin
Manager, Information Technology
Loom Inc.
Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com -
www.loomlearning.com - Skype: intel352
\\*


On Tue, Nov 29, 2011 at 6:07 PM, Jonathan Langevin &lt;
jlange...@loomlearning.com&gt; wrote:

&gt; I suppose I should instead stream the list of keys to client, slice keys
&gt; in client, then fetch the objects, right?
&gt; On Nov 29, 2011 5:21 PM, "Jonathan Langevin" 
&gt; wrote:
&gt;
&gt;&gt; When attempting to run m/r queries that execute Riak.reduceSlice to
&gt;&gt; create paginated result sets, I've found an unexpected result.
&gt;&gt;
&gt;&gt; For instance, if I call Riak.reduceSlice with start = 80, end = 85, which
&gt;&gt; you would expect to return 5 results (knowing that you have a total of 115
&gt;&gt; objects stored in Riak), you might instead get 16 objects returned back.
&gt;&gt; This is due to the logic of Riak.reduceSlice, which just returns the
&gt;&gt; results-thus-far when it finds that the end value (85) is greater than the
&gt;&gt; current length of value (16 objects).
&gt;&gt;
&gt;&gt; I suppose ultimately this is due to how Riak sends data in chunks between
&gt;&gt; phases (at least, that's my understanding)? So it happens to send a small
&gt;&gt; chunk of 16 results from the map phase to the reduce phase, and reduce
&gt;&gt; returns back the current "value" chunk since 16 results is less than 85
&gt;&gt; results...
&gt;&gt;
&gt;&gt;
&gt;&gt; How can I plan for this, so that I can ensure I'm getting the expected #
&gt;&gt; results back, and in fair context to the "page" of results that I should be
&gt;&gt; viewing?
&gt;&gt; And just a note, while I tested with & without sorted results, the final
&gt;&gt; code would be with sorted results that are then paginated.
&gt;&gt;
&gt;&gt;
&gt;&gt; Example data payload:
&gt;&gt; {
&gt;&gt; "inputs":"demo\\_3\\_Course",
&gt;&gt; "query":[
&gt;&gt; {
&gt;&gt; "map":{
&gt;&gt; "keep":false,
&gt;&gt; "language":"javascript",
&gt;&gt; "arg":null,
&gt;&gt; "source":"function(value){return [value.key];}"
&gt;&gt; }
&gt;&gt; },
&gt;&gt; {
&gt;&gt; "reduce":{
&gt;&gt; "keep":true,
&gt;&gt; "language":"javascript",
&gt;&gt; "arg":[
&gt;&gt; 80,
&gt;&gt; 85
&gt;&gt; ],
&gt;&gt; "name":"Riak.reduceSlice"
&gt;&gt; }
&gt;&gt; }
&gt;&gt; ]
&gt;&gt; }
&gt;&gt; \\*
&gt;&gt;
&gt;&gt; 
&gt;&gt; Jonathan Langevin
&gt;&gt; Manager, Information Technology
&gt;&gt; Loom Inc.
&gt;&gt; Wilmington, NC: (910) 241-0433 - jlange...@loomlearning.com -
&gt;&gt; www.loomlearning.com - Skype: intel352
&gt;&gt; \\*
&gt;&gt;
&gt;
