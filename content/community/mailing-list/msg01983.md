---
title: "Fwd: Riak Recap for Jan. 12 - 13."
description: ""
project: community
lastmod: 2011-01-14T16:58:26-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg01983"
mailinglist_parent_id: "msg01982"
author_name: "Neville Burnell"
project_section: "mailinglistitem"
sent_date: 2011-01-14T16:58:26-08:00
---


oops, forgot to include the list

&gt;&gt; This sucks, so as an optimization you decided that if a majority of the
cluster thinks it's X, well then it must be X! I'm not sure I explained
that well, but I'm sure I understand it now :)

All true, except when Riak knows X is out of date, and Y is the correct
value, and forces read repair with Y, but returns X which sucks, because a
KV can be Found, Not Found, and Found, when you need it to
be continuously found.

Note, I dont mind that an out of date version is returned by Riak - that I
can handle. But a 404 for a KV that actually exists is a problem for me.

 On 15 January 2011 11:49, Ryan Zezeski  wrote:

&gt;
&gt;
&gt; On Fri, Jan 14, 2011 at 7:12 PM, Sean Cribbs  wrote:
&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; Crap, the second after I hit "send" the lightbulb goes on! Why is that?
&gt;&gt;
&gt;&gt; The quorum \\_was\\_ met (all vnodes just migrated to the one machine) but
&gt;&gt; since some of them were fail-overs they didn't have the value yet (or the
&gt;&gt; wrong value)? In this case a read repair happened and subsequent gets
&gt;&gt; worked.
&gt;&gt;
&gt;&gt;
&gt;&gt; Your understanding is correct. However, when I say "quorum was met" I
&gt;&gt; usually mean that "it had R successful replies". Minor semantic quibble.
&gt;&gt;
&gt;&gt; You are correct in saying that the wiki is misleading -- read repair
&gt;&gt; happens when any successful reply reaches the FSM, even if "not found" was
&gt;&gt; returned to the client, that is, if quorum was not met. We'll get that
&gt;&gt; fixed.
&gt;&gt;
&gt;&gt; I'm still dark on the second question.
&gt;&gt;
&gt;&gt;
&gt;&gt;&gt; 2) Why doesn't r=1 work?
&gt;&gt;&gt;
&gt;&gt;&gt; In the IRC session, you claimed that r=1 would not have helped this
&gt;&gt;&gt; problem. Just like the OP, this confused me. You then went on to say it
&gt;&gt;&gt; was because of some optimization and then mentioned a "basic quorum."
&gt;&gt;&gt;
&gt;&gt;&gt; I took a few minutes to think about this and the only conclusion I came
&gt;&gt;&gt; to is that when r=1 you will treat the first response as the final response,
&gt;&gt;&gt; and in this case the notfound response will always come back first? I'm not
&gt;&gt;&gt; sure if what I just said makes sense but I would have expected r=1 to work,
&gt;&gt;&gt; just like the OP. I'll admit that I still haven't read all the wiki docs
&gt;&gt;&gt; yet (but I've read Read Repair 3 times now), so I'd be happy to hear RTFM.
&gt;&gt;&gt;
&gt;&gt;
&gt;&gt; A number of months ago, we ran into some issues with a cluster where "not
&gt;&gt; found" responses were not returning in a reasonable amount of time,
&gt;&gt; especially when R=1. That is, the requests took MUCH longer than a
&gt;&gt; SUCCESSFUL read. We determined that this occurred because one of the
&gt;&gt; partitions was too busy to reply, causing the request timeout to expire. So
&gt;&gt; we added a special case called "basic quorum" (n\\_val/2 + 1) that is invoked
&gt;&gt; only when receiving a "not found" response from a replica. The idea is that
&gt;&gt; if a simple majority of the replica partitions report "not found", it's
&gt;&gt; probably not there. This way, you don't sit around waiting for the last
&gt;&gt; lonely partition to reply when R=1 (and your successful reads are still fast
&gt;&gt; because you only wait for one replica). It's a tradeoff of availability:
&gt;&gt; returning a potentially incorrect response vs. appearing unavailable (timing
&gt;&gt; out). We chose the former.
&gt;&gt;
&gt;&gt; Hope that helps,
&gt;&gt;
&gt;
&gt;
&gt; Reading your explanation made me realize it's because I'm mucking up
&gt; the semantics of "quorum." It was previously my understanding that if R=1
&gt; then you only need a quorum of 1 vnode, where a quorum is simply defined as
&gt; a response. Which would mean that the first reply (whether notfound or a
&gt; value) would be considered the cluster value. However, as you subtly hinted
&gt; to above, quorum does not mean that, i.e. it's more than just a response.
&gt; It's that R vnodes found \\_a\\_ value and agreed on it's contents. Going back
&gt; to the case of R=1, N=3, and the value is missing on 2 of it's preferred
&gt; vnodes it means that the request will take as long as the longest vnode to
&gt; respond, even if 2 vnodes reply immediately with no value. This sucks, so
&gt; as an optimization you decided that if a majority of the cluster thinks it's
&gt; X, well then it must be X! I'm not sure I explained that well, but I'm sure
&gt; I understand it now :)
&gt;
&gt;
&gt; -Ryan
&gt;
&gt;

