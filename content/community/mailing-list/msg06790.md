---
title: "Re: basho_metrics re-entrant?"
description: ""
project: community
lastmod: 2012-02-29T14:58:23-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06790"
mailinglist_parent_id: "msg06789"
author_name: "Bob Ippolito"
project_section: "mailinglistitem"
sent_date: 2012-02-29T14:58:23-08:00
---


I don't believe that you'll be able to store these NIF instances in
mochiglobal. You can only store things that can be represented as BEAM code.

On Wed, Feb 29, 2012 at 2:46 PM, Joel Meyer  wrote:

&gt; Hello,
&gt;
&gt; I'd like to capture statistics on all calls to my riak\\_core service and
&gt; the execution time of vnode commands. I looked at folsom\\_metrics, but for a
&gt; service that does 10-30k QPS I'm concerned about the overhead introduced of
&gt; doing ets calls. Given that, my current plan was to create several
&gt; basho\\_metrics on startup and store the opaque refs using mochiglobal. Then
&gt; my service will make module calls to update the metrics. Will using
&gt; basho\\_metrics in that matter cause problems?
&gt;
&gt; Here's what I'm thinking:
&gt;
&gt; -module(freqserver\\_stats).
&gt;
&gt; -export([ init/0,
&gt; vnode\\_count/1,
&gt; ... ]).
&gt;
&gt; -define( VNODE\\_COUNT, freqserver\\_stats\\_vnode\\_count ).
&gt;
&gt;
&gt; ...
&gt;
&gt; -define( METRICS,
&gt; [ { ?VNODE\\_COUNT, histogram },
&gt; ... ] ).
&gt;
&gt; -define( STAT(Name), mochiglobal:get(Name) ).
&gt;
&gt; init() -&gt;
&gt;
&gt;
&gt; F = fun( { S, Type } , \\_ ) -&gt;
&gt; Ref = case Type of
&gt; histogram -&gt; basho\\_metrics\\_nifs:histogram\\_new();
&gt; meter -&gt; basho\\_metrics\\_nifs:meter\\_new()
&gt; end,
&gt; ok = mochiglobal:put( S, Ref )
&gt; end,
&gt; lists:foldl( F, [], ?METRICS ).
&gt;
&gt; vnode\\_count( Micros ) -&gt;
&gt; basho\\_metrics\\_nifs:histogram\\_update( ?STAT( ?VNODE\\_COUNT ), Micros ).
&gt;
&gt; I'm also open to better ideas, if people have them. I'm concerned about
&gt; back pressure and/or overflowing the message queue if I dedicate a process
&gt; to handling these statistics. Let me know if I'm needlessly concerned about
&gt; that.
&gt;
&gt; Thanks,
&gt; Joel
&gt;

