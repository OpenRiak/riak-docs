---
title: "RE: Timeout when storing"
description: ""
project: community
lastmod: 2011-10-01T12:59:15-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04971"
mailinglist_parent_id: "msg04941"
author_name: "Jim Adler"
project_section: "mailinglistitem"
sent_date: 2011-10-01T12:59:15-07:00
---


After upgrading my single-node instance to 1.0, I'm still seeing the "timeout 
when storing" issue. Here are the changes I made based on everyone's 
suggestions (much appreciated!):

- Ubuntu 11.04 (natty) 32-bit
- Python client 1.3.0
- /etc/riak/vm.args: -env ERL\\_MAX\\_PORTS 32768
- /etc/default/riak: ulimit -n 32768

Here's the /var/log/crash.log report:

2011-10-01 12:31:03 =ERROR REPORT====
\\*\\* State machine &lt;0.3452.0&gt; terminating 
\\*\\* Last event in was 
{'riak\\_vnode\\_req\\_v1',1136089163393944065322395631681798128560666312704,{fsm,undefined,&lt;0.3451.0&gt;},{'riak\\_kv\\_put\\_req\\_v1',{&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"user\\_id-17527747-info"&gt;&gt;},{r\\_object,&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"user\\_id-17527747-info"&gt;&gt;,[{r\\_content,{dict,4,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,116,105,111,110,47,106,115,111,110],[&lt;&lt;"X-Riak-VTag"&gt;&gt;,49,88,88,75,75,51,90,88,68,117,90,122,85,53,57,85,53,101,107,89,115,110]],[[&lt;&lt;"index"&gt;&gt;]],[],[[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|{1317,497463,847242}]],[],[]}}},&lt;&lt;"{DATA
 
DELETED}"&gt;&gt;}],[],{dict,1,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[[clean|true]],[]}}},undefined},51456853,63484716663,[coord]}}
\\*\\* When State == active
\\*\\* Data == 
{state,1136089163393944065322395631681798128560666312704,riak\\_kv\\_vnode,{state,1136089163393944065322395631681798128560666312704,false,riak\\_kv\\_bitcask\\_backend,{state,#Ref&lt;0.0.0.10359&gt;,"1136089163393944065322395631681798128560666312704",[{async\\_folds,true},[{vnode\\_vclocks,true},{included\\_applications,[]},{add\\_paths,[]},{allow\\_strfun,false},{storage\\_backend,riak\\_kv\\_bitcask\\_backend},{legacy\\_keylisting,false},{reduce\\_js\\_vm\\_count,6},{js\\_thread\\_stack,16},{pb\\_ip,"0.0.0.0"},{riak\\_kv\\_stat,true},{map\\_js\\_vm\\_count,8},{mapred\\_system,pipe},{js\\_max\\_vm\\_mem,8},{pb\\_port,8087},{legacy\\_stats,true},{mapred\\_name,"mapred"},{stats\\_urlpath,"stats"},{http\\_url\\_encoding,on},{hook\\_js\\_vm\\_count,2}],{read\\_write,true}],1136089163393944065322395631681798128560666312704,"/var/lib/riak/bitcask"},{dict,0,16,16,8,80,48,{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},{{[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]}}},&lt;&lt;35,9,254,249,78,135,82,106&gt;&gt;,3000,1000,100,100,true,false},undefined,undefined,none,undefined,&lt;0.3454.0&gt;,60000}
\\*\\* Reason for termination = 
\\*\\* {bad\\_return\\_value,{error,{write\\_locked,emfile}}}
2011-10-01 12:31:03 =CRASH REPORT====
 crasher:
 initial call: riak\\_core\\_vnode:init/1
 pid: &lt;0.3452.0&gt;
 registered\\_name: []
 exception exit: {bad\\_return\\_value,{error,{write\\_locked,emfile}}}
 in function gen\\_fsm:terminate/7
 in call from proc\\_lib:init\\_p\\_do\\_apply/3
 ancestors: [riak\\_core\\_vnode\\_sup,riak\\_core\\_sup,&lt;0.92.0&gt;]
 messages: [{'EXIT',&lt;0.3454.0&gt;,shutdown}]
 links: [&lt;0.96.0&gt;]
 dictionary: []
 trap\\_exit: true
 status: running
 heap\\_size: 6765
 stack\\_size: 24
 reductions: 160650
 neighbours:
2011-10-01 12:31:03 =SUPERVISOR REPORT====
 Supervisor: {local,riak\\_core\\_vnode\\_sup}
 Context: child\\_terminated
 Reason: {bad\\_return\\_value,{error,{write\\_locked,emfile}}}
 Offender: 
[{pid,&lt;0.3452.0&gt;},{name,undefined},{mfargs,{riak\\_core\\_vnode,start\\_link,undefined}},{restart\\_type,temporary},{shutdown,300000},{child\\_type,worker}]

2011-10-01 12:45:28 =ERROR REPORT====
Failed to merge 
"/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1315770213.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316329673.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316330222.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316879145.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1316995340.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1317493005.bitcask.data/var/lib/riak/bitcask/605153021707326989568713251046585937826284568576/1317495168.bitcask.data":
 
{{badmatch,{error,emfile}},[{bitcask,'-merge1/3-lc$^0/1-1-',1},{bitcask,'-merge1/3-lc$^0/1-1-',1},{bitcask,'merge1',3},{bitcask\\_merge\\_worker,do\\_merge,1}]}


-----Original Message-----
From: David Smith [mailto:diz...@basho.com]
Sent: Fri 9/30/2011 9:56 AM
To: Jim Adler
Cc: Sean Cribbs; riak-users@lists.basho.com
Subject: Re: Timeout when storing
 
IIRC, {error, emfile} indicates that the max # of ports (in the erlang
VM) is being exceeded. Try bumping up ERL\\_MAX\\_PORTS in vm.args.

D.

On Thu, Sep 29, 2011 at 10:52 PM, Jim Adler  wrote:
&gt; Thanks Sean.  I added the ulimit -n 10240 to /etc/default/riak, restarted
&gt; riak, but that didn't work.
&gt;
&gt; Fyodor Yarochkin suggested that the bitcask files could be corrupted, but I
&gt; wasn't sure which bitcask \\*.data or \\*.hint file to delete.  Any pointers?
&gt;
&gt; Here's the /var/log/riak/erlang.log:
&gt;
&gt; =ERROR REPORT==== 29-Sep-2011::20:27:42 ===
&gt; \\*\\* State machine &lt;0.369.0&gt; terminating
&gt; \\*\\* Last event in was {riak\\_vnode\\_req\\_v1,
&gt;                       941983477185933521498468739836666790012612771840,
&gt;                       {fsm,undefined,&lt;0.27704.1&gt;},
&gt;                       {riak\\_kv\\_put\\_req\\_v1,
&gt;                        {&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"screen\\_name-psych\\_ic-info"&gt;&gt;},
&gt;
&gt; {r\\_object,&lt;&lt;"nodes"&gt;&gt;,&lt;&lt;"screen\\_name-psych\\_ic-info"&gt;&gt;,
&gt;                         [{r\\_content,
&gt;                           {dict,3,16,16,8,80,48,
&gt;
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;                            {{[],[],[],[],[],[],[],[],[],[],
&gt;                              [[&lt;&lt;"content-type"&gt;&gt;,97,112,112,108,105,99,97,
&gt;                                116,105,111,110,47,106,115,111,110],
&gt;
&gt; [&lt;&lt;"X-Riak-VTag"&gt;&gt;,49,90,120,65,84,100,56,99,48,
&gt;                                80,86,99,111,122,71,79,108,90,70,97,53,87]],
&gt;                              [],[],
&gt;                              [[&lt;&lt;"X-Riak-Last-Modified"&gt;&gt;|
&gt;                                {1317,353201,695471}]],
&gt;                              [],[]}}},
&gt;                           &lt;&lt;"{DELETED DATA}"&gt;&gt;}],
&gt;                         [{&lt;&lt;2,65,205,48&gt;&gt;,{1,63484572401}}],
&gt;                         {dict,1,16,16,8,80,48,
&gt;                          {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]},
&gt;                          {{[],[],[],[],[],[],[],[],[],[],[],[],[],[],
&gt;                            [[clean|true]],
&gt;                            []}}},
&gt;                         undefined},
&gt;                        1174401,63484572401,
&gt;                        [{returnbody,true}]}}
&gt; \\*\\* When State == active
&gt; \\*\\*      Data  == {state,941983477185933521498468739836666790012612771840,
&gt;                         riak\\_kv\\_vnode,
&gt;
&gt; {state,941983477185933521498468739836666790012612771840,
&gt;                                riak\\_kv\\_bitcask\\_backend,
&gt;                                {#Ref&lt;0.0.0.3952&gt;,
&gt;
&gt; "/var/lib/riak/bitcask/941983477185933521498468739836666790012612771840"},
&gt;                                {dict,0,16,16,8,80,48,
&gt;
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],
&gt;                                       [],[],[]},
&gt;
&gt; {{[],[],[],[],[],[],[],[],[],[],[],[],[],
&gt;                                        [],[],[]}}},
&gt;                                false},
&gt;                         undefined,none,60000}
&gt; \\*\\* Reason for termination =
&gt; \\*\\* {{badmatch,{error,emfile}},
&gt;     [{bitcask\\_fileops,create\\_file\\_loop,3},
&gt;      {bitcask,put,3},
&gt;      {riak\\_kv\\_bitcask\\_backend,put,3},
&gt;      {riak\\_kv\\_vnode,perform\\_put,3},
&gt;      {riak\\_kv\\_vnode,do\\_put,7},
&gt;      {riak\\_kv\\_vnode,handle\\_command,3},
&gt;      {riak\\_core\\_vnode,vnode\\_command,3},
&gt;      {gen\\_fsm,handle\\_msg,7}]}
&gt;
&gt;
&gt;
&gt; -----Original Message-----
&gt; From: Sean Cribbs [mailto:s...@basho.com]
&gt; Sent: Thu 9/29/2011 3:02 PM
&gt; To: Jim Adler
&gt; Cc: riak-users@lists.basho.com
&gt; Subject: Re: Timeout when storing
&gt;
&gt; Your environment has too few file handles.  Retry starting riak after
&gt; setting `ulimit -n 1024` in the shell.  Also see our wiki page about this
&gt; issue: http://wiki.basho.com/Open-Files-Limit.html  You may need to set this
&gt; limit specifically for the 'riak' user.
&gt;
&gt; Cheers,
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt;


-- 
Dave Smith
Director, Engineering
Basho Technologies, Inc.
diz...@basho.com

