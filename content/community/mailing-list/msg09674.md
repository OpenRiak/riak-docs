---
title: "Re: Keyfilters. I cant get date ranges to work using key filters"
description: ""
project: community
lastmod: 2012-12-24T14:04:29-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09674"
mailinglist_parent_id: "msg09672"
author_name: "David Montgomery"
project_section: "mailinglistitem"
sent_date: 2012-12-24T14:04:29-08:00
---


OMG......now I get how to use 2i in map reduce. For the life of me I could
never get it to click in my brain. Anyway....it worked. Very cool.

Nonetheless I am still curious about why using key filters would not work.

Thanks


On Mon, Dec 24, 2012 at 8:57 PM, Sean Cribbs  wrote:

&gt; David,
&gt;
&gt; Perhaps key filters are the wrong approach. Are you using the LevelDB
&gt; backend? If so, then a secondary index lookup on the special '$key'
&gt; index is what you need. I can't tell from your examples above what
&gt; language/client you're using but here's how the raw inputs would look
&gt; in the JSON:
&gt;
&gt; {
&gt; "bucket":"yourbucket", // change this to your bucket name
&gt; "index":"$key",
&gt; "start":"2012123000", // beginning of your range
&gt; "end":"2012122323" // end of your range
&gt; }
&gt;
&gt; Not only is this simpler to express, but it also limits the range of
&gt; scans done in the backend, meaning your queries shouldn't take as long
&gt; to complete.
&gt;
&gt; On Mon, Dec 24, 2012 at 2:16 AM, David Montgomery
&gt;  wrote:
&gt; &gt; Thanks,
&gt; &gt;
&gt; &gt; If I use a logical & I get no data.
&gt; &gt;
&gt; &gt; If I just use a greater than than it works.
&gt; &gt;
&gt; &gt; date\\_start = '2012122300'
&gt; &gt; date\\_end = '2012122323'
&gt; &gt;
&gt; &gt; filters = key\\_filter.tokenize(":",
&gt; &gt; filter\\_map['date']).greater\\_than\\_eq(date\\_start) &
&gt; key\\_filter.tokenize(":",
&gt; &gt; filter\\_map['date']).less\\_than\\_eq(date\\_end)
&gt; &gt; query.add\\_key\\_filters(filters)
&gt; &gt;
&gt; &gt;
&gt; &gt; filters = key\\_filter.tokenize(":", 4) +
&gt; &gt; (key\\_filter.string\\_to\\_int().greater\\_than\\_eq(date\\_start))
&gt; &gt; query.add\\_key\\_filters(filters)
&gt; &gt;
&gt; &gt; I event tried between
&gt; &gt;
&gt; &gt; filters = key\\_filter.tokenize(":", 4) +
&gt; &gt; (key\\_filter.between(date\\_start,date\\_end))
&gt; &gt; query.add\\_key\\_filters(filters)
&gt; &gt; print filters
&gt; &gt;
&gt; &gt; These are the results for one day. I am really at a loss as to why I
&gt; cant
&gt; &gt; get riak to work with what should be very simple logical conditions
&gt; &gt;
&gt; &gt; cid5989410021||null||2012122314 1
&gt; &gt; cid5989410021||null||2012122306 1
&gt; &gt; cid5989410021||www.sonems.net||2012122305 1
&gt; &gt; cid5989410021||www.ke5ter.com||2012122406 1
&gt; &gt; cid5989410021||mobile.brothersoft.com||2012122315 1
&gt; &gt; cid5989410021||www.renotalk.com||2012122315 1
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; query.map('''
&gt; &gt; function(value, keyData, arg) {
&gt; &gt;
&gt; &gt; if(value.length == 0){
&gt; &gt; return [];
&gt; &gt; }else{
&gt; &gt;
&gt; &gt; var data = Riak.mapValuesJson(value)[0];
&gt; &gt; var obj = {};
&gt; &gt; var xs = value.key.split(':');
&gt; &gt; var dt = xs[3];
&gt; &gt; if(data['adx']=='gdn'){
&gt; &gt; try{
&gt; &gt; var matches =
&gt; &gt; data['url'].match(/^https?\\:\\/\\/([^\\/?#]+)(?:[\\/?#]|$)/i);
&gt; &gt; var domain = matches && matches[1];
&gt; &gt; var alt\\_key = data['campaign\\_id'] + '||' + domain +
&gt; '||'
&gt; &gt; + dt;
&gt; &gt; }
&gt; &gt; catch(err){
&gt; &gt; var alt\\_key = 'error';
&gt; &gt; }
&gt; &gt; var obj = {};
&gt; &gt; obj[alt\\_key] = 1;
&gt; &gt; return [ obj ];
&gt; &gt; }else{
&gt; &gt; return [];
&gt; &gt; }
&gt; &gt; }
&gt; &gt; }''')
&gt; &gt;
&gt; &gt; reducer = """
&gt; &gt; function(values, arg){
&gt; &gt;
&gt; &gt; if(values.length == 0){
&gt; &gt; return [{}]
&gt; &gt; }
&gt; &gt; return [ values.reduce( function(acc, item) {
&gt; &gt; for (var state in item) {
&gt; &gt; if (acc[state])
&gt; &gt; acc[state] += item[state];
&gt; &gt; else
&gt; &gt; acc[state] = item[state];
&gt; &gt; }
&gt; &gt; return acc;
&gt; &gt; })];
&gt; &gt; }
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; On Mon, Dec 24, 2012 at 7:19 AM, Evan Vigil-McClanahan
&gt; &gt;  wrote:
&gt; &gt;&gt;
&gt; &gt;&gt; It looks to me like your error is here:
&gt; &gt;&gt;
&gt; &gt;&gt; &gt; filters = key\\_filter.tokenize(":", 4) +
&gt; &gt;&gt; &gt; (key\\_filter.starts\\_with('20121223') and
&gt; &gt;&gt; &gt; key\\_filter.string\\_to\\_int().less\\_than(2012122423))
&gt; &gt;&gt;
&gt; &gt;&gt; The 'and' there is getting interpreted as a logical and:
&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;&gt; key\\_filter.starts\\_with('20121223') and
&gt; &gt;&gt; &gt;&gt;&gt; key\\_filter.string\\_to\\_int().less\\_than(2012122423)
&gt; &gt;&gt; [['string\\_to\\_int'], ['less\\_than', 2012122423]]
&gt; &gt;&gt;
&gt; &gt;&gt; You have to use the sadly non-idiomatic '&' to get it to do what
&gt; &gt;&gt; you're trying to do:
&gt; &gt;&gt;
&gt; &gt;&gt; &gt;&gt;&gt; key\\_filter.tokenize(":", 4) + (key\\_filter.starts\\_with('20121223') &
&gt; &gt;&gt; &gt;&gt;&gt; key\\_filter.string\\_to\\_int().less\\_than(2012122423))
&gt; &gt;&gt; [['tokenize', ':', 4], ['and', [['starts\\_with', '20121223']],
&gt; &gt;&gt; [['string\\_to\\_int'], ['less\\_than', 2012122423]]]]
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Software Engineer
&gt; Basho Technologies, Inc.
&gt; http://basho.com/
&gt;
