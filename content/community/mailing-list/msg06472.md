---
title: "Re: documents disappear from riak search index"
description: ""
project: community
lastmod: 2012-01-31T07:34:57-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06472"
mailinglist_parent_id: "msg06283"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2012-01-31T07:34:57-08:00
---


On Tue, Jan 31, 2012 at 7:44 AM, francisco treacy &lt;
francisco.tre...@gmail.com&gt; wrote:
&gt;
&gt;
&gt; db.get('user\\_books', 'maya012-8542')
&gt; =&gt; { }
&gt;

I'm assuming this does not represent an empty object


&gt;
&gt; It's found, k/v works at least.
&gt;
&gt; db.addSearch('user\\_books', 'bookId:8542 AND userId:maya012').reduce({
&gt; language: 'erlang', module: 'riak\\_kv\\_mapreduce', function:
&gt; 'reduce\\_identity' }).run(function(err,d) { console.log(d.length) })
&gt; =&gt; 0
&gt;
&gt; Uh oh, nothing there. Let's see what we have:
&gt;
&gt; db.addSearch('user\\_books', 'userId:maya0121').reduce({ language:
&gt; 'erlang', module: 'riak\\_kv\\_mapreduce', function: 'reduce\\_identity'
&gt; }).run(function(err,d) { console.log(d) })
&gt; =&gt; [ [ 'user\\_books', 'maya012-8528' ] ]
&gt;

What about when you run a query on just userId?


&gt;
&gt; Aha. User is supposed to have 2 books but has one. Let's see if
&gt; there's a disparity between counts in K/V and search:
&gt;
&gt; db.add('user\\_books').map('query', 'where
&gt; .bookId:val("8542")').run(function(err, d) { console.log(d.length) })
&gt; =&gt; 660
&gt;
&gt; db.addSearch('user\\_books', 'bookId:8542').reduce({ language: 'erlang',
&gt; module: 'riak\\_kv\\_mapreduce', function: 'reduce\\_identity'
&gt; }).run(function(err,d) { console.log(d.length) })
&gt; =&gt; 660
&gt;
&gt; WTH? It seems that 'userId' is introducing some weirdness here.
&gt;

If Search is missing replicas then results will become non-deterministic
and sometimes you will see correct results and other times you won't. If
you run this query many times back-to-back and see different results then
you are losing data somewhere.


&gt;
&gt; I fetched/saved the document, and now things are back to normal...
&gt;
&gt; db.addSearch('user\\_books', 'bookId:8542 AND userId:maya012').reduce({
&gt; language: 'erlang', module: 'riak\\_kv\\_mapreduce', function:
&gt; 'reduce\\_identity' }).run(function(err,d) { console.log(d.length) })
&gt; =&gt; 1
&gt;

What happens if you rerun the bookId query and search? Do they both still
return 660 or is it now 661? Next time you run into this I'd like to see
the results of \\_all\\_ the queries before and after. Also, run the search
query many times back-to-back and verify the answer is always the same.

&gt;
&gt; ...for maya012. Go figure how many other users are getting incorrect
&gt; data. Oh yea, I need to write another script to check them one by one.
&gt;
&gt; I waded through the logs, because there are tons of errors regarding
&gt; Luwak... (oh right, that too! Probably 5% of the files return 0 bytes,
&gt; awesome â€“ but I digress) ... and can't find anything that is even
&gt; close to be search-related.
&gt;

Considering you seem to have both Search and Luwak data disappearing I'm a
bit concerned that it's not just coincidence. What type of hardware are
you running on? What's your network like between these machines? What
does your app.config look like (and is it the same across the cluster)?
 What does your Search schema look like for user\\_books? What does
`riak-admin status` show you? What about `riak-admin ringready` and
`riak-admin transfers`? While we are at it `riak-admin cluster\\_info
/tmp/cluster\\_info.txt` couldn't hurt to try as well.
