---
title: "Re: riak_core: different types of commands"
description: ""
project: community
lastmod: 2011-12-27T09:48:09-08:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg06077"
mailinglist_parent_id: "msg06067"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2011-12-27T09:48:09-08:00
---


Adam, comments inline.

On Sat, Dec 24, 2011 at 7:04 AM, Adam Schepis wrote:
&gt;
&gt;
&gt; What is the difference between the different ways to send a command in
&gt; riak\\_core\\_vnode\\_master?
&gt; - command
&gt; - sync\\_command
&gt; - sync\\_spawn\\_command
&gt;

A command is async and is typically how a request should arrive at vnode.

The sync\\_command is the same as command but now the caller (i.e. the caller
of sync\\_command) will block until a reply is delivered by the vnode.
 Contrary to the comments in the code the master is \\_not\\_ blocked by the
reply (possibly a case of code and docs getting out of sync).

The sync\\_spawn\\_command, according to the comments, is supposed to be
sync\\_command but without the side effect of blocking the master. As I
said, my guess this is historical and docs have not been kept in sync with
code. The spawn command does two things differently: 1) it spawn\\_links a
new process and 2) it sends the msg to the vnode via send\\_all\\_state\\_event
which causes the event to be handled by the handle\\_event callback rather
than the current state (which is moot in riak\\_core\\_vnode since there is
only one state). Looking at Riak I see sync\\_spawn\\_command only used it two
places, both in riak\\_kv\\_vnode: 1) fold and 2) get\\_vclocks. In the case of
fold this is only used by the backup process (all other folds go thru a
different code path). I see get\\_vclocks referenced nowhere. It is my
opinion that this is legacy code that should be removed.


&gt; as far as i can tell, the sync commands will hold up the Sender process
&gt; until the Sender receives a {reply, Whatever, State}, whereas command is
&gt; asynchronous and the Sender won't wait for a result. I returned noreply
&gt; from a handle\\_command that was called by sync\\_spawn\\_command and it hung on
&gt; the Sender side.
&gt;
&gt; Next, when is it appropriate to use reply and noreply in handle\\_command?
&gt; Does no reply really mean there will never be a reply or just that it may
&gt; come from someone else at a later time (e.g. async call)
&gt;

It is useful to use noreply so that you may offload the request to another
process but at the same time unblock your vnode. I couldn't quickly find a
good example of this out in the wild, I would have thought listkeys does
something like this but it has it's own machinery which looks new.

It's also used in the case where a reply was already made in some helper
code. You can see this technique used in the KV\\_PUT\\_REQ code of
riak\\_kv\\_vnode.

Finally, maybe there is nothing to reply with.


&gt; Finally, what is a Preflist? Is it just the list of preferred vnodes for a
&gt; particular command (e.g. if nothing has crashed, here are the people who
&gt; should see this.)
&gt;

The preference list, or preflist for short, is the preferred vnodes to use
for a given operation. The notion of "preferred" comes from the idea of
 \\_the ring\\_ and that in the best case you want to always send a particular
command to the same vnodes if possible. If the preferred vnodes aren't
available then you can look further down the list for secondary vnodes to
stand in place while the preferred vnodes are down or unavailable. If you
look at the core code you'll find the words "primary" and "fallback"

-Ryan
