---
title: "Re: doubt about encoding in map/reduce"
description: ""
project: community
lastmod: 2010-06-06T14:09:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00509"
mailinglist_parent_id: "msg00506"
author_name: "Kevin Smith"
project_section: "mailinglistitem"
sent_date: 2010-06-06T14:09:16-07:00
---


Francisco - 

A potential fix for this bug is the latest version of erlang\\_js. erlang\\_js 
wasn't calling JS\\_CStringsAreUTF8() in the Spidermonkey API. This causes all 
kinds of interesting string mangling to occur and can trigger bad\\_encoding 
errors as well. You can either checkout the latest erlang\\_js and replace your 
existing version with the new copy or you can wait on Riak 0.11 and pick it up 
then.

--Kevin
On Jun 6, 2010, at 12:23 PM, francisco treacy wrote:

&gt; I get {"error":"bad\\_encoding"} from map/reduce when I use non-ASCII 
&gt; characters:
&gt; 
&gt; ftreacy @ ~
&gt; =&gt; curl -X PUT http://127.0.0.1:8098/riak/test/bug -H "Content-Type:
&gt; application/json" -d @-
&gt; {"city":"Buenos Aires"}
&gt; ^D
&gt; 
&gt; ftreacy @ ~
&gt; =&gt; curl -X POST http://localhost:8098/mapred -H "Content-Type:
&gt; application/json" -d @-
&gt; {"inputs":"test",
&gt; "query":[{"map":{"language":"javascript",
&gt; "source":"function(value, keyData, arg) { var data =
&gt; Riak.mapValuesJson(value)[0]; return [data]; }",
&gt; "keep":true}}]
&gt; }
&gt; [{"city":"Buenos Aires"}]
&gt; 
&gt; ftreacy @ ~
&gt; =&gt; curl -X PUT http://127.0.0.1:8098/riak/test/bug -H "Content-Type:
&gt; application/json" -d @-
&gt; {"city":"København"}
&gt; ^D
&gt; 
&gt; ftreacy @ ~
&gt; =&gt; curl http://127.0.0.1:8098/riak/test/bug
&gt; {"city":"København"}
&gt; 
&gt; ftreacy @ ~
&gt; =&gt; curl -X POST http://localhost:8098/mapred -H "Content-Type:
&gt; application/json" -d @-
&gt; {"inputs":"test",
&gt; "query":[{"map":{"language":"javascript",
&gt; "source":"function(value, keyData, arg) { var data =
&gt; Riak.mapValuesJson(value)[0]; return [data]; }",
&gt; "keep":true}}]
&gt; }
&gt; {"error":"bad\\_encoding"}
&gt; 
&gt; 
&gt; Should I escape UTF-8, or is this a bug? (Same behaviour using riak-js).
&gt; 
&gt; "bug" is the only key in the "test" bucket. Using Riak 0.10.1 on Snow Leopard.
&gt; 
&gt; Francisco
&gt; 
