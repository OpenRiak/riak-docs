---
title: "Re: Indexing of intermediate nested fields in Riak search"
description: ""
project: community
lastmod: 2011-10-30T06:48:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg05376"
mailinglist_parent_id: "msg05375"
author_name: "Elias Levy"
project_section: "mailinglistitem"
sent_date: 2011-10-30T06:48:09-07:00
---


On Sat, Oct 29, 2011 at 9:59 PM, Elias Levy wrote:

&gt; I am wondering if Riak search can index intermediate nested fields. When
&gt; indexing json data through the KV precommit hook, the underscore is
&gt; understood in the schema as indicating nesting. Thus, foo\\_bar will index
&gt; the value "bah" of field "bar" in the json document { "foo" : { "bar" :
&gt; "bah" } }.
&gt;
&gt; What I'd like to know is if it can instead index the key "bar" in the same
&gt; json document. In my current use case I want to be able to find documents
&gt; with certain values for "bar" for these types of documents.
&gt;
&gt; Can this be done by simply indexing the field "foo"? Does search know to
&gt; index all keys in "foo" if foo is a hash, or all its values if it is an
&gt; array?
&gt;

My testing on 1.0.0 shows that this appears not to work. Looking at the
source for the search kv extractor gives the impression that a workaround
would be to instead store { "foo" : [ { "x": "bar", "y": "bah"}, { "x":
"woo", "y": "zoo" }, ... ]} and index "foo\\_z" to be able to search for
"bar" and "woo". I.e. it appears the extractor will index each subdocument
in the array.

At least that is what json\\_text() function implies with the tests:

{&lt;&lt;"
{\\"menu\\": {
 \\"id\\": \\"file\\",
 \\"value\\": \\"File\\",
 \\"popup\\": {
 \\"menuitem\\": [
 {\\"value\\": \\"New\\", \\"onclick\\": \\"CreateNewDoc()\\"},
 {\\"value\\": \\"Open\\", \\"onclick\\": \\"OpenDoc()\\"},
 {\\"value\\": \\"Close\\", \\"onclick\\": \\"CloseDoc()\\"}
 ]
 }
}}"&gt;&gt;,
 [{&lt;&lt;"menu\\_id"&gt;&gt;, &lt;&lt;"file"&gt;&gt;},
 {&lt;&lt;"menu\\_value"&gt;&gt;, &lt;&lt;"File"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_value"&gt;&gt;, &lt;&lt;"New"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_onclick"&gt;&gt;, &lt;&lt;"CreateNewDoc()"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_value"&gt;&gt;, &lt;&lt;"Open"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_onclick"&gt;&gt;, &lt;&lt;"OpenDoc()"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_value"&gt;&gt;, &lt;&lt;"Close"&gt;&gt;},
 {&lt;&lt;"menu\\_popup\\_menuitem\\_onclick"&gt;&gt;, &lt;&lt;"CloseDoc()"&gt;&gt;}]},
 %% From http://www.ibm.com/developerworks/library/x-atom2json.html


&gt; The implication of the above code is that you can search for
menu\\_popup\\_menuitem\\_value:New or menu\\_popup\\_menuitem\\_value:Open and find
the doc. But my testing shows this not to work. If any of the documents
in the array have the same fields, those fields will not be indexed.

E.g. if I set my schema to index foo\\_bar and insert {"foo": [ { "bar" :
"baz" }, {"xxx":"yyy"} ] }, I can search for foo\\_bar:baz and receive a
match. If I instead insert '{"foo": [ { "bar" : "baz" }, {"bar":"yyy"} ]
}' and search for foo\\_bar:baz I receive no match.

Is this expected behavior or a bug?

Elias
\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

