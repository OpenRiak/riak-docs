---
title: "Re: Java map-reduce and result keys"
description: ""
project: community
lastmod: 2012-09-16T17:16:24-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg08558"
mailinglist_parent_id: "msg08557"
author_name: "Mark Phillips"
project_section: "mailinglistitem"
sent_date: 2012-09-16T17:16:24-07:00
---


Addendum:

In the interest of completeness, it's worth noting that the Erlang
builtins are here:

https://github.com/basho/riak\\_kv/blob/master/src/riak\\_kv\\_mapreduce.erl

Mark

On Sun, Sep 16, 2012 at 5:08 PM, Mark Phillips  wrote:
&gt; Hi Deepak,
&gt;
&gt; I can answer one of two questions here...
&gt;
&gt; On Fri, Sep 14, 2012 at 9:42 AM, Deepak Balasubramanyam
&gt;  wrote:
&gt;&gt; Thanks for the tip Russell. I managed to get this done.
&gt;&gt;
&gt;&gt; I have one more question and a suggestion.
&gt;&gt;
&gt;&gt; Is the name keyData a misnomer in the mapping function -&gt; function(value,
&gt;&gt; keyData, arg) ? keyData is a String that carries the bucket name. The value
&gt;&gt; object carries more information. value[0].data represents the data itself
&gt;&gt; among other properties that represent user metadata; riak links; indexes;
&gt;&gt; key; etc etc.
&gt;&gt; If mapValuesJson: function(value, keyData, arg) can take an input argument
&gt;&gt; and use it to add a json property whose value is the riak key, a custom
&gt;&gt; function would not be necessary. It would be a neat little system feature
&gt;&gt; which I take would need amendments to mapred\\_builtins.js.
&gt;&gt;
&gt;&gt; Is riak\\_kv the repo to make contributions to system built functions ? There
&gt;&gt; are quite a few open pull requests on that repo, so I'm not sure where this
&gt;&gt; change should go.
&gt;&gt;
&gt;
&gt; The riak\\_kv repo is indeed the repo you want for this. Specifically,
&gt; you'll want to start here:
&gt;
&gt; https://github.com/basho/riak\\_kv/blob/master/priv/mapred\\_builtins.js
&gt;
&gt; As far as the large queue of pull requests go, we're working on
&gt; merging/addressing the backlog (for this and a few other repos). Send
&gt; yours our way. It'll get some love when time allows.
&gt;
&gt; Thanks.
&gt;
&gt; Mark
&gt;
&gt;
&gt;&gt;
&gt;&gt; Thanks
&gt;&gt; Deepak Bala
&gt;&gt;
&gt;&gt; On Fri, Sep 14, 2012 at 7:16 PM, Russell Brown  wrote:
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On 14 Sep 2012, at 14:24, Deepak Balasubramanyam wrote:
&gt;&gt;&gt;
&gt;&gt;&gt; &gt; Hi,
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; I've written a map reduce query on the riak java client like so...
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; client.mapReduce(BUCKET).addKeyFilter(keyFilter)
&gt;&gt;&gt; &gt; .addLinkPhase(BUCKET, "\\_", false)
&gt;&gt;&gt; &gt; .addMapPhase(new
&gt;&gt;&gt; &gt; NamedJSFunction("Riak.mapValuesJson"), false)
&gt;&gt;&gt; &gt; .addReducePhase(phaseFunction).execute();
&gt;&gt;&gt; &gt; Collection types = result.getResult(MyType.class);
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; This is the class definition for MyType
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; public class MyType
&gt;&gt;&gt; &gt; {
&gt;&gt;&gt; &gt; @RiakKey
&gt;&gt;&gt; &gt; private String myKey;
&gt;&gt;&gt; &gt; private String property1;
&gt;&gt;&gt; &gt; private String property2;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; /\\* Getters / Setters go here \\*/
&gt;&gt;&gt; &gt; }
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; When the object mapper deserializes the results into Collection,
&gt;&gt;&gt; &gt; none of the types have the myKey property populated in them. When I 
&gt;&gt;&gt; &gt; debugged
&gt;&gt;&gt; &gt; the calls made by riak I realized that the result of the /mapred call does
&gt;&gt;&gt; &gt; not contain any key information in the body. It only contains the value 
&gt;&gt;&gt; &gt; that
&gt;&gt;&gt; &gt; each key represents. So that explains why the keys are null in the result.
&gt;&gt;&gt;
&gt;&gt;&gt; The Java client doesn't add the value of the @RiakKey field to the value
&gt;&gt;&gt; stored in riak.
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; On the contrary, a link walk in riak returns the Location header for
&gt;&gt;&gt; &gt; each multipart form entry in the response (Location: /riak/bucket/key). 
&gt;&gt;&gt; &gt; So I
&gt;&gt;&gt; &gt; guess there is at least some way to tweak a client to parse the location 
&gt;&gt;&gt; &gt; to
&gt;&gt;&gt; &gt; get the keys, but you lose out on the map-reduce goodness.
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; Is there some way a map-reduce query can be formed to allow the
&gt;&gt;&gt; &gt; resulting type's RiakKey to be populated ? What are my options ?
&gt;&gt;&gt;
&gt;&gt;&gt; A custom Map function may do what you want. Get the Key from the Key Data
&gt;&gt;&gt; passed to the Map function and add it to the JSON value returned. Jackson
&gt;&gt;&gt; should then take care of de-serialising it into your values.
&gt;&gt;&gt;
&gt;&gt;&gt; Cheers
&gt;&gt;&gt;
&gt;&gt;&gt; Russell
&gt;&gt;&gt;
&gt;&gt;&gt; &gt;
&gt;&gt;&gt; &gt; Thanks
&gt;&gt;&gt; &gt; Deepak Bala
&gt;&gt;&gt; &gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt; &gt; riak-users mailing list
&gt;&gt;&gt; &gt; riak-users@lists.basho.com
&gt;&gt;&gt; &gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;
&gt;&gt;
