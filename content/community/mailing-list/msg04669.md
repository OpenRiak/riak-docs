---
title: "Re: riaksearch 0.14.2 via solr: sort desc"
description: ""
project: community
lastmod: 2011-09-12T08:55:09-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg04669"
mailinglist_parent_id: "msg04667"
author_name: "Sean Cribbs"
project_section: "mailinglistitem"
sent_date: 2011-09-12T08:55:09-07:00
---


Pagination can be non-trivial, but this feels like a good fit for secondary
indexes rather than Search. Note that secondary indexes are only available
in 1.0 (you can get a prerelease package from downloads.basho.com).

I'd start off with a reduce phase that handles the pagination (since you
know it's by key, it's easy to do up front), then you can add a map to fetch
the documents and a final reduce/sort to make sure they are in the original
order. This isn't exact because I don't know your document structure, but
here's how you might do that:

{
 "inputs": {
 "bucket": "order",
 "index": "contact\\_email\\_bin",
 "key": "firstname.lastn...@company.com"
 },
 "query":[

{"reduce":{"language":"erlang","module":"riak\\_kv\\_mapreduce","function":"reduce\\_identity"}},
 {"reduce":{"language":"javascript", "name":"paginateOrders", "arg":
1}},
 {"map":{"language":"javascript", "name":"Riak.mapValuesJson"}},
 {"reduce":{"language":"javascript", "name":"Riak.reduceSort",
"keep":true, arg:"function(a,b){ return a.Order.OrderNumber &gt;
b.Order.OrderNumber; }"}}
 ]
}

The first reduce makes sure the keys emitted can be passed to the pagination
function in Javascript. If you are using Erlang for the function, you might
not need this. Your paginateOrders function (assuming stored as a built-in)
would look like this:

function(values, page){
 // Set the page size here, or possibly set as an argument
 var pageSize = 30;
 // Sort on the key, descending.
 values = values.sort(function(a,b){ return parseInt(a[1]) &lt;
parseInt(b[1]); });
 return values.slice((page - 1) \\* pageSize, page \\* pageSize);
}

Note the Riak.reduceSort function can take a comparator function as a string
arg and will evaluate it and pass it to the Array.sort function.

2011/9/12 Fredrik Lindström 

&gt; Hi Sean,
&gt; thank you for the clarification. In our scenario a user might have many
&gt; orders so it would be nice to be able to page through the result set in
&gt; descending order.
&gt; Since our OrderNumbers are guaranteed to be unique we are currently using
&gt; them as the keys in Riak. They numbers are also created sequentially, hence
&gt; the desire to page through them in descending order giving the user a
&gt; chronological perspective of placed orders.
&gt;
&gt; We're still quite early in the process of evaluating Riak for our project
&gt; so we have plenty of time to try other approaches.
&gt;
&gt; /F
&gt; ------------------------------
&gt; \\*From:\\* Sean Cribbs [s...@basho.com]
&gt; \\*Sent:\\* Monday, September 12, 2011 3:53 PM
&gt; \\*To:\\* Fredrik Lindström
&gt; \\*Cc:\\* riak-users@lists.basho.com
&gt; \\*Subject:\\* Re: riaksearch 0.14.2 via solr: sort desc
&gt;
&gt; Fredrik,
&gt;
&gt; Unfortunately, because of limitations in Riak Search 0.14.x, it can only
&gt; (pre-)sort reliably on the document ID. However, it seems like OrderNumber
&gt; might be a natural ID for this document? If so, you could do something like
&gt; the following:
&gt;
&gt; http://riak/solr/order/select?rows=1&presort=key&q=
&gt; Order\\_Contact\\_Email:firstname.lastn...@company.com
&gt;
&gt; However, this query will also return in ascending order. If you just want
&gt; the highest order number, then feeding this query to MapReduce and
&gt; processing it there would seem appropriate.
&gt;
&gt; 2011/9/12 Fredrik Lindström 
&gt;
&gt;&gt; Hi everyone,
&gt;&gt; does the "sort=myfieldname desc" parameter in riaksearch 0.14.2 (via solr)
&gt;&gt; only sort within the current result set dictated by rows=x and start =y?
&gt;&gt;
&gt;&gt; I can get my search results in the correct ASC order regardless of the
&gt;&gt; rows and start parameters.
&gt;&gt; Sorting in DESC with rows=1 and start=0 I get one (obviously) result but
&gt;&gt; the result actually appears to be in ASC order. The doc returned in the
&gt;&gt; search result is the one with the lowest integer value in the field used for
&gt;&gt; sorting.
&gt;&gt;
&gt;&gt; I'm quite new to Riak and Riak Search and therefore I assume that the
&gt;&gt; error is on my part.
&gt;&gt;
&gt;&gt; Some technical details:
&gt;&gt;
&gt;&gt; Total objects in "order" bucket: 187
&gt;&gt;
&gt;&gt; Query with DESC sort:
&gt;&gt;
&gt;&gt; http://riak/solr/order/select?rows=1&start=0&sort=Order\\_OrderNumber%20desc&q=Order\\_Contact\\_Email:firstname.lastn...@company.com
&gt;&gt; Result: 1 doc with Order\\_OrderNumber = 362982 (Expected result in my
&gt;&gt; world of fantasy would be 621738 which is currently the highest value)
&gt;&gt;
&gt;&gt; Query with ASC sort:
&gt;&gt;
&gt;&gt; http://riak/solr/order/select?rows=1&start=0&sort=Order\\_OrderNumber%20asc&q=Order\\_Contact\\_Email:firstname.lastn...@company.com
&gt;&gt; Result: 1 doc with Order\\_OrderNumber = 362982
&gt;&gt;
&gt;&gt; I have a custom schema where I have defined the field I want to sort by in
&gt;&gt; the following way:
&gt;&gt; {field, [
&gt;&gt; {name, "Order\\_OrderNumber"},
&gt;&gt; {type, integer},
&gt;&gt; {analyzer\\_factory, {erlang, text\\_analyzers,
&gt;&gt; integer\\_analyzer\\_factory}}
&gt;&gt; ]},
&gt;&gt;
&gt;&gt; If I run the DESC query with rows=187 the results are ordered in the
&gt;&gt; correct descending order.
&gt;&gt;
&gt;&gt; /F
&gt;&gt;
&gt;
&gt;
&gt; --
&gt; Sean Cribbs 
&gt; Developer Advocate
&gt; Basho Technologies, Inc.
&gt; http://www.basho.com/
&gt;
&gt;


-- 
Sean Cribbs 
Developer Advocate
Basho Technologies, Inc.
http://www.basho.com/
