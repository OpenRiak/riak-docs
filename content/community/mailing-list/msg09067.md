---
title: "Re: This is about riak search question. How to search utf8 format dat?"
description: ""
project: community
lastmod: 2012-10-28T12:10:16-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg09067"
author_name: "Ryan Zezeski"
project_section: "mailinglistitem"
sent_date: 2012-10-28T12:10:16-07:00
---


On Wed, Oct 10, 2012 at 12:52 AM, 郎咸武  wrote:
&gt;
&gt;
&gt; \\*2)To put a Object to &lt;&lt;"user1"&gt;&gt; bucket. The data is utf8 format.\\*
&gt;
&gt; (trends@jason-lxw)123&gt; f(O), O=riakc\\_obj:new(&lt;&lt;"user1"&gt;&gt;,
&gt; &lt;&lt;"jason5"&gt;&gt;,list\\_to\\_binary(mochijson:encode({struct, [{name,
&gt; binary\\_to\\_list(unicode:characters\\_to\\_binary("爱"))},{sex,"male"}]})),
&gt; "application/json").
&gt; {riakc\\_obj,&lt;&lt;"user1"&gt;&gt;,&lt;&lt;"jason5"&gt;&gt;,undefined,[],
&gt; {dict,1,16,16,8,80,48,
&gt; {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},
&gt;
&gt; {{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;...&gt;&gt;|...]],[],[],...}}},
&gt; &lt;&lt;"{\\"name\\":\\"\\\\u00e7\\\\u0088\\\\u00b1\\",\\"sex\\":\\"male\\"}"&gt;&gt;}
&gt; (((trends@jason-lxw)124&gt; riakc\\_pb\\_socket:put(Pid, O).
&gt;
&gt; ok
&gt;
&gt;
First, let's start with your data and make sure it's getting stored
properly.

3&gt; UC = unicode:characters\\_to\\_binary("爱").
&lt;&lt;231,136,177&gt;&gt;

Okay, so Erlang properly decoded this into a 3-byte unicode sequence. What
does mochijson2 think? (I noticed you are using mochison, I recommend using
mochijson2).

4&gt; mochijson2:encode({struct, [{name, UC}]}).
[123,[34,"name",34],58,[34,"\\\\u7231",34],125]

Good, mochijson2 properly interpreted this as u7231. A quick lookup on the
web verifies this is correct:
http://www.fileformat.info/info/unicode/char/7231/index.htm.

But notice in your code you call binary\\_to\\_list on the binary before
passing it to mochi. Lets see what happened.

15&gt; binary\\_to\\_list(UC).
[231,136,177]

Okay, so the integers are correct. But Erlang treats lists differently
from binaries. It's just a list of integers to Erlang.

16&gt; io:format("~ts~n",[binary\\_to\\_list(UC)]).
ç±
ok

This is why mochi converted it to 3 chatacters: \\\\u00e7\\\\u0088\\\\u00b1

To make a proper unicode list the unicode:caracters\\_to\\_list function must
be used.

17&gt; UCS = unicode:characters\\_to\\_list("爱").
[29233]

18&gt; io:format("~ts~n", [UCS]).
爱
ok

Let's try encoding again, but this time leave out the list\\_to\\_binary.

19&gt; riakc\\_obj:new(&lt;&lt;"user1"&gt;&gt;, &lt;&lt;"jason5"&gt;&gt;, mochijson2:encode({struct,
[{name, unicode:characters\\_to\\_binary("爱")}]}), "application/json").
{riakc\\_obj,&lt;&lt;"user1"&gt;&gt;,&lt;&lt;"jason5"&gt;&gt;,undefined,[],
 {dict,1,16,16,8,80,48,
 {[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],...},

 {{[],[],[],[],[],[],[],[],[],[],[[&lt;&lt;...&gt;&gt;|...]],[],[],...}}},
 [123,[34,"name",34],58,[34,"\\\\u7231",34],125]}

And there we go. A properly encoded unicode character.

-Z
