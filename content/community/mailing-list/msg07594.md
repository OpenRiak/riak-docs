---
title: "Re: Strange spike"
description: ""
project: community
lastmod: 2012-06-01T09:45:21-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07594"
mailinglist_parent_id: "msg07587"
author_name: "Nam Nguyen"
project_section: "mailinglistitem"
sent_date: 2012-06-01T09:45:21-07:00
---


Sounds like a good plan, Greg.

By the way, I joined back the old node into the cluster (making it 6-node 
cluster now). And it seems to me that the spike occurs only on that node.

To summarize the problem so far, for the benefits of other list members:

1. The latency spike occurred on one particular node.

2. I took that node out of the cluster, and put in another one. Spikes seemed 
to happen on all nodes when the cluster were converging and shortly after that. 
The new node seemed to perform a little bit worse than the rest of the cluster.

3. I rejoin the old node to the cluster. Spike seems to be localized to it 
again. The spike is, however, less intensive and a little bit shorter in 
duration. New node seems to be doing on par with the rest.

I'll wait for version 1.2.

Cheers,
Nam


On Jun 1, 2012, at 2:36 AM, Greg Burd wrote:

&gt; Hey Nam,
&gt; 
&gt; It is safe to restart but my advice is to wait until we release 1.2.0 in the 
&gt; next week or two. It has a boat-load of fixes to LevelDB one of which I'm 
&gt; fairly sure is impacting you. Changing these settings as you've indicated is 
&gt; unlikely to make a difference if my intuition is correct.
&gt; 
&gt; -greg 
&gt; 
&gt; @gregburd
&gt; Developer Advocate, Basho Technologies | http://basho.com | @basho
&gt; 
&gt; 
&gt; On Thursday, May 31, 2012 at 9:22 PM, Nam Nguyen wrote:
&gt; 
&gt;&gt; Hi Seth,
&gt;&gt; 
&gt;&gt; Yes, I am using the default config.
&gt;&gt; 
&gt;&gt; Is it safe to change these values and restart riak?
&gt;&gt; 
&gt;&gt; Nam
&gt;&gt; 
&gt;&gt; On May 31, 2012, at 11:24 AM, Seth Benton wrote:
&gt;&gt;&gt; Hey,
&gt;&gt;&gt; 
&gt;&gt;&gt; Apologies if this is the wrong place for this, but I just updated the 
&gt;&gt;&gt; eLevelDB wiki page to mention randomization of the write buffer length (via 
&gt;&gt;&gt; setting write\\_buffer\\_size\\_min and write\\_buffer\\_size\\_max). Before there was 
&gt;&gt;&gt; no mention of these config parameters. Perhaps people were just using 
&gt;&gt;&gt; levelDB's 4MB default buffer size, causing all the vnodes to compact at the 
&gt;&gt;&gt; same time? Or are there default write\\_buffer\\_size\\_min and 
&gt;&gt;&gt; write\\_buffer\\_size\\_max parameters under the hood?
&gt;&gt;&gt; 
&gt;&gt;&gt; http://wiki.basho.com/LevelDB.html
&gt;&gt;&gt; 
&gt;&gt;&gt; P.S. Mathew V is getting back to me shortly on changes to this page due to 
&gt;&gt;&gt; changes in 1.2.
&gt;&gt;&gt; 
&gt;&gt;&gt; Seth
&gt;&gt;&gt; (Tech Writer)
&gt;&gt;&gt; 
&gt;&gt;&gt; 
&gt;&gt;&gt; On Thu, May 31, 2012 at 9:26 AM, Nam Nguyen &gt;&gt; (mailto:n...@tinyco.com)&gt; wrote:
&gt;&gt;&gt;&gt; Hi Sean,
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; You are right. At first I thought it was localized to that one particular 
&gt;&gt;&gt;&gt; node. Now others are also exhibiting the same symptom.
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; I am putting in another node. 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; Cheers,
&gt;&gt;&gt;&gt; Nam
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; On May 30, 2012, at 11:23 PM, Sean Cribbs wrote:
&gt;&gt;&gt;&gt;&gt; Nam,
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; The LevelDB storage backend has a known issue where compaction can stall 
&gt;&gt;&gt;&gt;&gt; a heavily-loaded node for a long time (we've seen 60 seconds or more in 
&gt;&gt;&gt;&gt;&gt; production clusters). We're very sorry about this, but an improvement 
&gt;&gt;&gt;&gt;&gt; will be available in the next release. In the meantime, DO NOT make the 
&gt;&gt;&gt;&gt;&gt; node leave the cluster - this will only make things worse! It might be 
&gt;&gt;&gt;&gt;&gt; worth adding another node to the cluster, but I suggest you wait until 
&gt;&gt;&gt;&gt;&gt; the node finishes compaction.
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; On Wed, May 30, 2012 at 10:43 PM, Nam Nguyen &gt;&gt;&gt;&gt; (mailto:n...@tinyco.com)&gt; wrote:
&gt;&gt;&gt;&gt;&gt;&gt; Hi,
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; My 5-node cluster exhibits a strange spike on one particular node.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Overall, the mean get time is about 1ms. This node occasionally shoots 
&gt;&gt;&gt;&gt;&gt;&gt; up to 40ms.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; During those times, %iowait is still the same as it is before the spike. 
&gt;&gt;&gt;&gt;&gt;&gt; No error. Console log shows many lines like the below, which I don't 
&gt;&gt;&gt;&gt;&gt;&gt; think relevant to the spike.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 2012-05-30 21:29:50.591 [info] 
&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.72.0&gt;@riak\\_core\\_sysmon\\_handler:handle\\_event:85 monitor long\\_gc 
&gt;&gt;&gt;&gt;&gt;&gt; &lt;0.938.0&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; [{initial\\_call,{riak\\_core\\_vnode,init,1}},{almost\\_current\\_function,{gen\\_fsm,loop,7}},{message\\_queue\\_len,0}]
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; [{timeout,185},{old\\_heap\\_block\\_size,0},{heap\\_block\\_size,2584},{mbuf\\_size,0},{stack\\_size,55},{old\\_heap\\_size,0},{heap\\_size,804}]
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; The cluster is set up uniformly. Ubuntu 64bit, m2.2xlarge instance. Riak 
&gt;&gt;&gt;&gt;&gt;&gt; 1.1.2 with LevelDB backend.
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; What would be the best course of actions for me?
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; I plan to:
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; - riak-admin leave on that node
&gt;&gt;&gt;&gt;&gt;&gt; - set up new instance
&gt;&gt;&gt;&gt;&gt;&gt; - riak-admin reip the new instance
&gt;&gt;&gt;&gt;&gt;&gt; - riak-admin join it to the cluster
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; Cheers,
&gt;&gt;&gt;&gt;&gt;&gt; Nam
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt;&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt;&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt;&gt; -- 
&gt;&gt;&gt;&gt;&gt; Sean Cribbs 
&gt;&gt;&gt;&gt;&gt; Software Engineer
&gt;&gt;&gt;&gt;&gt; Basho Technologies, Inc.
&gt;&gt;&gt;&gt;&gt; http://basho.com/
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; 
&gt;&gt;&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt;&gt;&gt; riak-users mailing list
&gt;&gt;&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt;&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt;&gt;&gt; 
&gt;&gt; 
&gt;&gt; 
&gt;&gt; \\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
&gt;&gt; riak-users mailing list
&gt;&gt; riak-users@lists.basho.com (mailto:riak-users@lists.basho.com)
&gt;&gt; http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com
&gt; 
&gt; 
&gt; 


\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

