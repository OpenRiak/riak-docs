---
title: "Re: Riak Client Resources,	Deleting a Key Doesn't Remove it from bucket.keys"
description: ""
project: community
lastmod: 2012-05-22T09:34:37-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07504"
mailinglist_parent_id: "msg07501"
author_name: "Steve Warren"
project_section: "mailinglistitem"
sent_date: 2012-05-22T09:34:37-07:00
---


Thank you for the reply. My observation does not quite match up with this
though so I'm still a bit confused. The deleted keys appeared to stay long
past the 3 seconds described in the post you referenced. In fact, I don't
know if they ever "went away". I'll run some more tests to see if I can
narrow down the exact behavior, for example not all key deletions exhibited
this behavior (the test I ran resulted in 118 residual keys out of around
20K deletes). If I directly queried any of the keys it would respond with
"not found" and immediately stop showing up in the key list or $key index
query.

I'm still running a bunch of tests just to learn the behavior of the system
so I'll keep plugging away at it. For example, I'm observing that $key
index queries halt inserts into the same bucket while the query is running,
I don't know yet if this halts all server activity or just the inserts for
that bucket though.

Regards
Steve

On Tue, May 22, 2012 at 8:58 AM, Kelly McLaughlin  wrote:

&gt; Hi Steve. There is no caching of key lists in riak. What you are seeing is
&gt; likely the fact that listing of keys or index queries can pick up deleted
&gt; keys due to the fact that riak keeps tombstone markers around for deleted
&gt; objects for some period. For a really good explanation of riak's delete
&gt; behavior check out this writeup by Jon Meredith:
&gt; http://lists.basho.com/pipermail/riak-users\\_lists.basho.com/2011-October/006048.html.
&gt; You can set delete\\_mode to immediate as described in that post and you will
&gt; most likely not see any deleted keys when you do an index query or key
&gt; list. The tradeoff is that you may get the unexpected behavior when doing
&gt; concurrent updates to the same set of keys that the delete\\_mode changes
&gt; were designed to address as Jon also indicates in that post. We are
&gt; considering different options on this front, but at this time no actual
&gt; changes have been made to address this.
&gt;
&gt; Kelly
&gt;
&gt; On May 20, 2012, at 10:13 AM, Steve Warren wrote:
&gt;
&gt; The last message I saw on this (from a year ago) says the caching of key
&gt; lists will be removed. I just ran into it while running a $key index range
&gt; search. I then ran a ?key=stream search on the bucket and the same stale
&gt; key list appeared (I had created a bunch of data and then deleted it as a
&gt; test). Did the caching removal not happen? I'm running 1.1.2
&gt;
&gt; The query:
&gt;
&gt; curl 'localhost:8098/buckets/testbucket/index/$key/0/g'
&gt;
&gt; As others have noted, this behavior is quite disconcerting and I don't
&gt; want to pepper the application with otherwise unnecessary checks for stale
&gt; keys even on 2i range queries. Or is that unavoidable?
&gt;
&gt; Regards
&gt; Steve

