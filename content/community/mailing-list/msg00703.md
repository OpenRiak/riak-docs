---
title: "Re: map function for link-walking"
description: ""
project: community
lastmod: 2010-07-11T06:19:29-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg00703"
mailinglist_parent_id: "msg00702"
author_name: "Nicolas Fouché"
project_section: "mailinglistitem"
sent_date: 2010-07-11T06:19:29-07:00
---


I was expecting some really tricky code, but it's just simple and
clean. Thanks a lot.
My links point to objects in the same bucket, so I'll store an array
of object keys and I'll add the bucket name directly in the map
function.

I did not find any doc about preloading javascript functions. Is it
the same as storing JS files in a bucket and load them thanks to the
"bucket" and "key" fields, as described in the "Map" paragraph of the
Fast Track ? 
https://wiki.basho.com/display/RIAK/Loading+Data+and+Running+MapReduce+Queries

-Nicolas

On Sun, Jul 11, 2010 at 12:20 AM, Bryan Fink  wrote:
&gt; On Sat, Jul 10, 2010 at 4:45 PM, Nicolas Fouché  wrote:
&gt;&gt; In the "one-to-very-many link associations" thread , Sean Cribbs talks
&gt;&gt; about a map function which does link-walking from links stored in
&gt;&gt; object contents. http://bit.ly/cKguqQ
&gt;&gt;
&gt;&gt; "Another way to cope with large numbers of links is to
&gt;&gt; encapsulate them in the object itself, rather than in the headers.  This 
&gt;&gt; removes
&gt;&gt; the header-length/count limitation, but would require you to have a map 
&gt;&gt; function
&gt;&gt; that understands the internals of the object.  Also, you would need to deal 
&gt;&gt; with
&gt;&gt; the larger size of the object, which could potentially slow down your 
&gt;&gt; request."
&gt;&gt;
&gt;&gt; Is there any chance someone shares the code of a map function doing
&gt;&gt; this (custom-)link-walking ?
&gt;
&gt; Hi, Nicolas.  Any function you have that returns a list of bucket-key
&gt; pairs, in the same format as the "inputs" list for the map/reduce
&gt; query, will work.  For example, if you stored your object's links in a
&gt; "mylinks" field in it's value, like so:
&gt;
&gt; $ curl -X PUT -H "content-type:application/json"
&gt; http://localhost:8098/riak/example/foo --data @-
&gt; {"mylinks":[["example","bar"],["example","baz"]],"myval":1}
&gt; ^D
&gt; $ curl -X PUT -H "content-type:application/json"
&gt; http://localhost:8098/riak/example/bar --data @-
&gt; {"mylinks":[["example","baz"]],"myval":2}
&gt; ^D
&gt; $ curl -X PUT -H "content-type:application/json"
&gt; http://localhost:8098/riak/example/baz --data @-
&gt; {"mylinks":[["example","foo"]],"myval":3}
&gt; ^D
&gt;
&gt; Then you could use a very simple map function like:
&gt;   function(v) {
&gt;      return v.not\\_found ? [] : JSON.parse(v.values[0].data).mylinks;
&gt;   }
&gt;
&gt; And then the link-walking is simple:
&gt;
&gt; carboy:riak bryan$ curl -X POST -H "content-type:application/json"
&gt; http://localhost:8098/mapred --data @-
&gt; {"inputs":[["example","foo"]],"query":[{"map":{"language":"javascript","source":"function(v)
&gt; { return v.not\\_found ? [] : JSON.parse(v.values[0].data).mylinks;
&gt; }"}},{"map":{"language":"javascript","source":"function(v) { return
&gt; [JSON.parse(v.values[0].data).myval]; }"}}]}
&gt; ^D
&gt; [2,3]
&gt;
&gt; That query uses two map phases to start at the example/foo object I
&gt; created above, and then follow the links it has to the example/bar and
&gt; example/baz, and extracting the "myval" field from the values of those
&gt; objects.
&gt;
&gt; I'd recommend adding a little defensive programming in to make sure
&gt; that "mylinks" is defined, and that it's a list of the proper shape.
&gt; It would also be a good idea to define these function in a file that
&gt; Riak would preload, instead of specifying them dynamically in the
&gt; query (for performance).  But, you could also take it in another
&gt; direction: if you knew that all of your links were going to point to
&gt; objects in a certain bucket, you could store just the keys in the
&gt; object, and produce bucket-key pairs with a quick map function  (e.g.
&gt; mykeys.map(function(k) { return ["otherbucket", k]; })
&gt;
&gt; Hope that helps.
&gt;
&gt; -Bryan
&gt;

