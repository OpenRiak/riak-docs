---
title: "How to prevent Riak crashes when out of memory?"
description: ""
project: community
lastmod: 2012-06-04T13:52:24-07:00
sitemap:
  priority: 0.2
layout: mailinglistitem
mailinglist_id: "msg07609"
author_name: "Steve Edwards"
project_section: "mailinglistitem"
sent_date: 2012-06-04T13:52:24-07:00
---


I have a cluster of riak nodes and one of them crashed because of a
failure to allocate memory.

eheap\\_alloc: Cannot allocate 2850821240 bytes of memory

I restarted the node and it came up gracefully but all my clients
reported that it was offline until I restarted every single node in
the cluster.
How can I tell what was trying to allocate that memory so that I can
give it more memory?
When the node is running, it looks like its only using 8 out of 16G of memory.
Is there a configuration option somewhere that I can modify to
increase the amount of memory available to the node?
I've tweaked all the javascript vm settings but even when there are no
mapreduce calls, memory usage still tops out at 8G.
I should also mention that I am using riak\\_search


Here are some of the config settings:

ERL\\_MAX\\_ETS\\_TABLES 4800
{map\\_js\\_vm\\_count, 16 },
{reduce\\_js\\_vm\\_count, 6 },
{hook\\_js\\_vm\\_count, 8 },

{js\\_max\\_vm\\_mem, 16},
js\\_thread\\_stack, 16},
{segment\\_full\\_read\\_size,20},
{buffer\\_delayed\\_write\\_size,1024 },
{buffer\\_rollover\\_size, 4194304},
{max\\_compact\\_segments, 20}


Here is some more detail about the memory error from erl\\_crash.dump
=erl\\_crash\\_dump:0.1
Fri Jun 1 19:46:03 2012
Slogan: eheap\\_alloc: Cannot allocate 2850821240 bytes of memory (of
type "heap").
System version: Erlang R14B03 (erts-5.8.4) [source] [64-bit] [smp:4:4]
[rq:4] [async-threads:64] [kernel-poll:true]
Compiled: Tue Sep 6 10:22:01 2011
Taints: crypto,bitcask\\_nifs
Atoms: 15614
=memory
total: 12474692688
processes: 6076294256
processes\\_used: 6076132696
system: 6398398432
atom: 1068865
atom\\_used: 1048912
binary: 402089120
code: 9947817
ets: 89367152

\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\_
riak-users mailing list
riak-users@lists.basho.com
http://lists.basho.com/mailman/listinfo/riak-users\\_lists.basho.com

